import{e as pg,s as mg,r as fs,f as Io,g as Lu,h as Pp,i as Ir,a as yi,m as i1,j as Hs,F as _g,k as R2,l as Ed,u as Oi,o as Ki,n as z2,c as il,p as ps,w as Mn,q as L2,t as D2,v as Du,b as Lr,x as Ru,y as Ad,z as O2,T as k2,d as tl,A as r1,B as n1,C as F2,D as B2,E as N2}from"./index-C87g4SEK.js";import{u as zu,_ as Cp}from"./ItTravelerInput-qZYnjjgx.js";import{_ as hc}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{_ as Id}from"./ItTravelerButton-CQ11WlnA.js";var el=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function s1(je){return je&&je.__esModule&&Object.prototype.hasOwnProperty.call(je,"default")?je.default:je}function V2(je){if(Object.prototype.hasOwnProperty.call(je,"__esModule"))return je;var Te=je.default;if(typeof Te=="function"){var he=function pe(){var le=!1;try{le=this instanceof pe}catch{}return le?Reflect.construct(Te,arguments,this.constructor):Te.apply(this,arguments)};he.prototype=Te.prototype}else he={};return Object.defineProperty(he,"__esModule",{value:!0}),Object.keys(je).forEach(function(pe){var le=Object.getOwnPropertyDescriptor(je,pe);Object.defineProperty(he,pe,le.get?le:{enumerable:!0,get:function(){return je[pe]}})}),he}var Ip={exports:{}},U2=Ip.exports,d0;function j2(){return d0||(d0=1,function(je,Te){(function(he,pe){je.exports=pe()})(U2,function(){var he,pe,le;function be(o,Ae){if(!he)he=Ae;else if(!pe)pe=Ae;else{var Ce="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+he+")(sharedChunk); ("+pe+")(sharedChunk); self.onerror = null;",ot={};he(ot),le=Ae(ot),typeof window<"u"&&window&&window.URL&&window.URL.createObjectURL&&(le.workerUrl=window.URL.createObjectURL(new Blob([Ce],{type:"text/javascript"})))}}be(["exports"],function(o){var Ae=1e-6,Ce=typeof Float32Array<"u"?Float32Array:Array;function ot(r,e){var i=e[0],s=e[1],a=e[2],u=e[3],h=i*u-a*s;return h?(r[0]=u*(h=1/h),r[1]=-s*h,r[2]=-a*h,r[3]=i*h,r):null}function ht(){var r=new Ce(9);return Ce!=Float32Array&&(r[1]=0,r[2]=0,r[3]=0,r[5]=0,r[6]=0,r[7]=0),r[0]=1,r[4]=1,r[8]=1,r}function zt(r,e){var i=e[0],s=e[1],a=e[2],u=e[3],h=e[4],p=e[5],_=e[6],g=e[7],x=e[8];return r[0]=h*x-p*g,r[1]=a*g-s*x,r[2]=s*p-a*h,r[3]=p*_-u*x,r[4]=i*x-a*_,r[5]=a*u-i*p,r[6]=u*g-h*_,r[7]=s*_-i*g,r[8]=i*h-s*u,r}function qt(r,e,i){var s=e[0],a=e[1],u=e[2],h=e[3],p=e[4],_=e[5],g=e[6],x=e[7],b=e[8],w=i[0],E=i[1],A=i[2],P=i[3],L=i[4],k=i[5],j=i[6],G=i[7],R=i[8];return r[0]=w*s+E*h+A*g,r[1]=w*a+E*p+A*x,r[2]=w*u+E*_+A*b,r[3]=P*s+L*h+k*g,r[4]=P*a+L*p+k*x,r[5]=P*u+L*_+k*b,r[6]=j*s+G*h+R*g,r[7]=j*a+G*p+R*x,r[8]=j*u+G*_+R*b,r}function st(){var r=new Ce(16);return Ce!=Float32Array&&(r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=0,r[12]=0,r[13]=0,r[14]=0),r[0]=1,r[5]=1,r[10]=1,r[15]=1,r}function re(r){return r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function Ge(r,e){var i=e[0],s=e[1],a=e[2],u=e[3],h=e[4],p=e[5],_=e[6],g=e[7],x=e[8],b=e[9],w=e[10],E=e[11],A=e[12],P=e[13],L=e[14],k=e[15],j=i*p-s*h,G=i*_-a*h,R=i*g-u*h,N=s*_-a*p,q=s*g-u*p,Z=a*g-u*_,ae=x*P-b*A,ne=x*L-w*A,ce=x*k-E*A,me=b*L-w*P,Re=b*k-E*P,Xe=w*k-E*L,Ve=j*Xe-G*Re+R*me+N*ce-q*ne+Z*ae;return Ve?(r[0]=(p*Xe-_*Re+g*me)*(Ve=1/Ve),r[1]=(a*Re-s*Xe-u*me)*Ve,r[2]=(P*Z-L*q+k*N)*Ve,r[3]=(w*q-b*Z-E*N)*Ve,r[4]=(_*ce-h*Xe-g*ne)*Ve,r[5]=(i*Xe-a*ce+u*ne)*Ve,r[6]=(L*R-A*Z-k*G)*Ve,r[7]=(x*Z-w*R+E*G)*Ve,r[8]=(h*Re-p*ce+g*ae)*Ve,r[9]=(s*ce-i*Re-u*ae)*Ve,r[10]=(A*q-P*R+k*j)*Ve,r[11]=(b*R-x*q-E*j)*Ve,r[12]=(p*ne-h*me-_*ae)*Ve,r[13]=(i*me-s*ne+a*ae)*Ve,r[14]=(P*G-A*N-L*j)*Ve,r[15]=(x*N-b*G+w*j)*Ve,r):null}function at(r,e,i){var s=e[0],a=e[1],u=e[2],h=e[3],p=e[4],_=e[5],g=e[6],x=e[7],b=e[8],w=e[9],E=e[10],A=e[11],P=e[12],L=e[13],k=e[14],j=e[15],G=i[0],R=i[1],N=i[2],q=i[3];return r[0]=G*s+R*p+N*b+q*P,r[1]=G*a+R*_+N*w+q*L,r[2]=G*u+R*g+N*E+q*k,r[3]=G*h+R*x+N*A+q*j,r[4]=(G=i[4])*s+(R=i[5])*p+(N=i[6])*b+(q=i[7])*P,r[5]=G*a+R*_+N*w+q*L,r[6]=G*u+R*g+N*E+q*k,r[7]=G*h+R*x+N*A+q*j,r[8]=(G=i[8])*s+(R=i[9])*p+(N=i[10])*b+(q=i[11])*P,r[9]=G*a+R*_+N*w+q*L,r[10]=G*u+R*g+N*E+q*k,r[11]=G*h+R*x+N*A+q*j,r[12]=(G=i[12])*s+(R=i[13])*p+(N=i[14])*b+(q=i[15])*P,r[13]=G*a+R*_+N*w+q*L,r[14]=G*u+R*g+N*E+q*k,r[15]=G*h+R*x+N*A+q*j,r}function It(r,e,i){var s,a,u,h,p,_,g,x,b,w,E,A,P=i[0],L=i[1],k=i[2];return e===r?(r[12]=e[0]*P+e[4]*L+e[8]*k+e[12],r[13]=e[1]*P+e[5]*L+e[9]*k+e[13],r[14]=e[2]*P+e[6]*L+e[10]*k+e[14],r[15]=e[3]*P+e[7]*L+e[11]*k+e[15]):(a=e[1],u=e[2],h=e[3],p=e[4],_=e[5],g=e[6],x=e[7],b=e[8],w=e[9],E=e[10],A=e[11],r[0]=s=e[0],r[1]=a,r[2]=u,r[3]=h,r[4]=p,r[5]=_,r[6]=g,r[7]=x,r[8]=b,r[9]=w,r[10]=E,r[11]=A,r[12]=s*P+p*L+b*k+e[12],r[13]=a*P+_*L+w*k+e[13],r[14]=u*P+g*L+E*k+e[14],r[15]=h*P+x*L+A*k+e[15]),r}function vt(r,e,i){var s=i[0],a=i[1],u=i[2];return r[0]=e[0]*s,r[1]=e[1]*s,r[2]=e[2]*s,r[3]=e[3]*s,r[4]=e[4]*a,r[5]=e[5]*a,r[6]=e[6]*a,r[7]=e[7]*a,r[8]=e[8]*u,r[9]=e[9]*u,r[10]=e[10]*u,r[11]=e[11]*u,r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15],r}function nt(r,e,i){var s=Math.sin(i),a=Math.cos(i),u=e[4],h=e[5],p=e[6],_=e[7],g=e[8],x=e[9],b=e[10],w=e[11];return e!==r&&(r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r[4]=u*a+g*s,r[5]=h*a+x*s,r[6]=p*a+b*s,r[7]=_*a+w*s,r[8]=g*a-u*s,r[9]=x*a-h*s,r[10]=b*a-p*s,r[11]=w*a-_*s,r}function $e(r,e,i){var s=Math.sin(i),a=Math.cos(i),u=e[0],h=e[1],p=e[2],_=e[3],g=e[8],x=e[9],b=e[10],w=e[11];return e!==r&&(r[4]=e[4],r[5]=e[5],r[6]=e[6],r[7]=e[7],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r[0]=u*a-g*s,r[1]=h*a-x*s,r[2]=p*a-b*s,r[3]=_*a-w*s,r[8]=u*s+g*a,r[9]=h*s+x*a,r[10]=p*s+b*a,r[11]=_*s+w*a,r}function Ye(r,e,i){var s=Math.sin(i),a=Math.cos(i),u=e[0],h=e[1],p=e[2],_=e[3],g=e[4],x=e[5],b=e[6],w=e[7];return e!==r&&(r[8]=e[8],r[9]=e[9],r[10]=e[10],r[11]=e[11],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r[0]=u*a+g*s,r[1]=h*a+x*s,r[2]=p*a+b*s,r[3]=_*a+w*s,r[4]=g*a-u*s,r[5]=x*a-h*s,r[6]=b*a-p*s,r[7]=w*a-_*s,r}function yt(r,e){return r[0]=e[0],r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=e[1],r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=e[2],r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function Gt(r,e,i){var s,a,u,h=i[0],p=i[1],_=i[2],g=Math.hypot(h,p,_);return g<Ae?null:(h*=g=1/g,p*=g,_*=g,s=Math.sin(e),a=Math.cos(e),r[0]=h*h*(u=1-a)+a,r[1]=p*h*u+_*s,r[2]=_*h*u-p*s,r[3]=0,r[4]=h*p*u-_*s,r[5]=p*p*u+a,r[6]=_*p*u+h*s,r[7]=0,r[8]=h*_*u+p*s,r[9]=p*_*u-h*s,r[10]=_*_*u+a,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r)}function gi(r,e){var i=e[0],s=e[1],a=e[2],u=e[3],h=i+i,p=s+s,_=a+a,g=i*h,x=s*h,b=s*p,w=a*h,E=a*p,A=a*_,P=u*h,L=u*p,k=u*_;return r[0]=1-b-A,r[1]=x+k,r[2]=w-L,r[3]=0,r[4]=x-k,r[5]=1-g-A,r[6]=E+P,r[7]=0,r[8]=w+L,r[9]=E-P,r[10]=1-g-b,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}Math.hypot||(Math.hypot=function(){for(var r=0,e=arguments.length;e--;)r+=arguments[e]*arguments[e];return Math.sqrt(r)});var xi=at;function Si(){var r=new Ce(3);return Ce!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0),r}function Dr(r){var e=new Ce(3);return e[0]=r[0],e[1]=r[1],e[2]=r[2],e}function Rr(r){return Math.hypot(r[0],r[1],r[2])}function Ei(r,e,i){var s=new Ce(3);return s[0]=r,s[1]=e,s[2]=i,s}function zr(r,e,i){return r[0]=e[0]+i[0],r[1]=e[1]+i[1],r[2]=e[2]+i[2],r}function Or(r,e,i){return r[0]=e[0]-i[0],r[1]=e[1]-i[1],r[2]=e[2]-i[2],r}function Nn(r,e,i){return r[0]=e[0]*i[0],r[1]=e[1]*i[1],r[2]=e[2]*i[2],r}function Vn(r,e,i){return r[0]=Math.min(e[0],i[0]),r[1]=Math.min(e[1],i[1]),r[2]=Math.min(e[2],i[2]),r}function Un(r,e,i){return r[0]=Math.max(e[0],i[0]),r[1]=Math.max(e[1],i[1]),r[2]=Math.max(e[2],i[2]),r}function rr(r,e,i){return r[0]=e[0]*i,r[1]=e[1]*i,r[2]=e[2]*i,r}function fn(r,e,i,s){return r[0]=e[0]+i[0]*s,r[1]=e[1]+i[1]*s,r[2]=e[2]+i[2]*s,r}function pn(r,e){var i=e[0]-r[0],s=e[1]-r[1],a=e[2]-r[2];return i*i+s*s+a*a}function Ts(r){var e=r[0],i=r[1],s=r[2];return e*e+i*i+s*s}function Zs(r,e){return r[0]=-e[0],r[1]=-e[1],r[2]=-e[2],r}function mr(r,e){var i=e[0],s=e[1],a=e[2],u=i*i+s*s+a*a;return u>0&&(u=1/Math.sqrt(u)),r[0]=e[0]*u,r[1]=e[1]*u,r[2]=e[2]*u,r}function Ar(r,e){return r[0]*e[0]+r[1]*e[1]+r[2]*e[2]}function $i(r,e,i){var s=e[0],a=e[1],u=e[2],h=i[0],p=i[1],_=i[2];return r[0]=a*_-u*p,r[1]=u*h-s*_,r[2]=s*p-a*h,r}function Zr(r,e,i,s){var a=e[0],u=e[1],h=e[2];return r[0]=a+s*(i[0]-a),r[1]=u+s*(i[1]-u),r[2]=h+s*(i[2]-h),r}function ji(r,e,i){var s=e[0],a=e[1],u=e[2],h=i[3]*s+i[7]*a+i[11]*u+i[15];return r[0]=(i[0]*s+i[4]*a+i[8]*u+i[12])/(h=h||1),r[1]=(i[1]*s+i[5]*a+i[9]*u+i[13])/h,r[2]=(i[2]*s+i[6]*a+i[10]*u+i[14])/h,r}function Ss(r,e,i){var s=e[0],a=e[1],u=e[2];return r[0]=s*i[0]+a*i[3]+u*i[6],r[1]=s*i[1]+a*i[4]+u*i[7],r[2]=s*i[2]+a*i[5]+u*i[8],r}function Es(r,e,i){var s=i[0],a=i[1],u=i[2],h=e[0],p=e[1],_=e[2],g=a*_-u*p,x=u*h-s*_,b=s*p-a*h,w=a*b-u*x,E=u*g-s*b,A=s*x-a*g,P=2*i[3];return x*=P,b*=P,E*=2,A*=2,r[0]=h+(g*=P)+(w*=2),r[1]=p+x+E,r[2]=_+b+A,r}function rs(r,e){return r[0]===e[0]&&r[1]===e[1]&&r[2]===e[2]}var Br=Or,na=Nn,Ws=Rr;function mn(){var r=new Ce(4);return Ce!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0,r[3]=0),r}function Co(r,e,i){return r[0]=e[0]*i,r[1]=e[1]*i,r[2]=e[2]*i,r[3]=e[3]*i,r}function rl(r,e){var i=e[0],s=e[1],a=e[2],u=e[3],h=i*i+s*s+a*a+u*u;return h>0&&(h=1/Math.sqrt(h)),r[0]=i*h,r[1]=s*h,r[2]=a*h,r[3]=u*h,r}function _n(r,e,i){var s=e[0],a=e[1],u=e[2],h=e[3];return r[0]=i[0]*s+i[4]*a+i[8]*u+i[12]*h,r[1]=i[1]*s+i[5]*a+i[9]*u+i[13]*h,r[2]=i[2]*s+i[6]*a+i[10]*u+i[14]*h,r[3]=i[3]*s+i[7]*a+i[11]*u+i[15]*h,r}function Pn(){var r=new Ce(4);return Ce!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0),r[3]=1,r}function Xs(r){return r[0]=0,r[1]=0,r[2]=0,r[3]=1,r}function Ys(r,e,i){i*=.5;var s=e[0],a=e[1],u=e[2],h=e[3],p=Math.sin(i),_=Math.cos(i);return r[0]=s*_+h*p,r[1]=a*_+u*p,r[2]=u*_-a*p,r[3]=h*_-s*p,r}function Ks(r,e,i){i*=.5;var s=e[0],a=e[1],u=e[2],h=e[3],p=Math.sin(i),_=Math.cos(i);return r[0]=s*_-u*p,r[1]=a*_+h*p,r[2]=u*_+s*p,r[3]=h*_-a*p,r}Si(),mn();var gn,sa,oa,Rn,nl,Is=rl,aa=(gn=Si(),sa=Ei(1,0,0),oa=Ei(0,1,0),function(r,e,i){var s=Ar(e,i);return s<-.999999?($i(gn,sa,e),Ws(gn)<1e-6&&$i(gn,oa,e),mr(gn,gn),function(a,u,h){h*=.5;var p=Math.sin(h);a[0]=p*u[0],a[1]=p*u[1],a[2]=p*u[2],a[3]=Math.cos(h)}(r,gn,Math.PI),r):s>.999999?(r[0]=0,r[1]=0,r[2]=0,r[3]=1,r):($i(gn,e,i),r[0]=gn[0],r[1]=gn[1],r[2]=gn[2],r[3]=1+s,Is(r,r))});function an(){var r=new Ce(2);return Ce!=Float32Array&&(r[0]=0,r[1]=0),r}function Wn(r,e){var i=new Ce(2);return i[0]=r,i[1]=e,i}function Mo(r,e,i){return r[0]=e[0]+i[0],r[1]=e[1]+i[1],r}function Js(r,e,i){return r[0]=e[0]-i[0],r[1]=e[1]-i[1],r}function Po(r,e,i){return r[0]=e[0]*i,r[1]=e[1]*i,r}function Qs(r){return Math.hypot(r[0],r[1])}function la(r,e){var i=e[0],s=e[1],a=i*i+s*s;return a>0&&(a=1/Math.sqrt(a)),r[0]=e[0]*a,r[1]=e[1]*a,r}function pr(r,e){return r[0]*e[0]+r[1]*e[1]}function eo(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}Pn(),Pn(),ht(),an();var ca,zn,ku=function(){if(nl)return Rn;function r(e,i,s,a){this.cx=3*e,this.bx=3*(s-e)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*i,this.by=3*(a-i)-this.cy,this.ay=1-this.cy-this.by,this.p1x=e,this.p1y=i,this.p2x=s,this.p2y=a}return nl=1,Rn=r,r.prototype={sampleCurveX:function(e){return((this.ax*e+this.bx)*e+this.cx)*e},sampleCurveY:function(e){return((this.ay*e+this.by)*e+this.cy)*e},sampleCurveDerivativeX:function(e){return(3*this.ax*e+2*this.bx)*e+this.cx},solveCurveX:function(e,i){if(i===void 0&&(i=1e-6),e<0)return 0;if(e>1)return 1;for(var s=e,a=0;a<8;a++){var u=this.sampleCurveX(s)-e;if(Math.abs(u)<i)return s;var h=this.sampleCurveDerivativeX(s);if(Math.abs(h)<1e-6)break;s-=u/h}var p=0,_=1;for(s=e,a=0;a<20&&(u=this.sampleCurveX(s),!(Math.abs(u-e)<i));a++)e>u?p=s:_=s,s=.5*(_-p)+p;return s},solve:function(e,i){return this.sampleCurveY(this.solveCurveX(e,i))}},Rn}(),dc=eo(ku);function Ro(){if(zn)return ca;function r(e,i){this.x=e,this.y=i}return zn=1,ca=r,r.prototype={clone:function(){return new r(this.x,this.y)},add:function(e){return this.clone()._add(e)},sub:function(e){return this.clone()._sub(e)},multByPoint:function(e){return this.clone()._multByPoint(e)},divByPoint:function(e){return this.clone()._divByPoint(e)},mult:function(e){return this.clone()._mult(e)},div:function(e){return this.clone()._div(e)},rotate:function(e){return this.clone()._rotate(e)},rotateAround:function(e,i){return this.clone()._rotateAround(e,i)},matMult:function(e){return this.clone()._matMult(e)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(e){return this.x===e.x&&this.y===e.y},dist:function(e){return Math.sqrt(this.distSqr(e))},distSqr:function(e){var i=e.x-this.x,s=e.y-this.y;return i*i+s*s},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(e){return Math.atan2(this.y-e.y,this.x-e.x)},angleWith:function(e){return this.angleWithSep(e.x,e.y)},angleWithSep:function(e,i){return Math.atan2(this.x*i-this.y*e,this.x*e+this.y*i)},_matMult:function(e){var i=e[2]*this.x+e[3]*this.y;return this.x=e[0]*this.x+e[1]*this.y,this.y=i,this},_add:function(e){return this.x+=e.x,this.y+=e.y,this},_sub:function(e){return this.x-=e.x,this.y-=e.y,this},_mult:function(e){return this.x*=e,this.y*=e,this},_div:function(e){return this.x/=e,this.y/=e,this},_multByPoint:function(e){return this.x*=e.x,this.y*=e.y,this},_divByPoint:function(e){return this.x/=e.x,this.y/=e.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var e=this.y;return this.y=this.x,this.x=-e,this},_rotate:function(e){var i=Math.cos(e),s=Math.sin(e),a=s*this.x+i*this.y;return this.x=i*this.x-s*this.y,this.y=a,this},_rotateAround:function(e,i){var s=Math.cos(e),a=Math.sin(e),u=i.y+a*(this.x-i.x)+s*(this.y-i.y);return this.x=i.x+s*(this.x-i.x)-a*(this.y-i.y),this.y=u,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},r.convert=function(e){return e instanceof r?e:Array.isArray(e)?new r(e[0],e[1]):e},ca}var ut=eo(Ro());function As(r,e){if(Array.isArray(r)){if(!Array.isArray(e)||r.length!==e.length)return!1;for(let i=0;i<r.length;i++)if(!As(r[i],e[i]))return!1;return!0}if(typeof r=="object"&&r!==null&&e!==null){if(typeof e!="object"||Object.keys(r).length!==Object.keys(e).length)return!1;for(const i in r)if(!As(r[i],e[i]))return!1;return!0}return r===e}const Fu=Math.PI/180,sl=180/Math.PI;function wi(r){return r*Fu}function Ee(r){return r*sl}const F=[[0,0],[1,0],[1,1],[0,1]];function U(r){if(r<=0)return 0;if(r>=1)return 1;const e=r*r,i=e*r;return 4*(r<.5?i:3*(r-e)+i-.75)}function X(r,e,i,s){const a=new dc(r,e,i,s);return function(u){return a.solve(u)}}const oe=X(.25,.1,.25,1);function Q(r,e,i){return Math.min(i,Math.max(e,r))}function de(r,e,i){return(i=Q((i-r)/(e-r),0,1))*i*(3-2*i)}function xe(r,e,i){const s=i-e,a=((r-e)%s+s)%s+e;return a===e?i:a}function fe(r,e,i){if(!r.length)return i(null,[]);let s=r.length;const a=new Array(r.length);let u=null;r.forEach((h,p)=>{e(h,(_,g)=>{_&&(u=_),a[p]=g,--s==0&&i(u,a)})})}function we(r,...e){for(const i of e)for(const s in i)r[s]=i[s];return r}let Ue=1;function Ie(){return Ue++}function ct(r){return r<=1?1:Math.pow(2,Math.ceil(Math.log(r)/Math.LN2))}function Ct(r,e){r.forEach(i=>{e[i]&&(e[i]=e[i].bind(e))})}function Pt(r,e,i){const s={};for(const a in r)s[a]=e.call(this,r[a],a,r);return s}function Ht(r,e,i){const s={};for(const a in r)e.call(this,r[a],a,r)&&(s[a]=r[a]);return s}function Wt(r){return Array.isArray(r)?r.map(Wt):typeof r=="object"&&r?Pt(r,Wt):r}function Yt(r,e){for(let i=0;i<r.length;i++)if(e.indexOf(r[i])>=0)return!0;return!1}const ci={};function ei(r){ci[r]||(typeof console<"u"&&console.warn(r),ci[r]=!0)}function Zi(r,e,i){return(i.y-r.y)*(e.x-r.x)>(e.y-r.y)*(i.x-r.x)}function cr(r){let e=0;for(let i,s,a=0,u=r.length,h=u-1;a<u;h=a++)i=r[a],s=r[h],e+=(s.x-i.x)*(i.y+s.y);return e}function ur([r,e,i]){const s=wi(e+90),a=wi(i);return{x:r*Math.cos(s)*Math.sin(a),y:r*Math.sin(s)*Math.sin(a),z:r*Math.cos(a),azimuthal:e,polar:i}}function ki(r){return(typeof self<"u"||r!==void 0)&&typeof WorkerGlobalScope<"u"&&(r!==void 0?r:self)instanceof WorkerGlobalScope}function Ii(r){const e={};if(r.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(i,s,a,u)=>{const h=a||u;return e[s]=!h||h.toLowerCase(),""}),e["max-age"]){const i=parseInt(e["max-age"],10);isNaN(i)?delete e["max-age"]:e["max-age"]=i}return e}let Cr=null;function xr(r,e){return[r[4*e],r[4*e+1],r[4*e+2],r[4*e+3]]}function _r(r,e,i,s){for(;e<i;){const a=e+i>>1;r[a]<s?e=a+1:i=a}return e}function Xr(r,e,i,s){for(;e<i;){const a=e+i>>1;r[a]<=s?e=a+1:i=a}return e}function Sn(r){return r>0?1/(1.001-r):1+r}function ln(r){return r>0?1-1/(1.001-r):-r}function ol(r,e,i){return(r-e.min)*(i.max-i.min)/(e.max-e.min)+i.min}const Jr={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!Jr.API_URL)return null;try{const r=new URL(Jr.API_URL);return r.hostname==="api.mapbox.cn"?"https://events.mapbox.cn/events/v2":r.hostname==="api.mapbox.com"?"https://events.mapbox.com/events/v2":null}catch{return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",RASTERARRAYS_URL_PREFIX:"rasterarrays/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,DEFAULT_STYLE:"mapbox://styles/mapbox/standard",MAX_PARALLEL_IMAGE_REQUESTS:16,DRACO_URL:"https://api.mapbox.com/mapbox-gl-js/draco_decoder_gltf_v1.5.6.wasm",MESHOPT_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_base_v0.20.wasm",MESHOPT_SIMD_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_simd_v0.20.wasm",BUILDING_GEN_URL:"https://api.mapbox.com/mapbox-gl-js/building-gen/building_gen_v0.3.0.wasm",GLYPHS_URL:"mapbox://fonts/mapbox/{fontstack}/{range}.pbf",TILES3D_URL_PREFIX:"3dtiles/v1"};function to(r){return Jr.API_URL_REGEX.test(r)}function fc(r){return Jr.API_SPRITE_REGEX.test(r)}let al,ll,pc,mc,zo,cl;function _c(){return al==null&&(al=self.OffscreenCanvas&&new OffscreenCanvas(1,1).getContext("2d")&&typeof self.createImageBitmap=="function"),al}const ns={now:()=>mc!==void 0?mc:performance.now(),setNow(r){mc=r},restoreNow(){mc=void 0},frame(r){const e=requestAnimationFrame(r);return{cancel:()=>cancelAnimationFrame(e)}},getImageData(r,e=0){const{width:i,height:s}=r;zo||(zo=document.createElement("canvas"));const a=zo.getContext("2d",{willReadFrequently:!0});if(!a)throw new Error("failed to create canvas 2d context");return(i>zo.width||s>zo.height)&&(zo.width=i,zo.height=s),a.clearRect(-e,-e,i+2*e,s+2*e),a.drawImage(r,0,0,i,s),a.getImageData(-e,-e,i+2*e,s+2*e)},resolveURL:r=>(ll||(ll=document.createElement("a")),ll.href=r,ll.href),get devicePixelRatio(){return window.devicePixelRatio},get prefersReducedMotion(){return!!window.matchMedia&&(pc==null&&(pc=window.matchMedia("(prefers-reduced-motion: reduce)")),pc.matches)},hasCanvasFingerprintNoise(){if(cl!==void 0)return cl;if(!_c())return cl=!1,!1;const r=new OffscreenCanvas(85,1),e=r.getContext("2d",{willReadFrequently:!0});let i=0;for(let a=0;a<r.width;++a)e.fillStyle=`rgba(${i++},${i++},${i++}, 255)`,e.fillRect(a,0,1,1);const s=e.getImageData(0,0,r.width,r.height);i=0;for(let a=0;a<s.data.length;++a)if(a%4!=3&&i++!==s.data[a])return cl=!0,!0;return cl=!1,!1}};function jn(r,e){const i=r.indexOf("?");if(i<0)return`${r}?${new URLSearchParams(e).toString()}`;const s=new URLSearchParams(r.slice(i));for(const a in e)s.set(a,e[a]);return`${r.slice(0,i)}?${s.toString()}`}function Xn(r,e={persistentParams:[]}){const i=r.indexOf("?");if(i<0)return r;const s=new URLSearchParams,a=new URLSearchParams(r.slice(i));for(const h of e.persistentParams){const p=a.get(h);p&&s.set(h,p)}const u=s.toString();return`${r.slice(0,i)}${u.length>0?`?${u}`:""}`}const Cs="mapbox-tiles";let ss=500,Ms=50;const ul=["language","worldview","jobid"];let ms,hl;function Lo(){try{return caches}catch{}}function ua(){const r=Lo();r&&ms==null&&(ms=r.open(Cs))}let Bu=1/0;const Nu={supported:!1,testSupport:function(r){!dl&&Do&&(ha?Md(r):En=r)}};let En,Do,dl=!1,ha=!1;const Cd=typeof self<"u"?self:{};function Md(r){const e=r.createTexture();r.bindTexture(r.TEXTURE_2D,e);try{if(r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,Do),r.isContextLost())return;Nu.supported=!0}catch{}r.deleteTexture(e),dl=!0}Cd.document&&(Do=Cd.document.createElement("img"),Do.onload=function(){En&&Md(En),En=null,ha=!0},Do.onerror=function(){dl=!0,En=null},Do.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const fl={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Iconset:"Iconset",Image:"Image",Model:"Model"};typeof Object.freeze=="function"&&Object.freeze(fl);class vi extends Error{constructor(e,i,s){i===401&&to(s)&&(e+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(e),this.status=i,this.url=s}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}const gc=ki()?()=>self.worker.referrer:()=>(location.protocol==="blob:"?parent:self).location.href,da=function(r,e){if(!(/^file:/.test(i=r.url)||/^file:/.test(gc())&&!/^\w+:/.test(i))){if(self.fetch&&self.Request&&self.AbortController&&Request.prototype.hasOwnProperty("signal"))return function(s,a){const u=new AbortController,h=new Request(s.url,{method:s.method||"GET",body:s.body,credentials:s.credentials,headers:s.headers,referrer:gc(),referrerPolicy:s.referrerPolicy,signal:u.signal});let p=!1,_=!1;const g=(x=h.url).indexOf("sku=")>0&&to(x);var x;s.type==="json"&&h.headers.set("Accept","application/json");const b=(E,A,P)=>{if(_)return;if(E&&E.message!=="SecurityError"&&ei(E.toString()),A&&P)return w(A);const L=Date.now();fetch(h).then(k=>{if(k.ok){const j=g?k.clone():null;return w(k,j,L)}return a(new vi(k.statusText,k.status,s.url))}).catch(k=>{k.name!=="AbortError"&&a(new Error(`${k.message} ${s.url}`))})},w=(E,A,P)=>{(s.type==="arrayBuffer"?E.arrayBuffer():s.type==="json"?E.json():E.text()).then(L=>{_||(A&&P&&function(k,j,G){if(ua(),ms==null)return;const R=Ii(j.headers.get("Cache-Control")||"");if(R["no-store"])return;const N={status:j.status,statusText:j.statusText,headers:new Headers};j.headers.forEach((ae,ne)=>N.headers.set(ne,ae)),R["max-age"]&&N.headers.set("Expires",new Date(G+1e3*R["max-age"]).toUTCString());const q=N.headers.get("Expires");if(!q||new Date(q).getTime()-G<42e4)return;let Z=Xn(k.url,{persistentParams:ul});if(j.status===206){const ae=k.headers.get("Range");if(!ae)return;N.status=200,Z=jn(Z,{range:ae})}(function(ae,ne){if(hl===void 0)try{new Response(new ReadableStream),hl=!0}catch{hl=!1}hl?ne(ae.body):ae.blob().then(ne).catch(ce=>ei(ce.message))})(j,ae=>{const ne=new Response((ce=j.status)!==200&&ce!==404&&[101,103,204,205,304].includes(ce)?null:ae,N);var ce;ua(),ms?.then(me=>me.put(Z,ne)).catch(me=>ei(me.message))})}(h,A,P),p=!0,a(null,L,E.headers.get("Cache-Control"),E.headers.get("Expires")))}).catch(L=>{_||a(new Error(L.message))})};return g?function(E,A){if(ua(),ms==null)return A(null);ms.then(P=>{let L=Xn(E.url,{persistentParams:ul});const k=E.headers.get("Range");k&&(L=jn(L,{range:k})),P.match(L).then(j=>{const G=function(R){if(!R)return!1;const N=new Date(R.headers.get("Expires")||0),q=Ii(R.headers.get("Cache-Control")||"");return Number(N)>Date.now()&&!q["no-cache"]}(j);P.delete(L).catch(A),G&&P.put(L,j.clone()).catch(A),A(null,j,G)}).catch(A)}).catch(A)}(h,b):b(null,null),{cancel:()=>{_=!0,p||u.abort()}}}(r,e);if(ki(self)&&self.worker.actor)return self.worker.actor.send("getResource",r,e,void 0,!0)}var i;return function(s,a){const u=new XMLHttpRequest;u.open(s.method||"GET",s.url,!0),s.type==="arrayBuffer"&&(u.responseType="arraybuffer");for(const h in s.headers)u.setRequestHeader(h,s.headers[h]);return s.type==="json"&&(u.responseType="text",u.setRequestHeader("Accept","application/json")),u.withCredentials=s.credentials==="include",u.onerror=()=>{a(new Error(u.statusText))},u.onload=()=>{if((u.status>=200&&u.status<300||u.status===0)&&u.response!==null){let h=u.response;if(s.type==="json")try{h=JSON.parse(u.response)}catch(p){return a(p)}a(null,h,u.getResponseHeader("Cache-Control"),u.getResponseHeader("Expires"))}else a(new vi(u.statusText,u.status,s.url))},u.send(s.body),{cancel:()=>u.abort()}}(r,e)},pl=function(r,e){return da(we(r,{type:"arrayBuffer"}),e)};function Lp(r){const e=document.createElement("a");return e.href=r,e.protocol===location.protocol&&e.host===location.host}const ml="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let Oo,io;Oo=[],io=0;const Vu=function(r,e){if(Nu.supported&&(r.headers||(r.headers={}),r.headers.accept="image/webp,*/*"),io>=Jr.MAX_PARALLEL_IMAGE_REQUESTS){const u={requestParameters:r,callback:e,cancelled:!1,cancel(){this.cancelled=!0}};return Oo.push(u),u}io++;let i=!1;const s=()=>{if(!i)for(i=!0,io--;Oo.length&&io<Jr.MAX_PARALLEL_IMAGE_REQUESTS;){const u=Oo.shift(),{requestParameters:h,callback:p,cancelled:_}=u;_||(u.cancel=Vu(h,p).cancel)}},a=pl(r,(u,h,p,_)=>{s(),u?e(u):h&&(self.createImageBitmap?function(g,x){const b=new Blob([new Uint8Array(g)],{type:"image/png"});createImageBitmap(b).then(w=>{x(null,w)}).catch(w=>{x(new Error(`Could not load image because of ${w.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))})}(h,(g,x)=>e(g,x,p,_)):function(g,x){const b=new Image;b.onload=()=>{x(null,b),URL.revokeObjectURL(b.src),b.onload=null,requestAnimationFrame(()=>{b.src=ml})},b.onerror=()=>x(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const w=new Blob([new Uint8Array(g)],{type:"image/png"});b.src=g.byteLength?URL.createObjectURL(w):ml}(h,(g,x)=>e(g,x,p,_)))});return{cancel:()=>{a.cancel(),s()}}};var Uu,ko,Pd,Ps={exports:{}},yc={exports:{}},vc={exports:{}},os=function(){if(Pd)return Ps.exports;Pd=1;var r=(Uu||(Uu=1,yc.exports=function(i,s){var a,u,h,p,_,g,x,b;for(u=i.length-(a=3&i.length),h=s,_=3432918353,g=461845907,b=0;b<u;)x=255&i.charCodeAt(b)|(255&i.charCodeAt(++b))<<8|(255&i.charCodeAt(++b))<<16|(255&i.charCodeAt(++b))<<24,++b,h=27492+(65535&(p=5*(65535&(h=(h^=x=(65535&(x=(x=(65535&x)*_+(((x>>>16)*_&65535)<<16)&4294967295)<<15|x>>>17))*g+(((x>>>16)*g&65535)<<16)&4294967295)<<13|h>>>19))+((5*(h>>>16)&65535)<<16)&4294967295))+((58964+(p>>>16)&65535)<<16);switch(x=0,a){case 3:x^=(255&i.charCodeAt(b+2))<<16;case 2:x^=(255&i.charCodeAt(b+1))<<8;case 1:h^=x=(65535&(x=(x=(65535&(x^=255&i.charCodeAt(b)))*_+(((x>>>16)*_&65535)<<16)&4294967295)<<15|x>>>17))*g+(((x>>>16)*g&65535)<<16)&4294967295}return h^=i.length,h=2246822507*(65535&(h^=h>>>16))+((2246822507*(h>>>16)&65535)<<16)&4294967295,h=3266489909*(65535&(h^=h>>>13))+((3266489909*(h>>>16)&65535)<<16)&4294967295,(h^=h>>>16)>>>0}),yc.exports),e=(ko||(ko=1,vc.exports=function(i,s){for(var a,u=i.length,h=s^u,p=0;u>=4;)a=1540483477*(65535&(a=255&i.charCodeAt(p)|(255&i.charCodeAt(++p))<<8|(255&i.charCodeAt(++p))<<16|(255&i.charCodeAt(++p))<<24))+((1540483477*(a>>>16)&65535)<<16),h=1540483477*(65535&h)+((1540483477*(h>>>16)&65535)<<16)^(a=1540483477*(65535&(a^=a>>>24))+((1540483477*(a>>>16)&65535)<<16)),u-=4,++p;switch(u){case 3:h^=(255&i.charCodeAt(p+2))<<16;case 2:h^=(255&i.charCodeAt(p+1))<<8;case 1:h=1540483477*(65535&(h^=255&i.charCodeAt(p)))+((1540483477*(h>>>16)&65535)<<16)}return h=1540483477*(65535&(h^=h>>>13))+((1540483477*(h>>>16)&65535)<<16),(h^=h>>>15)>>>0}),vc.exports);return Ps.exports=r,Ps.exports.murmur3=r,Ps.exports.murmur2=e,Ps.exports}(),_l=eo(os);class Fo{constructor(e,...i){we(this,i[0]||{}),this.type=e}}class xc extends Fo{constructor(e,i={}){super("error",we({error:e},i))}}function ju(r,e,i){i[r]&&i[r].indexOf(e)!==-1||(i[r]=i[r]||[],i[r].push(e))}function bc(r,e,i){if(i&&i[r]){const s=i[r].indexOf(e);s!==-1&&i[r].splice(s,1)}}class Bo{on(e,i){return this._listeners=this._listeners||{},ju(e,i,this._listeners),this}off(e,i){return bc(e,i,this._listeners),bc(e,i,this._oneTimeListeners),this}once(e,i){return i?(this._oneTimeListeners=this._oneTimeListeners||{},ju(e,i,this._oneTimeListeners),this):new Promise(s=>{this.once(e,s)})}fire(e,i){const s=typeof e=="string"?new Fo(e,i):e,a=s.type;if(this.listens(a)){s.target=this;const u=this._listeners&&this._listeners[a]?this._listeners[a].slice():[];for(const _ of u)_.call(this,s);const h=this._oneTimeListeners&&this._oneTimeListeners[a]?this._oneTimeListeners[a].slice():[];for(const _ of h)bc(a,_,this._oneTimeListeners),_.call(this,s);const p=this._eventedParent;p&&(we(s,typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData),p.fire(s))}else s instanceof xc&&console.error(s.error);return this}listens(e){return!!(this._listeners&&this._listeners[e]&&this._listeners[e].length>0||this._oneTimeListeners&&this._oneTimeListeners[e]&&this._oneTimeListeners[e].length>0||this._eventedParent&&this._eventedParent.listens(e))}setEventedParent(e,i){return this._eventedParent=e,this._eventedParentData=i,this}}class Ln{constructor(e){typeof e=="string"?this.name=e:(this.name=e.name,this.iconsetId=e.iconsetId)}static from(e){return new Ln(e)}static toString(e){return e.iconsetId?`${e.name}${e.iconsetId}`:e.name}static parse(e){const[i,s]=e.split("");return new Ln({name:i,iconsetId:s})}static isEqual(e,i){return e.name===i.name&&e.iconsetId===i.iconsetId}toString(){return Ln.toString(this)}serialize(){return{name:this.name,iconsetId:this.iconsetId}}}var Gu,fa={},No=function(){if(Gu)return fa;Gu=1;var r={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function e(u){return(u=Math.round(u))<0?0:u>255?255:u}function i(u){return e(u[u.length-1]==="%"?parseFloat(u)/100*255:parseInt(u))}function s(u){return(h=u[u.length-1]==="%"?parseFloat(u)/100:parseFloat(u))<0?0:h>1?1:h;var h}function a(u,h,p){return p<0?p+=1:p>1&&(p-=1),6*p<1?u+(h-u)*p*6:2*p<1?h:3*p<2?u+(h-u)*(2/3-p)*6:u}try{fa.parseCSSColor=function(u){var h,p=u.replace(/ /g,"").toLowerCase();if(p in r)return r[p].slice();if(p[0]==="#")return p.length===4?(h=parseInt(p.substr(1),16))>=0&&h<=4095?[(3840&h)>>4|(3840&h)>>8,240&h|(240&h)>>4,15&h|(15&h)<<4,1]:null:p.length===7&&(h=parseInt(p.substr(1),16))>=0&&h<=16777215?[(16711680&h)>>16,(65280&h)>>8,255&h,1]:null;var _=p.indexOf("("),g=p.indexOf(")");if(_!==-1&&g+1===p.length){var x=p.substr(0,_),b=p.substr(_+1,g-(_+1)).split(","),w=1;switch(x){case"rgba":if(b.length!==4)return null;w=s(b.pop());case"rgb":return b.length!==3?null:[i(b[0]),i(b[1]),i(b[2]),w];case"hsla":if(b.length!==4)return null;w=s(b.pop());case"hsl":if(b.length!==3)return null;var E=(parseFloat(b[0])%360+360)%360/360,A=s(b[1]),P=s(b[2]),L=P<=.5?P*(A+1):P+A-P*A,k=2*P-L;return[e(255*a(k,L,E+1/3)),e(255*a(k,L,E)),e(255*a(k,L,E-1/3)),w];default:return null}}return null}}catch{}return fa}();class Pi{constructor(e,i,s,a=1){this.r=e,this.g=i,this.b=s,this.a=a}static parse(e){if(!e)return;if(e instanceof Pi)return e;if(typeof e!="string")return;const i=No.parseCSSColor(e);return i?new Pi(i[0]/255,i[1]/255,i[2]/255,i[3]):void 0}toString(){const[e,i,s,a]=[this.r,this.g,this.b,this.a];return`rgba(${Math.round(255*e)},${Math.round(255*i)},${Math.round(255*s)},${a})`}toNonPremultipliedRenderColor(e){const{r:i,g:s,b:a,a:u}=this;return new Dp(e,i,s,a,u)}toPremultipliedRenderColor(e){const{r:i,g:s,b:a,a:u}=this;return new qu(e,i*u,s*u,a*u,u)}clone(){return new Pi(this.r,this.g,this.b,this.a)}}class as{constructor(e,i,s,a,u,h=!1){if(this.premultiplied=!1,this.premultiplied=h,e){const p=e.image.height,_=p*p;this.premultiplied?(i=u===0?0:i/u*(p-1),s=u===0?0:s/u*(p-1),a=u===0?0:a/u*(p-1)):(i*=p-1,s*=p-1,a*=p-1);const g=Math.floor(i),x=Math.floor(s),b=Math.floor(a),w=Math.ceil(i),E=Math.ceil(s),A=Math.ceil(a),P=i-g,L=s-x,k=a-b,j=e.image.data,G=4*(g+x*_+b*p),R=4*(g+x*_+A*p),N=4*(g+E*_+b*p),q=4*(g+E*_+A*p),Z=4*(w+x*_+b*p),ae=4*(w+x*_+A*p),ne=4*(w+E*_+b*p),ce=4*(w+E*_+A*p);if(G<0||ce>=j.length)throw new Error("out of range");this.r=Ut(Ut(Ut(j[G],j[R],k),Ut(j[N],j[q],k),L),Ut(Ut(j[Z],j[ae],k),Ut(j[ne],j[ce],k),L),P)/255*(this.premultiplied?u:1),this.g=Ut(Ut(Ut(j[G+1],j[R+1],k),Ut(j[N+1],j[q+1],k),L),Ut(Ut(j[Z+1],j[ae+1],k),Ut(j[ne+1],j[ce+1],k),L),P)/255*(this.premultiplied?u:1),this.b=Ut(Ut(Ut(j[G+2],j[R+2],k),Ut(j[N+2],j[q+2],k),L),Ut(Ut(j[Z+2],j[ae+2],k),Ut(j[ne+2],j[ce+2],k),L),P)/255*(this.premultiplied?u:1),this.a=u}else this.r=i,this.g=s,this.b=a,this.a=u}toArray(){const{r:e,g:i,b:s,a}=this;return[255*e,255*i,255*s,a]}toHslaArray(){let{r:e,g:i,b:s,a}=this;if(this.premultiplied){if(a===0)return[0,0,0,0];e/=a,i/=a,s/=a}const u=Math.min(Math.max(e,0),1),h=Math.min(Math.max(i,0),1),p=Math.min(Math.max(s,0),1),_=Math.min(u,h,p),g=Math.max(u,h,p),x=(_+g)/2;if(_===g)return[0,0,100*x,a];const b=g-_,w=x>.5?b/(2-g-_):b/(g+_);let E=0;return g===u?E=(h-p)/b+(h<p?6:0):g===h?E=(p-u)/b+2:g===p&&(E=(u-h)/b+4),E*=60,[Math.min(Math.max(E,0),360),Math.min(Math.max(100*w,0),100),Math.min(Math.max(100*x,0),100),a]}toArray01(){const{r:e,g:i,b:s,a}=this;return[e,i,s,a]}toArray01Scaled(e){const{r:i,g:s,b:a}=this;return[i*e,s*e,a*e]}toArray01Linear(){const{r:e,g:i,b:s,a}=this;return[Math.pow(e,2.2),Math.pow(i,2.2),Math.pow(s,2.2),a]}}class Dp extends as{constructor(e,i,s,a,u){super(e,i,s,a,u,!1)}}class qu extends as{constructor(e,i,s,a,u){super(e,i,s,a,u,!0)}}function Ut(r,e,i){return r*(1-i)+e*i}function wc(r,e,i){return r.map((s,a)=>Ut(s,e[a],i))}Pi.black=new Pi(0,0,0,1),Pi.white=new Pi(1,1,1,1),Pi.transparent=new Pi(0,0,0,0),Pi.red=new Pi(1,0,0,1),Pi.blue=new Pi(0,0,1,1);var gl=Object.freeze({__proto__:null,array:wc,color:function(r,e,i){return new Pi(Ut(r.r,e.r,i),Ut(r.g,e.g,i),Ut(r.b,e.b,i),Ut(r.a,e.a,i))},number:Ut});function Vo(r,...e){for(const i of e)for(const s in i)r[s]=i[s];return r}class Gn extends Error{constructor(e,i){super(i),this.message=i,this.key=e}}class $u{constructor(e,i=[]){this.parent=e,this.bindings={};for(const[s,a]of i)this.bindings[s]=a}concat(e){return new $u(this,e)}get(e){if(this.bindings[e])return this.bindings[e];if(this.parent)return this.parent.get(e);throw new Error(`${e} not found in scope.`)}has(e){return!!this.bindings[e]||!!this.parent&&this.parent.has(e)}}const pa={kind:"null"},Lt={kind:"number"},Ni={kind:"string"},Ci={kind:"boolean"},Dn={kind:"color"},Rs={kind:"object"},Ri={kind:"value"},Tc={kind:"collator"},yl={kind:"formatted"},vl={kind:"resolvedImage"};function yn(r,e){return{kind:"array",itemType:r,N:e}}function jr(r){if(r.kind==="array"){const e=jr(r.itemType);return typeof r.N=="number"?`array<${e}, ${r.N}>`:r.itemType.kind==="value"?"array":`array<${e}>`}return r.kind}const Op=[pa,Lt,Ni,Ci,Dn,yl,Rs,yn(Ri),vl];function ma(r,e){if(e.kind==="error")return null;if(r.kind==="array"){if(e.kind==="array"&&(e.N===0&&e.itemType.kind==="value"||!ma(r.itemType,e.itemType))&&(typeof r.N!="number"||r.N===e.N))return null}else{if(r.kind===e.kind)return null;if(r.kind==="value"){for(const i of Op)if(!ma(i,e))return null}}return`Expected ${jr(r)} but found ${jr(e)} instead.`}function ro(r,e){return e.some(i=>i.kind===r.kind)}function xl(r,e){return e.some(i=>i==="null"?r===null:i==="array"?Array.isArray(r):i==="object"?r&&!Array.isArray(r)&&typeof r=="object":i===typeof r)}function Sc(r,e){return r.kind==="array"&&e.kind==="array"?r.N===e.N&&Sc(r.itemType,e.itemType):r.kind===e.kind}class bl{constructor(e,i,s){this.sensitivity=e?i?"variant":"case":i?"accent":"base",this.locale=s,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(e,i){return this.collator.compare(e,i)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class Ec{constructor(e,i,s,a,u){this.text=e.normalize?e.normalize():e,this.image=i,this.scale=s,this.fontStack=a,this.textColor=u}}class vn{constructor(e){this.sections=e}static fromString(e){return new vn([new Ec(e,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some(e=>e.text.length!==0||!!e.image&&e.image.hasPrimary())}static factory(e){return e instanceof vn?e:vn.fromString(e)}toString(){return this.sections.length===0?"":this.sections.map(e=>e.text).join("")}serialize(){const e=["format"];for(const i of this.sections){if(i.image){const a=i.image.getPrimary().id.toString();e.push(["image",a]);continue}e.push(i.text);const s={};i.fontStack&&(s["text-font"]=["literal",i.fontStack.split(",")]),i.scale&&(s["font-scale"]=i.scale),i.textColor&&(s["text-color"]=["rgba"].concat(i.textColor.toNonPremultipliedRenderColor(null).toArray())),e.push(s)}return e}}class zs{constructor(e,i={}){if(this.id=Ln.from(e),this.options=Object.assign({},i),i.transform){const{a:s,b:a,c:u,d:h,e:p,f:_}=i.transform;this.options.transform=new DOMMatrix([s,a,u,h,p,_])}else this.options.transform=new DOMMatrix([1,0,0,1,0,0])}toString(){const{a:e,b:i,c:s,d:a,e:u,f:h}=this.options.transform;return JSON.stringify({name:this.id.name,iconsetId:this.id.iconsetId,params:this.options.params,transform:{a:e,b:i,c:s,d:a,e:u,f:h}})}static parse(e){let i,s,a,u;try{({name:i,iconsetId:s,params:a,transform:u}=JSON.parse(e)||{})}catch{return null}if(!i)return null;const{a:h,b:p,c:_,d:g,e:x,f:b}=u||{};return new zs({name:i,iconsetId:s},{params:a,transform:new DOMMatrix([h,p,_,g,x,b])})}scaleSelf(e,i){return this.options.transform.scaleSelf(e,i),this}}class In{constructor(e,i,s,a,u=!1){this.primaryId=Ln.from(e),this.primaryOptions=i,s&&(this.secondaryId=Ln.from(s)),this.secondaryOptions=a,this.available=u}toString(){return this.primaryId&&this.secondaryId?`[${this.primaryId.name},${this.secondaryId.name}]`:this.primaryId.name}hasPrimary(){return!!this.primaryId}getPrimary(){return new zs(this.primaryId,this.primaryOptions)}hasSecondary(){return!!this.secondaryId}getSecondary(){return this.secondaryId?new zs(this.secondaryId,this.secondaryOptions):null}static from(e){return typeof e=="string"?In.build({name:e}):e}static build(e,i,s,a){return!e||typeof e=="object"&&!("name"in e)?null:new In(e,s,i,a)}}function Uo(r,e,i,s){return typeof r=="number"&&r>=0&&r<=255&&typeof e=="number"&&e>=0&&e<=255&&typeof i=="number"&&i>=0&&i<=255?s===void 0||typeof s=="number"&&s>=0&&s<=1?null:`Invalid rgba value [${[r,e,i,s].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof s=="number"?[r,e,i,s]:[r,e,i]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function oi(r){if(r===null||typeof r=="string"||typeof r=="boolean"||typeof r=="number"||r instanceof Pi||r instanceof bl||r instanceof vn||r instanceof In)return!0;if(Array.isArray(r)){for(const e of r)if(!oi(e))return!1;return!0}if(typeof r=="object"){for(const e in r)if(!oi(r[e]))return!1;return!0}return!1}function xt(r){if(r===null)return pa;if(typeof r=="string")return Ni;if(typeof r=="boolean")return Ci;if(typeof r=="number")return Lt;if(r instanceof Pi)return Dn;if(r instanceof bl)return Tc;if(r instanceof vn)return yl;if(r instanceof In)return vl;if(Array.isArray(r)){const e=r.length;let i;for(const s of r){const a=xt(s);if(i){if(i===a)continue;i=Ri;break}i=a}return yn(i||Ri,e)}return Rs}function Yn(r){const e=typeof r;return r===null?"":e==="string"||e==="number"||e==="boolean"?String(r):r instanceof vn||r instanceof In||r instanceof Pi?r.toString():JSON.stringify(r)}class Zt{constructor(e,i){this.type=e,this.value=i}static parse(e,i){if(e.length!==2)return i.error(`'literal' expression requires exactly one argument, but found ${e.length-1} instead.`);if(!oi(e[1]))return i.error("invalid value");const s=e[1];let a=xt(s);const u=i.expectedType;return a.kind!=="array"||a.N!==0||!u||u.kind!=="array"||typeof u.N=="number"&&u.N!==0||(a=u),new Zt(a,s)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return this.type.kind==="array"||this.type.kind==="object"?["literal",this.value]:this.value instanceof Pi?["rgba"].concat(this.value.toNonPremultipliedRenderColor(null).toArray()):this.value instanceof vn?this.value.serialize():this.value}}class Nr{constructor(e){this.name="ExpressionEvaluationError",this.message=e}toJSON(){return this.message}}const wl={string:Ni,number:Lt,boolean:Ci,object:Rs};class Nt{constructor(e,i){this.type=e,this.args=i}static parse(e,i){if(e.length<2)return i.error("Expected at least one argument.");let s,a=1;const u=e[0];if(u==="array"){let p,_;if(e.length>2){const g=e[1];if(typeof g!="string"||!(g in wl)||g==="object")return i.error('The item type argument of "array" must be one of string, number, boolean',1);p=wl[g],a++}else p=Ri;if(e.length>3){if(e[2]!==null&&(typeof e[2]!="number"||e[2]<0||e[2]!==Math.floor(e[2])))return i.error('The length argument to "array" must be a positive integer literal',2);_=e[2],a++}s=yn(p,_)}else s=wl[u];const h=[];for(;a<e.length;a++){const p=i.parse(e[a],a,Ri);if(!p)return null;h.push(p)}return new Nt(s,h)}evaluate(e){for(let i=0;i<this.args.length;i++){const s=this.args[i].evaluate(e);if(!ma(this.type,xt(s)))return s;if(i===this.args.length-1)throw new Nr(`The expression ${JSON.stringify(this.args[i].serialize())} evaluated to ${jr(xt(s))} but was expected to be of type ${jr(this.type)}.`)}return null}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){const e=this.type,i=[e.kind];if(e.kind==="array"){const s=e.itemType;if(s.kind==="string"||s.kind==="number"||s.kind==="boolean"){i.push(s.kind);const a=e.N;(typeof a=="number"||this.args.length>1)&&i.push(a)}}return i.concat(this.args.map(s=>s.serialize()))}}class _a{constructor(e){this.type=yl,this.sections=e}static parse(e,i){if(e.length<2)return i.error("Expected at least one argument.");const s=e[1];if(!Array.isArray(s)&&typeof s=="object")return i.error("First argument must be an image or text section.");const a=[];let u=!1;for(let h=1;h<=e.length-1;++h){const p=e[h];if(u&&typeof p=="object"&&!Array.isArray(p)){u=!1;let _=null;if(p["font-scale"]&&(_=i.parseObjectValue(p["font-scale"],h,"font-scale",Lt),!_))return null;let g=null;if(p["text-font"]&&(g=i.parseObjectValue(p["text-font"],h,"text-font",yn(Ni)),!g))return null;let x=null;if(p["text-color"]&&(x=i.parseObjectValue(p["text-color"],h,"text-color",Dn),!x))return null;const b=a[a.length-1];b.scale=_,b.font=g,b.textColor=x}else{const _=i.parse(e[h],h,Ri);if(!_)return null;const g=_.type.kind;if(g!=="string"&&g!=="value"&&g!=="null"&&g!=="resolvedImage")return i.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");u=!0,a.push({content:_,scale:null,font:null,textColor:null})}}return new _a(a)}evaluate(e){return new vn(this.sections.map(i=>{const s=i.content.evaluate(e);return Sc(xt(s),vl)?new Ec("",s,null,null,null):new Ec(Yn(s),null,i.scale?i.scale.evaluate(e):null,i.font?i.font.evaluate(e).join(","):null,i.textColor?i.textColor.evaluate(e):null)}))}eachChild(e){for(const i of this.sections)e(i.content),i.scale&&e(i.scale),i.font&&e(i.font),i.textColor&&e(i.textColor)}outputDefined(){return!1}serialize(){const e=["format"];for(const i of this.sections){e.push(i.content.serialize());const s={};i.scale&&(s["font-scale"]=i.scale.serialize()),i.font&&(s["text-font"]=i.font.serialize()),i.textColor&&(s["text-color"]=i.textColor.serialize()),e.push(s)}return e}}class ga{constructor(e,i,s,a){this._imageWarnHistory={},this.type=vl,this.namePrimary=e,this.nameSecondary=i,s&&(this.paramsPrimary=s.params,this.iconsetIdPrimary=s.iconset?s.iconset.id:void 0),a&&(this.paramsSecondary=a.params,this.iconsetIdSecondary=a.iconset?a.iconset.id:void 0)}static parse(e,i){if(e.length<2)return i.error("Expected two or more arguments.");let s=1;const a=[];function u(){if(s<e.length){const p=i.parse(e[s],s++,Ni);return p?(a.push({image:p,options:{}}),!0):(i.error(a.length?"Secondary image variant is not a string.":"No image name provided."),!1)}return!0}function h(){if(s<e.length){const _=e[s];if((p=_)===null||typeof p!="object"||Array.isArray(p))return!0;const g=_.params,x=_.iconset,b=i.concat(s);if(!g&&!x)return s++,!0;if(g){if(typeof g!="object"||g.constructor!==Object)return b.error('Image options "params" should be an object'),!1;const w={},E=b.concat(void 0,"params");for(const A in g){if(!A)return E.error("Image parameter name should be non-empty"),!1;const P=E.concat(void 0,A).parse(g[A],void 0,Dn,void 0,{typeAnnotation:"coerce"});if(!P)return!1;w[A]=P}a[a.length-1].options.params=w}if(x){if(typeof x!="object"||x.constructor!==Object)return b.error('Image options "iconset" should be an object'),!1;if(!x.id)return b.error('Image options "iconset" should have an "id" property'),!1;a[a.length-1].options.iconset=x}return s++,!0}var p;return!0}for(let p=0;p<2;p++)if(!u()||!h())return;return new ga(a[0].image,a[1]?a[1].image:void 0,a[0].options,a[1]?a[1].options:void 0)}evaluateParams(e,i){const s={};if(i){for(const a in i)if(i[a])try{s[a]=i[a].evaluate(e)}catch{continue}if(Object.keys(s).length!==0)return{params:s}}}evaluate(e){const i={name:this.namePrimary.evaluate(e),iconsetId:this.iconsetIdPrimary},s=this.nameSecondary?{name:this.nameSecondary.evaluate(e),iconsetId:this.iconsetIdSecondary}:void 0,a=In.build(i,s,this.paramsPrimary?this.evaluateParams(e,this.paramsPrimary):void 0,this.paramsSecondary?this.evaluateParams(e,this.paramsSecondary):void 0);if(a&&e.availableImages){const u=a.getPrimary().id;if(a.available=e.availableImages.some(h=>Ln.isEqual(h,u)),a.available){const h=a.getSecondary()?a.getSecondary().id:null;h&&(a.available=e.availableImages.some(p=>Ln.isEqual(p,h)))}}return a}eachChild(e){if(e(this.namePrimary),this.paramsPrimary)for(const i in this.paramsPrimary)this.paramsPrimary[i]&&e(this.paramsPrimary[i]);if(this.nameSecondary&&(e(this.nameSecondary),this.paramsSecondary))for(const i in this.paramsSecondary)this.paramsSecondary[i]&&e(this.paramsSecondary[i])}outputDefined(){return!1}serializeOptions(e,i){const s={};if(i&&(s.iconset={id:i}),e){s.params={};for(const a in e)e[a]&&(s.params[a]=e[a].serialize())}return Object.keys(s).length>0?s:void 0}serialize(){const e=["image",this.namePrimary.serialize()];if(this.paramsPrimary||this.iconsetIdPrimary){const i=this.serializeOptions(this.paramsPrimary,this.iconsetIdPrimary);i&&e.push(i)}if(this.nameSecondary&&(e.push(this.nameSecondary.serialize()),this.paramsSecondary||this.iconsetIdSecondary)){const i=this.serializeOptions(this.paramsSecondary,this.iconsetIdSecondary);i&&e.push(i)}return e}}function no(r){return r instanceof Number?"number":r instanceof String?"string":r instanceof Boolean?"boolean":Array.isArray(r)?"array":r===null?"null":typeof r}const Rd={"to-boolean":Ci,"to-color":Dn,"to-number":Lt,"to-string":Ni};class Kn{constructor(e,i){this.type=e,this.args=i}static parse(e,i){if(e.length<2)return i.error("Expected at least one argument.");const s=e[0],a=[];let u=pa;if(s==="to-array"){if(!Array.isArray(e[1]))return null;const h=e[1].length;if(i.expectedType){if(i.expectedType.kind!=="array")return i.error(`Expected ${i.expectedType.kind} but found array.`);u=yn(i.expectedType.itemType,h)}else{if(!(h>0&&oi(e[1][0])))return null;u=yn(xt(e[1][0]),h)}for(let p=0;p<h;p++){const _=e[1][p];let g;if(no(_)==="array")g=i.parse(_,void 0,u.itemType);else{const x=no(_);if(x!==u.itemType.kind)return i.error(`Expected ${u.itemType.kind} but found ${x}.`);g=i.registry.literal.parse(["literal",_===void 0?null:_],i)}if(!g)return null;a.push(g)}}else{if((s==="to-boolean"||s==="to-string")&&e.length!==2)return i.error("Expected one argument.");u=Rd[s];for(let h=1;h<e.length;h++){const p=i.parse(e[h],h,Ri);if(!p)return null;a.push(p)}}return new Kn(u,a)}evaluate(e){if(this.type.kind==="boolean")return!!this.args[0].evaluate(e);if(this.type.kind==="color"){let i,s;for(const a of this.args){if(i=a.evaluate(e),s=null,i instanceof Pi)return i;if(typeof i=="string"){const u=e.parseColor(i);if(u)return u}else if(Array.isArray(i)&&(s=i.length<3||i.length>4?`Invalid rbga value ${JSON.stringify(i)}: expected an array containing either three or four numeric values.`:Uo(i[0],i[1],i[2],i[3]),!s))return new Pi(i[0]/255,i[1]/255,i[2]/255,i[3])}throw new Nr(s||`Could not parse color from value '${typeof i=="string"?i:String(JSON.stringify(i))}'`)}if(this.type.kind==="number"){let i=null;for(const s of this.args){if(i=s.evaluate(e),i===null)return 0;const a=Number(i);if(!isNaN(a))return a}throw new Nr(`Could not convert ${JSON.stringify(i)} to number.`)}return this.type.kind==="formatted"?vn.fromString(Yn(this.args[0].evaluate(e))):this.type.kind==="resolvedImage"?In.build(Yn(this.args[0].evaluate(e))):this.type.kind==="array"?this.args.map(i=>i.evaluate(e)):Yn(this.args[0].evaluate(e))}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){if(this.type.kind==="formatted")return new _a([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if(this.type.kind==="resolvedImage")return new ga(this.args[0]).serialize();const e=this.type.kind==="array"?[]:[`to-${this.type.kind}`];return this.eachChild(i=>{e.push(i.serialize())}),e}}const xn=["Unknown","Point","LineString","Polygon"];class Tl{constructor(e,i){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null,this.scope=e,this.options=i}id(){return this.feature&&this.feature.id!==void 0?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?xn[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}measureLight(e){return this.globals.brightness||0}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const e=this.featureDistanceData.center,i=this.featureDistanceData.scale,{x:s,y:a}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(s*i-e[0])+this.featureDistanceData.bearing[1]*(a*i-e[1])}return 0}parseColor(e){let i=this._parseColorCache[e];return i||(i=this._parseColorCache[e]=Pi.parse(e)),i}getConfig(e){return this.options?this.options.get(e):null}}class Yr{constructor(e,i,s,a,u){this.name=e,this.type=i,this._evaluate=s,this.args=a,this._overloadIndex=u}evaluate(e){if(!this._evaluate){const i=Yr.definitions[this.name];this._evaluate=Array.isArray(i)?i[2]:i.overloads[this._overloadIndex][1]}return this._evaluate(e,this.args)}eachChild(e){this.args.forEach(e)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map(e=>e.serialize()))}static parse(e,i){const s=e[0],a=Yr.definitions[s];if(!a)return i.error(`Unknown expression "${s}". If you wanted a literal array, use ["literal", [...]].`,0);const u=Array.isArray(a)?a[0]:a.type,h=Array.isArray(a)?[[a[1],a[2]]]:a.overloads,p=[];let _=null,g=-1;for(const[x,b]of h){if(Array.isArray(x)&&x.length!==e.length-1)continue;p.push(x),g++,_=new Fc(i.registry,i.path,null,i.scope,void 0,i._scope,i.options);const w=[];let E=!1;for(let A=1;A<e.length;A++){const P=e[A],L=Array.isArray(x)?x[A-1]:x.type,k=_.parse(P,1+w.length,L);if(!k){E=!0;break}w.push(k)}if(!E)if(Array.isArray(x)&&x.length!==w.length)_.error(`Expected ${x.length} arguments, but found ${w.length} instead.`);else{for(let A=0;A<w.length;A++){const P=Array.isArray(x)?x[A]:x.type,L=w[A];_.concat(A+1).checkSubtype(P,L.type)}if(_.errors.length===0)return new Yr(s,u,b,w,g)}}if(p.length===1)i.errors.push(..._.errors);else{const x=(p.length?p:h.map(([w])=>w)).map(Hu).join(" | "),b=[];for(let w=1;w<e.length;w++){const E=i.parse(e[w],1+b.length);if(!E)return null;b.push(jr(E.type))}i.error(`Expected arguments of type ${x}, but found (${b.join(", ")}) instead.`)}return null}static register(e,i){Yr.definitions=i;for(const s in i)e[s]=Yr}}function Hu(r){return Array.isArray(r)?`(${r.map(jr).join(", ")})`:`(${jr(r.type)}...)`}class _s{constructor(e,i,s){this.type=Tc,this.locale=s,this.caseSensitive=e,this.diacriticSensitive=i}static parse(e,i){if(e.length!==2)return i.error("Expected one argument.");const s=e[1];if(typeof s!="object"||Array.isArray(s))return i.error("Collator options argument must be an object.");const a=s["case-sensitive"]===void 0?i.parse(!1,1,Ci):i.parseObjectValue(s["case-sensitive"],1,"case-sensitive",Ci);if(!a)return null;const u=s["diacritic-sensitive"]===void 0?i.parse(!1,1,Ci):i.parseObjectValue(s["diacritic-sensitive"],1,"diacritic-sensitive",Ci);if(!u)return null;let h=null;return s.locale&&(h=i.parseObjectValue(s.locale,1,"locale",Ni),!h)?null:new _s(a,u,h)}evaluate(e){return new bl(this.caseSensitive.evaluate(e),this.diacriticSensitive.evaluate(e),this.locale?this.locale.evaluate(e):null)}eachChild(e){e(this.caseSensitive),e(this.diacriticSensitive),this.locale&&e(this.locale)}outputDefined(){return!1}serialize(){const e={};return e["case-sensitive"]=this.caseSensitive.serialize(),e["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(e.locale=this.locale.serialize()),["collator",e]}}function cn(r,e,i=0,s=r.length-1,a=kp){for(;s>i;){if(s-i>600){const _=s-i+1,g=e-i+1,x=Math.log(_),b=.5*Math.exp(2*x/3),w=.5*Math.sqrt(x*b*(_-b)/_)*(g-_/2<0?-1:1);cn(r,e,Math.max(i,Math.floor(e-g*b/_+w)),Math.min(s,Math.floor(e+(_-g)*b/_+w)),a)}const u=r[e];let h=i,p=s;for(Sl(r,i,e),a(r[s],u)>0&&Sl(r,i,s);h<p;){for(Sl(r,h,p),h++,p--;a(r[h],u)<0;)h++;for(;a(r[p],u)>0;)p--}a(r[i],u)===0?Sl(r,i,p):(p++,Sl(r,p,s)),p<=e&&(i=p+1),e<=p&&(s=p-1)}}function Sl(r,e,i){const s=r[e];r[e]=r[i],r[i]=s}function kp(r,e){return r<e?-1:r>e?1:0}function Fp(r){let e=0;for(let i,s,a=0,u=r.length,h=u-1;a<u;h=a++)i=r[a],s=r[h],e+=(s.x-i.x)*(i.y+s.y);return e}function so(r,e){r[0]=Math.min(r[0],e[0]),r[1]=Math.min(r[1],e[1]),r[2]=Math.max(r[2],e[0]),r[3]=Math.max(r[3],e[1])}function ya(r,e){return!(r[0]<=e[0]||r[2]>=e[2]||r[1]<=e[1]||r[3]>=e[3])}function jo(r,e,i){const s=r[0]-e[0],a=r[1]-e[1],u=r[0]-i[0],h=r[1]-i[1];return s*h-u*a==0&&s*u<=0&&a*h<=0}function va(r,e,i=!1){let s=!1;for(let p=0,_=e.length;p<_;p++){const g=e[p];for(let x=0,b=g.length,w=b-1;x<b;w=x++){const E=g[w],A=g[x];if(jo(r,E,A))return i;(u=E)[1]>(a=r)[1]!=(h=A)[1]>a[1]&&a[0]<(h[0]-u[0])*(a[1]-u[1])/(h[1]-u[1])+u[0]&&(s=!s)}}var a,u,h;return s}function zd(r,e,i,s){const a=s[0]-i[0],u=s[1]-i[1],h=(r[0]-i[0])*u-a*(r[1]-i[1]),p=(e[0]-i[0])*u-a*(e[1]-i[1]);return h>0&&p<0||h<0&&p>0}function Ic(r,e,i,s){return(a=[s[0]-i[0],s[1]-i[1]])[0]*(u=[e[0]-r[0],e[1]-r[1]])[1]-a[1]*u[0]!=0&&!(!zd(r,e,i,s)||!zd(i,s,r,e));var a,u}function Zu(r){const e=new ut(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),i=new ut(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(const s of r[0])e.x>s.x&&(e.x=s.x),e.y>s.y&&(e.y=s.y),i.x<s.x&&(i.x=s.x),i.y<s.y&&(i.y=s.y);return{min:e,max:i}}const Ls=8192;function Bp(r,e){const i=(180+r[0])/360,s=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+r[1]*Math.PI/360)))/360,a=Math.pow(2,e.z);return[Math.round(i*a*Ls),Math.round(s*a*Ls)]}function Np(r,e){for(let i=0;i<e.length;i++)if(va(r,e[i]))return!0;return!1}function Ld(r,e,i){for(const s of i)for(let a=0,u=s.length,h=u-1;a<u;h=a++)if(Ic(r,e,s[h],s[a]))return!0;return!1}function Dd(r,e){for(let i=0;i<r.length;++i)if(!va(r[i],e))return!1;for(let i=0;i<r.length-1;++i)if(Ld(r[i],r[i+1],e))return!1;return!0}function Go(r,e){for(let i=0;i<e.length;i++)if(Dd(r,e[i]))return!0;return!1}function Wu(r,e,i){const s=[];for(let a=0;a<r.length;a++){const u=[];for(let h=0;h<r[a].length;h++){const p=Bp(r[a][h],i);so(e,p),u.push(p)}s.push(u)}return s}function Od(r,e,i){const s=[];for(let a=0;a<r.length;a++){const u=Wu(r[a],e,i);s.push(u)}return s}function Ac(r,e,i,s){if(r[0]<i[0]||r[0]>i[2]){const a=.5*s;let u=r[0]-i[0]>a?-s:i[0]-r[0]>a?s:0;u===0&&(u=r[0]-i[2]>a?-s:i[2]-r[0]>a?s:0),r[0]+=u}so(e,r)}function Xu(r,e,i,s){const a=Math.pow(2,s.z)*Ls,u=[s.x*Ls,s.y*Ls],h=[];if(!r)return h;for(const p of r)for(const _ of p){const g=[_.x+u[0],_.y+u[1]];Ac(g,e,i,a),h.push(g)}return h}function Yu(r,e,i,s){const a=Math.pow(2,s.z)*Ls,u=[s.x*Ls,s.y*Ls],h=[];if(!r)return h;for(const _ of r){const g=[];for(const x of _){const b=[x.x+u[0],x.y+u[1]];so(e,b),g.push(b)}h.push(g)}if(e[2]-e[0]<=a/2){(p=e)[0]=p[1]=1/0,p[2]=p[3]=-1/0;for(const _ of h)for(const g of _)Ac(g,e,i,a)}var p;return h}class un{constructor(e,i){this.type=Ci,this.geojson=e,this.geometries=i}static parse(e,i){if(e.length!==2)return i.error(`'within' expression requires exactly one argument, but found ${e.length-1} instead.`);if(oi(e[1])){const s=e[1];if(s.type==="FeatureCollection")for(let a=0;a<s.features.length;++a){const u=s.features[a].geometry.type;if(u==="Polygon"||u==="MultiPolygon")return new un(s,s.features[a].geometry)}else if(s.type==="Feature"){const a=s.geometry.type;if(a==="Polygon"||a==="MultiPolygon")return new un(s,s.geometry)}else if(s.type==="Polygon"||s.type==="MultiPolygon")return new un(s,s)}return i.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(e){if(e.geometry()!=null&&e.canonicalID()!=null){if(e.geometryType()==="Point")return function(i,s){const a=[1/0,1/0,-1/0,-1/0],u=[1/0,1/0,-1/0,-1/0],h=i.canonicalID();if(!h)return!1;if(s.type==="Polygon"){const p=Wu(s.coordinates,u,h),_=Xu(i.geometry(),a,u,h);if(!ya(a,u))return!1;for(const g of _)if(!va(g,p))return!1}if(s.type==="MultiPolygon"){const p=Od(s.coordinates,u,h),_=Xu(i.geometry(),a,u,h);if(!ya(a,u))return!1;for(const g of _)if(!Np(g,p))return!1}return!0}(e,this.geometries);if(e.geometryType()==="LineString")return function(i,s){const a=[1/0,1/0,-1/0,-1/0],u=[1/0,1/0,-1/0,-1/0],h=i.canonicalID();if(!h)return!1;if(s.type==="Polygon"){const p=Wu(s.coordinates,u,h),_=Yu(i.geometry(),a,u,h);if(!ya(a,u))return!1;for(const g of _)if(!Dd(g,p))return!1}if(s.type==="MultiPolygon"){const p=Od(s.coordinates,u,h),_=Yu(i.geometry(),a,u,h);if(!ya(a,u))return!1;for(const g of _)if(!Go(g,p))return!1}return!0}(e,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}const El={kilometers:1,miles:1e3/1609.344,nauticalmiles:1e3/1852,meters:1e3,metres:1e3,yards:1e3/.9144,feet:1e3/.3048,inches:1e3/.0254},Ku=1/298.257223563,Ju=Ku*(2-Ku),xa=Math.PI/180;class ba{static fromTile(e,i,s){const a=Math.PI*(1-2*(e+.5)/Math.pow(2,i)),u=Math.atan(.5*(Math.exp(a)-Math.exp(-a)))/xa;return new ba(u,s)}static get units(){return El}constructor(e,i){if(e===void 0)throw new Error("No latitude given.");if(i&&!El[i])throw new Error(`Unknown unit ${i}. Use one of: ${Object.keys(El).join(", ")}`);const s=6378.137*xa*(i?El[i]:1),a=Math.cos(e*xa),u=1/(1-Ju*(1-a*a)),h=Math.sqrt(u);this.kx=s*h*a,this.ky=s*h*u*(1-Ju)}distance(e,i){const s=qn(e[0]-i[0])*this.kx,a=(e[1]-i[1])*this.ky;return Math.sqrt(s*s+a*a)}bearing(e,i){const s=qn(i[0]-e[0])*this.kx;return Math.atan2(s,(i[1]-e[1])*this.ky)/xa}destination(e,i,s){const a=s*xa;return this.offset(e,Math.sin(a)*i,Math.cos(a)*i)}offset(e,i,s){return[e[0]+i/this.kx,e[1]+s/this.ky]}lineDistance(e){let i=0;for(let s=0;s<e.length-1;s++)i+=this.distance(e[s],e[s+1]);return i}area(e){let i=0;for(let s=0;s<e.length;s++){const a=e[s];for(let u=0,h=a.length,p=h-1;u<h;p=u++)i+=qn(a[u][0]-a[p][0])*(a[u][1]+a[p][1])*(s?-1:1)}return Math.abs(i)/2*this.kx*this.ky}along(e,i){let s=0;if(i<=0)return e[0];for(let a=0;a<e.length-1;a++){const u=e[a],h=e[a+1],p=this.distance(u,h);if(s+=p,s>i)return Cc(u,h,(i-(s-p))/p)}return e[e.length-1]}pointToSegmentDistance(e,i,s){let[a,u]=i,h=qn(s[0]-a)*this.kx,p=(s[1]-u)*this.ky;if(h!==0||p!==0){const _=(qn(e[0]-a)*this.kx*h+(e[1]-u)*this.ky*p)/(h*h+p*p);_>1?(a=s[0],u=s[1]):_>0&&(a+=h/this.kx*_,u+=p/this.ky*_)}return h=qn(e[0]-a)*this.kx,p=(e[1]-u)*this.ky,Math.sqrt(h*h+p*p)}pointOnLine(e,i){let s=1/0,a=e[0][0],u=e[0][1],h=0,p=0;for(let _=0;_<e.length-1;_++){let g=e[_][0],x=e[_][1],b=qn(e[_+1][0]-g)*this.kx,w=(e[_+1][1]-x)*this.ky,E=0;b===0&&w===0||(E=(qn(i[0]-g)*this.kx*b+(i[1]-x)*this.ky*w)/(b*b+w*w),E>1?(g=e[_+1][0],x=e[_+1][1]):E>0&&(g+=b/this.kx*E,x+=w/this.ky*E)),b=qn(i[0]-g)*this.kx,w=(i[1]-x)*this.ky;const A=b*b+w*w;A<s&&(s=A,a=g,u=x,h=_,p=E)}return{point:[a,u],index:h,t:Math.max(0,Math.min(1,p))}}lineSlice(e,i,s){let a=this.pointOnLine(s,e),u=this.pointOnLine(s,i);if(a.index>u.index||a.index===u.index&&a.t>u.t){const g=a;a=u,u=g}const h=[a.point],p=a.index+1,_=u.index;!Qu(s[p],h[0])&&p<=_&&h.push(s[p]);for(let g=p+1;g<=_;g++)h.push(s[g]);return Qu(s[_],u.point)||h.push(u.point),h}lineSliceAlong(e,i,s){let a=0;const u=[];for(let h=0;h<s.length-1;h++){const p=s[h],_=s[h+1],g=this.distance(p,_);if(a+=g,a>e&&u.length===0&&u.push(Cc(p,_,(e-(a-g))/g)),a>=i)return u.push(Cc(p,_,(i-(a-g))/g)),u;a>e&&u.push(_)}return u}bufferPoint(e,i){const s=i/this.ky,a=i/this.kx;return[e[0]-a,e[1]-s,e[0]+a,e[1]+s]}bufferBBox(e,i){const s=i/this.ky,a=i/this.kx;return[e[0]-a,e[1]-s,e[2]+a,e[3]+s]}insideBBox(e,i){return qn(e[0]-i[0])>=0&&qn(e[0]-i[2])<=0&&e[1]>=i[1]&&e[1]<=i[3]}}function Qu(r,e){return r[0]===e[0]&&r[1]===e[1]}function Cc(r,e,i){const s=qn(e[0]-r[0]);return[r[0]+s*i,r[1]+(e[1]-r[1])*i]}function qn(r){for(;r<-180;)r+=360;for(;r>180;)r-=360;return r}class Mc{constructor(e=[],i=(s,a)=>s<a?-1:s>a?1:0){if(this.data=e,this.length=this.data.length,this.compare=i,this.length>0)for(let s=(this.length>>1)-1;s>=0;s--)this._down(s)}push(e){this.data.push(e),this._up(this.length++)}pop(){if(this.length===0)return;const e=this.data[0],i=this.data.pop();return--this.length>0&&(this.data[0]=i,this._down(0)),e}peek(){return this.data[0]}_up(e){const{data:i,compare:s}=this,a=i[e];for(;e>0;){const u=e-1>>1,h=i[u];if(s(a,h)>=0)break;i[e]=h,e=u}i[e]=a}_down(e){const{data:i,compare:s}=this,a=this.length>>1,u=i[e];for(;e<a;){let h=1+(e<<1);const p=h+1;if(p<this.length&&s(i[p],i[h])<0&&(h=p),s(i[h],u)>=0)break;i[e]=i[h],e=h}i[e]=u}}var dt=8192;function eh(r,e){return e.dist-r.dist}const wa=100,Ta=50;function Il(r){const e=[1/0,1/0,-1/0,-1/0];if(e.length!==r.length)return!1;for(let i=0;i<e.length;i++)if(e[i]!==r[i])return!1;return!0}function Al(r){return r[1]-r[0]+1}function gs(r,e){const i=r[1]>=r[0]&&r[1]<e;return i||console.warn("Distance Expression: Index is out of range"),i}function Pc(r,e){if(r[0]>r[1])return[null,null];const i=Al(r);if(e){if(i===2)return[r,null];const s=Math.floor(i/2);return[[r[0],r[0]+s],[r[0]+s,r[1]]]}{if(i===1)return[r,null];const s=Math.floor(i/2)-1;return[[r[0],r[0]+s],[r[0]+s+1,r[1]]]}}function Jn(r,e){const i=[1/0,1/0,-1/0,-1/0];if(!gs(e,r.length))return i;for(let s=e[0];s<=e[1];++s)so(i,r[s]);return i}function pi(r){const e=[1/0,1/0,-1/0,-1/0];for(let i=0;i<r.length;++i)for(let s=0;s<r[i].length;++s)so(e,r[i][s]);return e}function Sa(r,e,i){if(Il(r)||Il(e))return NaN;let s=0,a=0;return r[2]<e[0]&&(s=e[0]-r[2]),r[0]>e[2]&&(s=r[0]-e[2]),r[1]>e[3]&&(a=r[1]-e[3]),r[3]<e[1]&&(a=e[1]-r[3]),i.distance([0,0],[s,a])}function Vp(r){return 360*r-180}function Up(r){return 360/Math.PI*Math.atan(Math.exp((180-360*r)*Math.PI/180))-90}function Rc(r,e){const i=Math.pow(2,e.z),s=(r.y/dt+e.y)/i;return[Vp((r.x/dt+e.x)/i),Up(s)]}function jp(r,e){const i=[];for(let s=0;s<r.length;++s)i.push(Rc(r[s],e));return i}function gr(r,e,i){const s=i.pointOnLine(e,r).point;return i.distance(r,s)}function kd(r,e,i,s,a){const u=i.slice(s[0],s[1]+1);let h=1/0;for(let p=e[0];p<=e[1];++p)if((h=Math.min(h,gr(r[p],u,a)))===0)return 0;return h}function th(r,e,i,s,a){const u=Math.min(a.pointToSegmentDistance(r,i,s),a.pointToSegmentDistance(e,i,s)),h=Math.min(a.pointToSegmentDistance(i,r,e),a.pointToSegmentDistance(s,r,e));return Math.min(u,h)}function Gp(r,e,i,s,a){if(!gs(e,r.length)||!gs(s,i.length))return NaN;let u=1/0;for(let h=e[0];h<e[1];++h)for(let p=s[0];p<s[1];++p){if(Ic(r[h],r[h+1],i[p],i[p+1]))return 0;u=Math.min(u,th(r[h],r[h+1],i[p],i[p+1],a))}return u}function qp(r,e,i,s,a){if(!gs(e,r.length)||!gs(s,i.length))return NaN;let u=1/0;for(let h=e[0];h<=e[1];++h)for(let p=s[0];p<=s[1];++p)if((u=Math.min(u,a.distance(r[h],i[p])))===0)return u;return u}function $p(r,e,i){if(va(r,e,!0))return 0;let s=1/0;for(const a of e){const u=a.length;if(u<2)return console.warn("Distance Expression: Invalid polygon!"),NaN;if(a[0]!==a[u-1]&&(s=Math.min(s,i.pointToSegmentDistance(r,a[u-1],a[0])))===0||(s=Math.min(s,gr(r,a,i)))===0)return s}return s}function Hp(r,e,i,s){if(!gs(e,r.length))return NaN;for(let u=e[0];u<=e[1];++u)if(va(r[u],i,!0))return 0;let a=1/0;for(let u=e[0];u<e[1];++u)for(const h of i)for(let p=0,_=h.length,g=_-1;p<_;g=p++){if(Ic(r[u],r[u+1],h[g],h[p]))return 0;a=Math.min(a,th(r[u],r[u+1],h[g],h[p],s))}return a}function Fd(r,e){for(const i of r)for(let s=0;s<=i.length-1;++s)if(va(i[s],e,!0))return!0;return!1}function Zp(r,e,i,s=1/0){const a=pi(r),u=pi(e);if(s!==1/0&&Sa(a,u,i)>=s)return s;if(ya(a,u)){if(Fd(r,e))return 0}else if(Fd(e,r))return 0;let h=s;for(const p of r)for(let _=0,g=p.length,x=g-1;_<g;x=_++)for(const b of e)for(let w=0,E=b.length,A=E-1;w<E;A=w++){if(Ic(p[x],p[_],b[A],b[w]))return 0;h=Math.min(h,th(p[x],p[_],b[A],b[w],i))}return h}function zc(r,e,i,s,a,u,h){if(u===null||h===null)return;const p=Sa(Jn(s,u),Jn(a,h),i);p<e&&r.push({dist:p,range1:u,range2:h})}function Wp(r,e,i,s,a=1/0){let u=Math.min(s.distance(r[0],i[0][0]),a);if(u===0)return u;const h=new Mc([{dist:0,range1:[0,r.length-1],range2:[0,0]}],eh),p=e?Ta:wa,_=pi(i);for(;h.length;){const g=h.pop();if(g.dist>=u)continue;const x=g.range1;if(Al(x)<=p){if(!gs(x,r.length))return NaN;if(e){const b=Hp(r,x,i,s);if((u=Math.min(u,b))===0)return u}else for(let b=x[0];b<=x[1];++b){const w=$p(r[b],i,s);if((u=Math.min(u,w))===0)return u}}else{const b=Pc(x,e);if(b[0]!==null){const w=Sa(Jn(r,b[0]),_,s);w<u&&h.push({dist:w,range1:b[0],range2:[0,0]})}if(b[1]!==null){const w=Sa(Jn(r,b[1]),_,s);w<u&&h.push({dist:w,range1:b[1],range2:[0,0]})}}}return u}function Bd(r,e,i,s,a,u=1/0){let h=Math.min(u,a.distance(r[0],i[0]));if(h===0)return h;const p=new Mc([{dist:0,range1:[0,r.length-1],range2:[0,i.length-1]}],eh),_=e?Ta:wa,g=s?Ta:wa;for(;p.length;){const x=p.pop();if(x.dist>=h)continue;const b=x.range1,w=x.range2;if(Al(b)<=_&&Al(w)<=g){if(!gs(b,r.length)||!gs(w,i.length))return NaN;if(e&&s?h=Math.min(h,Gp(r,b,i,w,a)):e||s?e&&!s?h=Math.min(h,kd(i,w,r,b,a)):!e&&s&&(h=Math.min(h,kd(r,b,i,w,a))):h=Math.min(h,qp(r,b,i,w,a)),h===0)return h}else{const E=Pc(b,e),A=Pc(w,s);zc(p,h,a,r,i,E[0],A[0]),zc(p,h,a,r,i,E[0],A[1]),zc(p,h,a,r,i,E[1],A[0]),zc(p,h,a,r,i,E[1],A[1])}}return h}function ih(r,e,i,s,a=1/0){let u=a;const h=Jn(r,[0,r.length-1]);for(const p of i)if(!(u!==1/0&&Sa(h,Jn(p,[0,p.length-1]),s)>=u)&&(u=Math.min(u,Bd(r,e,p,!0,s,u)),u===0))return u;return u}function Lc(r,e,i,s,a=1/0){let u=a;const h=Jn(r,[0,r.length-1]);for(const p of i){if(u!==1/0&&Sa(h,pi(p),s)>=u)continue;const _=Wp(r,e,p,s,u);if(isNaN(_))return _;if((u=Math.min(u,_))===0)return u}return u}function rh(r){return r==="Point"||r==="MultiPoint"||r==="LineString"||r==="MultiLineString"||r==="Polygon"||r==="MultiPolygon"}class qo{constructor(e,i){this.type=Lt,this.geojson=e,this.geometries=i}static parse(e,i){if(e.length!==2)return i.error(`'distance' expression requires either one argument, but found ' ${e.length-1} instead.`);if(oi(e[1])){const s=e[1];if(s.type==="FeatureCollection"){for(let a=0;a<s.features.length;++a)if(rh(s.features[a].geometry.type))return new qo(s,s.features[a].geometry)}else if(s.type==="Feature"){if(rh(s.geometry.type))return new qo(s,s.geometry)}else if(rh(s.type))return new qo(s,s)}return i.error("'distance' expression needs to be an array with format ['Distance', GeoJSONObj].")}evaluate(e){const i=e.geometry(),s=e.canonicalID();if(i!=null&&s!=null){if(e.geometryType()==="Point")return function(a,u,h){const p=[];for(const g of a)for(const x of g)p.push(Rc(x,u));const _=new ba(p[0][1],"meters");return h.type==="Point"||h.type==="MultiPoint"||h.type==="LineString"?Bd(p,!1,h.type==="Point"?[h.coordinates]:h.coordinates,h.type==="LineString",_):h.type==="MultiLineString"?ih(p,!1,h.coordinates,_):h.type==="Polygon"||h.type==="MultiPolygon"?Lc(p,!1,h.type==="Polygon"?[h.coordinates]:h.coordinates,_):null}(i,s,this.geometries);if(e.geometryType()==="LineString")return function(a,u,h){const p=[];for(const g of a){const x=[];for(const b of g)x.push(Rc(b,u));p.push(x)}const _=new ba(p[0][0][1],"meters");if(h.type==="Point"||h.type==="MultiPoint"||h.type==="LineString")return ih(h.type==="Point"?[h.coordinates]:h.coordinates,h.type==="LineString",p,_);if(h.type==="MultiLineString"){let g=1/0;for(let x=0;x<h.coordinates.length;x++){const b=ih(h.coordinates[x],!0,p,_,g);if(isNaN(b))return b;if((g=Math.min(g,b))===0)return g}return g}if(h.type==="Polygon"||h.type==="MultiPolygon"){let g=1/0;for(let x=0;x<p.length;x++){const b=Lc(p[x],!0,h.type==="Polygon"?[h.coordinates]:h.coordinates,_,g);if(isNaN(b))return b;if((g=Math.min(g,b))===0)return g}return g}return null}(i,s,this.geometries);if(e.geometryType()==="Polygon")return function(a,u,h){const p=[];for(const g of function(x,b){const w=x.length;if(w<=1)return[x];const E=[];let A,P;for(let L=0;L<w;L++){const k=Fp(x[L]);k!==0&&(x[L].area=Math.abs(k),P===void 0&&(P=k<0),P===k<0?(A&&E.push(A),A=[x[L]]):A.push(x[L]))}return A&&E.push(A),E}(a)){const x=[];for(let b=0;b<g.length;++b)x.push(jp(g[b],u));p.push(x)}const _=new ba(p[0][0][0][1],"meters");if(h.type==="Point"||h.type==="MultiPoint"||h.type==="LineString")return Lc(h.type==="Point"?[h.coordinates]:h.coordinates,h.type==="LineString",p,_);if(h.type==="MultiLineString"){let g=1/0;for(let x=0;x<h.coordinates.length;x++){const b=Lc(h.coordinates[x],!0,p,_,g);if(isNaN(b))return b;if((g=Math.min(g,b))===0)return g}return g}return h.type==="Polygon"||h.type==="MultiPolygon"?function(g,x,b){let w=1/0;for(const E of g)for(const A of x){const P=Zp(E,A,b,w);if(isNaN(P))return P;if((w=Math.min(w,P))===0)return w}return w}(h.type==="Polygon"?[h.coordinates]:h.coordinates,p,_):null}(i,s,this.geometries);console.warn("Distance Expression: currently only evaluates valid Point/LineString/Polygon geometries.")}else console.warn("Distance Expression: requirs valid feature and canonical information.");return null}eachChild(){}outputDefined(){return!0}serialize(){return["distance",this.geojson]}}function Ea(r){if(r instanceof Yr&&(r.name==="get"&&r.args.length===1||r.name==="feature-state"||r.name==="has"&&r.args.length===1||r.name==="properties"||r.name==="geometry-type"||r.name==="id"||/^filter-/.test(r.name))||r instanceof un||r instanceof qo)return!1;if(r instanceof Aa)return r.featureConstant;let e=!0;return r.eachChild(i=>{e&&!Ea(i)&&(e=!1)}),e}function Dc(r){if(r instanceof Yr&&r.name==="feature-state")return!1;let e=!0;return r.eachChild(i=>{e&&!Dc(i)&&(e=!1)}),e}function Oc(r){if(r instanceof Aa)return new Set([r.key]);let e=new Set;return r.eachChild(i=>{e=new Set([...e,...Oc(i)])}),e}function Ia(r,e){if(r instanceof Yr&&e.indexOf(r.name)>=0)return!1;let i=!0;return r.eachChild(s=>{i&&!Ia(s,e)&&(i=!1)}),i}function Nd(r,e,i){return[r,e,i].filter(Boolean).join("")}function nh(r,e){switch(r){case"string":return Yn(e);case"number":return+e;case"boolean":return!!e;case"color":return Pi.parse(e);case"formatted":return vn.fromString(Yn(e));case"resolvedImage":return In.build(Yn(e))}return e}function Vd(r,e,i,s){return s!==void 0&&(r=s*Math.round(r/s)),e!==void 0&&r<e&&(r=e),i!==void 0&&r>i&&(r=i),r}class Aa{constructor(e,i,s,a=!1){this.type=e,this.key=i,this.scope=s,this.featureConstant=a}static parse(e,i){let s=i.expectedType;if(s==null&&(s=Ri),e.length<2||e.length>3)return i.error("Invalid number of arguments for 'config' expression.");const a=i.parse(e[1],1);if(!(a instanceof Zt))return i.error("Key name of 'config' expression must be a string literal.");let u,h=!0;const p=Yn(a.value);if(e.length>=3){const _=i.parse(e[2],2);if(!(_ instanceof Zt))return i.error("Scope of 'config' expression must be a string literal.");u=Yn(_.value)}if(i.options){const _=Nd(p,u,i._scope),g=i.options.get(_);g&&(h=Ea(g.value||g.default))}return new Aa(s,p,u,h)}evaluate(e){const i=Nd(this.key,this.scope,e.scope),s=e.getConfig(i);if(!s)return null;const{type:a,value:u,values:h,minValue:p,maxValue:_,stepValue:g}=s,x=s.default.evaluate(e);let b=x;if(u){const w=e.scope;e.scope=(w||"").split("").slice(1).join(""),b=u.evaluate(e),e.scope=w}return a&&(b=nh(a,b)),b===void 0||p===void 0&&_===void 0&&g===void 0||(typeof b=="number"?b=Vd(b,p,_,g):Array.isArray(b)&&(b=b.map(w=>typeof w=="number"?Vd(w,p,_,g):w))),u!==void 0&&b!==void 0&&h&&!h.includes(b)&&(b=x,a&&(b=nh(a,b))),(a&&a!==this.type||b!==void 0&&!Sc(xt(b),this.type))&&(b=nh(this.type.kind,b)),b}eachChild(){}outputDefined(){return!1}serialize(){const e=["config",this.key];return this.scope&&e.concat(this.scope),e}}class kc{constructor(e,i){this.type=i.type,this.name=e,this.boundExpression=i}static parse(e,i){if(e.length!==2||typeof e[1]!="string")return i.error("'var' expression requires exactly one string literal argument.");const s=e[1];return i.scope.has(s)?new kc(s,i.scope.get(s)):i.error(`Unknown variable "${s}". Make sure "${s}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(e){return this.boundExpression.evaluate(e)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}class Fc{constructor(e,i=[],s,a=new $u,u=[],h,p){this.registry=e,this.path=i,this.key=i.map(_=>typeof _=="string"?`['${_}']`:`[${_}]`).join(""),this.scope=a,this.errors=u,this.expectedType=s,this._scope=h,this.options=p}parse(e,i,s,a,u={}){return i||s?this.concat(i,null,s,a)._parse(e,u):this._parse(e,u)}parseObjectValue(e,i,s,a,u,h={}){return this.concat(i,s,a,u)._parse(e,h)}_parse(e,i){function s(a,u,h){return h==="assert"?new Nt(u,[a]):h==="coerce"?new Kn(u,[a]):a}if(e!==null&&typeof e!="string"&&typeof e!="boolean"&&typeof e!="number"||(e=["literal",e]),Array.isArray(e)){if(e.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const a=typeof e[0]=="string"?this.registry[e[0]]:void 0;if(a){let u=a.parse(e,this);if(!u)return null;if(this.expectedType){const h=this.expectedType,p=u.type;if(h.kind!=="string"&&h.kind!=="number"&&h.kind!=="boolean"&&h.kind!=="object"&&h.kind!=="array"||p.kind!=="value")if(h.kind!=="color"&&h.kind!=="formatted"&&h.kind!=="resolvedImage"||p.kind!=="value"&&p.kind!=="string"){if(this.checkSubtype(h,p))return null}else u=s(u,h,i.typeAnnotation||"coerce");else u=s(u,h,i.typeAnnotation||"assert")}if(!(u instanceof Zt)&&u.type.kind!=="resolvedImage"&&sh(u)){const h=new Tl(this._scope,this.options);try{u=new Zt(u.type,u.evaluate(h))}catch(p){return this.error(p.message),null}}return u}return Kn.parse(["to-array",e],this)}return this.error(e===void 0?"'undefined' value invalid. Use null instead.":typeof e=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof e} instead.`)}concat(e,i,s,a){let u=typeof e=="number"?this.path.concat(e):this.path;u=typeof i=="string"?u.concat(i):u;const h=a?this.scope.concat(a):this.scope;return new Fc(this.registry,u,s||null,h,this.errors,this._scope,this.options)}error(e,...i){const s=`${this.key}${i.map(a=>`[${a}]`).join("")}`;this.errors.push(new Gn(s,e))}checkSubtype(e,i){const s=ma(e,i);return s&&this.error(s),s}}function sh(r){if(r instanceof kc)return sh(r.boundExpression);if(r instanceof Yr&&r.name==="error"||r instanceof _s||r instanceof un||r instanceof qo||r instanceof Aa)return!1;const e=r instanceof Kn||r instanceof Nt;let i=!0;return r.eachChild(s=>{i=e?i&&sh(s):i&&s instanceof Zt}),!!i&&Ea(r)&&Ia(r,["zoom","heatmap-density","worldview","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])}function Bc(r,e){const i=r.length-1;let s,a,u=0,h=i,p=0;for(;u<=h;)if(p=Math.floor((u+h)/2),s=r[p],a=r[p+1],s<=e){if(p===i||e<a)return p;u=p+1}else{if(!(s>e))throw new Nr("Input is not a number.");h=p-1}return 0}class Cl{constructor(e,i,s){this.type=e,this.input=i,this.labels=[],this.outputs=[];for(const[a,u]of s)this.labels.push(a),this.outputs.push(u)}static parse(e,i){if(e.length-1<4)return i.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return i.error("Expected an even number of arguments.");const s=i.parse(e[1],1,Lt);if(!s)return null;const a=[];let u=null;i.expectedType&&i.expectedType.kind!=="value"&&(u=i.expectedType);for(let h=1;h<e.length;h+=2){const p=h===1?-1/0:e[h],_=e[h+1],g=h,x=h+1;if(typeof p!="number")return i.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',g);if(a.length&&a[a.length-1][0]>=p)return i.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',g);const b=i.parse(_,x,u);if(!b)return null;u=u||b.type,a.push([p,b])}return new Cl(u,s,a)}evaluate(e){const i=this.labels,s=this.outputs;if(i.length===1)return s[0].evaluate(e);const a=this.input.evaluate(e);if(a<=i[0])return s[0].evaluate(e);const u=i.length;return a>=i[u-1]?s[u-1].evaluate(e):s[Bc(i,a)].evaluate(e)}eachChild(e){e(this.input);for(const i of this.outputs)e(i)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}serialize(){const e=["step",this.input.serialize()];for(let i=0;i<this.labels.length;i++)i>0&&e.push(this.labels[i]),e.push(this.outputs[i].serialize());return e}}const Ud=.95047,jd=1.08883,Gd=4/29,oo=6/29,qd=3*oo*oo,$d=oo*oo*oo,Xp=Math.PI/180,Yp=180/Math.PI;function oh(r){return r>$d?Math.pow(r,1/3):r/qd+Gd}function Nc(r){return r>oo?r*r*r:qd*(r-Gd)}function Vc(r){return 255*(r<=.0031308?12.92*r:1.055*Math.pow(r,1/2.4)-.055)}function ao(r){return(r/=255)<=.04045?r/12.92:Math.pow((r+.055)/1.055,2.4)}function ah(r){const e=ao(r.r),i=ao(r.g),s=ao(r.b),a=oh((.4124564*e+.3575761*i+.1804375*s)/Ud),u=oh((.2126729*e+.7151522*i+.072175*s)/1);return{l:116*u-16,a:500*(a-u),b:200*(u-oh((.0193339*e+.119192*i+.9503041*s)/jd)),alpha:r.a}}function lh(r){let e=(r.l+16)/116,i=isNaN(r.a)?e:e+r.a/500,s=isNaN(r.b)?e:e-r.b/200;return e=1*Nc(e),i=Ud*Nc(i),s=jd*Nc(s),new Pi(Vc(3.2404542*i-1.5371385*e-.4985314*s),Vc(-.969266*i+1.8760108*e+.041556*s),Vc(.0556434*i-.2040259*e+1.0572252*s),r.alpha)}function Kp(r,e,i){const s=e-r;return r+i*(s>180||s<-180?s-360*Math.round(s/360):s)}const $o={forward:ah,reverse:lh,interpolate:function(r,e,i){return{l:Ut(r.l,e.l,i),a:Ut(r.a,e.a,i),b:Ut(r.b,e.b,i),alpha:Ut(r.alpha,e.alpha,i)}}},Ho={forward:function(r){const{l:e,a:i,b:s}=ah(r),a=Math.atan2(s,i)*Yp;return{h:a<0?a+360:a,c:Math.sqrt(i*i+s*s),l:e,alpha:r.a}},reverse:function(r){const e=r.h*Xp,i=r.c;return lh({l:r.l,a:Math.cos(e)*i,b:Math.sin(e)*i,alpha:r.alpha})},interpolate:function(r,e,i){return{h:Kp(r.h,e.h,i),c:Ut(r.c,e.c,i),l:Ut(r.l,e.l,i),alpha:Ut(r.alpha,e.alpha,i)}}};var Hd=Object.freeze({__proto__:null,hcl:Ho,lab:$o});class $n{constructor(e,i,s,a,u){this.type=e,this.operator=i,this.interpolation=s,this.input=a,this.labels=[],this.outputs=[];for(const[h,p]of u)this.labels.push(h),this.outputs.push(p)}static interpolationFactor(e,i,s,a){let u=0;if(e.name==="exponential")u=Uc(i,e.base,s,a);else if(e.name==="linear")u=Uc(i,1,s,a);else if(e.name==="cubic-bezier"){const h=e.controlPoints;u=new dc(h[0],h[1],h[2],h[3]).solve(Uc(i,1,s,a))}return u}static parse(e,i){let[s,a,u,...h]=e;if(!Array.isArray(a)||a.length===0)return i.error("Expected an interpolation type expression.",1);if(a[0]==="linear")a={name:"linear"};else if(a[0]==="exponential"){const g=a[1];if(typeof g!="number")return i.error("Exponential interpolation requires a numeric base.",1,1);a={name:"exponential",base:g}}else{if(a[0]!=="cubic-bezier")return i.error(`Unknown interpolation type ${String(a[0])}`,1,0);{const g=a.slice(1);if(g.length!==4||g.some(x=>typeof x!="number"||x<0||x>1))return i.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);a={name:"cubic-bezier",controlPoints:g}}}if(e.length-1<4)return i.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length-1>3&&(e.length-1)%2!=0)return i.error("Expected an even number of arguments.");if(u=i.parse(u,2,Lt),!u)return null;const p=[];let _=null;s==="interpolate-hcl"||s==="interpolate-lab"?_=Dn:i.expectedType&&i.expectedType.kind!=="value"&&(_=i.expectedType);for(let g=0;g<h.length;g+=2){const x=h[g],b=h[g+1],w=g+3,E=g+4;if(typeof x!="number")return i.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',w);if(p.length&&p[p.length-1][0]>=x)return i.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',w);const A=i.parse(b,E,_);if(!A)return null;_=_||A.type,p.push([x,A])}return _.kind==="number"||_.kind==="color"||_.kind==="array"&&_.itemType.kind==="number"&&typeof _.N=="number"?new $n(_,s,a,u,p):i.error(`Type ${jr(_)} is not interpolatable.`)}evaluate(e){const i=this.labels,s=this.outputs;if(i.length===1)return s[0].evaluate(e);const a=this.input.evaluate(e);if(a<=i[0])return s[0].evaluate(e);const u=i.length;if(a>=i[u-1])return s[u-1].evaluate(e);const h=Bc(i,a),p=$n.interpolationFactor(this.interpolation,a,i[h],i[h+1]),_=s[h].evaluate(e),g=s[h+1].evaluate(e);return this.operator==="interpolate"?gl[this.type.kind.toLowerCase()](_,g,p):this.operator==="interpolate-hcl"?Ho.reverse(Ho.interpolate(Ho.forward(_),Ho.forward(g),p)):$o.reverse($o.interpolate($o.forward(_),$o.forward(g),p))}eachChild(e){e(this.input);for(const i of this.outputs)e(i)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}serialize(){let e;e=this.interpolation.name==="linear"?["linear"]:this.interpolation.name==="exponential"?this.interpolation.base===1?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier",...this.interpolation.controlPoints];const i=[this.operator,e,this.input.serialize()];for(let s=0;s<this.labels.length;s++)i.push(this.labels[s],this.outputs[s].serialize());return i}}function Uc(r,e,i,s){const a=s-i,u=r-i;return a===0?0:e===1?u/a:(Math.pow(e,u)-1)/(Math.pow(e,a)-1)}class Ml{constructor(e,i){this.type=e,this.args=i}static parse(e,i){if(e.length<2)return i.error("Expectected at least one argument.");let s=null;const a=i.expectedType;a&&a.kind!=="value"&&(s=a);const u=[];for(const p of e.slice(1)){const _=i.parse(p,1+u.length,s,void 0,{typeAnnotation:"omit"});if(!_)return null;s=s||_.type,u.push(_)}const h=a&&u.some(p=>ma(a,p.type));return new Ml(h?Ri:s,u)}evaluate(e){let i,s=null,a=0;for(const u of this.args){if(a++,s=u.evaluate(e),s&&s instanceof In&&!s.available&&(i||(i=s),s=null,a===this.args.length))return i;if(s!==null)break}return s}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){const e=["coalesce"];return this.eachChild(i=>{e.push(i.serialize())}),e}}class jc{constructor(e,i){this.type=i.type,this.bindings=[].concat(e),this.result=i}evaluate(e){return this.result.evaluate(e)}eachChild(e){for(const i of this.bindings)e(i[1]);e(this.result)}static parse(e,i){if(e.length<4)return i.error(`Expected at least 3 arguments, but found ${e.length-1} instead.`);const s=[];for(let u=1;u<e.length-1;u+=2){const h=e[u];if(typeof h!="string")return i.error(`Expected string, but found ${typeof h} instead.`,u);if(/[^a-zA-Z0-9_]/.test(h))return i.error("Variable names must contain only alphanumeric characters or '_'.",u);const p=i.parse(e[u+1],u+1);if(!p)return null;s.push([h,p])}const a=i.parse(e[e.length-1],e.length-1,i.expectedType,s);return a?new jc(s,a):null}outputDefined(){return this.result.outputDefined()}serialize(){const e=["let"];for(const[i,s]of this.bindings)e.push(i,s.serialize());return e.push(this.result.serialize()),e}}class ch{constructor(e,i,s){this.type=e,this.index=i,this.input=s}static parse(e,i){if(e.length!==3)return i.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const s=i.parse(e[1],1,Lt),a=i.parse(e[2],2,yn(i.expectedType||Ri));return s&&a?new ch(a.type.itemType,s,a):null}evaluate(e){const i=this.index.evaluate(e),s=this.input.evaluate(e);if(i<0)throw new Nr(`Array index out of bounds: ${i} < 0.`);if(i>=s.length)throw new Nr(`Array index out of bounds: ${i} > ${s.length-1}.`);if(i!==Math.floor(i))throw new Nr(`Array index must be an integer, but found ${i} instead. Use at-interpolated to retrieve interpolated result with a fractional index.`);return s[i]}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}class uh{constructor(e,i,s){this.type=e,this.index=i,this.input=s}static parse(e,i){if(e.length!==3)return i.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const s=i.parse(e[1],1,Lt),a=i.parse(e[2],2,yn(i.expectedType||Ri));return s&&a?new uh(a.type.itemType,s,a):null}evaluate(e){const i=this.index.evaluate(e),s=this.input.evaluate(e);if(i<0)throw new Nr(`Array index out of bounds: ${i} < 0.`);if(i>s.length-1)throw new Nr(`Array index out of bounds: ${i} > ${s.length-1}.`);if(i===Math.floor(i))return s[i];const a=Math.floor(i),u=Math.ceil(i),h=s[a],p=s[u];if(typeof h!="number"||typeof p!="number")throw new Nr(`Cannot interpolate between non-number values at index ${i}.`);const _=i-a;return h*(1-_)+p*_}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at-interpolated",this.index.serialize(),this.input.serialize()]}}class Gc{constructor(e,i){this.type=Ci,this.needle=e,this.haystack=i}static parse(e,i){if(e.length!==3)return i.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const s=i.parse(e[1],1,Ri),a=i.parse(e[2],2,Ri);return s&&a?ro(s.type,[Ci,Ni,Lt,pa,Ri])?new Gc(s,a):i.error(`Expected first argument to be of type boolean, string, number or null, but found ${jr(s.type)} instead`):null}evaluate(e){const i=this.needle.evaluate(e),s=this.haystack.evaluate(e);if(s==null)return!1;if(!xl(i,["boolean","string","number","null"]))throw new Nr(`Expected first argument to be of type boolean, string, number or null, but found ${jr(xt(i))} instead.`);if(!xl(s,["string","array"]))throw new Nr(`Expected second argument to be of type array or string, but found ${jr(xt(s))} instead.`);return s.indexOf(i)>=0}eachChild(e){e(this.needle),e(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}class Pl{constructor(e,i,s){this.type=Lt,this.needle=e,this.haystack=i,this.fromIndex=s}static parse(e,i){if(e.length<=2||e.length>=5)return i.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const s=i.parse(e[1],1,Ri),a=i.parse(e[2],2,Ri);if(!s||!a)return null;if(!ro(s.type,[Ci,Ni,Lt,pa,Ri]))return i.error(`Expected first argument to be of type boolean, string, number or null, but found ${jr(s.type)} instead`);if(e.length===4){const u=i.parse(e[3],3,Lt);return u?new Pl(s,a,u):null}return new Pl(s,a)}evaluate(e){const i=this.needle.evaluate(e),s=this.haystack.evaluate(e);if(!xl(i,["boolean","string","number","null"]))throw new Nr(`Expected first argument to be of type boolean, string, number or null, but found ${jr(xt(i))} instead.`);if(!xl(s,["string","array"]))throw new Nr(`Expected second argument to be of type array or string, but found ${jr(xt(s))} instead.`);if(this.fromIndex){const a=this.fromIndex.evaluate(e);return s.indexOf(i,a)}return s.indexOf(i)}eachChild(e){e(this.needle),e(this.haystack),this.fromIndex&&e(this.fromIndex)}outputDefined(){return!1}serialize(){if(this.fromIndex!=null&&this.fromIndex!==void 0){const e=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),e]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}class Ca{constructor(e,i,s,a,u,h){this.inputType=e,this.type=i,this.input=s,this.cases=a,this.outputs=u,this.otherwise=h}static parse(e,i){if(e.length<5)return i.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length%2!=1)return i.error("Expected an even number of arguments.");let s,a;i.expectedType&&i.expectedType.kind!=="value"&&(a=i.expectedType);const u={},h=[];for(let g=2;g<e.length-1;g+=2){let x=e[g];const b=e[g+1];Array.isArray(x)||(x=[x]);const w=i.concat(g);if(x.length===0)return w.error("Expected at least one branch label.");for(const A of x){if(typeof A!="number"&&typeof A!="string")return w.error("Branch labels must be numbers or strings.");if(typeof A=="number"&&Math.abs(A)>Number.MAX_SAFE_INTEGER)return w.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof A=="number"&&Math.floor(A)!==A)return w.error("Numeric branch labels must be integer values.");if(s){if(w.checkSubtype(s,xt(A)))return null}else s=xt(A);if(u[String(A)]!==void 0)return w.error("Branch labels must be unique.");u[String(A)]=h.length}const E=i.parse(b,g,a);if(!E)return null;a=a||E.type,h.push(E)}const p=i.parse(e[1],1,Ri);if(!p)return null;const _=i.parse(e[e.length-1],e.length-1,a);return _?p.type.kind!=="value"&&i.concat(1).checkSubtype(s,p.type)?null:new Ca(s,a,p,u,h,_):null}evaluate(e){const i=this.input.evaluate(e);return(Sc(xt(i),this.inputType)&&this.outputs[this.cases[i]]||this.otherwise).evaluate(e)}eachChild(e){e(this.input),this.outputs.forEach(e),e(this.otherwise)}outputDefined(){return this.outputs.every(e=>e.outputDefined())&&this.otherwise.outputDefined()}serialize(){const e=["match",this.input.serialize()],i=Object.keys(this.cases).sort(),s=[],a={};for(const h of i){const p=a[this.cases[h]];p===void 0?(a[this.cases[h]]=s.length,s.push([this.cases[h],[h]])):s[p][1].push(h)}const u=h=>this.inputType.kind==="number"?Number(h):h;for(const[h,p]of s)e.push(p.length===1?u(p[0]):p.map(u)),e.push(this.outputs[h].serialize());return e.push(this.otherwise.serialize()),e}}class hh{constructor(e,i,s){this.type=e,this.branches=i,this.otherwise=s}static parse(e,i){if(e.length<4)return i.error(`Expected at least 3 arguments, but found only ${e.length-1}.`);if(e.length%2!=0)return i.error("Expected an odd number of arguments.");let s;i.expectedType&&i.expectedType.kind!=="value"&&(s=i.expectedType);const a=[];for(let h=1;h<e.length-1;h+=2){const p=i.parse(e[h],h,Ci);if(!p)return null;const _=i.parse(e[h+1],h+1,s);if(!_)return null;a.push([p,_]),s=s||_.type}const u=i.parse(e[e.length-1],e.length-1,s);return u?new hh(s,a,u):null}evaluate(e){for(const[i,s]of this.branches)if(i.evaluate(e))return s.evaluate(e);return this.otherwise.evaluate(e)}eachChild(e){for(const[i,s]of this.branches)e(i),e(s);e(this.otherwise)}outputDefined(){return this.branches.every(([e,i])=>i.outputDefined())&&this.otherwise.outputDefined()}serialize(){const e=["case"];return this.eachChild(i=>{e.push(i.serialize())}),e}}class Rl{constructor(e,i,s,a){this.type=e,this.input=i,this.beginIndex=s,this.endIndex=a}static parse(e,i){if(e.length<=2||e.length>=5)return i.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const s=i.parse(e[1],1,Ri),a=i.parse(e[2],2,Lt);if(!s||!a)return null;if(!ro(s.type,[yn(Ri),Ni,Ri]))return i.error(`Expected first argument to be of type array or string, but found ${jr(s.type)} instead`);if(e.length===4){const u=i.parse(e[3],3,Lt);return u?new Rl(s.type,s,a,u):null}return new Rl(s.type,s,a)}evaluate(e){const i=this.input.evaluate(e),s=this.beginIndex.evaluate(e);if(!xl(i,["string","array"]))throw new Nr(`Expected first argument to be of type array or string, but found ${jr(xt(i))} instead.`);if(this.endIndex){const a=this.endIndex.evaluate(e);return i.slice(s,a)}return i.slice(s)}eachChild(e){e(this.input),e(this.beginIndex),this.endIndex&&e(this.endIndex)}outputDefined(){return!1}serialize(){if(this.endIndex!=null&&this.endIndex!==void 0){const e=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),e]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}function Zd(r,e){return r==="=="||r==="!="?e.kind==="boolean"||e.kind==="string"||e.kind==="number"||e.kind==="null"||e.kind==="value":e.kind==="string"||e.kind==="number"||e.kind==="value"}function Wd(r,e,i,s){return s.compare(e,i)===0}function Zo(r,e,i){const s=r!=="=="&&r!=="!=";return class o1{constructor(u,h,p){this.type=Ci,this.lhs=u,this.rhs=h,this.collator=p,this.hasUntypedArgument=u.type.kind==="value"||h.type.kind==="value"}static parse(u,h){if(u.length!==3&&u.length!==4)return h.error("Expected two or three arguments.");const p=u[0];let _=h.parse(u[1],1,Ri);if(!_)return null;if(!Zd(p,_.type))return h.concat(1).error(`"${p}" comparisons are not supported for type '${jr(_.type)}'.`);let g=h.parse(u[2],2,Ri);if(!g)return null;if(!Zd(p,g.type))return h.concat(2).error(`"${p}" comparisons are not supported for type '${jr(g.type)}'.`);if(_.type.kind!==g.type.kind&&_.type.kind!=="value"&&g.type.kind!=="value")return h.error(`Cannot compare types '${jr(_.type)}' and '${jr(g.type)}'.`);s&&(_.type.kind==="value"&&g.type.kind!=="value"?_=new Nt(g.type,[_]):_.type.kind!=="value"&&g.type.kind==="value"&&(g=new Nt(_.type,[g])));let x=null;if(u.length===4){if(_.type.kind!=="string"&&g.type.kind!=="string"&&_.type.kind!=="value"&&g.type.kind!=="value")return h.error("Cannot use collator to compare non-string types.");if(x=h.parse(u[3],3,Tc),!x)return null}return new o1(_,g,x)}evaluate(u){const h=this.lhs.evaluate(u),p=this.rhs.evaluate(u);if(s&&this.hasUntypedArgument){const _=xt(h),g=xt(p);if(_.kind!==g.kind||_.kind!=="string"&&_.kind!=="number")throw new Nr(`Expected arguments for "${r}" to be (string, string) or (number, number), but found (${_.kind}, ${g.kind}) instead.`)}if(this.collator&&!s&&this.hasUntypedArgument){const _=xt(h),g=xt(p);if(_.kind!=="string"||g.kind!=="string")return e(u,h,p)}return this.collator?i(u,h,p,this.collator.evaluate(u)):e(u,h,p)}eachChild(u){u(this.lhs),u(this.rhs),this.collator&&u(this.collator)}outputDefined(){return!0}serialize(){const u=[r];return this.eachChild(h=>{u.push(h.serialize())}),u}}}const Xd=Zo("==",function(r,e,i){return e===i},Wd),Jp=Zo("!=",function(r,e,i){return e!==i},function(r,e,i,s){return!Wd(0,e,i,s)}),Qp=Zo("<",function(r,e,i){return e<i},function(r,e,i,s){return s.compare(e,i)<0}),em=Zo(">",function(r,e,i){return e>i},function(r,e,i,s){return s.compare(e,i)>0}),qc=Zo("<=",function(r,e,i){return e<=i},function(r,e,i,s){return s.compare(e,i)<=0}),tm=Zo(">=",function(r,e,i){return e>=i},function(r,e,i,s){return s.compare(e,i)>=0});class $c{constructor(e,i,s,a,u,h){this.type=Ni,this.number=e,this.locale=i,this.currency=s,this.unit=a,this.minFractionDigits=u,this.maxFractionDigits=h}static parse(e,i){if(e.length!==3)return i.error("Expected two arguments.");const s=i.parse(e[1],1,Lt);if(!s)return null;const a=e[2];if(typeof a!="object"||Array.isArray(a))return i.error("NumberFormat options argument must be an object.");let u=null;if(a.locale&&(u=i.parseObjectValue(a.locale,2,"locale",Ni),!u))return null;let h=null;if(a.currency&&(h=i.parseObjectValue(a.currency,2,"currency",Ni),!h))return null;let p=null;if(a.unit&&(p=i.parseObjectValue(a.unit,2,"unit",Ni),!p))return null;let _=null;if(a["min-fraction-digits"]&&(_=i.parseObjectValue(a["min-fraction-digits"],2,"min-fraction-digits",Lt),!_))return null;let g=null;return a["max-fraction-digits"]&&(g=i.parseObjectValue(a["max-fraction-digits"],2,"max-fraction-digits",Lt),!g)?null:new $c(s,u,h,p,_,g)}evaluate(e){return new Intl.NumberFormat(this.locale?this.locale.evaluate(e):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(e):void 0,unit:this.unit?this.unit.evaluate(e):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(e):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(e):void 0}).format(this.number.evaluate(e))}eachChild(e){e(this.number),this.locale&&e(this.locale),this.currency&&e(this.currency),this.unit&&e(this.unit),this.minFractionDigits&&e(this.minFractionDigits),this.maxFractionDigits&&e(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const e={};return this.locale&&(e.locale=this.locale.serialize()),this.currency&&(e.currency=this.currency.serialize()),this.unit&&(e.unit=this.unit.serialize()),this.minFractionDigits&&(e["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(e["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),e]}}class dh{constructor(e){this.type=Lt,this.input=e}static parse(e,i){if(e.length!==2)return i.error(`Expected 1 argument, but found ${e.length-1} instead.`);const s=i.parse(e[1],1);return s?s.type.kind!=="array"&&s.type.kind!=="string"&&s.type.kind!=="value"?i.error(`Expected argument of type string or array, but found ${jr(s.type)} instead.`):new dh(s):null}evaluate(e){const i=this.input.evaluate(e);if(typeof i=="string"||Array.isArray(i))return i.length;throw new Nr(`Expected value to be of type string or array, but found ${jr(xt(i))} instead.`)}eachChild(e){e(this.input)}outputDefined(){return!1}serialize(){const e=["length"];return this.eachChild(i=>{e.push(i.serialize())}),e}}function Yd(r){return function(){r=1831565813+(r|=0)|0;let e=Math.imul(r^r>>>15,1|r);return e=e+Math.imul(e^e>>>7,61|e)^e,((e^e>>>14)>>>0)/4294967296}}const Wo={"==":Xd,"!=":Jp,">":em,"<":Qp,">=":tm,"<=":qc,array:Nt,at:ch,"at-interpolated":uh,boolean:Nt,case:hh,coalesce:Ml,collator:_s,format:_a,image:ga,in:Gc,"index-of":Pl,interpolate:$n,"interpolate-hcl":$n,"interpolate-lab":$n,length:dh,let:jc,literal:Zt,match:Ca,number:Nt,"number-format":$c,object:Nt,slice:Rl,step:Cl,string:Nt,"to-boolean":Kn,"to-color":Kn,"to-number":Kn,"to-string":Kn,var:kc,within:un,distance:qo,config:Aa};function fh(r,[e,i,s,a]){e=e.evaluate(r),i=i.evaluate(r),s=s.evaluate(r);const u=a?a.evaluate(r):1,h=Uo(e,i,s,u);if(h)throw new Nr(h);return new Pi(e/255,i/255,s/255,u)}function ph(r,[e,i,s,a]){e=e.evaluate(r),i=i.evaluate(r),s=s.evaluate(r);const u=a?a.evaluate(r):1,h=function(g,x,b,w){return typeof g=="number"&&g>=0&&g<=360?typeof x=="number"&&x>=0&&x<=100&&typeof b=="number"&&b>=0&&b<=100?w===void 0||typeof w=="number"&&w>=0&&w<=1?null:`Invalid hsla value [${[g,x,b,w].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid hsla value [${(typeof w=="number"?[g,x,b,w]:[g,x,b]).join(", ")}]: 's', and 'l' must be between 0 and 100.`:`Invalid hsla value [${(typeof w=="number"?[g,x,b,w]:[g,x,b]).join(", ")}]: 'h' must be between 0 and 360.`}(e,i,s,u);if(h)throw new Nr(h);const p=`hsla(${e}, ${i}%, ${s}%, ${u})`,_=Pi.parse(p);if(!_)throw new Nr(`Failed to parse HSLA color: ${p}`);return _}function Kd(r,e){return r in e}function lo(r,e){const i=e[r];return i===void 0?null:i}function Xo(r){return{type:r}}function Jd(r){return{result:"success",value:r}}function co(r){return{result:"error",value:r}}function Hc(r,e){return!!r&&!!r.parameters&&r.parameters.indexOf(e)>-1}function zl(r){return r["property-type"]==="data-driven"}function mh(r){return Hc(r.expression,"measure-light")}function _h(r){return Hc(r.expression,"zoom")}function Ll(r){return!!r.expression&&r.expression.interpolated}function Dl(r){return typeof r=="object"&&r!==null&&!Array.isArray(r)}function Qd(r){return r}function ef(r,e){const i=e.type==="color",s=r.stops&&typeof r.stops[0][0]=="object",a=s||!(s||r.property!==void 0),u=r.type||(Ll(e)?"exponential":"interval");if(i&&((r=Vo({},r)).stops&&(r.stops=r.stops.map(g=>[g[0],Pi.parse(g[1])])),r.default=Pi.parse(r.default?r.default:e.default)),r.colorSpace&&r.colorSpace!=="rgb"&&!Hd[r.colorSpace])throw new Error(`Unknown color space: ${r.colorSpace}`);let h,p,_;if(u==="exponential")h=gh;else if(u==="interval")h=rm;else if(u==="categorical"){h=im,p=Object.create(null);for(const g of r.stops)p[g[0]]=g[1];_=typeof r.stops[0][0]}else{if(u!=="identity")throw new Error(`Unknown function type "${u}"`);h=nm}if(s){const g={},x=[];for(let E=0;E<r.stops.length;E++){const A=r.stops[E],P=A[0].zoom;g[P]===void 0&&(g[P]={zoom:P,type:r.type,property:r.property,default:r.default,stops:[]},x.push(P)),g[P].stops.push([A[0].value,A[1]])}const b=[];for(const E of x)b.push([g[E].zoom,ef(g[E],e)]);const w={name:"linear"};return{kind:"composite",interpolationType:w,interpolationFactor:$n.interpolationFactor.bind(void 0,w),zoomStops:b.map(E=>E[0]),evaluate:({zoom:E},A)=>gh({stops:b,base:r.base},e,E).evaluate(E,A)}}if(a){const g=u==="exponential"?{name:"exponential",base:r.base!==void 0?r.base:1}:null;return{kind:"camera",interpolationType:g,interpolationFactor:$n.interpolationFactor.bind(void 0,g),zoomStops:r.stops.map(x=>x[0]),evaluate:({zoom:x})=>h(r,e,x,p,_)}}return{kind:"source",evaluate(g,x){const b=x&&x.properties?x.properties[r.property]:void 0;return b===void 0?Qn(r.default,e.default):h(r,e,b,p,_)}}}function Qn(r,e,i){return r!==void 0?r:e!==void 0?e:i!==void 0?i:void 0}function im(r,e,i,s,a){return Qn(typeof i===a?s[i]:void 0,r.default,e.default)}function rm(r,e,i){if(no(i)!=="number")return Qn(r.default,e.default);const s=r.stops.length;if(s===1||i<=r.stops[0][0])return r.stops[0][1];if(i>=r.stops[s-1][0])return r.stops[s-1][1];const a=Bc(r.stops.map(u=>u[0]),i);return r.stops[a][1]}function gh(r,e,i){const s=r.base!==void 0?r.base:1;if(no(i)!=="number")return Qn(r.default,e.default);const a=r.stops.length;if(a===1||i<=r.stops[0][0])return r.stops[0][1];if(i>=r.stops[a-1][0])return r.stops[a-1][1];const u=Bc(r.stops.map(x=>x[0]),i),h=function(x,b,w,E){const A=E-w,P=x-w;return A===0?0:b===1?P/A:(Math.pow(b,P)-1)/(Math.pow(b,A)-1)}(i,s,r.stops[u][0],r.stops[u+1][0]),p=r.stops[u][1],_=r.stops[u+1][1];let g=gl[e.type]||Qd;if(r.colorSpace&&r.colorSpace!=="rgb"){const x=Hd[r.colorSpace];g=(b,w)=>x.reverse(x.interpolate(x.forward(b),x.forward(w),h))}return typeof p.evaluate=="function"?{evaluate(...x){const b=p.evaluate.apply(void 0,x),w=_.evaluate.apply(void 0,x);if(b!==void 0&&w!==void 0)return g(b,w,h)}}:g(p,_,h)}function nm(r,e,i){return e.type==="color"?i=Pi.parse(i):e.type==="formatted"?i=vn.fromString(i.toString()):e.type==="resolvedImage"?i=In.build(i.toString()):no(i)===e.type||e.type==="enum"&&e.values[i]||(i=void 0),Qn(i,r.default,e.default)}Yr.register(Wo,{error:[{kind:"error"},[Ni],(r,[e])=>{throw new Nr(e.evaluate(r))}],typeof:[Ni,[Ri],(r,[e])=>jr(xt(e.evaluate(r)))],"to-rgba":[yn(Lt,4),[Dn],(r,[e])=>e.evaluate(r).toNonPremultipliedRenderColor(null).toArray()],"to-hsla":[yn(Lt,4),[Dn],(r,[e])=>e.evaluate(r).toNonPremultipliedRenderColor(null).toHslaArray()],rgb:[Dn,[Lt,Lt,Lt],fh],rgba:[Dn,[Lt,Lt,Lt,Lt],fh],hsl:[Dn,[Lt,Lt,Lt],ph],hsla:[Dn,[Lt,Lt,Lt,Lt],ph],has:{type:Ci,overloads:[[[Ni],(r,[e])=>Kd(e.evaluate(r),r.properties())],[[Ni,Rs],(r,[e,i])=>Kd(e.evaluate(r),i.evaluate(r))]]},get:{type:Ri,overloads:[[[Ni],(r,[e])=>lo(e.evaluate(r),r.properties())],[[Ni,Rs],(r,[e,i])=>lo(e.evaluate(r),i.evaluate(r))]]},"feature-state":[Ri,[Ni],(r,[e])=>lo(e.evaluate(r),r.featureState||{})],properties:[Rs,[],r=>r.properties()],"geometry-type":[Ni,[],r=>r.geometryType()],worldview:[Ni,[],r=>r.globals.worldview||""],id:[Ri,[],r=>r.id()],zoom:[Lt,[],r=>r.globals.zoom],pitch:[Lt,[],r=>r.globals.pitch||0],"distance-from-center":[Lt,[],r=>r.distanceFromCenter()],"measure-light":[Lt,[Ni],(r,[e])=>r.measureLight(e.evaluate(r))],"heatmap-density":[Lt,[],r=>r.globals.heatmapDensity||0],"line-progress":[Lt,[],r=>r.globals.lineProgress||0],"raster-value":[Lt,[],r=>r.globals.rasterValue||0],"raster-particle-speed":[Lt,[],r=>r.globals.rasterParticleSpeed||0],"sky-radial-progress":[Lt,[],r=>r.globals.skyRadialProgress||0],accumulated:[Ri,[],r=>r.globals.accumulated===void 0?null:r.globals.accumulated],"+":[Lt,Xo(Lt),(r,e)=>{let i=0;for(const s of e)i+=s.evaluate(r);return i}],"*":[Lt,Xo(Lt),(r,e)=>{let i=1;for(const s of e)i*=s.evaluate(r);return i}],"-":{type:Lt,overloads:[[[Lt,Lt],(r,[e,i])=>e.evaluate(r)-i.evaluate(r)],[[Lt],(r,[e])=>-e.evaluate(r)]]},"/":[Lt,[Lt,Lt],(r,[e,i])=>e.evaluate(r)/i.evaluate(r)],"%":[Lt,[Lt,Lt],(r,[e,i])=>e.evaluate(r)%i.evaluate(r)],ln2:[Lt,[],()=>Math.LN2],pi:[Lt,[],()=>Math.PI],e:[Lt,[],()=>Math.E],"^":[Lt,[Lt,Lt],(r,[e,i])=>Math.pow(e.evaluate(r),i.evaluate(r))],sqrt:[Lt,[Lt],(r,[e])=>Math.sqrt(e.evaluate(r))],log10:[Lt,[Lt],(r,[e])=>Math.log(e.evaluate(r))/Math.LN10],ln:[Lt,[Lt],(r,[e])=>Math.log(e.evaluate(r))],log2:[Lt,[Lt],(r,[e])=>Math.log(e.evaluate(r))/Math.LN2],sin:[Lt,[Lt],(r,[e])=>Math.sin(e.evaluate(r))],cos:[Lt,[Lt],(r,[e])=>Math.cos(e.evaluate(r))],tan:[Lt,[Lt],(r,[e])=>Math.tan(e.evaluate(r))],asin:[Lt,[Lt],(r,[e])=>Math.asin(e.evaluate(r))],acos:[Lt,[Lt],(r,[e])=>Math.acos(e.evaluate(r))],atan:[Lt,[Lt],(r,[e])=>Math.atan(e.evaluate(r))],min:[Lt,Xo(Lt),(r,e)=>Math.min(...e.map(i=>i.evaluate(r)))],max:[Lt,Xo(Lt),(r,e)=>Math.max(...e.map(i=>i.evaluate(r)))],abs:[Lt,[Lt],(r,[e])=>Math.abs(e.evaluate(r))],round:[Lt,[Lt],(r,[e])=>{const i=e.evaluate(r);return i<0?-Math.round(-i):Math.round(i)}],floor:[Lt,[Lt],(r,[e])=>Math.floor(e.evaluate(r))],ceil:[Lt,[Lt],(r,[e])=>Math.ceil(e.evaluate(r))],"filter-==":[Ci,[Ni,Ri],(r,[e,i])=>r.properties()[e.value]===i.value],"filter-id-==":[Ci,[Ri],(r,[e])=>r.id()===e.value],"filter-type-==":[Ci,[Ni],(r,[e])=>r.geometryType()===e.value],"filter-<":[Ci,[Ni,Ri],(r,[e,i])=>{const s=r.properties()[e.value],a=i.value;return typeof s==typeof a&&s<a}],"filter-id-<":[Ci,[Ri],(r,[e])=>{const i=r.id(),s=e.value;return typeof i==typeof s&&i<s}],"filter->":[Ci,[Ni,Ri],(r,[e,i])=>{const s=r.properties()[e.value],a=i.value;return typeof s==typeof a&&s>a}],"filter-id->":[Ci,[Ri],(r,[e])=>{const i=r.id(),s=e.value;return typeof i==typeof s&&i>s}],"filter-<=":[Ci,[Ni,Ri],(r,[e,i])=>{const s=r.properties()[e.value],a=i.value;return typeof s==typeof a&&s<=a}],"filter-id-<=":[Ci,[Ri],(r,[e])=>{const i=r.id(),s=e.value;return typeof i==typeof s&&i<=s}],"filter->=":[Ci,[Ni,Ri],(r,[e,i])=>{const s=r.properties()[e.value],a=i.value;return typeof s==typeof a&&s>=a}],"filter-id->=":[Ci,[Ri],(r,[e])=>{const i=r.id(),s=e.value;return typeof i==typeof s&&i>=s}],"filter-has":[Ci,[Ri],(r,[e])=>e.value in r.properties()],"filter-has-id":[Ci,[],r=>r.id()!==null&&r.id()!==void 0],"filter-type-in":[Ci,[yn(Ni)],(r,[e])=>e.value.indexOf(r.geometryType())>=0],"filter-id-in":[Ci,[yn(Ri)],(r,[e])=>e.value.indexOf(r.id())>=0],"filter-in-small":[Ci,[Ni,yn(Ri)],(r,[e,i])=>i.value.indexOf(r.properties()[e.value])>=0],"filter-in-large":[Ci,[Ni,yn(Ri)],(r,[e,i])=>function(s,a,u,h){for(;u<=h;){const p=u+h>>1;if(a[p]===s)return!0;a[p]>s?h=p-1:u=p+1}return!1}(r.properties()[e.value],i.value,0,i.value.length-1)],all:{type:Ci,overloads:[[[Ci,Ci],(r,[e,i])=>e.evaluate(r)&&i.evaluate(r)],[Xo(Ci),(r,e)=>{for(const i of e)if(!i.evaluate(r))return!1;return!0}]]},any:{type:Ci,overloads:[[[Ci,Ci],(r,[e,i])=>e.evaluate(r)||i.evaluate(r)],[Xo(Ci),(r,e)=>{for(const i of e)if(i.evaluate(r))return!0;return!1}]]},"!":[Ci,[Ci],(r,[e])=>!e.evaluate(r)],"is-supported-script":[Ci,[Ni],(r,[e])=>{const i=r.globals&&r.globals.isSupportedScript;return!i||i(e.evaluate(r))}],upcase:[Ni,[Ni],(r,[e])=>e.evaluate(r).toUpperCase()],downcase:[Ni,[Ni],(r,[e])=>e.evaluate(r).toLowerCase()],concat:[Ni,Xo(Ri),(r,e)=>e.map(i=>Yn(i.evaluate(r))).join("")],"resolved-locale":[Ni,[Tc],(r,[e])=>e.evaluate(r).resolvedLocale()],random:[Lt,[Lt,Lt,Ri],(r,e)=>{const[i,s,a]=e.map(h=>h.evaluate(r));if(i>s||i===s)return i;let u;if(typeof a=="string")u=function(h){let p=0;if(h.length===0)return p;for(let _=0;_<h.length;_++)p=(p<<5)-p+h.charCodeAt(_),p|=0;return p}(a);else{if(typeof a!="number")throw new Nr(`Invalid seed input: ${a}`);u=a}return i+Yd(u)()*(s-i)}]});class Ma{constructor(e,i,s,a){this.expression=e,this._warningHistory={},this._evaluator=new Tl(s,a),this._defaultValue=i?function(u){return u.type==="color"&&(Dl(u.default)||Array.isArray(u.default))?new Pi(0,0,0,0):u.type==="color"?Pi.parse(u.default)||null:u.default===void 0?null:u.default}(i):null,this._enumValues=i&&i.type==="enum"?i.values:null,this.configDependencies=Oc(e)}evaluateWithoutErrorHandling(e,i,s,a,u,h,p,_){return this._evaluator.globals=e,this._evaluator.feature=i,this._evaluator.featureState=s,this._evaluator.canonical=a||null,this._evaluator.availableImages=u||null,this._evaluator.formattedSection=h,this._evaluator.featureTileCoord=p||null,this._evaluator.featureDistanceData=_||null,this.expression.evaluate(this._evaluator)}evaluate(e,i,s,a,u,h,p,_){this._evaluator.globals=e,this._evaluator.feature=i||null,this._evaluator.featureState=s||null,this._evaluator.canonical=a||null,this._evaluator.availableImages=u||null,this._evaluator.formattedSection=h||null,this._evaluator.featureTileCoord=p||null,this._evaluator.featureDistanceData=_||null;try{const g=this.expression.evaluate(this._evaluator);if(g==null||typeof g=="number"&&g!=g)return this._defaultValue;if(this._enumValues&&!(g in this._enumValues))throw new Nr(`Expected value to be one of ${Object.keys(this._enumValues).map(x=>JSON.stringify(x)).join(", ")}, but found ${JSON.stringify(g)} instead.`);return g}catch(g){return this._warningHistory[g.message]||(this._warningHistory[g.message]=!0,typeof console<"u"&&console.warn(`Failed to evaluate expression "${JSON.stringify(this.expression.serialize())}". ${g.message}`)),this._defaultValue}}}function Zc(r){return Array.isArray(r)&&r.length>0&&typeof r[0]=="string"&&r[0]in Wo}function Ds(r,e,i,s){const a=new Fc(Wo,[],e?function(h){const p={color:Dn,string:Ni,number:Lt,enum:Ni,boolean:Ci,formatted:yl,resolvedImage:vl};return h.type==="array"?yn(p[h.value]||Ri,h.length):p[h.type]}(e):void 0,void 0,void 0,i,s),u=a.parse(r,void 0,void 0,void 0,e&&e.type==="string"?{typeAnnotation:"coerce"}:void 0);return u?Jd(new Ma(u,e,i,s)):co(a.errors)}class Ol{constructor(e,i,s,a){this.kind=e,this._styleExpression=i,this.isLightConstant=s,this.isLineProgressConstant=a,this.isStateDependent=e!=="constant"&&!Dc(i.expression),this.configDependencies=Oc(i.expression)}evaluateWithoutErrorHandling(e,i,s,a,u,h){return this._styleExpression.evaluateWithoutErrorHandling(e,i,s,a,u,h)}evaluate(e,i,s,a,u,h){return this._styleExpression.evaluate(e,i,s,a,u,h)}}class kl{constructor(e,i,s,a,u,h){this.kind=e,this.zoomStops=s,this._styleExpression=i,this.isStateDependent=e!=="camera"&&!Dc(i.expression),this.isLightConstant=u,this.isLineProgressConstant=h,this.configDependencies=Oc(i.expression),this.interpolationType=a}evaluateWithoutErrorHandling(e,i,s,a,u,h){return this._styleExpression.evaluateWithoutErrorHandling(e,i,s,a,u,h)}evaluate(e,i,s,a,u,h){return this._styleExpression.evaluate(e,i,s,a,u,h)}interpolationFactor(e,i,s){return this.interpolationType?$n.interpolationFactor(this.interpolationType,e,i,s):0}}function tf(r,e,i,s){if((r=Ds(r,e,i,s)).result==="error")return r;const a=r.value.expression,u=Ea(a);if(!u&&!zl(e))return co([new Gn("","data expressions not supported")]);const h=Ia(a,["zoom","pitch","distance-from-center"]);if(!h&&!_h(e))return co([new Gn("","zoom expressions not supported")]);const p=Ia(a,["measure-light"]);if(!p&&!mh(e))return co([new Gn("","measure-light expression not supported")]);const _=Ia(a,["line-progress"]);if(!_&&!function(b){return Hc(b.expression,"line-progress")}(e))return co([new Gn("","line-progress expression not supported")]);const g=e.expression&&e.expression.relaxZoomRestriction,x=Ra(a);return x||h||g?x instanceof Gn?co([x]):x instanceof $n&&!Ll(e)?co([new Gn("",'"interpolate" expressions cannot be used with this property')]):Jd(x?new kl(u&&_?"camera":"composite",r.value,x.labels,x instanceof $n?x.interpolation:void 0,p,_):new Ol(u&&_?"constant":"source",r.value,p,_)):co([new Gn("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression, or in the properties of atmosphere.')])}class Pa{constructor(e,i){this._parameters=e,this._specification=i,Vo(this,ef(this._parameters,this._specification))}static deserialize(e){return new Pa(e._parameters,e._specification)}static serialize(e){return{_parameters:e._parameters,_specification:e._specification}}}function Ra(r){let e=null;if(r instanceof jc)e=Ra(r.result);else if(r instanceof Ml){for(const i of r.args)if(e=Ra(i),e)break}else(r instanceof Cl||r instanceof $n)&&r.input instanceof Yr&&r.input.name==="zoom"&&(e=r);return e instanceof Gn||r.eachChild(i=>{const s=Ra(i);s instanceof Gn?e=s:e&&s&&e!==s&&(e=new Gn("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),e}var Wc,yh,vh=function(){if(yh)return Wc;yh=1,Wc=e;var r=3;function e(i,s,a){var u=this.cells=[];if(i instanceof ArrayBuffer){this.arrayBuffer=i;var h=new Int32Array(this.arrayBuffer);i=h[0],this.d=(s=h[1])+2*(a=h[2]);for(var p=0;p<this.d*this.d;p++){var _=h[r+p],g=h[r+p+1];u.push(_===g?null:h.subarray(_,g))}var x=h[r+u.length+1];this.keys=h.subarray(h[r+u.length],x),this.bboxes=h.subarray(x),this.insert=this._insertReadonly}else{this.d=s+2*a;for(var b=0;b<this.d*this.d;b++)u.push([]);this.keys=[],this.bboxes=[]}this.n=s,this.extent=i,this.padding=a,this.scale=s/i,this.uid=0;var w=a/s*i;this.min=-w,this.max=i+w}return e.prototype.insert=function(i,s,a,u,h){this._forEachCell(s,a,u,h,this._insertCell,this.uid++),this.keys.push(i),this.bboxes.push(s),this.bboxes.push(a),this.bboxes.push(u),this.bboxes.push(h)},e.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},e.prototype._insertCell=function(i,s,a,u,h,p){this.cells[h].push(p)},e.prototype.query=function(i,s,a,u,h){var p=this.min,_=this.max;if(i<=p&&s<=p&&_<=a&&_<=u&&!h)return Array.prototype.slice.call(this.keys);var g=[];return this._forEachCell(i,s,a,u,this._queryCell,g,{},h),g},e.prototype._queryCell=function(i,s,a,u,h,p,_,g){var x=this.cells[h];if(x!==null)for(var b=this.keys,w=this.bboxes,E=0;E<x.length;E++){var A=x[E];if(_[A]===void 0){var P=4*A;(g?g(w[P+0],w[P+1],w[P+2],w[P+3]):i<=w[P+2]&&s<=w[P+3]&&a>=w[P+0]&&u>=w[P+1])?(_[A]=!0,p.push(b[A])):_[A]=!1}}},e.prototype._forEachCell=function(i,s,a,u,h,p,_,g){for(var x=this._convertToCellCoord(i),b=this._convertToCellCoord(s),w=this._convertToCellCoord(a),E=this._convertToCellCoord(u),A=x;A<=w;A++)for(var P=b;P<=E;P++){var L=this.d*P+A;if((!g||g(this._convertFromCellCoord(A),this._convertFromCellCoord(P),this._convertFromCellCoord(A+1),this._convertFromCellCoord(P+1)))&&h.call(this,i,s,a,u,L,p,_,g))return}},e.prototype._convertFromCellCoord=function(i){return(i-this.padding)/this.scale},e.prototype._convertToCellCoord=function(i){return Math.max(0,Math.min(this.d-1,Math.floor(i*this.scale)+this.padding))},e.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var i=this.cells,s=r+this.cells.length+1+1,a=0,u=0;u<this.cells.length;u++)a+=this.cells[u].length;var h=new Int32Array(s+a+this.keys.length+this.bboxes.length);h[0]=this.extent,h[1]=this.n,h[2]=this.padding;for(var p=s,_=0;_<i.length;_++){var g=i[_];h[r+_]=p,h.set(g,p),p+=g.length}return h[r+i.length]=p,h.set(this.keys,p),h[r+i.length+1]=p+=this.keys.length,h.set(this.bboxes,p),p+=this.bboxes.length,h.buffer},Wc}(),Os=eo(vh);const ks={};function bt(r,e,i={}){Object.defineProperty(r,"_classRegistryKey",{value:e,writable:!1}),ks[e]={klass:r,omit:i.omit||[]}}bt(Object,"Object"),Os.serialize=function(r,e){const i=r.toArrayBuffer();return e&&e.add(i),{buffer:i}},Os.deserialize=function(r){return new Os(r.buffer)},Object.defineProperty(Os,"name",{value:"Grid"}),bt(Os,"Grid"),typeof DOMMatrix<"u"&&bt(DOMMatrix,"DOMMatrix"),bt(Pi,"Color"),bt(Error,"Error"),bt(vn,"Formatted"),bt(Ec,"FormattedSection"),bt(vi,"AJAXError"),bt(In,"ResolvedImage"),bt(Pa,"StylePropertyFunction"),bt(Ma,"StyleExpression",{omit:["_evaluator"]}),bt(Ln,"ImageId"),bt(zs,"ImageVariant"),bt(kl,"ZoomDependentExpression"),bt(Ol,"ZoomConstantExpression"),bt(Yr,"CompoundExpression",{omit:["_evaluate"]});for(const r in Wo)ks[Wo[r]._classRegistryKey]||bt(Wo[r],`Expression${r}`);function rf(r){return r&&typeof ArrayBuffer<"u"&&(r instanceof ArrayBuffer||r.constructor&&r.constructor.name==="ArrayBuffer")}function nf(r){return self.ImageBitmap&&r instanceof ImageBitmap}function uo(r,e){if(r==null||typeof r=="boolean"||typeof r=="number"||typeof r=="string"||r instanceof Boolean||r instanceof Number||r instanceof String||r instanceof Date||r instanceof RegExp)return r;if(rf(r)||nf(r))return e&&e.add(r),r;if(ArrayBuffer.isView(r))return e&&e.add(r.buffer),r;if(r instanceof ImageData)return e&&e.add(r.data.buffer),r;if(Array.isArray(r)){const i=[];for(const s of r)i.push(uo(s,e));return i}if(r instanceof Map){const i={$name:"Map",entries:[]};for(const[s,a]of r.entries())i.entries.push(uo(s),uo(a,e));return i}if(r instanceof Set){const i={$name:"Set"};let s=0;for(const a of r.values())i[++s]=uo(a);return i}if(r instanceof DOMMatrix){const i={$name:"DOMMatrix"},s=["is2D","m11","m12","m13","m14","m21","m22","m23","m24","m31","m32","m33","m34","m41","m42","m43","m44","a","b","c","d","e","f"];for(const a of s)i[a]=r[a];return i}if(typeof r=="bigint")return{$name:"BigInt",value:r.toString()};if(typeof r=="object"){const i=r.constructor,s=i._classRegistryKey;if(!s)throw new Error(`Can't serialize object of unregistered class "${i.name}".`);const a=i.serialize?i.serialize(r,e):{};if(!i.serialize){for(const u in r)r.hasOwnProperty(u)&&(ks[s].omit.indexOf(u)>=0||(a[u]=uo(r[u],e)));r instanceof Error&&(a.message=r.message)}if(a.$name)throw new Error("$name property is reserved for worker serialization logic.");return s!=="Object"&&(a.$name=s),a}throw new Error("can't serialize object of type "+typeof r)}function ho(r){if(r==null||typeof r=="boolean"||typeof r=="number"||typeof r=="string"||r instanceof Boolean||r instanceof Number||r instanceof String||r instanceof Date||r instanceof RegExp||rf(r)||nf(r)||ArrayBuffer.isView(r)||r instanceof ImageData)return r;if(Array.isArray(r))return r.map(ho);if(typeof r=="object"){const e=r.$name||"Object";if(e==="Map"){const a=r.entries||[],u=new Map;for(let h=0;h<a.length;h+=2)u.set(ho(a[h]),ho(a[h+1]));return u}if(e==="Set"){const a=new Set;for(const u of Object.keys(r))u!=="$name"&&a.add(ho(r[u]));return a}if(e==="DOMMatrix"){let a;return a=r.is2D?[r.a,r.b,r.c,r.d,r.e,r.f]:[r.m11,r.m12,r.m13,r.m14,r.m21,r.m22,r.m23,r.m24,r.m31,r.m32,r.m33,r.m34,r.m41,r.m42,r.m43,r.m44],new DOMMatrix(a)}if(e==="BigInt")return BigInt(r.value);const{klass:i}=ks[e];if(!i)throw new Error(`Can't deserialize unregistered class "${e}".`);if(i.deserialize)return i.deserialize(r);const s=Object.create(i.prototype);for(const a of Object.keys(r))a!=="$name"&&(s[a]=ho(r[a]));return s}throw new Error("can't deserialize object of type "+typeof r)}const Ft={"Latin-1 Supplement":r=>r>=128&&r<=255,Arabic:r=>r>=1536&&r<=1791,"Arabic Supplement":r=>r>=1872&&r<=1919,"Arabic Extended-A":r=>r>=2208&&r<=2303,"Hangul Jamo":r=>r>=4352&&r<=4607,"Unified Canadian Aboriginal Syllabics":r=>r>=5120&&r<=5759,Khmer:r=>r>=6016&&r<=6143,"Unified Canadian Aboriginal Syllabics Extended":r=>r>=6320&&r<=6399,"General Punctuation":r=>r>=8192&&r<=8303,"Letterlike Symbols":r=>r>=8448&&r<=8527,"Number Forms":r=>r>=8528&&r<=8591,"Miscellaneous Technical":r=>r>=8960&&r<=9215,"Control Pictures":r=>r>=9216&&r<=9279,"Optical Character Recognition":r=>r>=9280&&r<=9311,"Enclosed Alphanumerics":r=>r>=9312&&r<=9471,"Geometric Shapes":r=>r>=9632&&r<=9727,"Miscellaneous Symbols":r=>r>=9728&&r<=9983,"Miscellaneous Symbols and Arrows":r=>r>=11008&&r<=11263,"CJK Radicals Supplement":r=>r>=11904&&r<=12031,"Kangxi Radicals":r=>r>=12032&&r<=12255,"Ideographic Description Characters":r=>r>=12272&&r<=12287,"CJK Symbols and Punctuation":r=>r>=12288&&r<=12351,Hiragana:r=>r>=12352&&r<=12447,Katakana:r=>r>=12448&&r<=12543,Bopomofo:r=>r>=12544&&r<=12591,"Hangul Compatibility Jamo":r=>r>=12592&&r<=12687,Kanbun:r=>r>=12688&&r<=12703,"Bopomofo Extended":r=>r>=12704&&r<=12735,"CJK Strokes":r=>r>=12736&&r<=12783,"Katakana Phonetic Extensions":r=>r>=12784&&r<=12799,"Enclosed CJK Letters and Months":r=>r>=12800&&r<=13055,"CJK Compatibility":r=>r>=13056&&r<=13311,"CJK Unified Ideographs Extension A":r=>r>=13312&&r<=19903,"Yijing Hexagram Symbols":r=>r>=19904&&r<=19967,"CJK Unified Ideographs":r=>r>=19968&&r<=40959,"Yi Syllables":r=>r>=40960&&r<=42127,"Yi Radicals":r=>r>=42128&&r<=42191,"Hangul Jamo Extended-A":r=>r>=43360&&r<=43391,"Hangul Syllables":r=>r>=44032&&r<=55215,"Hangul Jamo Extended-B":r=>r>=55216&&r<=55295,"Private Use Area":r=>r>=57344&&r<=63743,"CJK Compatibility Ideographs":r=>r>=63744&&r<=64255,"Arabic Presentation Forms-A":r=>r>=64336&&r<=65023,"Vertical Forms":r=>r>=65040&&r<=65055,"CJK Compatibility Forms":r=>r>=65072&&r<=65103,"Small Form Variants":r=>r>=65104&&r<=65135,"Arabic Presentation Forms-B":r=>r>=65136&&r<=65279,"Halfwidth and Fullwidth Forms":r=>r>=65280&&r<=65519,Osage:r=>r>=66736&&r<=66815,"CJK Unified Ideographs Extension B":r=>r>=131072&&r<=173791};function Fl(r){for(const e of r)if(xh(e.charCodeAt(0)))return!0;return!1}function sm(r){for(const e of r)if(!om(e.charCodeAt(0)))return!1;return!0}function om(r){return!(Ft.Arabic(r)||Ft["Arabic Supplement"](r)||Ft["Arabic Extended-A"](r)||Ft["Arabic Presentation Forms-A"](r)||Ft["Arabic Presentation Forms-B"](r))}function xh(r){return!(r!==746&&r!==747&&(r<4352||!(Ft["Bopomofo Extended"](r)||Ft.Bopomofo(r)||Ft["CJK Compatibility Forms"](r)&&!(r>=65097&&r<=65103)||Ft["CJK Compatibility Ideographs"](r)||Ft["CJK Compatibility"](r)||Ft["CJK Radicals Supplement"](r)||Ft["CJK Strokes"](r)||!(!Ft["CJK Symbols and Punctuation"](r)||r>=12296&&r<=12305||r>=12308&&r<=12319||r===12336)||Ft["CJK Unified Ideographs Extension A"](r)||Ft["CJK Unified Ideographs"](r)||Ft["Enclosed CJK Letters and Months"](r)||Ft["Hangul Compatibility Jamo"](r)||Ft["Hangul Jamo Extended-A"](r)||Ft["Hangul Jamo Extended-B"](r)||Ft["Hangul Jamo"](r)||Ft["Hangul Syllables"](r)||Ft.Hiragana(r)||Ft["Ideographic Description Characters"](r)||Ft.Kanbun(r)||Ft["Kangxi Radicals"](r)||Ft["Katakana Phonetic Extensions"](r)||Ft.Katakana(r)&&r!==12540||!(!Ft["Halfwidth and Fullwidth Forms"](r)||r===65288||r===65289||r===65293||r>=65306&&r<=65310||r===65339||r===65341||r===65343||r>=65371&&r<=65503||r===65507||r>=65512&&r<=65519)||!(!Ft["Small Form Variants"](r)||r>=65112&&r<=65118||r>=65123&&r<=65126)||Ft["Unified Canadian Aboriginal Syllabics"](r)||Ft["Unified Canadian Aboriginal Syllabics Extended"](r)||Ft["Vertical Forms"](r)||Ft["Yijing Hexagram Symbols"](r)||Ft["Yi Syllables"](r)||Ft["Yi Radicals"](r))))}function sf(r){return!(xh(r)||function(e){return!!(Ft["Latin-1 Supplement"](e)&&(e===167||e===169||e===174||e===177||e===188||e===189||e===190||e===215||e===247)||Ft["General Punctuation"](e)&&(e===8214||e===8224||e===8225||e===8240||e===8241||e===8251||e===8252||e===8258||e===8263||e===8264||e===8265||e===8273)||Ft["Letterlike Symbols"](e)||Ft["Number Forms"](e)||Ft["Miscellaneous Technical"](e)&&(e>=8960&&e<=8967||e>=8972&&e<=8991||e>=8996&&e<=9e3||e===9003||e>=9085&&e<=9114||e>=9150&&e<=9165||e===9167||e>=9169&&e<=9179||e>=9186&&e<=9215)||Ft["Control Pictures"](e)&&e!==9251||Ft["Optical Character Recognition"](e)||Ft["Enclosed Alphanumerics"](e)||Ft["Geometric Shapes"](e)||Ft["Miscellaneous Symbols"](e)&&!(e>=9754&&e<=9759)||Ft["Miscellaneous Symbols and Arrows"](e)&&(e>=11026&&e<=11055||e>=11088&&e<=11097||e>=11192&&e<=11243)||Ft["CJK Symbols and Punctuation"](e)||Ft.Katakana(e)||Ft["Private Use Area"](e)||Ft["CJK Compatibility Forms"](e)||Ft["Small Form Variants"](e)||Ft["Halfwidth and Fullwidth Forms"](e)||e===8734||e===8756||e===8757||e>=9984&&e<=10087||e>=10102&&e<=10131||e===65532||e===65533)}(r))}function am(r){return Ft.Arabic(r)||Ft["Arabic Supplement"](r)||Ft["Arabic Extended-A"](r)||Ft["Arabic Presentation Forms-A"](r)||Ft["Arabic Presentation Forms-B"](r)}function of(r){return r>=1424&&r<=2303||Ft["Arabic Presentation Forms-A"](r)||Ft["Arabic Presentation Forms-B"](r)}function lm(r,e){return!(!e&&of(r)||r>=2304&&r<=3583||r>=3840&&r<=4255||Ft.Khmer(r))}function cm(r){for(const e of r)if(of(e.charCodeAt(0)))return!0;return!1}const On={unavailable:"unavailable",deferred:"deferred",loading:"loading",parsing:"parsing",parsed:"parsed",loaded:"loaded",error:"error"};let bh=null,bn=On.unavailable,Fs=null;const Yo=function(r){r&&typeof r=="string"&&r.indexOf("NetworkError")>-1&&(bn=On.error),bh&&bh(r)};function Xc(){Yc.fire(new Fo("pluginStateChange",{pluginStatus:bn,pluginURL:Fs}))}const Yc=new Bo,za=function(){return bn},af=function(){if(bn!==On.deferred||!Fs)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");bn=On.loading,Xc(),Fs&&pl({url:Fs},r=>{r?Yo(r):(bn=On.loaded,Xc())})},Bs={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>bn===On.loaded||Bs.applyArabicShaping!=null,isLoading:()=>bn===On.loading,setState(r){bn=r.pluginStatus,Fs=r.pluginURL},isParsing:()=>bn===On.parsing,isParsed:()=>bn===On.parsed,getPluginURL:()=>Fs};class Gi{constructor(e,i){this.zoom=e,i?(this.now=i.now,this.fadeDuration=i.fadeDuration,this.transition=i.transition,this.pitch=i.pitch,this.brightness=i.brightness,this.worldview=i.worldview):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0,this.brightness=0)}isSupportedScript(e){return function(i,s){for(const a of i)if(!lm(a.charCodeAt(0),s))return!1;return!0}(e,Bs.isLoaded())}}class Bl{constructor(e,i,s,a){this.property=e,this.value=i,this.expression=function(u,h,p,_){if(Dl(u))return new Pa(u,h);if(Zc(u)||Array.isArray(u)&&u.length>0){const g=tf(u,h,p,_);if(g.result==="error")throw new Error(g.value.map(x=>`${x.key}: ${x.message}`).join(", "));return g.value}{let g=u;return typeof u=="string"&&h.type==="color"&&(g=Pi.parse(u)),{kind:"constant",configDependencies:new Set,evaluate:()=>g}}}(i===void 0?e.specification.default:i,e.specification,s,a)}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(e,i,s){return this.property.possiblyEvaluate(this,e,i,s)}}class fo{constructor(e,i,s){this.property=e,this.value=new Bl(e,void 0,i,s)}transitioned(e,i){return new cf(this.property,this.value,i,we({},e.transition,this.transition),e.now)}untransitioned(){return new cf(this.property,this.value,null,{},0)}}class lf{constructor(e,i,s){this._properties=e,this._values=Object.create(e.defaultTransitionablePropertyValues),this._scope=i,this._options=s,this.configDependencies=new Set}getValue(e){return Wt(this._values[e].value.value)}setValue(e,i){this._values.hasOwnProperty(e)||(this._values[e]=new fo(this._values[e].property,this._scope,this._options)),this._values[e].value=new Bl(this._values[e].property,i===null?void 0:Wt(i),this._scope,this._options),this._values[e].value.expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[e].value.expression.configDependencies]))}setTransitionOrValue(e,i){i&&(this._options=i);const s=this._properties.properties;if(e)for(const a in e){const u=e[a];if(a.endsWith("-transition")){const h=a.slice(0,-11);s[h]&&this.setTransition(h,u)}else s.hasOwnProperty(a)&&this.setValue(a,u)}}getTransition(e){return Wt(this._values[e].transition)}setTransition(e,i){this._values.hasOwnProperty(e)||(this._values[e]=new fo(this._values[e].property)),this._values[e].transition=Wt(i)||void 0}serialize(){const e={};for(const i of Object.keys(this._values)){const s=this.getValue(i);s!==void 0&&(e[i]=s);const a=this.getTransition(i);a!==void 0&&(e[`${i}-transition`]=a)}return e}transitioned(e,i){const s=new uf(this._properties);for(const a of Object.keys(this._values))s._values[a]=this._values[a].transitioned(e,i._values[a]);return s}untransitioned(){const e=new uf(this._properties);for(const i of Object.keys(this._values))e._values[i]=this._values[i].untransitioned();return e}}class cf{constructor(e,i,s,a,u){const h=a.delay||0,p=a.duration||0;u=u||0,this.property=e,this.value=i,this.begin=u+h,this.end=this.begin+p,e.specification.transition&&(a.delay||a.duration)&&(this.prior=s)}possiblyEvaluate(e,i,s){const a=e.now||0,u=this.value.possiblyEvaluate(e,i,s),h=this.prior;if(h){if(a>this.end)return this.prior=null,u;if(this.value.isDataDriven())return this.prior=null,u;if(a<this.begin)return h.possiblyEvaluate(e,i,s);{const p=(a-this.begin)/(this.end-this.begin);return this.property.interpolate(h.possiblyEvaluate(e,i,s),u,U(p))}}return u}}class uf{constructor(e){this._properties=e,this._values=Object.create(e.defaultTransitioningPropertyValues)}possiblyEvaluate(e,i,s){const a=new Ko(this._properties);for(const u of Object.keys(this._values))a._values[u]=this._values[u].possiblyEvaluate(e,i,s);return a}hasTransition(){for(const e of Object.keys(this._values))if(this._values[e].prior)return!0;return!1}}class um{constructor(e,i,s){this._properties=e,this._values=Object.create(e.defaultPropertyValues),this._scope=i,this._options=s,this.configDependencies=new Set}getValue(e){return Wt(this._values[e].value)}setValue(e,i){this._values[e]=new Bl(this._values[e].property,i===null?void 0:Wt(i),this._scope,this._options),this._values[e].expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[e].expression.configDependencies]))}serialize(){const e={};for(const i of Object.keys(this._values)){const s=this.getValue(i);s!==void 0&&(e[i]=s)}return e}possiblyEvaluate(e,i,s){const a=new Ko(this._properties);for(const u of Object.keys(this._values))a._values[u]=this._values[u].possiblyEvaluate(e,i,s);return a}}class La{constructor(e,i,s){this.property=e,this.value=i,this.parameters=s}isConstant(){return this.value.kind==="constant"}constantOr(e){return this.value.kind==="constant"?this.value.value:e}evaluate(e,i,s,a){return this.property.evaluate(this.value,this.parameters,e,i,s,a)}}class Ko{constructor(e){this._properties=e,this._values=Object.create(e.defaultPossiblyEvaluatedValues)}get(e){return this._values[e]}}class Je{constructor(e){this.specification=e}possiblyEvaluate(e,i){return e.expression.evaluate(i)}interpolate(e,i,s){const a=gl[this.specification.type];return a?a(e,i,s):e}}class _t{constructor(e,i){this.specification=e,this.overrides=i}possiblyEvaluate(e,i,s,a){return new La(this,e.expression.kind==="constant"||e.expression.kind==="camera"?{kind:"constant",value:e.expression.evaluate(i,null,{},s,a)}:e.expression,i)}interpolate(e,i,s){if(e.value.kind!=="constant"||i.value.kind!=="constant")return e;if(e.value.value===void 0||i.value.value===void 0)return new La(this,{kind:"constant",value:void 0},e.parameters);const a=gl[this.specification.type];return a?new La(this,{kind:"constant",value:a(e.value.value,i.value.value,s)},e.parameters):e}evaluate(e,i,s,a,u,h){return e.kind==="constant"?e.value:e.evaluate(i,s,a,u,h)}}class Jo{constructor(e){this.specification=e}possiblyEvaluate(e,i,s,a){return!!e.expression.evaluate(i,null,{},s,a)}interpolate(){return!1}}class br{constructor(e){this.properties=e,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];const i=new Gi(0,{});for(const s in e){const a=e[s];a.specification.overridable&&this.overridableProperties.push(s);const u=this.defaultPropertyValues[s]=new Bl(a,void 0),h=this.defaultTransitionablePropertyValues[s]=new fo(a);this.defaultTransitioningPropertyValues[s]=h.untransitioned(),this.defaultPossiblyEvaluatedValues[s]=u.possiblyEvaluate(i)}}}bt(_t,"DataDrivenProperty"),bt(Je,"DataConstantProperty"),bt(Jo,"ColorRampProperty");var ge=JSON.parse('{"$version":8,"$root":{"version":{"type":"enum","values":[8]},"fragment":{"type":"boolean"},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360},"pitch":{"type":"number","default":0},"light":{"type":"light"},"lights":{"type":"array","value":"light-3d"},"terrain":{"type":"terrain","optional":true},"fog":{"type":"fog"},"snow":{"type":"snow"},"rain":{"type":"rain"},"camera":{"type":"camera"},"color-theme":{"type":"colorTheme"},"indoor":{"type":"indoor"},"imports":{"type":"array","value":"import"},"iconsets":{"type":"iconsets"},"schema":{"type":"schema"},"sources":{"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string","default":"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"type":"array","value":"layer"},"models":{"type":"models"},"featuresets":{"type":"featuresets"}},"featuresets":{"*":{"type":"featureset"}},"featureset":{"metadata":{"type":"*"},"selectors":{"type":"array","value":"selector"}},"selector":{"layer":{"type":"string"},"properties":{"type":"selectorProperty"},"featureNamespace":{"type":"string"},"_uniqueFeatureID":{"type":"boolean"}},"selectorProperty":{"*":{"type":"*"}},"model":{"type":"string"},"import":{"id":{"type":"string"},"url":{"type":"string"},"config":{"type":"config"},"data":{"type":"$root"},"color-theme":{"type":"colorTheme","optional":true}},"config":{"*":{"type":"*"}},"schema":{"*":{"type":"option"}},"option":{"default":{"type":"*","expression":{}},"type":{"type":"enum","values":{"string":1,"number":1,"boolean":1,"color":1}},"array":{"type":"boolean"},"minValue":{"type":"number"},"maxValue":{"type":"number"},"stepValue":{"type":"number"},"values":{"type":"array","value":"*"},"metadata":{"type":"*"}},"models":{"*":{"type":"model"}},"light-3d":{"id":{"type":"string"},"properties":{"type":"properties"},"type":{"type":"enum","values":{"ambient":{},"directional":{},"flat":{}}}},"properties":["properties_light_directional","properties_light_ambient","properties_light_flat"],"properties_light_directional":{"direction":{"type":"array","default":[210,30],"minimum":[0,0],"maximum":[360,90],"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"cast-shadows":{"type":"boolean","default":false},"shadow-quality":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"parameters":["zoom"]}},"shadow-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_ambient":{"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_flat":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"iconsets":{"*":{"type":"iconset"}},"iconset":["iconset_sprite","iconset_source"],"iconset_sprite":{"type":{"type":"enum","values":{"sprite":1}},"url":{"type":"string"}},"iconset_source":{"type":{"type":"enum","values":{"source":1}},"source":{"type":"string"}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_raster_array","source_geojson","source_video","source_image","source_model"],"source_vector":{"type":{"type":"enum","values":{"vector":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"type":"enum","values":{"raster":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"type":"enum","values":{"raster-dem":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":1,"mapbox":1},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_array":{"type":{"type":"enum","values":{"raster-array":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"rasterLayers":{"type":"*"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"type":"enum","values":{"geojson":1}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"},"dynamic":{"type":"boolean","default":false}},"source_video":{"type":{"type":"enum","values":{"video":1}},"urls":{"type":"array","value":"string"},"coordinates":{"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"type":"enum","values":{"image":1}},"url":{"type":"string"},"coordinates":{"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_model":{"type":{"type":"enum","values":{"model":1,"batched-model":1}},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"tiles":{"type":"array","value":"string"}},"layer":{"id":{"type":"string"},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"building":{},"raster":{},"raster-particle":{},"hillshade":{},"model":{},"background":{},"sky":{},"slot":{},"clip":{}}},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"slot":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"}},"layout":["layout_clip","layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_building","layout_symbol","layout_raster","layout_raster-particle","layout_hillshade","layout_background","layout_sky","layout_model"],"layout_background":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_model":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"model-id":{"type":"string","default":"","property-type":"data-driven","expression":{"parameters":["zoom","feature"]}}},"layout_clip":{"clip-layer-types":{"type":"array","value":"enum","values":{"model":1,"symbol":1},"default":[],"expression":{}},"clip-layer-scope":{"type":"array","value":"string","default":[],"expression":{}}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"fill-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-base":1,"hd-road-markup":1},"default":"none","expression":{}},"fill-construct-bridge-guard-rail":{"type":"boolean","default":"true","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"circle-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-markup":1},"default":"none","expression":{}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"fill-extrusion-edge-radius":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}}},"layout_building":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"building-roof-shape":{"type":"enum","values":{"flat":1,"hipped":1,"gabled":1,"parapet":1,"mansard":1,"skillion":1,"pyramidal":1},"default":"flat","expression":{"parameters":["feature"]},"property-type":"data-driven"},"building-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{},"property-type":"data-driven"},"building-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{},"property-type":"data-driven"}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":1,"round":1,"square":1},"default":"butt","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":1,"round":1,"miter":1,"none":1},"default":"miter","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-round-limit":{"type":"number","default":1.05,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-z-offset":{"type":"number","default":0,"expression":{"parameters":["zoom","feature","line-progress"]},"property-type":"data-driven"},"line-elevation-reference":{"type":"enum","values":{"none":1,"sea":1,"ground":1,"hd-road-markup":1},"default":"none","expression":{}},"line-cross-slope":{"type":"number","expression":{}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"line-width-unit":{"type":"enum","values":{"pixels":1,"meters":1},"default":"pixels","expression":{"parameters":["zoom"]}}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":1,"line":1,"line-center":1},"default":"point","expression":{"parameters":["zoom"]}},"symbol-spacing":{"type":"number","default":250,"minimum":1,"expression":{"interpolated":true,"parameters":["zoom"]}},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"symbol-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":1,"viewport-y":1,"source":1},"default":"auto","expression":{"parameters":["zoom"]}},"symbol-z-elevate":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"symbol-elevation-reference":{"type":"enum","values":{"sea":1,"ground":1,"hd-road-markup":1},"default":"ground","expression":{"parameters":["zoom"]}},"icon-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"icon-size":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":0.1,"maximum":10,"expression":{}},"icon-text-fit":{"type":"enum","values":{"none":1,"width":1,"height":1,"both":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-image":{"type":"resolvedImage","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"icon-keep-upright":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":0.1,"maximum":10,"expression":{}},"text-max-width":{"type":"number","default":10,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":1,"left":1,"center":1,"right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","default":0,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"expression":{"parameters":["zoom"]}},"text-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":1,"vertical":1},"expression":{"parameters":["zoom"]}},"text-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-keep-upright":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"text-transform":{"type":"enum","values":{"none":1,"uppercase":1,"lowercase":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"text-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"text-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_raster-particle":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_hillshade":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster-particle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_clip":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_model":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_building":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":1,"!=":1,">":1,">=":1,"<":1,"<=":1,"in":1,"!in":1,"all":1,"any":1,"none":1,"has":1,"!has":1}},"geometry_type":{"type":"enum","values":{"Point":1,"LineString":1,"Polygon":1}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":1,"exponential":1,"interval":1,"categorical":1},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":1,"lab":1,"hcl":1},"default":"rgb"},"default":{"type":"*"}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"high-color":{"type":"color","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"space-color":{"type":"color","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"horizon-blend":{"type":"number","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"star-intensity":{"type":"number","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vertical-range":{"type":"array","default":[0,0],"minimum":0,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}}},"snow":{"density":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.85],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.3],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"center-thinning":{"type":"number","default":0.4,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,50],"minimum":0,"maximum":360,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"flake-size":{"type":"number","default":0.71,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"rain":{"density":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.5],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","default":["interpolate",["linear"],["measure-light","brightness"],0,"#03113d",0.3,"#a8adbc"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"opacity":{"type":"number","default":["interpolate",["linear"],["measure-light","brightness"],0,0.88,1,0.7],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","default":["interpolate",["linear"],["measure-light","brightness"],0,"#001736",0.3,"#464646"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"center-thinning":{"type":"number","default":0.57,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,80],"minimum":0,"maximum":360,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"droplet-size":{"type":"array","default":[2.6,18.2],"minimum":0,"maximum":50,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"distortion-strength":{"type":"number","default":0.7,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"camera":{"camera-projection":{"type":"enum","values":{"perspective":1,"orthographic":1},"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"default":"perspective"}},"colorTheme":{"data":{"type":"string","expression":{}}},"indoor":{"floorplanFeaturesetId":{"type":"string","expression":{}},"buildingFeaturesetId":{"type":"string","expression":{}}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":1,"equalEarth":1,"equirectangular":1,"lambertConformalConic":1,"mercator":1,"naturalEarth":1,"winkelTripel":1,"globe":1},"default":"mercator"},"center":{"type":"array","length":2,"value":"number","minimum":[-180,-90],"maximum":[180,90]},"parallels":{"type":"array","length":2,"value":"number","minimum":[-90,-90],"maximum":[90,90]}},"terrain":{"source":{"type":"string"},"exaggeration":{"type":"number","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_building","paint_symbol","paint_raster","paint_raster-particle","paint_hillshade","paint_background","paint_sky","paint_model"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"fill-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-bridge-guard-rail-color":{"type":"color","default":"rgba(241, 236, 225, 255)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"},"fill-tunnel-structure-color":{"type":"color","default":"rgba(241, 236, 225, 255)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"fill-extrusion-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-height-alignment":{"type":"enum","values":{"terrain":1,"flat":1},"default":"flat"},"fill-extrusion-base-alignment":{"type":"enum","values":{"terrain":1,"flat":1},"default":"terrain"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-ambient-occlusion-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-wall-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-flood-light-color":{"type":"color","default":"#ffffff","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-wall-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-radius":{"property-type":"data-driven","type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-vertical-scale":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-rounded-roof":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"fill-extrusion-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"fill-extrusion-line-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-cast-shadows":{"type":"boolean","default":true}},"paint_building":{"building-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-ambient-occlusion-wall-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-vertical-scale":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-cast-shadows":{"type":"boolean","default":true},"building-color":{"type":"color","default":"rgba(193, 154, 127, 1)","use-theme":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]},"property-type":"data-driven"},"building-emissive-strength":{"type":"number","default":0,"minimum":0,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"property-type":"data-driven"}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light","line-progress"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-gradient":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["line-progress"]}},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1]},"line-trim-fade-range":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-trim-color":{"type":"color","default":"transparent","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-border-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-occlusion-opacity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"circle-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"circle-pitch-scale":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"circle-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]}},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"use-theme":true,"expression":{"interpolated":true,"parameters":["heatmap-density"]}},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"text-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"icon-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"icon-image-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"overridable":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"icon-color-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{}},"icon-color-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{}},"icon-color-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"icon-color-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{}},"symbol-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["raster-value"]}},"raster-color-mix":{"type":"array","default":[0.2126,0.7152,0.0722,0],"length":4,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color-range":{"type":"array","length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-resampling":{"type":"enum","values":{"linear":1,"nearest":1},"default":"linear","expression":{"parameters":["zoom"]}},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"raster-array-band":{"type":"string"},"raster-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_raster-particle":{"raster-particle-array-band":{"type":"string"},"raster-particle-count":{"type":"number","default":512,"minimum":1},"raster-particle-color":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["raster-particle-speed"]}},"raster-particle-max-speed":{"type":"number","default":1,"minimum":1},"raster-particle-speed-factor":{"type":"number","default":0.2,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-particle-fade-opacity-factor":{"type":"number","default":0.98,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-particle-reset-rate-factor":{"type":"number","default":0.8,"minimum":0,"maximum":1},"raster-particle-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"expression":{"interpolated":true,"parameters":["zoom"]}},"hillshade-illumination-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]}},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"hillshade-shadow-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-accent-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_background":{"background-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":[]}},"background-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"background-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom"]}},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"background-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":1,"atmosphere":1},"default":"atmosphere","expression":{"parameters":["zoom"]}},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]}},"sky-atmosphere-sun-intensity":{"type":"number","default":10,"minimum":0,"maximum":100},"sky-gradient-center":{"type":"array","value":"number","default":[0,0],"length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]}},"sky-gradient-radius":{"type":"number","default":90,"minimum":0,"maximum":180,"expression":{"parameters":["zoom"]}},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"use-theme":true,"expression":{"interpolated":true,"parameters":["sky-radial-progress"]}},"sky-atmosphere-halo-color":{"type":"color","default":"white","use-theme":true},"sky-atmosphere-color":{"type":"color","default":"white","use-theme":true},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_model":{"model-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"property-type":"data-driven"},"model-rotation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-scale":{"type":"array","value":"number","length":3,"default":[1,1,1],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-translation":{"type":"array","value":"number","length":3,"default":[0,0,0],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-color":{"type":"color","default":"#ffffff","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light","zoom"]},"use-theme":true,"transition":true},"model-color-mix-intensity":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-type":{"type":"enum","values":{"common-3d":1,"location-indicator":1},"default":"common-3d"},"model-cast-shadows":{"type":"boolean","default":true},"model-receive-shadows":{"type":"boolean","default":true},"model-ambient-occlusion-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"model-emissive-strength":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-roughness":{"type":"number","default":1,"minimum":0,"maximum":1,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-height-based-emissive-strength-multiplier":{"type":"array","default":[1,1,1,1,0],"length":5,"value":"number","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"model-front-cutoff":{"type":"array","value":"number","expression":{"interpolated":true,"parameters":["zoom"]},"length":3,"default":[0,0,1],"minimum":[0,0,0],"maximum":[1,1,1]}},"transition":{"duration":{"type":"number","default":300,"minimum":0},"delay":{"type":"number","default":0,"minimum":0}},"promoteId":{"*":{"type":"*"}}}');function ls(r){return r instanceof Number||r instanceof String||r instanceof Boolean?r.valueOf():r}function Kc(r){if(Array.isArray(r))return r.map(Kc);if(r instanceof Object&&!(r instanceof Number||r instanceof String||r instanceof Boolean)){const e={};for(const i in r)e[i]=Kc(r[i]);return e}return ls(r)}function Jc(r){if(r===!0||r===!1)return!0;if(!Array.isArray(r)||r.length===0)return!1;switch(r[0]){case"has":return r.length>=2&&r[1]!=="$id"&&r[1]!=="$type";case"in":return r.length>=3&&(typeof r[1]!="string"||Array.isArray(r[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return r.length!==3||Array.isArray(r[1])||Array.isArray(r[2]);case"any":case"all":for(const e of r.slice(1))if(!Jc(e)&&typeof e!="boolean")return!1;return!0;default:return!0}}function wh(r,e="",i=null,s="fill"){if(r==null)return{filter:()=>!0,needGeometry:!1,needFeature:!1};Jc(r)||(r=Qc(r));const a=r;let u=!0;try{u=function(x){if(!Da(x))return x;let b=Kc(x);return df(b),b=hf(b),b}(a)}catch{console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.
This is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md
and paste the contents of this message in the report.
Thank you!
Filter Expression:
${JSON.stringify(a,null,2)}
        `)}let h=null,p=null;if(s!=="background"&&s!=="sky"&&s!=="slot"){p=ge[`filter_${s}`];const x=Ds(u,p,e,i);if(x.result==="error")throw new Error(x.value.map(b=>`${b.key}: ${b.message}`).join(", "));h=(b,w,E)=>x.value.evaluate(b,w,{},E)}let _=null,g=null;if(u!==a){const x=Ds(a,p,e,i);if(x.result==="error")throw new Error(x.value.map(b=>`${b.key}: ${b.message}`).join(", "));_=(b,w,E,A,P)=>x.value.evaluate(b,w,{},E,void 0,void 0,A,P),g=!Ea(x.value.expression)}return{filter:h,dynamicFilter:_||void 0,needGeometry:ff(u),needFeature:!!g}}function hf(r){if(!Array.isArray(r))return r;const e=function(i){if(hm.has(i[0])){for(let s=1;s<i.length;s++)if(Da(i[s]))return!0}return i}(r);return e===!0?e:e.map(i=>hf(i))}function df(r){let e=!1;const i=[];if(r[0]==="case"){for(let s=1;s<r.length-1;s+=2)e=e||Da(r[s]),i.push(r[s+1]);i.push(r[r.length-1])}else if(r[0]==="match"){e=e||Da(r[1]);for(let s=2;s<r.length-1;s+=2)i.push(r[s+1]);i.push(r[r.length-1])}else if(r[0]==="step"){e=e||Da(r[1]);for(let s=1;s<r.length-1;s+=2)i.push(r[s+1])}e&&(r.length=0,r.push("any",...i));for(let s=1;s<r.length;s++)df(r[s])}function Da(r){if(!Array.isArray(r))return!1;if((e=r[0])==="pitch"||e==="distance-from-center")return!0;var e;for(let i=1;i<r.length;i++)if(Da(r[i]))return!0;return!1}const hm=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function dm(r,e){return r<e?-1:r>e?1:0}function ff(r){if(!Array.isArray(r))return!1;if(r[0]==="within"||r[0]==="distance")return!0;for(let e=1;e<r.length;e++)if(ff(r[e]))return!0;return!1}function Qc(r){if(!r)return!0;const e=r[0];return r.length<=1?e!=="any":e==="=="?Th(r[1],r[2],"=="):e==="!="?eu(Th(r[1],r[2],"==")):e==="<"||e===">"||e==="<="||e===">="?Th(r[1],r[2],e):e==="any"?(i=r.slice(1),["any"].concat(i.map(Qc))):e==="all"?["all"].concat(r.slice(1).map(Qc)):e==="none"?["all"].concat(r.slice(1).map(Qc).map(eu)):e==="in"?Sh(r[1],r.slice(2)):e==="!in"?eu(Sh(r[1],r.slice(2))):e==="has"?pf(r[1]):e!=="!has"||eu(pf(r[1]));var i}function Th(r,e,i){switch(r){case"$type":return[`filter-type-${i}`,e];case"$id":return[`filter-id-${i}`,e];default:return[`filter-${i}`,r,e]}}function Sh(r,e){if(e.length===0)return!1;switch(r){case"$type":return["filter-type-in",["literal",e]];case"$id":return["filter-id-in",["literal",e]];default:return e.length>200&&!e.some(i=>typeof i!=typeof e[0])?["filter-in-large",r,["literal",e.sort(dm)]]:["filter-in-small",r,["literal",e]]}}function pf(r){switch(r){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",r]}}function eu(r){return["!",r]}const Nl="";function Qo(r,e){return e?`${r}${Nl}${e}`:r}const Eh="-transition",po=new Set(["fill","line","background","hillshade","raster"]);class hn extends Bo{constructor(e,i,s,a,u){if(super(),this.id=e.id,this.fqid=Qo(this.id,s),this.type=e.type,this.scope=s,this.lut=a,this.options=u,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,this.configDependencies=new Set,e.type!=="custom"){if(this.metadata=e.metadata,this.minzoom=e.minzoom,this.maxzoom=e.maxzoom,e.type&&e.type!=="background"&&e.type!=="sky"&&e.type!=="slot"){this.source=e.source,this.sourceLayer=e["source-layer"],this.filter=e.filter;const h=Ds(this.filter,ge[`filter_${e.type}`]);h.result!=="error"&&(this.configDependencies=new Set([...this.configDependencies,...h.value.configDependencies]))}if(e.slot&&(this.slot=e.slot),i.layout&&(this._unevaluatedLayout=new um(i.layout,this.scope,u),this.configDependencies=new Set([...this.configDependencies,...this._unevaluatedLayout.configDependencies])),i.paint){this._transitionablePaint=new lf(i.paint,this.scope,u);for(const h in e.paint)this.setPaintProperty(h,e.paint[h]);for(const h in e.layout)this.setLayoutProperty(h,e.layout[h]);this.configDependencies=new Set([...this.configDependencies,...this._transitionablePaint.configDependencies]),this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new Ko(i.paint)}}}onAdd(e){}onRemove(e){}isDraped(e){return!this.is3D(!0)&&po.has(this.type)}getLayoutProperty(e){return e==="visibility"?this.visibility:this._unevaluatedLayout.getValue(e)}setLayoutProperty(e,i){if(this.type==="custom"&&e==="visibility")return void(this.visibility=i);const s=this._unevaluatedLayout;s._properties.properties[e]&&(s.setValue(e,i),this.configDependencies=new Set([...this.configDependencies,...s.configDependencies]),e==="visibility"&&this.possiblyEvaluateVisibility())}possiblyEvaluateVisibility(){this._unevaluatedLayout._values.visibility&&(this.visibility=this._unevaluatedLayout._values.visibility.possiblyEvaluate({zoom:0}))}getPaintProperty(e){return e.endsWith(Eh)?this._transitionablePaint.getTransition(e.slice(0,-11)):this._transitionablePaint.getValue(e)}setPaintProperty(e,i){const s=this._transitionablePaint,a=s._properties.properties;if(e.endsWith(Eh)){const b=e.slice(0,-11);return a[b]&&s.setTransition(b,i||void 0),!1}if(!a[e])return!1;const u=s._values[e],h=u.value.isDataDriven(),p=u.value;s.setValue(e,i),this.configDependencies=new Set([...this.configDependencies,...s.configDependencies]),this._handleSpecialPaintPropertyUpdate(e);const _=s._values[e].value,g=_.isDataDriven(),x=e.endsWith("pattern")||e==="line-dasharray";return g||h||x||this._handleOverridablePaintPropertyUpdate(e,p,_)}_handleSpecialPaintPropertyUpdate(e){}getProgramIds(){return null}getDefaultProgramParams(e,i,s){return null}_handleOverridablePaintPropertyUpdate(e,i,s){return!1}isHidden(e){return!!(this.minzoom&&e<this.minzoom)||!!(this.maxzoom&&e>=this.maxzoom)||this.visibility==="none"}updateTransitions(e){this._transitioningPaint=this._transitionablePaint.transitioned(e,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(e,i){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(e,void 0,i)),this.paint=this._transitioningPaint.possiblyEvaluate(e,void 0,i)}serialize(){return Ht({id:this.id,type:this.type,slot:this.slot,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()},(e,i)=>!(e===void 0||i==="layout"&&!Object.keys(e).length||i==="paint"&&!Object.keys(e).length))}is3D(e){return!1}hasElevation(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}hasShadowPass(){return!1}canCastShadows(){return!1}hasLightBeamPass(){return!1}cutoffRange(){return 0}tileCoverLift(){return 0}resize(){}isStateDependent(){for(const e in this.paint._values){const i=this.paint.get(e);if(i instanceof La&&zl(i.property.specification)&&(i.value.kind==="source"||i.value.kind==="composite")&&i.value.isStateDependent)return!0}return!1}compileFilter(e){this._filterCompiled||(this._featureFilter=wh(this.filter,this.scope,e),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}getLayerRenderingStats(){return this._stats}resetLayerRenderingStats(e){this._stats&&(e.renderPass==="shadow"?this._stats.numRenderedVerticesInShadowPass=0:this._stats.numRenderedVerticesInTransparentPass=0)}queryRadius(e){}queryIntersectsFeature(e,i,s,a,u,h,p,_,g){}}const fm={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class Vl{constructor(e,i){this._structArray=e,this._pos1=i*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class hr{constructor(){this.capacity=-1,this.resize(0)}static serialize(e,i){return e._trim(),i&&i.add(e.arrayBuffer),{length:e.length,arrayBuffer:e.arrayBuffer}}static deserialize(e){const i=Object.create(this.prototype);return i.arrayBuffer=e.arrayBuffer,i.length=e.length,i.capacity=e.arrayBuffer.byteLength/i.bytesPerElement,i._refreshViews(),i}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(e){this.reserve(e),this.length=e}reserve(e){if(e>this.capacity){this.capacity=Math.max(e,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const i=this.uint8;this._refreshViews(),i&&this.uint8.set(i)}}_refreshViews(){throw new Error("StructArray#_refreshViews() must be implemented by each concrete StructArray layout")}emplace(...e){throw new Error("StructArray#emplace() must be implemented by each concrete StructArray layout")}emplaceBack(...e){throw new Error("StructArray#emplaceBack() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function bi(r,e=1){let i=0,s=0;return{members:r.map(a=>{const u=fm[a.type].BYTES_PER_ELEMENT,h=i=Ih(i,Math.max(e,u)),p=a.components||1;return s=Math.max(s,u),i+=u*p,{name:a.name,type:a.type,components:p,offset:h}}),size:Ih(i,Math.max(s,e)),alignment:e}}function Ih(r,e){return Math.ceil(r/e)*e}class Ns extends hr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i){const s=this.length;return this.resize(s+1),this.emplace(s,e,i)}emplace(e,i,s){const a=2*e;return this.int16[a+0]=i,this.int16[a+1]=s,e}}Ns.prototype.bytesPerElement=4,bt(Ns,"StructArrayLayout2i4");class Ul extends hr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s){const a=this.length;return this.resize(a+1),this.emplace(a,e,i,s)}emplace(e,i,s,a){const u=3*e;return this.int16[u+0]=i,this.int16[u+1]=s,this.int16[u+2]=a,e}}Ul.prototype.bytesPerElement=6,bt(Ul,"StructArrayLayout3i6");class Oa extends hr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s,a){const u=this.length;return this.resize(u+1),this.emplace(u,e,i,s,a)}emplace(e,i,s,a,u){const h=4*e;return this.int16[h+0]=i,this.int16[h+1]=s,this.int16[h+2]=a,this.int16[h+3]=u,e}}Oa.prototype.bytesPerElement=8,bt(Oa,"StructArrayLayout4i8");class mo extends hr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.float32[1*e+0]=i,e}}mo.prototype.bytesPerElement=4,bt(mo,"StructArrayLayout1f4");class Ah extends hr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s){const a=this.length;return this.resize(a+1),this.emplace(a,e,i,s)}emplace(e,i,s,a){const u=4*e,h=2*e;return this.int16[u+0]=i,this.int16[u+1]=s,this.float32[h+1]=a,e}}Ah.prototype.bytesPerElement=8,bt(Ah,"StructArrayLayout2i1f8");class tu extends hr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s){const a=this.length;return this.resize(a+1),this.emplace(a,e,i,s)}emplace(e,i,s,a){const u=4*e;return this.int16[u+0]=i,this.int16[u+1]=s,this.int16[u+2]=a,e}}tu.prototype.bytesPerElement=8,bt(tu,"StructArrayLayout3i8");class ka extends hr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u){const h=this.length;return this.resize(h+1),this.emplace(h,e,i,s,a,u)}emplace(e,i,s,a,u,h){const p=5*e;return this.int16[p+0]=i,this.int16[p+1]=s,this.int16[p+2]=a,this.int16[p+3]=u,this.int16[p+4]=h,e}}ka.prototype.bytesPerElement=10,bt(ka,"StructArrayLayout5i10");class Ch extends hr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u,h,p){const _=this.length;return this.resize(_+1),this.emplace(_,e,i,s,a,u,h,p)}emplace(e,i,s,a,u,h,p,_){const g=6*e,x=12*e,b=3*e;return this.int16[g+0]=i,this.int16[g+1]=s,this.uint8[x+4]=a,this.uint8[x+5]=u,this.uint8[x+6]=h,this.uint8[x+7]=p,this.float32[b+2]=_,e}}Ch.prototype.bytesPerElement=12,bt(Ch,"StructArrayLayout2i4ub1f12");class ys extends hr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s){const a=this.length;return this.resize(a+1),this.emplace(a,e,i,s)}emplace(e,i,s,a){const u=3*e;return this.float32[u+0]=i,this.float32[u+1]=s,this.float32[u+2]=a,e}}ys.prototype.bytesPerElement=12,bt(ys,"StructArrayLayout3f12");class _o extends hr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u){const h=this.length;return this.resize(h+1),this.emplace(h,e,i,s,a,u)}emplace(e,i,s,a,u,h){const p=6*e,_=3*e;return this.uint16[p+0]=i,this.uint16[p+1]=s,this.uint16[p+2]=a,this.uint16[p+3]=u,this.float32[_+2]=h,e}}_o.prototype.bytesPerElement=12,bt(_o,"StructArrayLayout4ui1f12");class jl extends hr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,s,a){const u=this.length;return this.resize(u+1),this.emplace(u,e,i,s,a)}emplace(e,i,s,a,u){const h=4*e;return this.uint16[h+0]=i,this.uint16[h+1]=s,this.uint16[h+2]=a,this.uint16[h+3]=u,e}}jl.prototype.bytesPerElement=8,bt(jl,"StructArrayLayout4ui8");class iu extends hr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u,h){const p=this.length;return this.resize(p+1),this.emplace(p,e,i,s,a,u,h)}emplace(e,i,s,a,u,h,p){const _=6*e;return this.int16[_+0]=i,this.int16[_+1]=s,this.int16[_+2]=a,this.int16[_+3]=u,this.int16[_+4]=h,this.int16[_+5]=p,e}}iu.prototype.bytesPerElement=12,bt(iu,"StructArrayLayout6i12");class Fa extends hr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u,h,p,_,g,x,b,w){const E=this.length;return this.resize(E+1),this.emplace(E,e,i,s,a,u,h,p,_,g,x,b,w)}emplace(e,i,s,a,u,h,p,_,g,x,b,w,E){const A=12*e;return this.int16[A+0]=i,this.int16[A+1]=s,this.int16[A+2]=a,this.int16[A+3]=u,this.uint16[A+4]=h,this.uint16[A+5]=p,this.uint16[A+6]=_,this.uint16[A+7]=g,this.int16[A+8]=x,this.int16[A+9]=b,this.int16[A+10]=w,this.int16[A+11]=E,e}}Fa.prototype.bytesPerElement=24,bt(Fa,"StructArrayLayout4i4ui4i24");class Ba extends hr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u,h){const p=this.length;return this.resize(p+1),this.emplace(p,e,i,s,a,u,h)}emplace(e,i,s,a,u,h,p){const _=10*e,g=5*e;return this.int16[_+0]=i,this.int16[_+1]=s,this.int16[_+2]=a,this.float32[g+2]=u,this.float32[g+3]=h,this.float32[g+4]=p,e}}Ba.prototype.bytesPerElement=20,bt(Ba,"StructArrayLayout3i3f20");class Qr extends hr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a){const u=this.length;return this.resize(u+1),this.emplace(u,e,i,s,a)}emplace(e,i,s,a,u){const h=4*e;return this.float32[h+0]=i,this.float32[h+1]=s,this.float32[h+2]=a,this.float32[h+3]=u,e}}Qr.prototype.bytesPerElement=16,bt(Qr,"StructArrayLayout4f16");class Na extends hr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.uint32[1*e+0]=i,e}}Na.prototype.bytesPerElement=4,bt(Na,"StructArrayLayout1ul4");class go extends hr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i){const s=this.length;return this.resize(s+1),this.emplace(s,e,i)}emplace(e,i,s){const a=2*e;return this.uint16[a+0]=i,this.uint16[a+1]=s,e}}go.prototype.bytesPerElement=4,bt(go,"StructArrayLayout2ui4");class Mh extends hr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u,h,p,_,g,x,b,w,E){const A=this.length;return this.resize(A+1),this.emplace(A,e,i,s,a,u,h,p,_,g,x,b,w,E)}emplace(e,i,s,a,u,h,p,_,g,x,b,w,E,A){const P=20*e,L=10*e;return this.int16[P+0]=i,this.int16[P+1]=s,this.int16[P+2]=a,this.int16[P+3]=u,this.int16[P+4]=h,this.float32[L+3]=p,this.float32[L+4]=_,this.float32[L+5]=g,this.float32[L+6]=x,this.int16[P+14]=b,this.uint32[L+8]=w,this.uint16[P+18]=E,this.uint16[P+19]=A,e}}Mh.prototype.bytesPerElement=40,bt(Mh,"StructArrayLayout5i4f1i1ul2ui40");class ru extends hr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u,h,p){const _=this.length;return this.resize(_+1),this.emplace(_,e,i,s,a,u,h,p)}emplace(e,i,s,a,u,h,p,_){const g=8*e;return this.int16[g+0]=i,this.int16[g+1]=s,this.int16[g+2]=a,this.int16[g+4]=u,this.int16[g+5]=h,this.int16[g+6]=p,this.int16[g+7]=_,e}}ru.prototype.bytesPerElement=16,bt(ru,"StructArrayLayout3i2i2i16");class Ph extends hr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u){const h=this.length;return this.resize(h+1),this.emplace(h,e,i,s,a,u)}emplace(e,i,s,a,u,h){const p=4*e,_=8*e;return this.float32[p+0]=i,this.float32[p+1]=s,this.float32[p+2]=a,this.int16[_+6]=u,this.int16[_+7]=h,e}}Ph.prototype.bytesPerElement=16,bt(Ph,"StructArrayLayout2f1f2i16");class Gl extends hr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u,h){const p=this.length;return this.resize(p+1),this.emplace(p,e,i,s,a,u,h)}emplace(e,i,s,a,u,h,p){const _=20*e,g=5*e;return this.uint8[_+0]=i,this.uint8[_+1]=s,this.float32[g+1]=a,this.float32[g+2]=u,this.float32[g+3]=h,this.float32[g+4]=p,e}}Gl.prototype.bytesPerElement=20,bt(Gl,"StructArrayLayout2ub4f20");class en extends hr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,s){const a=this.length;return this.resize(a+1),this.emplace(a,e,i,s)}emplace(e,i,s,a){const u=3*e;return this.uint16[u+0]=i,this.uint16[u+1]=s,this.uint16[u+2]=a,e}}en.prototype.bytesPerElement=6,bt(en,"StructArrayLayout3ui6");class ql extends hr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u,h,p,_,g,x,b,w,E,A,P,L,k,j,G,R,N){const q=this.length;return this.resize(q+1),this.emplace(q,e,i,s,a,u,h,p,_,g,x,b,w,E,A,P,L,k,j,G,R,N)}emplace(e,i,s,a,u,h,p,_,g,x,b,w,E,A,P,L,k,j,G,R,N,q){const Z=30*e,ae=15*e,ne=60*e;return this.int16[Z+0]=i,this.int16[Z+1]=s,this.int16[Z+2]=a,this.float32[ae+2]=u,this.float32[ae+3]=h,this.uint16[Z+8]=p,this.uint16[Z+9]=_,this.uint32[ae+5]=g,this.uint32[ae+6]=x,this.uint32[ae+7]=b,this.uint16[Z+16]=w,this.uint16[Z+17]=E,this.uint16[Z+18]=A,this.float32[ae+10]=P,this.float32[ae+11]=L,this.uint8[ne+48]=k,this.uint8[ne+49]=j,this.uint8[ne+50]=G,this.uint32[ae+13]=R,this.int16[Z+28]=N,this.uint8[ne+58]=q,e}}ql.prototype.bytesPerElement=60,bt(ql,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class Rh extends hr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u,h,p,_,g,x,b,w,E,A,P,L,k,j,G,R,N,q,Z,ae,ne,ce,me,Re,Xe,Ve,We,Ke,Le){const He=this.length;return this.resize(He+1),this.emplace(He,e,i,s,a,u,h,p,_,g,x,b,w,E,A,P,L,k,j,G,R,N,q,Z,ae,ne,ce,me,Re,Xe,Ve,We,Ke,Le)}emplace(e,i,s,a,u,h,p,_,g,x,b,w,E,A,P,L,k,j,G,R,N,q,Z,ae,ne,ce,me,Re,Xe,Ve,We,Ke,Le,He){const Me=20*e,ze=40*e,et=80*e;return this.float32[Me+0]=i,this.float32[Me+1]=s,this.int16[ze+4]=a,this.int16[ze+5]=u,this.int16[ze+6]=h,this.int16[ze+7]=p,this.int16[ze+8]=_,this.int16[ze+9]=g,this.int16[ze+10]=x,this.int16[ze+11]=b,this.int16[ze+12]=w,this.uint16[ze+13]=E,this.uint16[ze+14]=A,this.uint16[ze+15]=P,this.uint16[ze+16]=L,this.uint16[ze+17]=k,this.uint16[ze+18]=j,this.uint16[ze+19]=G,this.uint16[ze+20]=R,this.uint16[ze+21]=N,this.uint16[ze+22]=q,this.uint16[ze+23]=Z,this.uint16[ze+24]=ae,this.uint16[ze+25]=ne,this.uint16[ze+26]=ce,this.uint16[ze+27]=me,this.uint32[Me+14]=Re,this.float32[Me+15]=Xe,this.float32[Me+16]=Ve,this.float32[Me+17]=We,this.float32[Me+18]=Ke,this.uint8[et+76]=Le,this.uint16[ze+39]=He,e}}Rh.prototype.bytesPerElement=80,bt(Rh,"StructArrayLayout2f9i15ui1ul4f1ub1ui80");class zh extends hr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u,h){const p=this.length;return this.resize(p+1),this.emplace(p,e,i,s,a,u,h)}emplace(e,i,s,a,u,h,p){const _=6*e;return this.float32[_+0]=i,this.float32[_+1]=s,this.float32[_+2]=a,this.float32[_+3]=u,this.float32[_+4]=h,this.float32[_+5]=p,e}}zh.prototype.bytesPerElement=24,bt(zh,"StructArrayLayout6f24");class yo extends hr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u){const h=this.length;return this.resize(h+1),this.emplace(h,e,i,s,a,u)}emplace(e,i,s,a,u,h){const p=5*e;return this.float32[p+0]=i,this.float32[p+1]=s,this.float32[p+2]=a,this.float32[p+3]=u,this.float32[p+4]=h,e}}yo.prototype.bytesPerElement=20,bt(yo,"StructArrayLayout5f20");class $l extends hr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u,h,p){const _=this.length;return this.resize(_+1),this.emplace(_,e,i,s,a,u,h,p)}emplace(e,i,s,a,u,h,p,_){const g=7*e;return this.float32[g+0]=i,this.float32[g+1]=s,this.float32[g+2]=a,this.float32[g+3]=u,this.float32[g+4]=h,this.float32[g+5]=p,this.float32[g+6]=_,e}}$l.prototype.bytesPerElement=28,bt($l,"StructArrayLayout7f28");class Lh extends hr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u,h,p,_,g,x,b){const w=this.length;return this.resize(w+1),this.emplace(w,e,i,s,a,u,h,p,_,g,x,b)}emplace(e,i,s,a,u,h,p,_,g,x,b,w){const E=11*e;return this.float32[E+0]=i,this.float32[E+1]=s,this.float32[E+2]=a,this.float32[E+3]=u,this.float32[E+4]=h,this.float32[E+5]=p,this.float32[E+6]=_,this.float32[E+7]=g,this.float32[E+8]=x,this.float32[E+9]=b,this.float32[E+10]=w,e}}Lh.prototype.bytesPerElement=44,bt(Lh,"StructArrayLayout11f44");class nu extends hr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u,h,p,_,g){const x=this.length;return this.resize(x+1),this.emplace(x,e,i,s,a,u,h,p,_,g)}emplace(e,i,s,a,u,h,p,_,g,x){const b=9*e;return this.float32[b+0]=i,this.float32[b+1]=s,this.float32[b+2]=a,this.float32[b+3]=u,this.float32[b+4]=h,this.float32[b+5]=p,this.float32[b+6]=_,this.float32[b+7]=g,this.float32[b+8]=x,e}}nu.prototype.bytesPerElement=36,bt(nu,"StructArrayLayout9f36");class ea extends hr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i){const s=this.length;return this.resize(s+1),this.emplace(s,e,i)}emplace(e,i,s){const a=2*e;return this.float32[a+0]=i,this.float32[a+1]=s,e}}ea.prototype.bytesPerElement=8,bt(ea,"StructArrayLayout2f8");class Dh extends hr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,s,a){const u=this.length;return this.resize(u+1),this.emplace(u,e,i,s,a)}emplace(e,i,s,a,u){const h=6*e;return this.uint32[3*e+0]=i,this.uint16[h+2]=s,this.uint16[h+3]=a,this.uint16[h+4]=u,e}}Dh.prototype.bytesPerElement=12,bt(Dh,"StructArrayLayout1ul3ui12");class Hl extends hr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.uint16[1*e+0]=i,e}}Hl.prototype.bytesPerElement=2,bt(Hl,"StructArrayLayout1ui2");class Va extends hr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u,h,p,_,g,x,b,w,E,A,P,L){const k=this.length;return this.resize(k+1),this.emplace(k,e,i,s,a,u,h,p,_,g,x,b,w,E,A,P,L)}emplace(e,i,s,a,u,h,p,_,g,x,b,w,E,A,P,L,k){const j=16*e;return this.float32[j+0]=i,this.float32[j+1]=s,this.float32[j+2]=a,this.float32[j+3]=u,this.float32[j+4]=h,this.float32[j+5]=p,this.float32[j+6]=_,this.float32[j+7]=g,this.float32[j+8]=x,this.float32[j+9]=b,this.float32[j+10]=w,this.float32[j+11]=E,this.float32[j+12]=A,this.float32[j+13]=P,this.float32[j+14]=L,this.float32[j+15]=k,e}}Va.prototype.bytesPerElement=64,bt(Va,"StructArrayLayout16f64");class Zl extends hr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u,h,p){const _=this.length;return this.resize(_+1),this.emplace(_,e,i,s,a,u,h,p)}emplace(e,i,s,a,u,h,p,_){const g=10*e,x=5*e;return this.uint16[g+0]=i,this.uint16[g+1]=s,this.uint16[g+2]=a,this.uint16[g+3]=u,this.float32[x+2]=h,this.float32[x+3]=p,this.float32[x+4]=_,e}}Zl.prototype.bytesPerElement=20,bt(Zl,"StructArrayLayout4ui3f20");class Oh extends hr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.int16[1*e+0]=i,e}}Oh.prototype.bytesPerElement=2,bt(Oh,"StructArrayLayout1i2");class su extends hr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.uint8[1*e+0]=i,e}}su.prototype.bytesPerElement=1,bt(su,"StructArrayLayout1ub1");class mf extends Vl{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}mf.prototype.size=40;class ou extends Mh{get(e){return new mf(this,e)}}bt(ou,"CollisionBoxArray");class _f extends Vl{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(e){this._structArray.uint8[this._pos1+49]=e}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(e){this._structArray.uint8[this._pos1+50]=e}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(e){this._structArray.uint32[this._pos4+13]=e}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(e){this._structArray.uint8[this._pos1+58]=e}}_f.prototype.size=60;class gf extends ql{get(e){return new _f(this,e)}}bt(gf,"PlacedSymbolArray");class yf extends Vl{get tileAnchorX(){return this._structArray.float32[this._pos4+0]}get tileAnchorY(){return this._structArray.float32[this._pos4+1]}get projectedAnchorX(){return this._structArray.int16[this._pos2+4]}get projectedAnchorY(){return this._structArray.int16[this._pos2+5]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+6]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+7]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+11]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get key(){return this._structArray.uint16[this._pos2+13]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+14]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+15]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+17]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+19]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+21]}get featureIndex(){return this._structArray.uint16[this._pos2+22]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+23]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numIconVertices(){return this._structArray.uint16[this._pos2+25]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+26]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+27]}get crossTileID(){return this._structArray.uint32[this._pos4+14]}set crossTileID(e){this._structArray.uint32[this._pos4+14]=e}get textOffset0(){return this._structArray.float32[this._pos4+15]}get textOffset1(){return this._structArray.float32[this._pos4+16]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+17]}get zOffset(){return this._structArray.float32[this._pos4+18]}set zOffset(e){this._structArray.float32[this._pos4+18]=e}get hasIconTextFit(){return this._structArray.uint8[this._pos1+76]}get elevationFeatureIndex(){return this._structArray.uint16[this._pos2+39]}}yf.prototype.size=80;class vf extends Rh{get(e){return new yf(this,e)}}bt(vf,"SymbolInstanceArray");class kh extends mo{getoffsetX(e){return this.float32[1*e+0]}}bt(kh,"GlyphOffsetArray");class xf extends Ns{getx(e){return this.int16[2*e+0]}gety(e){return this.int16[2*e+1]}}bt(xf,"SymbolLineVertexArray");class bf extends Vl{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}bf.prototype.size=12;class wf extends Dh{get(e){return new bf(this,e)}}bt(wf,"FeatureIndexArray");class Tf extends go{geta_centroid_pos0(e){return this.uint16[2*e+0]}geta_centroid_pos1(e){return this.uint16[2*e+1]}}bt(Tf,"FillExtrusionCentroidArray");class Sf extends Vl{get a_join_normal_inside0(){return this._structArray.int16[this._pos2+0]}get a_join_normal_inside1(){return this._structArray.int16[this._pos2+1]}get a_join_normal_inside2(){return this._structArray.int16[this._pos2+2]}}Sf.prototype.size=6;class Ef extends Ul{get(e){return new Sf(this,e)}}bt(Ef,"FillExtrusionWallArray");const pm=bi([{name:"a_pos",components:2,type:"Int16"}],4),mm=bi([{name:"a_circle_z_offset",components:1,type:"Float32"}],4),au=bi([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class Tr{constructor(e=[]){this.segments=e}_prepareSegment(e,i,s,a){let u=this.segments[this.segments.length-1];return e>Tr.MAX_VERTEX_ARRAY_LENGTH&&ei(`Max vertices per segment is ${Tr.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${e}`),(!u||u.vertexLength+e>Tr.MAX_VERTEX_ARRAY_LENGTH||u.sortKey!==a)&&(u={vertexOffset:i,primitiveOffset:s,vertexLength:0,primitiveLength:0},a!==void 0&&(u.sortKey=a),this.segments.push(u)),u}prepareSegment(e,i,s,a){return this._prepareSegment(e,i.length,s.length,a)}get(){return this.segments}destroy(){for(const e of this.segments)for(const i in e.vaos)e.vaos[i].destroy()}static simpleSegment(e,i,s,a){return new Tr([{vertexOffset:e,primitiveOffset:i,vertexLength:s,primitiveLength:a,vaos:{},sortKey:0}])}}function If(r,e){return 256*(r=Q(Math.floor(r),0,255))+Q(Math.floor(e),0,255)}Tr.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,bt(Tr,"SegmentVector");const lu=bi([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),Fh=bi([{name:"a_pattern_b",components:4,type:"Uint16"}]),Af=bi([{name:"a_dash",components:4,type:"Uint16"}]);class Wl{constructor(){this.ids=[],this.uniqueIds=[],this.positions=[],this.indexed=!1}add(e,i,s,a){this.ids.push(Bh(e)),this.positions.push(i,s,a)}eachPosition(e,i){const s=Bh(e);let a=0,u=this.ids.length-1;for(;a<u;){const h=a+u>>1;this.ids[h]>=s?u=h:a=h+1}for(;this.ids[a]===s;)i(this.positions[3*a],this.positions[3*a+1],this.positions[3*a+2]),a++}static serialize(e,i){const s=new Float64Array(e.ids),a=new Uint32Array(e.positions);return cu(s,a,0,s.length-1),i&&(i.add(s.buffer),i.add(a.buffer)),{ids:s,positions:a}}static deserialize(e){const i=new Wl;let s;i.ids=e.ids,i.positions=e.positions;for(const a of i.ids)a!==s&&i.uniqueIds.push(a),s=a;return i.indexed=!0,i}}function Bh(r){const e=+r;return!isNaN(e)&&Number.MIN_SAFE_INTEGER<=e&&e<=Number.MAX_SAFE_INTEGER?e:_l(String(r))}function cu(r,e,i,s){for(;i<s;){const a=r[i+s>>1];let u=i-1,h=s+1;for(;;){do u++;while(r[u]<a);do h--;while(r[h]>a);if(u>=h)break;Xl(r,u,h),Xl(e,3*u,3*h),Xl(e,3*u+1,3*h+1),Xl(e,3*u+2,3*h+2)}h-i<s-h?(cu(r,e,i,h),i=h+1):(cu(r,e,h+1,s),s=h)}}function Xl(r,e,i){const s=r[e];r[e]=r[i],r[i]=s}bt(Wl,"FeaturePositionMap");class Vs{constructor(e){this.gl=e.gl,this.initialized=!1}fetchUniformLocation(e,i){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(e,i),this.initialized=!0),!!this.location}set(e,i,s){throw new Error("Uniform#set() must be implemented by each concrete Uniform")}}class uu extends Vs{constructor(e){super(e),this.current=0}set(e,i,s){this.fetchUniformLocation(e,i)&&this.current!==s&&(this.current=s,this.gl.uniform1i(this.location,s))}}class kr extends Vs{constructor(e){super(e),this.current=0}set(e,i,s){this.fetchUniformLocation(e,i)&&this.current!==s&&(this.current=s,this.gl.uniform1f(this.location,s))}}class vs extends Vs{constructor(e){super(e),this.current=[0,0]}set(e,i,s){this.fetchUniformLocation(e,i)&&(s[0]===this.current[0]&&s[1]===this.current[1]||(this.current=s,this.gl.uniform2f(this.location,s[0],s[1])))}}class Yl extends Vs{constructor(e){super(e),this.current=[0,0,0]}set(e,i,s){this.fetchUniformLocation(e,i)&&(s[0]===this.current[0]&&s[1]===this.current[1]&&s[2]===this.current[2]||(this.current=s,this.gl.uniform3f(this.location,s[0],s[1],s[2])))}}class hu extends Vs{constructor(e){super(e),this.current=[0,0,0,0]}set(e,i,s){this.fetchUniformLocation(e,i)&&(s[0]===this.current[0]&&s[1]===this.current[1]&&s[2]===this.current[2]&&s[3]===this.current[3]||(this.current=s,this.gl.uniform4f(this.location,s[0],s[1],s[2],s[3])))}}class Cf extends Vs{constructor(e){super(e),this.current=Pi.transparent.toPremultipliedRenderColor(null)}set(e,i,s){this.fetchUniformLocation(e,i)&&(s.r===this.current.r&&s.g===this.current.g&&s.b===this.current.b&&s.a===this.current.a||(this.current=s,this.gl.uniform4f(this.location,s.r,s.g,s.b,s.a)))}}const _m=new Float32Array(16);class Ua extends Vs{constructor(e){super(e),this.current=_m}set(e,i,s){if(this.fetchUniformLocation(e,i)){if(s[12]!==this.current[12]||s[0]!==this.current[0])return this.current=s,void this.gl.uniformMatrix4fv(this.location,!1,s);for(let a=1;a<16;a++)if(s[a]!==this.current[a]){this.current=s,this.gl.uniformMatrix4fv(this.location,!1,s);break}}}}const Nh=new Float32Array(9),xs=new Float32Array(4);class Kl extends Vs{constructor(e){super(e),this.current=xs}set(e,i,s){if(this.fetchUniformLocation(e,i)){for(let a=0;a<4;a++)if(s[a]!==this.current[a]){this.current=s,this.gl.uniformMatrix2fv(this.location,!1,s);break}}}}function Vh(r){return[If(255*r.r,255*r.g),If(255*r.b,255*r.a)]}class Jl{constructor(e,i,s,a){this.value=e,this.uniformNames=i.map(u=>`u_${u}`),this.type=s,this.context=a}setUniform(e,i,s,a,u){const h=a.constantOr(this.value);i.set(e,u,h instanceof Pi?h.toPremultipliedRenderColor(this.lutExpression&&this.lutExpression.value==="none"?null:this.context.lut):h)}getBinding(e,i){return this.type==="color"?new Cf(e):new kr(e)}}class ja{constructor(e,i){this.uniformNames=i.map(s=>`u_${s}`),this.pattern=null,this.patternTransition=null,this.pixelRatio=1}setConstantPatternPositions(e,i){this.pixelRatio=e.pixelRatio||1,this.pattern=e.tl.concat(e.br),this.patternTransition=i?i.tl.concat(i.br):this.pattern}setUniform(e,i,s,a,u){let h=null;u!=="u_pattern"&&u!=="u_dash"||(h=this.pattern),u==="u_pattern_b"&&(h=this.patternTransition),u==="u_pixel_ratio"&&(h=this.pixelRatio),h&&i.set(e,u,h)}getBinding(e,i){return i==="u_pattern"||i==="u_pattern_b"||i==="u_dash"?new hu(e):new kr(e)}}class Us{constructor(e,i,s,a){this.expression=e,this.type=s,this.maxValue=0,this.paintVertexAttributes=i.map(u=>({name:`a_${u}`,type:"Float32",components:s==="color"?2:1,offset:0})),this.paintVertexArray=new a}populatePaintArray(e,i,s,a,u,h,p,_){const g=this.paintVertexArray.length,x=this.expression.kind==="composite"||this.expression.kind==="source"?this.expression.evaluate(new Gi(0,{brightness:h,worldview:_}),i,{},u,a,p):this.expression.kind==="constant"&&this.expression.value,b=!!this.lutExpression&&(this.lutExpression.kind==="composite"||this.lutExpression.kind==="source"?this.lutExpression.evaluate(new Gi(0,{brightness:h,worldview:_}),i,{},u,a,p):this.lutExpression.value)==="none";this.paintVertexArray.resize(e),this._setPaintValue(g,e,x,b?null:this.context.lut)}updatePaintArray(e,i,s,a,u,h,p,_){const g=this.expression.kind==="composite"||this.expression.kind==="source"?this.expression.evaluate({zoom:0,brightness:p,worldview:_},s,a,void 0,u):this.expression.kind==="constant"&&this.expression.value,x=!!this.lutExpression&&(this.lutExpression.kind==="composite"||this.lutExpression.kind==="source"?this.lutExpression.evaluate(new Gi(0,{brightness:p,worldview:_}),s,a,void 0,u):this.lutExpression.value)==="none";this._setPaintValue(e,i,g,x?null:this.context.lut)}_setPaintValue(e,i,s,a){if(this.type==="color"){const u=Vh(s.toPremultipliedRenderColor(a));for(let h=e;h<i;h++)this.paintVertexArray.emplace(h,u[0],u[1])}else{for(let u=e;u<i;u++)this.paintVertexArray.emplace(u,s);this.maxValue=Math.max(this.maxValue,Math.abs(s))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.lutExpression&&this.lutExpression.kind!=="constant"&&(this.lutExpression.isStateDependent||!this.lutExpression.isLightConstant)||this.expression.kind!=="constant"&&(this.expression.isStateDependent||!this.expression.isLightConstant)))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class cs{constructor(e,i,s,a,u,h){this.expression=e,this.uniformNames=i.map(p=>`u_${p}_t`),this.type=s,this.useIntegerZoom=a,this.context=u,this.maxValue=0,this.paintVertexAttributes=i.map(p=>({name:`a_${p}`,type:"Float32",components:s==="color"?4:2,offset:0})),this.paintVertexArray=new h}populatePaintArray(e,i,s,a,u,h,p,_){const g=this.expression.evaluate(new Gi(this.context.zoom,{brightness:h,worldview:_}),i,{},u,a,p),x=this.expression.evaluate(new Gi(this.context.zoom+1,{brightness:h,worldview:_}),i,{},u,a,p),b=!!this.lutExpression&&(this.lutExpression.kind==="composite"||this.lutExpression.kind==="source"?this.lutExpression.evaluate(new Gi(0,{brightness:h,worldview:_}),i,{},u,a,p):this.lutExpression.value)==="none",w=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValue(w,e,g,x,b?null:this.context.lut)}updatePaintArray(e,i,s,a,u,h,p,_){const g=this.expression.evaluate({zoom:this.context.zoom,brightness:p,worldview:_},s,a,void 0,u),x=this.expression.evaluate({zoom:this.context.zoom+1,brightness:p,worldview:_},s,a,void 0,u),b=!!this.lutExpression&&(this.lutExpression.kind==="composite"||this.lutExpression.kind==="source"?this.lutExpression.evaluate(new Gi(0,{brightness:p,worldview:_}),s,a,void 0,u):this.lutExpression.value)==="none";this._setPaintValue(e,i,g,x,b?null:this.context.lut)}_setPaintValue(e,i,s,a,u){if(this.type==="color"){const h=Vh(s.toPremultipliedRenderColor(u)),p=Vh(s.toPremultipliedRenderColor(u));for(let _=e;_<i;_++)this.paintVertexArray.emplace(_,h[0],h[1],p[0],p[1])}else{for(let h=e;h<i;h++)this.paintVertexArray.emplace(h,s,a);this.maxValue=Math.max(this.maxValue,Math.abs(s),Math.abs(a))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(e,i,s,a,u){const h=this.useIntegerZoom?Math.floor(s.zoom):s.zoom,p=Q(this.expression.interpolationFactor(h,this.context.zoom,this.context.zoom+1),0,1);i.set(e,u,p)}getBinding(e,i){return new kr(e)}}class es{constructor(e,i,s,a,u){this.expression=e,this.layerId=u,this.paintVertexAttributes=(s==="array"?Af:lu).members;for(let h=0;h<i.length;++h);this.paintVertexArray=new a,this.paintTransitionVertexArray=new jl}populatePaintArray(e,i,s,a){const u=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValues(u,e,i.patterns&&i.patterns[this.layerId],s)}updatePaintArray(e,i,s,a,u,h,p){this._setPaintValues(e,i,s.patterns&&s.patterns[this.layerId],h)}_setPaintValues(e,i,s,a){if(!a||!s)return;const u=a[s[0]],h=a[s[1]];if(u){if(u){const{tl:p,br:_,pixelRatio:g}=u;for(let x=e;x<i;x++)this.paintVertexArray.emplace(x,p[0],p[1],_[0],_[1],g)}if(h){this.paintTransitionVertexArray.resize(this.paintVertexArray.length);const{tl:p,br:_}=h;for(let g=e;g<i;g++)this.paintTransitionVertexArray.emplace(g,p[0],p[1],_[0],_[1])}}}upload(e){const i=this.expression.isStateDependent||!this.expression.isLightConstant;this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,i)),this.paintTransitionVertexArray&&this.paintTransitionVertexArray.length&&(this.paintTransitionVertexBuffer=e.createVertexBuffer(this.paintTransitionVertexArray,Fh.members,i))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy(),this.paintTransitionVertexBuffer&&this.paintTransitionVertexBuffer.destroy()}}class Ga{constructor(e,i,s=()=>!0){this.binders={},this._buffers=[],this.context=i;const a=[];for(const u in e.paint._values){const h=e.paint.get(u);if(u.endsWith("-use-theme")||!s(u)||!(h instanceof La&&zl(h.property.specification)))continue;const p=n(u,e.type),_=h.value,g=h.property.specification.type,x=!!h.property.useIntegerZoom,b=u==="line-dasharray"||u.endsWith("pattern"),w=e.paint.get(`${u}-use-theme`),E=u==="line-dasharray"&&e.layout.get("line-cap").value.kind!=="constant"||w&&w.value.kind!=="constant";if(_.kind!=="constant"||E)if(_.kind==="source"||E||b){const A=f(u,g,"source");this.binders[u]=b?new es(_,p,g,A,e.id):new Us(_,p,g,A),a.push(`/a_${u}`)}else{const A=f(u,g,"composite");this.binders[u]=new cs(_,p,g,x,i,A),a.push(`/z_${u}`)}else this.binders[u]=b?new ja(_.value,p):new Jl(_.value,p,g,i),a.push(`/u_${u}`);w&&(this.binders[u].lutExpression=w.value)}this.cacheKey=a.sort().join("")}getMaxValue(e){const i=this.binders[e];return i instanceof Us||i instanceof cs?i.maxValue:0}populatePaintArrays(e,i,s,a,u,h,p,_){for(const g in this.binders){const x=this.binders[g];x.context=this.context,(x instanceof Us||x instanceof cs||x instanceof es)&&x.populatePaintArray(e,i,s,a,u,h,p,_)}}setConstantPatternPositions(e,i){for(const s in this.binders){const a=this.binders[s];a instanceof ja&&a.setConstantPatternPositions(e,i)}}getPatternTransitionVertexBuffer(e){const i=this.binders[e];return i instanceof es?i.paintTransitionVertexBuffer:null}updatePaintArrays(e,i,s,a,u,h,p,_,g,x){let b=!1;const w=Object.keys(e),E=w.length!==0&&!_,A=E?w:i.uniqueIds;this.context.lut=u.lut;for(const P in this.binders){const L=this.binders[P];if(L.context=this.context,(L instanceof Us||L instanceof cs||L instanceof es)&&L.expression&&L.expression.kind&&L.expression.kind!=="constant"&&(L.expression.isStateDependent===!0||L.expression.isLightConstant===!1)){const k=u.paint.get(P);L.expression=k.value;for(const j of A){const G=e[j.toString()];i.eachPosition(j,(R,N,q)=>{const Z=a.feature(R);L.updatePaintArray(N,q,Z,G,h,p,g,x)})}if(!E)for(const j of s.uniqueIds){const G=e[j.toString()];s.eachPosition(j,(R,N,q)=>{const Z=a.feature(R);L.updatePaintArray(N,q,Z,G,h,p,g,x)})}b=!0}}return b}defines(){const e=[];for(const i in this.binders){const s=this.binders[i];(s instanceof Jl||s instanceof ja)&&e.push(...s.uniformNames.map(a=>`#define HAS_UNIFORM_${a}`))}return e}getBinderAttributes(){const e=[];for(const i in this.binders){const s=this.binders[i];if(s instanceof Us||s instanceof cs||s instanceof es)for(let a=0;a<s.paintVertexAttributes.length;a++)e.push(s.paintVertexAttributes[a].name);if(s instanceof es)for(let a=0;a<Fh.members.length;a++)e.push(Fh.members[a].name)}return e}getBinderUniforms(){const e=[];for(const i in this.binders){const s=this.binders[i];if(s instanceof Jl||s instanceof ja||s instanceof cs)for(const a of s.uniformNames)e.push(a)}return e}getPaintVertexBuffers(){return this._buffers}getUniforms(e){const i=[];for(const s in this.binders){const a=this.binders[s];if(a instanceof Jl||a instanceof ja||a instanceof cs)for(const u of a.uniformNames)i.push({name:u,property:s,binding:a.getBinding(e,u)})}return i}setUniforms(e,i,s,a,u){for(const{name:h,property:p,binding:_}of s)this.binders[p].setUniform(e,_,u,a.get(p),h)}updatePaintBuffers(){this._buffers=[];for(const e in this.binders){const i=this.binders[e];(i instanceof Us||i instanceof cs||i instanceof es)&&i.paintVertexBuffer&&this._buffers.push(i.paintVertexBuffer),i instanceof es&&i.paintTransitionVertexBuffer&&this._buffers.push(i.paintTransitionVertexBuffer)}}upload(e){for(const i in this.binders){const s=this.binders[i];(s instanceof Us||s instanceof cs||s instanceof es)&&s.upload(e)}this.updatePaintBuffers()}destroy(){for(const e in this.binders){const i=this.binders[e];(i instanceof Us||i instanceof cs||i instanceof es)&&i.destroy()}}}class l{constructor(e,i,s=()=>!0){this.programConfigurations={};for(const a of e)this.programConfigurations[a.id]=new Ga(a,i,s);this.needsUpload=!1,this._featureMap=new Wl,this._featureMapWithoutIds=new Wl,this._bufferOffset=0,this._idlessCounter=0}populatePaintArrays(e,i,s,a,u,h,p,_,g){for(const x in this.programConfigurations)this.programConfigurations[x].populatePaintArrays(e,i,a,u,h,p,_,g);i.id!==void 0?this._featureMap.add(i.id,s,this._bufferOffset,e):(this._featureMapWithoutIds.add(this._idlessCounter,s,this._bufferOffset,e),this._idlessCounter+=1),this._bufferOffset=e,this.needsUpload=!0}updatePaintArrays(e,i,s,a,u,h,p,_){for(const g of s)this.needsUpload=this.programConfigurations[g.id].updatePaintArrays(e,this._featureMap,this._featureMapWithoutIds,i,g,a,u,h,p||0,_)||this.needsUpload}get(e){return this.programConfigurations[e]}upload(e){if(this.needsUpload){for(const i in this.programConfigurations)this.programConfigurations[i].upload(e);this.needsUpload=!1}}destroy(){for(const e in this.programConfigurations)this.programConfigurations[e].destroy()}}const t={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-occlusion-opacity":["occlusion_opacity"],"icon-occlusion-opacity":["occlusion_opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-emissive-strength":["emissive_strength"],"icon-emissive-strength":["emissive_strength"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"symbol-z-offset":["z_offset"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio","pattern_b"],"fill-pattern":["pattern","pixel_ratio","pattern_b"],"fill-extrusion-pattern":["pattern","pixel_ratio","pattern_b"],"line-dasharray":["dash"],"fill-bridge-guard-rail-color":["structure_color"],"fill-tunnel-structure-color":["structure_color"]};function n(r,e){return t[r]||[r.replace(`${e}-`,"").replace(/-/g,"_")]}const c={"line-pattern":{source:_o,composite:_o},"fill-pattern":{source:_o,composite:_o},"fill-extrusion-pattern":{source:_o,composite:_o},"line-dasharray":{source:jl,composite:jl}},d={color:{source:ea,composite:Qr},number:{source:mo,composite:ea}};function f(r,e,i){const s=c[r];return s&&s[i]||d[e][i]}bt(Jl,"ConstantBinder"),bt(ja,"PatternConstantBinder"),bt(Us,"SourceExpressionBinder"),bt(es,"PatternCompositeBinder"),bt(cs,"CompositeExpressionBinder"),bt(Ga,"ProgramConfiguration",{omit:["_buffers"]}),bt(l,"ProgramConfigurationSet");const m=dt/Math.PI/2,y=5,v=6,T=16383,S=64,C=[S,32,16],I=-m,M=m;function D(r,e,i,s=m){return i=wi(i),[r*Math.sin(i)*s,-e*s,r*Math.cos(i)*s]}function z(r,e,i){return D(Math.cos(wi(r)),Math.sin(wi(r)),e,i)}const O=63710088e-1,B=2*Math.PI*O;class V{constructor(e,i){if(isNaN(e)||isNaN(i))throw new Error(`Invalid LngLat object: (${e}, ${i})`);if(this.lng=+e,this.lat=+i,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new V(xe(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(e){const i=Math.PI/180,s=this.lat*i,a=e.lat*i,u=Math.sin(s)*Math.sin(a)+Math.cos(s)*Math.cos(a)*Math.cos((e.lng-this.lng)*i);return O*Math.acos(Math.min(u,1))}toBounds(e=0){const i=360*e/40075017,s=i/Math.cos(Math.PI/180*this.lat);return new H({lng:this.lng-s,lat:this.lat-i},{lng:this.lng+s,lat:this.lat+i})}toEcef(e){return z(this.lat,this.lng,m+e*m/O)}static convert(e){if(e instanceof V)return e;if(Array.isArray(e)&&(e.length===2||e.length===3))return new V(Number(e[0]),Number(e[1]));if(!Array.isArray(e)&&typeof e=="object"&&e!==null)return new V(Number("lng"in e?e.lng:e.lon),Number(e.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}class H{constructor(e,i){if(e)if(i)this.setSouthWest(e).setNorthEast(i);else if(e.length===4){const s=e;this.setSouthWest([s[0],s[1]]).setNorthEast([s[2],s[3]])}else{const s=e;this.setSouthWest(s[0]).setNorthEast(s[1])}}setNorthEast(e){return this._ne=e instanceof V?new V(e.lng,e.lat):V.convert(e),this}setSouthWest(e){return this._sw=e instanceof V?new V(e.lng,e.lat):V.convert(e),this}extend(e){const i=this._sw,s=this._ne;let a,u;if(e instanceof V)a=e,u=e;else{if(!(e instanceof H))return Array.isArray(e)?e.length===4||e.every(Array.isArray)?this.extend(H.convert(e)):this.extend(V.convert(e)):typeof e=="object"&&e!==null&&e.hasOwnProperty("lat")&&(e.hasOwnProperty("lon")||e.hasOwnProperty("lng"))?this.extend(V.convert(e)):this;if(a=e._sw,u=e._ne,!a||!u)return this}return i||s?(i.lng=Math.min(a.lng,i.lng),i.lat=Math.min(a.lat,i.lat),s.lng=Math.max(u.lng,s.lng),s.lat=Math.max(u.lat,s.lat)):(this._sw=new V(a.lng,a.lat),this._ne=new V(u.lng,u.lat)),this}getCenter(){return new V((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new V(this.getWest(),this.getNorth())}getSouthEast(){return new V(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(e){const{lng:i,lat:s}=V.convert(e);let a=this._sw.lng<=i&&i<=this._ne.lng;return this._sw.lng>this._ne.lng&&(a=this._sw.lng>=i&&i>=this._ne.lng),this._sw.lat<=s&&s<=this._ne.lat&&a}static convert(e){if(e)return e instanceof H?e:new H(e)}}const Y=0,te=25.5;function ee(r){return B*Math.cos(r*Math.PI/180)}function J(r){return(180+r)/360}function K(r){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+r*Math.PI/360)))/360}function ie(r,e){return r/ee(e)}function se(r){return 360*r-180}function ye(r){return 360/Math.PI*Math.atan(Math.exp((180-360*r)*Math.PI/180))-90}function ve(r,e){return r*ee(ye(e))}const Oe=85.051129;function ke(r){return Math.cos(wi(Q(r,-85.051129,Oe)))}function Ze(r,e){const i=Q(e,Y,te),s=Math.pow(2,i);return ke(r)*B/(512*s)}function _e(r){return 1/Math.cos(r*Math.PI/180)}function Pe(r,e=0){const i=Math.exp(Math.PI*(1-(r.y+e/dt)/(1<<r.z)*2));return 80150034*i/(i*i+1)/dt/(1<<r.z)}class ue{constructor(e,i,s=0){this.x=+e,this.y=+i,this.z=+s}static fromLngLat(e,i=0){const s=V.convert(e);return new ue(J(s.lng),K(s.lat),ie(i,s.lat))}toLngLat(){return new V(se(this.x),ye(this.y))}toAltitude(){return ve(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/B*_e(ye(this.y))}}function Ne(r,e,i,s,a,u,h,p,_){const g=(e+s)/2,x=(i+a)/2,b=new ut(g,x);p(b),function(w,E,A,P,L,k){const j=A-L,G=P-k;return Math.abs((P-E)*j-(A-w)*G)/Math.hypot(j,G)}(b.x,b.y,u.x,u.y,h.x,h.y)>=_?(Ne(r,e,i,g,x,u,b,p,_),Ne(r,g,x,s,a,b,h,p,_)):r.push(h)}function Se(r,e,i){let s=r[0],a=s.x,u=s.y;e(s);const h=[s];for(let p=1;p<r.length;p++){const _=r[p],{x:g,y:x}=_;e(_),Ne(h,a,u,g,x,s,_,e,i),a=g,u=x,s=_}return h}function qe(r,e,i,s){if(s(e,i)){const a=e.add(i)._mult(.5);qe(r,e,a,s),qe(r,a,i,s)}else r.push(i)}function rt(r,e){let i=r[0];const s=[i];for(let a=1;a<r.length;a++){const u=r[a];qe(s,i,u,e),i=u}return s}const Fe=Math.pow(2,14)-1,tt=-Fe-1;function wt(r,e){const i=Math.round(r.x*e),s=Math.round(r.y*e);return r.x=Q(i,tt,Fe),r.y=Q(s,tt,Fe),(i<r.x||i>r.x+1||s<r.y||s>r.y+1)&&ei("Geometry exceeds allowed extent, reduce your vector tile buffer size"),r}function Tt(r,e,i){const s=r.loadGeometry(),a=r.extent,u=dt/a;if(e&&i&&i.projection.isReprojectedInTileSpace){const h=1<<e.z,{scale:p,x:_,y:g,projection:x}=i,b=w=>{const E=se((e.x+w.x/a)/h),A=ye((e.y+w.y/a)/h),P=x.project(E,A);w.x=(P.x*p-_)*a,w.y=(P.y*p-g)*a};for(let w=0;w<s.length;w++)if(r.type!==1)s[w]=Se(s[w],b,1);else{const E=[];for(const A of s[w])A.x<0||A.x>=a||A.y<0||A.y>=a||(b(A),E.push(A));s[w]=E}}for(const h of s)for(const p of h)wt(p,u);return s}function gt(r,e){return{type:r.type,id:r.id,properties:r.properties,geometry:e?Tt(r):[]}}var Rt,Dt,kt,$t,ti,zi,Ji,Fi={};function Vi(){if(Dt)return Rt;Dt=1;var r=Ro();function e(a,u,h,p,_){this.properties={},this.extent=h,this.type=0,this._pbf=a,this._geometry=-1,this._keys=p,this._values=_,a.readFields(i,this,u)}function i(a,u,h){a==1?u.id=h.readVarint():a==2?function(p,_){for(var g=p.readVarint()+p.pos;p.pos<g;){var x=_._keys[p.readVarint()],b=_._values[p.readVarint()];_.properties[x]=b}}(h,u):a==3?u.type=h.readVarint():a==4&&(u._geometry=h.pos)}function s(a){for(var u,h,p=0,_=0,g=a.length,x=g-1;_<g;x=_++)p+=((h=a[x]).x-(u=a[_]).x)*(u.y+h.y);return p}return Rt=e,e.types=["Unknown","Point","LineString","Polygon"],e.prototype.loadGeometry=function(){var a=this._pbf;a.pos=this._geometry;for(var u,h=a.readVarint()+a.pos,p=1,_=0,g=0,x=0,b=[];a.pos<h;){if(_<=0){var w=a.readVarint();p=7&w,_=w>>3}if(_--,p===1||p===2)g+=a.readSVarint(),x+=a.readSVarint(),p===1&&(u&&b.push(u),u=[]),u.push(new r(g,x));else{if(p!==7)throw new Error("unknown command "+p);u&&u.push(u[0].clone())}}return u&&b.push(u),b},e.prototype.bbox=function(){var a=this._pbf;a.pos=this._geometry;for(var u=a.readVarint()+a.pos,h=1,p=0,_=0,g=0,x=1/0,b=-1/0,w=1/0,E=-1/0;a.pos<u;){if(p<=0){var A=a.readVarint();h=7&A,p=A>>3}if(p--,h===1||h===2)(_+=a.readSVarint())<x&&(x=_),_>b&&(b=_),(g+=a.readSVarint())<w&&(w=g),g>E&&(E=g);else if(h!==7)throw new Error("unknown command "+h)}return[x,w,b,E]},e.prototype.toGeoJSON=function(a,u,h){var p,_,g=this.extent*Math.pow(2,h),x=this.extent*a,b=this.extent*u,w=this.loadGeometry(),E=e.types[this.type];function A(k){for(var j=0;j<k.length;j++){var G=k[j];k[j]=[360*(G.x+x)/g-180,360/Math.PI*Math.atan(Math.exp((180-360*(G.y+b)/g)*Math.PI/180))-90]}}switch(this.type){case 1:var P=[];for(p=0;p<w.length;p++)P[p]=w[p][0];A(w=P);break;case 2:for(p=0;p<w.length;p++)A(w[p]);break;case 3:for(w=function(k){var j=k.length;if(j<=1)return[k];for(var G,R,N=[],q=0;q<j;q++){var Z=s(k[q]);Z!==0&&(R===void 0&&(R=Z<0),R===Z<0?(G&&N.push(G),G=[k[q]]):G.push(k[q]))}return G&&N.push(G),N}(w),p=0;p<w.length;p++)for(_=0;_<w[p].length;_++)A(w[p][_])}w.length===1?w=w[0]:E="Multi"+E;var L={type:"Feature",geometry:{type:E,coordinates:w},properties:this.properties};return"id"in this&&(L.id=this.id),L},Rt}function Mr(){if($t)return kt;$t=1;var r=Vi();function e(s,a){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=s,this._keys=[],this._values=[],this._features=[],s.readFields(i,this,a),this.length=this._features.length}function i(s,a,u){s===15?a.version=u.readVarint():s===1?a.name=u.readString():s===5?a.extent=u.readVarint():s===2?a._features.push(u.pos):s===3?a._keys.push(u.readString()):s===4&&a._values.push(function(h){for(var p=null,_=h.readVarint()+h.pos;h.pos<_;){var g=h.readVarint()>>3;p=g===1?h.readString():g===2?h.readFloat():g===3?h.readDouble():g===4?h.readVarint64():g===5?h.readVarint():g===6?h.readSVarint():g===7?h.readBoolean():null}return p}(u))}return kt=e,e.prototype.feature=function(s){if(s<0||s>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[s];var a=this._pbf.readVarint()+this._pbf.pos;return new r(this._pbf,a,this.extent,this._keys,this._values)},kt}function Kt(){return Ji||(Ji=1,Fi.VectorTile=function(){if(zi)return ti;zi=1;var r=Mr();function e(i,s,a){if(i===3){var u=new r(a,a.readVarint()+a.pos);u.length&&(s[u.name]=u)}}return ti=function(i,s){this.layers=i.readFields(e,{},s)},ti}(),Fi.VectorTileFeature=Vi(),Fi.VectorTileLayer=Mr()),Fi}var ni=Kt();const ui="3d_elevation_id",nr="level";class Vr{constructor(){this._valid=!1}reset(e){return this.feature=e,this._valid=!0,this._geometry=e.loadGeometry(),this._geometry.length!==0&&this._geometry[0].length!==0||(this._valid=!1),this}geometry(e,i){return this._valid&&e(i(this._geometry)),this}require(e,i,s){return this.get(e,!0,i,s)}optional(e,i,s){return this.get(e,!1,i,s)}success(){return this._valid}get(e,i,s,a){const u=this.feature.properties.hasOwnProperty(e)?+this.feature.properties[e]:void 0;return this._valid&&u!==void 0&&!Number.isNaN(u)?s(a?a(u):u):i&&(this._valid=!1),this}}class Qi{constructor(e,i){this.featureFunc=e,this.vertexFunc=i}parseFeature(e,i,s){return this.featureFunc(e,i,s)}parseVertex(e,i,s){return this.vertexFunc(e,i,s)}}const Ai=new Qi((r,e,i)=>r.reset(e).require(ui,s=>{i.id=s}).optional("fixed_height_relative",s=>{i.constantHeight=s},mi.decodeRelativeHeight).geometry(s=>{i.bounds=s},Zu).success(),(r,e,i)=>r.reset(e).require(ui,s=>{i.id=s}).require("elevation_idx",s=>{i.idx=s}).require("extent",s=>{i.extent=s}).require("height_relative",s=>{i.height=s},mi.decodeRelativeHeight).geometry(s=>{i.position=s},mi.getPoint).success()),wr=new Qi((r,e,i)=>r.reset(e).require(ui,s=>{i.id=s}).optional("fixed_height",s=>{i.constantHeight=s},mi.decodeMetricHeight).geometry(s=>{i.bounds=s},Zu).success(),(r,e,i)=>r.reset(e).require(ui,s=>{i.id=s}).require("elevation_idx",s=>{i.idx=s}).require("extent",s=>{i.extent=s}).require("height",s=>{i.height=s},mi.decodeMetricHeight).geometry(s=>{i.position=s},mi.getPoint).success());class mi{static getPoint(e){return Wn(e[0][0].x,e[0][0].y)}static decodeRelativeHeight(e){return 1e-4*e*5}static decodeMetricHeight(e){return 1e-4*e}static parse(e){const i=[],s=[],a=e.length,u=new Vr;for(let p=0;p<a;p++){const _=e.feature(p),g=_.properties.hasOwnProperty("version")?String(_.properties.version):void 0,x=(h=g)?h==="1.0.1"?wr:void 0:Ai;if(x===void 0){ei(`Unknown elevation feature version number ${g||"(unknown)"}`);continue}const b=_.properties.hasOwnProperty("type")?_.properties.type:void 0;if(b){if(ni.VectorTileFeature.types[_.type]==="Point"&&b==="curve_point"){const w={};x.parseVertex(u,_,w)&&i.push(w)}else if(ni.VectorTileFeature.types[_.type]==="Polygon"&&b==="curve_meta"){const w={};x.parseFeature(u,_,w)&&s.push(w)}}}var h;return{vertices:i,features:s}}}class Fr{constructor(e,i){this.pos=e,this.dir=i}intersectsPlane(e,i,s){const a=pr(i,this.dir);if(Math.abs(a)<1e-6)return!1;const u=((e[0]-this.pos[0])*i[0]+(e[1]-this.pos[1])*i[1])/a;return s[0]=this.pos[0]+this.dir[0]*u,s[1]=this.pos[1]+this.dir[1]*u,!0}}class sr{constructor(e,i){this.pos=e,this.dir=i}intersectsPlane(e,i,s){const a=Ar(i,this.dir);if(Math.abs(a)<1e-6)return!1;const u=((e[0]-this.pos[0])*i[0]+(e[1]-this.pos[1])*i[1]+(e[2]-this.pos[2])*i[2])/a;return s[0]=this.pos[0]+this.dir[0]*u,s[1]=this.pos[1]+this.dir[1]*u,s[2]=this.pos[2]+this.dir[2]*u,!0}closestPointOnSphere(e,i,s){if(function(E,A){var P=E[0],L=E[1],k=E[2],j=A[0],G=A[1],R=A[2];return Math.abs(P-j)<=Ae*Math.max(1,Math.abs(P),Math.abs(j))&&Math.abs(L-G)<=Ae*Math.max(1,Math.abs(L),Math.abs(G))&&Math.abs(k-R)<=Ae*Math.max(1,Math.abs(k),Math.abs(R))}(this.pos,e)||i===0)return s[0]=s[1]=s[2]=0,!1;const[a,u,h]=this.dir,p=this.pos[0]-e[0],_=this.pos[1]-e[1],g=this.pos[2]-e[2],x=a*a+u*u+h*h,b=2*(p*a+_*u+g*h),w=b*b-4*x*(p*p+_*_+g*g-i*i);if(w<0){const E=Math.max(-b/2,0),A=p+a*E,P=_+u*E,L=g+h*E,k=Math.hypot(A,P,L);return s[0]=A*i/k,s[1]=P*i/k,s[2]=L*i/k,!1}{const E=(-b-Math.sqrt(w))/(2*x);if(E<0){const A=Math.hypot(p,_,g);return s[0]=p*i/A,s[1]=_*i/A,s[2]=g*i/A,!1}return s[0]=p+a*E,s[1]=_+u*E,s[2]=g+h*E,!0}}}class Wi{constructor(e,i,s,a,u){this.TL=e,this.TR=i,this.BR=s,this.BL=a,this.horizon=u}static fromInvProjectionMatrix(e,i,s){const a=[-1,1,1],u=[1,1,1],h=[1,-1,1],p=[-1,-1,1],_=ji(a,a,e),g=ji(u,u,e),x=ji(h,h,e),b=ji(p,p,e);return new Wi(_,g,x,b,i/s)}}function or(r,e,i){let s=1/0,a=-1/0;const u=[];for(const h of r){Br(u,h,e);const p=Ar(u,i);s=Math.min(s,p),a=Math.max(a,p)}return[s,a]}function Mi(r,e){let i=!0;for(let s=0;s<r.planes.length;s++){const a=r.planes[s];let u=0;for(let h=0;h<e.length;h++)u+=Ar(a,e[h])+a[3]>=0;if(u===0)return 0;u!==e.length&&(i=!1)}return i?2:1}function Sr(r,e){for(const i of r.projections){const s=or(e,r.points[0],i.axis);if(i.projection[1]<s[0]||i.projection[0]>s[1])return 0}return 1}function tn(r,e){let i=0;const s=[0,0,0,0];for(let h=0;h<r.length;h++)s[0]=r[h][0],s[1]=r[h][1],s[2]=r[h][2],s[3]=1,(a=s)[0]*(u=e)[0]+a[1]*u[1]+a[2]*u[2]+a[3]*u[3]>=0&&i++;var a,u;return i}class dr{constructor(e,i){this.points=e||new Array(8).fill([0,0,0]),this.planes=i||new Array(6).fill([0,0,0,0]),this.bounds=Ti.fromPoints(this.points),this.projections=[],this.frustumEdges=[Br([],this.points[2],this.points[3]),Br([],this.points[0],this.points[3]),Br([],this.points[4],this.points[0]),Br([],this.points[5],this.points[1]),Br([],this.points[6],this.points[2]),Br([],this.points[7],this.points[3])];for(const s of this.frustumEdges){const a=[0,-s[2],s[1]],u=[s[2],0,-s[0]];this.projections.push({axis:a,projection:or(this.points,this.points[0],a)}),this.projections.push({axis:u,projection:or(this.points,this.points[0],u)})}}static fromInvProjectionMatrix(e,i,s,a){const u=Math.pow(2,s),h=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(g=>{const x=_n([],g,e),b=1/x[3]/i*u;return(w=x)[0]=(E=x)[0]*(A=[b,b,a?1/x[3]:b,b])[0],w[1]=E[1]*A[1],w[2]=E[2]*A[2],w[3]=E[3]*A[3],w;var w,E,A}),p=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(g=>{const x=mr([],$i([],Br([],h[g[0]],h[g[1]]),Br([],h[g[2]],h[g[1]]))),b=-Ar(x,h[g[1]]);return x.concat(b)}),_=[];for(let g=0;g<h.length;g++)_.push([h[g][0],h[g][1],h[g][2]]);return new dr(_,p)}intersectsPrecise(e,i,s){for(let a=0;a<i.length;a++)if(!tn(e,i[a]))return 0;for(let a=0;a<this.planes.length;a++)if(!tn(e,this.planes[a]))return 0;for(const a of s)for(const u of this.frustumEdges){const h=$i([],a,u),p=Rr(h);if(p===0)continue;rr(h,h,1/p);const _=or(this.points,this.points[0],h),g=or(e,this.points[0],h);if(_[0]>g[1]||g[0]>_[1])return 0}return 1}containsPoint(e){for(const i of this.planes){const s=i[3];if(Ar([i[0],i[1],i[2]],e)+s<0)return!1}return!0}}class Ti{static fromPoints(e){const i=[1/0,1/0,1/0],s=[-1/0,-1/0,-1/0];for(const a of e)Vn(i,i,a),Un(s,s,a);return new Ti(i,s)}static fromTileIdAndHeight(e,i,s){const a=1<<e.canonical.z,u=e.canonical.x,h=e.canonical.y;return new Ti([u/a,h/a,i],[(u+1)/a,(h+1)/a,s])}static applyTransform(e,i){const s=e.getCorners();for(let a=0;a<s.length;++a)ji(s[a],s[a],i);return Ti.fromPoints(s)}static applyTransformFast(e,i){const s=[i[12],i[13],i[14]],a=[...s];for(let u=0;u<3;u++)for(let h=0;h<3;h++){const p=i[4*h+u],_=p*e.min[h],g=p*e.max[h];s[u]+=Math.min(_,g),a[u]+=Math.max(_,g)}return new Ti(s,a)}static projectAabbCorners(e,i){const s=e.getCorners();for(let a=0;a<s.length;++a)ji(s[a],s[a],i);return s}constructor(e,i){this.min=e,this.max=i,this.center=rr([],zr([],this.min,this.max),.5)}quadrant(e){const i=[e%2==0,e<2],s=Dr(this.min),a=Dr(this.max);for(let u=0;u<i.length;u++)s[u]=i[u]?this.min[u]:this.center[u],a[u]=i[u]?this.center[u]:this.max[u];return a[2]=this.max[2],new Ti(s,a)}distanceX(e){return Math.max(Math.min(this.max[0],e[0]),this.min[0])-e[0]}distanceY(e){return Math.max(Math.min(this.max[1],e[1]),this.min[1])-e[1]}distanceZ(e){return Math.max(Math.min(this.max[2],e[2]),this.min[2])-e[2]}getCorners(){const e=this.min,i=this.max;return[[e[0],e[1],e[2]],[i[0],e[1],e[2]],[i[0],i[1],e[2]],[e[0],i[1],e[2]],[e[0],e[1],i[2]],[i[0],e[1],i[2]],[i[0],i[1],i[2]],[e[0],i[1],i[2]]]}intersects(e){return this.intersectsAabb(e.bounds)?Mi(e,this.getCorners()):0}intersectsFlat(e){return this.intersectsAabb(e.bounds)?Mi(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsPrecise(e,i){return i||this.intersects(e)?Sr(e,this.getCorners()):0}intersectsPreciseFlat(e,i){return i||this.intersectsFlat(e)?Sr(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsAabb(e){for(let i=0;i<3;++i)if(this.min[i]>e.max[i]||e.min[i]>this.max[i])return!1;return!0}intersectsAabbXY(e){return!(this.min[0]>e.max[0]||e.min[0]>this.max[0]||this.min[1]>e.max[1]||e.min[1]>this.max[1])}encapsulate(e){for(let i=0;i<3;i++)this.min[i]=Math.min(this.min[i],e.min[i]),this.max[i]=Math.max(this.max[i],e.max[i])}encapsulatePoint(e){for(let i=0;i<3;i++)this.min[i]=Math.min(this.min[i],e[i]),this.max[i]=Math.max(this.max[i],e[i])}closestPoint(e){return[Math.max(Math.min(this.max[0],e[0]),this.min[0]),Math.max(Math.min(this.max[1],e[1]),this.min[1]),Math.max(Math.min(this.max[2],e[2]),this.min[2])]}}bt(Ti,"Aabb");class kn{constructor(e,i){this.feature=e,this.metersToTile=i,this.index=0}get(){const e=this.feature.vertices[this.index],i=this.feature.vertexProps[this.index].dir,s=i[1],a=-i[0],u=(e.extent+1)*this.metersToTile;return[new ut(Math.trunc(e.position[0]+s*u),Math.trunc(e.position[1]+a*u)),new ut(Math.trunc(e.position[0]-s*u),Math.trunc(e.position[1]-a*u))]}next(){this.index++}valid(){return this.index<this.feature.vertices.length}}class An{constructor(e,i,s,a,u,h){if(this.vertices=new Array,this.vertexProps=new Array,this.edges=new Array,this.edgeProps=new Array,this.id=e,this.heightRange={min:s,max:s},this.safeArea=i,this.constantHeight=s,this.constantHeight==null&&(this.constantHeight!=null||a.length!==0)){this.vertices=a,this.edges=u,this.edges=this.edges.filter(p=>{return p.a<this.vertices.length&&p.b<this.vertices.length&&!((_=this.vertices[p.a].position)[0]===(g=this.vertices[p.b].position)[0]&&_[1]===g[1]);var _,g}),this.heightRange={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY};for(const p of this.vertices)this.vertexProps.push({dir:Wn(0,0)}),this.heightRange.min=Math.min(this.heightRange.min,p.height),this.heightRange.max=Math.max(this.heightRange.max,p.height);for(const p of this.edges){const _=this.vertices[p.a].position,g=this.vertices[p.b].position,x=Js(an(),g,_),b=Qs(x),w=Po(an(),x,1/b);this.edgeProps.push({vec:x,dir:w,len:b});const E=this.vertexProps[p.a].dir,A=this.vertexProps[p.b].dir;Mo(E,E,w),Mo(A,A,w)}for(const p of this.vertexProps)p.dir[0]===0&&p.dir[1]===0||la(p.dir,p.dir);this.tessellate(h)}}pointElevation(e){if(this.constantHeight!=null)return this.constantHeight;const i=this.getClosestEdge(e);if(i==null)return 0;const[s,a]=i;return Ut(this.vertices[this.edges[s].a].height,this.vertices[this.edges[s].b].height,a)}computeSlopeNormal(e,i){const s=this.getClosestEdge(e);if(!s)return Ei(0,0,1);const a=s[0],u=this.edges[a],h=this.edgeProps[a].vec,p=Ei(h[0],h[1],(this.vertices[u.b].height-this.vertices[u.a].height)*i),_=Ei(p[1],-p[0],0);$i(_,_,p);const g=Rr(_);return g>0?rr(_,_,1/g):Ei(0,0,1)}getSafeArea(){return this.safeArea}isTunnel(){return this.heightRange.max<=-5}getClosestEdge(e){if(this.edges.length===0)return;let i=0,s=Number.POSITIVE_INFINITY,a=0;const u=Wn(e.x,e.y);for(let h=0;h<this.edges.length;h++){const p=this.edges[h],_=this.edgeProps[h].dir,g=new Fr(u,this.edgeProps[h].dir),x=this.vertices[p.a].position,b=this.vertices[p.b].position,w=an(),E=an(),A=g.intersectsPlane(x,this.vertexProps[p.a].dir,w),P=g.intersectsPlane(b,this.vertexProps[p.b].dir,E);if(!A||!P)continue;const L=Js(an(),E,w),k=Js(an(),u,w),j=pr(L,L),G=j>0?pr(k,L)/j:0,R=Q(G,0,1),N=Math.abs((G-R)*this.edgeProps[h].len),q=Js(an(),u,x),Z=N+Math.abs(pr(q,Wn(_[1],-_[0])));Z<s&&(i=h,s=Z,a=R)}return[i,a]}tessellate(e){for(let i=this.edges.length-1;i>=0;--i){const s=this.edges[i].a,a=this.edges[i].b,{position:u,height:h,extent:p}=this.vertices[s],{position:_,height:g,extent:x}=this.vertices[a],b=this.vertexProps[s].dir,w=this.vertexProps[a].dir,E=Ei(u[0]/e,u[1]/e,h),A=Ei(_[0]/e,_[1]/e,g),P=Ei(b[1],-b[0],0);rr(P,P,p);const L=Ei(w[1],-w[0],0);if(rr(L,L,x),this.distSqLines(Ei(E[0]+.5*P[0],E[1]+.5*P[1],E[2]+.5*P[2]),Ei(A[0]-.5*L[0],A[1]-.5*L[1],A[2]-.5*L[2]),Ei(E[0]-.5*P[0],E[1]-.5*P[1],E[2]-.5*P[2]),Ei(A[0]+.5*L[0],A[1]+.5*L[1],A[2]+.5*L[2]))<=.0025000000000000005)continue;const k=this.vertices.length,j=Mo(an(),u,_);this.vertices.push({position:Po(j,j,.5),height:.5*(h+g),extent:.5*(p+x)});const G=Mo(an(),b,w);this.vertexProps.push({dir:la(G,G)}),this.edges.splice(i,1),this.edgeProps.splice(i,1),this.edges.push({a:s,b:k}),this.edges.push({a:k,b:a});const R=Js(an(),this.vertices[k].position,u),N=Qs(R),q={vec:R,dir:Po(an(),R,1/N),len:N};this.edgeProps.push(q),this.edgeProps.push(q)}}distSqLines(e,i,s,a){const u=Or(Si(),i,e),h=Or(Si(),a,s),p=Or(Si(),e,s),_=Ar(u,u),g=Ar(u,h),x=Ar(u,p),b=Ar(h,h),w=Ar(h,p),E=_*b-g*g;if(E===0){const L=Ar(p,h)/Ar(h,h);return pn(Zr(Si(),s,a,L),e)}const A=(g*w-x*b)/E,P=(_*w-g*x)/E;return pn(Zr(Si(),e,i,A),Zr(Si(),s,a,P))}}class Hn{static parseFrom(e,i){const s=mi.parse(e);if(!s)return[];let{vertices:a,features:u}=s;const h=1/Pe(i);u.sort((x,b)=>x.id-b.id),a.sort((x,b)=>x.id-b.id||x.idx-b.idx),a=a.filter((x,b,w)=>b===w.findIndex(E=>E.id===x.id&&E.idx===x.idx));const p=new Array;let _=0;const g=a.length;for(const x of u){if(x.constantHeight){p.push(new An(x.id,x.bounds,x.constantHeight));continue}for(;_!==g&&a[_].id<x.id;)_++;if(_===g||a[_].id!==x.id)continue;const b=new Array,w=new Array,E=_;for(;_!==g&&a[_].id===x.id;){const A=a[_];if(b.push({position:A.position,height:A.height,extent:A.extent}),_!==E&&a[_-1].idx===A.idx-1){const P=_-E;w.push({a:P-1,b:P})}_++}p.push(new An(x.id,x.bounds,void 0,b,w,h))}return p}static getElevationFeature(e,i){if(!i)return;const s=+e.properties[ui];return Number.isNaN(s)?void 0:i.find(a=>a.id===s)}}class us{constructor(e,i){this.zScale=1,this.xOffset=0,this.yOffset=0,e.equals(i)||(this.zScale=Math.pow(2,i.z-e.z),this.xOffset=(e.x*this.zScale-i.x)*dt,this.yOffset=(e.y*this.zScale-i.y)*dt)}constantElevation(e,i){if(e.constantHeight!=null)return this.computeBiasedHeight(e.constantHeight,i)}pointElevation(e,i,s){const a=this.constantElevation(i,s);return a??(e.x=e.x*this.zScale+this.xOffset,e.y=e.y*this.zScale+this.yOffset,this.computeBiasedHeight(i.pointElevation(e),s))}computeBiasedHeight(e,i){return i<=0?e:e+i*de(0,i,e>=0?e:Math.abs(.5*e))}}bt(An,"ElevationFeature");class ts{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.hasPattern=!1,this.projection=e.projection,this.layoutVertexArray=new Ns,this.indexArray=new en,this.segments=new Tr,this.programConfigurations=new l(e.layers,{zoom:e.zoom,lut:e.lut}),this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.elevationMode=this.layers[0].layout.get("circle-elevation-reference"),this.hasElevation=!1,this.elevationMode!=="none"&&(this.elevatedLayoutVertexArray=new mo),this.worldview=e.worldview}updateFootprints(e,i){}populate(e,i,s,a){const u=this.layers[0],h=[];let p=null;u.type==="circle"&&(p=u.layout.get("circle-sort-key"));for(const{feature:g,id:x,index:b,sourceLayerIndex:w}of e){const E=this.layers[0]._featureFilter.needGeometry,A=gt(g,E);if(!this.layers[0]._featureFilter.filter(new Gi(this.zoom,{worldview:this.worldview}),A,s))continue;const P=p?p.evaluate(A,{},s):void 0,L={id:x,properties:g.properties,type:g.type,sourceLayerIndex:w,index:b,geometry:E?A.geometry:Tt(g,s,a),patterns:{},sortKey:P};h.push(L)}p&&h.sort((g,x)=>g.sortKey-x.sortKey);let _=null;a.projection.name==="globe"&&(this.globeExtVertexArray=new iu,_=a.projection);for(const g of h){const{geometry:x,index:b,sourceLayerIndex:w}=g,E=e[b].feature;this.addFeature(g,x,b,i.availableImages,s,_,i.brightness,i.elevationFeatures),i.featureIndex.insert(E,x,b,w,this.index)}this.hasElevation||(this.elevatedLayoutVertexArray=void 0)}update(e,i,s,a,u,h,p){this.programConfigurations.updatePaintArrays(e,i,u,s,a,h,p,this.worldview)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,pm.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,au.members)),this.elevatedLayoutVertexArray&&(this.elevatedLayoutVertexBuffer=e.createVertexBuffer(this.elevatedLayoutVertexArray,mm.members))),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.elevatedLayoutVertexBuffer&&this.elevatedLayoutVertexBuffer.destroy())}addFeature(e,i,s,a,u,h,p,_){let g;this.elevationMode!=="none"&&(g=Hn.getElevationFeature(e,_));for(const x of i)for(const b of x){const w=b.x,E=b.y;if(w<0||w>=dt||E<0||E>=dt)continue;if(h){const L=h.projectTilePoint(w,E,u),k=h.upVector(u,w,E);this.addGlobeExtVertex(L,k),this.addGlobeExtVertex(L,k),this.addGlobeExtVertex(L,k),this.addGlobeExtVertex(L,k)}const A=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,e.sortKey),P=A.vertexLength;if(this.addCircleVertex(w,E,-1,-1),this.addCircleVertex(w,E,1,-1),this.addCircleVertex(w,E,1,1),this.addCircleVertex(w,E,-1,1),this.elevationMode!=="none"){const L=g?g.pointElevation(new ut(w,E)):0;this.hasElevation=this.hasElevation||L!==0;for(let k=0;k<4;k++)this.elevatedLayoutVertexArray.emplaceBack(L)}this.indexArray.emplaceBack(P,P+1,P+2),this.indexArray.emplaceBack(P,P+2,P+3),A.vertexLength+=4,A.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,s,{},a,u,p,void 0,this.worldview)}addCircleVertex(e,i,s,a){this.layoutVertexArray.emplaceBack(2*e+(s+1)/2,2*i+(a+1)/2)}addGlobeExtVertex(e,i){this.globeExtVertexArray.emplaceBack(e.x,e.y,e.z,i[0]*16384,i[1]*16384,i[2]*16384)}}function Cn(r,e){for(let i=0;i<r.length;i++)if(bs(e,r[i]))return!0;for(let i=0;i<e.length;i++)if(bs(r,e[i]))return!0;return!!Ql(r,e)}function vo(r,e,i){return!!bs(r,e)||!!ec(e,r,i)}function hs(r,e){if(r.length===1)return fu(e,r[0]);for(let i=0;i<e.length;i++){const s=e[i];for(let a=0;a<s.length;a++)if(bs(r,s[a]))return!0}for(let i=0;i<r.length;i++)if(fu(e,r[i]))return!0;for(let i=0;i<e.length;i++)if(Ql(r,e[i]))return!0;return!1}function xo(r,e,i){if(r.length>1){if(Ql(r,e))return!0;for(let s=0;s<e.length;s++)if(ec(e[s],r,i))return!0}for(let s=0;s<r.length;s++)if(ec(r[s],e,i))return!0;return!1}function Ql(r,e){if(r.length===0||e.length===0)return!1;for(let i=0;i<r.length-1;i++){const s=r[i],a=r[i+1];for(let u=0;u<e.length-1;u++)if(Uh(s,a,e[u],e[u+1]))return!0}return!1}function Uh(r,e,i,s){return Zi(r,i,s)!==Zi(e,i,s)&&Zi(r,e,i)!==Zi(r,e,s)}function qa(r,e,i){return(r.x-i.x)*(e.y-i.y)-(r.y-i.y)*(e.x-i.x)}function jh(r,e,i,s){const a=qa(r,e,s),u=qa(r,e,i);if(Math.sign(a)===Math.sign(u))return;const h=qa(i,s,r),p=h+u-a;return Math.sign(h)!==Math.sign(p)?[h/(h-p),u/(u-a)]:void 0}function ec(r,e,i){const s=i*i;if(e.length===1)return r.distSqr(e[0])<s;for(let a=1;a<e.length;a++)if(du(r,e[a-1],e[a])<s)return!0;return!1}function du(r,e,i){const s=e.distSqr(i);if(s===0)return r.distSqr(e);const a=((r.x-e.x)*(i.x-e.x)+(r.y-e.y)*(i.y-e.y))/s;return r.distSqr(a<0?e:a>1?i:i.sub(e)._mult(a)._add(e))}function fu(r,e){let i,s,a,u=!1;for(let h=0;h<r.length;h++){i=r[h];for(let p=0,_=i.length-1;p<i.length;_=p++)s=i[p],a=i[_],s.y>e.y!=a.y>e.y&&e.x<(a.x-s.x)*(e.y-s.y)/(a.y-s.y)+s.x&&(u=!u)}return u}function bs(r,e){let i=!1;for(let s=0,a=r.length-1;s<r.length;a=s++){const u=r[s],h=r[a];u.y>e.y!=h.y>e.y&&e.x<(h.x-u.x)*(e.y-u.y)/(h.y-u.y)+u.x&&(i=!i)}return i}function $a(r,e,i,s,a){for(const h of r)if(e<=h.x&&i<=h.y&&s>=h.x&&a>=h.y)return!0;const u=[new ut(e,i),new ut(e,a),new ut(s,a),new ut(s,i)];if(r.length>2){for(const h of u)if(bs(r,h))return!0}for(let h=0;h<r.length-1;h++)if(ta(r[h],r[h+1],u))return!0;return!1}function ta(r,e,i){const s=i[0],a=i[2];if(r.x<s.x&&e.x<s.x||r.x>a.x&&e.x>a.x||r.y<s.y&&e.y<s.y||r.y>a.y&&e.y>a.y)return!1;const u=Zi(r,e,i[0]);return u!==Zi(r,e,i[1])||u!==Zi(r,e,i[2])||u!==Zi(r,e,i[3])}function bo(r,e,i,s,a,u){let h=e.y-r.y,p=r.x-e.x;if(u=u||0){const _=h*h+p*p;if(_===0)return!0;const g=Math.sqrt(_);h/=g,p/=g}return!((i.x-r.x)*h+(i.y-r.y)*p-u<0||(s.x-r.x)*h+(s.y-r.y)*p-u<0||(a.x-r.x)*h+(a.y-r.y)*p-u<0)}function gm(r,e,i,s,a,u,h){return!(bo(r,e,s,a,u,h)||bo(e,i,s,a,u,h)||bo(i,r,s,a,u,h)||bo(s,a,r,e,i,h)||bo(a,u,r,e,i,h)||bo(u,s,r,e,i,h))}function pu(r,e,i){const s=e.paint.get(r).value;return s.kind==="constant"?s.value:i.programConfigurations.get(e.id).getMaxValue(r)}function Mf(r){return Math.sqrt(r[0]*r[0]+r[1]*r[1])}function xg(r,e,i,s,a){if(!e[0]&&!e[1])return r;const u=ut.convert(e)._mult(a);i==="viewport"&&u._rotate(-s);const h=[];for(let p=0;p<r.length;p++)h.push(r[p].sub(u));return h}function bg(r,e,i,s){const a=ut.convert(r)._mult(s);return e==="viewport"&&a._rotate(-i),a}let wg,Tg;function Sg(r,e,i){var s=2*Math.PI*6378137/256/Math.pow(2,i);return[r*s-2*Math.PI*6378137/2,e*s-2*Math.PI*6378137/2]}bt(ts,"CircleBucket",{omit:["layers"]});class tc{constructor(e,i,s){this.z=e,this.x=i,this.y=s,this.key=mu(0,e,e,i,s)}equals(e){return this.z===e.z&&this.x===e.x&&this.y===e.y}url(e,i){const s=function(u,h,p){var _=Sg(256*u,256*(h=Math.pow(2,p)-h-1),p),g=Sg(256*(u+1),256*(h+1),p);return _[0]+","+_[1]+","+g[0]+","+g[1]}(this.x,this.y,this.z),a=function(u,h,p){let _,g="";for(let x=u;x>0;x--)_=1<<x-1,g+=(h&_?1:0)+(p&_?2:0);return g}(this.z,this.x,this.y);return e[(this.x+this.y)%e.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(i==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",a).replace("{bbox-epsg-3857}",s)}toString(){return`${this.z}/${this.x}/${this.y}`}}class Eg{constructor(e,i){this.wrap=e,this.canonical=i,this.key=mu(e,i.z,i.z,i.x,i.y)}}class wn{constructor(e,i,s,a,u){this.overscaledZ=e,this.wrap=i,this.canonical=new tc(s,+a,+u),this.key=i===0&&e===s?this.canonical.key:mu(i,e,s,a,u)}equals(e){return this.overscaledZ===e.overscaledZ&&this.wrap===e.wrap&&this.canonical.equals(e.canonical)}scaledTo(e){const i=this.canonical.z-e;return e>this.canonical.z?new wn(e,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new wn(e,this.wrap,e,this.canonical.x>>i,this.canonical.y>>i)}calculateScaledKey(e,i=!0){if(this.overscaledZ===e&&i)return this.key;if(e>this.canonical.z)return mu(this.wrap*+i,e,this.canonical.z,this.canonical.x,this.canonical.y);{const s=this.canonical.z-e;return mu(this.wrap*+i,e,e,this.canonical.x>>s,this.canonical.y>>s)}}isChildOf(e){if(e.wrap!==this.wrap)return!1;const i=this.canonical.z-e.canonical.z;return e.overscaledZ===0||e.overscaledZ<this.overscaledZ&&e.canonical.z<this.canonical.z&&e.canonical.x===this.canonical.x>>i&&e.canonical.y===this.canonical.y>>i}children(e){if(this.overscaledZ>=e)return[new wn(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const i=this.canonical.z+1,s=2*this.canonical.x,a=2*this.canonical.y;return[new wn(i,this.wrap,i,s,a),new wn(i,this.wrap,i,s+1,a),new wn(i,this.wrap,i,s,a+1),new wn(i,this.wrap,i,s+1,a+1)]}isLessThan(e){return this.wrap<e.wrap||!(this.wrap>e.wrap)&&(this.overscaledZ<e.overscaledZ||!(this.overscaledZ>e.overscaledZ)&&(this.canonical.x<e.canonical.x||!(this.canonical.x>e.canonical.x)&&this.canonical.y<e.canonical.y))}wrapped(){return new wn(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(e){return new wn(this.overscaledZ,e,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new Eg(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function mu(r,e,i,s,a){const u=1<<Math.min(i,22);let h=u*(a%u)+s%u;return r&&i<22&&(h+=u*u*((r<0?-2*r-1:2*r)%(1<<2*(22-i)))),16*(32*h+i)+(e-i)}const m1=[r=>{let e=r.canonical.x-1,i=r.wrap;return e<0&&(e=(1<<r.canonical.z)-1,i--),new wn(r.overscaledZ,i,r.canonical.z,e,r.canonical.y)},r=>{let e=r.canonical.x+1,i=r.wrap;return e===1<<r.canonical.z&&(e=0,i++),new wn(r.overscaledZ,i,r.canonical.z,e,r.canonical.y)},r=>new wn(r.overscaledZ,r.wrap,r.canonical.z,r.canonical.x,(r.canonical.y===0?1<<r.canonical.z:r.canonical.y)-1),r=>new wn(r.overscaledZ,r.wrap,r.canonical.z,r.canonical.x,r.canonical.y===(1<<r.canonical.z)-1?0:r.canonical.y+1)];bt(tc,"CanonicalTileID"),bt(wn,"OverscaledTileID",{omit:["projMatrix","expandedProjMatrix"]});const _1=bi([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:Pf}=_1,g1=bi([{name:"a_pos_3",components:3,type:"Int16"}]);var Ig=bi([{name:"a_pos",type:"Int16",components:2}]);function Rf(r){return r*m/O}const y1=[new Ti([I,I,I],[M,M,M]),new Ti([I,I,I],[0,0,M]),new Ti([0,I,I],[M,0,M]),new Ti([I,0,I],[0,M,M]),new Ti([0,0,I],[M,M,M])];function Ag(r,e,i,s=!0){const a=rr([],r._camera.position,r.worldSize),u=[e,i,1,1];_n(u,u,r.pixelMatrixInverse),Co(u,u,1/u[3]);const h=mr([],Br([],u,a)),p=r.globeMatrix,_=[p[12],p[13],p[14]],g=Br([],_,a),x=Rr(g),b=mr([],g),w=r.worldSize/(2*Math.PI),E=Ar(b,h),A=Math.asin(w/x);if(A<Math.acos(E)){if(!s)return null;const ce=[],me=[];rr(ce,h,x/E),mr(me,Br(me,ce,g)),mr(h,zr(h,g,rr(h,me,Math.tan(A)*x)))}const P=[];new sr(a,h).closestPointOnSphere(_,w,P);const L=mr([],xr(p,0)),k=mr([],xr(p,1)),j=mr([],xr(p,2)),G=Ar(L,P),R=Ar(k,P),N=Ar(j,P),q=Ee(Math.asin(-R/w));let Z=Ee(Math.atan2(G,N));Z=r.center.lng+function(ce,me){const Re=(me-ce+180)%360-180;return Re<-180?Re+360:Re}(r.center.lng,Z);const ae=J(Z),ne=Q(K(q),0,1);return new ue(ae,ne)}class v1{constructor(e,i,s){this.a=Br([],e,s),this.b=Br([],i,s),this.center=s;const a=mr([],this.a),u=mr([],this.b);this.angle=Math.acos(Ar(a,u))}}function ym(r,e){if(r.angle===0)return null;let i;return i=r.a[e]===0?1/r.angle*.5*Math.PI:1/r.angle*Math.atan(r.b[e]/r.a[e]/Math.sin(r.angle)-1/Math.tan(r.angle)),i<0||i>1?null:function(s,a,u,h){const p=Math.sin(u);return s*(Math.sin((1-h)*u)/p)+a*(Math.sin(h*u)/p)}(r.a[e],r.b[e],r.angle,Q(i,0,1))+r.center[e]}function wo(r){if(r.z<=1)return y1[r.z+2*r.y+r.x];const e=vm(zf(r));return Ti.fromPoints(e)}function ia(r,e,i){return rr(r,r,1-i),fn(r,r,e,i)}function Cg(r,e,i){for(const s of r)ji(s,s,e),rr(s,s,i)}function Mg(r,e,i,s){const a=e/r.worldSize,u=r.globeMatrix;if(i.z<=1){const ne=wo(i).getCorners();return Cg(ne,u,a),Ti.fromPoints(ne)}const h=zf(i,s),p=vm(h,m+Rf(r._tileCoverLift));Cg(p,u,a);const _=Number.MAX_VALUE,g=[-_,-_,-_],x=[_,_,_];if(h.contains(r.center)){for(const me of p)Vn(x,x,me),Un(g,g,me);g[2]=0;const ne=r.point,ce=[ne.x*a,ne.y*a,0];return Vn(x,x,ce),Un(g,g,ce),new Ti(x,g)}if(r._tileCoverLift>0){for(const ne of p)Vn(x,x,ne),Un(g,g,ne);return new Ti(x,g)}const b=[u[12]*a,u[13]*a,u[14]*a],w=h.getCenter(),E=Q(r.center.lat,-85.051129,Oe),A=Q(w.lat,-85.051129,Oe),P=J(r.center.lng),L=K(E);let k=P-J(w.lng);const j=L-K(A);k>.5?k-=1:k<-.5&&(k+=1);let G=0;Math.abs(k)>Math.abs(j)?G=k>=0?1:3:(G=j>=0?0:2,fn(b,b,[u[4]*a,u[5]*a,u[6]*a],-Math.sin(wi(j>=0?h.getSouth():h.getNorth()))*m));const R=p[G],N=p[(G+1)%4],q=new v1(R,N,b),Z=[ym(q,0)||R[0],ym(q,1)||R[1],ym(q,2)||R[2]],ae=Ha(r.zoom);if(ae>0){const ne=function({x:me,y:Re,z:Xe},Ve,We,Ke,Le){const He=1/(1<<Xe);let Me=me*He,ze=Me+He,et=Re*He,it=et+He,Ot=0;const At=(Me+ze)/2-Ke;return At>.5?Ot=-1:At<-.5&&(Ot=1),Me=((Me+Ot)*Ve-(Ke*=Ve))*We+Ke,ze=((ze+Ot)*Ve-Ke)*We+Ke,et=(et*Ve-(Le*=Ve))*We+Le,it=(it*Ve-Le)*We+Le,[[Me,it,0],[ze,it,0],[ze,et,0],[Me,et,0]]}(i,e,r._pixelsPerMercatorPixel,P,L);for(let me=0;me<p.length;me++)ia(p[me],ne[me],ae);const ce=zr([],ne[G],ne[(G+1)%4]);rr(ce,ce,.5),ia(Z,ce,ae)}for(const ne of p)Vn(x,x,ne),Un(g,g,ne);return x[2]=Math.min(R[2],N[2]),Vn(x,x,Z),Un(g,g,Z),new Ti(x,g)}function zf({x:r,y:e,z:i},s=!1){const a=1/(1<<i),u=new V(se(r*a),e===(1<<i)-1&&s?-90:ye((e+1)*a)),h=new V(se((r+1)*a),e===0&&s?90:ye(e*a));return new H(u,h)}function vm(r,e=m){const i=wi(r.getNorth()),s=wi(r.getSouth()),a=Math.cos(i),u=Math.cos(s),h=Math.sin(i),p=Math.sin(s),_=r.getWest(),g=r.getEast();return[D(u,p,_,e),D(u,p,g,e),D(a,h,g,e),D(a,h,_,e)]}function Gh(r,e,i,s){const a=1<<i.z,u=(r/dt+i.x)/a;return z(ye((e/dt+i.y)/a),se(u),s)}function Lf({min:r,max:e}){return T/Math.max(e[0]-r[0],e[1]-r[1],e[2]-r[2])}const Pg=new Float64Array(16);function Df(r){const e=Lf(r),i=yt(Pg,[e,e,e]);return It(i,i,Zs([],r.min))}function xm(r){const e=(s=r.min,(i=Pg)[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=s[0],i[13]=s[1],i[14]=s[2],i[15]=1,i);var i,s;const a=1/Lf(r);return vt(e,e,[a,a,a])}function bm(r){const e=dt/(2*Math.PI);return r/(2*Math.PI)/e}function Rg(r,e){return dt/(512*Math.pow(2,r))*Lf(wo(e))}function zg(r,e,i,s,a){const u=bm(i),h=[r,e,-i/(2*Math.PI)],p=re(new Float64Array(16));return It(p,p,h),vt(p,p,[u,u,u]),nt(p,p,wi(-a)),$e(p,p,wi(-s)),p}function Ha(r){return de(y,v,r)}function Lg(r,e){const i=z(e.lat,e.lng),s=function(A){const P=z(A._center.lat,A._center.lng);let L=$i([],Ei(0,1,0),P);const k=Gt([],-A.angle,P);L=ji(L,L,k),Gt(k,-A._pitch,L);const j=mr([],P);return rr(j,j,Rf(A.cameraToCenterDistance/A.pixelsPerMeter)),ji(j,j,k),zr([],P,j)}(r);return h=(a=Or([],s,i))[0],p=a[1],_=a[2],g=(u=i)[0],x=u[1],b=u[2],E=(w=Math.sqrt(h*h+p*p+_*_)*Math.sqrt(g*g+x*x+b*b))&&Ar(a,u)/w,Math.acos(Math.min(Math.max(E,-1),1));var a,u,h,p,_,g,x,b,w,E}function wm(r,e){return Lg(r,e)>Math.PI/2*1.01}const Dg=wi(85),x1=Math.cos(Dg),b1=Math.sin(Dg),w1=st(),Og=r=>{const e=[];return r.paint.get("circle-pitch-alignment")==="map"&&e.push("PITCH_WITH_MAP"),r.paint.get("circle-pitch-scale")==="map"&&e.push("SCALE_WITH_MAP"),e};function kg(r,e,i,s,a,u,h,p,_){if(u&&r.queryGeometry.isAboveHorizon)return!1;u&&(_*=r.pixelToTileUnitsFactor);const g=r.tileID.canonical,x=i.projection.upVectorScale(g,i.center.lat,i.worldSize).metersToTile;for(const b of e)for(const w of b){const E=w.add(p),A=a&&i.elevation?i.elevation.exaggeration()*a.getElevationAt(E.x,E.y,!0):0,P=i.projection.projectTilePoint(E.x,E.y,g);if(A>0){const G=i.projection.upVector(g,E.x,E.y);P.x+=G[0]*x*A,P.y+=G[1]*x*A,P.z+=G[2]*x*A}const L=u?E:T1(P.x,P.y,P.z,s),k=u?r.tilespaceRays.map(G=>E1(G,A)):r.queryGeometry.screenGeometry,j=_n([],[P.x,P.y,P.z,1],s);if(!h&&u?_*=j[3]/i.cameraToCenterDistance:h&&!u&&(_*=i.cameraToCenterDistance/j[3]),u){const G=ye((w.y/dt+g.y)/(1<<g.z));_/=i.projection.pixelsPerMeter(G,1)/ie(1,G)}if(vo(k,L,_))return!0}return!1}function T1(r,e,i,s){const a=_n([],[r,e,i,1],s);return new ut(a[0]/a[3],a[1]/a[3])}const Fg=Ei(0,0,0),S1=Ei(0,0,1);function E1(r,e){const i=Si();return Fg[2]=e,r.intersectsPlane(Fg,S1,i),new ut(i[0],i[1])}class Bg extends ts{}let Ng,Vg,Ug,jg;function Gg(r,{width:e,height:i},s,a){if(a){if(a instanceof Uint8ClampedArray)a=new Uint8Array(a.buffer);else if(a.length!==e*i*s)throw new RangeError("mismatched image size")}else a=new Uint8Array(e*i*s);return r.width=e,r.height=i,r.data=a,r}function qg(r,e,i){const{width:s,height:a}=e;s===r.width&&a===r.height||(Tm(r,e,{x:0,y:0},{x:0,y:0},{width:Math.min(r.width,s),height:Math.min(r.height,a)},i,null),r.width=s,r.height=a,r.data=e.data)}function Tm(r,e,i,s,a,u,h,p){if(a.width===0||a.height===0)return e;if(a.width>r.width||a.height>r.height||i.x>r.width-a.width||i.y>r.height-a.height)throw new RangeError("out of range source coordinates for image copy");if(a.width>e.width||a.height>e.height||s.x>e.width-a.width||s.y>e.height-a.height)throw new RangeError("out of range destination coordinates for image copy");const _=r.data,g=e.data,x=u===4&&p;for(let b=0;b<a.height;b++){const w=((i.y+b)*r.width+i.x)*u,E=((s.y+b)*e.width+s.x)*u;if(x)for(let A=0;A<a.width;A++){const P=w+A*u+3,L=E+A*u;g[L+0]=255,g[L+1]=255,g[L+2]=255,g[L+3]=_[P]}else if(h)for(let A=0;A<a.width;A++){const P=w+A*u,L=E+A*u,k=new Pi(_[P+0]/255,_[P+1]/255,_[P+2]/255,_[P+3]).toNonPremultipliedRenderColor(h).toArray();g[L+0]=k[0],g[L+1]=k[1],g[L+2]=k[2],g[L+3]=k[3]}else for(let A=0;A<a.width*u;A++)g[E+A]=_[w+A]}return e}bt(Bg,"HeatmapBucket",{omit:["layers"]});class Za{constructor(e,i){Gg(this,e,1,i)}resize(e){qg(this,new Za(e),1)}clone(){return new Za({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,i,s,a,u){Tm(e,i,s,a,u,1,null)}}class nn{constructor(e,i){Gg(this,e,4,i)}resize(e){qg(this,new nn(e),4)}replace(e,i){i?this.data.set(e):this.data=e instanceof Uint8ClampedArray?new Uint8Array(e.buffer):e}clone(){return new nn({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,i,s,a,u,h,p){Tm(e,i,s,a,u,4,h,p)}}class $g{constructor(e,i){this.width=e.width,this.height=e.height,this.data=i instanceof Uint8Array?new Float32Array(i.buffer):i}}function qh(r){const e={},i=r.resolution||256,s=r.clips?r.clips.length:1,a=r.image||new nn({width:i,height:s}),u=(h,p,_)=>{e[r.evaluationKey]=_;const g=r.expression.evaluate(e),x=g?g.toNonPremultipliedRenderColor(null):null;x&&(a.data[h+p+0]=Math.floor(255*x.r),a.data[h+p+1]=Math.floor(255*x.g),a.data[h+p+2]=Math.floor(255*x.b),a.data[h+p+3]=Math.floor(255*x.a))};if(r.clips)for(let h=0,p=0;h<s;++h,p+=4*i)for(let _=0,g=0;_<i;_++,g+=4){const x=_/(i-1),{start:b,end:w}=r.clips[h];u(p,g,b*(1-x)+w*x)}else for(let h=0,p=0;h<i;h++,p+=4)u(0,p,h/(i-1));return a}bt(Za,"AlphaImage"),bt(nn,"RGBAImage");const I1=bi([{name:"a_pos",components:2,type:"Int16"}],4),A1=bi([{name:"a_road_z_offset",components:1,type:"Float32"}],4),C1=bi([{name:"a_pos",components:2,type:"Int16"},{name:"a_height",components:1,type:"Float32"}],4),M1=bi([{name:"a_pos_normal_3",components:3,type:"Int16"}],4);function $h(r,e,i=2){const s=e&&e.length,a=s?e[0]*i:r.length;let u=Hg(r,0,a,i,!0);const h=[];if(!u||u.next===u.prev)return h;let p,_,g;if(s&&(u=function(x,b,w,E){const A=[];for(let P=0,L=b.length;P<L;P++){const k=Hg(x,b[P]*E,P<L-1?b[P+1]*E:x.length,E,!1);k===k.next&&(k.steiner=!0),A.push(F1(k))}A.sort(D1);for(let P=0;P<A.length;P++)w=O1(A[P],w);return w}(r,e,u,i)),r.length>80*i){p=1/0,_=1/0;let x=-1/0,b=-1/0;for(let w=i;w<a;w+=i){const E=r[w],A=r[w+1];E<p&&(p=E),A<_&&(_=A),E>x&&(x=E),A>b&&(b=A)}g=Math.max(x-p,b-_),g=g!==0?32767/g:0}return Hh(u,h,i,p,_,g,0),h}function Hg(r,e,i,s,a){let u;if(a===function(h,p,_,g){let x=0;for(let b=p,w=_-g;b<_;b+=g)x+=(h[w]-h[b])*(h[b+1]+h[w+1]),w=b;return x}(r,e,i,s)>0)for(let h=e;h<i;h+=s)u=Yg(h/s|0,r[h],r[h+1],u);else for(let h=i-s;h>=e;h-=s)u=Yg(h/s|0,r[h],r[h+1],u);return u&&_u(u,u.next)&&(Xh(u),u=u.next),u}function ic(r,e){if(!r)return r;e||(e=r);let i,s=r;do if(i=!1,s.steiner||!_u(s,s.next)&&Wr(s.prev,s,s.next)!==0)s=s.next;else{if(Xh(s),s=e=s.prev,s===s.next)break;i=!0}while(i||s!==e);return e}function Hh(r,e,i,s,a,u,h){if(!r)return;!h&&u&&function(_,g,x,b){let w=_;do w.z===0&&(w.z=Sm(w.x,w.y,g,x,b)),w.prevZ=w.prev,w.nextZ=w.next,w=w.next;while(w!==_);w.prevZ.nextZ=null,w.prevZ=null,function(E){let A,P=1;do{let L,k=E;E=null;let j=null;for(A=0;k;){A++;let G=k,R=0;for(let q=0;q<P&&(R++,G=G.nextZ,G);q++);let N=P;for(;R>0||N>0&&G;)R!==0&&(N===0||!G||k.z<=G.z)?(L=k,k=k.nextZ,R--):(L=G,G=G.nextZ,N--),j?j.nextZ=L:E=L,L.prevZ=j,j=L;k=G}j.nextZ=null,P*=2}while(A>1)}(w)}(r,s,a,u);let p=r;for(;r.prev!==r.next;){const _=r.prev,g=r.next;if(u?R1(r,s,a,u):P1(r))e.push(_.i,r.i,g.i),Xh(r),r=g.next,p=g.next;else if((r=g)===p){h?h===1?Hh(r=z1(ic(r),e),e,i,s,a,u,2):h===2&&L1(r,e,i,s,a,u):Hh(ic(r),e,i,s,a,u,1);break}}}function P1(r){const e=r.prev,i=r,s=r.next;if(Wr(e,i,s)>=0)return!1;const a=e.x,u=i.x,h=s.x,p=e.y,_=i.y,g=s.y,x=Math.min(a,u,h),b=Math.min(p,_,g),w=Math.max(a,u,h),E=Math.max(p,_,g);let A=s.next;for(;A!==e;){if(A.x>=x&&A.x<=w&&A.y>=b&&A.y<=E&&Zh(a,p,u,_,h,g,A.x,A.y)&&Wr(A.prev,A,A.next)>=0)return!1;A=A.next}return!0}function R1(r,e,i,s){const a=r.prev,u=r,h=r.next;if(Wr(a,u,h)>=0)return!1;const p=a.x,_=u.x,g=h.x,x=a.y,b=u.y,w=h.y,E=Math.min(p,_,g),A=Math.min(x,b,w),P=Math.max(p,_,g),L=Math.max(x,b,w),k=Sm(E,A,e,i,s),j=Sm(P,L,e,i,s);let G=r.prevZ,R=r.nextZ;for(;G&&G.z>=k&&R&&R.z<=j;){if(G.x>=E&&G.x<=P&&G.y>=A&&G.y<=L&&G!==a&&G!==h&&Zh(p,x,_,b,g,w,G.x,G.y)&&Wr(G.prev,G,G.next)>=0||(G=G.prevZ,R.x>=E&&R.x<=P&&R.y>=A&&R.y<=L&&R!==a&&R!==h&&Zh(p,x,_,b,g,w,R.x,R.y)&&Wr(R.prev,R,R.next)>=0))return!1;R=R.nextZ}for(;G&&G.z>=k;){if(G.x>=E&&G.x<=P&&G.y>=A&&G.y<=L&&G!==a&&G!==h&&Zh(p,x,_,b,g,w,G.x,G.y)&&Wr(G.prev,G,G.next)>=0)return!1;G=G.prevZ}for(;R&&R.z<=j;){if(R.x>=E&&R.x<=P&&R.y>=A&&R.y<=L&&R!==a&&R!==h&&Zh(p,x,_,b,g,w,R.x,R.y)&&Wr(R.prev,R,R.next)>=0)return!1;R=R.nextZ}return!0}function z1(r,e){let i=r;do{const s=i.prev,a=i.next.next;!_u(s,a)&&Wg(s,i,i.next,a)&&Wh(s,a)&&Wh(a,s)&&(e.push(s.i,i.i,a.i),Xh(i),Xh(i.next),i=r=a),i=i.next}while(i!==r);return ic(i)}function L1(r,e,i,s,a,u){let h=r;do{let p=h.next.next;for(;p!==h.prev;){if(h.i!==p.i&&B1(h,p)){let _=Xg(h,p);return h=ic(h,h.next),_=ic(_,_.next),Hh(h,e,i,s,a,u,0),void Hh(_,e,i,s,a,u,0)}p=p.next}h=h.next}while(h!==r)}function D1(r,e){let i=r.x-e.x;return i===0&&(i=r.y-e.y,i===0)&&(i=(r.next.y-r.y)/(r.next.x-r.x)-(e.next.y-e.y)/(e.next.x-e.x)),i}function O1(r,e){const i=function(a,u){let h=u;const p=a.x,_=a.y;let g,x=-1/0;if(_u(a,h))return h;do{if(_u(a,h.next))return h.next;if(_<=h.y&&_>=h.next.y&&h.next.y!==h.y){const P=h.x+(_-h.y)*(h.next.x-h.x)/(h.next.y-h.y);if(P<=p&&P>x&&(x=P,g=h.x<h.next.x?h:h.next,P===p))return g}h=h.next}while(h!==u);if(!g)return null;const b=g,w=g.x,E=g.y;let A=1/0;h=g;do{if(p>=h.x&&h.x>=w&&p!==h.x&&Zg(_<E?p:x,_,w,E,_<E?x:p,_,h.x,h.y)){const P=Math.abs(_-h.y)/(p-h.x);Wh(h,a)&&(P<A||P===A&&(h.x>g.x||h.x===g.x&&k1(g,h)))&&(g=h,A=P)}h=h.next}while(h!==b);return g}(r,e);if(!i)return e;const s=Xg(i,r);return ic(s,s.next),ic(i,i.next)}function k1(r,e){return Wr(r.prev,r,e.prev)<0&&Wr(e.next,r,r.next)<0}function Sm(r,e,i,s,a){return(r=1431655765&((r=858993459&((r=252645135&((r=16711935&((r=(r-i)*a|0)|r<<8))|r<<4))|r<<2))|r<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-s)*a|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function F1(r){let e=r,i=r;do(e.x<i.x||e.x===i.x&&e.y<i.y)&&(i=e),e=e.next;while(e!==r);return i}function Zg(r,e,i,s,a,u,h,p){return(a-h)*(e-p)>=(r-h)*(u-p)&&(r-h)*(s-p)>=(i-h)*(e-p)&&(i-h)*(u-p)>=(a-h)*(s-p)}function Zh(r,e,i,s,a,u,h,p){return!(r===h&&e===p)&&Zg(r,e,i,s,a,u,h,p)}function B1(r,e){return r.next.i!==e.i&&r.prev.i!==e.i&&!function(i,s){let a=i;do{if(a.i!==i.i&&a.next.i!==i.i&&a.i!==s.i&&a.next.i!==s.i&&Wg(a,a.next,i,s))return!0;a=a.next}while(a!==i);return!1}(r,e)&&(Wh(r,e)&&Wh(e,r)&&function(i,s){let a=i,u=!1;const h=(i.x+s.x)/2,p=(i.y+s.y)/2;do a.y>p!=a.next.y>p&&a.next.y!==a.y&&h<(a.next.x-a.x)*(p-a.y)/(a.next.y-a.y)+a.x&&(u=!u),a=a.next;while(a!==i);return u}(r,e)&&(Wr(r.prev,r,e.prev)||Wr(r,e.prev,e))||_u(r,e)&&Wr(r.prev,r,r.next)>0&&Wr(e.prev,e,e.next)>0)}function Wr(r,e,i){return(e.y-r.y)*(i.x-e.x)-(e.x-r.x)*(i.y-e.y)}function _u(r,e){return r.x===e.x&&r.y===e.y}function Wg(r,e,i,s){const a=kf(Wr(r,e,i)),u=kf(Wr(r,e,s)),h=kf(Wr(i,s,r)),p=kf(Wr(i,s,e));return a!==u&&h!==p||!(a!==0||!Of(r,i,e))||!(u!==0||!Of(r,s,e))||!(h!==0||!Of(i,r,s))||!(p!==0||!Of(i,e,s))}function Of(r,e,i){return e.x<=Math.max(r.x,i.x)&&e.x>=Math.min(r.x,i.x)&&e.y<=Math.max(r.y,i.y)&&e.y>=Math.min(r.y,i.y)}function kf(r){return r>0?1:r<0?-1:0}function Wh(r,e){return Wr(r.prev,r,r.next)<0?Wr(r,e,r.next)>=0&&Wr(r,r.prev,e)>=0:Wr(r,e,r.prev)<0||Wr(r,r.next,e)<0}function Xg(r,e){const i=Em(r.i,r.x,r.y),s=Em(e.i,e.x,e.y),a=r.next,u=e.prev;return r.next=e,e.prev=r,i.next=a,a.prev=i,s.next=i,i.prev=s,u.next=s,s.prev=u,s}function Yg(r,e,i,s){const a=Em(r,e,i);return s?(a.next=s.next,a.prev=s,s.next.prev=a,s.next=a):(a.prev=a,a.next=a),a}function Xh(r){r.next.prev=r.prev,r.prev.next=r.next,r.prevZ&&(r.prevZ.nextZ=r.nextZ),r.nextZ&&(r.nextZ.prevZ=r.prevZ)}function Em(r,e,i){return{i:r,x:e,y:i,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function Ff(r,e){const i=r.length;if(i<=1)return[r];const s=[];let a,u;for(let h=0;h<i;h++){const p=cr(r[h]);p!==0&&(r[h].area=Math.abs(p),u===void 0&&(u=p<0),u===p<0?(a&&s.push(a),a=[r[h]]):a.push(r[h]))}if(a&&s.push(a),e>1)for(let h=0;h<s.length;h++)s[h].length<=e||(cn(s[h],e,1,s[h].length-1,N1),s[h]=s[h].slice(0,e));return s}function N1(r,e){return e.area-r.area}function Kg(r,e,i=1){if(!r)return null;const s=typeof r=="string"?In.from(r).getPrimary():r.getPrimary(),a=typeof r=="string"?null:r.getSecondary();for(const u of[s,a]){if(!u)continue;const h=u.id.toString();e.has(h)||e.set(h,[]),u.scaleSelf(i),e.get(h).push(u)}return{primary:s.toString(),secondary:a?a.toString():null}}function Im(r,e,i,s){const a=s.patternDependencies;let u=!1;for(const h of e){const p=h.paint.get(`${r}-pattern`);p.isConstant()||(u=!0),Kg(p.constantOr(null),a,i)&&(u=!0)}return u}function Am(r,e,i,s,a,u){const h=u.patternDependencies;for(const p of e){const _=p.paint.get(`${r}-pattern`).value;if(_.kind!=="constant"){let g=_.evaluate({zoom:s},i,{},u.availableImages);g=g&&g.name?g.name:g;const x=Kg(g,h,a);if(!x)continue;const{primary:b,secondary:w}=x;b&&(i.patterns[p.id]=[b,w].filter(Boolean))}}return i}class Jg{constructor(){this.polygons=new Map}add(e,...i){this.polygons.has(e)?this.polygons.get(e).push(...i):this.polygons.set(e,i)}merge(e){for(const[i,s]of e.polygons)this.add(i,...s)}}class rc{constructor(){this.portals=[]}static evaluate(e){if(e.length===0)return new rc;let i=[];for(const g of e)i.push(...g.portals);if(i.length===0)return new rc;const s=(g,x)=>g<=0&&x<=0||g>=dt&&x>=dt;for(const g of i){const x=g.va,b=g.vb;(s(x.x,b.x)||s(x.y,b.y))&&(g.type="border")}const a=i.filter(g=>g.type!=="unevaluated"),u=i.filter(g=>g.type==="unevaluated");if(u.length===0)return new rc;u.sort((g,x)=>g.hash===x.hash?g.isTunnel===x.isTunnel?0:g.isTunnel?-1:1:g.hash<x.hash?1:-1),i=a.concat(u);let h=a.length,p=h,_=h;do if(p++,p===i.length||i[h].hash!==i[p].hash){if(p-h==2){_<h&&(i[_]=i[h],i[h]=null);const g=i[_],x=i[p-1];g.type=g.isTunnel!==x.isTunnel?"tunnel":"polygon",g.connection={a:g.connection.a,b:x.connection.a},_++}h=p}while(h!==i.length);return i.splice(_),i.sort((g,x)=>g.hash<x.hash?1:-1),{portals:i}}}bt(rc,"ElevationPortalGraph"),bt(Jg,"ElevationPolygons");class V1{constructor(e,i,s){this.outPositions=e,this.outNormals=i,this.outIndices=s,this.vertexLookup=new Map,this.buffer=new ArrayBuffer(4),this.view=new DataView(this.buffer)}addVertex(e,i,s){let a=e[2];s!=null&&(a*=s);const u=this.getVec3Bits(e)<<96n|this.getVec3Bits(i),h=this.vertexLookup.get(u);if(h!=null)return h;const p=this.outPositions.length;this.vertexLookup.set(u,p);const _=Math.trunc(16384*i[0]),g=Math.trunc(16384*i[1]),x=Math.trunc(16384*i[2]);return this.outPositions.emplaceBack(e[0],e[1],a),this.outNormals.emplaceBack(_,g,x),p}addVertices(e,i,...s){const a=[];for(const u of s){const h=this.addVertex(u,e,i);a.push(h)}return a}addTriangles(e,i,s){if(i&&s){const a=s.length===1,u=Ei(0,0,0);for(let h=0;h<e.length;h+=3){const p=i[e[h+0]],_=i[e[h+1]],g=i[e[h+2]],x=a?s[0]:s[e[h+1]],b=a?s[0]:s[e[h+2]],w=this.addVertex(Ei(p.x,p.y,a?s[0]:s[e[h+0]]),u),E=this.addVertex(Ei(_.x,_.y,x),u),A=this.addVertex(Ei(g.x,g.y,b),u);this.outIndices.emplaceBack(w,E,A)}}else for(let a=0;a<e.length;a+=3)this.outIndices.emplaceBack(e[a+0],e[a+1],e[a+2])}addQuad(e,i){const s=this.addVertices(i,void 0,...e.map(_=>Ei(_.coord.x,_.coord.y,_.height))),[a,u,h,p]=s;this.addTriangles([a,u,h,h,p,a])}getVertexCount(){return this.outPositions.length}clearVertexLookup(){this.vertexLookup.clear()}getBits(e){return this.view.setFloat32(0,e),BigInt(this.view.getUint32(0))}getVec3Bits(e){return this.getBits(e[0])<<64n|this.getBits(e[1])<<32n|this.getBits(e[2])}}class is{constructor(e,i,s,a){this.unevaluatedPortals=new rc,this.portalPolygons=new Jg,this.bridgeFeatureSections=[],this.tunnelFeatureSections=[],this.vertexHashLookup=new Map,this.unevalVertices=[],this.unevalHeights=[],this.unevalTriangles=[],this.unevalTunnelTriangles=[],this.unevalEdges=[],this.vertexPositions=new Ah,this.vertexNormals=new tu,this.indexArray=new en,this.tileToMeters=Pe(e),this.bridgeProgramConfigurations=new l(i,{zoom:s,lut:a},u=>u!=="fill-tunnel-structure-color"),this.tunnelProgramConfigurations=new l(i,{zoom:s,lut:a},u=>u!=="fill-bridge-guard-rail-color")}addVertices(e,i){const s=this.unevalVertices.length;for(let a=0;a<e.length;a++)this.unevalVertices.push(e[a]),this.unevalHeights.push(i[a]);return s}addTriangles(e,i,s){const a=s?this.unevalTunnelTriangles:this.unevalTriangles;for(const u of e)a.push(u+i)}addRenderableRing(e,i,s,a,u,h){const p=[new ut(u.min.x,u.min.y),new ut(u.max.x,u.min.y),new ut(u.max.x,u.max.y),new ut(u.min.x,u.max.y)];for(let _=0;_<s-1;_++){const g=i+_,x=g+1,b=this.unevalVertices[g],w=this.unevalVertices[x];if(!(b.x>=u.min.x&&b.x<=u.max.x&&b.y>=u.min.y&&b.y<=u.max.y||w.x>=u.min.x&&w.x<=u.max.x&&w.y>=u.min.y&&w.y<=u.max.y||ta(b,w,p))||this.isOnBorder(b.x,w.x)||this.isOnBorder(b.y,w.y))continue;const E=is.computeEdgeHash(this.unevalVertices[g],this.unevalVertices[x]);let A,P=this.vertexHashLookup.get(is.computePosHash(b));P!=null?A=P.next:(P=this.vertexHashLookup.get(is.computePosHash(w)),A=P!=null?P.prev:E),this.unevalEdges.push({polygonIdx:e,a:g,b:x,hash:E,portalHash:A,isTunnel:a,type:"unevaluated",featureInfo:h})}}addPortalCandidates(e,i,s,a,u){if(i.length===0)return;this.portalPolygons.add(e,{geometry:i,zLevel:u});const h=i[0];this.vertexHashLookup.clear();let p=is.computeEdgeHash(h[h.length-2],h[h.length-1]);for(let _=0;_<h.length-1;_++){const g=h[_+0],x=h[_+1],b=Wn(x.x-g.x,x.y-g.y),w=Qs(b);if(w===0)continue;let E="unevaluated";const A=a.pointElevation(g),P=a.pointElevation(x);Math.abs(A)<.01&&Math.abs(P)<.01?E="entrance":(this.isOnBorder(g.x,x.x)||this.isOnBorder(g.y,x.y))&&(E="border");const L=is.computeEdgeHash(g,x);this.unevaluatedPortals.portals.push({connection:{a:e,b:void 0},va:g,vb:x,vab:b,length:w,hash:L,isTunnel:s,type:E});const k=is.computePosHash(g);this.vertexHashLookup.set(k,{prev:p,next:L}),p=L}}construct(e){if(this.unevalVertices.length===0)return;const i=()=>({vertexOffset:0,primitiveOffset:this.indexArray.length}),s=w=>{w.primitiveLength=this.indexArray.length-w.primitiveOffset},a=new V1(this.vertexPositions,this.vertexNormals,this.indexArray);this.prepareEdges(e.portals,this.unevalEdges);const u=i(),h=i(),p=i(),_=(w,E)=>{w.sort((P,L)=>P.type===E&&L.type!==E?-1:P.type!==E&&L.type===E?1:0);const A=w.findIndex(P=>P.type!==E);return A>=0?A:w.length};let g=0;this.unevalEdges.length>0&&(g=_(this.unevalEdges,"none"),this.constructBridgeStructures(a,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:g},this.tileToMeters)),s(p);const x=i(),b=i();if(this.unevalEdges.length>0){const w=this.unevalEdges.splice(g),E=_(w,"tunnel")+g;this.unevalEdges.push(...w),this.constructTunnelStructures(a,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:g},{min:g,max:E})}s(x),a.addTriangles(this.unevalTriangles,this.unevalVertices,this.unevalHeights),s(b),a.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,this.unevalHeights),s(h),a.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,[-.1]),s(u),this.maskSegments=Tr.simpleSegment(0,b.primitiveOffset,0,b.primitiveLength),this.depthSegments=Tr.simpleSegment(0,h.primitiveOffset,0,h.primitiveLength),this.renderableBridgeSegments=Tr.simpleSegment(0,p.primitiveOffset,0,p.primitiveLength),this.renderableTunnelSegments=Tr.simpleSegment(0,x.primitiveOffset,0,x.primitiveLength),this.shadowCasterSegments=Tr.simpleSegment(0,u.primitiveOffset,0,u.primitiveLength)}update(e,i,s,a,u,h,p,_){this.bridgeProgramConfigurations.updatePaintArrays(e,i,u,s,a,h,p,_),this.tunnelProgramConfigurations.updatePaintArrays(e,i,u,s,a,h,p,_)}upload(e){this.vertexBuffer||this.vertexPositions.length===0||this.vertexNormals.length===0||this.indexArray.length===0||(this.vertexBuffer=e.createVertexBuffer(this.vertexPositions,C1.members),this.vertexBufferNormal=e.createVertexBuffer(this.vertexNormals,M1.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.bridgeProgramConfigurations.upload(e),this.tunnelProgramConfigurations.upload(e))}destroy(){this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBufferNormal.destroy(),this.indexBuffer.destroy()),this.maskSegments&&(this.maskSegments.destroy(),this.depthSegments.destroy(),this.renderableBridgeSegments.destroy(),this.renderableTunnelSegments.destroy(),this.shadowCasterSegments.destroy()),this.bridgeProgramConfigurations.destroy(),this.tunnelProgramConfigurations.destroy()}populatePaintArrays(e,i,s,a,u){const h=(p,_)=>{for(let g=0;g<_.length-1;g++){const x=_[g].featureIndex,b=_[g+1].vertexStart,w=e.feature(x);p.populatePaintArrays(b,w,x,{},s,i,a,void 0,u)}};h(this.bridgeProgramConfigurations,this.bridgeFeatureSections),h(this.tunnelProgramConfigurations,this.tunnelFeatureSections)}computeVertexConnections(e,i,s,a,u){const h=new Map;for(let p=a;p<u;p++){const _=s[p],g=_.a,x=_.b,b=is.computePosHash(e[g]),w=is.computePosHash(e[x]);h.has(b)||h.set(b,{}),h.has(w)||h.set(w,{});const E=h.get(b),A=h.get(w);i[g]<=0&&i[x]<=0||(E.to=x,A.from=g)}return h}constructBridgeStructures(e,i,s,a,u,h){e.clearVertexLookup();const p=this.computeVertexConnections(i,s,a,u.min,u.max),_=1/h,g=.5*_,x=E=>Ei(i[E].x,i[E].y,s[E]*_),b=E=>{const A=p.get(is.computePosHash(i[E])),P=A.from,L=A.to;if(!P||!L)return;const k=x(P),j=x(E),G=x(L),R=Ei(0,0,0);if(!rs(k,j)){const q=Br(Si(),j,k);zr(R,R,mr(q,q))}if(!rs(G,j)){const q=Br(Si(),G,j);zr(R,R,mr(q,q))}const N=Ws(R);return N>0?rr(R,R,1/N):void 0};let w=Number.POSITIVE_INFINITY;this.sortSubarray(a,u.min,u.max,(E,A)=>E.featureInfo.featureIndex-A.featureInfo.featureIndex);for(let E=u.min;E<u.max;E++){const A=a[E];if(!A.featureInfo.guardRailEnabled)continue;const P=this.prepareEdgePoints(i,s,A,(Xt,Et)=>Xt>Et);if(P==null)continue;const L=P[0],k=P[1],j=Ei(L.coord.x,L.coord.y,_*L.height),G=Ei(k.coord.x,k.coord.y,_*k.height);if(rs(j,G))continue;const R=Br(Si(),G,j);mr(R,R);const N=Xt=>mr(Xt,Xt),q=b(A.a)||R,Z=b(A.b)||R,ae=N(Ei(q[1],-q[0],0)),ne=N(Ei(Z[1],-Z[0],0)),ce=N($i(Si(),ae,q)),me=N($i(Si(),ne,Z)),Re=Si(),Xe=[zr(Si(),j,rr(Re,Br(Re,ae,ce),g)),zr(Si(),j,rr(Re,zr(Re,ae,ce),g)),zr(Si(),j,rr(Re,ce,g)),j],Ve=[zr(Si(),G,rr(Re,Br(Re,ne,me),g)),zr(Si(),G,rr(Re,zr(Re,ne,me),g)),zr(Si(),G,rr(Re,me,g)),G];w=this.addFeatureSection(A.featureInfo.featureIndex,w,this.bridgeFeatureSections,e);const[We,Ke]=e.addVertices(ae,h,Xe[0],Xe[1]),[Le,He]=e.addVertices(ne,h,Ve[0],Ve[1]);e.addTriangles([We,Ke,Le,Ke,He,Le]);const[Me,ze]=e.addVertices(ce,h,Xe[1],Xe[2]),[et,it]=e.addVertices(me,h,Ve[1],Ve[2]);e.addTriangles([Me,ze,et,ze,it,et]);const[Ot,At]=e.addVertices(Zs(ae,ae),h,Xe[2],Xe[3]),[pt,Qe]=e.addVertices(Zs(ne,ne),h,Ve[2],Ve[3]);e.addTriangles([Ot,At,pt,At,Qe,pt])}this.bridgeFeatureSections.push({featureIndex:Number.POSITIVE_INFINITY,vertexStart:e.getVertexCount()})}constructTunnelStructures(e,i,s,a,u,h){e.clearVertexLookup();let p=Number.POSITIVE_INFINITY;const _=(x,b)=>x.featureInfo.featureIndex-b.featureInfo.featureIndex;this.sortSubarray(a,u.min,u.max,_),this.sortSubarray(a,h.min,h.max,_);const g=x=>mr(x,x);for(let x=u.min;x<u.max;x++){const b=this.prepareEdgePoints(i,s,a[x],(P,L)=>P<L);if(b==null)continue;const[w,E]=b,A=g(Ei(-(E.coord.y-w.coord.y),E.coord.x-w.coord.x,0));p=this.addFeatureSection(a[x].featureInfo.featureIndex,p,this.tunnelFeatureSections,e),e.addQuad([w,E,{coord:E.coord,height:a[x].isTunnel?-.1:0},{coord:w.coord,height:a[x].isTunnel?-.1:0}],A)}for(let x=h.min;x<h.max;x++){const b=a[x];b.isTunnel&&([b.a,b.b]=[b.b,b.a]);const w=i[b.a],E=i[b.b],A=g(Ei(-(E.y-w.y),E.x-w.x,0));p=this.addFeatureSection(b.featureInfo.featureIndex,p,this.tunnelFeatureSections,e),e.addQuad([{coord:E,height:0},{coord:w,height:0},{coord:w,height:s[b.a]+4},{coord:E,height:s[b.b]+4}],A),e.addQuad([{coord:w,height:0},{coord:E,height:0},{coord:E,height:s[b.b]+4},{coord:w,height:s[b.a]+4}],A)}this.tunnelFeatureSections.push({featureIndex:Number.POSITIVE_INFINITY,vertexStart:e.getVertexCount()})}prepareEdgePoints(e,i,s,a){let u=i[s.a],h=i[s.b];const p=a(u,0),_=a(h,0);if(p&&_)return[{coord:e[s.a],height:u},{coord:e[s.b],height:h}];if(!p&&!_)return;const g=e[s.a].clone(),x=e[s.b].clone();if(p){if(!_){const b=h/(h-u);x.x=Ut(x.x,g.x,b),x.y=Ut(x.y,g.y,b),h=Ut(h,u,b)}}else{const b=u/(u-h);g.x=Ut(g.x,x.x,b),g.y=Ut(g.y,x.y,b),u=Ut(u,h,b)}return[{coord:g,height:u},{coord:x,height:h}]}prepareEdges(e,i){if(i.length===0)return;i.sort((p,_)=>p.hash===_.hash?_.polygonIdx-p.polygonIdx:_.hash>p.hash?1:-1);let s=0,a=0,u=0,h=i[s].polygonIdx;do a++,(a===i.length||i[s].hash!==i[a].hash)&&((a-s==1||i[a-1].polygonIdx!==h)&&(u<s&&(i[u]=i[s],i[s]=null),i[u].type="none",u++),s=a,s!==i.length&&(h=i[s].polygonIdx));while(s!==i.length);if(i.splice(u),i.length!==0&&e.length!==0){i.sort((g,x)=>g.portalHash<x.portalHash?1:-1);let p=0,_=0;for(;p!==i.length&&_!==e.length;){const g=i[p],x=e[_];g.portalHash>x.hash?p++:x.hash>g.portalHash?_++:(g.type=x.type,p++)}}}isOnBorder(e,i){return e<=0&&i<=0||e>=dt&&i>=dt}addFeatureSection(e,i,s,a){return e!==i&&(i=e,s.push({featureIndex:e,vertexStart:a.getVertexCount()}),a.clearVertexLookup()),i}sortSubarray(e,i,s,a){const u=e.slice(i,s);u.sort(a),e.splice(i,u.length,...u)}static computeEdgeHash(e,i){return(e.y===i.y&&e.x>i.x||e.y>i.y)&&([e,i]=[i,e]),BigInt(is.computePosHash(e))<<32n|BigInt(is.computePosHash(i))}static computePosHash(e){return((65535&e.x)<<16|65535&e.y)>>>0}}var Qg,ey={exports:{}},ty=(Qg||(Qg=1,function(r,e){(function(i){function s($,W){return $>W?1:$<W?-1:0}var a=function($,W){$===void 0&&($=s),W===void 0&&(W=!1),this._compare=$,this._root=null,this._size=0,this._noDuplicates=!!W},u={size:{configurable:!0}};function h($,W,De,lt,mt){var ft=mt-lt;if(ft>0){var St=lt+Math.floor(ft/2),Vt={key:W[St],data:De[St],parent:$};return Vt.left=h(Vt,W,De,lt,St),Vt.right=h(Vt,W,De,St+1,mt),Vt}return null}function p($,W,De,lt,mt){if(!(De>=lt)){for(var ft=$[De+lt>>1],St=De-1,Vt=lt+1;;){do St++;while(mt($[St],ft)<0);do Vt--;while(mt($[Vt],ft)>0);if(St>=Vt)break;var hi=$[St];$[St]=$[Vt],$[Vt]=hi,hi=W[St],W[St]=W[Vt],W[Vt]=hi}p($,W,De,Vt,mt),p($,W,Vt+1,lt,mt)}}a.prototype.rotateLeft=function($){var W=$.right;W&&($.right=W.left,W.left&&(W.left.parent=$),W.parent=$.parent),$.parent?$===$.parent.left?$.parent.left=W:$.parent.right=W:this._root=W,W&&(W.left=$),$.parent=W},a.prototype.rotateRight=function($){var W=$.left;W&&($.left=W.right,W.right&&(W.right.parent=$),W.parent=$.parent),$.parent?$===$.parent.left?$.parent.left=W:$.parent.right=W:this._root=W,W&&(W.right=$),$.parent=W},a.prototype._splay=function($){for(;$.parent;){var W=$.parent;W.parent?W.left===$&&W.parent.left===W?(this.rotateRight(W.parent),this.rotateRight(W)):W.right===$&&W.parent.right===W?(this.rotateLeft(W.parent),this.rotateLeft(W)):W.left===$&&W.parent.right===W?(this.rotateRight(W),this.rotateLeft(W)):(this.rotateLeft(W),this.rotateRight(W)):W.left===$?this.rotateRight(W):this.rotateLeft(W)}},a.prototype.splay=function($){for(var W,De,lt,mt,ft;$.parent;)(De=(W=$.parent).parent)&&De.parent?((lt=De.parent).left===De?lt.left=$:lt.right=$,$.parent=lt):($.parent=null,this._root=$),mt=$.left,ft=$.right,$===W.left?(De&&(De.left===W?(W.right?(De.left=W.right,De.left.parent=De):De.left=null,W.right=De,De.parent=W):(mt?(De.right=mt,mt.parent=De):De.right=null,$.left=De,De.parent=$)),ft?(W.left=ft,ft.parent=W):W.left=null,$.right=W,W.parent=$):(De&&(De.right===W?(W.left?(De.right=W.left,De.right.parent=De):De.right=null,W.left=De,De.parent=W):(ft?(De.left=ft,ft.parent=De):De.left=null,$.right=De,De.parent=$)),mt?(W.right=mt,mt.parent=W):W.right=null,$.left=W,W.parent=$)},a.prototype.replace=function($,W){$.parent?$===$.parent.left?$.parent.left=W:$.parent.right=W:this._root=W,W&&(W.parent=$.parent)},a.prototype.minNode=function($){if($===void 0&&($=this._root),$)for(;$.left;)$=$.left;return $},a.prototype.maxNode=function($){if($===void 0&&($=this._root),$)for(;$.right;)$=$.right;return $},a.prototype.insert=function($,W){var De=this._root,lt=null,mt=this._compare;if(this._noDuplicates)for(;De;){if(lt=De,mt(De.key,$)===0)return;De=mt(De.key,$)<0?De.right:De.left}else for(;De;)lt=De,De=mt(De.key,$)<0?De.right:De.left;return De={key:$,data:W,left:null,right:null,parent:lt},lt?mt(lt.key,De.key)<0?lt.right=De:lt.left=De:this._root=De,this.splay(De),this._size++,De},a.prototype.find=function($){for(var W=this._root,De=this._compare;W;){var lt=De(W.key,$);if(lt<0)W=W.right;else{if(!(lt>0))return W;W=W.left}}return null},a.prototype.contains=function($){for(var W=this._root,De=this._compare;W;){var lt=De($,W.key);if(lt===0)return!0;W=lt<0?W.left:W.right}return!1},a.prototype.remove=function($){var W=this.find($);if(!W)return!1;if(this.splay(W),W.left)if(W.right){var De=this.minNode(W.right);De.parent!==W&&(this.replace(De,De.right),De.right=W.right,De.right.parent=De),this.replace(W,De),De.left=W.left,De.left.parent=De}else this.replace(W,W.left);else this.replace(W,W.right);return this._size--,!0},a.prototype.removeNode=function($){if(!$)return!1;if(this.splay($),$.left)if($.right){var W=this.minNode($.right);W.parent!==$&&(this.replace(W,W.right),W.right=$.right,W.right.parent=W),this.replace($,W),W.left=$.left,W.left.parent=W}else this.replace($,$.left);else this.replace($,$.right);return this._size--,!0},a.prototype.erase=function($){var W=this.find($);if(W){this.splay(W);var De=W.left,lt=W.right,mt=null;De&&(De.parent=null,mt=this.maxNode(De),this.splay(mt),this._root=mt),lt&&(De?mt.right=lt:this._root=lt,lt.parent=mt),this._size--}},a.prototype.pop=function(){var $=this._root,W=null;if($){for(;$.left;)$=$.left;W={key:$.key,data:$.data},this.remove($.key)}return W},a.prototype.next=function($){var W=$;if(W)if(W.right)for(W=W.right;W&&W.left;)W=W.left;else for(W=$.parent;W&&W.right===$;)$=W,W=W.parent;return W},a.prototype.prev=function($){var W=$;if(W)if(W.left)for(W=W.left;W&&W.right;)W=W.right;else for(W=$.parent;W&&W.left===$;)$=W,W=W.parent;return W},a.prototype.forEach=function($){for(var W=this._root,De=[],lt=!1,mt=0;!lt;)W?(De.push(W),W=W.left):De.length>0?($(W=De.pop(),mt++),W=W.right):lt=!0;return this},a.prototype.range=function($,W,De,lt){for(var mt=[],ft=this._compare,St=this._root;mt.length!==0||St;)if(St)mt.push(St),St=St.left;else{if(ft((St=mt.pop()).key,W)>0)break;if(ft(St.key,$)>=0&&De.call(lt,St))return this;St=St.right}return this},a.prototype.keys=function(){for(var $=this._root,W=[],De=[],lt=!1;!lt;)$?(W.push($),$=$.left):W.length>0?($=W.pop(),De.push($.key),$=$.right):lt=!0;return De},a.prototype.values=function(){for(var $=this._root,W=[],De=[],lt=!1;!lt;)$?(W.push($),$=$.left):W.length>0?($=W.pop(),De.push($.data),$=$.right):lt=!0;return De},a.prototype.at=function($){for(var W=this._root,De=[],lt=!1,mt=0;!lt;)if(W)De.push(W),W=W.left;else if(De.length>0){if(W=De.pop(),mt===$)return W;mt++,W=W.right}else lt=!0;return null},a.prototype.load=function($,W,De){if($===void 0&&($=[]),W===void 0&&(W=[]),De===void 0&&(De=!1),this._size!==0)throw new Error("bulk-load: tree is not empty");var lt=$.length;return De&&p($,W,0,lt-1,this._compare),this._root=h(null,$,W,0,lt),this._size=lt,this},a.prototype.min=function(){var $=this.minNode(this._root);return $?$.key:null},a.prototype.max=function(){var $=this.maxNode(this._root);return $?$.key:null},a.prototype.isEmpty=function(){return this._root===null},u.size.get=function(){return this._size},a.createTree=function($,W,De,lt,mt){return new a(De,mt).load($,W,lt)},Object.defineProperties(a.prototype,u);var _=0,g=1,x=2,b=3,w=0,E=1,A=2,P=3;function L($,W,De){W===null?($.inOut=!1,$.otherInOut=!0):($.isSubject===W.isSubject?($.inOut=!W.inOut,$.otherInOut=W.otherInOut):($.inOut=!W.otherInOut,$.otherInOut=W.isVertical()?!W.inOut:W.inOut),W&&($.prevInResult=!k(W,De)||W.isVertical()?W.prevInResult:W));var lt=k($,De);$.resultTransition=lt?function(mt,ft){var St,Vt=!mt.inOut,hi=!mt.otherInOut;switch(ft){case w:St=Vt&&hi;break;case E:St=Vt||hi;break;case P:St=Vt^hi;break;case A:St=mt.isSubject?Vt&&!hi:hi&&!Vt}return St?1:-1}($,De):0}function k($,W){switch($.type){case _:switch(W){case w:return!$.otherInOut;case E:return $.otherInOut;case A:return $.isSubject&&$.otherInOut||!$.isSubject&&!$.otherInOut;case P:return!0}break;case x:return W===w||W===E;case b:return W===A;case g:return!1}return!1}var j=function($,W,De,lt,mt){this.left=W,this.point=$,this.otherEvent=De,this.isSubject=lt,this.type=mt||_,this.inOut=!1,this.otherInOut=!1,this.prevInResult=null,this.resultTransition=0,this.otherPos=-1,this.outputContourId=-1,this.isExteriorRing=!0},G={inResult:{configurable:!0}};function R($,W){return $[0]===W[0]&&$[1]===W[1]}j.prototype.isBelow=function($){var W=this.point,De=this.otherEvent.point;return this.left?(W[0]-$[0])*(De[1]-$[1])-(De[0]-$[0])*(W[1]-$[1])>0:(De[0]-$[0])*(W[1]-$[1])-(W[0]-$[0])*(De[1]-$[1])>0},j.prototype.isAbove=function($){return!this.isBelow($)},j.prototype.isVertical=function(){return this.point[0]===this.otherEvent.point[0]},G.inResult.get=function(){return this.resultTransition!==0},j.prototype.clone=function(){var $=new j(this.point,this.left,this.otherEvent,this.isSubject,this.type);return $.contourId=this.contourId,$.resultTransition=this.resultTransition,$.prevInResult=this.prevInResult,$.isExteriorRing=this.isExteriorRing,$.inOut=this.inOut,$.otherInOut=this.otherInOut,$},Object.defineProperties(j.prototype,G);var N=11102230246251565e-32,q=134217729,Z=(3+8*N)*N;function ae($,W,De,lt,mt){var ft,St,Vt,hi,di=W[0],ri=lt[0],Bi=0,Xi=0;ri>di==ri>-di?(ft=di,di=W[++Bi]):(ft=ri,ri=lt[++Xi]);var fi=0;if(Bi<$&&Xi<De)for(ri>di==ri>-di?(Vt=ft-((St=di+ft)-di),di=W[++Bi]):(Vt=ft-((St=ri+ft)-ri),ri=lt[++Xi]),ft=St,Vt!==0&&(mt[fi++]=Vt);Bi<$&&Xi<De;)ri>di==ri>-di?(Vt=ft-((St=ft+di)-(hi=St-ft))+(di-hi),di=W[++Bi]):(Vt=ft-((St=ft+ri)-(hi=St-ft))+(ri-hi),ri=lt[++Xi]),ft=St,Vt!==0&&(mt[fi++]=Vt);for(;Bi<$;)Vt=ft-((St=ft+di)-(hi=St-ft))+(di-hi),di=W[++Bi],ft=St,Vt!==0&&(mt[fi++]=Vt);for(;Xi<De;)Vt=ft-((St=ft+ri)-(hi=St-ft))+(ri-hi),ri=lt[++Xi],ft=St,Vt!==0&&(mt[fi++]=Vt);return ft===0&&fi!==0||(mt[fi++]=ft),fi}function ne($){return new Float64Array($)}var ce=33306690738754716e-32,me=22204460492503146e-32,Re=11093356479670487e-47,Xe=ne(4),Ve=ne(8),We=ne(12),Ke=ne(16),Le=ne(4);function He($,W,De){var lt=function(mt,ft,St,Vt,hi,di){var ri=(ft-di)*(St-hi),Bi=(mt-hi)*(Vt-di),Xi=ri-Bi;if(ri===0||Bi===0||ri>0!=Bi>0)return Xi;var fi=Math.abs(ri+Bi);return Math.abs(Xi)>=ce*fi?Xi:-function(yr,tr,Di,Pr,ar,Yi,ir){var Ui,si,qi,vr,Bt,_i,lr,Er,fr,Gr,Hi,Ur,Fn,sn,rn,Bn,Eo,qr,Hr=yr-ar,on=Di-ar,Tn=tr-Yi,dn=Pr-Yi;Xe[0]=(rn=(Er=Hr-(lr=(_i=q*Hr)-(_i-Hr)))*(Gr=dn-(fr=(_i=q*dn)-(_i-dn)))-((sn=Hr*dn)-lr*fr-Er*fr-lr*Gr))-((Hi=rn-(Eo=(Er=Tn-(lr=(_i=q*Tn)-(_i-Tn)))*(Gr=on-(fr=(_i=q*on)-(_i-on)))-((Bn=Tn*on)-lr*fr-Er*fr-lr*Gr)))+(Bt=rn-Hi))+(Bt-Eo),Xe[1]=(Fn=sn-((Ur=sn+Hi)-(Bt=Ur-sn))+(Hi-Bt))-((Hi=Fn-Bn)+(Bt=Fn-Hi))+(Bt-Bn),Xe[2]=Ur-((qr=Ur+Hi)-(Bt=qr-Ur))+(Hi-Bt),Xe[3]=qr;var Qa=function(TE,u0){for(var h0=u0[0],z_=1;z_<4;z_++)h0+=u0[z_];return h0}(0,Xe),Td=me*ir;if(Qa>=Td||-Qa>=Td||(Ui=yr-(Hr+(Bt=yr-Hr))+(Bt-ar),qi=Di-(on+(Bt=Di-on))+(Bt-ar),si=tr-(Tn+(Bt=tr-Tn))+(Bt-Yi),vr=Pr-(dn+(Bt=Pr-dn))+(Bt-Yi),Ui===0&&si===0&&qi===0&&vr===0)||(Td=Re*ir+Z*Math.abs(Qa),(Qa+=Hr*vr+dn*Ui-(Tn*qi+on*si))>=Td||-Qa>=Td))return Qa;Le[0]=(rn=(Er=Ui-(lr=(_i=q*Ui)-(_i-Ui)))*(Gr=dn-(fr=(_i=q*dn)-(_i-dn)))-((sn=Ui*dn)-lr*fr-Er*fr-lr*Gr))-((Hi=rn-(Eo=(Er=si-(lr=(_i=q*si)-(_i-si)))*(Gr=on-(fr=(_i=q*on)-(_i-on)))-((Bn=si*on)-lr*fr-Er*fr-lr*Gr)))+(Bt=rn-Hi))+(Bt-Eo),Le[1]=(Fn=sn-((Ur=sn+Hi)-(Bt=Ur-sn))+(Hi-Bt))-((Hi=Fn-Bn)+(Bt=Fn-Hi))+(Bt-Bn),Le[2]=Ur-((qr=Ur+Hi)-(Bt=qr-Ur))+(Hi-Bt),Le[3]=qr;var C2=ae(4,Xe,4,Le,Ve);Le[0]=(rn=(Er=Hr-(lr=(_i=q*Hr)-(_i-Hr)))*(Gr=vr-(fr=(_i=q*vr)-(_i-vr)))-((sn=Hr*vr)-lr*fr-Er*fr-lr*Gr))-((Hi=rn-(Eo=(Er=Tn-(lr=(_i=q*Tn)-(_i-Tn)))*(Gr=qi-(fr=(_i=q*qi)-(_i-qi)))-((Bn=Tn*qi)-lr*fr-Er*fr-lr*Gr)))+(Bt=rn-Hi))+(Bt-Eo),Le[1]=(Fn=sn-((Ur=sn+Hi)-(Bt=Ur-sn))+(Hi-Bt))-((Hi=Fn-Bn)+(Bt=Fn-Hi))+(Bt-Bn),Le[2]=Ur-((qr=Ur+Hi)-(Bt=qr-Ur))+(Hi-Bt),Le[3]=qr;var M2=ae(C2,Ve,4,Le,We);Le[0]=(rn=(Er=Ui-(lr=(_i=q*Ui)-(_i-Ui)))*(Gr=vr-(fr=(_i=q*vr)-(_i-vr)))-((sn=Ui*vr)-lr*fr-Er*fr-lr*Gr))-((Hi=rn-(Eo=(Er=si-(lr=(_i=q*si)-(_i-si)))*(Gr=qi-(fr=(_i=q*qi)-(_i-qi)))-((Bn=si*qi)-lr*fr-Er*fr-lr*Gr)))+(Bt=rn-Hi))+(Bt-Eo),Le[1]=(Fn=sn-((Ur=sn+Hi)-(Bt=Ur-sn))+(Hi-Bt))-((Hi=Fn-Bn)+(Bt=Fn-Hi))+(Bt-Bn),Le[2]=Ur-((qr=Ur+Hi)-(Bt=qr-Ur))+(Hi-Bt),Le[3]=qr;var P2=ae(M2,We,4,Le,Ke);return Ke[P2-1]}(mt,ft,St,Vt,hi,di,fi)}($[0],$[1],W[0],W[1],De[0],De[1]);return lt>0?-1:lt<0?1:0}function Me($,W){var De=$.point,lt=W.point;return De[0]>lt[0]?1:De[0]<lt[0]?-1:De[1]!==lt[1]?De[1]>lt[1]?1:-1:function(mt,ft,St,Vt){return mt.left!==ft.left?mt.left?1:-1:He(St,mt.otherEvent.point,ft.otherEvent.point)!==0?mt.isBelow(ft.otherEvent.point)?-1:1:!mt.isSubject&&ft.isSubject?1:-1}($,W,De)}function ze($,W,De){var lt=new j(W,!1,$,$.isSubject),mt=new j(W,!0,$.otherEvent,$.isSubject);return R($.point,$.otherEvent.point)&&console.warn("what is that, a collapsed segment?",$),lt.contourId=mt.contourId=$.contourId,Me(mt,$.otherEvent)>0&&($.otherEvent.left=!0,mt.left=!1),$.otherEvent.otherEvent=mt,$.otherEvent=lt,De.push(mt),De.push(lt),De}function et($,W){return $[0]*W[1]-$[1]*W[0]}function it($,W){return $[0]*W[0]+$[1]*W[1]}function Ot($,W,De){var lt=function(hi,di,ri,Bi,Xi){var fi=[di[0]-hi[0],di[1]-hi[1]],yr=[Bi[0]-ri[0],Bi[1]-ri[1]];function tr(_i,lr,Er){return[_i[0]+lr*Er[0],_i[1]+lr*Er[1]]}var Di=[ri[0]-hi[0],ri[1]-hi[1]],Pr=et(fi,yr),ar=Pr*Pr,Yi=it(fi,fi);if(ar>0){var ir=et(Di,yr)/Pr;if(ir<0||ir>1)return null;var Ui=et(Di,fi)/Pr;return Ui<0||Ui>1?null:ir===0||ir===1?[tr(hi,ir,fi)]:Ui===0||Ui===1?[tr(ri,Ui,yr)]:[tr(hi,ir,fi)]}if((ar=(Pr=et(Di,fi))*Pr)>0)return null;var si=it(fi,Di)/Yi,qi=si+it(fi,yr)/Yi,vr=Math.min(si,qi),Bt=Math.max(si,qi);return vr<=1&&Bt>=0?vr===1?[tr(hi,vr>0?vr:0,fi)]:Bt===0?[tr(hi,Bt<1?Bt:1,fi)]:[tr(hi,vr>0?vr:0,fi),tr(hi,Bt<1?Bt:1,fi)]:null}($.point,$.otherEvent.point,W.point,W.otherEvent.point),mt=lt?lt.length:0;if(mt===0||mt===1&&(R($.point,W.point)||R($.otherEvent.point,W.otherEvent.point))||mt===2&&$.isSubject===W.isSubject)return 0;if(mt===1)return R($.point,lt[0])||R($.otherEvent.point,lt[0])||ze($,lt[0],De),R(W.point,lt[0])||R(W.otherEvent.point,lt[0])||ze(W,lt[0],De),1;var ft=[],St=!1,Vt=!1;return R($.point,W.point)?St=!0:Me($,W)===1?ft.push(W,$):ft.push($,W),R($.otherEvent.point,W.otherEvent.point)?Vt=!0:Me($.otherEvent,W.otherEvent)===1?ft.push(W.otherEvent,$.otherEvent):ft.push($.otherEvent,W.otherEvent),St&&Vt||St?(W.type=g,$.type=W.inOut===$.inOut?x:b,St&&!Vt&&ze(ft[1].otherEvent,ft[0].point,De),2):Vt?(ze(ft[0],ft[1].point,De),3):ft[0]!==ft[3].otherEvent?(ze(ft[0],ft[1].point,De),ze(ft[1],ft[2].point,De),3):(ze(ft[0],ft[1].point,De),ze(ft[3].otherEvent,ft[2].point,De),3)}function At($,W){if($===W)return 0;if(He($.point,$.otherEvent.point,W.point)!==0||He($.point,$.otherEvent.point,W.otherEvent.point)!==0)return R($.point,W.point)?$.isBelow(W.otherEvent.point)?-1:1:$.point[0]===W.point[0]?$.point[1]<W.point[1]?-1:1:Me($,W)===1?W.isAbove($.point)?-1:1:$.isBelow(W.point)?-1:1;if($.isSubject!==W.isSubject)return $.isSubject?-1:1;var De=$.point,lt=W.point;return De[0]===lt[0]&&De[1]===lt[1]?(De=$.otherEvent.point)[0]===(lt=W.otherEvent.point)[0]&&De[1]===lt[1]?0:$.contourId>W.contourId?1:-1:Me($,W)===1?1:-1}var pt=function(){this.points=[],this.holeIds=[],this.holeOf=null,this.depth=null};function Qe($,W,De,lt){var mt,ft=$+1,St=W[$].point,Vt=W.length;for(ft<Vt&&(mt=W[ft].point);ft<Vt&&mt[0]===St[0]&&mt[1]===St[1];){if(!De[ft])return ft;++ft<Vt&&(mt=W[ft].point)}for(ft=$-1;De[ft]&&ft>lt;)ft--;return ft}pt.prototype.isExterior=function(){return this.holeOf==null};var Xt=Mt,Et=Mt;function Mt($,W){if(!(this instanceof Mt))return new Mt($,W);if(this.data=$||[],this.length=this.data.length,this.compare=W||jt,this.length>0)for(var De=(this.length>>1)-1;De>=0;De--)this._down(De)}function jt($,W){return $<W?-1:$>W?1:0}Mt.prototype={push:function($){this.data.push($),this.length++,this._up(this.length-1)},pop:function(){if(this.length!==0){var $=this.data[0];return this.length--,this.length>0&&(this.data[0]=this.data[this.length],this._down(0)),this.data.pop(),$}},peek:function(){return this.data[0]},_up:function($){for(var W=this.data,De=this.compare,lt=W[$];$>0;){var mt=$-1>>1,ft=W[mt];if(De(lt,ft)>=0)break;W[$]=ft,$=mt}W[$]=lt},_down:function($){for(var W=this.data,De=this.compare,lt=this.length>>1,mt=W[$];$<lt;){var ft=1+($<<1),St=ft+1,Vt=W[ft];if(St<this.length&&De(W[St],Vt)<0&&(ft=St,Vt=W[St]),De(Vt,mt)>=0)break;W[$]=Vt,$=ft}W[$]=mt}},Xt.default=Et;var Qt=Math.max,Jt=Math.min,ai=0;function ii($,W,De,lt,mt,ft){var St,Vt,hi,di,ri,Bi;for(St=0,Vt=$.length-1;St<Vt;St++)if(di=$[St+1],ri=new j(hi=$[St],!1,void 0,W),Bi=new j(di,!1,ri,W),ri.otherEvent=Bi,hi[0]!==di[0]||hi[1]!==di[1]){ri.contourId=Bi.contourId=De,ft||(ri.isExteriorRing=!1,Bi.isExteriorRing=!1),Me(ri,Bi)>0?Bi.left=!0:ri.left=!0;var Xi=hi[0],fi=hi[1];mt[0]=Jt(mt[0],Xi),mt[1]=Jt(mt[1],fi),mt[2]=Qt(mt[2],Xi),mt[3]=Qt(mt[3],fi),lt.push(ri),lt.push(Bi)}}var li=[];function Li($,W,De){typeof $[0][0][0]=="number"&&($=[$]),typeof W[0][0][0]=="number"&&(W=[W]);var lt=function(fi,yr,tr){var Di=null;return fi.length*yr.length==0&&(tr===w?Di=li:tr===A?Di=fi:tr!==E&&tr!==P||(Di=fi.length===0?yr:fi)),Di}($,W,De);if(lt)return lt===li?null:lt;var mt=[1/0,1/0,-1/0,-1/0],ft=[1/0,1/0,-1/0,-1/0],St=function(fi,yr,tr,Di,Pr){var ar,Yi,ir,Ui,si,qi,vr=new Xt(null,Me);for(ir=0,Ui=fi.length;ir<Ui;ir++)for(si=0,qi=(ar=fi[ir]).length;si<qi;si++)(Yi=si===0)&&ai++,ii(ar[si],!0,ai,vr,tr,Yi);for(ir=0,Ui=yr.length;ir<Ui;ir++)for(si=0,qi=(ar=yr[ir]).length;si<qi;si++)Yi=si===0,Pr===A&&(Yi=!1),Yi&&ai++,ii(ar[si],!1,ai,vr,Di,Yi);return vr}($,W,mt,ft,De);if(lt=function(fi,yr,tr,Di,Pr){var ar=null;return(tr[0]>Di[2]||Di[0]>tr[2]||tr[1]>Di[3]||Di[1]>tr[3])&&(Pr===w?ar=li:Pr===A?ar=fi:Pr!==E&&Pr!==P||(ar=fi.concat(yr))),ar}($,W,mt,ft,De))return lt===li?null:lt;for(var Vt=function(fi){var yr,tr,Di=function(ir){var Ui,si,qi,vr,Bt=[];for(si=0,qi=ir.length;si<qi;si++)((Ui=ir[si]).left&&Ui.inResult||!Ui.left&&Ui.otherEvent.inResult)&&Bt.push(Ui);for(var _i=!1;!_i;)for(_i=!0,si=0,qi=Bt.length;si<qi;si++)si+1<qi&&Me(Bt[si],Bt[si+1])===1&&(vr=Bt[si],Bt[si]=Bt[si+1],Bt[si+1]=vr,_i=!1);for(si=0,qi=Bt.length;si<qi;si++)(Ui=Bt[si]).otherPos=si;for(si=0,qi=Bt.length;si<qi;si++)(Ui=Bt[si]).left||(vr=Ui.otherPos,Ui.otherPos=Ui.otherEvent.otherPos,Ui.otherEvent.otherPos=vr);return Bt}(fi),Pr={},ar=[],Yi=function(){if(!Pr[yr]){var ir=ar.length,Ui=function(Bt,_i,lr){var Er=new pt;if(Bt.prevInResult!=null){var fr=Bt.prevInResult,Gr=fr.outputContourId;if(fr.resultTransition>0){var Hi=_i[Gr];if(Hi.holeOf!=null){var Ur=Hi.holeOf;_i[Ur].holeIds.push(lr),Er.holeOf=Ur,Er.depth=_i[Gr].depth}else _i[Gr].holeIds.push(lr),Er.holeOf=Gr,Er.depth=_i[Gr].depth+1}else Er.holeOf=null,Er.depth=_i[Gr].depth}else Er.holeOf=null,Er.depth=0;return Er}(Di[yr],ar,ir),si=function(Bt){Pr[Bt]=!0,Bt<Di.length&&Di[Bt]&&(Di[Bt].outputContourId=ir)},qi=yr,vr=yr;for(Ui.points.push(Di[yr].point);si(qi),si(qi=Di[qi].otherPos),Ui.points.push(Di[qi].point),!((qi=Qe(qi,Di,Pr,vr))==vr||qi>=Di.length)&&Di[qi];);ar.push(Ui)}};for(yr=0,tr=Di.length;yr<tr;yr++)Yi();return ar}(function(fi,yr,tr,Di,Pr,ar){for(var Yi,ir,Ui,si=new a(At),qi=[],vr=Math.min(Di[2],Pr[2]);fi.length!==0;){var Bt=fi.pop();if(qi.push(Bt),ar===w&&Bt.point[0]>vr||ar===A&&Bt.point[0]>Di[2])break;if(Bt.left){ir=Yi=si.insert(Bt),Yi=Yi!==(Ui=si.minNode())?si.prev(Yi):null,ir=si.next(ir);var _i=Yi?Yi.key:null;if(L(Bt,_i,ar),ir&&Ot(Bt,ir.key,fi)===2&&(L(Bt,_i,ar),L(ir.key,Bt,ar)),Yi&&Ot(Yi.key,Bt,fi)===2){var lr=Yi;L(_i,(lr=lr!==Ui?si.prev(lr):null)?lr.key:null,ar),L(Bt,_i,ar)}}else ir=Yi=si.find(Bt=Bt.otherEvent),Yi&&ir&&(Yi=Yi!==Ui?si.prev(Yi):null,ir=si.next(ir),si.remove(Bt),ir&&Yi&&Ot(Yi.key,ir.key,fi))}return qi}(St,0,0,mt,ft,De)),hi=[],di=0;di<Vt.length;di++){var ri=Vt[di];if(ri.isExterior()){for(var Bi=[ri.points],Xi=0;Xi<ri.holeIds.length;Xi++)Bi.push(Vt[ri.holeIds[Xi]].points);hi.push(Bi)}}return hi}var er={UNION:E,DIFFERENCE:A,INTERSECTION:w,XOR:P};i.diff=function($,W){return Li($,W,A)},i.intersection=function($,W){return Li($,W,w)},i.operations=er,i.union=function($,W){return Li($,W,E)},i.xor=function($,W){return Li($,W,P)},Object.defineProperty(i,"__esModule",{value:!0})})(e)}(0,ey.exports)),ey.exports);/**
 * martinez v0.7.4
 * Martinez polygon clipping algorithm, does boolean operation on polygons (multipolygons, polygons with holes etc): intersection, union, difference, xor
 *
 * @author Alex Milevski <info@w8r.name>
 * @license MIT
 * @preserve
 */function Bf(r,e,i,s){const a=[],u=s===0?(h,p,_,g,x,b)=>{h.push(new ut(b,_+(b-p)/(g-p)*(x-_)))}:(h,p,_,g,x,b)=>{h.push(new ut(p+(b-_)/(x-_)*(g-p),b))};for(const h of r){const p=[];for(const _ of h){if(_.length<=2)continue;const g=[];for(let w=0;w<_.length-1;w++){const E=_[w].x,A=_[w].y,P=_[w+1].x,L=_[w+1].y,k=s===0?E:A,j=s===0?P:L;k<e?j>e&&u(g,E,A,P,L,e):k>i?j<i&&u(g,E,A,P,L,i):g.push(_[w]),j<e&&k>=e&&u(g,E,A,P,L,e),j>i&&k<=i&&u(g,E,A,P,L,i)}let x=_[_.length-1];const b=s===0?x.x:x.y;b>=e&&b<=i&&g.push(x),g.length&&(x=g[g.length-1],g[0].x===x.x&&g[0].y===x.y||g.push(g[0]),p.push(g))}p.length&&a.push(p)}return a}function U1(r,e){const i=Cm(r),s=Cm([e]),a=ty.intersection(i,s);return a==null?[]:iy(a)}function j1(r,e){let s=Cm(r,65536);for(;e.valid();e.next()){const[a,u]=e.get(),h=a.x*65536,p=a.y*65536,_=u.x*65536,g=u.y*65536,x=_-h,b=g-p,w=Math.hypot(x,b),E=Math.trunc(b/w*3),A=-Math.trunc(x/w*3);s=ty.diff(s,[[[h,p],[_,g],[_+E,g+A],[h+E,p+A],[h,p]]])}return iy(s,1/65536)}function Cm(r,e=1){return[r.map(i=>i.map(s=>[s.x*e,s.y*e]))]}function iy(r,e=1){return r.map(i=>i.map((s,a)=>{const u=s.map(h=>new ut(h[0]*e,h[1]*e).round());return a>0&&u.reverse(),u}))}class Mm{constructor(e,i){this.layoutVertexArray=new Ns,this.indexArray=new en,this.lineIndexArray=new go,this.triangleSegments=new Tr,this.lineSegments=new Tr,this.programConfigurations=new l(e.layers,{zoom:e.zoom,lut:e.lut}),this.uploaded=!1,i&&(this.elevatedLayoutVertexArray=new mo)}update(e,i,s,a,u,h,p,_){this.programConfigurations.updatePaintArrays(e,i,u,s,a,h,p,_)}isEmpty(){return this.layoutVertexArray.length===0}needsUpload(){return this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,I1.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.lineIndexBuffer=e.createIndexBuffer(this.lineIndexArray),this.elevatedLayoutVertexArray&&this.elevatedLayoutVertexArray.length>0&&(this.elevatedLayoutVertexBuffer=e.createVertexBuffer(this.elevatedLayoutVertexArray,A1.members))),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.elevatedLayoutVertexBuffer&&this.elevatedLayoutVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.lineIndexBuffer.destroy(),this.programConfigurations.destroy(),this.triangleSegments.destroy(),this.lineSegments.destroy())}populatePaintArrays(e,i,s,a,u,h,p){this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,i,s,a,u,h,void 0,p)}}class Pm{constructor(e){this.zoom=e.zoom,this.pixelRatio=e.pixelRatio,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.hasPattern=!1,this.patternFeatures=[],this.lut=e.lut,this.bufferData=new Mm(e,!1),this.elevationBufferData=new Mm(e,!0),this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.projection=e.projection,this.elevationMode=this.layers[0].layout.get("fill-elevation-reference"),this.sourceLayerIndex=e.sourceLayerIndex,this.worldview=e.worldview}updateFootprints(e,i){}populate(e,i,s,a){this.hasPattern=Im("fill",this.layers,this.pixelRatio,i);const u=this.layers[0].layout.get("fill-sort-key"),h=[];for(const{feature:p,id:_,index:g,sourceLayerIndex:x}of e){const b=this.layers[0]._featureFilter.needGeometry,w=gt(p,b);if(!this.layers[0]._featureFilter.filter(new Gi(this.zoom,{worldview:this.worldview}),w,s))continue;const E=u?u.evaluate(w,{},s,i.availableImages):void 0,A={id:_,properties:p.properties,type:p.type,sourceLayerIndex:x,index:g,geometry:b?w.geometry:Tt(p,s,a),patterns:{},sortKey:E};h.push(A)}u&&h.sort((p,_)=>p.sortKey-_.sortKey);for(const p of h){const{geometry:_,index:g,sourceLayerIndex:x}=p;if(this.hasPattern){const b=Am("fill",this.layers,p,this.zoom,this.pixelRatio,i);this.patternFeatures.push(b)}else this.addFeature(p,_,g,s,{},i.availableImages,i.brightness,i.elevationFeatures);i.featureIndex.insert(e[g].feature,_,g,x,this.index)}}update(e,i,s,a,u,h,p){this.bufferData.update(e,i,s,a,u,h,p,this.worldview),this.elevationBufferData.update(e,i,s,a,u,h,p,this.worldview),this.elevatedStructures&&this.elevatedStructures.update(e,i,s,a,u,h,p,this.worldview)}addFeatures(e,i,s,a,u,h){for(const p of this.patternFeatures)this.addFeature(p,p.geometry,p.index,i,s,a,h,e.elevationFeatures)}isEmpty(){return this.bufferData.isEmpty()&&this.elevationBufferData.isEmpty()}uploadPending(){return!this.uploaded||this.bufferData.needsUpload()||this.elevationBufferData.needsUpload()}upload(e){this.bufferData.upload(e),this.elevationBufferData.upload(e),this.elevatedStructures&&this.elevatedStructures.upload(e)}destroy(){this.bufferData.destroy(),this.elevationBufferData.destroy(),this.elevatedStructures&&this.elevatedStructures.destroy()}addFeature(e,i,s,a,u,h=[],p,_){const g=Ff(i,500);this.elevationMode!=="none"?this.addElevatedRoadFeature(e,g,a,s,_):this.addGeometry(g,this.bufferData),this.bufferData.populatePaintArrays(e,s,u,h,a,p,this.worldview),this.elevationBufferData.populatePaintArrays(e,s,u,h,a,p,this.worldview)}getUnevaluatedPortalGraph(){return this.elevatedStructures?this.elevatedStructures.unevaluatedPortals:void 0}getElevationPolygons(){return this.elevatedStructures?this.elevatedStructures.portalPolygons:void 0}setEvaluatedPortalGraph(e,i,s,a,u){this.elevatedStructures&&(this.elevatedStructures.construct(e),this.elevatedStructures.populatePaintArrays(i,s,a,u,this.worldview))}addElevatedRoadFeature(e,i,s,a,u){const h=new Array,p=Hn.getElevationFeature(e,u);if(!p)return void this.addGeometry(i,this.bufferData);{const g=this.clipPolygonsToTile(i,1);g.length>0&&h.push({polygons:g,elevationFeature:p,elevationTileID:s})}const _={guardRailEnabled:this.layers[0].layout.get("fill-construct-bridge-guard-rail").evaluate(e,{},s),featureIndex:a};for(const g of h)if(g.elevationFeature){if(this.elevationMode==="hd-road-base"){this.elevatedStructures||(this.elevatedStructures=new is(g.elevationTileID,this.layers,this.zoom,this.lut));const b=g.elevationFeature.isTunnel();let w=0;e.properties.hasOwnProperty(nr)&&(w=+e.properties[nr]);for(const E of g.polygons)this.elevatedStructures.addPortalCandidates(g.elevationFeature.id,E,b,g.elevationFeature,w)}g.elevationFeature.constantHeight==null&&(g.polygons=this.prepareElevatedPolygons(g.polygons,g.elevationFeature,g.elevationTileID));const x=new us(s,g.elevationTileID);this.addElevatedGeometry(g.polygons,x,g.elevationFeature,this.elevationMode==="hd-road-base"?0:.05,a,_)}}addElevatedGeometry(e,i,s,a,u,h){const p={elevation:s,elevationSampler:i,bias:a,index:u,featureInfo:h},[_,g]=this.addGeometry(e,this.elevationBufferData,p);this.elevationBufferData.heightRange==null?this.elevationBufferData.heightRange={min:_,max:g}:(this.elevationBufferData.heightRange.min=Math.min(this.elevationBufferData.heightRange.min,_),this.elevationBufferData.heightRange.max=Math.max(this.elevationBufferData.heightRange.max,g))}addGeometry(e,i,s){let a=Number.POSITIVE_INFINITY,u=Number.NEGATIVE_INFINITY,h=null;s&&(h=s.elevationSampler.constantElevation(s.elevation,s.bias),h!=null&&(a=h,u=h));const p=(_,g,x)=>{if(s!=null)if(g.push(_),h!=null)i.elevatedLayoutVertexArray.emplaceBack(h),x.push(h);else{const b=s.elevationSampler.pointElevation(_,s.elevation,s.bias);i.elevatedLayoutVertexArray.emplaceBack(b),x.push(b),a=Math.min(a,b),u=Math.max(u,b)}};for(const _ of e){let g=0;for(const G of _)g+=G.length;const x=i.triangleSegments.prepareSegment(g,i.layoutVertexArray,i.indexArray),b=x.vertexLength,w=[],E=[],A=[],P=[],L=[],k=i.layoutVertexArray.length;for(const G of _){if(G.length===0)continue;G!==_[0]&&E.push(w.length/2);const R=i.lineSegments.prepareSegment(G.length,i.layoutVertexArray,i.lineIndexArray),N=R.vertexLength;s&&L.push(i.layoutVertexArray.length-k),p(G[0],A,P),i.layoutVertexArray.emplaceBack(G[0].x,G[0].y),i.lineIndexArray.emplaceBack(N+G.length-1,N),w.push(G[0].x),w.push(G[0].y);for(let q=1;q<G.length;q++)p(G[q],A,P),i.layoutVertexArray.emplaceBack(G[q].x,G[q].y),i.lineIndexArray.emplaceBack(N+q-1,N+q),w.push(G[q].x),w.push(G[q].y);R.vertexLength+=G.length,R.primitiveLength+=G.length}const j=$h(w,E);for(let G=0;G<j.length;G+=3)i.indexArray.emplaceBack(b+j[G],b+j[G+1],b+j[G+2]);if(j.length>0&&s&&this.elevationMode==="hd-road-base"){const G=s.elevation.isTunnel(),R=s.elevation.safeArea,N=this.elevatedStructures.addVertices(A,P);this.elevatedStructures.addTriangles(j,N,G);const q=L.length;if(q>0){for(let Z=0;Z<q-1;Z++)this.elevatedStructures.addRenderableRing(s.index,L[Z]+N,L[Z+1]-L[Z],G,R,s.featureInfo);this.elevatedStructures.addRenderableRing(s.index,L[q-1]+N,A.length-L[q-1],G,R,s.featureInfo)}}x.vertexLength+=g,x.primitiveLength+=j.length/3}return[a,u]}prepareElevatedPolygons(e,i,s){const a=1/Pe(s),u=[];for(const h of e){const p=j1(h,new kn(i,a));u.push(...p)}return u}clipPolygonsToTile(e,i){const s=-i,a=-i,u=dt+i,h=dt+i;let p=0;const _=[],g=[];for(;p<e.length;p++){const w=e[p],E=Zu(w);(E.min.x>=s&&E.max.x<=u&&E.min.y>=a&&E.max.y<=h?_:g).push(w)}if(_.length===e.length)return e;const x=[new ut(s,a),new ut(u,a),new ut(u,h),new ut(s,h),new ut(s,a)],b=_;for(const w of g)b.push(...U1(w,x));return b}}let ry,ny,sy,oy;bt(Pm,"FillBucket",{omit:["layers","patternFeatures"]}),bt(Mm,"FillBufferData"),bt(is,"ElevatedStructures");class Rm{constructor(e,i,s,a){if(this.triangleCount=i.length/3,this.min=new ut(0,0),this.max=new ut(0,0),this.xScale=0,this.yScale=0,this.cellsX=0,this.cellsY=0,this.cells=[],this.payload=[],this.triangleCount===0||e.length===0)return;const[u,h]=[e[0].clone(),e[0].clone()];for(let b=1;b<e.length;++b){const w=e[b];u.x=Math.min(u.x,w.x),u.y=Math.min(u.y,w.y),h.x=Math.max(h.x,w.x),h.y=Math.max(h.y,w.y)}if(a){const b=Math.ceil(Math.max(h.x-u.x,h.y-u.y)/a);s=Math.max(s,b)}if(s===0)return;this.min=u,this.max=h;const p=this.max.sub(this.min);p.x=Math.max(p.x,1),p.y=Math.max(p.y,1);const _=Math.max(p.x,p.y)/s;this.cellsX=Math.max(1,Math.ceil(p.x/_)),this.cellsY=Math.max(1,Math.ceil(p.y/_)),this.xScale=1/_,this.yScale=1/_;const g=[];for(let b=0;b<this.triangleCount;b++){const w=e[i[3*b+0]].sub(this.min),E=e[i[3*b+1]].sub(this.min),A=e[i[3*b+2]].sub(this.min),P=To(Math.floor(Math.min(w.x,E.x,A.x)),this.xScale,this.cellsX),L=To(Math.floor(Math.max(w.x,E.x,A.x)),this.xScale,this.cellsX),k=To(Math.floor(Math.min(w.y,E.y,A.y)),this.yScale,this.cellsY),j=To(Math.floor(Math.max(w.y,E.y,A.y)),this.yScale,this.cellsY),G=new ut(0,0),R=new ut(0,0),N=new ut(0,0),q=new ut(0,0);for(let Z=k;Z<=j;++Z){G.y=R.y=Z*_,N.y=q.y=(Z+1)*_;for(let ae=P;ae<=L;++ae)G.x=N.x=ae*_,R.x=q.x=(ae+1)*_,(gm(w,E,A,G,R,q)||gm(w,E,A,G,q,N))&&g.push({cellIdx:Z*this.cellsX+ae,triIdx:b})}}if(g.length===0)return;g.sort((b,w)=>b.cellIdx-w.cellIdx||b.triIdx-w.triIdx);let x=0;for(;x<g.length;){const b=g[x].cellIdx,w={start:this.payload.length,len:0};for(;x<g.length&&g[x].cellIdx===b;)++w.len,this.payload.push(g[x++].triIdx);this.cells[b]=w}}_lazyInitLookup(){this.lookup||(this.lookup=new Uint8Array(Math.ceil(this.triangleCount/8))),this.lookup.fill(0)}queryPoint(e,i){if(this.triangleCount===0||this.cells.length===0||e.x>this.max.x||this.min.x>e.x||e.y>this.max.y||this.min.y>e.y)return;const s=To(e.x-this.min.x,this.xScale,this.cellsX),a=To(e.y-this.min.y,this.yScale,this.cellsY),u=this.cells[a*this.cellsX+s];if(u){this._lazyInitLookup();for(let h=0;h<u.len;h++){const p=this.payload[u.start+h],_=Math.floor(p/8),g=1<<p%8;if(!(this.lookup[_]&g)&&(this.lookup[_]|=g,i.push(p),i.length===this.triangleCount))return}}}query(e,i,s){if(this.triangleCount===0||this.cells.length===0||e.x>this.max.x||this.min.x>i.x||e.y>this.max.y||this.min.y>i.y)return;this._lazyInitLookup();const a=To(e.x-this.min.x,this.xScale,this.cellsX),u=To(i.x-this.min.x,this.xScale,this.cellsX),h=To(e.y-this.min.y,this.yScale,this.cellsY),p=To(i.y-this.min.y,this.yScale,this.cellsY);for(let _=h;_<=p;_++)for(let g=a;g<=u;g++){const x=this.cells[_*this.cellsX+g];if(x)for(let b=0;b<x.len;b++){const w=this.payload[x.start+b],E=Math.floor(w/8),A=1<<w%8;if(!(this.lookup[E]&A)&&(this.lookup[E]|=A,s.push(w),s.length===this.triangleCount))return}}}}function To(r,e,i){return Math.max(0,Math.min(i-1,Math.floor(r*e)))}bt(Rm,"TriangleGridIndex");class ay{constructor(e){this.zoom=e.zoom,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.hasPattern=!1,this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.footprints=[],this.worldview=e.worldview}updateFootprints(e,i){for(const s of this.footprints)i.push({footprint:s,id:e})}populate(e,i,s,a){const u=[];for(const{feature:h,id:p,index:_,sourceLayerIndex:g}of e){const x=this.layers[0]._featureFilter.needGeometry,b=gt(h,x);if(!this.layers[0]._featureFilter.filter(new Gi(this.zoom,{worldview:this.worldview}),b,s))continue;const w={id:p,properties:h.properties,type:h.type,sourceLayerIndex:g,index:_,geometry:x?b.geometry:Tt(h,s,a),patterns:{}};u.push(w)}for(const h of u){const{geometry:p,index:_,sourceLayerIndex:g}=h;this.addFeature(h,p,_,s,{},i.availableImages,i.brightness),i.featureIndex.insert(e[_].feature,p,_,g,this.index)}}isEmpty(){return this.footprints.length===0}uploadPending(){return!1}upload(e){}update(e,i,s,a,u,h,p){}destroy(){}addFeature(e,i,s,a,u,h=[],p){for(const _ of Ff(i,2)){const g=[],x=[],b=[],w=new ut(1/0,1/0),E=new ut(-1/0,-1/0);for(const L of _)if(L.length!==0){L!==_[0]&&b.push(x.length/2);for(let k=0;k<L.length;k++)x.push(L[k].x),x.push(L[k].y),g.push(L[k]),w.x=Math.min(w.x,L[k].x),w.y=Math.min(w.y,L[k].y),E.x=Math.max(E.x,L[k].x),E.y=Math.max(E.y,L[k].y)}const A=$h(x,b),P=new Rm(g,A,8,256);this.footprints.push({vertices:g,indices:A,grid:P,min:w,max:E})}}}bt(ay,"ClipBucket",{omit:["layers"]});const G1=bi([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),q1=bi([{name:"a_pos_end",components:4,type:"Int16"},{name:"a_angular_offset_factor",components:1,type:"Int16"}]),$1=bi([{name:"a_centroid_pos",components:2,type:"Uint16"}]),H1=bi([{name:"a_join_normal_inside",components:3,type:"Int16"}]),Z1=bi([{name:"a_hidden_by_landmark",components:1,type:"Uint8"}]),W1=bi([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:X1}=G1,Nf=Number.MAX_SAFE_INTEGER;function ly(r,e,i,s){return r.order<e||r.order===Nf||!(r.clipMask&i)||function(a,u){return u.length!==0&&u.find(h=>h===a)===void 0}(s,r.clipScope)}function Vf(r,e){return r.x-e.x||r.y-e.y}function cy(r,e){return Vf(r.min,e.min)===0&&Vf(r.max,e.max)===0}function zm(r,e){return!(r.min.x>e.max.x||r.max.x<e.min.x||r.min.y>e.max.y||r.max.y<e.min.y)}function Lm(r,e){if(r.length!==e.length)return!1;for(let i=0;i<r.length;i++)if(r[i].sourceId!==e[i].sourceId||!cy(r[i],e[i])||r[i].order!==e[i].order||r[i].clipMask!==e[i].clipMask||!As(r[i].clipScope,e[i].clipScope))return!1;return!0}function uy(r,e,i){const s=1/dt,a=1/(1<<i.canonical.z),u=(e.x*s+i.canonical.x)*a+i.wrap,h=(e.y*s+i.canonical.y)*a;return{min:new ut((r.x*s+i.canonical.x)*a+i.wrap,(r.y*s+i.canonical.y)*a),max:new ut(u,h)}}function Y1(r,e,i){const s=1<<i.canonical.z,a=((e.x-i.wrap)*s-i.canonical.x)*dt,u=(e.y*s-i.canonical.y)*dt;return{min:new ut(((r.x-i.wrap)*s-i.canonical.x)*dt,(r.y*s-i.canonical.y)*dt),max:new ut(a,u)}}function hy(r,e,i,s,a,u,h){const p=r.indices,_=r.vertices,g=[];for(let x=s;x<s+a;x+=3){const b=e[i[x+0]+u],w=e[i[x+1]+u],E=e[i[x+2]+u],A=Math.min(b.x,w.x,E.x),P=Math.max(b.x,w.x,E.x),L=Math.min(b.y,w.y,E.y),k=Math.max(b.y,w.y,E.y);g.length=0,r.grid.query(new ut(A,L),new ut(P,k),g);for(let j=0;j<g.length;j++){const G=g[j];if(gm(_[p[3*G+0]],_[p[3*G+1]],_[p[3*G+2]],b,w,E,h))return!0}}return!1}function dy(r,e,i,s){if(!r||!i)return!1;let a=r.vertices;if(!e.canonical.equals(s.canonical)||e.wrap!==s.wrap){if(i.vertices.length<r.vertices.length)return dy(i,s,r,e);const u=e.canonical,h=s.canonical,p=Math.pow(2,h.z-u.z);a=r.vertices.map(_=>new ut((_.x+u.x*dt)*p-h.x*dt,(_.y+u.y*dt)*p-h.y*dt))}return hy(i,a,r.indices,0,r.indices.length,0,0)}function fy(r,e,i,s){const a=Math.pow(2,s.z-i.z);return new ut((r+i.x*dt)*a-s.x*dt,(e+i.y*dt)*a-s.y*dt)}function py(r,e){const i=[];e.grid.queryPoint(r,i);const s=e.indices,a=e.vertices;for(let u=0;u<i.length;u++){const h=i[u];if(bs([a[s[3*h+0]],a[s[3*h+1]],a[s[3*h+2]]],r))return!0}return!1}const Dm=[new ut(0,0),new ut(dt,0),new ut(dt,dt),new ut(0,dt)];function my(r,e){const i=[];let s=[];if(!e||r.length<2)return[r];if(r.length===2)return ta(r[0],r[1],Dm)?[r]:[];for(let a=0;a<r.length+2;a++){const u=r[a%r.length],h=r[(a+1)%r.length],p=ta(a===0?r[r.length-1]:r[(a-1)%r.length],u,Dm),_=ta(u,h,Dm),g=p||_;g&&s.push(u),g&&_||s.length>0&&(s.length>1&&i.push(s),s=[])}return s.length>1&&i.push(s),i}const Om=ni.VectorTileFeature.types,K1=["fill-extrusion-base","fill-extrusion-height","fill-extrusion-color","fill-extrusion-pattern","fill-extrusion-flood-light-wall-radius","fill-extrusion-line-width","fill-extrusion-emissive-strength"],J1=["fill-extrusion-flood-light-ground-radius"],Q1=Math.pow(2,13),eb=Math.pow(2,15)-1,_y=new ut(0,1),Wa=2147483648;function Yh(r,e,i,s,a,u,h,p){r.emplaceBack((e<<1)+h,(i<<1)+u,(Math.floor(s*Q1)<<1)+a,Math.round(p))}function Kh(r,e,i){r.emplaceBack(e.x*dt,e.y*dt,i?1:0)}function Uf(r,e,i,s,a,u){r.emplaceBack(e.x,e.y,(i.x<<1)+s,(i.y<<1)+a,u)}function Jh(r,e,i){r.emplaceBack(e.x,e.y,e.z,i[0]*16384,i[1]*16384,i[2]*16384)}class gy{constructor(){this.vertexOffset=0,this.vertexCount=0,this.indexOffset=0,this.indexCount=0}}class yy{constructor(){this.centroidXY=new ut(0,0),this.vertexArrayOffset=0,this.vertexCount=0,this.groundVertexArrayOffset=0,this.groundVertexCount=0,this.flags=0,this.footprintSegIdx=-1,this.footprintSegLen=0,this.polygonSegIdx=-1,this.polygonSegLen=0,this.min=new ut(Number.MAX_VALUE,Number.MAX_VALUE),this.max=new ut(-Number.MAX_VALUE,-Number.MAX_VALUE),this.height=0}span(){return new ut(this.max.x-this.min.x,this.max.y-this.min.y)}}class vy{constructor(){this.acc=new ut(0,0),this.accCount=0,this.centroidDataIndex=0}startRing(e,i){e.min.x===Number.MAX_VALUE&&(e.min.x=e.max.x=i.x,e.min.y=e.max.y=i.y)}appendEdge(e,i,s){this.accCount++,this.acc._add(i);let a=!!this.borders;i.x<e.min.x?(e.min.x=i.x,a=!0):i.x>e.max.x&&(e.max.x=i.x,a=!0),i.y<e.min.y?(e.min.y=i.y,a=!0):i.y>e.max.y&&(e.max.y=i.y,a=!0),((i.x===0||i.x===dt)&&i.x===s.x)!=((i.y===0||i.y===dt)&&i.y===s.y)&&this.processBorderOverlap(i,s),a&&this.checkBorderIntersection(i,s)}checkBorderIntersection(e,i){i.x<0!=e.x<0&&this.addBorderIntersection(0,Ut(i.y,e.y,(0-i.x)/(e.x-i.x))),i.x>dt!=e.x>dt&&this.addBorderIntersection(1,Ut(i.y,e.y,(dt-i.x)/(e.x-i.x))),i.y<0!=e.y<0&&this.addBorderIntersection(2,Ut(i.x,e.x,(0-i.y)/(e.y-i.y))),i.y>dt!=e.y>dt&&this.addBorderIntersection(3,Ut(i.x,e.x,(dt-i.y)/(e.y-i.y)))}addBorderIntersection(e,i){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);const s=this.borders[e];i<s[0]&&(s[0]=i),i>s[1]&&(s[1]=i)}processBorderOverlap(e,i){if(e.x===i.x){if(e.y===i.y)return;const s=e.x===0?0:1;this.addBorderIntersection(s,i.y),this.addBorderIntersection(s,e.y)}else{const s=e.y===0?2:3;this.addBorderIntersection(s,i.x),this.addBorderIntersection(s,e.x)}}centroid(){return this.accCount===0?new ut(0,0):new ut(Math.floor(Math.max(0,this.acc.x)/this.accCount),Math.floor(Math.max(0,this.acc.y)/this.accCount))}intersectsCount(){return this.borders?this.borders.reduce((e,i)=>e+ +(i[0]!==Number.MAX_VALUE),0):0}}function xy(r,e){const i=r.add(e)._unit(),s=Q(r.x*i.x+r.y*i.y,-1,1);var a,u,h;return a=Math.acos(s),Math.min(4,Math.max(-4,Math.tan(a)))/4*eb*((u=r).x*(h=e).y-u.y*h.x<0?-1:1)}const tb=[r=>r.x<0,r=>r.x>dt,r=>r.y<0,r=>r.y>dt];function ib(r,e,i,s){const a=[4];if(s===0)return a;i._mult(s);const u=r.sub(i),h=e.sub(i),p=[r,e,u,h];for(let _=0;_<4;_++)for(const g of p)if(tb[_](g)){a.push(_);break}return a}class by{constructor(e){this.vertexArray=new ka,this.indexArray=new en,this.programConfigurations=new l(e.layers,{zoom:e.zoom,lut:e.lut},i=>J1.includes(i)),this._segments=new Tr,this.hiddenByLandmarkVertexArray=new su,this._segmentToGroundQuads={},this._segmentToGroundQuads[0]=[],this._segmentToRegionTriCounts={},this._segmentToRegionTriCounts[0]=[0,0,0,0,0],this.regionSegments={},this.regionSegments[4]=new Tr}getDefaultSegment(){return this.regionSegments[4]}hasData(){return this.vertexArray.length!==0}addData(e,i,s,a=!1){const u=e.length;if(u>2){let h=Math.max(0,this._segments.get().length-1);const p=this._segments._prepareSegment(4*u,this.vertexArray.length,2*this._segmentToGroundQuads[h].length);let _;h!==this._segments.get().length-1&&(h++,this._segmentToGroundQuads[h]=[],this._segmentToRegionTriCounts[h]=[0,0,0,0,0]);{const g=e[0],x=e[1];_=xy(g.sub(e[u-1])._perp()._unit(),x.sub(g)._perp()._unit())}for(let g=0;g<u;g++){const x=g===u-1?0:g+1,b=e[g],w=e[x],E=e[x===u-1?0:x+1],A=w.sub(b)._perp()._unit(),P=xy(A,E.sub(w)._perp()._unit()),L=_,k=P;if(km(b,w,i)||a&&Sy(b,i)&&Sy(w,i)){_=P;continue}const j=p.vertexLength;Uf(this.vertexArray,b,w,1,1,L),Uf(this.vertexArray,b,w,1,0,L),Uf(this.vertexArray,b,w,0,1,k),Uf(this.vertexArray,b,w,0,0,k),p.vertexLength+=4;const G=ib(b,w,A,s);for(const R of G)this._segmentToGroundQuads[h].push({id:j,region:R}),this._segmentToRegionTriCounts[h][R]+=2,p.primitiveLength+=2;_=P}}}prepareBorderSegments(){if(!this.hasData())return;const e=this._segments.get(),i=e.length;for(let s=0;s<i;s++)this._segmentToGroundQuads[s].sort((a,u)=>a.region-u.region);for(let s=0;s<i;s++){const a=this._segmentToGroundQuads[s],u=e[s],h=this._segmentToRegionTriCounts[s];h.reduce((_,g)=>_+g,0);let p=0;for(let _=0;_<=4;_++){const g=h[_];if(g!==0){let x=this.regionSegments[_];x||(x=this.regionSegments[_]=new Tr);const b={vertexOffset:u.vertexOffset,primitiveOffset:u.primitiveOffset+p,vertexLength:u.vertexLength,primitiveLength:g};x.get().push(b)}p+=g}for(let _=0;_<a.length;_++){const g=a[_].id;this.indexArray.emplaceBack(g,g+1,g+3),this.indexArray.emplaceBack(g,g+3,g+2)}}this._segmentToGroundQuads=null,this._segmentToRegionTriCounts=null,this._segments.destroy(),this._segments=null}addPaintPropertiesData(e,i,s,a,u,h,p){this.hasData()&&this.programConfigurations.populatePaintArrays(this.vertexArray.length,e,i,s,a,u,h,void 0,p)}upload(e){this.hasData()&&(this.vertexBuffer=e.createVertexBuffer(this.vertexArray,q1.members),this.indexBuffer=e.createIndexBuffer(this.indexArray))}uploadPaintProperties(e){this.hasData()&&this.programConfigurations.upload(e)}update(e,i,s,a,u,h,p,_){this.hasData()&&this.programConfigurations.updatePaintArrays(e,i,s,a,u,h,p,_)}updateHiddenByLandmark(e){if(!this.hasData())return;const i=e.groundVertexCount+e.groundVertexArrayOffset;if(e.groundVertexCount===0)return;const s=e.flags&Wa?1:0;for(let a=e.groundVertexArrayOffset;a<i;++a)this.hiddenByLandmarkVertexArray.emplace(a,s);this._needsHiddenByLandmarkUpdate=!0}uploadHiddenByLandmark(e){this.hasData()&&this._needsHiddenByLandmarkUpdate&&(!this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexArray.length>0?this.hiddenByLandmarkVertexBuffer=e.createVertexBuffer(this.hiddenByLandmarkVertexArray,Z1.members,!0):this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.updateData(this.hiddenByLandmarkVertexArray),this._needsHiddenByLandmarkUpdate=!1)}destroy(){if(this.vertexBuffer){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.destroy(),this._segments&&this._segments.destroy(),this.programConfigurations.destroy();for(let e=0;e<=4;e++){const i=this.regionSegments[e];i&&i.destroy()}}}}class jf{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.overscaling=e.overscaling,this.layers=e.layers,this.pixelRatio=e.pixelRatio,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=e.projection,this.activeReplacements=[],this.replacementUpdateTime=0,this.centroidData=[],this.footprintIndices=new en,this.footprintVertices=new Ns,this.footprintSegments=[],this.layoutVertexArray=new Oa,this.centroidVertexArray=new Tf,this.wallVertexArray=new Ef,this.indexArray=new en,this.programConfigurations=new l(e.layers,{zoom:e.zoom,lut:e.lut},i=>K1.includes(i)),this.segments=new Tr,this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.groundEffect=new by(e),this.maxHeight=0,this.partLookup={},this.triangleSubSegments=[],this.polygonSegments=[],this.worldview=e.worldview}updateFootprints(e,i){}populate(e,i,s,a){this.features=[],this.hasPattern=Im("fill-extrusion",this.layers,this.pixelRatio,i),this.featuresOnBorder=[],this.borderFeatureIndices=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.selfDEMTileTimestamp=Number.MAX_VALUE,this.borderDEMTileTimestamp=[Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE],this.tileToMeter=Pe(s),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter,this.wallMode=this.layers[0].paint.get("fill-extrusion-line-width").constantOr(1)!==0;for(const{feature:u,id:h,index:p,sourceLayerIndex:_}of e){const g=this.layers[0]._featureFilter.needGeometry,x=gt(u,g);if(!this.layers[0]._featureFilter.filter(new Gi(this.zoom,{worldview:this.worldview}),x,s))continue;const b={id:h,sourceLayerIndex:_,index:p,geometry:g?x.geometry:Tt(u,s,a),properties:u.properties,type:u.type,patterns:{}},w=this.layoutVertexArray.length,E=Om[b.type]==="Polygon";if(this.hasPattern)this.features.push(Am("fill-extrusion",this.layers,b,this.zoom,this.pixelRatio,i));else if(this.wallMode)for(const A of b.geometry)for(const P of my(A,E))this.addFeature(b,[P],p,s,{},i.availableImages,a,i.brightness);else this.addFeature(b,b.geometry,p,s,{},i.availableImages,a,i.brightness);i.featureIndex.insert(u,b.geometry,p,_,this.index,w)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles(),this.groundEffect.prepareBorderSegments(),this.polygonSegments.length=0}addFeatures(e,i,s,a,u,h){for(const p of this.features){const _=Om[p.type]==="Polygon",{geometry:g}=p;if(this.wallMode)for(const x of g)for(const b of my(x,_))this.addFeature(p,[b],p.index,i,s,a,u,h);else this.addFeature(p,g,p.index,i,s,a,u,h)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles()}update(e,i,s,a,u,h,p){this.programConfigurations.updatePaintArrays(e,i,u,s,a,h,p,this.worldview),this.groundEffect.update(e,i,u,s,a,h,p,this.worldview)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,X1),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.wallVertexBuffer=e.createVertexBuffer(this.wallVertexArray,H1.members),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=e.createVertexBuffer(this.layoutVertexExtArray,W1.members,!0)),this.groundEffect.upload(e)),this.groundEffect.uploadPaintProperties(e),this.programConfigurations.upload(e),this.uploaded=!0}uploadCentroid(e){this.groundEffect.uploadHiddenByLandmark(e),this.needsCentroidUpdate&&(!this.centroidVertexBuffer&&this.centroidVertexArray.length>0?this.centroidVertexBuffer=e.createVertexBuffer(this.centroidVertexArray,$1.members,!0):this.centroidVertexBuffer&&this.centroidVertexBuffer.updateData(this.centroidVertexArray),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(e,i,s,a,u,h,p,_){const g=this.layers[0].paint.get("fill-extrusion-flood-light-ground-radius").evaluate(e,{})/this.tileToMeter,x=[new ut(0,0),new ut(dt,dt)],b=p.projection,w=b.name==="globe",E=this.wallMode||Om[e.type]==="Polygon",A=new vy;A.centroidDataIndex=this.centroidData.length;const P=new yy,L=this.layers[0].paint.get("fill-extrusion-base").evaluate(e,{},a)<=0,k=this.layers[0].paint.get("fill-extrusion-height").evaluate(e,{},a);let j;if(P.height=k,P.vertexArrayOffset=this.layoutVertexArray.length,P.groundVertexArrayOffset=this.groundEffect.vertexArray.length,w&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new iu),this.wallMode){if(w)return void ei("Non zero fill-extrusion-line-width is not yet supported on globe.");if(i.length!==1)return;j=function(ce){const me=ce[0].x===ce[ce.length-1].x&&ce[0].y===ce[ce.length-1].y;(function(pt){let Qe=0;const Xt=pt.length;for(let Et=0;Et<Xt;Et++)Qe+=(pt[(Et+1)%Xt].x-pt[Et].x)*(pt[(Et+1)%Xt].y+pt[Et].y);return Qe>=0})(ce)||(ce=ce.reverse());const Xe={geometry:[],joinNormals:[],indices:[]},Ve=[],We=[],Ke=[];let Le=ce.length;for(;Le>=2&&ce[Le-1].equals(ce[Le-2]);)Le--;if(Le<(me?3:2))return Xe;let He,Me,ze,et,it,Ot=0;for(;Ot<Le-1&&ce[Ot].equals(ce[Ot+1]);)Ot++;me&&(He=ce[Le-2],it=ce[Ot].sub(He)._unit()._perp());for(let pt=Ot;pt<Le;pt++){if(ze=pt===Le-1?me?ce[Ot+1]:void 0:ce[pt+1],ze&&ce[pt].equals(ze))continue;it&&(et=it),He&&(Me=He),He=ce[pt],it=ze?ze.sub(He)._unit()._perp():et,et=et||it;let Qe=et.add(it);Qe.x===0&&Qe.y===0||Qe._unit();const Xt=Qe.x*it.x+Qe.y*it.y,Et=Xt!==0?1/Xt:1/0,Mt=et.x*it.y-et.y*it.x>0;let jt="miter";const Qt=2;jt==="miter"&&Et>Qt&&(jt="bevel"),jt==="bevel"&&(Et>100&&(jt="flipbevel"),Et<Qt&&(jt="miter"));const Jt=(ai,ii,li,Li)=>{const er=new ut(ai.x,ai.y),$=new ut(ai.x,ai.y);er.x+=ii.x*Li,er.y+=ii.y*Li,$.x-=ii.x*Math.max(li,1),$.y-=ii.y*Math.max(li,1),Ke.push(ii),Ve.push(er),We.push($)};if(jt==="miter")Qe._mult(Et),Jt(He,Qe,0,0);else if(jt==="flipbevel")Qe=it.mult(-1),Jt(He,Qe,0,0),Jt(He,Qe.mult(-1),0,0);else{const ai=-Math.sqrt(Et*Et-1),ii=Mt?ai:0,li=Mt?0:ai;Me&&Jt(He,et,ii,li),ze&&Jt(He,it,ii,li)}}Xe.geometry=[...Ve,...We.reverse(),Ve[0]],Xe.joinNormals=[...Ke,...Ke.reverse(),Ke[Ke.length-1]];const At=Xe.geometry.length-1;for(let pt=0;pt<At/2;pt++)if(pt+1<At/2){let Qe=pt,Xt=pt+1,Et=At-1-pt,Mt=At-2-pt;Qe=Qe===0?At-1:Qe-1,Xt=Xt===0?At-1:Xt-1,Et=Et===0?At-1:Et-1,Mt=Mt===0?At-1:Mt-1,Xe.indices.push(Et),Xe.indices.push(Xt),Xe.indices.push(Qe),Xe.indices.push(Et),Xe.indices.push(Mt),Xe.indices.push(Xt)}return Xe}(i[0]),i=[j.geometry]}const G=(ce,me)=>ce<(me.length-1)/2||ce===me.length-1,R=this.wallMode?[i]:Ff(i,500);for(let ce=R.length-1;ce>=0;ce--){const me=R[ce];(me.length===0||(N=me[0]).every(Re=>Re.x<=0)||N.every(Re=>Re.x>=dt)||N.every(Re=>Re.y<=0)||N.every(Re=>Re.y>=dt))&&R.splice(ce,1)}var N;let q;if(w)q=Cy(R,x,a);else{q=[];for(const ce of R)q.push({polygon:ce,bounds:x})}const Z=E?this.edgeRadius:0,ae=Z>0&&this.zoom<17,ne=(ce,me)=>{if(ce.length===0)return!1;const Re=ce[ce.length-1];return me.x===Re.x&&me.y===Re.y};for(const{polygon:ce,bounds:me}of q){let Re=0,Xe=0;for(const Le of ce)E&&!Le[0].equals(Le[Le.length-1])&&Le.push(Le[0]),Xe+=E?Le.length-1:Le.length;const Ve=this.segments.prepareSegment((E?5:4)*Xe,this.layoutVertexArray,this.indexArray);P.footprintSegIdx<0&&(P.footprintSegIdx=this.footprintSegments.length),P.polygonSegIdx<0&&(P.polygonSegIdx=this.polygonSegments.length);const We={triangleArrayOffset:this.indexArray.length,triangleCount:0,triangleSegIdx:this.segments.segments.length-1},Ke=new gy;if(Ke.vertexOffset=this.footprintVertices.length,Ke.indexOffset=3*this.footprintIndices.length,Ke.ringIndices=[],E){const Le=[],He=[];Re=Ve.vertexLength;for(let ze=0;ze<ce.length;ze++){const et=ce[ze];et.length&&ze!==0&&He.push(Le.length/2);const it=[];let Ot,At;Ot=et[1].sub(et[0])._perp()._unit(),Ke.ringIndices.push(et.length-1);for(let pt=1;pt<et.length;pt++){const Qe=et[pt],Xt=et[pt===et.length-1?1:pt+1],Et=Qe.clone();if(Z){At=Xt.sub(Qe)._perp()._unit();const Mt=Ot.add(At)._unit(),jt=Z*Math.min(4,1/(Ot.x*Mt.x+Ot.y*Mt.y));Et.x+=jt*Mt.x,Et.y+=jt*Mt.y,Et.x=Math.round(Et.x),Et.y=Math.round(Et.y),Ot=At}if(!L||Z!==0&&!ae||ne(it,Et)||it.push(Et),Yh(this.layoutVertexArray,Et.x,Et.y,0,0,1,1,0),this.wallMode){const Mt=G(pt,et);Kh(this.wallVertexArray,j.joinNormals[pt],!Mt)}Ve.vertexLength++,this.footprintVertices.emplaceBack(Qe.x,Qe.y),Le.push(Qe.x,Qe.y),w&&Jh(this.layoutVertexExtArray,b.projectTilePoint(Et.x,Et.y,a),b.upVector(a,Et.x,Et.y))}L&&(Z===0||ae)&&(it.length!==0&&ne(it,it[0])&&it.pop(),this.groundEffect.addData(it,me,g))}const Me=this.wallMode?j.indices:$h(Le,He);for(let ze=0;ze<Me.length;ze+=3)this.footprintIndices.emplaceBack(Ke.vertexOffset+Me[ze+0],Ke.vertexOffset+Me[ze+1],Ke.vertexOffset+Me[ze+2]),this.indexArray.emplaceBack(Re+Me[ze],Re+Me[ze+2],Re+Me[ze+1]),Ve.primitiveLength++;Ke.indexCount+=Me.length,Ke.vertexCount+=this.footprintVertices.length-Ke.vertexOffset}for(let Le=0;Le<ce.length;Le++){const He=ce[Le];A.startRing(P,He[0]);let Me=He.length>4&&Ey(He[He.length-2],He[0],He[1]),ze=Z?rb(He[He.length-2],He[0],He[1],Z):0;const et=[];let it,Ot,At;Ot=He[1].sub(He[0])._perp()._unit();let pt=!0;for(let Qe=1,Xt=0;Qe<He.length;Qe++){let Et=He[Qe-1],Mt=He[Qe];const jt=He[Qe===He.length-1?1:Qe+1];if(A.appendEdge(P,Mt,Et),km(Mt,Et,me)){Z&&(Ot=jt.sub(Mt)._perp()._unit(),pt=!pt);continue}const Qt=Mt.sub(Et)._perp(),Jt=Qt.x/(Math.abs(Qt.x)+Math.abs(Qt.y)),ai=Qt.y>0?1:0,ii=Et.dist(Mt);if(Xt+ii>32768&&(Xt=0),Z){At=jt.sub(Mt)._perp()._unit();let $=Ty(Et,Mt,jt,wy(Ot,At),Z);isNaN($)&&($=0);const W=Mt.sub(Et)._unit();Et=Et.add(W.mult(ze))._round(),Mt=Mt.add(W.mult(-$))._round(),ze=$,Ot=At,L&&this.zoom>=17&&(ne(et,Et)||et.push(Et),ne(et,Mt)||et.push(Mt))}const li=Ve.vertexLength,Li=He.length>4&&Ey(Et,Mt,jt);let er=Iy(Xt,Me,pt);if(Yh(this.layoutVertexArray,Et.x,Et.y,Jt,ai,0,0,er),Yh(this.layoutVertexArray,Et.x,Et.y,Jt,ai,0,1,er),this.wallMode){const $=G(Qe-1,He),W=j.joinNormals[Qe-1];Kh(this.wallVertexArray,W,$),Kh(this.wallVertexArray,W,$)}if(Xt+=ii,er=Iy(Xt,Li,!pt),Me=Li,Yh(this.layoutVertexArray,Mt.x,Mt.y,Jt,ai,0,0,er),Yh(this.layoutVertexArray,Mt.x,Mt.y,Jt,ai,0,1,er),this.wallMode){const $=G(Qe,He),W=j.joinNormals[Qe];Kh(this.wallVertexArray,W,$),Kh(this.wallVertexArray,W,$)}if(Ve.vertexLength+=4,this.indexArray.emplaceBack(li+0,li+1,li+2),this.indexArray.emplaceBack(li+1,li+3,li+2),Ve.primitiveLength+=2,Z){const $=Re+(Qe===1?He.length-2:Qe-2),W=Qe===1?Re:$+1;if(this.indexArray.emplaceBack(li+1,$,li+3),this.indexArray.emplaceBack($,W,li+3),Ve.primitiveLength+=2,it===void 0&&(it=li),!km(jt,He[Qe],me)){const De=Qe===He.length-1?it:Ve.vertexLength;this.indexArray.emplaceBack(li+2,li+3,De),this.indexArray.emplaceBack(li+3,De+1,De),this.indexArray.emplaceBack(li+3,W,De+1),Ve.primitiveLength+=3}pt=!pt}if(w){const $=this.layoutVertexExtArray,W=b.projectTilePoint(Et.x,Et.y,a),De=b.projectTilePoint(Mt.x,Mt.y,a),lt=b.upVector(a,Et.x,Et.y),mt=b.upVector(a,Mt.x,Mt.y);Jh($,W,lt),Jh($,W,lt),Jh($,De,mt),Jh($,De,mt)}}E&&(Re+=He.length-1),L&&Z&&this.zoom>=17&&(et.length!==0&&ne(et,et[0])&&et.pop(),this.groundEffect.addData(et,me,g,Z>0))}this.footprintSegments.push(Ke),We.triangleCount=this.indexArray.length-We.triangleArrayOffset,this.polygonSegments.push(We),++P.footprintSegLen,++P.polygonSegLen}if(P.vertexCount=this.layoutVertexArray.length-P.vertexArrayOffset,P.groundVertexCount=this.groundEffect.vertexArray.length-P.groundVertexArrayOffset,P.vertexCount!==0){if(P.centroidXY=A.borders?_y:this.encodeCentroid(A,P),this.centroidData.push(P),A.borders){this.featuresOnBorder.push(A);const ce=this.featuresOnBorder.length-1;for(let me=0;me<A.borders.length;me++)A.borders[me][0]!==Number.MAX_VALUE&&this.borderFeatureIndices[me].push(ce)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,s,u,h,a,_,void 0,this.worldview),this.groundEffect.addPaintPropertiesData(e,s,u,h,a,_,this.worldview),this.maxHeight=Math.max(this.maxHeight,k)}}sortBorders(){for(let e=0;e<this.borderFeatureIndices.length;e++)this.borderFeatureIndices[e].sort((i,s)=>this.featuresOnBorder[i].borders[e][0]-this.featuresOnBorder[s].borders[e][0])}splitToSubtiles(){const e=[];for(let p=0;p<this.centroidData.length;p++){const _=this.centroidData[p],g=+(_.min.y+_.max.y>dt),x=2*g+(+(_.min.x+_.max.x>dt)^g);for(let b=0;b<_.polygonSegLen;b++){const w=_.polygonSegIdx+b;e.push({centroidIdx:p,subtile:x,polygonSegmentIdx:w,triangleSegmentIdx:this.polygonSegments[w].triangleSegIdx})}}const i=new en;e.sort((p,_)=>p.triangleSegmentIdx===_.triangleSegmentIdx?p.subtile-_.subtile:p.triangleSegmentIdx-_.triangleSegmentIdx);let s=0,a=0,u=0;for(const p of e){if(p.triangleSegmentIdx!==s)break;u++}const h=e.length;for(;a!==e.length;){s=e[a].triangleSegmentIdx;let p=0,_=a,g=a;for(let x=_;x<u&&e[x].subtile===p;x++)g++;for(;_!==u;){const x=e[_];p=x.subtile;const b=this.centroidData[x.centroidIdx].min.clone(),w=this.centroidData[x.centroidIdx].max.clone(),E={vertexOffset:this.segments.segments[s].vertexOffset,primitiveOffset:i.length,vertexLength:this.segments.segments[s].vertexLength,primitiveLength:0,sortKey:void 0,vaos:{}};for(let A=_;A<g;A++){const P=e[A],L=this.polygonSegments[P.polygonSegmentIdx],k=this.centroidData[P.centroidIdx].min,j=this.centroidData[P.centroidIdx].max,G=this.indexArray.uint16;for(let R=L.triangleArrayOffset;R<L.triangleArrayOffset+L.triangleCount;R++)i.emplaceBack(G[3*R],G[3*R+1],G[3*R+2]);E.primitiveLength+=L.triangleCount,b.x=Math.min(b.x,k.x),b.y=Math.min(b.y,k.y),w.x=Math.max(w.x,j.x),w.y=Math.max(w.y,j.y)}E.primitiveLength>0&&this.triangleSubSegments.push({segment:E,min:b,max:w}),_=g;for(let A=_;A<u&&e[A].subtile===e[_].subtile;A++)g++}a=u;for(let x=a;x<h&&e[x].triangleSegmentIdx===e[a].triangleSegmentIdx;x++)u++}i._trim(),this.indexArray=i}getVisibleSegments(e,i,s){const a=new Tr;if(this.wallMode){for(const P of this.triangleSubSegments)a.segments.push(P.segment);return a}let u=0,h=0;const p=1<<e.canonical.z;if(i){const P=i.getMinMaxForTile(e);P&&(u=P.min,h=P.max)}h+=this.maxHeight;const _=e.toUnwrapped();let g;const x=[_.canonical.x/p+_.wrap,_.canonical.y/p],b=[(_.canonical.x+1)/p+_.wrap,(_.canonical.y+1)/p],w=(P,L,k)=>[P[0]*(1-k[0])+L[0]*k[0],P[1]*(1-k[1])+L[1]*k[1]],E=[],A=[];for(const P of this.triangleSubSegments){E[0]=P.min.x/dt,E[1]=P.min.y/dt,A[0]=P.max.x/dt,A[1]=P.max.y/dt;const L=w(x,b,E),k=w(x,b,A);if(new Ti([L[0],L[1],u],[k[0],k[1],h]).intersectsPrecise(s)===0){g&&(a.segments.push(g),g=void 0);continue}const j=P.segment;g&&g.vertexOffset!==j.vertexOffset&&(a.segments.push(g),g=void 0),g?(g.vertexLength+=j.vertexLength,g.primitiveLength+=j.primitiveLength):g={vertexOffset:j.vertexOffset,primitiveLength:j.primitiveLength,vertexLength:j.vertexLength,primitiveOffset:j.primitiveOffset,sortKey:void 0,vaos:{}}}return g&&a.segments.push(g),a}encodeCentroid(e,i){const s=e.centroid(),a=i.span(),u=Math.min(7,Math.round(a.x*this.tileToMeter/10)),h=Math.min(7,Math.round(a.y*this.tileToMeter/10));return new ut(Q(s.x,1,dt-1)<<3|u,Q(s.y,1,dt-1)<<3|h)}encodeBorderCentroid(e){if(!e.borders)return new ut(0,0);const i=e.borders,s=Number.MAX_VALUE;if(i[0][0]!==s||i[1][0]!==s){const a=i[0][0]!==s?0:1;return new ut(6|(i[0][0]!==s?0:65528),(i[a][0]+i[a][1])/2<<3|6)}{const a=i[2][0]!==s?2:3;return new ut((i[a][0]+i[a][1])/2<<3|6,6|(i[2][0]!==s?0:65528))}}showCentroid(e){const i=this.centroidData[e.centroidDataIndex];i.flags&=Wa,i.centroidXY.x=0,i.centroidXY.y=0,this.writeCentroidToBuffer(i)}writeCentroidToBuffer(e){this.groundEffect.updateHiddenByLandmark(e);const i=e.vertexArrayOffset,s=e.vertexCount+e.vertexArrayOffset,a=e.flags&Wa?_y:e.centroidXY,u=this.centroidVertexArray.geta_centroid_pos0(i);if(this.centroidVertexArray.geta_centroid_pos1(i)!==a.y||u!==a.x){for(let h=i;h<s;++h)this.centroidVertexArray.emplace(h,a.x,a.y);this.needsCentroidUpdate=!0}}createCentroidsBuffer(){this.centroidVertexArray.resize(this.layoutVertexArray.length),this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const e of this.centroidData)this.writeCentroidToBuffer(e)}updateReplacement(e,i,s){if(i.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=i.updateTime;const a=i.getReplacementRegionsForTile(e.toUnwrapped());if(Lm(this.activeReplacements,a))return;if(this.activeReplacements=a,this.centroidVertexArray.length===0)this.createCentroidsBuffer();else for(const h of this.centroidData)h.flags&=2147483647;const u=[];for(const h of this.activeReplacements){if(h.order<s)continue;const p=Math.max(1,Math.pow(2,h.footprintTileId.canonical.z-e.canonical.z));for(const _ of this.centroidData)if(!(_.flags&Wa||h.min.x>_.max.x||_.min.x>h.max.x||h.min.y>_.max.y||_.min.y>h.max.y))for(let g=0;g<_.footprintSegLen;g++){const x=this.footprintSegments[_.footprintSegIdx+g];if(u.length=0,nb(this.footprintVertices,x.vertexOffset,x.vertexCount,h.footprintTileId.canonical,e.canonical,u),hy(h.footprint,u,this.footprintIndices.uint16,x.indexOffset,x.indexCount,-x.vertexOffset,-p)){_.flags|=Wa;break}}}for(const h of this.centroidData)this.writeCentroidToBuffer(h);this.borderDoneWithNeighborZ=[-1,-1,-1,-1]}footprintContainsPoint(e,i,s){let a=!1;for(let u=0;u<s.footprintSegLen;u++){const h=this.footprintSegments[s.footprintSegIdx+u];let p=0;for(const _ of h.ringIndices){for(let g=p,x=_+p-1;g<_+p;x=g++){const b=this.footprintVertices.int16[2*(g+h.vertexOffset)+0],w=this.footprintVertices.int16[2*(g+h.vertexOffset)+1],E=this.footprintVertices.int16[2*(x+h.vertexOffset)+1];w>i!=E>i&&e<(this.footprintVertices.int16[2*(x+h.vertexOffset)+0]-b)*(i-w)/(E-w)+b&&(a=!a)}p=_}}return a}getHeightAtTileCoord(e,i){let s=Number.NEGATIVE_INFINITY,a=!0;const u=4*(e+dt)*dt+(i+dt);if(this.partLookup.hasOwnProperty(u)){const h=this.partLookup[u];return h?{height:h.height,hidden:!!(h.flags&Wa)}:void 0}for(const h of this.centroidData)e>h.max.x||h.min.x>e||i>h.max.y||h.min.y>i||this.footprintContainsPoint(e,i,h)&&h&&h.height>s&&(s=h.height,this.partLookup[u]=h,a=!!(h.flags&Wa));if(s!==Number.NEGATIVE_INFINITY)return{height:s,hidden:a};this.partLookup[u]=void 0}}function wy(r,e){const i=r.add(e)._unit();return r.x*i.x+r.y*i.y}function rb(r,e,i,s){const a=e.sub(r)._perp()._unit(),u=i.sub(e)._perp()._unit();return Ty(r,e,i,wy(a,u),s)}function Ty(r,e,i,s,a){const u=Math.sqrt(1-s*s);return Math.min(r.dist(e)/3,e.dist(i)/3,a*u/s)}function km(r,e,i){return r.x<i[0].x&&e.x<i[0].x||r.x>i[1].x&&e.x>i[1].x||r.y<i[0].y&&e.y<i[0].y||r.y>i[1].y&&e.y>i[1].y}function Sy(r,e){return r.x<e[0].x||r.x>e[1].x||r.y<e[0].y||r.y>e[1].y}function Ey(r,e,i){if(r.x<0||r.x>=dt||e.x<0||e.x>=dt||i.x<0||i.x>=dt)return!1;const s=i.sub(e),a=s.perp(),u=r.sub(e);return(s.x*u.x+s.y*u.y)/Math.sqrt((s.x*s.x+s.y*s.y)*(u.x*u.x+u.y*u.y))>-.866&&a.x*u.x+a.y*u.y<0}function Iy(r,e,i){const s=e?2|r:-3&r;return i?1|s:-2&s}function Ay(){const r=Math.PI/32,e=Math.tan(r),i=O;return i*Math.sqrt(1+2*e*e)-i}function Cy(r,e,i){const s=1<<i.z,a=se(i.x/s),u=se((i.x+1)/s),h=ye(i.y/s),p=ye((i.y+1)/s);return function(_,g,x,b,w=0,E){const A=[];if(!_.length||!x||!b)return A;const P=(q,Z)=>{for(const ae of q)A.push({polygon:ae,bounds:Z})},L=Math.ceil(Math.log2(x)),k=Math.ceil(Math.log2(b)),j=L-k,G=[];for(let q=0;q<Math.abs(j);q++)G.push(j>0?0:1);for(let q=0;q<Math.min(L,k);q++)G.push(0),G.push(1);let R=_;if(R=Bf(R,g[0].y-w,g[1].y+w,1),R=Bf(R,g[0].x-w,g[1].x+w,0),!R.length)return A;const N=[];for(G.length?N.push({polygons:R,bounds:g,depth:0}):P(R,g);N.length;){const q=N.pop(),Z=q.depth,ae=G[Z],ne=q.bounds[0],ce=q.bounds[1],me=ae===0?ne.x:ne.y,Re=ae===0?ce.x:ce.y,Xe=E?E(ae,me,Re):.5*(me+Re),Ve=Bf(q.polygons,me-w,Xe+w,ae),We=Bf(q.polygons,Xe-w,Re+w,ae);if(Ve.length){const Ke=[ne,new ut(ae===0?Xe:ce.x,ae===1?Xe:ce.y)];G.length>Z+1?N.push({polygons:Ve,bounds:Ke,depth:Z+1}):P(Ve,Ke)}if(We.length){const Ke=[new ut(ae===0?Xe:ne.x,ae===1?Xe:ne.y),ce];G.length>Z+1?N.push({polygons:We,bounds:Ke,depth:Z+1}):P(We,Ke)}}return A}(r,e,Math.ceil((u-a)/11.25),Math.ceil((h-p)/11.25),1,(_,g,x)=>{if(_===0)return .5*(g+x);{const b=ye((i.y+g/dt)/s);return(K(.5*(ye((i.y+x/dt)/s)+b))*s-i.y)*dt}})}function nb(r,e,i,s,a,u){const h=Math.pow(2,s.z-a.z);for(let p=0;p<i;p++){let _=r.int16[2*(p+e)+0],g=r.int16[2*(p+e)+1];_=(_+a.x*dt)*h-s.x*dt,g=(g+a.y*dt)*h-s.y*dt,u.push(new ut(_,g))}}let My,Py;bt(jf,"FillExtrusionBucket",{omit:["layers","features"]}),bt(yy,"PartData"),bt(gy,"FootprintSegment"),bt(vy,"BorderCentroidData"),bt(by,"GroundEffect");class nc extends ut{constructor(e,i,s){super(e,i),this.z=s}}class Ry extends nc{constructor(e,i,s,a){super(e,i,s),this.w=a}}function zy(r,e,i,s){const a=i==="x"?"y":"x",u=(s-r[i])/(e[i]-r[i]);r[a]=Math.round(r[a]+(e[a]-r[a])*u),r[i]=s,r.hasOwnProperty("z")&&(r.z=Ut(r.z,e.z,u)),r.hasOwnProperty("w")&&(r.w=Ut(r.w,e.w,u))}function Ly(r,e,i,s){const a=i,u=s;for(const h of["x","y"]){let p=r,_=e;p[h]>=_[h]&&(p=e,_=r),p[h]<a&&_[h]>a&&zy(p,_,h,a),p[h]<u&&_[h]>u&&zy(_,p,h,u)}}function Gf(r,e,i,s,a,u){const h=[];for(let p=0;p<r.length;p++){const _=r[p];let g;const x=h.length;let b=0;for(let w=0;w<_.length-1;w++){let E=_[w],A=_[w+1],P=0;const L=b;let k,j;u&&(P=Math.hypot(A.x-E.x,A.y-E.y),b+=P,k=E,j=A),E.x<e&&A.x<e||(E.x<e?E=new ut(e,E.y+(e-E.x)/(A.x-E.x)*(A.y-E.y))._round():A.x<e&&(A=new ut(e,E.y+(e-E.x)/(A.x-E.x)*(A.y-E.y))._round()),E.y<i&&A.y<i||(E.y<i?E=new ut(E.x+(i-E.y)/(A.y-E.y)*(A.x-E.x),i)._round():A.y<i&&(A=new ut(E.x+(i-E.y)/(A.y-E.y)*(A.x-E.x),i)._round()),E.x>=s&&A.x>=s||(E.x>=s?E=new ut(s,E.y+(s-E.x)/(A.x-E.x)*(A.y-E.y))._round():A.x>=s&&(A=new ut(s,E.y+(s-E.x)/(A.x-E.x)*(A.y-E.y))._round()),E.y>=a&&A.y>=a||(E.y>=a?E=new ut(E.x+(a-E.y)/(A.y-E.y)*(A.x-E.x),a)._round():A.y>=a&&(A=new ut(E.x+(a-E.y)/(A.y-E.y)*(A.x-E.x),a)._round()),g&&E.equals(g[g.length-1])||(g=[E],h.push(g),u&&u.push({progress:{min:L+Dy(k,j,E)*P,max:1},parentIndex:p,prevPoint:k,nextPoint:j})),g.push(A),u&&(u[u.length-1].progress.max=L+Dy(k,j,A)*P,u[u.length-1].nextPoint=j)))))}if(u&&b>0)for(let w=x;w<h.length;w++)u[w].progress.min/=b,u[w].progress.max/=b}return h}function sb(r,e,i,s,a){if(r.length<2)return void s.push(r);const u=[];for(;e.valid();){const[g,x]=e.get();for(let b=0;b<r.length-1;b++){const w=r[b],E=r[b+1],A=jh(w,E,g,x);if(A){const[P]=A,L=new ut(Ut(w.x,E.x,P),Ut(w.y,E.y,P));u.push({t:b+P,distance:0,point:L})}}e.next()}if(u.length===0)return void s.push(r);u.sort((g,x)=>g.t-x.t);let h=0,p=0,_=[];for(s.push(_);h!==r.length;){if(p===u.length){for(;h!==r.length;)_.length!==0&&_[_.length-1].equals(r[h])||_.push(r[h]),h++;break}u[p].t<=h?(_.length!==0&&_[_.length-1].equals(u[p].point)||_.push(u[p].point),Math.trunc(u[p].t),p++):(_.length!==0&&_[_.length-1].equals(r[h])||_.push(r[h]),h++)}}function Dy(r,e,i){return r.x!==e.x?(i.x-r.x)/(e.x-r.x):r.y!==e.y?(i.y-r.y)/(e.y-r.y):0}function Qh(r,e){return r.x*e.x+r.y*e.y}function Oy(r,e){if(r.length===1){let i=0;const s=e[i++];let a;for(;!a||s.equals(a);)if(a=e[i++],!a)return 1/0;for(;i<e.length;i++){const u=e[i],h=r[0],p=a.sub(s),_=u.sub(s),g=h.sub(s),x=Qh(p,p),b=Qh(p,_),w=Qh(_,_),E=Qh(g,p),A=Qh(g,_),P=x*w-b*b,L=(w*E-b*A)/P,k=(x*A-b*E)/P,j=s.z*(1-L-k)+a.z*L+u.z*k;if(isFinite(j))return j}return 1/0}{let i=1/0;for(const s of e)i=Math.min(i,s.z);return i}}function ky(r,e,i,s,a,u,h,p){const _=h*a.getElevationAt(r,e,!0,!0),g=u[0]!==0,x=g?u[1]===0?h*(u[0]/7-450):h*function(b,w,E){const A=Math.floor(w[0]/8),P=Math.floor(w[1]/8),L=10*(w[0]-8*A),k=10*(w[1]-8*P),j=b.getElevationAt(A,P,!0,!0),G=b.getMeterToDEM(E),R=Math.floor(.5*(L*G-1)),N=Math.floor(.5*(k*G-1)),q=b.tileCoordToPixel(A,P),Z=2*R+1,ae=2*N+1,ne=function(We,Ke,Le,He,Me){return[We.getElevationAtPixel(Ke,Le,!0),We.getElevationAtPixel(Ke+Me,Le,!0),We.getElevationAtPixel(Ke,Le+Me,!0),We.getElevationAtPixel(Ke+He,Le+Me,!0)]}(b,q.x-R,q.y-N,Z,ae),ce=Math.abs(ne[0]-ne[1]),me=Math.abs(ne[2]-ne[3]),Re=Math.abs(ne[0]-ne[2])+Math.abs(ne[1]-ne[3]),Xe=Math.min(.25,.5*G*(ce+me)/Z),Ve=Math.min(.25,.5*G*Re/ae);return j+Math.max(Xe*L,Ve*k)}(a,u,p):_;return{base:_+(i===0?-1:i),top:g?Math.max(x+s,_+i+2):_+s}}class ob{constructor(e){this._callback=e,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._callback()},0))}remove(){this._channel=void 0,this._callback=()=>{}}}class ab{constructor(){this.tasks={},this.taskQueue=[],Ct(["process"],this),this.invoker=new ob(this.process),this.nextId=0}add(e,i){const s=this.nextId++,a=function({type:u,isSymbolTile:h,zoom:p}){return p=p||0,u==="message"?0:u!=="maybePrepare"||h?u!=="parseTile"||h?u==="parseTile"&&h?300-p:u==="maybePrepare"&&h?400-p:500:200-p:100-p}(i);if(a===0){try{e()}finally{}return null}return this.tasks[s]={fn:e,metadata:i,priority:a,id:s},this.taskQueue.push(s),this.invoker.trigger(),{cancel:()=>{delete this.tasks[s]}}}process(){try{if(this.taskQueue=this.taskQueue.filter(s=>!!this.tasks[s]),!this.taskQueue.length)return;const e=this.pick();if(e===null)return;const i=this.tasks[e];if(delete this.tasks[e],this.taskQueue.length&&this.invoker.trigger(),!i)return;i.fn()}finally{}}pick(){let e=null,i=1/0;for(let a=0;a<this.taskQueue.length;a++){const u=this.tasks[this.taskQueue[a]];u.priority<i&&(i=u.priority,e=a)}if(e===null)return null;const s=this.taskQueue[e];return this.taskQueue.splice(e,1),s}remove(){this.invoker.remove()}}class Fy{constructor(e,i,s){this.target=e,this.parent=i,this.mapId=s,this.callbacks={},this.cancelCallbacks={},Ct(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.scheduler=new ab}send(e,i,s,a,u=!1,h){const p=Math.round(1e18*Math.random()).toString(36).substring(0,10);s&&(s.metadata=h,this.callbacks[p]=s);const _=new Set;return this.target.postMessage({id:p,type:e,hasCallback:!!s,targetMapId:a,mustQueue:u,sourceMapId:this.mapId,data:uo(i,_)},_),{cancel:()=>{s&&delete this.callbacks[p],this.target.postMessage({id:p,type:"<cancel>",targetMapId:a,sourceMapId:this.mapId})}}}receive(e){const i=e.data;if(!i)return;const s=i.id;if(s&&(!i.targetMapId||this.mapId===i.targetMapId))if(i.type==="<cancel>"){const a=this.cancelCallbacks[s];delete this.cancelCallbacks[s],a&&a.cancel()}else if(i.mustQueue||ki(self)){const a=this.callbacks[s],u=this.scheduler.add(()=>this.processTask(s,i),a&&a.metadata||{type:"message"});u&&(this.cancelCallbacks[s]=u)}else this.processTask(s,i)}processTask(e,i){if(delete this.cancelCallbacks[e],i.type==="<response>"){const s=this.callbacks[e];delete this.callbacks[e],s&&(i.error?s(ho(i.error)):s(null,ho(i.data)))}else{const s=new Set,a=i.hasCallback?(h,p)=>{this.target.postMessage({id:e,type:"<response>",sourceMapId:this.mapId,error:h?uo(h):null,data:uo(p,s)},s)}:()=>{},u=ho(i.data);if(this.parent[i.type])this.parent[i.type](i.sourceMapId,u,a);else if(this.parent.getWorkerSource){const h=i.type.split("."),{source:p,scope:_}=u;this.parent.getWorkerSource(i.sourceMapId,h[0],p,_)[h[1]](u,a)}else a(new Error(`Could not find function ${i.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}}var ed={workerUrl:"",workerClass:null,workerParams:void 0};const Fm="mapboxgl_preloaded_worker_pool";class sc{constructor(){this.active={}}acquire(e,i=sc.workerCount){if(!this.workers)for(this.workers=[];this.workers.length<i;)this.workers.push(ed.workerClass!=null?new ed.workerClass:new self.Worker(ed.workerUrl,ed.workerParams));return this.active[e]=!0,this.workers.slice()}release(e){delete this.active[e],this.workers&&this.numActive()===0&&(this.workers.forEach(i=>{i.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[Fm]}numActive(){return Object.keys(this.active).length}}sc.workerCount=2;class gu{constructor(e,i,s="Worker",a=sc.workerCount){this.workerPool=e,this.actors=[],this.currentActor=0,this.id=Ie();const u=this.workerPool.acquire(this.id,a);for(let h=0;h<u.length;h++){const p=new gu.Actor(u[h],i,this.id);p.name=`${s} ${h}`,this.actors.push(p)}this.ready=!1,this.broadcast("checkIfReady",null,()=>{this.ready=!0})}broadcast(e,i,s){fe(this.actors,(a,u)=>{a.send(e,i,u)},s=s||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach(e=>{e.remove()}),this.actors=[],this.workerPool.release(this.id)}}let td,Bm;function qf(){return td||(td=new sc),td}gu.Actor=Fy;class lb{constructor(e){this.module=e}createIntArray(e){const i=new Int32Array(e),s=this.module.malloc(i.length*i.BYTES_PER_ELEMENT);return this.module.heap32.set(i,s/i.BYTES_PER_ELEMENT),s}createFloatArray(e){const i=new Float32Array(e),s=this.module.malloc(i.length*i.BYTES_PER_ELEMENT);return this.module.heapF32.set(i,s/i.BYTES_PER_ELEMENT),s}createStringBuffer(e){const i=this.module.malloc(e.length+1);for(let s=0;s<e.length;++s)this.module.heapU8[i+s]=e.charCodeAt(s);return this.module.heapU8[i+e.length]=0,i}readStringBuffer(e){let i="";for(;this.module.heapU8[e]!==0;)i+=String.fromCharCode(this.module.heapU8[e]),++e;return i}setStyle(e){const i=e.entranceColorRgb,s=e.facadeGlazingColorRgb,a=e.roofColorRgb,u=e.wallColorRgb,h=e.normalScale;this.module.setStyle(i[0],i[1],i[2],s[0],s[1],s[2],a[0],a[1],a[2],u[0],u[1],u[2],h[0],h[1],h[2],e.tileToMeters)}setAOOptions(e,i){this.module.setAOOptions(e?1:0,i)}setMetricOptions(e,i){this.module.setMetricOptions(e?1:0,i)}setFacadeOptions(e,i,s){this.module.setFacadeOptions(e,i,s)}generateMesh(e,i){for(const p of e){const _=this.createStringBuffer(p.roofType),g=[0],x=[];for(const E of p.coordinates)if(Array.isArray(E)){for(const A of E)x.push(A.x),x.push(A.y);g.push(x.length)}const b=this.createIntArray(g),w=this.createFloatArray(x);this.module.addFeature(p.id,p.sourceId,p.minHeight,p.height,_,p.roofType.length,w,b,g.length-1),this.module.free(_),this.module.free(b),this.module.free(w)}for(const p of i){let _;_=p.entrances?JSON.parse(p.entrances):[];const g=this.createFloatArray(_),x=[];for(const w of p.coordinates)x.push(w.x),x.push(w.y);const b=this.createFloatArray(x);this.module.addFacade(p.sourceId,p.crossPerc,p.distanceToRoad,g,_.length,b,x.length),this.module.free(g),this.module.free(b)}if(!this.module.generateMesh()){const p=this.module.getLastError();return this.readStringBuffer(p)}const s=this.module.getMeshCount(),a=new Array(s);for(let p=0;p<s;p++){const _=this.module.getPositionsPtr(p),g=this.module.getPositionsLength(p),x=new Float32Array(this.module.heapF32.buffer,_,g),b=this.module.getNormalsPtr(p),w=this.module.getNormalsLength(p),E=new Float32Array(this.module.heapF32.buffer,b,w),A=this.module.getColorsPtr(p),P=this.module.getColorsLength(p),L=new Uint8Array(this.module.heapU8.buffer,A,P),k=this.module.getAOPtr(p),j=this.module.getAOLength(p),G=new Float32Array(this.module.heapF32.buffer,k,j),R=this.module.getIndicesPtr(p),N=this.module.getIndicesLength(p),q=new Int32Array(this.module.heap32.buffer,R,N),Z=this.module.getBuildingPart(p),ae=this.readStringBuffer(Z);a[p]={positions:x,normals:E,colors:L,ao:G,indices:q,buildingPart:ae}}const u=this.module.getRingCount(),h=[];for(let p=0;p<u;p++){const _=this.module.getRingPtr(p),g=this.module.getRingLength(p),x=new Float32Array(this.module.heapF32.buffer,_,g);h.push(x)}return{meshes:a,modifiedPolygonRings:h}}}let id,Nm,js,yu,Vm,vu=null,xu=null,By=null,Um=null;function Ny(){return ki(self)&&self.worker.dracoUrl?self.worker.dracoUrl:Nm||Jr.DRACO_URL}function Vy(){if(ki(self)&&self.worker.meshoptUrl)return self.worker.meshoptUrl;if(yu)return yu;const r=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]);if(typeof WebAssembly!="object")throw new Error("WebAssembly not supported, cannot instantiate meshoptimizer");return yu=WebAssembly.validate(r)?Jr.MESHOPT_SIMD_URL:Jr.MESHOPT_URL,yu}const $f={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},cb={5120:"DT_INT8",5121:"DT_UINT8",5122:"DT_INT16",5123:"DT_UINT16",5125:"DT_UINT32",5126:"DT_FLOAT32"},rd={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function Uy(r,e,i){const s=i.json.bufferViews.length,a=i.buffers.length;e.bufferView=s,i.json.bufferViews[s]={buffer:a,byteLength:r.byteLength},i.buffers[a]=r}const jm="KHR_draco_mesh_compression";function ub(r,e){const i=r.extensions&&r.extensions[jm];if(!i)return;const s=new js.Decoder,a=$y(e,i.bufferView),u=new js.Mesh;if(!s.DecodeArrayToMesh(a,a.byteLength,u))throw new Error("Failed to decode Draco mesh");const h=e.json.accessors[r.indices],p=$f[h.componentType],_=h.count*p.BYTES_PER_ELEMENT,g=js._malloc(_);p===Uint16Array?s.GetTrianglesUInt16Array(u,_,g):s.GetTrianglesUInt32Array(u,_,g),Uy(js.memory.buffer.slice(g,g+_),h,e),js._free(g);for(const x of Object.keys(i.attributes)){const b=s.GetAttributeByUniqueId(u,i.attributes[x]),w=e.json.accessors[r.attributes[x]],E=cb[w.componentType],A=w.count*rd[w.type]*$f[w.componentType].BYTES_PER_ELEMENT,P=js._malloc(A);s.GetAttributeDataArrayForAllPoints(u,b,js[E],A,P),Uy(js.memory.buffer.slice(P,P+A),w,e),js._free(P)}s.destroy(),u.destroy(),delete r.extensions[jm]}const Hf="EXT_meshopt_compression";function hb(r,e){if(!r.extensions||!r.extensions[Hf])return;const i=r.extensions[Hf],s=new Uint8Array(e.buffers[i.buffer],i.byteOffset||0,i.byteLength||0),a=new Uint8Array(i.count*i.byteStride);Vm.decodeGltfBuffer(a,i.count,i.byteStride,s,i.mode,i.filter),r.buffer=e.buffers.length,r.byteOffset=0,e.buffers[r.buffer]=a.buffer,delete r.extensions[Hf]}const jy=1179937895,Gy=new TextDecoder("utf8");function qy(r,e){return new URL(r,e).href}function db(r,e,i,s){return fetch(qy(r.uri,s)).then(a=>a.arrayBuffer()).then(a=>{e.buffers[i]=a})}function $y(r,e){const i=r.json.bufferViews[e];return new Uint8Array(r.buffers[i.buffer],i.byteOffset||0,i.byteLength)}function fb(r,e,i,s){if(r.uri){const a=qy(r.uri,s);return fetch(a).then(u=>u.blob()).then(u=>createImageBitmap(u)).then(u=>{e.images[i]=u})}if(r.bufferView!==void 0){const a=$y(e,r.bufferView),u=new Blob([a],{type:r.mimeType});return createImageBitmap(u).then(h=>{e.images[i]=h})}}function Hy(r,e=0,i){const s={json:null,images:[],buffers:[]};if(new Uint32Array(r,e,1)[0]===jy){const x=new Uint32Array(r,e);let b=2;const w=(x[b++]>>2)-3,E=x[b++]>>2;if(b++,s.json=JSON.parse(Gy.decode(x.subarray(b,b+E))),b+=E,b<w){const A=x[b++];b++;const P=e+(b<<2);s.buffers[0]=r.slice(P,P+A)}}else s.json=JSON.parse(Gy.decode(new Uint8Array(r,e)));const{buffers:a,images:u,meshes:h,extensionsUsed:p,bufferViews:_}=s.json;let g=Promise.resolve();if(a){const x=[];for(let b=0;b<a.length;b++){const w=a[b];w.uri?x.push(db(w,s,b,i)):s.buffers[b]||(s.buffers[b]=null)}g=Promise.all(x)}return g.then(()=>{const x=[],b=p&&p.includes(jm),w=p&&p.includes(Hf);if(b&&x.push(function(){if(!js)return id??(id=function(E){let A,P=null;function L(){A=new Uint8Array(P.buffer)}function k(){throw new Error("Unexpected Draco error.")}const j={a:{a:k,d:function(G,R,N){return A.copyWithin(G,R,R+N)},c:function(G){const R=A.length,N=Math.max(G>>>0,Math.ceil(1.2*R)),q=Math.ceil((N-R)/65536);try{return P.grow(q),L(),!0}catch{return!1}},b:k}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(E,j):E.then(G=>G.arrayBuffer()).then(G=>WebAssembly.instantiate(G,j))).then(G=>{const{Rb:R,Qb:N,P:q,T:Z,X:ae,Ja:ne,La:ce,Qa:me,Va:Re,Wa:Xe,eb:Ve,jb:We,f:Ke,e:Le,yb:He,zb:Me,Ab:ze,Bb:et,Db:it,Gb:Ot}=G.instance.exports;P=Le;const At=(()=>{let pt=0,Qe=0,Xt=0,Et=0;return Mt=>{Xt&&(R(Et),R(pt),Qe+=Xt,Xt=pt=0),pt||(Qe+=128,pt=N(Qe));const jt=Mt.length+7&-8;let Qt=pt;jt>=Qe&&(Xt=jt,Qt=Et=N(jt));for(let Jt=0;Jt<Mt.length;Jt++)A[Qt+Jt]=Mt[Jt];return Qt}})();return L(),Ke(),{memory:Le,_free:R,_malloc:N,Mesh:class{constructor(){this.ptr=q()}destroy(){Z(this.ptr)}},Decoder:class{constructor(){this.ptr=ne()}destroy(){We(this.ptr)}DecodeArrayToMesh(pt,Qe,Xt){const Et=At(pt),Mt=ce(this.ptr,Et,Qe,Xt.ptr);return!!ae(Mt)}GetAttributeByUniqueId(pt,Qe){return{ptr:me(this.ptr,pt.ptr,Qe)}}GetTrianglesUInt16Array(pt,Qe,Xt){Re(this.ptr,pt.ptr,Qe,Xt)}GetTrianglesUInt32Array(pt,Qe,Xt){Xe(this.ptr,pt.ptr,Qe,Xt)}GetAttributeDataArrayForAllPoints(pt,Qe,Xt,Et,Mt){Ve(this.ptr,pt.ptr,Qe.ptr,Xt,Et,Mt)}},DT_INT8:He(),DT_UINT8:Me(),DT_INT16:ze(),DT_UINT16:et(),DT_UINT32:it(),DT_FLOAT32:Ot()}})}(fetch(Ny())),id.then(E=>{js=E,id=void 0}))}()),w&&x.push(function(){if(Vm)return;const E=function(A){let P;const L=WebAssembly.instantiateStreaming(A,{}).then(G=>{P=G.instance,P.exports.__wasm_call_ctors()}),k={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},j={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};return{ready:L,supported:!0,decodeGltfBuffer(G,R,N,q,Z,ae){(function(ne,ce,me,Re,Xe,Ve,We){const Ke=ne.exports.sbrk,Le=Re+3&-4,He=Ke(Le*Xe),Me=Ke(Ve.length),ze=new Uint8Array(ne.exports.memory.buffer);ze.set(Ve,Me);const et=ce(He,Re,Xe,Me,Ve.length);if(et===0&&We&&We(He,Le,Xe),me.set(ze.subarray(He,He+Re*Xe)),Ke(He-Ke(0)),et!==0)throw new Error(`Malformed buffer data: ${et}`)})(P,P.exports[j[Z]],G,R,N,q,P.exports[k[ae]])}}}(fetch(Vy()));return E.ready.then(()=>{Vm=E})}()),u)for(let E=0;E<u.length;E++)x.push(fb(u[E],s,E,i));return(x.length?Promise.all(x):Promise.resolve()).then(()=>{if(b&&h)for(const{primitives:E}of h)for(const A of E)ub(A,s);if(w&&h&&_)for(const E of _)hb(E,s);return s})})}class Zy{constructor(e){this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.hasPattern=!1,this.worldview=e.worldview}updateFootprints(e,i){}prepare(){return function(){if(Um!=null||By!=null)return null;if(xu!=null)return xu;const e=fetch(Jr.BUILDING_GEN_URL);return xu=function(i){let s,a,u,h;function p(){s=new Uint8Array(h.buffer),a=new Int32Array(h.buffer),u=new Float32Array(h.buffer)}function _(){throw new Error("Unexpected BuildingGen error.")}const g=()=>{},x={a:{a:_,f:function(b){const w=s.length,E=Math.max(b>>>0,Math.ceil(1.2*w)),A=Math.ceil((E-w)/65536);try{return h.grow(A),p(),!0}catch{return!1}},g:_,b:g,c:g,d:g,e:g}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(i,x):i.then(b=>b.arrayBuffer()).then(b=>WebAssembly.instantiate(b,x))).then(b=>{const w=b.instance.exports;return(0,w.g)(),h=w.f,p(),new lb({setStyle:w.h,setAOOptions:w.i,setMetricOptions:w.j,setFacadeOptions:w.k,addFeature:w.l,addFacade:w.m,generateMesh:w.n,getLastError:w.o,getMeshCount:w.p,getPositionsPtr:w.q,getPositionsLength:w.r,getNormalsPtr:w.s,getNormalsLength:w.t,getColorsPtr:w.u,getColorsLength:w.v,getAOPtr:w.w,getAOLength:w.x,getIndicesPtr:w.y,getIndicesLength:w.z,getBuildingPart:w.A,getRingCount:w.B,getRingPtr:w.C,getRingLength:w.D,free:w.E,malloc:w.F,heapU8:s,heap32:a,heapF32:u})})}(e).then(i=>(xu=null,Um=i,Um)).catch(i=>{ei("Could not load building-gen"),xu=null,By=i}),xu}()}populate(e,i,s,a){}update(e,i,s,a,u,h,p){}isEmpty(){return!1}uploadPending(){return!1}upload(e){}destroy(){}getHeightAtTileCoord(e,i){return{height:Number.NEGATIVE_INFINITY,hidden:!0}}}let Wy,Xy;bt(Zy,"BuildingBucket",{omit:["layers"]});const pb=bi([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),mb=bi([{name:"a_z_offset_width",components:3,type:"Float32"}],4),{members:_b}=pb,gb=bi([{name:"a_packed",components:3,type:"Float32"}]),{members:yb}=gb,vb=bi([{name:"a_pattern_data",components:3,type:"Float32"}]),{members:xb}=vb;class Yy{constructor(e,i){this.width=e,this.height=i,this.nextRow=0,this.image=new Za({width:e,height:i}),this.positions={},this.uploaded=!1}getDash(e,i){const s=this.getKey(e,i);return this.positions[s]}trim(){const e=this.width,i=this.height=ct(this.nextRow);this.image.resize({width:e,height:i})}getKey(e,i){return e.join(",")+i}getDashRanges(e,i,s){const a=[];let u=e.length%2==1?-e[e.length-1]*s:0,h=e[0]*s,p=!0;a.push({left:u,right:h,isDash:p,zeroLength:e[0]===0});let _=e[0];for(let g=1;g<e.length;g++){p=!p;const x=e[g];u=_*s,_+=x,h=_*s,a.push({left:u,right:h,isDash:p,zeroLength:x===0})}return a}addRoundDash(e,i,s){const a=i/2;for(let u=-s;u<=s;u++){const h=this.width*(this.nextRow+s+u);let p=0,_=e[p];for(let g=0;g<this.width;g++){g/_.right>1&&(_=e[++p]);const x=Math.abs(g-_.left),b=Math.abs(g-_.right),w=Math.min(x,b);let E;const A=u/s*(a+1);if(_.isDash){const P=a-Math.abs(A);E=Math.sqrt(w*w+P*P)}else E=a-Math.sqrt(w*w+A*A);this.image.data[h+g]=Math.max(0,Math.min(255,E+128))}}}addRegularDash(e,i){for(let _=e.length-1;_>=0;--_){const g=e[_],x=e[_+1];g.zeroLength?e.splice(_,1):x&&x.isDash===g.isDash&&(x.left=g.left,e.splice(_,1))}const s=e[0],a=e[e.length-1];s.isDash===a.isDash&&(s.left=a.left-this.width,a.right=s.right+this.width);const u=this.width*this.nextRow;let h=0,p=e[h];for(let _=0;_<this.width;_++){_/p.right>1&&(p=e[++h]);const g=Math.abs(_-p.left),x=Math.abs(_-p.right),b=Math.min(g,x);this.image.data[u+_]=Math.max(0,Math.min(255,(p.isDash?b:-b)+i+128))}}addDash(e,i){const s=this.getKey(e,i);if(this.positions[s])return this.positions[s];const a=i==="round",u=a?7:0,h=2*u+1;if(this.nextRow+h>this.height)return ei("LineAtlas out of space"),null;e.length===0&&e.push(1);let p=0;for(let x=0;x<e.length;x++)e[x]<0&&(ei("Negative value is found in line dasharray, replacing values with 0"),e[x]=0),p+=e[x];if(p!==0){const x=this.width/p,b=this.getDashRanges(e,this.width,x);a?this.addRoundDash(b,x,u):this.addRegularDash(b,i==="square"?.5*x:0)}const _=this.nextRow+u;this.nextRow+=h;const g={tl:[_,u],br:[p,0]};return this.positions[s]=g,g}}bt(Yy,"LineAtlas");const bb=ni.VectorTileFeature.types,wb=Math.cos(Math.PI/180*37.5),Tb=Math.cos(Math.PI/180*5);class Gm{constructor(e){this.evaluationGlobals={zoom:0,lineProgress:void 0},this.elevationType="none",this.zoom=e.zoom,this.evaluationGlobals.zoom=this.zoom,this.overscaling=e.overscaling,this.pixelRatio=e.pixelRatio,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.projection=e.projection,this.hasPattern=!1,this.hasCrossSlope=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(i=>{this.gradients[i.id]={}}),this.layoutVertexArray=new Ch,this.layoutVertexArray2=new ys,this.patternVertexArray=new ys,this.indexArray=new en,this.programConfigurations=new l(e.layers,{zoom:e.zoom,lut:e.lut}),this.segments=new Tr,this.maxLineLength=0,this.zOffsetVertexArray=new ys,this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.tessellationStep=e.tessellationStep?e.tessellationStep:dt/64,this.worldview=e.worldview}updateFootprints(e,i){}populate(e,i,s,a){this.hasPattern=Im("line",this.layers,this.pixelRatio,i);const u=this.layers[0].layout.get("line-sort-key");this.tileToMeter=Pe(s);const h=this.layers[0].layout.get("line-elevation-reference");if(h==="hd-road-markup")this.elevationType="road";else{const w=this.layers[0].layout.get("line-z-offset"),E=w.isConstant()&&!w.constantOr(0);this.elevationType=h!=="sea"&&h!=="ground"&&E?"none":"offset",this.elevationType==="offset"&&h==="none"&&ei(`line-elevation-reference: ground is used for the layer ${this.layerIds[0]} because non-zero line-z-offset value was found.`)}const p=this.layers[0].layout.get("line-cross-slope");this.hasCrossSlope=this.elevationType==="offset"&&p!==void 0;const _=[];for(const{feature:w,id:E,index:A,sourceLayerIndex:P}of e){const L=this.layers[0]._featureFilter.needGeometry,k=gt(w,L);if(!this.layers[0]._featureFilter.filter(new Gi(this.zoom,{worldview:this.worldview}),k,s))continue;const j=u?u.evaluate(k,{},s):void 0,G={id:E,properties:w.properties,type:w.type,sourceLayerIndex:P,index:A,geometry:L?k.geometry:Tt(w,s,a),patterns:{},sortKey:j};_.push(G)}u&&_.sort((w,E)=>w.sortKey-E.sortKey);const{lineAtlas:g,featureIndex:x}=i,b=this.addConstantDashes(g);for(const w of _){const{geometry:E,index:A,sourceLayerIndex:P}=w;if(b&&this.addFeatureDashes(w,g),this.hasPattern){const L=Am("line",this.layers,w,this.zoom,this.pixelRatio,i);this.patternFeatures.push(L)}else this.addFeature(w,E,A,s,g.positions,i.availableImages,i.brightness,i.elevationFeatures);x.insert(e[A].feature,E,A,P,this.index)}}addConstantDashes(e){let i=!1;for(const s of this.layers){const a=s.paint.get("line-dasharray").value,u=s.layout.get("line-cap").value;if(a.kind!=="constant"||u.kind!=="constant")i=!0;else{const h=u.value,p=a.value;if(!p)continue;e.addDash(p,h)}}return i}addFeatureDashes(e,i){const s=this.zoom;for(const a of this.layers){const u=a.paint.get("line-dasharray").value,h=a.layout.get("line-cap").value;if(u.kind==="constant"&&h.kind==="constant")continue;let p,_;if(u.kind==="constant"){if(p=u.value,!p)continue}else p=u.evaluate({zoom:s},e);_=h.kind==="constant"?h.value:h.evaluate({zoom:s},e),i.addDash(p,_),e.patterns[a.id]=[i.getKey(p,_)]}}update(e,i,s,a,u,h,p,_){this.programConfigurations.updatePaintArrays(e,i,u,s,a,h,p,_)}addFeatures(e,i,s,a,u,h){for(const p of this.patternFeatures)this.addFeature(p,p.geometry,p.index,i,s,a,h)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=e.createVertexBuffer(this.layoutVertexArray2,yb)),this.patternVertexArray.length!==0&&(this.patternVertexBuffer=e.createVertexBuffer(this.patternVertexArray,xb)),!this.zOffsetVertexBuffer&&this.zOffsetVertexArray.length>0&&(this.zOffsetVertexBuffer=e.createVertexBuffer(this.zOffsetVertexArray,mb.members,!0)),this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,_b),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(e){if(e.properties&&e.properties.hasOwnProperty("mapbox_clip_start")&&e.properties.hasOwnProperty("mapbox_clip_end"))return{start:+e.properties.mapbox_clip_start,end:+e.properties.mapbox_clip_end}}addFeature(e,i,s,a,u,h,p,_){const g=this.layers[0].layout,x=g.get("line-join").evaluate(e,{}),b=g.get("line-cap").evaluate(e,{}),w=g.get("line-miter-limit"),E=g.get("line-round-limit");this.lineClips=this.lineFeatureClips(e),this.lineFeature=e,this.zOffsetValue=g.get("line-z-offset").value;const A=this.layers[0].paint.get("line-width").value;if(A.kind!=="constant"&&A.isLineProgressConstant===!1&&(this.variableWidthValue=A),this.elevationType==="road"){const P=this.layoutVertexArray.length;if(!this.addElevatedRoadFeature(e,i,a,_,x,b,w,E)){const[L,k]=this.clipRuntimeLinesToTile(i,1);for(let j=0;j<L.length;j++){const G=L[j],R=k[j],N={progress:{min:R.progress.min,max:R.progress.max},nextDir:this.computeSegNextDir(R,G),prevDir:this.computeSegPrevDir(R,G)};this.addLine(G,e,a,x,b,w,E,N)}this.fillNonElevatedRoadSegment(P)}}else for(const P of i)this.addLine(P,e,a,x,b,w,E);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,s,u,h,a,p,void 0,this.worldview)}computeSegNextDir(e,i){return e.nextPoint.sub(i.at(-2)).unit()}computeSegPrevDir(e,i){return i[1].sub(e.prevPoint).unit()}clipLinesToTile(e,i){return Gf(e,-i,-i,dt+i,dt+i)}clipRuntimeLinesToTile(e,i){const s=[];return[Gf(e,-i,-i,dt+i,dt+i,s),s]}addElevatedRoadFeature(e,i,s,a,u,h,p,_){const g=[],x=Hn.getElevationFeature(e,a);if(x){const b=this.clipLinesToTile(i,1),w=this.prepareElevatedLines(b,x,s);for(const E of w)g.push({geometry:E,elevation:x,elevationTileID:s,segment:{progress:{min:0,max:1},nextDir:void 0,prevDir:void 0}})}if(g.length===0)return!1;for(const b of g){const w=this.layoutVertexArray.length;this.addLine(b.geometry,e,s,u,h,p,_);const E=new us(s,b.elevationTileID);if(b.elevation)for(let A=w;A<this.layoutVertexArray.length;A++){const P=new ut(this.layoutVertexArray.int16[6*A]>>1,this.layoutVertexArray.int16[6*A+1]>>1),L=E.pointElevation(P,b.elevation,.05);this.updateHeightRange(L),this.zOffsetVertexArray.emplaceBack(L,0,0)}else this.fillNonElevatedRoadSegment(w)}return!0}prepareElevatedLines(e,i,s){if(i.constantHeight!=null)return e;const a=[],u=1/Pe(s);for(const h of e)sb(h,new kn(i,u),0,a);return a}fillNonElevatedRoadSegment(e){for(let i=e;i<this.layoutVertexArray.length;i++)this.zOffsetVertexArray.emplaceBack(0,0,0)}updateHeightRange(e){this.heightRange?(this.heightRange.min=Math.min(this.heightRange.min,e),this.heightRange.max=Math.max(this.heightRange.max,e)):this.heightRange={min:e,max:e}}addLine(e,i,s,a,u,h,p,_){this.distance=0,this.prevDistance=0,this.scaledDistance=0,this.totalDistance=0,this.totalFeatureLength=0,this.lineSoFar=0,this.currentVertex=void 0;const g=a==="none";this.patternJoinNone=this.hasPattern&&g,this.segmentStart=0,this.segmentStartf32=0,this.segmentPoints=[];const x=_&&_.progress.min>0,b=_&&_.progress.max<1;if(this.lineClips){let ae={min:this.lineClips.start,max:this.lineClips.end},ne=1;if(_){const Re=this.lineClips.end-this.lineClips.start;ae=function(Xe,Ve,We){return{min:ol(Xe.min,Ve,We),max:ol(Xe.max,Ve,We)}}(_.progress,{min:0,max:1},ae),Re>0&&(ne=(ae.max-ae.min)/Re)}const ce=+i.properties.mapbox_clip_feature_len,me=+i.properties.mapbox_clip_seg_len;if(Number.isNaN(ce)||Number.isNaN(me)){for(let Xe=0;Xe<e.length-1;Xe++)this.totalDistance+=e[Xe].dist(e[Xe+1]);const Re=this.totalDistance/(ae.max-ae.min);this.totalFeatureLength=Number.isFinite(Re)?Re:0,this.lineClips.start=ae.min,this.lineClips.end=ae.max,this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}else this.totalFeatureLength=ce,this.distance=me*ne,this.lineClips.start=ae.min,this.lineClips.end=ae.max,this.maxLineLength=Math.max(this.maxLineLength,this.distance);this.lineClipsArray.push(this.lineClips),this.updateScaledDistance()}const w=bb[i.type]==="Polygon";let E=e.length;for(;E>=2&&e[E-1].equals(e[E-2]);)E--;let A=0;for(;A<E-1&&e[A].equals(e[A+1]);)A++;if(E<(w?3:2))return;a==="bevel"&&(h=1.05);const P=this.segments.prepareSegment(10*E,this.layoutVertexArray,this.indexArray);let L,k,j,G,R,N,q,Z;_&&_.prevDir&&(N=_.prevDir.perp()),_&&_.nextDir&&(q=_.nextDir.perp()),this.e1=this.e2=-1,w&&(L=e[E-2],R=e[A].sub(L)._unit()._perp());for(let ae=A;ae<E;ae++){if(j=ae===E-1?w?e[A+1]:void 0:e[ae+1],j&&e[ae].equals(j))continue;R&&(G=R),L&&(k=L),L=e[ae],Z=this.evaluateLineProgressFeatures(k?k.dist(L):0),R=j?j.sub(L)._unit()._perp():G,G=G||R;const ne=k&&j;let ce=ne?a:w||g?"butt":u;const me=G.x*R.x+G.y*R.y;if(g){const Me=function(ze){if(ze.patternJoinNone){const et=ze.segmentPoints.length/2,it=ze.lineSoFar-ze.segmentStart;for(let Ot=0;Ot<et;++Ot){const At=ze.segmentPoints[2*Ot+1],pt=Math.round(ze.segmentPoints[2*Ot])+.5+.25*At;ze.patternVertexArray.emplaceBack(pt,it,ze.segmentStart),ze.patternVertexArray.emplaceBack(pt,it,ze.segmentStart)}ze.segmentPoints.length=0}ze.e1=ze.e2=-1};if(ne&&me<Tb){this.updateDistance(k,L),this.addCurrentVertex(L,G,1,1,P,Z),Me(this),this.addCurrentVertex(L,R,-1,-1,P,Z);continue}if(k){if(!j){this.updateDistance(k,L),this.addCurrentVertex(L,G,1,1,P,Z),Me(this);continue}ce="miter"}}let Re=G.add(R);Re.x===0&&Re.y===0||Re._unit();const Xe=Re.x*R.x+Re.y*R.y,Ve=Xe!==0?1/Xe:1/0,We=2*Math.sqrt(2-2*Xe),Ke=Xe<wb&&k&&j,Le=G.x*R.y-G.y*R.x>0,He=this.overscaling<=16?15*dt/(512*this.overscaling):0;if(ne&&ce==="round"){if(Ve<p)ce="miter";else if(Ve<=2){const Me=qm(L,-10,dt+10);ce=this.elevationType==="offset"&&(Me||this.hasCrossSlope)?"miter":"fakeround"}}if(ce==="miter"&&Ve>h&&(ce="bevel"),ce==="bevel"&&(Ve>2&&(ce="flipbevel"),Ve<h&&(ce="miter")),k&&!(ce==="miter"&&Ke)&&this.updateDistance(k,L),ce==="miter")if(Ke){const Me=L.dist(k);if(Me>2*He){const et=L.sub(L.sub(k)._mult(He/Me)._round());this.updateDistance(k,et),this.addCurrentVertex(et,G,0,0,P,Z),k=et}this.updateDistance(k,L),Re._mult(Ve),this.addCurrentVertex(L,Re,0,0,P,Z);const ze=L.dist(j);if(ze>2*He){const et=L.add(j.sub(L)._mult(He/ze)._round());this.updateDistance(L,et),this.addCurrentVertex(et,R,0,0,P,Z),L=et}}else Re._mult(Ve),this.addCurrentVertex(L,Re,0,0,P,Z);else if(ce==="flipbevel"){if(Ve>100)Re=R.mult(-1);else{const Me=Ve*G.add(R).mag()/G.sub(R).mag();Re._perp()._mult(Me*(Le?-1:1))}this.addCurrentVertex(L,Re,0,0,P,Z),this.addCurrentVertex(L,Re.mult(-1),0,0,P,Z)}else if(ce==="bevel"||ce==="fakeround"){Z!=null&&k&&this.addCurrentVertex(L,q||G,-1,-1,P,Z);const Me=L.dist(k)<=2*He&&ce!=="bevel",ze=Re.mult(Le?1:-1);ze._mult(Ve);const et=R.mult(Le?-1:1),it=G.mult(Le?-1:1),Ot=this.evaluateLineProgressFeatures(this.distance);if(Z==null&&(this.addHalfVertex(L,ze.x,ze.y,!1,!Le,0,P,Ot),Me||this.addHalfVertex(L,ze.x+2*it.x,ze.y+2*it.y,!1,Le,0,P,Ot)),ce==="fakeround"){const At=Math.round(180*We/Math.PI/20);this.addHalfVertex(L,it.x,it.y,!1,Le,0,P,Ot);for(let pt=0;pt<At;pt++){let Qe=pt/At;if(Qe!==.5){const Et=Qe-.5;Qe+=Qe*Et*(Qe-1)*((1.0904+me*(me*(3.55645-1.43519*me)-3.2452))*Et*Et+(.848013+me*(.215638*me-1.06021)))}const Xt=et.sub(it)._mult(Qe)._add(it)._unit();this.addHalfVertex(L,Xt.x,Xt.y,!1,Le,0,P,Ot)}this.addHalfVertex(L,et.x,et.y,!1,Le,0,P,Ot)}Me||Z!=null||this.addHalfVertex(L,ze.x+2*et.x,ze.y+2*et.y,!1,Le,0,P,Ot),Z!=null&&j&&this.addCurrentVertex(L,N||R,1,1,P,Z)}else if(ce==="butt")this.addCurrentVertex(L,Re,0,0,P,Z);else if(ce==="square"){if(!k){const Me=x?0:-1;this.addCurrentVertex(L,Re,Me,Me,P,Z)}if(this.addCurrentVertex(L,Re,0,0,P,Z),k){const Me=b?0:1;this.addCurrentVertex(L,Re,Me,Me,P,Z)}}else if(ce==="round"){if(k){const Me=!ne&&q?q:G;this.addCurrentVertex(L,Me,0,0,P,Z),!ne&&b||this.addCurrentVertex(L,Me,1,1,P,Z,!0)}if(j){const Me=!ne&&N?N:R;!ne&&x||this.addCurrentVertex(L,Me,-1,-1,P,Z,!0),this.addCurrentVertex(L,Me,0,0,P,Z)}}}}addVerticesTo(e,i,s,a,u,h,p,_,g,x){const b=(i.w-e.w)/this.tessellationStep|0;let w=0;const E=this.scaledDistance;if(b>1){this.lineSoFar=e.w;const P=(i.x-e.x)/b,L=(i.y-e.y)/b,k=(i.z-e.z)/b,j=(i.w-e.w)/b;for(let G=1;G<b;++G){e.x+=P,e.y+=L,e.z+=k,this.lineSoFar+=j,w+=j;const R=this.evaluateLineProgressFeatures(this.prevDistance+w);this.scaledDistance=(this.prevDistance+w)/this.totalDistance,this.addHalfVertex(e,s,a,x,!1,p,g,R),this.addHalfVertex(e,u,h,x,!0,-_,g,R)}}this.lineSoFar=i.w,this.scaledDistance=E;const A=this.evaluateLineProgressFeatures(this.distance);this.addHalfVertex(i,s,a,x,!1,p,g,A),this.addHalfVertex(i,u,h,x,!0,-_,g,A)}evaluateLineProgressFeatures(e){if(!this.variableWidthValue&&this.elevationType!=="offset")return null;this.evaluationGlobals.lineProgress=0,this.lineClips?this.evaluationGlobals.lineProgress=Math.min(1,(this.totalFeatureLength*this.lineClips.start+e)/this.totalFeatureLength):ei(`line-progress evaluation for ${this.layerIds[0]} requires enabling 'lineMetrics' for the source.`);let i=0;return this.variableWidthValue&&this.variableWidthValue.kind!=="constant"&&(i=this.variableWidthValue.evaluate(this.evaluationGlobals,this.lineFeature)||0),this.elevationType!=="offset"?{zOffset:0,variableWidth:i}:this.zOffsetValue.kind==="constant"?{zOffset:this.zOffsetValue.value,variableWidth:i}:{zOffset:this.zOffsetValue.evaluate(this.evaluationGlobals,this.lineFeature)||0,variableWidth:i}}addCurrentVertex(e,i,s,a,u,h,p=!1){const _=i.x+i.y*s,g=i.y-i.x*s,x=i.y*a-i.x,b=-i.y-i.x*a;if(h!=null){const w=this.elevationType==="offset",E=-10,A=dt+10,P=h.zOffset,L=new Ry(e.x,e.y,P,this.lineSoFar),k=!!w&&qm(e,E,A),j=this.lineSoFar,G=this.distance;if(this.currentVertex)if(k){const R=this.currentVertexIsOutside,N=this.currentVertex,q=new Ry(e.x,e.y,P,this.lineSoFar);if(Ly(N,q,E,A),!qm(q,E,A)){if(R){this.e1=this.e2=-1,this.distance-=N.dist(L),this.lineSoFar=N.w;const Z=this.evaluateLineProgressFeatures(N.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(N,_,g,p,!1,s,u,Z),this.addHalfVertex(N,x,b,p,!0,-a,u,Z),this.prevDistance=this.distance}this.distance=this.prevDistance+N.dist(q),this.scaledDistance=this.distance/this.totalDistance,this.addVerticesTo(N,q,_,g,x,b,s,a,u,p),this.distance=G,this.scaledDistance=this.distance/this.totalDistance}}else{const R=this.currentVertex;if(this.currentVertexIsOutside){Ly(R,L,E,A),this.e1=this.e2=-1,this.distance-=R.dist(L),this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=R.w;const N=this.evaluateLineProgressFeatures(R.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(R,_,g,p,!1,s,u,N),this.addHalfVertex(R,x,b,p,!0,-a,u,N),this.prevDistance=this.distance,this.distance=G,this.scaledDistance=this.distance/this.totalDistance}this.addVerticesTo(R,L,_,g,x,b,s,a,u,p)}else k||(this.addHalfVertex(e,_,g,p,!1,s,u,h),this.addHalfVertex(e,x,b,p,!0,-a,u,h));this.currentVertex=L,this.currentVertexIsOutside=k,this.lineSoFar=j}else this.addHalfVertex(e,_,g,p,!1,s,u,h),this.addHalfVertex(e,x,b,p,!0,-a,u,h)}addHalfVertex({x:e,y:i},s,a,u,h,p,_,g){if(this.patternJoinNone&&(this.segmentPoints.length===0&&(this.segmentStart=this.lineSoFar,this.segmentStartf32=Math.fround(this.lineSoFar)),h||this.segmentPoints.push(this.lineSoFar-this.segmentStart,p)),this.layoutVertexArray.emplaceBack((e<<1)+(u?1:0),(i<<1)+(h?1:0),Math.round(63*s)+128,Math.round(63*a)+128,1+(p===0?0:p<0?-1:1),0,this.lineSoFar-this.segmentStartf32),this.lineClips){const b=Ut(this.lineClips.start,this.lineClips.end,this.scaledDistance);this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,b)}const x=_.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,x),_.primitiveLength++),h?this.e2=x:this.e1=x,g!=null&&this.zOffsetVertexArray.emplaceBack(g.zOffset,g.variableWidth,g.variableWidth)}updateScaledDistance(){this.lineClips?(this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=this.totalFeatureLength*this.lineClips.start+this.distance):this.lineSoFar=this.distance}updateDistance(e,i){this.prevDistance=this.distance,this.distance+=e.dist(i),this.updateScaledDistance()}}function qm(r,e,i){return r.x<e||r.x>i||r.y<e||r.y>i}let Ky,Jy;function Qy(r,e,i){return e*(dt/(r.tileSize*Math.pow(2,i-r.tileID.overscaledZ)))}bt(Gm,"LineBucket",{omit:["layers","patternFeatures","currentVertex","currentVertexIsOutside"]});const ev=(r,e,i)=>(1-i)*r+i*e;function tv(r,e){return 1/Qy(r,1,e.tileZoom)}function iv(r,e,i,s){return r.translatePosMatrix(s||e.tileID.projMatrix,e,i.paint.get("line-translate"),i.paint.get("line-translate-anchor"))}const rv=r=>{const e=[];nv(r)&&e.push("RENDER_LINE_DASH"),r.paint.get("line-gradient")&&e.push("RENDER_LINE_GRADIENT");const i=r.paint.get("line-trim-offset");i[0]===0&&i[1]===0||e.push("RENDER_LINE_TRIM_OFFSET"),r.paint.get("line-border-width").constantOr(1)!==0&&e.push("RENDER_LINE_BORDER");const s=r.layout.get("line-join").constantOr("miter")==="none",a=!!r.paint.get("line-pattern").constantOr(1);return s&&a&&e.push("LINE_JOIN_NONE"),e};function nv(r){const e=r.paint.get("line-dasharray").value;return e.value||e.kind!=="constant"}let $m;const sv=()=>$m||($m={layout:Ky||(Ky=new br({"line-cap":new _t(ge.layout_line["line-cap"]),"line-join":new _t(ge.layout_line["line-join"]),"line-miter-limit":new Je(ge.layout_line["line-miter-limit"]),"line-round-limit":new Je(ge.layout_line["line-round-limit"]),"line-sort-key":new _t(ge.layout_line["line-sort-key"]),"line-z-offset":new _t(ge.layout_line["line-z-offset"]),"line-elevation-reference":new Je(ge.layout_line["line-elevation-reference"]),"line-cross-slope":new Je(ge.layout_line["line-cross-slope"]),visibility:new Je(ge.layout_line.visibility),"line-width-unit":new Je(ge.layout_line["line-width-unit"])})),paint:Jy||(Jy=new br({"line-opacity":new _t(ge.paint_line["line-opacity"]),"line-color":new _t(ge.paint_line["line-color"]),"line-translate":new Je(ge.paint_line["line-translate"]),"line-translate-anchor":new Je(ge.paint_line["line-translate-anchor"]),"line-width":new _t(ge.paint_line["line-width"]),"line-gap-width":new _t(ge.paint_line["line-gap-width"]),"line-offset":new _t(ge.paint_line["line-offset"]),"line-blur":new _t(ge.paint_line["line-blur"]),"line-dasharray":new _t(ge.paint_line["line-dasharray"]),"line-pattern":new _t(ge.paint_line["line-pattern"]),"line-pattern-cross-fade":new Je(ge.paint_line["line-pattern-cross-fade"]),"line-gradient":new Jo(ge.paint_line["line-gradient"]),"line-trim-offset":new Je(ge.paint_line["line-trim-offset"]),"line-trim-fade-range":new Je(ge.paint_line["line-trim-fade-range"]),"line-trim-color":new Je(ge.paint_line["line-trim-color"]),"line-emissive-strength":new Je(ge.paint_line["line-emissive-strength"]),"line-border-width":new _t(ge.paint_line["line-border-width"]),"line-border-color":new _t(ge.paint_line["line-border-color"]),"line-occlusion-opacity":new Je(ge.paint_line["line-occlusion-opacity"]),"line-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"line-gradient-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"line-trim-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"line-border-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},$m);class Sb extends _t{possiblyEvaluate(e,i){return i=new Gi(Math.floor(i.zoom),{now:i.now,fadeDuration:i.fadeDuration,transition:i.transition,worldview:i.worldview}),super.possiblyEvaluate(e,i)}evaluate(e,i,s,a){return i=we({},i,{zoom:Math.floor(i.zoom)}),super.evaluate(e,i,s,a)}}let nd;function ov(r,e){return e>0?e+2*r:r}const Eb=bi([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),Ib=bi([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),Ab=bi([{name:"a_projected_pos",components:4,type:"Float32"}],4);bi([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const Cb=bi([{name:"a_auto_z_offset",components:1,type:"Float32"}],4),Mb=bi([{name:"a_x_axis",components:3,type:"Float32"},{name:"a_y_axis",components:3,type:"Float32"}]),Pb=bi([{name:"a_texb",components:2,type:"Uint16"}]),Rb=bi([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"},{name:"a_elevation_from_sea",components:2,type:"Float32"}]),zb=bi([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"},{name:"a_auto_z_offset",components:1,type:"Float32"}]);bi([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const av=bi([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),Lb=bi([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);bi([{name:"triangle",components:3,type:"Uint16"}]),bi([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),bi([{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Float32",name:"zOffset"},{type:"Uint8",name:"hasIconTextFit"},{type:"Uint16",name:"elevationFeatureIndex"}]),bi([{type:"Float32",name:"offsetX"}]),bi([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);var Kr=24;function Db(r,e,i){return r.sections.forEach(s=>{s.text=function(a,u,h){const p=u.layout.get("text-transform").evaluate(h,{});return p==="uppercase"?a=a.toLocaleUpperCase():p==="lowercase"&&(a=a.toLocaleLowerCase()),Bs.applyArabicShaping&&(a=Bs.applyArabicShaping(a)),a}(s.text,e,i)}),r}const sd={"!":"︕","#":"＃",$:"＄","%":"％","&":"＆","(":"︵",")":"︶","*":"＊","+":"＋",",":"︐","-":"︲",".":"・","/":"／",":":"︓",";":"︔","<":"︿","=":"＝",">":"﹀","?":"︖","@":"＠","[":"﹇","\\":"＼","]":"﹈","^":"＾",_:"︳","`":"｀","{":"︷","|":"―","}":"︸","~":"～","¢":"￠","£":"￡","¥":"￥","¦":"￤","¬":"￢","¯":"￣","–":"︲","—":"︱","‘":"﹃","’":"﹄","“":"﹁","”":"﹂","…":"︙","‧":"・","₩":"￦","、":"︑","。":"︒","〈":"︿","〉":"﹀","《":"︽","》":"︾","「":"﹁","」":"﹂","『":"﹃","』":"﹄","【":"︻","】":"︼","〔":"︹","〕":"︺","〖":"︗","〗":"︘","！":"︕","（":"︵","）":"︶","，":"︐","－":"︲","．":"・","：":"︓","；":"︔","＜":"︿","＞":"﹀","？":"︖","［":"﹇","］":"﹈","＿":"︳","｛":"︷","｜":"―","｝":"︸","｟":"︵","｠":"︶","｡":"︒","｢":"﹁","｣":"﹂","←":"↑","→":"↓"};function Ob(r){return r==="︶"||r==="﹈"||r==="︸"||r==="﹄"||r==="﹂"||r==="︾"||r==="︼"||r==="︺"||r==="︘"||r==="﹀"||r==="︐"||r==="︓"||r==="︔"||r==="｀"||r==="￣"||r==="︑"||r==="︒"}function kb(r){return r==="︵"||r==="﹇"||r==="︷"||r==="﹃"||r==="﹁"||r==="︽"||r==="︻"||r==="︹"||r==="︗"||r==="︿"}var lv,Hm,cv,Zm={};/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */function Fb(){return lv||(lv=1,Zm.read=function(r,e,i,s,a){var u,h,p=8*a-s-1,_=(1<<p)-1,g=_>>1,x=-7,b=i?a-1:0,w=i?-1:1,E=r[e+b];for(b+=w,u=E&(1<<-x)-1,E>>=-x,x+=p;x>0;u=256*u+r[e+b],b+=w,x-=8);for(h=u&(1<<-x)-1,u>>=-x,x+=s;x>0;h=256*h+r[e+b],b+=w,x-=8);if(u===0)u=1-g;else{if(u===_)return h?NaN:1/0*(E?-1:1);h+=Math.pow(2,s),u-=g}return(E?-1:1)*h*Math.pow(2,u-s)},Zm.write=function(r,e,i,s,a,u){var h,p,_,g=8*u-a-1,x=(1<<g)-1,b=x>>1,w=a===23?Math.pow(2,-24)-Math.pow(2,-77):0,E=s?0:u-1,A=s?1:-1,P=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(p=isNaN(e)?1:0,h=x):(h=Math.floor(Math.log(e)/Math.LN2),e*(_=Math.pow(2,-h))<1&&(h--,_*=2),(e+=h+b>=1?w/_:w*Math.pow(2,1-b))*_>=2&&(h++,_/=2),h+b>=x?(p=0,h=x):h+b>=1?(p=(e*_-1)*Math.pow(2,a),h+=b):(p=e*Math.pow(2,b-1)*Math.pow(2,a),h=0));a>=8;r[i+E]=255&p,E+=A,p/=256,a-=8);for(h=h<<a|p,g+=a;g>0;r[i+E]=255&h,E+=A,h/=256,g-=8);r[i+E-A]|=128*P}),Zm}function uv(){if(cv)return Hm;cv=1,Hm=e;var r=Fb();function e(R){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(R)?R:new Uint8Array(R||0),this.pos=0,this.type=0,this.length=this.buf.length}e.Varint=0,e.Fixed64=1,e.Bytes=2,e.Fixed32=5;var i=4294967296,s=1/i,a=typeof TextDecoder>"u"?null:new TextDecoder("utf8");function u(R){return R.type===e.Bytes?R.readVarint()+R.pos:R.pos+1}function h(R,N,q){return q?4294967296*N+(R>>>0):4294967296*(N>>>0)+(R>>>0)}function p(R,N,q){var Z=N<=16383?1:N<=2097151?2:N<=268435455?3:Math.floor(Math.log(N)/(7*Math.LN2));q.realloc(Z);for(var ae=q.pos-1;ae>=R;ae--)q.buf[ae+Z]=q.buf[ae]}function _(R,N){for(var q=0;q<R.length;q++)N.writeVarint(R[q])}function g(R,N){for(var q=0;q<R.length;q++)N.writeSVarint(R[q])}function x(R,N){for(var q=0;q<R.length;q++)N.writeFloat(R[q])}function b(R,N){for(var q=0;q<R.length;q++)N.writeDouble(R[q])}function w(R,N){for(var q=0;q<R.length;q++)N.writeBoolean(R[q])}function E(R,N){for(var q=0;q<R.length;q++)N.writeFixed32(R[q])}function A(R,N){for(var q=0;q<R.length;q++)N.writeSFixed32(R[q])}function P(R,N){for(var q=0;q<R.length;q++)N.writeFixed64(R[q])}function L(R,N){for(var q=0;q<R.length;q++)N.writeSFixed64(R[q])}function k(R,N){return(R[N]|R[N+1]<<8|R[N+2]<<16)+16777216*R[N+3]}function j(R,N,q){R[q]=N,R[q+1]=N>>>8,R[q+2]=N>>>16,R[q+3]=N>>>24}function G(R,N){return(R[N]|R[N+1]<<8|R[N+2]<<16)+(R[N+3]<<24)}return e.prototype={destroy:function(){this.buf=null},readFields:function(R,N,q){for(q=q||this.length;this.pos<q;){var Z=this.readVarint(),ae=Z>>3,ne=this.pos;this.type=7&Z,R(ae,N,this),this.pos===ne&&this.skip(Z)}return N},readMessage:function(R,N){return this.readFields(R,N,this.readVarint()+this.pos)},readFixed32:function(){var R=k(this.buf,this.pos);return this.pos+=4,R},readSFixed32:function(){var R=G(this.buf,this.pos);return this.pos+=4,R},readFixed64:function(){var R=k(this.buf,this.pos)+k(this.buf,this.pos+4)*i;return this.pos+=8,R},readSFixed64:function(){var R=k(this.buf,this.pos)+G(this.buf,this.pos+4)*i;return this.pos+=8,R},readFloat:function(){var R=r.read(this.buf,this.pos,!0,23,4);return this.pos+=4,R},readDouble:function(){var R=r.read(this.buf,this.pos,!0,52,8);return this.pos+=8,R},readVarint:function(R){var N,q,Z=this.buf;return N=127&(q=Z[this.pos++]),q<128?N:(N|=(127&(q=Z[this.pos++]))<<7,q<128?N:(N|=(127&(q=Z[this.pos++]))<<14,q<128?N:(N|=(127&(q=Z[this.pos++]))<<21,q<128?N:function(ae,ne,ce){var me,Re,Xe=ce.buf;if(me=(112&(Re=Xe[ce.pos++]))>>4,Re<128||(me|=(127&(Re=Xe[ce.pos++]))<<3,Re<128)||(me|=(127&(Re=Xe[ce.pos++]))<<10,Re<128)||(me|=(127&(Re=Xe[ce.pos++]))<<17,Re<128)||(me|=(127&(Re=Xe[ce.pos++]))<<24,Re<128)||(me|=(1&(Re=Xe[ce.pos++]))<<31,Re<128))return h(ae,me,ne);throw new Error("Expected varint not more than 10 bytes")}(N|=(15&(q=Z[this.pos]))<<28,R,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var R=this.readVarint();return R%2==1?(R+1)/-2:R/2},readBoolean:function(){return!!this.readVarint()},readString:function(){var R=this.readVarint()+this.pos,N=this.pos;return this.pos=R,R-N>=12&&a?function(q,Z,ae){return a.decode(q.subarray(Z,ae))}(this.buf,N,R):function(q,Z,ae){for(var ne="",ce=Z;ce<ae;){var me,Re,Xe,Ve=q[ce],We=null,Ke=Ve>239?4:Ve>223?3:Ve>191?2:1;if(ce+Ke>ae)break;Ke===1?Ve<128&&(We=Ve):Ke===2?(192&(me=q[ce+1]))==128&&(We=(31&Ve)<<6|63&me)<=127&&(We=null):Ke===3?(Re=q[ce+2],(192&(me=q[ce+1]))==128&&(192&Re)==128&&((We=(15&Ve)<<12|(63&me)<<6|63&Re)<=2047||We>=55296&&We<=57343)&&(We=null)):Ke===4&&(Re=q[ce+2],Xe=q[ce+3],(192&(me=q[ce+1]))==128&&(192&Re)==128&&(192&Xe)==128&&((We=(15&Ve)<<18|(63&me)<<12|(63&Re)<<6|63&Xe)<=65535||We>=1114112)&&(We=null)),We===null?(We=65533,Ke=1):We>65535&&(We-=65536,ne+=String.fromCharCode(We>>>10&1023|55296),We=56320|1023&We),ne+=String.fromCharCode(We),ce+=Ke}return ne}(this.buf,N,R)},readBytes:function(){var R=this.readVarint()+this.pos,N=this.buf.subarray(this.pos,R);return this.pos=R,N},readPackedVarint:function(R,N){if(this.type!==e.Bytes)return R.push(this.readVarint(N));var q=u(this);for(R=R||[];this.pos<q;)R.push(this.readVarint(N));return R},readPackedSVarint:function(R){if(this.type!==e.Bytes)return R.push(this.readSVarint());var N=u(this);for(R=R||[];this.pos<N;)R.push(this.readSVarint());return R},readPackedBoolean:function(R){if(this.type!==e.Bytes)return R.push(this.readBoolean());var N=u(this);for(R=R||[];this.pos<N;)R.push(this.readBoolean());return R},readPackedFloat:function(R){if(this.type!==e.Bytes)return R.push(this.readFloat());var N=u(this);for(R=R||[];this.pos<N;)R.push(this.readFloat());return R},readPackedDouble:function(R){if(this.type!==e.Bytes)return R.push(this.readDouble());var N=u(this);for(R=R||[];this.pos<N;)R.push(this.readDouble());return R},readPackedFixed32:function(R){if(this.type!==e.Bytes)return R.push(this.readFixed32());var N=u(this);for(R=R||[];this.pos<N;)R.push(this.readFixed32());return R},readPackedSFixed32:function(R){if(this.type!==e.Bytes)return R.push(this.readSFixed32());var N=u(this);for(R=R||[];this.pos<N;)R.push(this.readSFixed32());return R},readPackedFixed64:function(R){if(this.type!==e.Bytes)return R.push(this.readFixed64());var N=u(this);for(R=R||[];this.pos<N;)R.push(this.readFixed64());return R},readPackedSFixed64:function(R){if(this.type!==e.Bytes)return R.push(this.readSFixed64());var N=u(this);for(R=R||[];this.pos<N;)R.push(this.readSFixed64());return R},skip:function(R){var N=7&R;if(N===e.Varint)for(;this.buf[this.pos++]>127;);else if(N===e.Bytes)this.pos=this.readVarint()+this.pos;else if(N===e.Fixed32)this.pos+=4;else{if(N!==e.Fixed64)throw new Error("Unimplemented type: "+N);this.pos+=8}},writeTag:function(R,N){this.writeVarint(R<<3|N)},realloc:function(R){for(var N=this.length||16;N<this.pos+R;)N*=2;if(N!==this.length){var q=new Uint8Array(N);q.set(this.buf),this.buf=q,this.length=N}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(R){this.realloc(4),j(this.buf,R,this.pos),this.pos+=4},writeSFixed32:function(R){this.realloc(4),j(this.buf,R,this.pos),this.pos+=4},writeFixed64:function(R){this.realloc(8),j(this.buf,-1&R,this.pos),j(this.buf,Math.floor(R*s),this.pos+4),this.pos+=8},writeSFixed64:function(R){this.realloc(8),j(this.buf,-1&R,this.pos),j(this.buf,Math.floor(R*s),this.pos+4),this.pos+=8},writeVarint:function(R){(R=+R||0)>268435455||R<0?function(N,q){var Z,ae;if(N>=0?(Z=N%4294967296|0,ae=N/4294967296|0):(ae=~(-N/4294967296),4294967295^(Z=~(-N%4294967296))?Z=Z+1|0:(Z=0,ae=ae+1|0)),N>=18446744073709552e3||N<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");q.realloc(10),function(ne,ce,me){me.buf[me.pos++]=127&ne|128,ne>>>=7,me.buf[me.pos++]=127&ne|128,ne>>>=7,me.buf[me.pos++]=127&ne|128,ne>>>=7,me.buf[me.pos++]=127&ne|128,me.buf[me.pos]=127&(ne>>>=7)}(Z,0,q),function(ne,ce){var me=(7&ne)<<4;ce.buf[ce.pos++]|=me|((ne>>>=3)?128:0),ne&&(ce.buf[ce.pos++]=127&ne|((ne>>>=7)?128:0),ne&&(ce.buf[ce.pos++]=127&ne|((ne>>>=7)?128:0),ne&&(ce.buf[ce.pos++]=127&ne|((ne>>>=7)?128:0),ne&&(ce.buf[ce.pos++]=127&ne|((ne>>>=7)?128:0),ne&&(ce.buf[ce.pos++]=127&ne)))))}(ae,q)}(R,this):(this.realloc(4),this.buf[this.pos++]=127&R|(R>127?128:0),R<=127||(this.buf[this.pos++]=127&(R>>>=7)|(R>127?128:0),R<=127||(this.buf[this.pos++]=127&(R>>>=7)|(R>127?128:0),R<=127||(this.buf[this.pos++]=R>>>7&127))))},writeSVarint:function(R){this.writeVarint(R<0?2*-R-1:2*R)},writeBoolean:function(R){this.writeVarint(!!R)},writeString:function(R){R=String(R),this.realloc(4*R.length),this.pos++;var N=this.pos;this.pos=function(Z,ae,ne){for(var ce,me,Re=0;Re<ae.length;Re++){if((ce=ae.charCodeAt(Re))>55295&&ce<57344){if(!me){ce>56319||Re+1===ae.length?(Z[ne++]=239,Z[ne++]=191,Z[ne++]=189):me=ce;continue}if(ce<56320){Z[ne++]=239,Z[ne++]=191,Z[ne++]=189,me=ce;continue}ce=me-55296<<10|ce-56320|65536,me=null}else me&&(Z[ne++]=239,Z[ne++]=191,Z[ne++]=189,me=null);ce<128?Z[ne++]=ce:(ce<2048?Z[ne++]=ce>>6|192:(ce<65536?Z[ne++]=ce>>12|224:(Z[ne++]=ce>>18|240,Z[ne++]=ce>>12&63|128),Z[ne++]=ce>>6&63|128),Z[ne++]=63&ce|128)}return ne}(this.buf,R,this.pos);var q=this.pos-N;q>=128&&p(N,q,this),this.pos=N-1,this.writeVarint(q),this.pos+=q},writeFloat:function(R){this.realloc(4),r.write(this.buf,R,this.pos,!0,23,4),this.pos+=4},writeDouble:function(R){this.realloc(8),r.write(this.buf,R,this.pos,!0,52,8),this.pos+=8},writeBytes:function(R){var N=R.length;this.writeVarint(N),this.realloc(N);for(var q=0;q<N;q++)this.buf[this.pos++]=R[q]},writeRawMessage:function(R,N){this.pos++;var q=this.pos;R(N,this);var Z=this.pos-q;Z>=128&&p(q,Z,this),this.pos=q-1,this.writeVarint(Z),this.pos+=Z},writeMessage:function(R,N,q){this.writeTag(R,e.Bytes),this.writeRawMessage(N,q)},writePackedVarint:function(R,N){N.length&&this.writeMessage(R,_,N)},writePackedSVarint:function(R,N){N.length&&this.writeMessage(R,g,N)},writePackedBoolean:function(R,N){N.length&&this.writeMessage(R,w,N)},writePackedFloat:function(R,N){N.length&&this.writeMessage(R,x,N)},writePackedDouble:function(R,N){N.length&&this.writeMessage(R,b,N)},writePackedFixed32:function(R,N){N.length&&this.writeMessage(R,E,N)},writePackedSFixed32:function(R,N){N.length&&this.writeMessage(R,A,N)},writePackedFixed64:function(R,N){N.length&&this.writeMessage(R,P,N)},writePackedSFixed64:function(R,N){N.length&&this.writeMessage(R,L,N)},writeBytesField:function(R,N){this.writeTag(R,e.Bytes),this.writeBytes(N)},writeFixed32Field:function(R,N){this.writeTag(R,e.Fixed32),this.writeFixed32(N)},writeSFixed32Field:function(R,N){this.writeTag(R,e.Fixed32),this.writeSFixed32(N)},writeFixed64Field:function(R,N){this.writeTag(R,e.Fixed64),this.writeFixed64(N)},writeSFixed64Field:function(R,N){this.writeTag(R,e.Fixed64),this.writeSFixed64(N)},writeVarintField:function(R,N){this.writeTag(R,e.Varint),this.writeVarint(N)},writeSVarintField:function(R,N){this.writeTag(R,e.Varint),this.writeSVarint(N)},writeStringField:function(R,N){this.writeTag(R,e.Bytes),this.writeString(N)},writeFloatField:function(R,N){this.writeTag(R,e.Fixed32),this.writeFloat(N)},writeDoubleField:function(R,N){this.writeTag(R,e.Fixed64),this.writeDouble(N)},writeBooleanField:function(R,N){this.writeVarintField(R,!!N)}},Hm}var Zf=eo(uv());const Wm=3;function Bb(r,e,i){e.glyphs=[],r===1&&i.readMessage(Nb,e)}function Nb(r,e,i){if(r===3){const{id:s,bitmap:a,width:u,height:h,left:p,top:_,advance:g}=i.readMessage(Vb,{});e.glyphs.push({id:s,bitmap:new Za({width:u+2*Wm,height:h+2*Wm},a),metrics:{width:u,height:h,left:p,top:_,advance:g}})}else r===4?e.ascender=i.readSVarint():r===5&&(e.descender=i.readSVarint())}function Vb(r,e,i){r===1?e.id=i.readVarint():r===2?e.bitmap=i.readBytes():r===3?e.width=i.readVarint():r===4?e.height=i.readVarint():r===5?e.left=i.readSVarint():r===6?e.top=i.readSVarint():r===7&&(e.advance=i.readVarint())}const Ub=Wm,Zn={horizontal:1,vertical:2,horizontalOnly:3};class od{constructor(){this.scale=1,this.fontStack="",this.image=null}static forText(e,i){const s=new od;return s.scale=e||1,s.fontStack=i,s}static forImage(e){const i=new od;return i.image=e,i}}class bu{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(e,i,s){const a=new bu;for(let u=0;u<e.sections.length;u++){const h=e.sections[u];h.image?a.addImageSection(h,s):a.addTextSection(h,i)}return a}length(){return this.text.length}getSection(e){return this.sections[this.sectionIndex[e]]}getSections(){return this.sections}getSectionIndex(e){return this.sectionIndex[e]}getCodePoint(e){return this.text.codePointAt(e)}verticalizePunctuation(e){this.text=function(i,s){let a="";for(let u=0;u<i.length;u++){const h=i.charCodeAt(u+1)||null,p=i.charCodeAt(u-1)||null;a+=!s&&(h&&sf(h)&&!sd[i[u+1]]||p&&sf(p)&&!sd[i[u-1]])||!sd[i[u]]?i[u]:sd[i[u]]}return a}(this.text,e)}trim(){let e=0;for(let s=0;s<this.text.length&&Wf[this.text.charCodeAt(s)];s++)e++;let i=this.text.length;for(let s=this.text.length-1;s>=0&&s>=e&&Wf[this.text.charCodeAt(s)];s--)i--;this.text=this.text.substring(e,i),this.sectionIndex=this.sectionIndex.slice(e,i)}substring(e,i){const s=new bu;return s.text=this.text.substring(e,i),s.sectionIndex=this.sectionIndex.slice(e,i),s.sections=this.sections,s}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((e,i)=>Math.max(e,this.sections[i].scale),0)}addTextSection(e,i){this.text+=e.text,this.sections.push(od.forText(e.scale,e.fontStack||i));const s=this.sections.length-1;for(let a=0;a<e.text.length;++a)this.sectionIndex.push(s)}addImageSection(e,i){const s=e.image?e.image.getPrimary():null;if(!s)return void ei("Can't add FormattedSection with an empty image.");s.scaleSelf(i);const a=this.getNextImageSectionCharCode();a?(this.text+=String.fromCodePoint(a),this.sections.push(od.forImage(s)),this.sectionIndex.push(this.sections.length-1)):ei("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function Xm(r,e,i,s,a,u,h,p,_,g,x,b,w,E,A,P=1){const L=bu.fromFeature(r,a,P);b===Zn.vertical&&L.verticalizePunctuation(w);let k=[];const j=function(Z,ae,ne,ce,me,Re){if(!Z)return[];const Xe=[],Ve=function(He,Me,ze,et,it,Ot){let At=0;for(let pt=0;pt<He.length();pt++){const Qe=He.getSection(pt);At+=hv(He.getCodePoint(pt),Qe,et,it,Me,Ot)}return At/Math.max(1,Math.ceil(At/ze))}(Z,ae,ne,ce,me,Re),We=Z.text.indexOf("​")>=0;let Ke=0;for(let He=0;He<Z.length();He++){const Me=Z.getSection(He),ze=Z.getCodePoint(He);if(Wf[ze]||(Ke+=hv(ze,Me,ce,me,ae,Re)),He<Z.length()-1){const et=!((Le=ze)<11904||!(Ft["Bopomofo Extended"](Le)||Ft.Bopomofo(Le)||Ft["CJK Compatibility Forms"](Le)||Ft["CJK Compatibility Ideographs"](Le)||Ft["CJK Compatibility"](Le)||Ft["CJK Radicals Supplement"](Le)||Ft["CJK Strokes"](Le)||Ft["CJK Symbols and Punctuation"](Le)||Ft["CJK Unified Ideographs Extension A"](Le)||Ft["CJK Unified Ideographs"](Le)||Ft["Enclosed CJK Letters and Months"](Le)||Ft["Halfwidth and Fullwidth Forms"](Le)||Ft.Hiragana(Le)||Ft["Ideographic Description Characters"](Le)||Ft["Kangxi Radicals"](Le)||Ft["Katakana Phonetic Extensions"](Le)||Ft.Katakana(Le)||Ft["Vertical Forms"](Le)||Ft["Yi Radicals"](Le)||Ft["Yi Syllables"](Le)));(jb[ze]||et||Me.image)&&Xe.push(fv(He+1,Ke,Ve,Xe,Gb(ze,Z.getCodePoint(He+1),et&&We),!1))}}var Le;return pv(fv(Z.length(),Ke,Ve,Xe,0,!0))}(L,g,u,e,s,E),{processBidirectionalText:G,processStyledBidirectionalText:R}=Bs;if(G&&L.sections.length===1){const Z=G(L.toString(),j);for(const ae of Z){const ne=new bu;ne.text=ae,ne.sections=L.sections;for(let ce=0;ce<ae.length;ce++)ne.sectionIndex.push(0);k.push(ne)}}else if(R){const Z=R(L.text,L.sectionIndex,j);for(const ae of Z){const ne=new bu;ne.text=ae[0],ne.sectionIndex=ae[1],ne.sections=L.sections,k.push(ne)}}else k=function(Z,ae){const ne=[],ce=Z.text;let me=0;for(const Re of ae)ne.push(Z.substring(me,Re)),me=Re;return me<ce.length&&ne.push(Z.substring(me,ce.length)),ne}(L,j);const N=[],q={positionedLines:N,text:L.toString(),top:x[1],bottom:x[1],left:x[0],right:x[0],writingMode:b,iconsInText:!1,verticalizable:!1,hasBaseline:!1};if(function(Z,ae,ne,ce,me,Re,Xe,Ve,We,Ke,Le,He){let Me=0,ze=0,et=0;const it=Ve==="right"?1:Ve==="left"?0:.5;let Ot=!1;for(const Mt of me){const jt=Mt.getSections();for(const Qt of jt){if(Qt.image)continue;const Jt=ae[Qt.fontStack];if(Jt&&(Ot=Jt.ascender!==void 0&&Jt.descender!==void 0,!Ot))break}if(!Ot)break}let At=0;for(const Mt of me){Mt.trim();const jt=Mt.getMaxScale(),Qt=(jt-1)*Kr,Jt={positionedGlyphs:[],lineOffset:0};Z.positionedLines[At]=Jt;const ai=Jt.positionedGlyphs;let ii=0;if(!Mt.length()){ze+=Re,++At;continue}let li=0,Li=0;for(let $=0;$<Mt.length();$++){const W=Mt.getSection($),De=Mt.getSectionIndex($),lt=Mt.getCodePoint($);let mt=W.scale,ft=null,St=null,Vt=null,hi=Kr,di=0;We===Zn.vertical&&((pt=lt)===12312||pt===12313||pt===12316||pt===12540||pt===12448)&&(We=Zn.horizontal);const ri=!(We===Zn.horizontal||!Le&&!xh(lt)||Le&&(Wf[lt]||am(lt)));if(W.image){const Bi=ce.get(W.image.toString());if(!Bi)continue;Vt=W.image,Z.iconsInText=Z.iconsInText||!0,St=Bi.paddedRect;const Xi=Bi.displaySize;mt=mt*Kr/He,ft={width:Xi[0],height:Xi[1],left:0,top:-3,advance:ri?Xi[1]:Xi[0],localGlyph:!1},di=Ot?-ft.height*mt:jt*Kr-17-Xi[1]*mt,hi=ft.advance;const fi=(ri?Xi[0]:Xi[1])*mt-Kr*jt;fi>0&&fi>ii&&(ii=fi)}else{const Bi=ne[W.fontStack];if(!Bi)continue;Bi[lt]&&(St=Bi[lt]);const Xi=ae[W.fontStack];if(!Xi)continue;const fi=Xi.glyphs[lt];if(!fi)continue;if(ft=fi.metrics,hi=lt!==8203?Kr:0,Ot){const yr=Xi.ascender!==void 0?Math.abs(Xi.ascender):0,tr=Xi.descender!==void 0?Math.abs(Xi.descender):0,Di=(yr+tr)*mt;li<Di&&(li=Di,Li=(yr-tr)/2*mt),di=-yr*mt}else di=(jt-mt)*Kr-17}ri?(Z.verticalizable=!0,ai.push({glyph:lt,image:Vt,x:Me,y:ze+di,vertical:ri,scale:mt,localGlyph:ft.localGlyph,fontStack:W.fontStack,sectionIndex:De,metrics:ft,rect:St}),Me+=hi*mt+Ke):(ai.push({glyph:lt,image:Vt,x:Me,y:ze+di,vertical:ri,scale:mt,localGlyph:ft.localGlyph,fontStack:W.fontStack,sectionIndex:De,metrics:ft,rect:St}),Me+=ft.advance*mt+Ke)}ai.length!==0&&(et=Math.max(Me-Ke,et),Ot?mv(ai,it,ii,Li,Re*jt/2):mv(ai,it,ii,0,Re/2)),Me=0;const er=Re*jt+ii;Jt.lineOffset=Math.max(ii,Qt),ze+=er,++At}var pt;const Qe=ze,{horizontalAlign:Xt,verticalAlign:Et}=Ym(Xe);(function(Mt,jt,Qt,Jt,ai,ii){const li=(jt-Qt)*ai,Li=-ii*Jt;for(const er of Mt)for(const $ of er.positionedGlyphs)$.x+=li,$.y+=Li})(Z.positionedLines,it,Xt,Et,et,Qe),Z.top+=-Et*Qe,Z.bottom=Z.top+Qe,Z.left+=-Xt*et,Z.right=Z.left+et,Z.hasBaseline=Ot}(q,e,i,s,k,h,p,_,b,g,w,A),!function(Z){for(const ae of Z)if(ae.positionedGlyphs.length!==0)return!1;return!0}(N))return q}const Wf={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},jb={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function hv(r,e,i,s,a,u){if(e.image){const h=s.get(e.image.toString());return h?h.displaySize[0]*e.scale*Kr/u+a:0}{const h=i[e.fontStack],p=h&&h.glyphs[r];return p?p.metrics.advance*e.scale+a:0}}function dv(r,e,i,s){const a=Math.pow(r-e,2);return s?r<e?a/2:2*a:a+Math.abs(i)*i}function Gb(r,e,i){let s=0;return r===10&&(s-=1e4),i&&(s+=150),r!==40&&r!==65288||(s+=50),e!==41&&e!==65289||(s+=50),s}function fv(r,e,i,s,a,u){let h=null,p=dv(e,i,a,u);for(const _ of s){const g=dv(e-_.x,i,a,u)+_.badness;g<=p&&(h=_,p=g)}return{index:r,x:e,priorBreak:h,badness:p}}function pv(r){return r?pv(r.priorBreak).concat(r.index):[]}function Ym(r){let e=.5,i=.5;switch(r){case"right":case"top-right":case"bottom-right":e=1;break;case"left":case"top-left":case"bottom-left":e=0}switch(r){case"bottom":case"bottom-right":case"bottom-left":i=1;break;case"top":case"top-right":case"top-left":i=0}return{horizontalAlign:e,verticalAlign:i}}function mv(r,e,i,s,a){if(!(e||i||s||a))return;const u=r.length-1,h=r[u],p=(h.x+h.metrics.advance*h.scale)*e;for(let _=0;_<=u;_++)r[_].x-=p,r[_].y+=i+s+a}function _v(r){return r.imagePrimary!==void 0&&r.top!==void 0&&r.bottom!==void 0&&r.left!==void 0&&r.right!==void 0}function qb(r,e,i,s){const{horizontalAlign:a,verticalAlign:u}=Ym(s),h=i[0]-r.displaySize[0]*a,p=i[1]-r.displaySize[1]*u;return{imagePrimary:r,imageSecondary:e,top:p,bottom:p+r.displaySize[1],left:h,right:h+r.displaySize[0]}}function gv(r,e,i,s,a,u){const h=r.imagePrimary;let p;if(h.content){const L=h.content,k=h.pixelRatio||1;p=[L[0]/k,L[1]/k,h.displaySize[0]-L[2]/k,h.displaySize[1]-L[3]/k]}const _=e.left*u,g=e.right*u;let x,b,w,E;i==="width"||i==="both"?(E=a[0]+_-s[3],b=a[0]+g+s[1]):(E=a[0]+(_+g-h.displaySize[0])/2,b=E+h.displaySize[0]);const A=e.top*u,P=e.bottom*u;return i==="height"||i==="both"?(x=a[1]+A-s[0],w=a[1]+P+s[2]):(x=a[1]+(A+P-h.displaySize[1])/2,w=x+h.displaySize[1]),{imagePrimary:h,imageSecondary:void 0,top:x,right:b,bottom:w,left:E,collisionPadding:p}}function yv(r){return!r.imagePrimary.stretchX}function vv(r){return!r.imagePrimary.stretchY}function xv(r){return{width:r.right-r.left,height:r.bottom-r.top}}const So=128;function bv(r,e,i){const{expression:s}=e;if(s.kind==="constant")return{kind:"constant",layoutSize:s.evaluate(new Gi(r+1,{worldview:i}))};if(s.kind==="source")return{kind:"source"};{const{zoomStops:a,interpolationType:u}=s;let h=0;for(;h<a.length&&a[h]<=r;)h++;h=Math.max(0,h-1);let p=h;for(;p<a.length&&a[p]<r+1;)p++;p=Math.min(a.length-1,p);const _=a[h],g=a[p];return s.kind==="composite"?{kind:"composite",minZoom:_,maxZoom:g,interpolationType:u}:{kind:"camera",minZoom:_,maxZoom:g,minSize:s.evaluate(new Gi(_,{worldview:i})),maxSize:s.evaluate(new Gi(g,{worldview:i})),interpolationType:u}}}function Km(r,{uSize:e,uSizeT:i},{lowerSize:s,upperSize:a}){return r.kind==="source"?s/So:r.kind==="composite"?Ut(s/So,a/So,i):e}function ad(r,e,i=1){let s=0,a=0;if(r.kind==="constant")a=r.layoutSize*i;else if(r.kind!=="source"){const{interpolationType:u,minZoom:h,maxZoom:p}=r,_=u?Q($n.interpolationFactor(u,e,h,p),0,1):0;r.kind==="camera"?a=Ut(r.minSize,r.maxSize,_)*i:s=_*i}return{uSizeT:s,uSize:a}}class ra extends ut{constructor(e,i,s,a,u){super(e,i),this.angle=a,this.z=s,u!==void 0&&(this.segment=u)}clone(){return new ra(this.x,this.y,this.z,this.angle,this.segment)}}function wv(r,e,i,s,a){if(e.segment===void 0)return!0;let u=e,h=e.segment+1,p=0;for(;p>-i/2;){if(h--,h<0)return!1;p-=r[h].dist(u),u=r[h]}p+=r[h].dist(r[h+1]),h++;const _=[];let g=0;for(;p<i/2;){const x=r[h],b=r[h+1];if(!b)return!1;let w=r[h-1].angleTo(x)-x.angleTo(b);for(w=Math.abs((w+3*Math.PI)%(2*Math.PI)-Math.PI),_.push({distance:p,angleDelta:w}),g+=w;p-_[0].distance>s;)g-=_.shift().angleDelta;if(g>a)return!1;h++,p+=x.dist(b)}return!0}function Tv(r){let e=0;for(let i=0;i<r.length-1;i++)e+=r[i].dist(r[i+1]);return e}function Sv(r,e,i){return r?.6*e*i:0}function Ev(r,e){return Math.max(r?r.right-r.left:0,e?e.right-e.left:0)}function $b(r,e,i,s,a,u){const h=Sv(i,a,u),p=Ev(i,s)*u;let _=0;const g=Tv(r)/2;for(let x=0;x<r.length-1;x++){const b=r[x],w=r[x+1],E=b.dist(w);if(_+E>g){const A=(g-_)/E,P=Ut(b.x,w.x,A),L=Ut(b.y,w.y,A),k=new ra(P,L,0,w.angleTo(b),x);return!h||wv(r,k,p,h,e)?k:void 0}_+=E}}function Hb(r,e,i,s,a,u,h,p,_){const g=Sv(s,u,h),x=Ev(s,a),b=x*h,w=r[0].x===0||r[0].x===_||r[0].y===0||r[0].y===_;return e-b<e/4&&(e=b+e/4),Iv(r,w?e/2*p%e:(x/2+2*u)*h*p%e,e,g,i,b,w,!1,_)}function Iv(r,e,i,s,a,u,h,p,_){const g=u/2,x=Tv(r);let b=0,w=e-i,E=[];for(let A=0;A<r.length-1;A++){const P=r[A],L=r[A+1],k=P.dist(L),j=L.angleTo(P);for(;w+i<b+k;){w+=i;const G=(w-b)/k,R=Ut(P.x,L.x,G),N=Ut(P.y,L.y,G);if(R>=0&&R<_&&N>=0&&N<_&&w-g>=0&&w+g<=x){const q=new ra(R,N,0,j,A);s&&!wv(r,q,u,s,a)||E.push(q)}}b+=k}return p||E.length||h||(E=Iv(r,b/2,i,s,a,u,h,!0,_)),E}function Av(r){let e=0,i=0;for(const h of r)e+=h.w*h.h,i=Math.max(i,h.w);r.sort((h,p)=>p.h-h.h);const s=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(e/.95)),i),h:1/0}];let a=0,u=0;for(const h of r)for(let p=s.length-1;p>=0;p--){const _=s[p];if(!(h.w>_.w||h.h>_.h)){if(h.x=_.x,h.y=_.y,u=Math.max(u,h.y+h.h),a=Math.max(a,h.x+h.w),h.w===_.w&&h.h===_.h){const g=s.pop();p<s.length&&(s[p]=g)}else h.h===_.h?(_.x+=h.w,_.w-=h.w):h.w===_.w?(_.y+=h.h,_.h-=h.h):(s.push({x:_.x+h.w,y:_.y,w:_.w-h.w,h:h.h}),_.y+=h.h,_.h-=h.h);break}}return{w:a,h:u,fill:e/(a*u)||0}}bt(ra,"Anchor");const oc=1;class ld{static getImagePositionScale(e,i,s){if(i&&e&&e.options&&e.options.transform){const a=e.options.transform;return{x:a.a,y:a.d}}return{x:s,y:s}}constructor(e,i,s,a){this.paddedRect=e;const{pixelRatio:u,version:h,stretchX:p,stretchY:_,content:g,sdf:x,usvg:b}=i;this.pixelRatio=u,this.stretchX=p,this.stretchY=_,this.content=g,this.version=h,this.padding=s,this.sdf=x,this.usvg=b,this.scale=ld.getImagePositionScale(a,b,u)}get tl(){return[this.paddedRect.x+this.padding,this.paddedRect.y+this.padding]}get br(){return[this.paddedRect.x+this.paddedRect.w-this.padding,this.paddedRect.y+this.paddedRect.h-this.padding]}get displaySize(){return[(this.paddedRect.w-2*this.padding)/this.scale.x,(this.paddedRect.h-2*this.padding)/this.scale.y]}}function Jm(r,e,i){const s=zs.parse(r),a=function(u,h,p=[1,1]){return{x:0,y:0,w:(u.data?u.data.width:u.width*p[0])+2*h,h:(u.data?u.data.height:u.height*p[1])+2*h}}(e,i,[s.options.transform.a,s.options.transform.d]);return{bin:a,imagePosition:new ld(a,e,i,s),imageVariant:s}}class Cv{constructor(e,i,s){const a=new Map,u=new Map;this.haveRenderCallbacks=[];const h=[];this.addImages(e,a,oc,h),this.addImages(i,u,2,h);const{w:p,h:_}=Av(h),g=new nn({width:p||1,height:_||1});for(const[x,b]of e.entries()){const w=a.get(x).paddedRect;nn.copy(b.data,g,{x:0,y:0},{x:w.x+oc,y:w.y+oc},b.data,s,b.sdf)}for(const[x,b]of i.entries()){const w=u.get(x),E=w.paddedRect;let A=w.padding;const P=E.x+A,L=E.y+A,k=b.data.width,j=b.data.height;A=A>1?A-1:A,nn.copy(b.data,g,{x:0,y:0},{x:P,y:L},b.data,s),nn.copy(b.data,g,{x:0,y:j-A},{x:P,y:L-A},{width:k,height:A},s),nn.copy(b.data,g,{x:0,y:0},{x:P,y:L+j},{width:k,height:A},s),nn.copy(b.data,g,{x:k-A,y:0},{x:P-A,y:L},{width:A,height:j},s),nn.copy(b.data,g,{x:0,y:0},{x:P+k,y:L},{width:A,height:j},s),nn.copy(b.data,g,{x:k-A,y:j-A},{x:P-A,y:L-A},{width:A,height:A},s),nn.copy(b.data,g,{x:0,y:j-A},{x:P+k,y:L-A},{width:A,height:A},s),nn.copy(b.data,g,{x:0,y:0},{x:P+k,y:L+j},{width:A,height:A},s),nn.copy(b.data,g,{x:k-A,y:0},{x:P-A,y:L+j},{width:A,height:A},s)}this.lut=s,this.image=g,this.iconPositions=a,this.patternPositions=u}addImages(e,i,s,a){for(const[u,h]of e.entries()){const{bin:p,imagePosition:_,imageVariant:g}=Jm(u,h,s);i.set(u,_),a.push(p),h.hasRenderCallback&&this.haveRenderCallbacks.push(g.id)}}patchUpdatedImages(e,i,s){this.haveRenderCallbacks=this.haveRenderCallbacks.filter(a=>e.hasImage(a,s)),e.dispatchRenderCallbacks(this.haveRenderCallbacks,s);for(const a of e.getUpdatedImages(s)){for(const u of this.iconPositions.keys()){const h=zs.parse(u);if(Ln.isEqual(h.id,a)){const p=e.getImage(a,s);this.patchUpdatedImage(this.iconPositions.get(u),p,i)}}for(const u of this.patternPositions.keys()){const h=zs.parse(u);if(Ln.isEqual(h.id,a)){const p=e.getImage(a,s);this.patchUpdatedImage(this.patternPositions.get(u),p,i)}}}}patchUpdatedImage(e,i,s){if(!e||!i||e.version===i.version)return;e.version=i.version;const[a,u]=e.tl,h=e.sdf;if(this.lut||h){const p={width:i.data.width,height:i.data.height},_=new nn(p);nn.copy(i.data,_,{x:0,y:0},{x:0,y:0},p,this.lut,h),s.update(_,{position:{x:a,y:u}})}else s.update(i.data,{position:{x:a,y:u}})}}bt(ld,"ImagePosition"),bt(Cv,"ImageAtlas");const Xf=1e20;function Mv(r,e,i,s,a,u,h,p,_){for(let g=e;g<e+s;g++)Pv(r,i*u+g,u,a,h,p,_);for(let g=i;g<i+a;g++)Pv(r,g*u+e,1,s,h,p,_)}function Pv(r,e,i,s,a,u,h){u[0]=0,h[0]=-1e20,h[1]=Xf,a[0]=r[e];for(let p=1,_=0,g=0;p<s;p++){a[p]=r[e+p*i];const x=p*p;do{const b=u[_];g=(a[p]-a[b]+x-b*b)/(p-b)/2}while(g<=h[_]&&--_>-1);_++,u[_]=p,h[_]=g,h[_+1]=Xf}for(let p=0,_=0;p<s;p++){for(;h[_+1]<p;)_++;const g=u[_],x=p-g;r[e+p*i]=a[g]+x*x}}const Gs=2,Qm={none:0,ideographs:1,all:2};class wu{constructor(e,i,s){this.requestManager=e,this.localGlyphMode=i,this.localFontFamily=s,this.urls={},this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(e,i){this.urls[i]=e}getGlyphs(e,i,s){const a=[],u=this.urls[i]||Jr.GLYPHS_URL;for(const h in e)for(const p of e[h])a.push({stack:h,id:p});fe(a,({stack:h,id:p},_)=>{let g=this.entries[h];g||(g=this.entries[h]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let x=g.glyphs[p];if(x!==void 0)return void _(null,{stack:h,id:p,glyph:x});if(x=this._tinySDF(g,h,p),x)return g.glyphs[p]=x,void _(null,{stack:h,id:p,glyph:x});const b=Math.floor(p/256);if(256*b>65535)return ei("glyphs > 65535 not supported"),void _(null,{stack:h,id:p,glyph:x});if(g.ranges[b])return void _(null,{stack:h,id:p,glyph:x});let w=g.requests[b];w||(w=g.requests[b]=[],wu.loadGlyphRange(h,b,u,this.requestManager,(E,A)=>{if(A){g.ascender=A.ascender,g.descender=A.descender;for(const P in A.glyphs)this._doesCharSupportLocalGlyph(+P)||(g.glyphs[+P]=A.glyphs[+P]);g.ranges[b]=!0}for(const P of w)P(E,A);delete g.requests[b]})),w.push((E,A)=>{E?_(E):A&&_(null,{stack:h,id:p,glyph:A.glyphs[p]||null})})},(h,p)=>{if(h)s(h);else if(p){const _={};for(const{stack:g,id:x,glyph:b}of p)_[g]===void 0&&(_[g]={}),_[g].glyphs===void 0&&(_[g].glyphs={}),_[g].glyphs[x]=b&&{id:b.id,bitmap:b.bitmap.clone(),metrics:b.metrics},_[g].ascender=this.entries[g].ascender,_[g].descender=this.entries[g].descender;s(null,_)}})}_doesCharSupportLocalGlyph(e){return this.localGlyphMode!==Qm.none&&(this.localGlyphMode===Qm.all?!!this.localFontFamily:!!this.localFontFamily&&(Ft["CJK Unified Ideographs"](e)||Ft["Hangul Syllables"](e)||Ft.Hiragana(e)||Ft.Katakana(e)||Ft["CJK Symbols and Punctuation"](e)||Ft["CJK Unified Ideographs Extension A"](e)||Ft["CJK Unified Ideographs Extension B"](e)||Ft.Osage(e)))}_tinySDF(e,i,s){const a=this.localFontFamily;if(!a||!this._doesCharSupportLocalGlyph(s))return;let u=e.tinySDF;if(!u){let P="400";/bold/i.test(i)?P="900":/medium/i.test(i)?P="500":/light/i.test(i)&&(P="200"),u=e.tinySDF=new wu.TinySDF({fontFamily:a,fontWeight:P,fontSize:24*Gs,buffer:3*Gs,radius:8*Gs}),u.fontWeight=P}if(this.localGlyphs[u.fontWeight][s])return this.localGlyphs[u.fontWeight][s];const h=String.fromCodePoint(s),{data:p,width:_,height:g,glyphWidth:x,glyphHeight:b,glyphLeft:w,glyphTop:E,glyphAdvance:A}=u.draw(h);return this.localGlyphs[u.fontWeight][s]={id:s,bitmap:new Za({width:_,height:g},p),metrics:{width:x/Gs,height:b/Gs,left:w/Gs,top:E/Gs-27,advance:A/Gs,localGlyph:!0}}}}wu.loadGlyphRange=function(r,e,i,s,a){const u=256*e,h=u+255,p=s.transformRequest(s.normalizeGlyphsURL(i).replace("{fontstack}",r).replace("{range}",`${u}-${h}`),fl.Glyphs);pl(p,(_,g)=>{if(_)a(_);else if(g){const x={},b=function(w){return new Zf(w).readFields(Bb,{})}(g);for(const w of b.glyphs)x[w.id]=w;a(null,{glyphs:x,ascender:b.ascender,descender:b.descender})}})},wu.TinySDF=class{constructor({fontSize:r=24,buffer:e=3,radius:i=8,cutoff:s=.25,fontFamily:a="sans-serif",fontWeight:u="normal",fontStyle:h="normal"}={}){this.buffer=e,this.cutoff=s,this.radius=i;const p=this.size=r+4*e,_=this._createCanvas(p),g=this.ctx=_.getContext("2d",{willReadFrequently:!0});g.font=`${h} ${u} ${r}px ${a}`,g.textBaseline="alphabetic",g.textAlign="left",g.fillStyle="black",this.gridOuter=new Float64Array(p*p),this.gridInner=new Float64Array(p*p),this.f=new Float64Array(p),this.z=new Float64Array(p+1),this.v=new Uint16Array(p)}_createCanvas(r){const e=document.createElement("canvas");return e.width=e.height=r,e}draw(r){const{width:e,actualBoundingBoxAscent:i,actualBoundingBoxDescent:s,actualBoundingBoxLeft:a,actualBoundingBoxRight:u}=this.ctx.measureText(r),h=Math.ceil(i),p=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(u-a))),_=Math.min(this.size-this.buffer,h+Math.ceil(s)),g=p+2*this.buffer,x=_+2*this.buffer,b=Math.max(g*x,0),w=new Uint8ClampedArray(b),E={data:w,width:g,height:x,glyphWidth:p,glyphHeight:_,glyphTop:h,glyphLeft:0,glyphAdvance:e};if(p===0||_===0)return E;const{ctx:A,buffer:P,gridInner:L,gridOuter:k}=this;A.clearRect(P,P,p,_),A.fillText(r,P,P+h);const j=A.getImageData(P,P,p,_);k.fill(Xf,0,b),L.fill(0,0,b);for(let G=0;G<_;G++)for(let R=0;R<p;R++){const N=j.data[4*(G*p+R)+3]/255;if(N===0)continue;const q=(G+P)*g+R+P;if(N===1)k[q]=0,L[q]=Xf;else{const Z=.5-N;k[q]=Z>0?Z*Z:0,L[q]=Z<0?Z*Z:0}}Mv(k,0,0,g,x,g,this.f,this.v,this.z),Mv(L,P,P,p,_,g,this.f,this.v,this.z);for(let G=0;G<b;G++){const R=Math.sqrt(k[G])-Math.sqrt(L[G]);w[G]=Math.round(255-255*(R/this.radius+this.cutoff))}return E}};const ac=oc;function Rv(r,e){return r+e[1]-e[0]}function zv(r,e,i,s,a=1){const u=[],h=r.imagePrimary,p=h.pixelRatio,_=h.paddedRect.w-2*ac,g=h.paddedRect.h-2*ac,x=(r.right-r.left)*a,b=(r.bottom-r.top)*a,w=h.stretchX||[[0,_]],E=h.stretchY||[[0,g]],A=w.reduce(Rv,0),P=E.reduce(Rv,0),L=_-A,k=g-P;let j=0,G=A,R=0,N=P,q=0,Z=L,ae=0,ne=k;if(h.content&&s){const me=h.content;j=Yf(w,0,me[0]),R=Yf(E,0,me[1]),G=Yf(w,me[0],me[2]),N=Yf(E,me[1],me[3]),q=me[0]-j,ae=me[1]-R,Z=me[2]-me[0]-G,ne=me[3]-me[1]-N}const ce=(me,Re,Xe,Ve)=>{const We=Kf(me.stretch-j,G,x,r.left*a),Ke=Jf(me.fixed-q,Z,me.stretch,A),Le=Kf(Re.stretch-R,N,b,r.top*a),He=Jf(Re.fixed-ae,ne,Re.stretch,P),Me=Kf(Xe.stretch-j,G,x,r.left*a),ze=Jf(Xe.fixed-q,Z,Xe.stretch,A),et=Kf(Ve.stretch-R,N,b,r.top*a),it=Jf(Ve.fixed-ae,ne,Ve.stretch,P),Ot=new ut(We,Le),At=new ut(Me,Le),pt=new ut(Me,et),Qe=new ut(We,et),Xt=new ut(Ke/p,He/p),Et=new ut(ze/p,it/p),Mt=e*Math.PI/180;if(Mt){const li=Math.sin(Mt),Li=Math.cos(Mt),er=[Li,-li,li,Li];Ot._matMult(er),At._matMult(er),Qe._matMult(er),pt._matMult(er)}const jt=me.stretch+me.fixed,Qt=Xe.stretch+Xe.fixed,Jt=Re.stretch+Re.fixed,ai=Ve.stretch+Ve.fixed,ii=r.imageSecondary;return{tl:Ot,tr:At,bl:Qe,br:pt,texPrimary:{x:h.paddedRect.x+ac+jt,y:h.paddedRect.y+ac+Jt,w:Qt-jt,h:ai-Jt},texSecondary:ii?{x:ii.paddedRect.x+ac+jt,y:ii.paddedRect.y+ac+Jt,w:Qt-jt,h:ai-Jt}:void 0,writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:Xt,pixelOffsetBR:Et,minFontScaleX:Z/p/x,minFontScaleY:ne/p/b,isSDF:i}};if(s&&(h.stretchX||h.stretchY)){const me=Lv(w,L,A),Re=Lv(E,k,P);for(let Xe=0;Xe<me.length-1;Xe++){const Ve=me[Xe],We=me[Xe+1];for(let Ke=0;Ke<Re.length-1;Ke++)u.push(ce(Ve,Re[Ke],We,Re[Ke+1]))}}else u.push(ce({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:_+1},{fixed:0,stretch:g+1}));return u}function Yf(r,e,i){let s=0;for(const a of r)s+=Math.max(e,Math.min(i,a[1]))-Math.max(e,Math.min(i,a[0]));return s}function Lv(r,e,i){const s=[{fixed:-1,stretch:0}];for(const[a,u]of r){const h=s[s.length-1];s.push({fixed:a-h.stretch,stretch:h.stretch}),s.push({fixed:a-h.stretch,stretch:h.stretch+(u-a)})}return s.push({fixed:e+ac,stretch:i}),s}function Kf(r,e,i,s){return r/e*i+s}function Jf(r,e,i,s){return r-e*i/s}function Zb(r,e,i,s){const a=e+r.positionedLines[s].lineOffset;return s===0?i+a/2:i+(a+(e+r.positionedLines[s-1].lineOffset))/2}function Wb(r,e=1,i=!1){let s=1/0,a=1/0,u=-1/0,h=-1/0;const p=r[0];for(let E=0;E<p.length;E++){const A=p[E];(!E||A.x<s)&&(s=A.x),(!E||A.y<a)&&(a=A.y),(!E||A.x>u)&&(u=A.x),(!E||A.y>h)&&(h=A.y)}const _=Math.min(u-s,h-a);let g=_/2;const x=new Mc([],Xb);if(_===0)return new ut(s,a);for(let E=s;E<u;E+=_)for(let A=a;A<h;A+=_)x.push(new Tu(E+g,A+g,g,r));let b=function(E){let A=0,P=0,L=0;const k=E[0];for(let j=0,G=k.length,R=G-1;j<G;R=j++){const N=k[j],q=k[R],Z=N.x*q.y-q.x*N.y;P+=(N.x+q.x)*Z,L+=(N.y+q.y)*Z,A+=3*Z}return new Tu(P/A,L/A,0,E)}(r),w=x.length;for(;x.length;){const E=x.pop();(E.d>b.d||!b.d)&&(b=E,i&&console.log("found best %d after %d probes",Math.round(1e4*E.d)/1e4,w)),E.max-b.d<=e||(g=E.h/2,x.push(new Tu(E.p.x-g,E.p.y-g,g,r)),x.push(new Tu(E.p.x+g,E.p.y-g,g,r)),x.push(new Tu(E.p.x-g,E.p.y+g,g,r)),x.push(new Tu(E.p.x+g,E.p.y+g,g,r)),w+=4)}return i&&(console.log(`num probes: ${w}`),console.log(`best distance: ${b.d}`)),b.p}function Xb(r,e){return e.max-r.max}class Tu{constructor(e,i,s,a){this.p=new ut(e,i),this.h=s,this.d=function(u,h){let p=!1,_=1/0;for(let g=0;g<h.length;g++){const x=h[g];for(let b=0,w=x.length,E=w-1;b<w;E=b++){const A=x[b],P=x[E];A.y>u.y!=P.y>u.y&&u.x<(P.x-A.x)*(u.y-A.y)/(P.y-A.y)+A.x&&(p=!p),_=Math.min(_,du(u,A,P))}}return(p?1:-1)*Math.sqrt(_)}(this.p,a),this.max=this.d+this.h*Math.SQRT2}}const Yb=Object.keys,e_=Number.POSITIVE_INFINITY,Kb=Math.sqrt(2);function Dv(r,[e,i]){let s=0,a=0;if(i===e_){e<0&&(e=0);const u=e/Kb;switch(r){case"top-right":case"top-left":a=u-7;break;case"bottom-right":case"bottom-left":a=7-u;break;case"bottom":a=7-e;break;case"top":a=e-7}switch(r){case"top-right":case"bottom-right":s=-u;break;case"top-left":case"bottom-left":s=u;break;case"left":s=e;break;case"right":s=-e}}else{switch(e=Math.abs(e),i=Math.abs(i),r){case"top-right":case"top-left":case"top":a=i-7;break;case"bottom-right":case"bottom-left":case"bottom":a=7-i}switch(r){case"top-right":case"bottom-right":case"right":s=-e;break;case"top-left":case"bottom-left":case"left":s=e}}return[s,a]}function Qf(r,e,i,s,a,u,h,p,_){if(!e||!e.usvg)return;const g=xv(s),x=xv(a),b=u!=="both"&&u!=="width"||!yv(s)?1:x.width/g.width,w=u!=="both"&&u!=="height"||!vv(s)?1:x.height/g.height;i.scaleSelf(b,w);const E=i.toString();h.set(E,i),p.set(E,e);const{imagePosition:A}=Jm(E,e,oc);_.set(E,A)}function Ov(r,e,i,s,a,u,h,p,_){if(!r)return;const g=function(x,b,w,E,A,P){if(x.kind==="camera")return x.maxSize;if(x.kind==="composite"){const L=b.possiblyEvaluate(new Gi(x.maxZoom,{worldview:P}),w).evaluate(A,{},w),k=b.possiblyEvaluate(new Gi(x.minZoom,{worldview:P}),w).evaluate(A,{},w);return Math.max(L,k)}return b.possiblyEvaluate(new Gi(E,{worldview:P})).evaluate(A,{},w)}(e,i,s,a,u,_);return r.scaleSelf(g*p*h)}function kv(r,e,i,s,a,u,h,p,_){return{iconPrimary:Ov(r.getPrimary(),e,i,s,a,u,h,p,_),iconSecondary:Ov(r.getSecondary(),e,i,s,a,u,h,p,_)}}function Jb(r,e,i){if(!e)return;const s=i.get(r.toString()),a=i.get(e.toString());a&&(s.paddedRect.w===a.paddedRect.w&&s.paddedRect.h===a.paddedRect.h||ei(`Mismatch in icon variant sizes: ${r.toString()} and ${e.toString()}`),s.usvg!==a.usvg&&ei(`Mismatch in icon variant image types: ${r.id} and ${e.id}`))}function Fv(r,e,i,s){if(!r)return;const a=e.get(i.toString());if(r.imagePrimary=a,s){const u=e.get(s.toString());r.imageSecondary=u}}function Qb(r,e){for(const i in r.horizontal)Bv(r.horizontal[i],e);Bv(r.vertical,e)}function Bv(r,e){if(r){for(const i of r.positionedLines)for(const s of i.positionedGlyphs)if(s.image!==null){const a=s.image.toString();s.rect=e.get(a).paddedRect}}}function t_(r){switch(r){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function ew(r,e,i,s,a,u,h,p,_){const g=i_(u.horizontal)||u.vertical,x=i.get("icon-text-fit-padding").evaluate(s,{},a);let b,w=e;return e&&_!=="none"&&(r.allowVerticalPlacement&&u.vertical&&(b=gv(e,u.vertical,_,x,p,h)),g&&(w=gv(e,g,_,x,p,h))),{defaultShapedIcon:w,verticallyShapedIcon:b}}function tw(r,e,i,s,a,u,h,p,_,g,x,b,w,E,A,P,L,k,j,G){let R=h.textMaxSize.evaluate(e,{},w);R===void 0?R=p*h.textScaleFactor:R*=h.textScaleFactor;const N=r.layers[0].layout,q=i_(i.horizontal)||i.vertical,Z=E.name==="globe",ae=Kr,ne=r.tilePixelRatio*R/ae,ce=(Ke=r.overscaling,r.zoom>18&&Ke>2&&(Ke>>=1),Math.max(dt/(512*Ke),1)*N.get("symbol-spacing")),me=N.get("text-padding")*r.tilePixelRatio,Re=N.get("icon-padding")*r.tilePixelRatio,Xe=wi(N.get("text-max-angle")),Ve=N.get("icon-rotation-alignment")==="map"&&G!=="point",We=ce/2;var Ke;r.hasAnyIconTextFit===!1&&L!=="none"&&(r.hasAnyIconTextFit=!0);const Le=e.properties?+e.properties[ui]:null,He=Le&&r.elevationFeatureIdToIndex?r.elevationFeatureIdToIndex.get(Le):65535,Me=(ze,et,it)=>{if(et.x<0||et.x>=dt||et.y<0||et.y>=dt)return;let Ot=null;if(Z){const{x:At,y:pt,z:Qe}=E.projectTilePoint(et.x,et.y,it);Ot={anchor:new ra(At,pt,Qe,0,void 0),up:E.upVector(it,et.x,et.y)}}(function(At,pt,Qe,Xt,Et,Mt,jt,Qt,Jt,ai,ii,li,Li,er,$,W,De,lt,mt,ft,St,Vt,hi,di,ri,Bi,Xi,fi,yr){const tr=At.addToLineVertexArray(pt,Xt);let Di,Pr,ar,Yi,ir,Ui,si,qi=0,vr=0,Bt=0,_i=0,lr=-1,Er=-1;const fr={};let Gr=_l("");const Hi=Qe?Qe.anchor:pt,Ur=fi!=="none";let Fn=0,sn=0;if(Jt._unevaluatedLayout.getValue("text-radial-offset")===void 0){const qr=Jt.layout.get("text-offset").evaluate(St,{},ri);Fn=qr[0]*Kr,sn=qr[1]*Kr}else Fn=Jt.layout.get("text-radial-offset").evaluate(St,{},ri)*Kr,sn=e_;if(At.allowVerticalPlacement&&Et.vertical){const qr=Et.vertical;if($)Ui=r_(qr),Qt&&(si=r_(Qt));else{const Hr=Jt.layout.get("text-rotate").evaluate(St,{},ri)+90;ar=ep(ai,Hi,pt,ii,li,Li,qr,er,Hr,W),Qt&&(Yi=ep(ai,Hi,pt,ii,li,Li,Qt,lt,Hr))}}if(Mt){const qr=At.iconSizeData,Hr=Jt.layout.get("icon-rotate").evaluate(St,{},ri),on=zv(Mt,Hr,hi,Ur,Vt.iconScaleFactor),Tn=Qt?zv(Qt,Hr,hi,Ur,Vt.iconScaleFactor):void 0;Pr=ep(ai,Hi,pt,ii,li,Li,Mt,lt,Hr,null),qi=4*on.length;let dn=null;qr.kind==="source"?(dn=[So*Jt.layout.get("icon-size").evaluate(St,{},ri)*Vt.iconScaleFactor],dn[0]>Xa&&ei(`${At.layerIds[0]}: Value for "icon-size" is >= ${cd}. Reduce your "icon-size".`)):qr.kind==="composite"&&(dn=[So*Vt.compositeIconSizes[0].evaluate(St,{},ri)*Vt.iconScaleFactor,So*Vt.compositeIconSizes[1].evaluate(St,{},ri)*Vt.iconScaleFactor],(dn[0]>Xa||dn[1]>Xa)&&ei(`${At.layerIds[0]}: Value for "icon-size" is >= ${cd}. Reduce your "icon-size".`)),At.addSymbols(At.icon,on,dn,ft,mt,St,void 0,Qe,pt,tr.lineStartIndex,tr.lineLength,-1,di,ri,Bi,Xi),lr=At.icon.placedSymbolArray.length-1,Tn&&(vr=4*Tn.length,At.addSymbols(At.icon,Tn,dn,ft,mt,St,Zn.vertical,Qe,pt,tr.lineStartIndex,tr.lineLength,-1,di,ri,Bi,Xi),Er=At.icon.placedSymbolArray.length-1)}for(const qr in Et.horizontal){const Hr=qr,on=Et.horizontal[Hr];Di||(Gr=_l(on.text),$?ir=r_(on):Di=ep(ai,Hi,pt,ii,li,Li,on,er,Jt.layout.get("text-rotate").evaluate(St,{},ri),W));const Tn=on.positionedLines.length===1;if(Bt+=Nv(At,Qe,pt,on,jt,Jt,$,St,W,tr,Et.vertical?Zn.horizontal:Zn.horizontalOnly,Tn?Yb(Et.horizontal):[Hr],fr,lr,Vt,di,ri,Bi),Tn)break}Et.vertical&&(_i+=Nv(At,Qe,pt,Et.vertical,jt,Jt,$,St,W,tr,Zn.vertical,["vertical"],fr,Er,Vt,di,ri,Bi));let rn=-1;const Bn=(qr,Hr)=>qr?Math.max(qr,Hr):Hr;rn=Bn(ir,rn),rn=Bn(Ui,rn),rn=Bn(si,rn);const Eo=rn>-1?1:0;At.glyphOffsetArray.length>=65535&&ei("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),St.sortKey!==void 0&&At.addToSortKeyRanges(At.symbolInstances.length,St.sortKey),At.symbolInstances.emplaceBack(pt.x,pt.y,Hi.x,Hi.y,Hi.z,fr.right>=0?fr.right:-1,fr.center>=0?fr.center:-1,fr.left>=0?fr.left:-1,fr.vertical>=0?fr.vertical:-1,lr,Er,Gr,Di!==void 0?Di:At.collisionBoxArray.length,Di!==void 0?Di+1:At.collisionBoxArray.length,ar!==void 0?ar:At.collisionBoxArray.length,ar!==void 0?ar+1:At.collisionBoxArray.length,Pr!==void 0?Pr:At.collisionBoxArray.length,Pr!==void 0?Pr+1:At.collisionBoxArray.length,Yi||At.collisionBoxArray.length,Yi?Yi+1:At.collisionBoxArray.length,ii,Bt,_i,qi,vr,Eo,0,Fn,sn,rn,0,Ur?1:0,yr)})(r,et,Ot,ze,i,s,u,a,r.layers[0],r.collisionBoxArray,e.index,e.sourceLayerIndex,r.index,me,j,g,0,Re,Ve,k,e,h,x,b,w,A,P,L,He)};if(G==="line")for(const ze of Gf(e.geometry,0,0,dt,dt)){const et=Hb(ze,ce,Xe,i.vertical||q,s,ae,ne,r.overscaling,dt);for(const it of et)q&&iw(r,q.text,We,it)||Me(ze,it,w)}else if(G==="line-center"){for(const ze of e.geometry)if(ze.length>1){const et=$b(ze,Xe,i.vertical||q,s,ae,ne);et&&Me(ze,et,w)}}else if(e.type==="Polygon")for(const ze of Ff(e.geometry,0)){const et=Wb(ze,16);Me(ze[0],new ra(et.x,et.y,0,0,void 0),w)}else if(e.type==="LineString")for(const ze of e.geometry)Me(ze,new ra(ze[0].x,ze[0].y,0,0,void 0),w);else if(e.type==="Point")for(const ze of e.geometry)for(const et of ze)Me([et],new ra(et.x,et.y,0,0,void 0),w)}const cd=255,Xa=cd*So;function Nv(r,e,i,s,a,u,h,p,_,g,x,b,w,E,A,P,L,k){const j=function(N,q,Z,ae,ne,ce,me,Re){const Xe=[];if(q.positionedLines.length===0)return Xe;const Ve=ae.layout.get("text-rotate").evaluate(ce,{})*Math.PI/180,We=function(ze){const et=ze[0],it=ze[1],Ot=et*it;return Ot>0?[et,-it]:Ot<0?[-et,it]:et===0?[it,et]:[it,-et]}(Z);let Ke=Math.abs(q.top-q.bottom);for(const ze of q.positionedLines)Ke-=ze.lineOffset;const Le=q.positionedLines.length,He=Ke/Le;let Me=q.top-Z[1];for(let ze=0;ze<Le;++ze){const et=q.positionedLines[ze];Me=Zb(q,He,Me,ze);for(const it of et.positionedGlyphs){if(!it.rect)continue;const Ot=it.rect||{};let At=Ub+1,pt=!0,Qe=1,Xt=0;if(it.image){const St=me.get(it.image.toString());if(!St)continue;if(St.sdf){ei("SDF images are not supported in formatted text and will be ignored.");continue}pt=!1,Qe=St.pixelRatio,At=oc/Qe}const Et=(ne||Re)&&it.vertical,Mt=it.metrics.advance*it.scale/2,jt=it.metrics,Qt=it.rect;if(Qt===null)continue;Re&&q.verticalizable&&(Xt=it.image?Mt-it.metrics.width*it.scale/2:0);const Jt=ne?[it.x+Mt,it.y]:[0,0];let ai=[0,0],ii=[0,0],li=!1;ne||(Et?(ii=[it.x+Mt+We[0],it.y+We[1]-Xt],li=!0):ai=[it.x+Mt+Z[0],it.y+Z[1]-Xt]);const Li=Qt.w*it.scale/(Qe*(it.localGlyph?Gs:1)),er=Qt.h*it.scale/(Qe*(it.localGlyph?Gs:1));let $,W,De,lt;if(Et){const St=it.y-Me,Vt=new ut(-Mt,Mt-St),hi=-Math.PI/2,di=new ut(...ii);$=new ut(-Mt+ai[0],ai[1]),$._rotateAround(hi,Vt)._add(di),$.x+=-St+Mt,$.y-=(jt.left-At)*it.scale;const ri=it.image?jt.advance*it.scale:Kr*it.scale,Bi=String.fromCodePoint(it.glyph);Ob(Bi)?$.x+=(1-At)*it.scale:kb(Bi)?$.x+=ri-jt.height*it.scale+(-At-1)*it.scale:$.x+=it.image||jt.width+2*At===Qt.w&&jt.height+2*At===Qt.h?(ri-er)/2:(ri-(jt.height+2*At)*it.scale)/2,W=new ut($.x,$.y-Li),De=new ut($.x+er,$.y),lt=new ut($.x+er,$.y-Li)}else{const St=(jt.left-At)*it.scale-Mt+ai[0],Vt=(-jt.top-At)*it.scale+ai[1],hi=St+Li,di=Vt+er;$=new ut(St,Vt),W=new ut(hi,Vt),De=new ut(St,di),lt=new ut(hi,di)}if(Ve){let St;St=ne?new ut(0,0):li?new ut(We[0],We[1]):new ut(Z[0],Z[1]),$._rotateAround(Ve,St),W._rotateAround(Ve,St),De._rotateAround(Ve,St),lt._rotateAround(Ve,St)}const mt=new ut(0,0),ft=new ut(0,0);Xe.push({tl:$,tr:W,bl:De,br:lt,texPrimary:Ot,texSecondary:void 0,writingMode:q.writingMode,glyphOffset:Jt,sectionIndex:it.sectionIndex,isSDF:pt,pixelOffsetTL:mt,pixelOffsetBR:ft,minFontScaleX:0,minFontScaleY:0})}}return Xe}(0,s,_,u,h,p,a,r.allowVerticalPlacement),G=r.textSizeData;let R=null;G.kind==="source"?(R=[So*u.layout.get("text-size").evaluate(p,{},L)*A.textScaleFactor],R[0]>Xa&&ei(`${r.layerIds[0]}: Value for "text-size" is >= ${cd}. Reduce your "text-size".`)):G.kind==="composite"&&(R=[So*A.compositeTextSizes[0].evaluate(p,{},L)*A.textScaleFactor,So*A.compositeTextSizes[1].evaluate(p,{},L)*A.textScaleFactor],(R[0]>Xa||R[1]>Xa)&&ei(`${r.layerIds[0]}: Value for "text-size" is >= ${cd}. Reduce your "text-size".`)),r.addSymbols(r.text,j,R,_,h,p,x,e,i,g.lineStartIndex,g.lineLength,E,P,L,k,!1);for(const N of b)w[N]=r.text.placedSymbolArray.length-1;return 4*j.length}function i_(r){for(const e in r)return r[e];return null}function ep(r,e,i,s,a,u,h,p,_,g){let x=h.top,b=h.bottom,w=h.left,E=h.right;if(_v(h)&&h.collisionPadding){const A=h.collisionPadding;w-=A[0],x-=A[1],E+=A[2],b+=A[3]}if(_){const A=new ut(w,x),P=new ut(E,x),L=new ut(w,b),k=new ut(E,b),j=wi(_);let G=new ut(0,0);g&&(G=new ut(g[0],g[1])),A._rotateAround(j,G),P._rotateAround(j,G),L._rotateAround(j,G),k._rotateAround(j,G),w=Math.min(A.x,P.x,L.x,k.x),E=Math.max(A.x,P.x,L.x,k.x),x=Math.min(A.y,P.y,L.y,k.y),b=Math.max(A.y,P.y,L.y,k.y)}return r.emplaceBack(e.x,e.y,e.z,i.x,i.y,w,x,E,b,p,s,a,u),r.length-1}function r_(r){_v(r)&&r.collisionPadding&&(r.top-=r.collisionPadding[1],r.bottom+=r.collisionPadding[3]);const e=r.bottom-r.top;return e>0?Math.max(10,e):null}function iw(r,e,i,s){const a=r.compareText;if(e in a){const u=a[e];for(let h=u.length-1;h>=0;h--)if(s.dist(u[h])<i)return!0}else a[e]=[];return a[e].push(s),!1}function Vv(r,e){const i=r.fovAboveCenter,s=r.elevation?r.elevation.getMinElevationBelowMSL()*e:0,a=(r._camera.position[2]*r.worldSize-s)/Math.cos(r._pitch),u=Math.sin(i)*a/Math.sin(Math.max(Math.PI/2-r._pitch-i,.01));let h=Math.sin(r._pitch)*u+a;const p=a*(1/r._horizonShift);if(!r.elevation||r.elevation.exaggeration()===0){let _=Math.max(r.zoom-17,0);r.isOrthographic&&(_/=10),h*=1+_}return Math.min(1.01*h,p)}function ud(r,e){if(!e.isReprojectedInTileSpace)return{scale:1<<r.z,x:r.x,y:r.y,x2:r.x+1,y2:r.y+1,projection:e};const i=Math.pow(2,-r.z),s=r.x*i,a=(r.x+1)*i,u=r.y*i,h=(r.y+1)*i,p=se(s),_=se(a),g=ye(u),x=ye(h),b=e.project(p,g),w=e.project(_,g),E=e.project(_,x),A=e.project(p,x);let P=Math.min(b.x,w.x,E.x,A.x),L=Math.min(b.y,w.y,E.y,A.y),k=Math.max(b.x,w.x,E.x,A.x),j=Math.max(b.y,w.y,E.y,A.y);const G=i/16;function R(q,Z,ae,ne,ce,me){const Re=(ae+ce)/2,Xe=(ne+me)/2,Ve=e.project(se(Re),ye(Xe)),We=Math.max(0,P-Ve.x,L-Ve.y,Ve.x-k,Ve.y-j);P=Math.min(P,Ve.x),k=Math.max(k,Ve.x),L=Math.min(L,Ve.y),j=Math.max(j,Ve.y),We>G&&(R(q,Ve,ae,ne,Re,Xe),R(Ve,Z,Re,Xe,ce,me))}R(b,w,s,u,a,u),R(w,E,a,u,a,h),R(E,A,a,h,s,h),R(A,b,s,h,s,u),P-=G,L-=G,k+=G,j+=G;const N=1/Math.max(k-P,j-L);return{scale:N,x:P*N,y:L*N,x2:k*N,y2:j*N,projection:e}}function Uv(r,{x:e,y:i},s=0){return new ut(((e-s)*r.scale-r.x)*dt,(i*r.scale-r.y)*dt)}const rw=re(new Float32Array(16));class Ya{constructor(e){this.spec=e,this.name=e.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(e,i){return{x:0,y:0,z:0}}unproject(e,i){return new V(0,0)}projectTilePoint(e,i,s){return{x:e,y:i,z:0}}locationPoint(e,i,s,a=!0){return e._coordinatePoint(e.locationCoordinate(i,s),a)}pixelsPerMeter(e,i){return ie(1,e)*i}pixelSpaceConversion(e,i,s){return 1}farthestPixelDistance(e){return Vv(e,e.pixelsPerMeter)}pointCoordinate(e,i,s,a){const u=e.horizonLineFromTop(!1),h=new ut(i,Math.max(u,s));return e.rayIntersectionCoordinate(e.pointRayIntersection(h,a))}pointCoordinate3D(e,i,s){const a=new ut(i,s);if(e.elevation)return e.elevation.pointCoordinate(a);{const u=this.pointCoordinate(e,a.x,a.y,0);return[u.x,u.y,u.z]}}isPointAboveHorizon(e,i){if(e.elevation&&e.elevation.visibleDemTiles.length)return!this.pointCoordinate3D(e,i.x,i.y);const s=e.horizonLineFromTop();return i.y<s}createInversionMatrix(e,i){return rw}createTileMatrix(e,i,s){let a,u,h;const p=s.canonical,_=re(new Float64Array(16));if(this.isReprojectedInTileSpace){const g=ud(p,this);a=1,u=g.x+s.wrap*g.scale,h=g.y,vt(_,_,[a/g.scale,a/g.scale,e.pixelsPerMeter/i])}else a=i/e.zoomScale(p.z),u=(p.x+Math.pow(2,p.z)*s.wrap)*a,h=p.y*a;return It(_,_,[u,h,0]),vt(_,_,[a/dt,a/dt,1]),_}upVector(e,i,s){return[0,0,1]}upVectorScale(e,i,s){return{metersToTile:1}}}class nw extends Ya{constructor(e){super(e),this.range=[4,7],this.center=e.center||[-96,37.5];const[i,s]=this.parallels=e.parallels||[29.5,45.5],a=Math.sin(wi(i));this.n=(a+Math.sin(wi(s)))/2,this.c=1+a*(2*this.n-a),this.r0=Math.sqrt(this.c)/this.n}project(e,i){const{n:s,c:a,r0:u}=this,h=wi(e-this.center[0]),p=wi(i),_=Math.sqrt(a-2*s*Math.sin(p))/s;return{x:_*Math.sin(h*s),y:_*Math.cos(h*s)-u,z:0}}unproject(e,i){const{n:s,c:a,r0:u}=this,h=u+i;let p=Math.atan2(e,Math.abs(h))*Math.sign(h);h*s<0&&(p-=Math.PI*Math.sign(e)*Math.sign(h));const _=wi(this.center[0])*s;p=xe(p,-Math.PI-_,Math.PI-_);const g=Q(Ee(p/s)+this.center[0],-180,180),x=Math.asin(Q((a-(e*e+h*h)*s*s)/(2*s),-1,1)),b=Q(Ee(x),-85.051129,Oe);return new V(g,b)}}const hd=1.340264,dd=-.081106,fd=893e-6,pd=.003796,tp=Math.sqrt(3)/2;class sw extends Ya{project(e,i){i=i/180*Math.PI,e=e/180*Math.PI;const s=Math.asin(tp*Math.sin(i)),a=s*s,u=a*a*a;return{x:.5*(e*Math.cos(s)/(tp*(hd+3*dd*a+u*(7*fd+9*pd*a)))/Math.PI+.5),y:1-.5*(s*(hd+dd*a+u*(fd+pd*a))/Math.PI+1),z:0}}unproject(e,i){e=(2*e-.5)*Math.PI;let s=i=(2*(1-i)-1)*Math.PI,a=s*s,u=a*a*a;for(let x,b,w,E=0;E<12&&(b=s*(hd+dd*a+u*(fd+pd*a))-i,w=hd+3*dd*a+u*(7*fd+9*pd*a),x=b/w,s=Q(s-x,-Math.PI/3,Math.PI/3),a=s*s,u=a*a*a,!(Math.abs(x)<1e-12));++E);const h=tp*e*(hd+3*dd*a+u*(7*fd+9*pd*a))/Math.cos(s),p=Math.asin(Math.sin(s)/tp),_=Q(180*h/Math.PI,-180,180),g=Q(180*p/Math.PI,-85.051129,Oe);return new V(_,g)}}class ow extends Ya{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0}project(e,i){return{x:.5+e/360,y:.5-i/360,z:0}}unproject(e,i){const s=360*(e-.5),a=Q(360*(.5-i),-85.051129,Oe);return new V(s,a)}}const Su=Math.PI/2;function ip(r){return Math.tan((Su+r)/2)}class aw extends Ya{constructor(e){super(e),this.center=e.center||[0,30];const[i,s]=this.parallels=e.parallels||[30,30];let a=wi(i),u=wi(s);this.southernCenter=a+u<0,this.southernCenter&&(a=-a,u=-u);const h=Math.cos(a),p=ip(a);this.n=a===u?Math.sin(a):Math.log(h/Math.cos(u))/Math.log(ip(u)/p),this.f=h*Math.pow(ip(a),this.n)/this.n}project(e,i){i=wi(i),this.southernCenter&&(i=-i),e=wi(e-this.center[0]);const s=1e-6,{n:a,f:u}=this;u>0?i<-Su+s&&(i=-Su+s):i>Su-s&&(i=Su-s);const h=u/Math.pow(ip(i),a);let p=h*Math.sin(a*e),_=u-h*Math.cos(a*e);return p=.5*(p/Math.PI+.5),_=.5*(_/Math.PI+.5),{x:p,y:this.southernCenter?_:1-_,z:0}}unproject(e,i){e=(2*e-.5)*Math.PI,this.southernCenter&&(i=1-i),i=(2*(1-i)-.5)*Math.PI;const{n:s,f:a}=this,u=a-i,h=Math.sign(u),p=Math.sign(s)*Math.sqrt(e*e+u*u);let _=Math.atan2(e,Math.abs(u))*h;u*s<0&&(_-=Math.PI*Math.sign(e)*h);const g=Q(Ee(_/s)+this.center[0],-180,180),x=Q(Ee(2*Math.atan(Math.pow(a/p,1/s))-Su),-85.051129,Oe);return new V(g,this.southernCenter?-x:x)}}class jv extends Ya{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(e,i){return{x:J(e),y:K(i),z:0}}unproject(e,i){const s=se(e),a=ye(i);return new V(s,a)}}const Gv=wi(Oe);class lw extends Ya{project(e,i){const s=(i=wi(i))*i,a=s*s;return{x:.5*((e=wi(e))*(.8707-.131979*s+a*(a*(.003971*s-.001529*a)-.013791))/Math.PI+.5),y:1-.5*(i*(1.007226+s*(.015085+a*(.028874*s-.044475-.005916*a)))/Math.PI+1),z:0}}unproject(e,i){e=(2*e-.5)*Math.PI;let s=i=(2*(1-i)-1)*Math.PI,a=25,u=0,h=s*s;do{h=s*s;const g=h*h;u=(s*(1.007226+h*(.015085+g*(.028874*h-.044475-.005916*g)))-i)/(1.007226+h*(.045255+g*(.259866*h-.311325-.005916*11*g))),s=Q(s-u,-Gv,Gv)}while(Math.abs(u)>1e-6&&--a>0);h=s*s;const p=Q(Ee(e/(.8707+h*(h*(h*h*h*(.003971-.001529*h)-.013791)-.131979))),-180,180),_=Ee(s);return new V(p,_)}}const qv=wi(Oe);class cw extends Ya{project(e,i){i=wi(i),e=wi(e);const s=Math.cos(i),a=2/Math.PI,u=Math.acos(s*Math.cos(e/2)),h=Math.sin(u)/u,p=.5*(e*a+2*s*Math.sin(e/2)/h)||0,_=.5*(i+Math.sin(i)/h)||0;return{x:.5*(p/Math.PI+.5),y:1-.5*(_/Math.PI+1),z:0}}unproject(e,i){let s=e=(2*e-.5)*Math.PI,a=i=(2*(1-i)-1)*Math.PI,u=25;const h=1e-6;let p=0,_=0;do{const g=Math.cos(a),x=Math.sin(a),b=2*x*g,w=x*x,E=g*g,A=Math.cos(s/2),P=Math.sin(s/2),L=2*A*P,k=P*P,j=1-E*A*A,G=j?1/j:0,R=j?Math.acos(g*A)*Math.sqrt(1/j):0,N=.5*(2*R*g*P+2*s/Math.PI)-e,q=.5*(R*x+a)-i,Z=.5*G*(E*k+R*g*A*w)+1/Math.PI,ae=G*(L*b/4-R*x*P),ne=.125*G*(b*P-R*x*E*L),ce=.5*G*(w*A+R*k*g)+.5,me=ae*ne-ce*Z;p=(q*ae-N*ce)/me,_=(N*ne-q*Z)/me,s=Q(s-p,-Math.PI,Math.PI),a=Q(a-_,-qv,qv)}while((Math.abs(p)>h||Math.abs(_)>h)&&--u>0);return new V(Ee(s),Ee(a))}}class $v extends Ya{constructor(e){super(e),this.center=e.center||[0,0],this.parallels=e.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(wi(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(e,i){const{scale:s,cosPhi:a}=this;return{x:wi(e)*a*s+.5,y:-Math.sin(wi(i))/a*s+.5,z:0}}unproject(e,i){const{scale:s,cosPhi:a}=this,u=-(i-.5)/s,h=Q(Ee((e-.5)/s)/a,-180,180),p=Math.asin(Q(u*a,-1,1)),_=Q(Ee(p),-85.051129,Oe);return new V(h,_)}}class uw extends jv{constructor(e){super(e),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(e,i,s){const a=Gh(e,i,s);return ji(a,a,Df(wo(s))),{x:a[0],y:a[1],z:a[2]}}locationPoint(e,i,s){const a=z(i.lat,i.lng),u=mr([],a),h=s?e._centerAltitude+s:e.elevation?e.elevation.getAtPointOrZero(e.locationCoordinate(i),e._centerAltitude):e._centerAltitude;fn(a,a,u,ie(1,0)*dt*h);const p=re(new Float64Array(16));return at(p,e.pixelMatrix,e.globeMatrix),ji(a,a,p),new ut(a[0],a[1])}pixelsPerMeter(e,i){return ie(1,0)*i}pixelSpaceConversion(e,i,s){const a=ie(1,e)*i,u=Ut(ie(1,45)*i,a,s);return this.pixelsPerMeter(e,i)/u}createTileMatrix(e,i,s){const a=xm(wo(s.canonical));return at(new Float64Array(16),e.globeMatrix,a)}createInversionMatrix(e,i){const{center:s}=e,a=Df(wo(i));return $e(a,a,wi(s.lng)),nt(a,a,wi(s.lat)),vt(a,a,[e._pixelsPerMercatorPixel,e._pixelsPerMercatorPixel,1]),Float32Array.from(a)}pointCoordinate(e,i,s,a){return Ag(e,i,s,!0)||new ue(0,0)}pointCoordinate3D(e,i,s){const a=this.pointCoordinate(e,i,s,0);return[a.x,a.y,a.z]}isPointAboveHorizon(e,i){return!Ag(e,i.x,i.y,!1)}farthestPixelDistance(e){const i=function(a,u){const h=a.cameraToCenterDistance,p=a._centerAltitude*u,_=a._camera,g=a._camera.forward(),x=zr([],rr([],g,-h),[0,0,p]),b=a.worldSize/(2*Math.PI),w=[0,0,-b],E=a.width/a.height,A=Math.tan(a.fovAboveCenter),P=rr([],_.up(),A),L=rr([],_.right(),A*E),k=mr([],zr([],zr([],g,P),L)),j=[];let G;if(new sr(x,k).closestPointOnSphere(w,b,j)){const R=zr([],j,w),N=Br([],R,x);G=Math.cos(a.fovAboveCenter)*Rr(N)}else{const R=Br([],x,w),N=Br([],w,x);mr(N,N);const q=Rr(R)-b;G=Math.sqrt(q*(q+2*b));const Z=Math.acos(G/(b+q))-Math.acos(Ar(g,N));G*=Math.cos(Z)}return 1.01*G}(e,this.pixelsPerMeter(e.center.lat,e.worldSize)),s=Ha(e.zoom);if(s>0){const a=Vv(e,ie(1,e.center.lat)*e.worldSize),u=e.worldSize/(2*Math.PI),h=Math.max(e.width,e.height)/e.worldSize*Math.PI;return Ut(i,a+u*(1-Math.cos(h)),Math.pow(s,10))}return i}upVector(e,i,s){return Gh(i,s,e,1)}upVectorScale(e){return{metersToTile:Rf(Lf(wo(e)))}}}function Hv(r){const e=r.parallels,i=!!e&&Math.abs(e[0]+e[1])<.01;switch(r.name){case"mercator":return new jv(r);case"equirectangular":return new ow(r);case"naturalEarth":return new lw(r);case"equalEarth":return new sw(r);case"winkelTripel":return new cw(r);case"albers":return i?new $v(r):new nw(r);case"lambertConformalConic":return i?new $v(r):new aw(r);case"globe":return new uw(r)}throw new Error(`Invalid projection name: ${r.name}`)}const hw=ni.VectorTileFeature.types,dw=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function rp(r,e,i,s,a,u,h,p,_,g,x,b,w){const E=p?Math.min(Xa,Math.round(p[0])):0,A=p?Math.min(Xa,Math.round(p[1])):0;r.emplaceBack(e,i,Math.round(32*s),Math.round(32*a),u,h,(E<<1)+(_?1:0),A,16*g,16*x,256*b,256*w)}function np(r,e,i){r.emplaceBack(e,i)}function sp(r,e,i,s,a,u,h){r.emplaceBack(e,i,s,a,u,h)}const op=(r,e,i,s)=>{for(let a=0;a<e;a++)r.emplaceBack(i[0],i[1],i[2],s[0],s[1],s[2])};function ap(r,e,i,s,a){r.emplaceBack(e,i,s,a),r.emplaceBack(e,i,s,a),r.emplaceBack(e,i,s,a),r.emplaceBack(e,i,s,a)}function fw(r){for(const e of r.sections)if(cm(e.text))return!0;return!1}class n_{constructor(e){this.layoutVertexArray=new Fa,this.indexArray=new en,this.programConfigurations=e,this.segments=new Tr,this.dynamicLayoutVertexArray=new Qr,this.opacityVertexArray=new Na,this.placedSymbolArray=new gf,this.iconTransitioningVertexArray=new go,this.globeExtVertexArray=new Ba,this.zOffsetVertexArray=new mo,this.orientationVertexArray=new zh}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0&&this.iconTransitioningVertexArray.length===0}upload(e,i,s,a,u){this.isEmpty()||(s&&(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Eb.members),this.indexBuffer=e.createIndexBuffer(this.indexArray,i),this.dynamicLayoutVertexBuffer=e.createVertexBuffer(this.dynamicLayoutVertexArray,Ab.members,!0),this.opacityVertexBuffer=e.createVertexBuffer(this.opacityVertexArray,dw,!0),this.iconTransitioningVertexArray.length>0&&(this.iconTransitioningVertexBuffer=e.createVertexBuffer(this.iconTransitioningVertexArray,Pb.members,!0)),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,Ib.members,!0)),!this.zOffsetVertexBuffer&&(this.zOffsetVertexArray.length>0||u)&&(this.zOffsetVertexBuffer=e.createVertexBuffer(this.zOffsetVertexArray,Cb.members,!0)),!this.orientationVertexBuffer&&this.orientationVertexArray&&this.orientationVertexArray.length>0&&(this.orientationVertexBuffer=e.createVertexBuffer(this.orientationVertexArray,Mb.members,!0)),this.opacityVertexBuffer.itemSize=1),(s||a)&&this.programConfigurations.upload(e))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.iconTransitioningVertexBuffer&&this.iconTransitioningVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.orientationVertexBuffer&&this.orientationVertexBuffer.destroy())}}bt(n_,"SymbolBuffers");class s_{constructor(e,i,s){this.layoutVertexArray=new e,this.layoutAttributes=i,this.indexArray=new s,this.segments=new Tr,this.collisionVertexArray=new Gl,this.collisionVertexArrayExt=new Qr}upload(e){this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=e.createVertexBuffer(this.collisionVertexArray,Rb.members,!0),this.collisionVertexBufferExt=e.createVertexBuffer(this.collisionVertexArrayExt,zb.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}bt(s_,"CollisionBuffers");class lp{constructor(e){this.collisionBoxArray=e.collisionBoxArray,this.zoom=e.zoom,this.lut=e.lut,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(h=>h.fqid),this.index=e.index,this.pixelRatio=e.pixelRatio,this.sourceLayerIndex=e.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.hasAnyIconTextFit=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=re([]),this.placementViewportMatrix=re([]);const i=this.layers[0]._unevaluatedLayout._values;this.worldview=e.worldview,this.textSizeData=bv(this.zoom,i["text-size"],this.worldview),this.iconSizeData=bv(this.zoom,i["icon-size"],this.worldview);const s=this.layers[0].layout,a=s.get("symbol-sort-key"),u=s.get("symbol-z-order");this.canOverlap=s.get("text-allow-overlap")||s.get("icon-allow-overlap")||s.get("text-ignore-placement")||s.get("icon-ignore-placement"),this.sortFeaturesByKey=u!=="viewport-y"&&a.constantOr(1)!==void 0,this.sortFeaturesByY=(u==="viewport-y"||u==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=s.get("text-writing-mode").map(h=>Zn[h]),this.stateDependentLayerIds=this.layers.filter(h=>h.isStateDependent()).map(h=>h.id),this.sourceID=e.sourceID,this.projection=e.projection,this.hasAnyZOffset=!1,this.zOffsetSortDirty=!1,this.zOffsetBuffersNeedUpload=!1,this.elevationType="none",this.elevationStateComplete=!1,this.activeReplacements=[],this.replacementUpdateTime=0}createArrays(){this.text=new n_(new l(this.layers,{zoom:this.zoom,lut:this.lut},e=>e.startsWith("text")||e.startsWith("symbol"))),this.icon=new n_(new l(this.layers,{zoom:this.zoom,lut:this.lut},e=>e.startsWith("icon")||e.startsWith("symbol"))),this.glyphOffsetArray=new kh,this.lineVertexArray=new xf,this.symbolInstances=new vf}calculateGlyphDependencies(e,i,s,a,u){for(const h of e){const p=h.codePointAt(0);if(p===void 0)break;if(i[p]=!0,a&&u&&p<=65535){const _=sd[h];_&&(i[_.charCodeAt(0)]=!0)}}}updateFootprints(e,i){}updateReplacement(e,i){if(i.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=i.updateTime;const s=i.getReplacementRegionsForTile(e.toUnwrapped(),!0);return!Lm(this.activeReplacements,s)&&(this.activeReplacements=s,!0)}populate(e,i,s,a){const u=this.layers[0],h=u.layout,p=this.projection.name==="globe",_=h.get("text-font"),g=h.get("text-field"),x=h.get("icon-image"),[b,w]=h.get("icon-size-scale-range"),E=Q(i.scaleFactor||1,b,w),A=(g.value.kind!=="constant"||g.value.value instanceof vn&&!g.value.value.isEmpty()||g.value.value.toString().length>0)&&(_.value.kind!=="constant"||_.value.value.length>0),P=x.value.kind!=="constant"||!!x.value.value||Object.keys(x.parameters).length>0,L=h.get("symbol-sort-key");if(this.features=[],!A&&!P)return;const k=i.iconDependencies,j=i.glyphDependencies,G=i.availableImages,R=new Gi(this.zoom,{worldview:this.worldview});for(const{feature:N,id:q,index:Z,sourceLayerIndex:ae}of e){const ne=u._featureFilter.needGeometry,ce=gt(N,ne);if(!u._featureFilter.filter(R,ce,s))continue;if(ne||(ce.geometry=Tt(N,s,a)),p&&N.type!==1&&s.z<=5){const We=ce.geometry,Ke=.98078528056,Le=(He,Me)=>Ar(Gh(He.x,He.y,s,1),Gh(Me.x,Me.y,s,1))<Ke;for(let He=0;He<We.length;He++)We[He]=rt(We[He],Le)}let me,Re;if(A){const We=u.getValueAndResolveTokens("text-field",ce,s,G),Ke=vn.factory(We);fw(Ke)&&(this.hasRTLText=!0),(!this.hasRTLText||za()==="unavailable"||this.hasRTLText&&Bs.isParsed())&&(me=Db(Ke,u,ce))}if(P){const We=u.getValueAndResolveTokens("icon-image",ce,s,G);Re=typeof We=="string"?In.build(We):We}if(!me&&!Re)continue;const Xe=this.sortFeaturesByKey?L.evaluate(ce,{},s):void 0,Ve={id:q,text:me,icon:Re,index:Z,sourceLayerIndex:ae,geometry:ce.geometry,properties:N.properties,type:hw[N.type],sortKey:Xe};if(this.features.push(Ve),Re){const We=this.layers[0]._unevaluatedLayout._values,{iconPrimary:Ke,iconSecondary:Le}=kv(Re,this.iconSizeData,We["icon-size"],s,this.zoom,Ve,this.pixelRatio,E,this.worldview),He=Ke.id.toString();if(k.has(He)?k.get(He).push(Ke):k.set(He,[Ke]),Le){const Me=Le.id.toString();k.has(Me)?k.get(Me).push(Le):k.set(Me,[Le])}}if(me){const We=_.evaluate(ce,{},s).join(","),Ke=h.get("text-rotation-alignment")==="map"&&h.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(Zn.vertical)>=0;for(const Le of me.sections)if(Le.image){const He=Le.image.getPrimary().scaleSelf(this.pixelRatio),Me=He.id.toString(),ze=k.get(Me)||[];ze.push(He),k.set(Me,ze)}else{const He=Fl(me.toString()),Me=Le.fontStack||We,ze=j[Me]=j[Me]||{};this.calculateGlyphDependencies(Le.text,ze,Ke,this.allowVerticalPlacement,He)}}}if(h.get("symbol-placement")==="line"&&(this.features=function(N){const q={},Z={},ae=[];let ne=0;function ce(Ve){ae.push(N[Ve]),ne++}function me(Ve,We,Ke){const Le=Z[Ve];return delete Z[Ve],Z[We]=Le,ae[Le].geometry[0].pop(),ae[Le].geometry[0]=ae[Le].geometry[0].concat(Ke[0]),Le}function Re(Ve,We,Ke){const Le=q[We];return delete q[We],q[Ve]=Le,ae[Le].geometry[0].shift(),ae[Le].geometry[0]=Ke[0].concat(ae[Le].geometry[0]),Le}function Xe(Ve,We,Ke){const Le=Ke?We[0][We[0].length-1]:We[0][0];return`${Ve}:${Le.x}:${Le.y}`}for(let Ve=0;Ve<N.length;Ve++){const We=N[Ve],Ke=We.geometry,Le=We.text?We.text.toString():null;if(!Le){ce(Ve);continue}const He=Xe(Le,Ke),Me=Xe(Le,Ke,!0);if(He in Z&&Me in q&&Z[He]!==q[Me]){const ze=Re(He,Me,Ke),et=me(He,Me,ae[ze].geometry);delete q[He],delete Z[Me],Z[Xe(Le,ae[et].geometry,!0)]=et,ae[ze].geometry=null}else He in Z?me(He,Me,Ke):Me in q?Re(He,Me,Ke):(ce(Ve),q[He]=ne-1,Z[Me]=ne-1)}return ae.filter(Ve=>Ve.geometry)}(this.features)),h.get("symbol-elevation-reference")==="hd-road-markup"){if(this.elevationType="road",i.elevationFeatures){!this.elevationFeatures&&i.elevationFeatures.length>0&&(this.elevationFeatures=[],this.elevationFeatureIdToIndex=new Map);for(const N of i.elevationFeatures)this.elevationFeatureIdToIndex.set(N.id,this.elevationFeatures.length),this.elevationFeatures.push(N)}}else h.get("symbol-z-elevate")&&(this.elevationType="offset");this.elevationType!=="none"&&(this.zOffsetBuffersNeedUpload=!0),this.sortFeaturesByKey&&this.features.sort((N,q)=>N.sortKey-q.sortKey)}update(e,i,s,a,u,h,p){this.text.programConfigurations.updatePaintArrays(e,i,u,s,a,h,p,this.worldview),this.icon.programConfigurations.updatePaintArrays(e,i,u,s,a,h,p,this.worldview)}updateRoadElevation(e){if(this.elevationType!=="road"||!this.elevationFeatures||this.elevationStateComplete)return;this.elevationStateComplete=!0,this.hasAnyZOffset=!1;let i=!1;const s=Pe(e),a=1/s;let u=!1,h=!1;for(let p=0;p<this.symbolInstances.length;p++){const _=this.symbolInstances.get(p),g=Ei(1,0,0),x=Ei(0,1,0),{numHorizontalGlyphVertices:b,numVerticalGlyphVertices:w,numIconVertices:E,numVerticalIconVertices:A}=_,P=b>0||w>0,L=E>0,k=this.elevationFeatures[_.elevationFeatureIndex];if(k){const j=new ut(_.tileAnchorX,_.tileAnchorY),G=.075+k.pointElevation(j);_.zOffset!==G&&(i=!0,_.zOffset=G);const R=k.computeSlopeNormal(j,a),N=aa(Pn(),Ei(0,0,1),R);Es(g,g,N),Es(x,x,N),g[2]*=s,x[2]*=s,g[0]===1&&g[1]===0&&g[2]===0&&x[0]===0&&x[1]===1&&x[2]===0||(u=u||P,h=h||L)}if(P&&(op(this.text.orientationVertexArray,b,g,x),op(this.text.orientationVertexArray,w,g,x)),L){const{placedIconSymbolIndex:j,verticalPlacedIconSymbolIndex:G}=_;j>=0&&op(this.icon.orientationVertexArray,E,g,x),G>=0&&op(this.icon.orientationVertexArray,A,g,x)}}u||(this.text.orientationVertexArray=void 0),h||(this.icon.orientationVertexArray=void 0),i&&(this.zOffsetBuffersNeedUpload=!0,this.zOffsetSortDirty=!0)}updateZOffset(){const e=(u,h,p)=>{s+=h,s>u.length&&u.resize(s);for(let _=-h;_<0;_++)u.emplace(_+s,p)},i=(u,h,p)=>{a+=h,a>u.length&&u.resize(a);for(let _=-h;_<0;_++)u.emplace(_+a,p)};if(!this.zOffsetBuffersNeedUpload)return;this.zOffsetBuffersNeedUpload=!1;let s=0,a=0;for(let u=0;u<this.symbolInstances.length;u++){const h=this.symbolInstances.get(u),{numHorizontalGlyphVertices:p,numVerticalGlyphVertices:_,numIconVertices:g}=h,x=h.zOffset,b=g>0;if((p>0||_>0)&&(e(this.text.zOffsetVertexArray,p,x),e(this.text.zOffsetVertexArray,_,x)),b){const{placedIconSymbolIndex:w,verticalPlacedIconSymbolIndex:E}=h;w>=0&&i(this.icon.zOffsetVertexArray,g,x),E>=0&&i(this.icon.zOffsetVertexArray,h.numVerticalIconVertices,x)}}this.text.zOffsetVertexBuffer&&this.text.zOffsetVertexBuffer.updateData(this.text.zOffsetVertexArray),this.icon.zOffsetVertexBuffer&&this.icon.zOffsetVertexBuffer.updateData(this.icon.zOffsetVertexArray)}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(e){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(e),this.iconCollisionBox.upload(e)),this.text.upload(e,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.icon.upload(e,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=Hv(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(e,i){const s=this.lineVertexArray.length;if(e.segment!==void 0)for(const{x:a,y:u}of i)this.lineVertexArray.emplaceBack(a,u);return{lineStartIndex:s,lineLength:this.lineVertexArray.length-s}}addSymbols(e,i,s,a,u,h,p,_,g,x,b,w,E,A,P,L){const k=e.indexArray,j=e.layoutVertexArray,G=e.globeExtVertexArray,R=e.segments.prepareSegment(4*i.length,j,k,this.canOverlap?h.sortKey:void 0),N=this.glyphOffsetArray.length,q=R.vertexLength,Z=this.allowVerticalPlacement&&p===Zn.vertical?Math.PI/2:0,ae=h.text&&h.text.sections;for(let ce=0;ce<i.length;ce++){const{tl:me,tr:Re,bl:Xe,br:Ve,texPrimary:We,texSecondary:Ke,pixelOffsetTL:Le,pixelOffsetBR:He,minFontScaleX:Me,minFontScaleY:ze,glyphOffset:et,isSDF:it,sectionIndex:Ot}=i[ce],At=R.vertexLength,pt=et[1];if(rp(j,g.x,g.y,me.x,pt+me.y,We.x,We.y,s,it,Le.x,Le.y,Me,ze),rp(j,g.x,g.y,Re.x,pt+Re.y,We.x+We.w,We.y,s,it,He.x,Le.y,Me,ze),rp(j,g.x,g.y,Xe.x,pt+Xe.y,We.x,We.y+We.h,s,it,Le.x,He.y,Me,ze),rp(j,g.x,g.y,Ve.x,pt+Ve.y,We.x+We.w,We.y+We.h,s,it,He.x,He.y,Me,ze),_){const{x:Qe,y:Xt,z:Et}=_.anchor,[Mt,jt,Qt]=_.up;sp(G,Qe,Xt,Et,Mt,jt,Qt),sp(G,Qe,Xt,Et,Mt,jt,Qt),sp(G,Qe,Xt,Et,Mt,jt,Qt),sp(G,Qe,Xt,Et,Mt,jt,Qt),ap(e.dynamicLayoutVertexArray,Qe,Xt,Et,Z)}else ap(e.dynamicLayoutVertexArray,g.x,g.y,g.z,Z);if(L){const Qe=Ke||We;np(e.iconTransitioningVertexArray,Qe.x,Qe.y),np(e.iconTransitioningVertexArray,Qe.x+Qe.w,Qe.y),np(e.iconTransitioningVertexArray,Qe.x,Qe.y+Qe.h),np(e.iconTransitioningVertexArray,Qe.x+Qe.w,Qe.y+Qe.h)}k.emplaceBack(At,At+1,At+2),k.emplaceBack(At+1,At+2,At+3),R.vertexLength+=4,R.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(et[0]),ce!==i.length-1&&Ot===i[ce+1].sectionIndex||e.programConfigurations.populatePaintArrays(j.length,h,h.index,{},E,A,P,ae&&ae[Ot],this.worldview)}const ne=_?_.anchor:g;e.placedSymbolArray.emplaceBack(ne.x,ne.y,ne.z,g.x,g.y,N,this.glyphOffsetArray.length-N,q,x,b,g.segment,s?s[0]:0,s?s[1]:0,a[0],a[1],p,0,0,0,w,0)}_commitLayoutVertex(e,i,s,a,u,h,p){e.emplaceBack(i,s,a,u,h,Math.round(p.x),Math.round(p.y))}_addCollisionDebugVertices(e,i,s,a,u,h,p){const _=s.segments.prepareSegment(4,s.layoutVertexArray,s.indexArray),g=_.vertexLength,x=p.tileAnchorX,b=p.tileAnchorY;for(let E=0;E<4;E++)s.collisionVertexArray.emplaceBack(0,0,0,0,0,0);this._commitDebugCollisionVertexUpdate(s.collisionVertexArrayExt,i,e.padding,p.zOffset),this._commitLayoutVertex(s.layoutVertexArray,a,u,h,x,b,new ut(e.x1,e.y1)),this._commitLayoutVertex(s.layoutVertexArray,a,u,h,x,b,new ut(e.x2,e.y1)),this._commitLayoutVertex(s.layoutVertexArray,a,u,h,x,b,new ut(e.x2,e.y2)),this._commitLayoutVertex(s.layoutVertexArray,a,u,h,x,b,new ut(e.x1,e.y2)),_.vertexLength+=4;const w=s.indexArray;w.emplaceBack(g,g+1),w.emplaceBack(g+1,g+2),w.emplaceBack(g+2,g+3),w.emplaceBack(g+3,g),_.primitiveLength+=4}_addTextDebugCollisionBoxes(e,i,s,a,u,h){for(let p=a;p<u;p++){const _=s.get(p),g=this.getSymbolInstanceTextSize(e,h,i,p);this._addCollisionDebugVertices(_,g,this.textCollisionBox,_.projectedAnchorX,_.projectedAnchorY,_.projectedAnchorZ,h)}}_addIconDebugCollisionBoxes(e,i,s,a,u,h){for(let p=a;p<u;p++){const _=s.get(p),g=this.getSymbolInstanceIconSize(e,i,h.placedIconSymbolIndex);this._addCollisionDebugVertices(_,g,this.iconCollisionBox,_.projectedAnchorX,_.projectedAnchorY,_.projectedAnchorZ,h)}}generateCollisionDebugBuffers(e,i,s){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new s_(ru,av.members,go),this.iconCollisionBox=new s_(ru,av.members,go);const a=ad(this.iconSizeData,e),u=ad(this.textSizeData,e,s);for(let h=0;h<this.symbolInstances.length;h++){const p=this.symbolInstances.get(h);this._addTextDebugCollisionBoxes(u,e,i,p.textBoxStartIndex,p.textBoxEndIndex,p),this._addTextDebugCollisionBoxes(u,e,i,p.verticalTextBoxStartIndex,p.verticalTextBoxEndIndex,p),this._addIconDebugCollisionBoxes(a,e,i,p.iconBoxStartIndex,p.iconBoxEndIndex,p),this._addIconDebugCollisionBoxes(a,e,i,p.verticalIconBoxStartIndex,p.verticalIconBoxEndIndex,p)}}getSymbolInstanceTextSize(e,i,s,a){const u=this.text.placedSymbolArray.get(i.rightJustifiedTextSymbolIndex>=0?i.rightJustifiedTextSymbolIndex:i.centerJustifiedTextSymbolIndex>=0?i.centerJustifiedTextSymbolIndex:i.leftJustifiedTextSymbolIndex>=0?i.leftJustifiedTextSymbolIndex:i.verticalPlacedTextSymbolIndex>=0?i.verticalPlacedTextSymbolIndex:a),h=Km(this.textSizeData,e,u)/Kr;return this.tilePixelRatio*h}getSymbolInstanceIconSize(e,i,s){const a=this.icon.placedSymbolArray.get(s),u=Km(this.iconSizeData,e,a);return this.tilePixelRatio*u}_commitDebugCollisionVertexUpdate(e,i,s,a){e.emplaceBack(i,-s,-s,a),e.emplaceBack(i,s,-s,a),e.emplaceBack(i,s,s,a),e.emplaceBack(i,-s,s,a)}_updateTextDebugCollisionBoxes(e,i,s,a,u,h,p){for(let _=a;_<u;_++){const g=s.get(_),x=this.getSymbolInstanceTextSize(e,h,i,_);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,x,g.padding,h.zOffset)}}_updateIconDebugCollisionBoxes(e,i,s,a,u,h,p){for(let _=a;_<u;_++){const g=s.get(_),x=this.getSymbolInstanceIconSize(e,i,h.placedIconSymbolIndex);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,x,g.padding,h.zOffset)}}updateCollisionDebugBuffers(e,i,s,a){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();const u=ad(this.iconSizeData,e,a),h=ad(this.textSizeData,e,s);for(let p=0;p<this.symbolInstances.length;p++){const _=this.symbolInstances.get(p);this._updateTextDebugCollisionBoxes(h,e,i,_.textBoxStartIndex,_.textBoxEndIndex,_,s),this._updateTextDebugCollisionBoxes(h,e,i,_.verticalTextBoxStartIndex,_.verticalTextBoxEndIndex,_,s),this._updateIconDebugCollisionBoxes(u,e,i,_.iconBoxStartIndex,_.iconBoxEndIndex,_,a),this._updateIconDebugCollisionBoxes(u,e,i,_.verticalIconBoxStartIndex,_.verticalIconBoxEndIndex,_,a)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(e,i,s,a,u,h,p,_,g){const x={};if(i<s){const{x1:b,y1:w,x2:E,y2:A,padding:P,projectedAnchorX:L,projectedAnchorY:k,projectedAnchorZ:j,tileAnchorX:G,tileAnchorY:R,featureIndex:N}=e.get(i);x.textBox={x1:b,y1:w,x2:E,y2:A,padding:P,projectedAnchorX:L,projectedAnchorY:k,projectedAnchorZ:j,tileAnchorX:G,tileAnchorY:R},x.textFeatureIndex=N}if(a<u){const{x1:b,y1:w,x2:E,y2:A,padding:P,projectedAnchorX:L,projectedAnchorY:k,projectedAnchorZ:j,tileAnchorX:G,tileAnchorY:R,featureIndex:N}=e.get(a);x.verticalTextBox={x1:b,y1:w,x2:E,y2:A,padding:P,projectedAnchorX:L,projectedAnchorY:k,projectedAnchorZ:j,tileAnchorX:G,tileAnchorY:R},x.verticalTextFeatureIndex=N}if(h<p){const{x1:b,y1:w,x2:E,y2:A,padding:P,projectedAnchorX:L,projectedAnchorY:k,projectedAnchorZ:j,tileAnchorX:G,tileAnchorY:R,featureIndex:N}=e.get(h);x.iconBox={x1:b,y1:w,x2:E,y2:A,padding:P,projectedAnchorX:L,projectedAnchorY:k,projectedAnchorZ:j,tileAnchorX:G,tileAnchorY:R},x.iconFeatureIndex=N}if(_<g){const{x1:b,y1:w,x2:E,y2:A,padding:P,projectedAnchorX:L,projectedAnchorY:k,projectedAnchorZ:j,tileAnchorX:G,tileAnchorY:R,featureIndex:N}=e.get(_);x.verticalIconBox={x1:b,y1:w,x2:E,y2:A,padding:P,projectedAnchorX:L,projectedAnchorY:k,projectedAnchorZ:j,tileAnchorX:G,tileAnchorY:R},x.verticalIconFeatureIndex=N}return x}deserializeCollisionBoxes(e){this.collisionArrays=[];for(let i=0;i<this.symbolInstances.length;i++){const s=this.symbolInstances.get(i);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(e,s.textBoxStartIndex,s.textBoxEndIndex,s.verticalTextBoxStartIndex,s.verticalTextBoxEndIndex,s.iconBoxStartIndex,s.iconBoxEndIndex,s.verticalIconBoxStartIndex,s.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}hasIconTextFit(){return this.hasAnyIconTextFit}addIndicesForPlacedSymbol(e,i){const s=e.placedSymbolArray.get(i),a=s.vertexStartIndex+4*s.numGlyphs;for(let u=s.vertexStartIndex;u<a;u+=4)e.indexArray.emplaceBack(u,u+1,u+2),e.indexArray.emplaceBack(u+1,u+2,u+3)}getSortedSymbolIndexes(e){if(this.sortedAngle===e&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;const i=Math.sin(e),s=Math.cos(e),a=[],u=[],h=[];for(let p=0;p<this.symbolInstances.length;++p){h.push(p);const _=this.symbolInstances.get(p);a.push(0|Math.round(i*_.tileAnchorX+s*_.tileAnchorY)),u.push(_.featureIndex)}return h.sort((p,_)=>a[p]-a[_]||u[_]-u[p]),h}getSortedIndexesByZOffset(){if(!this.zOffsetSortDirty)return this.symbolInstanceIndexesSortedZOffset;if(!this.symbolInstanceIndexesSortedZOffset){this.symbolInstanceIndexesSortedZOffset=[];for(let e=0;e<this.symbolInstances.length;++e)this.symbolInstanceIndexesSortedZOffset.push(e)}return this.zOffsetSortDirty=!1,this.symbolInstanceIndexesSortedZOffset.sort((e,i)=>this.symbolInstances.get(i).zOffset-this.symbolInstances.get(e).zOffset)}addToSortKeyRanges(e,i){const s=this.sortKeyRanges[this.sortKeyRanges.length-1];s&&s.sortKey===i?s.symbolInstanceEnd=e+1:this.sortKeyRanges.push({sortKey:i,symbolInstanceStart:e,symbolInstanceEnd:e+1})}sortFeatures(e){if(this.sortFeaturesByY&&this.sortedAngle!==e&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(e),this.sortedAngle=e,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const i of this.symbolInstanceIndexes){const s=this.symbolInstances.get(i);this.featureSortOrder.push(s.featureIndex);const{rightJustifiedTextSymbolIndex:a,centerJustifiedTextSymbolIndex:u,leftJustifiedTextSymbolIndex:h,verticalPlacedTextSymbolIndex:p,placedIconSymbolIndex:_,verticalPlacedIconSymbolIndex:g}=s;a>=0&&this.addIndicesForPlacedSymbol(this.text,a),u>=0&&u!==a&&this.addIndicesForPlacedSymbol(this.text,u),h>=0&&h!==u&&h!==a&&this.addIndicesForPlacedSymbol(this.text,h),p>=0&&this.addIndicesForPlacedSymbol(this.text,p),_>=0&&this.addIndicesForPlacedSymbol(this.icon,_),g>=0&&this.addIndicesForPlacedSymbol(this.icon,g)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}let Zv,Wv,o_;bt(lp,"SymbolBucket",{omit:["layers","collisionBoxArray","features","compareText"]}),lp.addDynamicAttributes=ap;class Xv{constructor(e){this.type=e.property.overrides?e.property.overrides.runtimeType:pa,this.defaultValue=e}evaluate(e){if(e.formattedSection){const i=this.defaultValue.property.overrides;if(i&&i.hasOverride(e.formattedSection))return i.getOverride(e.formattedSection)}return e.feature&&e.featureState?this.defaultValue.evaluate(e.feature,e.featureState):this.defaultValue.property.specification.default}eachChild(e){this.defaultValue.isConstant()||e(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}bt(Xv,"FormatSectionOverride",{omit:["defaultValue"]});const a_=()=>o_||(o_={layout:Zv||(Zv=new br({"symbol-placement":new Je(ge.layout_symbol["symbol-placement"]),"symbol-spacing":new Je(ge.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new Je(ge.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new _t(ge.layout_symbol["symbol-sort-key"]),"symbol-z-order":new Je(ge.layout_symbol["symbol-z-order"]),"symbol-z-elevate":new Je(ge.layout_symbol["symbol-z-elevate"]),"symbol-elevation-reference":new Je(ge.layout_symbol["symbol-elevation-reference"]),"icon-allow-overlap":new Je(ge.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new Je(ge.layout_symbol["icon-ignore-placement"]),"icon-optional":new Je(ge.layout_symbol["icon-optional"]),"icon-rotation-alignment":new Je(ge.layout_symbol["icon-rotation-alignment"]),"icon-size":new _t(ge.layout_symbol["icon-size"]),"icon-size-scale-range":new Je(ge.layout_symbol["icon-size-scale-range"]),"icon-text-fit":new _t(ge.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new _t(ge.layout_symbol["icon-text-fit-padding"]),"icon-image":new _t(ge.layout_symbol["icon-image"]),"icon-rotate":new _t(ge.layout_symbol["icon-rotate"]),"icon-padding":new Je(ge.layout_symbol["icon-padding"]),"icon-keep-upright":new Je(ge.layout_symbol["icon-keep-upright"]),"icon-offset":new _t(ge.layout_symbol["icon-offset"]),"icon-anchor":new _t(ge.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new Je(ge.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new Je(ge.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new Je(ge.layout_symbol["text-rotation-alignment"]),"text-field":new _t(ge.layout_symbol["text-field"]),"text-font":new _t(ge.layout_symbol["text-font"]),"text-size":new _t(ge.layout_symbol["text-size"]),"text-size-scale-range":new Je(ge.layout_symbol["text-size-scale-range"]),"text-max-width":new _t(ge.layout_symbol["text-max-width"]),"text-line-height":new _t(ge.layout_symbol["text-line-height"]),"text-letter-spacing":new _t(ge.layout_symbol["text-letter-spacing"]),"text-justify":new _t(ge.layout_symbol["text-justify"]),"text-radial-offset":new _t(ge.layout_symbol["text-radial-offset"]),"text-variable-anchor":new Je(ge.layout_symbol["text-variable-anchor"]),"text-anchor":new _t(ge.layout_symbol["text-anchor"]),"text-max-angle":new Je(ge.layout_symbol["text-max-angle"]),"text-writing-mode":new Je(ge.layout_symbol["text-writing-mode"]),"text-rotate":new _t(ge.layout_symbol["text-rotate"]),"text-padding":new Je(ge.layout_symbol["text-padding"]),"text-keep-upright":new Je(ge.layout_symbol["text-keep-upright"]),"text-transform":new _t(ge.layout_symbol["text-transform"]),"text-offset":new _t(ge.layout_symbol["text-offset"]),"text-allow-overlap":new Je(ge.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new Je(ge.layout_symbol["text-ignore-placement"]),"text-optional":new Je(ge.layout_symbol["text-optional"]),visibility:new Je(ge.layout_symbol.visibility)})),paint:Wv||(Wv=new br({"icon-opacity":new _t(ge.paint_symbol["icon-opacity"]),"icon-occlusion-opacity":new _t(ge.paint_symbol["icon-occlusion-opacity"]),"icon-emissive-strength":new _t(ge.paint_symbol["icon-emissive-strength"]),"text-emissive-strength":new _t(ge.paint_symbol["text-emissive-strength"]),"icon-color":new _t(ge.paint_symbol["icon-color"]),"icon-halo-color":new _t(ge.paint_symbol["icon-halo-color"]),"icon-halo-width":new _t(ge.paint_symbol["icon-halo-width"]),"icon-halo-blur":new _t(ge.paint_symbol["icon-halo-blur"]),"icon-translate":new Je(ge.paint_symbol["icon-translate"]),"icon-translate-anchor":new Je(ge.paint_symbol["icon-translate-anchor"]),"icon-image-cross-fade":new Je(ge.paint_symbol["icon-image-cross-fade"]),"text-opacity":new _t(ge.paint_symbol["text-opacity"]),"text-occlusion-opacity":new _t(ge.paint_symbol["text-occlusion-opacity"]),"text-color":new _t(ge.paint_symbol["text-color"],{runtimeType:Dn,getOverride:r=>r.textColor,hasOverride:r=>!!r.textColor}),"text-halo-color":new _t(ge.paint_symbol["text-halo-color"]),"text-halo-width":new _t(ge.paint_symbol["text-halo-width"]),"text-halo-blur":new _t(ge.paint_symbol["text-halo-blur"]),"text-translate":new Je(ge.paint_symbol["text-translate"]),"text-translate-anchor":new Je(ge.paint_symbol["text-translate-anchor"]),"icon-color-saturation":new Je(ge.paint_symbol["icon-color-saturation"]),"icon-color-contrast":new Je(ge.paint_symbol["icon-color-contrast"]),"icon-color-brightness-min":new Je(ge.paint_symbol["icon-color-brightness-min"]),"icon-color-brightness-max":new Je(ge.paint_symbol["icon-color-brightness-max"]),"symbol-z-offset":new _t(ge.paint_symbol["symbol-z-offset"]),"icon-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"icon-halo-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"text-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"text-halo-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},o_);class cp extends hn{constructor(e,i,s,a){super(e,a_(),i,s,a),this._colorAdjustmentMatrix=re([]),this.hasInitialOcclusionOpacityProperties=e.paint!==void 0&&("icon-occlusion-opacity"in e.paint||"text-occlusion-opacity"in e.paint)}recalculate(e,i){super.recalculate(e,i),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));const s=this.layout.get("text-writing-mode");if(s){const a=[];for(const u of s)a.indexOf(u)<0&&a.push(u);this.layout._values["text-writing-mode"]=a}else this.layout._values["text-writing-mode"]=this.layout.get("symbol-placement")==="point"?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getColorAdjustmentMatrix(e,i,s,a){return this._saturation===e&&this._contrast===i&&this._brightnessMin===s&&this._brightnessMax===a||(this._colorAdjustmentMatrix=function(u,h,p,_){u=ln(u),h=Sn(h);const g=st(),x=u/3,b=1-2*x,w=[b,x,x,0,x,b,x,0,x,x,b,0,0,0,0,1],E=.5-.5*h,A=_-p;return at(g,[A,0,0,0,0,A,0,0,0,0,A,0,p,p,p,1],[h,0,0,0,0,h,0,0,0,0,h,0,E,E,E,1]),at(g,g,w),g}(e,i,s,a),this._saturation=e,this._contrast=i,this._brightnessMin=s,this._brightnessMax=a),this._colorAdjustmentMatrix}getValueAndResolveTokens(e,i,s,a){const u=this.layout.get(e).evaluate(i,{},s,a),h=this._unevaluatedLayout._values[e];return h.isDataDriven()||Zc(h.value)||!u?u:function(p,_){return _.replace(/{([^{}]+)}/g,(g,x)=>x in p?String(p[x]):"")}(i.properties,u)}createBucket(e){return new lp(e)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(const e of a_().paint.overridableProperties){if(!cp.hasPaintOverride(this.layout,e))continue;const i=this.paint.get(e),s=new Xv(i),a=new Ma(s,i.property.specification,this.scope,this.options);let u=null;u=i.value.kind==="constant"||i.value.kind==="source"?new Ol("source",a):new kl("composite",a,i.value.zoomStops,i.value.interpolationType),this.paint._values[e]=new La(i.property,u,i.parameters)}}_handleOverridablePaintPropertyUpdate(e,i,s){return!(!this.layout||i.isDataDriven()||s.isDataDriven())&&cp.hasPaintOverride(this.layout,e)}static hasPaintOverride(e,i){const s=e.get("text-field"),a=a_().paint.properties[i];let u=!1;const h=p=>{for(const _ of p)if(a.overrides&&a.overrides.hasOverride(_))return void(u=!0)};if(s.value.kind==="constant"&&s.value.value instanceof vn)h(s.value.value.sections);else if(s.value.kind==="source"){const p=g=>{u||(g instanceof Zt&&xt(g.value)===yl?h(g.value.sections):g instanceof _a?h(g.sections):g.eachChild(p))},_=s.value;_._styleExpression&&p(_._styleExpression.expression)}return u}getProgramIds(){return["symbol"]}getDefaultProgramParams(e,i,s){return{config:new Ga(this,{zoom:i,lut:s}),overrideFog:!1}}hasElevation(){return this.layout&&this.layout.get("symbol-elevation-reference")==="hd-road-markup"}}let Yv,Kv,Jv,Qv;var l_=bi([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);function c_(r){switch(r){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.RGBA;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.DEPTH_COMPONENT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.DEPTH_STENCIL;case WebGL2RenderingContext.R8:case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.RED}}function u_(r){switch(r){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.UNSIGNED_SHORT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.UNSIGNED_INT_24_8;case WebGL2RenderingContext.R8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.FLOAT}}class h_{constructor(e,i,s,a){this.context=e,this.format=s,this.useMipmap=a&&a.useMipmap,this.texture=e.gl.createTexture(),this.update(i,{premultiply:a&&a.premultiply})}update(e,i){const s=e&&e instanceof HTMLVideoElement&&e.width===0?e.videoWidth:e.width,a=e&&e instanceof HTMLVideoElement&&e.height===0?e.videoHeight:e.height,{context:u}=this,{gl:h}=u,{x:p,y:_}=i&&i.position?i.position:{x:0,y:0},g=p+s,x=_+a;!this.size||this.size[0]===g&&this.size[1]===x||(h.bindTexture(h.TEXTURE_2D,null),h.deleteTexture(this.texture),this.texture=h.createTexture(),this.size=null),h.bindTexture(h.TEXTURE_2D,this.texture),u.pixelStoreUnpackFlipY.set(!1),u.pixelStoreUnpack.set(1),u.pixelStoreUnpackPremultiplyAlpha.set(this.format===h.RGBA8&&(!i||i.premultiply!==!1));const b=e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement||e instanceof ImageData||ImageBitmap&&e instanceof ImageBitmap;if(!this.size&&g>0&&x>0){const w=this.useMipmap?Math.floor(Math.log2(Math.max(g,x)))+1:1;h.texStorage2D(h.TEXTURE_2D,w,this.format,g,x),this.size=[g,x]}if(this.size)if(b)h.texSubImage2D(h.TEXTURE_2D,0,p,_,c_(this.format),u_(this.format),e);else{const w=e.data;w&&h.texSubImage2D(h.TEXTURE_2D,0,p,_,s,a,c_(this.format),u_(this.format),w)}this.useMipmap&&h.generateMipmap(h.TEXTURE_2D)}bind(e,i,s=!1){const{context:a}=this,{gl:u}=a;u.bindTexture(u.TEXTURE_2D,this.texture),e!==this.minFilter&&(u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MAG_FILTER,e),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MIN_FILTER,this.useMipmap&&!s?e===u.NEAREST?u.NEAREST_MIPMAP_NEAREST:u.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),i!==this.wrapS&&(u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_S,i),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_T,i),this.wrapS=i)}bindExtraParam(e,i,s,a,u){const{context:h}=this,{gl:p}=h;p.bindTexture(p.TEXTURE_2D,this.texture),i!==this.magFilter&&(p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MAG_FILTER,i),this.magFilter=i),e!==this.minFilter&&(p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MIN_FILTER,this.useMipmap?e===p.NEAREST?p.NEAREST_MIPMAP_NEAREST:p.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),s!==this.wrapS&&(p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_S,s),this.wrapS=s),a!==this.wrapT&&(p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_T,a),this.wrapT=a),u!==this.compareMode&&(u?(p.texParameteri(p.TEXTURE_2D,p.TEXTURE_COMPARE_MODE,p.COMPARE_REF_TO_TEXTURE),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_COMPARE_FUNC,u)):p.texParameteri(p.TEXTURE_2D,p.TEXTURE_COMPARE_MODE,p.NONE),this.compareMode=u)}destroy(){const{gl:e}=this.context;e.deleteTexture(this.texture),this.texture=null}}class up{constructor(e,i){this.context=e,this.texture=i}bind(e,i){const{context:s}=this,{gl:a}=s;a.bindTexture(a.TEXTURE_2D,this.texture),e!==this.minFilter&&(a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,e),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,e),this.minFilter=e),i!==this.wrapS&&(a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,i),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,i),this.wrapS=i)}}function hp(r,e,i,s,a,u,h,p){const _=[r,e,1,i,s,1,a,u,1],g=[h,p,1],x=zt([],_),[b,w,E]=Ss(g,g,x);return qt(_,_,[b,0,0,0,w,0,0,0,E])}function ex(r,e,i,s,a,u,h,p){const _=function(g,x,b,w,E,A,P,L){const k=hp(0,0,1,0,1,1,0,1),j=hp(g,x,b,w,E,A,P,L);return qt(j,j,zt([],k))}(r,e,i,s,a,u,h,p);return[_[2]/_[8]/dt,_[5]/_[8]/dt]}function dp(r){return[r[0],Math.min(Math.max(r[1],-85.051129),Oe)]}class tx extends Bo{constructor(e,i,s,a){super(),this.id=e,this.dispatcher=s,this.coordinates=i.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.onNorthPole=!1,this.onSouthPole=!1,this.setEventedParent(a),this.options=i,this._dirty=!1}load(e,i){if(this._loaded=i||!1,this.fire(new Fo("dataloading",{dataType:"source"})),this.url=this.options.url,!this.url)return e&&(this.coordinates=e),this._loaded=!0,void this._finishLoading();this._imageRequest=Vu(this.map._requestManager.transformRequest(this.url,fl.Image),(s,a)=>{this._imageRequest=null,this._loaded=!0,s?this.fire(new xc(s)):a&&(this.image=a instanceof HTMLImageElement?ns.getImageData(a):a,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,e&&(this.coordinates=e),this._finishLoading())})}loaded(){return this._loaded}updateImage(e){return e.url?(this._imageRequest&&e.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=e.url,this.load(e.coordinates,this._loaded),this):this}setTexture(e){if(!(e.handle instanceof WebGLTexture))throw new Error("The provided handle is not a WebGLTexture instance");return this.texture=new up(this.map.painter.context,e.handle),this.width=e.dimensions[0],this.height=e.dimensions[1],this._dirty=!1,this._loaded=!0,this._finishLoading(),this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new Fo("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(e){this.map=e,this.load()}onRemove(e){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),!this.texture||this.texture instanceof up||this.texture.destroy(),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy())}setCoordinates(e){if(this.coordinates=e,this._boundsArray=void 0,this._unsupportedCoords=!1,!e.length)return this;this.onNorthPole=!1,this.onSouthPole=!1;let i=e[0][1],s=e[0][1];for(const u of e)u[1]>s&&(s=u[1]),u[1]<i&&(i=u[1]);const a=(s+i)/2;if(a>Oe?this.onNorthPole=!0:a<-85.051129&&(this.onSouthPole=!0),!this.onNorthPole&&!this.onSouthPole){const u=e.map(ue.fromLngLat);this.tileID=function(h){let p=1/0,_=1/0,g=-1/0,x=-1/0;for(const P of h)p=Math.min(p,P.x),_=Math.min(_,P.y),g=Math.max(g,P.x),x=Math.max(x,P.y);const b=Math.max(g-p,x-_),w=Math.max(0,Math.floor(-Math.log(b)/Math.LN2)),E=Math.pow(2,w);let A=Math.floor((p+g)/2*E);return A>1&&(A-=1),new tc(w,A,Math.floor((_+x)/2*E))}(u),this.minzoom=this.maxzoom=this.tileID.z}return this.fire(new Fo("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){this._boundsArray=void 0,this._unsupportedCoords=!1}_prepareData(e){for(const k in this.tiles){const j=this.tiles[k];j.state!=="loaded"&&(j.state="loaded",j.texture=this.texture)}if(this._boundsArray||this.onNorthPole||this.onSouthPole||this._unsupportedCoords)return;const i=ud(new tc(0,0,0),this.map.transform.projection),s=[i.projection.project(this.coordinates[0][0],this.coordinates[0][1]),i.projection.project(this.coordinates[1][0],this.coordinates[1][1]),i.projection.project(this.coordinates[2][0],this.coordinates[2][1]),i.projection.project(this.coordinates[3][0],this.coordinates[3][1])];if(!function(k){const j=k[1].x-k[0].x,G=k[1].y-k[0].y,R=k[2].x-k[1].x,N=k[2].y-k[1].y,q=k[3].x-k[2].x,Z=k[3].y-k[2].y,ae=k[0].x-k[3].x,ne=k[0].y-k[3].y,ce=j*N-R*G,me=R*Z-q*N,Re=q*ne-ae*Z,Xe=ae*G-j*ne;return ce>0&&me>0&&Re>0&&Xe>0||ce<0&&me<0&&Re<0&&Xe<0}(s))return console.warn("Image source coordinates are defining non-convex area in the Mercator projection"),void(this._unsupportedCoords=!0);const a=ud(this.tileID,this.map.transform.projection),[u,h,p,_]=this.coordinates.map(k=>{const j=a.projection.project(k[0],k[1]);return Uv(a,j)._round()});this.perspectiveTransform=ex(u.x,u.y,h.x,h.y,p.x,p.y,_.x,_.y);const g=this._boundsArray=new Oa;g.emplaceBack(u.x,u.y,0,0),g.emplaceBack(h.x,h.y,dt,0),g.emplaceBack(_.x,_.y,0,dt),g.emplaceBack(p.x,p.y,dt,dt),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy()),this.boundsBuffer=e.createVertexBuffer(g,l_.members),this.boundsSegments=Tr.simpleSegment(0,0,4,2);const x=[],b=[dp((w=this.coordinates)[0]),dp(w[1]),dp(w[2]),dp(w[3])];var w;const[E,A,P,L]=function(k){let j=k[0][0],G=j,R=k[0][1],N=R;for(let q=1;q<k.length;q++)k[q][0]<j?j=k[q][0]:k[q][0]>G&&(G=k[q][0]),k[q][1]<R?R=k[q][1]:k[q][1]>N&&(N=k[q][1]);return[j,R,G-j,N-R]}(b);{const k=new Oa,[j,G,R,N]=function(Le){let He=Le[0].x,Me=He,ze=Le[0].y,et=ze;for(let it=1;it<Le.length;it++)Le[it].x<He?He=Le[it].x:Le[it].x>Me&&(Me=Le[it].x),Le[it].y<ze?ze=Le[it].y:Le[it].y>et&&(et=Le[it].y);return[He,ze,Me-He,et-ze]}(s),q=Le=>[(Le.x-j)/R,(Le.y-G)/N],[Z,ae,ne,ce]=s.map(q),me=function(Le,He,Me,ze,et,it,Ot,At){const pt=hp(0,0,1,0,1,1,0,1);return qt(pt,pt,zt([],hp(Le,He,Me,ze,et,it,Ot,At)))}(Z[0],Z[1],ae[0],ae[1],ne[0],ne[1],ce[0],ce[1]);this.elevatedGlobePerspectiveTransform=ex(Z[0],Z[1],ae[0],ae[1],ne[0],ne[1],ce[0],ce[1]);const Re=(Le,He)=>{x.push(Le.lng);const Me=Math.round((Le.lng-E)/P*dt),ze=Math.round((Le.lat-A)/L*dt),et=q(He),it=Ss([],[et[0],et[1],1],me),Ot=Math.round(it[0]/it[2]*dt),At=Math.round(it[1]/it[2]*dt);k.emplaceBack(Me,ze,Ot,At)},Xe=s[3].x-s[0].x,Ve=s[3].y-s[0].y,We=s[2].x-s[1].x,Ke=s[2].y-s[1].y;for(let Le=0;Le<65;Le++){const He=Le/64,Me=[s[0].x+He*Xe,s[0].y+He*Ve],ze=[s[1].x+He*We,s[1].y+He*Ke],et=ze[0]-Me[0],it=ze[1]-Me[1];for(let Ot=0;Ot<65;Ot++){const At=Ot/64,pt={x:Me[0]+et*At,y:Me[1]+it*At};Re(i.projection.unproject(pt.x,pt.y),pt)}}this.elevatedGlobeVertexBuffer=e.createVertexBuffer(k,l_.members)}{this.maxLongitudeTriangleSize=0;let k=[],j=new en;const G=(R,N,q)=>{j.emplaceBack(R,N,q);const Z=x[R],ae=x[N],ne=x[q],ce=Math.min(Math.min(Z,ae),ne),me=Math.max(Math.max(Z,ae),ne)-ce;me>this.maxLongitudeTriangleSize&&(this.maxLongitudeTriangleSize=me),k.push(ce+me/2)};for(let R=0;R<64;R++)for(let N=0;N<64;N++){const q=65*R+N,Z=q+1,ae=q+65,ne=ae+1;G(q,ae,Z),G(Z,ae,ne)}[k,j]=function(R,N){const q=Array.from({length:R.length},(ne,ce)=>ce);q.sort((ne,ce)=>R[ne]-R[ce]);const Z=[],ae=new en;for(let ne=0;ne<q.length;ne++){const ce=q[ne];Z.push(R[ce]);const me=3*ce,Re=me+1;ae.emplaceBack(N.uint16[me],N.uint16[Re],N.uint16[Re+1])}return[Z,ae]}(k,j),this.elevatedGlobeTrianglesCenterLongitudes=k,this.elevatedGlobeIndexBuffer=e.createIndexBuffer(j)}this.elevatedGlobeSegments=Tr.simpleSegment(0,0,4225,8192),this.elevatedGlobeGridMatrix=new Float32Array([0,P/dt,0,L/dt,0,0,A,E,0])}prepare(){const e=Object.keys(this.tiles).length!==0;if(this.tileID&&!e)return;const i=this.map.painter.context,s=i.gl;!this._dirty||this.texture instanceof up||(this.texture?this.texture.update(this.image):(this.texture=new h_(i,this.image,s.RGBA8),this.texture.bind(s.LINEAR,s.CLAMP_TO_EDGE)),this._dirty=!1),e&&this._prepareData(i)}loadTile(e,i){this.tileID&&this.tileID.equals(e.tileID.canonical)?(this.tiles[String(e.tileID.wrap)]=e,e.buckets={},i(null)):(e.state="errored",i(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}getSegmentsForLongitude(e){const i=this.elevatedGlobeSegments;if(!this.elevatedGlobeTrianglesCenterLongitudes||!i)return null;const s=this.elevatedGlobeTrianglesCenterLongitudes;let a=(u=e+180)+360*Math.round((s[0]-u)/360);var u;const h=new Tr,p=(b,w)=>{h.segments.push({vertexOffset:0,primitiveOffset:b,vertexLength:i.segments[0].vertexLength,primitiveLength:w,sortKey:void 0,vaos:{}})},_=.51*this.maxLongitudeTriangleSize;if(Math.abs(s[0]-a)<=_){const b=Xr(s,0,s.length,a+_);return b===s.length||p(b,_r(s,b+1,s.length,a+360-_)-b),h}a<s[0]&&(a+=360);const g=_r(s,0,s.length,a-_);if(g===s.length)return p(0,s.length),h;p(0,g-0);const x=Xr(s,g+1,s.length,a+_);return x!==s.length&&p(x,s.length-x),h}}const pw=(Math.pow(256,2)-1)/16907520;class ix extends hn{constructor(e,i,s,a){super(e,{layout:Jv||(Jv=new br({visibility:new Je(ge.layout_raster.visibility)})),paint:Qv||(Qv=new br({"raster-opacity":new Je(ge.paint_raster["raster-opacity"]),"raster-color":new Jo(ge.paint_raster["raster-color"]),"raster-color-mix":new Je(ge.paint_raster["raster-color-mix"]),"raster-color-range":new Je(ge.paint_raster["raster-color-range"]),"raster-hue-rotate":new Je(ge.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new Je(ge.paint_raster["raster-brightness-min"]),"raster-brightness-max":new Je(ge.paint_raster["raster-brightness-max"]),"raster-saturation":new Je(ge.paint_raster["raster-saturation"]),"raster-contrast":new Je(ge.paint_raster["raster-contrast"]),"raster-resampling":new Je(ge.paint_raster["raster-resampling"]),"raster-fade-duration":new Je(ge.paint_raster["raster-fade-duration"]),"raster-emissive-strength":new Je(ge.paint_raster["raster-emissive-strength"]),"raster-array-band":new Je(ge.paint_raster["raster-array-band"]),"raster-elevation":new Je(ge.paint_raster["raster-elevation"]),"raster-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},i,s,a),this.updateColorRamp(),this._curRampRange=[NaN,NaN]}getProgramIds(){return["raster"]}hasColorMap(){return!!this._transitionablePaint._values["raster-color"].value.value}tileCoverLift(){return this.paint.get("raster-elevation")}isDraped(e){return!(e&&e._source instanceof tx&&(e._source.onNorthPole||e._source.onSouthPole))&&this.paint.get("raster-elevation")===0}_handleSpecialPaintPropertyUpdate(e){e!=="raster-color"&&e!=="raster-color-range"||(this._curRampRange=[NaN,NaN],this.updateColorRamp())}updateColorRamp(e){if(!this.hasColorMap()||!this._curRampRange)return;const i=this._transitionablePaint._values["raster-color"].value.expression,[s,a]=e||this._transitionablePaint._values["raster-color-range"].value.expression.evaluate({zoom:0})||[NaN,NaN];isNaN(s)&&isNaN(a)||s===this._curRampRange[0]&&a===this._curRampRange[1]||(this.colorRamp=qh({expression:i,evaluationKey:"rasterValue",image:this.colorRamp,clips:[{start:s,end:a}],resolution:256}),this.colorRampTexture=null,this._curRampRange=[s,a])}}let rx,nx,sx,ox,ax;class lx extends hn{constructor(e,i,s,a){super(e,{layout:rx||(rx=new br({visibility:new Je(ge["layout_raster-particle"].visibility)})),paint:nx||(nx=new br({"raster-particle-array-band":new Je(ge["paint_raster-particle"]["raster-particle-array-band"]),"raster-particle-count":new Je(ge["paint_raster-particle"]["raster-particle-count"]),"raster-particle-color":new Jo(ge["paint_raster-particle"]["raster-particle-color"]),"raster-particle-max-speed":new Je(ge["paint_raster-particle"]["raster-particle-max-speed"]),"raster-particle-speed-factor":new Je(ge["paint_raster-particle"]["raster-particle-speed-factor"]),"raster-particle-fade-opacity-factor":new Je(ge["paint_raster-particle"]["raster-particle-fade-opacity-factor"]),"raster-particle-reset-rate-factor":new Je(ge["paint_raster-particle"]["raster-particle-reset-rate-factor"]),"raster-particle-elevation":new Je(ge["paint_raster-particle"]["raster-particle-elevation"]),"raster-particle-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},i,s,a),this._updateColorRamp(),this.lastInvalidatedAt=ns.now()}onRemove(e){this.colorRampTexture&&this.colorRampTexture.destroy(),this.tileFramebuffer&&this.tileFramebuffer.destroy(),this.particleFramebuffer&&this.particleFramebuffer.destroy()}hasColorMap(){return!!this._transitionablePaint._values["raster-particle-color"].value.value}getProgramIds(){return["rasterParticle"]}hasOffscreenPass(){return this.visibility!=="none"}isDraped(e){return!1}_handleSpecialPaintPropertyUpdate(e){e!=="raster-particle-color"&&e!=="raster-particle-max-speed"||(this._updateColorRamp(),this._invalidateAnimationState()),e==="raster-particle-count"&&this._invalidateAnimationState()}_updateColorRamp(){if(!this.hasColorMap())return;const e=this._transitionablePaint._values["raster-particle-color"].value.expression,i=this._transitionablePaint._values["raster-particle-max-speed"].value.expression.evaluate({zoom:0});this.colorRamp=qh({expression:e,evaluationKey:"rasterParticleSpeed",image:this.colorRamp,clips:[{start:0,end:i}],resolution:256}),this.colorRampTexture=null}_invalidateAnimationState(){this.lastInvalidatedAt=ns.now()}tileCoverLift(){return this.paint.get("raster-particle-elevation")}}class mw extends hn{constructor(e,i){super(e,{},i,null),this.implementation=e,e.slot&&(this.slot=e.slot)}is3D(e){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}isDraped(e){return this.implementation.renderToTile!==void 0}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(e){this.implementation.onAdd&&this.implementation.onAdd(e,e.painter.context.gl)}onRemove(e){this.implementation.onRemove&&this.implementation.onRemove(e,e.painter.context.gl)}}function d_(r,e,i){const s=[0,0,1],a=Xs([]);return Ks(a,a,i?-wi(r)+Math.PI:wi(r)),Ys(a,a,-wi(e)),Es(s,s,a),mr(s,s)}function cx(r,e){const i=fp(r.projection,r.zoom,r.width,r.height),s=function(u,h,p,_,g){const x=new V(p.lng-180*Ka,p.lat),b=new V(p.lng+180*Ka,p.lat),w=u.project(x.lng,x.lat),E=u.project(b.lng,b.lat),A=-Math.atan2(E.y-w.y,E.x-w.x),P=ue.fromLngLat(p);P.y=Q(P.y,-1+Ka,1-Ka);const L=P.toLngLat(),k=u.project(L.lng,L.lat),j=ue.fromLngLat(L);j.x+=Ka;const G=j.toLngLat(),R=u.project(G.lng,G.lat),N=hx(R.x-k.x,R.y-k.y,A),q=ue.fromLngLat(L);q.y+=Ka;const Z=q.toLngLat(),ae=u.project(Z.lng,Z.lat),ne=hx(ae.x-k.x,ae.y-k.y,A),ce=Math.abs(N.x)/Math.abs(ne.y),me=re([]);Ye(me,me,-A*(1-(g?0:_)));const Re=re([]);return vt(Re,Re,[1,1-(1-ce)*_,1]),Re[4]=-ne.x/ne.y*_,Ye(Re,Re,A),at(Re,me,Re),Re}(r.projection,0,r.center,i,e),a=ux(r);return vt(s,s,[a,a,1]),s}function ux(r){const e=r.projection,i=fp(r.projection,r.zoom,r.width,r.height),s=f_(e,r.center),a=f_(e,V.convert(e.center));return Math.pow(2,s*i+(1-i)*a)}function fp(r,e,i,s,a=1/0){const u=r.range;if(!u)return 0;const h=Math.min(a,Math.max(i,s)),p=Math.log(h/1024)/Math.LN2;return de(u[0]+p,u[1]+p,e)}const Ka=1/4e4;function f_(r,e){const i=Q(e.lat,-85.051129,Oe),s=new V(e.lng-180*Ka,i),a=new V(e.lng+180*Ka,i),u=r.project(s.lng,i),h=r.project(a.lng,i),p=ue.fromLngLat(s),_=ue.fromLngLat(a),g=h.x-u.x,x=h.y-u.y,b=_.x-p.x,w=_.y-p.y,E=Math.sqrt((b*b+w*w)/(g*g+x*x));return Math.log(E)/Math.LN2}function hx(r,e,i){const s=Math.cos(i),a=Math.sin(i);return{x:r*s-e*a,y:r*a+e*s}}function dx(r,e,i){re(r),Ye(r,r,wi(e[2])),nt(r,r,wi(e[0])),$e(r,r,wi(e[1])),vt(r,r,i),at(r,r,[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1])}function pp(r,e,i,s,a,u,h,p){const _=[i[0]-e[0],i[1]-e[1],0],g=[s[0]-e[0],s[1]-e[1],0];if(Rr(_)<1e-12||Rr(g)<1e-12)return Xs(r);const x=$i([],_,g);mr(x,x),Or(g,s,e),_[2]=(u-a)*p,g[2]=(h-a)*p;const b=_;return $i(b,_,g),mr(b,b),aa(r,x,b)}function p_(r,e,i=!1){const s=Ha(e.zoom),a=function(u,h,p){const _=h.worldSize,g=[u[12],u[13],u[14]],x=ye(g[1]/_),b=se(g[0]/_),w=re([]),E=ie(1,x)*_,A=ie(1,0)*_*Ze(x,h.zoom),P=1/bm(_);let L=A*P;if(p){const R=fp(h.projection,h.zoom,h.width,h.height,1024);L=P*h.projection.pixelSpaceConversion(h.center.lat,_,R)}const k=z(x,b);zr(k,k,rr([],mr([],k),E*L*g[2]));const j=function(R){const N=[R[0],R[1],R[2]];let q=[0,1,0];const Z=$i([],q,N);return $i(q,N,Z),Ts(q)===0&&(q=[0,1,0],$i(Z,N,q)),mr(Z,Z),mr(q,q),mr(N,N),[Z[0],Z[1],Z[2],0,q[0],q[1],q[2],0,N[0],N[1],N[2],0,R[0],R[1],R[2],1]}(k);vt(w,w,[L,L,L*E]),It(w,w,[-g[0],-g[1],-g[2]]);const G=at([],h.globeMatrix,j);return at(G,G,w),at(G,G,u),G}(r,e,i);if(s>0){const u=function(h,p){const _=p.worldSize,g=ie(1,0)*_*Ze(p.center.lat,p.zoom)/bm(_),x=ie(1,p.center.lat)*_,b=re([]);return $e(b,b,wi(p.center.lng)),nt(b,b,wi(p.center.lat)),It(b,b,[0,0,m]),vt(b,b,[g,g,g*x]),It(b,b,[p.point.x-.5*_,p.point.y-.5*_,0]),at(b,b,h),at(b,p.globeMatrix,b)}(r,e);return function(h,p,_){const g=(A,P,L)=>{const k=Rr(A),j=Rr(P),G=ia(A,P,L);return rr(G,G,1/Rr(G)*Ut(k,j,L))},x=g([h[0],h[1],h[2]],[p[0],p[1],p[2]],_),b=g([h[4],h[5],h[6]],[p[4],p[5],p[6]],_),w=g([h[8],h[9],h[10]],[p[8],p[9],p[10]],_),E=ia([h[12],h[13],h[14]],[p[12],p[13],p[14]],_);return[x[0],x[1],x[2],0,b[0],b[1],b[2],0,w[0],w[1],w[2],0,E[0],E[1],E[2],1]}(a,u,s)}return a}function fx(r,e,i,s){const a=Ti.projectAabbCorners(s,i);let u=Number.MAX_VALUE,h=-1;for(let g=0;g<a.length;++g){const x=a[g];x[0]=(.5*x[0]+.5)*e.width,x[1]=(.5-.5*x[1])*e.height,x[2]<u&&(h=g,u=x[2])}const p=g=>new ut(a[g][0],a[g][1]);let _;switch(h){case 0:case 6:_=[p(1),p(5),p(4),p(7),p(3),p(2),p(1)];break;case 1:case 7:_=[p(0),p(4),p(5),p(6),p(2),p(3),p(0)];break;case 3:case 5:_=[p(1),p(0),p(4),p(7),p(6),p(2),p(1)];break;default:_=[p(1),p(5),p(6),p(7),p(3),p(0),p(1)]}if(Cn(r,_))return u}const _w=bi([{name:"a_pos_3f",components:3,type:"Float32"}]),gw=bi([{name:"a_color_3f",components:3,type:"Float32"}]),yw=bi([{name:"a_color_4f",components:4,type:"Float32"}]),vw=bi([{name:"a_uv_2f",components:2,type:"Float32"}]),xw=bi([{name:"a_normal_3f",components:3,type:"Float32"}]),bw=bi([{name:"a_normal_matrix0",components:4,type:"Float32"},{name:"a_normal_matrix1",components:4,type:"Float32"},{name:"a_normal_matrix2",components:4,type:"Float32"},{name:"a_normal_matrix3",components:4,type:"Float32"}]),ww=bi([{name:"a_pbr",components:4,type:"Uint16"},{name:"a_heightBasedEmissiveStrength",components:3,type:"Float32"}]),px={None:0,Model:1,Symbol:2,FillExtrusion:4};class mp{constructor(e,i,s,a){this.message=(e?`${e}: `:"")+s,a&&(this.identifier=a),i!=null&&i.__line__&&(this.line=i.__line__)}}function m_(r,e){const i=r.indexOf("://")===-1;try{return new URL(r,i&&e?"http://example.com":void 0),!0}catch{return!1}}class mx{constructor(e,i){this.feature=e,this.instancedDataOffset=i,this.instancedDataCount=0,this.rotation=[0,0,0],this.scale=[1,1,1],this.translation=[0,0,0]}}class _x{constructor(){this.instancedDataArray=new Va,this.instancesEvaluatedElevation=[],this.features=[],this.idToFeaturesIndex={}}}class __{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.projection=e.projection,this.index=e.index,this.worldview=e.worldview,this.hasZoomDependentProperties=this.layers[0].isZoomDependent(),this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.hasPattern=!1,this.instancesPerModel={},this.validForExaggeration=0,this.maxVerticalOffset=0,this.maxScale=0,this.maxHeight=0,this.lookupDim=this.zoom>this.canonical.z?256:this.zoom>15?75:100,this.instanceCount=0,this.terrainElevationMin=0,this.terrainElevationMax=0,this.validForDEMTile={id:null,timestamp:0},this.modelUris=[],this.modelsRequested=!1,this.activeReplacements=[],this.replacementUpdateTime=0,this.styleDefinedModelURLs=e.styleDefinedModelURLs}updateFootprints(e,i){}populate(e,i,s,a){this.tileToMeter=Pe(s);const u=this.layers[0]._featureFilter.needGeometry;this.lookup=new Uint8Array(this.lookupDim*this.lookupDim);for(const{feature:h,id:p,index:_,sourceLayerIndex:g}of e){const x=p??(h.properties&&h.properties.hasOwnProperty("id")?h.properties.id:void 0),b=gt(h,u);if(!this.layers[0]._featureFilter.filter(new Gi(this.zoom,{worldview:this.worldview}),b,s))continue;const w={id:x,sourceLayerIndex:g,index:_,geometry:u?b.geometry:Tt(h,s,a),properties:h.properties,type:h.type,patterns:{}},E=this.addFeature(w,w.geometry,b);E&&i.featureIndex.insert(h,w.geometry,_,g,this.index,this.instancesPerModel[E].instancedDataArray.length,dt/32)}this.lookup=null}update(e,i,s,a){for(const u in this.instancesPerModel){const h=this.instancesPerModel[u];for(const p in e)h.idToFeaturesIndex.hasOwnProperty(p)&&(this.evaluate(h.features[h.idToFeaturesIndex[p]],e[p],h,!0),this.uploaded=!1)}this.maxHeight=0}updateZoomBasedPaintProperties(){if(!this.hasZoomDependentProperties)return!1;let e=!1;for(const i in this.instancesPerModel){const s=this.instancesPerModel[i];for(const a of s.features){const u=this.layers[0],h=a.feature,p=this.canonical,_=u.paint.get("model-rotation").evaluate(h,{},p),g=u.paint.get("model-scale").evaluate(h,{},p),x=u.paint.get("model-translation").evaluate(h,{},p);rs(a.rotation,_)&&rs(a.scale,g)&&rs(a.translation,x)||(this.evaluate(a,a.featureStates,s,!0),e=!0)}}return e}updateReplacement(e,i,s,a){if(i.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=i.updateTime;const u=i.getReplacementRegionsForTile(e.toUnwrapped(),!0);if(Lm(this.activeReplacements,u))return!1;this.activeReplacements=u;let h=!1;for(const p in this.instancesPerModel){const _=this.instancesPerModel[p],g=_.instancedDataArray;for(const x of _.features){const b=x.instancedDataOffset,w=x.instancedDataCount;for(let E=0;E<w;E++){const A=16*(E+b);let P=g.float32[A+0];const L=P>dt;P=L?P-dt:P;const k=Math.floor(P),j=g.float32[A+1];let G=!1;for(const R of this.activeReplacements)if(!ly(R,s,px.Model,a)&&!(R.min.x>k||k>R.max.x||R.min.y>j||j>R.max.y)&&(G=py(fy(k,j,e.canonical,R.footprintTileId.canonical),R.footprint),G))break;g.float32[A]=G?P+dt:P,h=h||G!==L}}}return h}isEmpty(){for(const e in this.instancesPerModel)if(this.instancesPerModel[e].instancedDataArray.length!==0)return!1;return!0}uploadPending(){return!this.uploaded}upload(e){if(!this.uploaded)for(const i in this.instancesPerModel){const s=this.instancesPerModel[i];s.instancedDataArray.length<0||s.instancedDataArray.length===0||(s.instancedDataBuffer?s.instancedDataBuffer.updateData(s.instancedDataArray):s.instancedDataBuffer=e.createVertexBuffer(s.instancedDataArray,bw.members,!0,void 0,this.instanceCount))}this.uploaded=!0}destroy(){for(const i in this.instancesPerModel){const s=this.instancesPerModel[i];s.instancedDataArray.length!==0&&s.instancedDataBuffer&&s.instancedDataBuffer.destroy()}const e=this.layers[0].modelManager;if(e&&this.modelUris&&this.modelsRequested)for(const i of this.modelUris)e.removeModel(i,"",!0)}addFeature(e,i,s){const a=this.layers[0],u=a.layout.get("model-id").evaluate(s,{},this.canonical);if(!u)return ei(`modelId is not evaluated for layer ${a.id} and it is not going to get rendered.`),u;(m_(u,!1)||this.styleDefinedModelURLs[u]!==void 0)&&(this.modelUris.includes(u)||this.modelUris.push(u)),this.instancesPerModel[u]||(this.instancesPerModel[u]=new _x);const h=this.instancesPerModel[u],p=h.instancedDataArray,_=new mx(s,p.length);for(const g of i)for(const x of g){if(x.x<0||x.x>=dt||x.y<0||x.y>=dt)continue;const b=(this.lookupDim-1)/dt,w=this.lookupDim*(x.y*b|0)+x.x*b|0;if(this.lookup){if(this.lookup[w]!==0)continue;this.lookup[w]=1}this.instanceCount++;const E=p.length;p.resize(E+1),h.instancesEvaluatedElevation.push(0),p.float32[16*E]=x.x,p.float32[16*E+1]=x.y}return _.instancedDataCount=h.instancedDataArray.length-_.instancedDataOffset,_.instancedDataCount>0&&(e.id&&(h.idToFeaturesIndex[e.id]=h.features.length),h.features.push(_),this.evaluate(_,{},h,!1)),u}getModelUris(){return this.modelUris}evaluate(e,i,s,a){const u=this.layers[0],h=e.feature,p=this.canonical,_=e.rotation=u.paint.get("model-rotation").evaluate(h,i,p),g=e.scale=u.paint.get("model-scale").evaluate(h,i,p),x=e.translation=u.paint.get("model-translation").evaluate(h,i,p),b=u.paint.get("model-color").evaluate(h,i,p);b.a=u.paint.get("model-color-mix-intensity").evaluate(h,i,p);const w=[];this.maxVerticalOffset<x[2]&&(this.maxVerticalOffset=x[2]),this.maxScale=Math.max(Math.max(this.maxScale,g[0]),Math.max(g[1],g[2])),dx(w,_,g);const E=Math.round(100*b.a)+b.b/1.05;for(let A=0;A<e.instancedDataCount;++A){const P=e.instancedDataOffset+A,L=16*P,k=s.instancedDataArray.float32;let j=0;a&&(j=k[L+6]-s.instancesEvaluatedElevation[P]);const G=0|k[L+1];k[L]=(0|k[L])+b.r/1.05,k[L+1]=G+b.g/1.05,k[L+2]=E,k[L+3]=1/(p.z>10?this.tileToMeter:Pe(p,G)),k[L+4]=x[0],k[L+5]=x[1],k[L+6]=x[2]+j,k[L+7]=w[0],k[L+8]=w[1],k[L+9]=w[2],k[L+10]=w[4],k[L+11]=w[5],k[L+12]=w[6],k[L+13]=w[8],k[L+14]=w[9],k[L+15]=w[10],s.instancesEvaluatedElevation[P]=x[2]}}}let gx,yx;bt(__,"ModelBucket",{omit:["layers"]}),bt(_x,"PerModelAttributes"),bt(mx,"ModelFeature");const lc=64,Eu={CoordinateSpaceTile:1,HasMapboxMeshFeatures:4,HasMeshoptCompression:8};function vx(r,e,i,s,a,u,h,p,_,g=!1){const x=i.zoom,b=i.project(s),w=Ze(s.lat,x),E=1/w;re(r),It(r,r,[b.x+h[0]*E,b.y+h[1]*E,h[2]]);let A=1,P=1;const L=i.worldSize;if(g){if(i.projection.name==="mercator"){let R=0;i.elevation&&(R=i.elevation.getAtPointOrZero(new ue(b.x/L,b.y/L),0));const N=_n([],[b.x,b.y,R,1],i.projMatrix)[3]/i.cameraToCenterDistance;A=N,P=N*Ze(i.center.lat,x)}else if(i.projection.name==="globe"){const R=p_(r,i),N=[0,0,0,1];_n(N,N,at([],i.projMatrix,R));const q=N[3]/i.cameraToCenterDistance,Z=Ha(x),ae=i.projection.pixelsPerMeter(s.lat,L)*Ze(s.lat,x),ne=i.projection.pixelsPerMeter(i.center.lat,L)*Ze(i.center.lat,x);A=q/Ut(ae,ke(i.center.lat),Z),P=q*w/ae,A*=ne,P*=ne}}else A=E;vt(r,r,[A,A,P]);const k=[...r],j=e.orientation,G=[];if(dx(G,[j[0]+a[0],j[1]+a[1],j[2]+a[2]],u),at(r,k,G),p&&i.elevation){let R=0;const N=[];if(_&&i.elevation){R=function(Z,ae,ne,ce,me){const Re=ae.elevation;if(!Re)return 0;const Xe=Ti.projectAabbCorners(ne,ce),Ve=ie(1,me.lat)*ae.worldSize,We=function(Qe,Xt){const Et=[0,0,1],Mt=[{corners:[0,1,3,2],dotProductWithUp:0},{corners:[1,5,2,6],dotProductWithUp:0},{corners:[0,4,1,5],dotProductWithUp:0},{corners:[2,6,3,7],dotProductWithUp:0},{corners:[4,7,5,6],dotProductWithUp:0},{corners:[0,3,4,7],dotProductWithUp:0}];for(const jt of Mt){const Qt=Qe[jt.corners[0]],Jt=Qe[jt.corners[1]],ai=Qe[jt.corners[2]],ii=[Jt[0]-Qt[0],Jt[1]-Qt[1],Xt*(Jt[2]-Qt[2])],li=$i(ii,ii,[ai[0]-Qt[0],ai[1]-Qt[1],Xt*(ai[2]-Qt[2])]);mr(li,li),jt.dotProductWithUp=Ar(li,Et)}return Mt.sort((jt,Qt)=>jt.dotProductWithUp-Qt.dotProductWithUp),Mt[0].corners}(Xe,Ve),Ke=Xe[We[0]],Le=Xe[We[1]],He=Xe[We[2]],Me=Xe[We[3]],ze=Re.getAtPointOrZero(new ue(Ke[0]/ae.worldSize,Ke[1]/ae.worldSize),0),et=Re.getAtPointOrZero(new ue(Le[0]/ae.worldSize,Le[1]/ae.worldSize),0),it=Re.getAtPointOrZero(new ue(He[0]/ae.worldSize,He[1]/ae.worldSize),0),Ot=Re.getAtPointOrZero(new ue(Me[0]/ae.worldSize,Me[1]/ae.worldSize),0),At=(ze+Ot)/2,pt=(et+it)/2;return At>pt?et<it?pp(Z,Le,Me,Ke,et,Ot,ze,Ve):pp(Z,He,Ke,Me,it,ze,Ot,Ve):ze<Ot?pp(Z,Ke,Le,He,ze,et,it,Ve):pp(Z,Me,He,Le,Ot,it,et,Ve),Math.max(At,pt)}(N,i,e.aabb,r,s);const q=at([],gi([],N),G);at(r,k,q)}else R=i.elevation.getAtPointOrZero(new ue(b.x/L,b.y/L),0);R!==0&&(r[14]+=R)}}function md(r,e,i=!1){r.uploaded||(r.gfxTexture=new h_(e,r.image,i?e.gl.R8:e.gl.RGBA8,{useMipmap:r.sampler.minFilter>=e.gl.NEAREST_MIPMAP_NEAREST}),r.uploaded=!0,r.image=null)}function Tw(r,e,i){r.indexBuffer=e.createIndexBuffer(r.indexArray,!1,!0),r.vertexBuffer=e.createVertexBuffer(r.vertexArray,_w.members,!1,!0),r.normalArray&&(r.normalBuffer=e.createVertexBuffer(r.normalArray,xw.members,!1,!0)),r.texcoordArray&&(r.texcoordBuffer=e.createVertexBuffer(r.texcoordArray,vw.members,!1,!0)),r.colorArray&&(r.colorBuffer=e.createVertexBuffer(r.colorArray,(r.colorArray.bytesPerElement===12?gw:yw).members,!1,!0)),r.featureArray&&(r.pbrBuffer=e.createVertexBuffer(r.featureArray,ww.members,!0)),r.segments=Tr.simpleSegment(0,0,r.vertexArray.length,r.indexArray.length);const s=r.material;s.pbrMetallicRoughness.baseColorTexture&&md(s.pbrMetallicRoughness.baseColorTexture,e),s.pbrMetallicRoughness.metallicRoughnessTexture&&md(s.pbrMetallicRoughness.metallicRoughnessTexture,e),s.normalTexture&&md(s.normalTexture,e),s.occlusionTexture&&md(s.occlusionTexture,e,i),s.emissionTexture&&md(s.emissionTexture,e)}function g_(r,e,i){if(r.meshes)for(const s of r.meshes)Tw(s,e,i);if(r.children)for(const s of r.children)g_(s,e,i)}function _p(r){if(r.meshes)for(const e of r.meshes)e.indexArray.destroy(),e.vertexArray.destroy(),e.colorArray&&e.colorArray.destroy(),e.normalArray&&e.normalArray.destroy(),e.texcoordArray&&e.texcoordArray.destroy(),e.featureArray&&e.featureArray.destroy();if(r.children)for(const e of r.children)_p(e)}function y_(r){if(r.meshes)for(const i of r.meshes)i.vertexBuffer&&(i.vertexBuffer.destroy(),i.indexBuffer.destroy(),i.normalBuffer&&i.normalBuffer.destroy(),i.texcoordBuffer&&i.texcoordBuffer.destroy(),i.colorBuffer&&i.colorBuffer.destroy(),i.pbrBuffer&&i.pbrBuffer.destroy(),i.segments.destroy(),i.material&&((e=i.material).pbrMetallicRoughness.baseColorTexture&&e.pbrMetallicRoughness.baseColorTexture.gfxTexture&&e.pbrMetallicRoughness.baseColorTexture.gfxTexture.destroy(),e.pbrMetallicRoughness.metallicRoughnessTexture&&e.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture&&e.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture.destroy(),e.normalTexture&&e.normalTexture.gfxTexture&&e.normalTexture.gfxTexture.destroy(),e.emissionTexture&&e.emissionTexture.gfxTexture&&e.emissionTexture.gfxTexture.destroy(),e.occlusionTexture&&e.occlusionTexture.gfxTexture&&e.occlusionTexture.gfxTexture.destroy()));var e;if(r.children)for(const i of r.children)y_(i)}class Iu{constructor(e,i,s){this._demTile=e,this._dem=this._demTile.dem,this._scale=i,this._offset=s}static create(e,i,s){const a=s||e.findDEMTileFor(i);if(!a||!a.dem)return;const u=a.dem,h=a.tileID,p=1<<i.canonical.z-h.canonical.z;return new Iu(a,u.dim/dt/p,[(i.canonical.x/p-h.canonical.x)*u.dim,(i.canonical.y/p-h.canonical.y)*u.dim])}tileCoordToPixel(e,i){const s=i*this._scale+this._offset[1],a=Math.floor(e*this._scale+this._offset[0]),u=Math.floor(s);return new ut(a,u)}getElevationAt(e,i,s,a){const u=e*this._scale+this._offset[0],h=i*this._scale+this._offset[1],p=Math.floor(u),_=Math.floor(h),g=this._dem;return a=!!a,s?Ut(Ut(g.get(p,_,a),g.get(p,_+1,a),h-_),Ut(g.get(p+1,_,a),g.get(p+1,_+1,a),h-_),u-p):g.get(p,_,a)}getElevationAtPixel(e,i,s){return this._dem.get(e,i,!!s)}getMeterToDEM(e){return(1<<this._demTile.tileID.canonical.z)*ie(1,e)*this._dem.stride}}const v_=new Float32Array(262144),cc=new Uint8Array(262144);function xx(r){let e=0;if(r.meshes)for(const i of r.meshes)e=Math.max(e,i.aabb.max[2]);if(r.children)for(const i of r.children)e=Math.max(e,xx(i));return e}function bx(r,e,i){if(r.meshes)for(const s of r.meshes){if(s.aabb.min[0]===1/0)continue;const a=Ti.applyTransform(s.aabb,r.matrix);i.insert(e,a.min[0],a.min[1],a.max[0],a.max[1])}if(r.children)for(const s of r.children)bx(s,e,i)}const wx=["","wall","door","roof","window","lamp","logo"];class Tx{constructor(e){this.node=e,this.evaluatedRMEA=[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[.4,1,0,1],[1,0,0,1],[1,0,0,1]],this.hiddenByReplacement=!1,this.evaluatedTranslation=[0,0,0],this.evaluatedScale=[1,1,1],this.evaluatedColor=[],this.emissionHeightBasedParams=[],this.cameraCollisionOpacity=1,this.feature={type:"Point",id:e.id,geometry:[],properties:{height:xx(e)}},this.aabb=this._getLocalBounds(),this.state=null}_getLocalBounds(){if(!this.node.meshes)return new Ti([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);if(!this.aabb){let e=0;const i=new Ti([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(const s of this.node.meshes)this.node.lightMeshIndex!==e&&(s.transformedAabb=Ti.applyTransformFast(s.aabb,this.node.matrix),i.encapsulate(s.transformedAabb)),e++;this.aabb=i}return this.aabb}}class gp{constructor(e,i,s,a,u,h,p,_){this.id=s,this.layers=e,this.layerIds=this.layers.map(g=>g.fqid),this.stateDependentLayerIds=this.layers.filter(g=>g.isStateDependent()).map(g=>g.id),this.modelTraits|=Eu.CoordinateSpaceTile,this.uploaded=!1,this.hasPattern=!1,a&&(this.modelTraits|=Eu.HasMapboxMeshFeatures),u&&(this.modelTraits|=Eu.HasMeshoptCompression),this.zoom=-1,this.terrainExaggeration=1,this.projection={name:"mercator"},this.replacementUpdateTime=0,this.elevationReadFromZ=255,this.brightness=h,this.worldview=_,this.dirty=!0,this.needsUpload=!1,this.filter=null,this.nodesInfo=[];for(const g of i)this.nodesInfo.push(new Tx(g)),bx(g,p.featureIndexArray.length,p.grid),p.featureIndexArray.emplaceBack(this.nodesInfo.length-1,0,p.bucketLayerIDs.length-1,0);this.states={}}updateFootprints(e,i){for(const s of this.getNodesInfo()){const a=s.node;a.footprint&&i.push({footprint:a.footprint,id:e})}}update(e){const i=Object.keys(e).length!==0;if(i&&!this.stateDependentLayers.length)return;const s=i?this.stateDependentLayers:this.layers;if(!As(e,this.states))for(const a of s)this.evaluate(a,e);this.states=structuredClone(e)}populate(){console.log("populate 3D model bucket")}uploadPending(){return!this.uploaded||this.needsUpload}upload(e){if(!this.needsUpload)return;const i=this.getNodesInfo();for(const s of i){const a=s.node;this.uploaded?this.updatePbrBuffer(a):g_(a,e,!0)}for(const s of i)_p(s.node);this.uploaded=!0,this.needsUpload=!1}updatePbrBuffer(e){let i=!1;if(!e.meshes)return i;for(const s of e.meshes)s.pbrBuffer&&(s.pbrBuffer.updateData(s.featureArray),i=!0);return i}needsReEvaluation(e,i,s){const a=e.transform.projectionOptions,u=e.style.getBrightness(),h=this.brightness!==u;if(!this.uploaded||this.dirty||a.name!==this.projection.name||_d(s.paint.get("model-color").value,h)||_d(s.paint.get("model-color-mix-intensity").value,h)||_d(s.paint.get("model-roughness").value,h)||_d(s.paint.get("model-emissive-strength").value,h)||_d(s.paint.get("model-height-based-emissive-strength-multiplier").value,h)){this.projection=a,this.brightness=u;const p=this.getNodesInfo();for(const _ of p)_.state=null;return!0}return!1}evaluateTransform(e,i){if(e.transform.zoom===this.zoom)return;this.zoom=e.transform.zoom;const s=this.getNodesInfo(),a=this.id.canonical;for(const u of s){const h=u.feature;u.evaluatedTranslation=i.paint.get("model-translation").evaluate(h,{},a),u.evaluatedScale=i.paint.get("model-scale").evaluate(h,{},a)}}evaluate(e,i){const s=this.getNodesInfo();for(const a of s){if(!a.node.meshes)continue;const u=a.feature,h=i&&i[u.id];if(As(h,a.state))continue;a.state=structuredClone(h);const p=a.node.meshes&&a.node.meshes[0].featureData,_=a.evaluatedColor[2],g=a.evaluatedRMEA[2],x=this.id.canonical;if(a.hasTranslucentParts=!1,p){for(let b=0;b<wx.length;b++){const w=wx[b];w.length&&(u.properties.part=w);const E=e.paint.get("model-color").evaluate(u,h,x).toPremultipliedRenderColor(null),A=e.paint.get("model-color-mix-intensity").evaluate(u,h,x);a.evaluatedColor[b]=[E.r,E.g,E.b,A],a.evaluatedRMEA[b][0]=e.paint.get("model-roughness").evaluate(u,h,x),a.evaluatedRMEA[b][2]=e.paint.get("model-emissive-strength").evaluate(u,h,x),a.evaluatedRMEA[b][3]=E.a,a.emissionHeightBasedParams[b]=e.paint.get("model-height-based-emissive-strength-multiplier").evaluate(u,h,x),!a.hasTranslucentParts&&E.a<1&&(a.hasTranslucentParts=!0)}delete u.properties.part,Ew(a,_!==a.evaluatedColor[2]||g!==a.evaluatedRMEA[2],this.modelTraits)}else a.evaluatedRMEA[0][2]=e.paint.get("model-emissive-strength").evaluate(u,h,x);a.evaluatedTranslation=e.paint.get("model-translation").evaluate(u,h,x),a.evaluatedScale=e.paint.get("model-scale").evaluate(u,h,x),this.updatePbrBuffer(a.node)||(this.needsUpload=!0)}this.dirty=!1}elevationUpdate(e,i,s,a){const u=e.findDEMTileFor(s);if(u&&(u.tileID.canonical!==this.terrainTile||i!==this.terrainExaggeration)){if(u.dem&&u.tileID.overscaledZ!==this.elevationReadFromZ){this.elevationReadFromZ=u.tileID.overscaledZ;const h=Iu.create(e,s,u);if(!h)return;this.modelTraits&Eu.HasMapboxMeshFeatures&&this.updateDEM(e,h,s,a);for(const p of this.getNodesInfo()){const _=p.node;if(!_.footprint||!_.footprint.vertices||!_.footprint.vertices.length)continue;const g=_.footprint.vertices;let x=h.getElevationAt(g[0].x,g[0].y,!0,!0);for(let b=1;b<g.length;b++)x=Math.min(x,h.getElevationAt(g[b].x,g[b].y,!0,!0));_.elevation=x}}this.terrainTile=u.tileID.canonical,this.terrainExaggeration=i}}updateDEM(e,i,s,a){let u=i._dem._modifiedForSources[a];if(u===void 0&&(i._dem._modifiedForSources[a]=[],u=i._dem._modifiedForSources[a]),u.includes(s.canonical))return;const h=i._dem.dim;u.push(s.canonical);let p=!1;for(const _ of this.getNodesInfo()){const g=_.node;if(!g.footprint||!g.footprint.grid)continue;const x=g.footprint.grid,b=i.tileCoordToPixel(x.min.x,x.min.y),w=i.tileCoordToPixel(x.max.x,x.max.y),E=Math.min(Math.min(h-w.y,b.x),Math.min(b.y,h-w.x));if(E<0)continue;const A=Q(E,2,5);let P=Math.max(0,b.x-A),L=Math.max(0,b.y-A),k=Math.min(w.x+A,h-1),j=Math.min(w.y+A,h-1);for(let q=L;q<=j;++q)for(let Z=P;Z<=k;++Z)cc[q*h+Z]=255;let G=0,R=0;for(let q=0;q<x.cellsY;++q)for(let Z=0;Z<x.cellsX;++Z){if(!x.cells[q*x.cellsX+Z])continue;const ae=i.tileCoordToPixel(x.min.x+Z/x.xScale,x.min.y+q/x.yScale),ne=i.tileCoordToPixel(x.min.x+(Z+1)/x.xScale,x.min.y+(q+1)/x.yScale);for(let ce=ae.y;ce<=Math.min(ne.y+1,h-1);++ce)for(let me=ae.x;me<=Math.min(ne.x+1,h-1);++me)cc[ce*h+me]===255&&(cc[ce*h+me]=0,G+=i.getElevationAtPixel(me,ce),R++)}const N=G/R;P=Math.max(1,b.x-A),L=Math.max(1,b.y-A),k=Math.min(w.x+A,h-2),j=Math.min(w.y+A,h-2),p=!0;for(let q=L;q<=j;++q)for(let Z=P;Z<=k;++Z)cc[q*h+Z]===0&&(v_[q*h+Z]=i._dem.set(Z,q,N));for(let q=1;q<A;++q){P=Math.max(1,b.x-q),L=Math.max(1,b.y-q),k=Math.min(w.x+q,h-2),j=Math.min(w.y+q,h-2);for(let Z=L;Z<=j;++Z)for(let ae=P;ae<=k;++ae){const ne=Z*h+ae;if(cc[ne]===255){let ce=0,me=0,Re=-1,Xe=-1;for(let Ve=-1;Ve<=1;++Ve)for(let We=-1;We<=1;++We){const Ke=(Z+Ve)*h+ae+We;if(cc[Ke]>=q)continue;const Le=v_[Ke],He=Math.abs(Le);He>me&&(ce=Le,me=He,Re=We,Xe=Ve)}if(me>.1){const Ve=1-(q+.5*Math.abs(Re*Xe))/A;let We=i._dem.get(ae,Z)+ce*Ve;const Ke=i._dem.get(ae+Re,Z+Xe),Le=i._dem.get(ae-Re,Z-Xe,!0);(We-Ke)*(We-Le)>0&&(We=(Ke+Le)/2),v_[ne]=i._dem.set(ae,Z,We),cc[ne]=q}}}}}p&&(i._demTile.needsDEMTextureUpload=!0,i._dem._timestamp=ns.now())}setFilter(e){this.filter=e?wh(e):null}getNodesInfo(){return this.filter?this.nodesInfo.filter(e=>this.filter.filter(new Gi(this.id.overscaledZ,{worldview:this.worldview}),e.feature,this.id.canonical)):this.nodesInfo}destroy(){const e=this.getNodesInfo();for(const i of e)_p(i.node),y_(i.node)}isEmpty(){return!this.nodesInfo.length}updateReplacement(e,i){if(i.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=i.updateTime;const s=i.getReplacementRegionsForTile(e.toUnwrapped());for(const a of this.getNodesInfo()){const u=a.node.footprint;a.hiddenByReplacement=!!u&&!s.find(h=>h.footprint===u)}}getHeightAtTileCoord(e,i){const s=[],a=[0,0,0],u=re([]);for(const h of this.getNodesInfo()){const p=h.node.meshes[0],_=p.transformedAabb;if(e<_.min[0]||i<_.min[1]||e>_.max[0]||i>_.max[1])continue;if(h.node.hidden===!0)return{height:1/0,maxHeight:h.feature.properties.height,hidden:!1,verticalScale:h.evaluatedScale[2]};Ge(u,h.node.matrix),a[0]=e,a[1]=i,ji(a,a,u);const g=(a[0]-p.aabb.min[0])/(p.aabb.max[0]-p.aabb.min[0])*lc|0,x=Math.min(63,(a[1]-p.aabb.min[1])/(p.aabb.max[1]-p.aabb.min[1])*lc|0)*lc+Math.min(63,g),b=p.heightmap[x];if(!(b<0&&h.node.footprint))return h.hiddenByReplacement?void 0:{height:b,maxHeight:h.feature.properties.height,hidden:!1,verticalScale:h.evaluatedScale[2]};if(h.node.footprint.grid.query(new ut(e,i),new ut(e,i),s),s.length>0)return{height:void 0,maxHeight:h.feature.properties.height,hidden:h.hiddenByReplacement,verticalScale:h.evaluatedScale[2]}}}}function _d(r,e){return r instanceof Ol&&!r.isLightConstant&&e}function Sw(r,e,i,s,a,u,h,p){let _=(61440&e|(61440&e)>>4)>>8,g=(3840&e|(3840&e)>>4)>>4,x=240&e|(240&e)>>4;i[3]>0&&(_=Ut(_,255*i[0],i[3]),g=Ut(g,255*i[1],i[3]),x=Ut(x,255*i[2],i[3]));const b=_<<8|g,w=x<<8|Math.floor(255*s[3]),E=function(q){const Z=Q(q,0,2);return Math.min(Math.round(.5*Z*255),255)}(s[2])<<8|15*s[0]<<4|15*s[1],A=Q(a[0],0,1),P=Q(a[1],0,1),L=Q(a[2],0,1),k=Q(a[3],0,1);let j,G,R,N;if(A!==P&&h!==u&&P!==A){const q=h-u;G=1/(q*(P-A)),R=-(u+q*A)/(q*(P-A));const Z=Q(a[4],-1,1);N=Math.pow(10,Z),j=255*L<<8|255*k}else j=65535,G=0,R=1,N=1;if(r.emplaceBack(b,w,E,j,G,R,N),p){const q=p.length;p.clear();for(let Z=0;Z<q;Z++)p.emplaceBack(b,w,E,j,G,R,N)}}function Ew(r,e,i){const s=r.node;let a=0;const u=i&Eu.HasMeshoptCompression;for(const h of s.meshes){if(s.lights&&s.lightMeshIndex===a||!h.featureData)continue;h.featureArray=new Zl,h.featureArray.reserve(h.featureData.length);let p=e;for(const _ of h.featureData){const g=u?65535&_:_>>16&65535,x=u?_>>16&65535:65535&_,b=(15&x)<8?15&x:0,w=r.evaluatedRMEA[b],E=r.evaluatedColor[b],A=r.emissionHeightBasedParams[b];let P;if(p&&b===2&&s.lights&&(P=new Zl,P.resize(10*s.lights.length)),Sw(h.featureArray,g,E,w,A,h.aabb.min[2],h.aabb.max[2],P),P&&p){p=!1;const L=s.meshes[s.lightMeshIndex];L.featureArray=P,L.featureArray._trim()}}h.featureArray._trim(),a++}}function Sx(r,e,i,s){const a=1<<r.z;e.lat=ye((s/dt+r.y)/a),e.lng=se((i/dt+r.x)/a)}function Iw(r,e,i,s){const a=r.getNodesInfo()[e];if(!a||a.hiddenByReplacement||!a.node.meshes)return;let u=Number.MAX_VALUE;const h=a.node,p=i.tile,_=s.calculatePosMatrix(p.tileID.toUnwrapped(),s.worldSize),g=a.evaluatedScale;let x=0;s.elevation&&h.elevation&&(x=h.elevation*s.elevation.exaggeration()),It(_,_,[(h.anchor?h.anchor[0]:0)*(g[0]-1),(h.anchor?h.anchor[1]:0)*(g[1]-1),x]),vt(_,_,g);const b=i.queryGeometry,w=b.isPointQuery()?b.screenBounds:b.screenGeometry,E=function(P){const L=at([],_,P.matrix);at(L,s.expandedFarZProjMatrix,L);for(let k=0;k<P.meshes.length;++k){const j=P.meshes[k];if(k===P.lightMeshIndex)continue;const G=fx(w,s,L,j.aabb);G!=null&&(u=Math.min(G,u))}if(P.children)for(const k of P.children)E(k)};if(E(h),u===Number.MAX_VALUE)return;const A=new V(0,0);return Sx(p.tileID.canonical,A,a.node.anchor[0],a.node.anchor[1]),{intersectionZ:u,position:A,feature:a.feature}}bt(gp,"Tiled3dModelBucket",{omit:["layers"]}),bt(Tx,"Tiled3dModelFeature");const Aw={circle:class extends hn{constructor(r,e,i,s){super(r,{layout:wg||(wg=new br({"circle-sort-key":new _t(ge.layout_circle["circle-sort-key"]),"circle-elevation-reference":new Je(ge.layout_circle["circle-elevation-reference"]),visibility:new Je(ge.layout_circle.visibility)})),paint:Tg||(Tg=new br({"circle-radius":new _t(ge.paint_circle["circle-radius"]),"circle-color":new _t(ge.paint_circle["circle-color"]),"circle-blur":new _t(ge.paint_circle["circle-blur"]),"circle-opacity":new _t(ge.paint_circle["circle-opacity"]),"circle-translate":new Je(ge.paint_circle["circle-translate"]),"circle-translate-anchor":new Je(ge.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new Je(ge.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new Je(ge.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new _t(ge.paint_circle["circle-stroke-width"]),"circle-stroke-color":new _t(ge.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new _t(ge.paint_circle["circle-stroke-opacity"]),"circle-emissive-strength":new Je(ge.paint_circle["circle-emissive-strength"]),"circle-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"circle-stroke-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s)}createBucket(r){return new ts(r)}queryRadius(r){const e=r;return pu("circle-radius",this,e)+pu("circle-stroke-width",this,e)+Mf(this.paint.get("circle-translate"))}queryIntersectsFeature(r,e,i,s,a,u,h,p){const _=bg(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),u.angle,r.pixelToTileUnitsFactor),g=this.paint.get("circle-radius").evaluate(e,i)+this.paint.get("circle-stroke-width").evaluate(e,i);return kg(r,s,u,h,p,this.paint.get("circle-pitch-alignment")==="map",this.paint.get("circle-pitch-scale")==="map",_,g)}getProgramIds(){return["circle"]}getDefaultProgramParams(r,e,i){const s=Og(this);return{config:new Ga(this,{zoom:e,lut:i}),defines:s,overrideFog:!1}}is3D(r){return!r&&!!this.layout&&this.layout.get("circle-elevation-reference")!=="none"}hasElevation(){return this.layout&&this.layout.get("circle-elevation-reference")!=="none"}},heatmap:class extends hn{createBucket(r){return new Bg(r)}constructor(r,e,i,s){super(r,{layout:Ng||(Ng=new br({visibility:new Je(ge.layout_heatmap.visibility)})),paint:Vg||(Vg=new br({"heatmap-radius":new _t(ge.paint_heatmap["heatmap-radius"]),"heatmap-weight":new _t(ge.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new Je(ge.paint_heatmap["heatmap-intensity"]),"heatmap-color":new Jo(ge.paint_heatmap["heatmap-color"]),"heatmap-opacity":new Je(ge.paint_heatmap["heatmap-opacity"]),"heatmap-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(r){r==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=qh({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}queryRadius(r){return pu("heatmap-radius",this,r)}queryIntersectsFeature(r,e,i,s,a,u,h,p){const _=this.paint.get("heatmap-radius").evaluate(e,i);return kg(r,s,u,h,p,!0,!0,new ut(0,0),_)}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}getProgramIds(){return["heatmap","heatmapTexture"]}getDefaultProgramParams(r,e,i){return r==="heatmap"?{config:new Ga(this,{zoom:e,lut:i}),overrideFog:!1}:{}}},hillshade:class extends hn{constructor(r,e,i,s){super(r,{layout:Ug||(Ug=new br({visibility:new Je(ge.layout_hillshade.visibility)})),paint:jg||(jg=new br({"hillshade-illumination-direction":new Je(ge.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new Je(ge.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new Je(ge.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new Je(ge.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new Je(ge.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new Je(ge.paint_hillshade["hillshade-accent-color"]),"hillshade-emissive-strength":new Je(ge.paint_hillshade["hillshade-emissive-strength"]),"hillshade-shadow-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"hillshade-highlight-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"hillshade-accent-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s)}shouldRedrape(){return this.hasOffscreenPass()&&this.paint.get("hillshade-illumination-anchor")==="viewport"}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}getProgramIds(){return["hillshade","hillshadePrepare"]}getDefaultProgramParams(r,e,i){return{overrideFog:!1}}},fill:class extends hn{constructor(r,e,i,s){super(r,{layout:ry||(ry=new br({"fill-sort-key":new _t(ge.layout_fill["fill-sort-key"]),visibility:new Je(ge.layout_fill.visibility),"fill-elevation-reference":new Je(ge.layout_fill["fill-elevation-reference"]),"fill-construct-bridge-guard-rail":new _t(ge.layout_fill["fill-construct-bridge-guard-rail"])})),paint:ny||(ny=new br({"fill-antialias":new Je(ge.paint_fill["fill-antialias"]),"fill-opacity":new _t(ge.paint_fill["fill-opacity"]),"fill-color":new _t(ge.paint_fill["fill-color"]),"fill-outline-color":new _t(ge.paint_fill["fill-outline-color"]),"fill-translate":new Je(ge.paint_fill["fill-translate"]),"fill-translate-anchor":new Je(ge.paint_fill["fill-translate-anchor"]),"fill-pattern":new _t(ge.paint_fill["fill-pattern"]),"fill-pattern-cross-fade":new Je(ge.paint_fill["fill-pattern-cross-fade"]),"fill-emissive-strength":new Je(ge.paint_fill["fill-emissive-strength"]),"fill-z-offset":new _t(ge.paint_fill["fill-z-offset"]),"fill-bridge-guard-rail-color":new _t(ge.paint_fill["fill-bridge-guard-rail-color"]),"fill-tunnel-structure-color":new _t(ge.paint_fill["fill-tunnel-structure-color"]),"fill-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"fill-outline-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"fill-bridge-guard-rail-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"fill-tunnel-structure-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s)}getProgramIds(){const r=this.paint.get("fill-pattern"),e=r&&r.constantOr(1),i=[e?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&i.push(e&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),i}getDefaultProgramParams(r,e,i){return{config:new Ga(this,{zoom:e,lut:i}),overrideFog:!1}}recalculate(r,e){super.recalculate(r,e);const i=this.paint._values["fill-outline-color"];i.value.kind==="constant"&&i.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(r){return new Pm(r)}queryRadius(){return Mf(this.paint.get("fill-translate"))}queryIntersectsFeature(r,e,i,s,a,u){return!r.queryGeometry.isAboveHorizon&&hs(xg(r.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),u.angle,r.pixelToTileUnitsFactor),s)}isTileClipped(){return this.paint.get("fill-z-offset").constantOr(1)===0}is3D(r){if(this.paint.get("fill-z-offset").constantOr(1)!==0)return!0;const e=this.layout&&this.layout.get("fill-elevation-reference")!=="none";return r!=null?e&&!r:e}hasElevation(){return this.layout&&this.layout.get("fill-elevation-reference")!=="none"}hasShadowPass(){return this.layout&&this.layout.get("fill-elevation-reference")!=="none"}},"fill-extrusion":class extends hn{constructor(r,e,i,s){super(r,{layout:My||(My=new br({visibility:new Je(ge["layout_fill-extrusion"].visibility),"fill-extrusion-edge-radius":new Je(ge["layout_fill-extrusion"]["fill-extrusion-edge-radius"])})),paint:Py||(Py=new br({"fill-extrusion-opacity":new Je(ge["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new _t(ge["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new Je(ge["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new Je(ge["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new _t(ge["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-pattern-cross-fade":new Je(ge["paint_fill-extrusion"]["fill-extrusion-pattern-cross-fade"]),"fill-extrusion-height":new _t(ge["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new _t(ge["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-height-alignment":new Je(ge["paint_fill-extrusion"]["fill-extrusion-height-alignment"]),"fill-extrusion-base-alignment":new Je(ge["paint_fill-extrusion"]["fill-extrusion-base-alignment"]),"fill-extrusion-vertical-gradient":new Je(ge["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new Je(ge["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new Je(ge["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"]),"fill-extrusion-ambient-occlusion-wall-radius":new Je(ge["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-wall-radius"]),"fill-extrusion-ambient-occlusion-ground-radius":new Je(ge["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-radius"]),"fill-extrusion-ambient-occlusion-ground-attenuation":new Je(ge["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-attenuation"]),"fill-extrusion-flood-light-color":new Je(ge["paint_fill-extrusion"]["fill-extrusion-flood-light-color"]),"fill-extrusion-flood-light-intensity":new Je(ge["paint_fill-extrusion"]["fill-extrusion-flood-light-intensity"]),"fill-extrusion-flood-light-wall-radius":new _t(ge["paint_fill-extrusion"]["fill-extrusion-flood-light-wall-radius"]),"fill-extrusion-flood-light-ground-radius":new _t(ge["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-radius"]),"fill-extrusion-flood-light-ground-attenuation":new Je(ge["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-attenuation"]),"fill-extrusion-vertical-scale":new Je(ge["paint_fill-extrusion"]["fill-extrusion-vertical-scale"]),"fill-extrusion-rounded-roof":new Je(ge["paint_fill-extrusion"]["fill-extrusion-rounded-roof"]),"fill-extrusion-cutoff-fade-range":new Je(ge["paint_fill-extrusion"]["fill-extrusion-cutoff-fade-range"]),"fill-extrusion-emissive-strength":new _t(ge["paint_fill-extrusion"]["fill-extrusion-emissive-strength"]),"fill-extrusion-line-width":new _t(ge["paint_fill-extrusion"]["fill-extrusion-line-width"]),"fill-extrusion-cast-shadows":new Je(ge["paint_fill-extrusion"]["fill-extrusion-cast-shadows"]),"fill-extrusion-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"fill-extrusion-flood-light-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(r){return new jf(r)}queryRadius(){return Mf(this.paint.get("fill-extrusion-translate"))}is3D(r){return!0}hasShadowPass(){return this.paint.get("fill-extrusion-cast-shadows")}cutoffRange(){return this.paint.get("fill-extrusion-cutoff-fade-range")}canCastShadows(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}queryIntersectsFeature(r,e,i,s,a,u,h,p,_){const g=bg(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),u.angle,r.pixelToTileUnitsFactor),x=this.paint.get("fill-extrusion-height").evaluate(e,i),b=this.paint.get("fill-extrusion-base").evaluate(e,i),w=[0,0],E=p&&u.elevation,A=u.elevation?u.elevation.exaggeration():1,P=r.tile.getBucket(this);if(E&&P instanceof jf){const R=P.centroidVertexArray,N=_+1;N<R.length&&(w[0]=R.geta_centroid_pos0(N),w[1]=R.geta_centroid_pos1(N))}if(w[0]===0&&w[1]===1)return!1;u.projection.name==="globe"&&(s=Cy([s],[new ut(0,0),new ut(dt,dt)],r.tileID.canonical).map(R=>R.polygon).flat());const L=E?p:null,[k,j]=function(R,N,q,Z,ae,ne,ce,me,Re,Xe,Ve){return R.projection.name==="globe"?function(We,Ke,Le,He,Me,ze,et,it,Ot,At,pt){const Qe=[],Xt=[],Et=We.projection.upVectorScale(pt,We.center.lat,We.worldSize).metersToTile,Mt=[0,0,0,1],jt=[0,0,0,1],Qt=(ai,ii,li,Li)=>{ai[0]=ii,ai[1]=li,ai[2]=Li,ai[3]=1},Jt=Ay();Le>0&&(Le+=Jt),He+=Jt;for(const ai of Ke){const ii=[],li=[];for(const Li of ai){const er=Li.x+Me.x,$=Li.y+Me.y,W=We.projection.projectTilePoint(er,$,pt),De=We.projection.upVector(pt,Li.x,Li.y);let lt=Le,mt=He;if(et){const ft=ky(er,$,Le,He,et,it,Ot,At);lt+=ft.base,mt+=ft.top}Le!==0?Qt(Mt,W.x+De[0]*Et*lt,W.y+De[1]*Et*lt,W.z+De[2]*Et*lt):Qt(Mt,W.x,W.y,W.z),Qt(jt,W.x+De[0]*Et*mt,W.y+De[1]*Et*mt,W.z+De[2]*Et*mt),ji(Mt,Mt,ze),ji(jt,jt,ze),ii.push(new nc(Mt[0],Mt[1],Mt[2])),li.push(new nc(jt[0],jt[1],jt[2]))}Qe.push(ii),Xt.push(li)}return[Qe,Xt]}(R,N,q,Z,ae,ne,ce,me,Re,Xe,Ve):ce?function(We,Ke,Le,He,Me,ze,et,it,Ot){const At=[],pt=[],Qe=[0,0,0,1];for(const Xt of We){const Et=[],Mt=[];for(const jt of Xt){const Qt=jt.x+He.x,Jt=jt.y+He.y,ai=ky(Qt,Jt,Ke,Le,ze,et,it,Ot);Qe[0]=Qt,Qe[1]=Jt,Qe[2]=ai.base,Qe[3]=1,_n(Qe,Qe,Me),Qe[3]=Math.max(Qe[3],1e-5);const ii=new nc(Qe[0]/Qe[3],Qe[1]/Qe[3],Qe[2]/Qe[3]);Qe[0]=Qt,Qe[1]=Jt,Qe[2]=ai.top,Qe[3]=1,_n(Qe,Qe,Me),Qe[3]=Math.max(Qe[3],1e-5);const li=new nc(Qe[0]/Qe[3],Qe[1]/Qe[3],Qe[2]/Qe[3]);Et.push(ii),Mt.push(li)}At.push(Et),pt.push(Mt)}return[At,pt]}(N,q,Z,ae,ne,ce,me,Re,Xe):function(We,Ke,Le,He,Me){const ze=[],et=[],it=Me[8]*Ke,Ot=Me[9]*Ke,At=Me[10]*Ke,pt=Me[11]*Ke,Qe=Me[8]*Le,Xt=Me[9]*Le,Et=Me[10]*Le,Mt=Me[11]*Le;for(const jt of We){const Qt=[],Jt=[];for(const ai of jt){const ii=ai.x+He.x,li=ai.y+He.y,Li=Me[0]*ii+Me[4]*li+Me[12],er=Me[1]*ii+Me[5]*li+Me[13],$=Me[2]*ii+Me[6]*li+Me[14],W=Me[3]*ii+Me[7]*li+Me[15],De=Li+it,lt=er+Ot,mt=$+At,ft=Math.max(W+pt,1e-5),St=Li+Qe,Vt=er+Xt,hi=$+Et,di=Math.max(W+Mt,1e-5);Qt.push(new nc(De/ft,lt/ft,mt/ft)),Jt.push(new nc(St/di,Vt/di,hi/di))}ze.push(Qt),et.push(Jt)}return[ze,et]}(N,q,Z,ae,ne)}(u,s,b,x,g,h,L,w,A,u.center.lat,r.tileID.canonical),G=r.queryGeometry;return function(R,N,q){let Z=1/0;hs(q,N)&&(Z=Oy(q,N[0]));for(let ae=0;ae<N.length;ae++){const ne=N[ae],ce=R[ae];for(let me=0;me<ne.length-1;me++){const Re=ne[me],Xe=[Re,ne[me+1],ce[me+1],ce[me],Re];Cn(q,Xe)&&(Z=Math.min(Z,Oy(q,Xe)))}}return Z!==1/0&&Z}(k,j,G.isPointQuery()?G.screenBounds:G.screenGeometry)}},building:class extends hn{constructor(r,e,i,s){super(r,{layout:Wy||(Wy=new br({visibility:new Je(ge.layout_building.visibility),"building-roof-shape":new _t(ge.layout_building["building-roof-shape"]),"building-height":new _t(ge.layout_building["building-height"]),"building-base":new _t(ge.layout_building["building-base"])})),paint:Xy||(Xy=new br({"building-opacity":new Je(ge.paint_building["building-opacity"]),"building-ambient-occlusion-wall-intensity":new Je(ge.paint_building["building-ambient-occlusion-wall-intensity"]),"building-ambient-occlusion-ground-intensity":new Je(ge.paint_building["building-ambient-occlusion-ground-intensity"]),"building-ambient-occlusion-ground-radius":new Je(ge.paint_building["building-ambient-occlusion-ground-radius"]),"building-ambient-occlusion-ground-attenuation":new Je(ge.paint_building["building-ambient-occlusion-ground-attenuation"]),"building-vertical-scale":new Je(ge.paint_building["building-vertical-scale"]),"building-cast-shadows":new Je(ge.paint_building["building-cast-shadows"]),"building-color":new _t(ge.paint_building["building-color"]),"building-emissive-strength":new _t(ge.paint_building["building-emissive-strength"]),"building-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(r){return new Zy(r)}},line:class extends hn{constructor(r,e,i,s){const a=sv();super(r,a,e,i,s),a.layout&&(this.layout=new Ko(a.layout)),this.gradientVersion=0,this.hasElevatedBuckets=!1,this.hasNonElevatedBuckets=!1}_handleSpecialPaintPropertyUpdate(r){if(r==="line-gradient"){const e=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=e._styleExpression&&e._styleExpression.expression instanceof Cl,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}recalculate(r,e){super.recalculate(r,e),this.paint._values["line-floorwidth"]=(()=>{if(nd)return nd;const i=sv();return nd=new Sb(i.paint.properties["line-width"].specification),nd.useIntegerZoom=!0,nd})().possiblyEvaluate(this._transitioningPaint._values["line-width"].value,r)}createBucket(r){return new Gm(r)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getDefaultProgramParams(r,e,i){const s=rv(this);return{config:new Ga(this,{zoom:e,lut:i}),defines:s,overrideFog:!1}}queryRadius(r){const e=r,i=ov(pu("line-width",this,e),pu("line-gap-width",this,e)),s=pu("line-offset",this,e);return i/2+Math.abs(s)+Mf(this.paint.get("line-translate"))}queryIntersectsFeature(r,e,i,s,a,u){if(r.queryGeometry.isAboveHorizon)return!1;const h=xg(r.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),u.angle,r.pixelToTileUnitsFactor),p=r.pixelToTileUnitsFactor/2*ov(this.paint.get("line-width").evaluate(e,i),this.paint.get("line-gap-width").evaluate(e,i)),_=this.paint.get("line-offset").evaluate(e,i);return _&&(s=function(g,x){const b=[],w=new ut(0,0);for(let E=0;E<g.length;E++){const A=g[E],P=[];for(let L=0;L<A.length;L++){const k=A[L],j=A[L+1],G=L===0?w:k.sub(A[L-1])._unit()._perp(),R=L===A.length-1?w:j.sub(k)._unit()._perp(),N=G._add(R)._unit();N._mult(1/(N.x*R.x+N.y*R.y)),P.push(N._mult(x)._add(k))}b.push(P)}return b}(s,_*r.pixelToTileUnitsFactor)),function(g,x,b){for(let w=0;w<x.length;w++){const E=x[w];if(g.length>=3){for(let A=0;A<E.length;A++)if(bs(g,E[A]))return!0}if(xo(g,E,b))return!0}return!1}(h,s,p)}isTileClipped(){return this.hasNonElevatedBuckets}isDraped(r){return!this.hasElevatedBuckets}hasElevation(){return this.layout&&this.layout.get("line-elevation-reference")!=="none"}},symbol:cp,background:class extends hn{constructor(r,e,i,s){super(r,{layout:Yv||(Yv=new br({visibility:new Je(ge.layout_background.visibility)})),paint:Kv||(Kv=new br({"background-pitch-alignment":new Je(ge.paint_background["background-pitch-alignment"]),"background-color":new Je(ge.paint_background["background-color"]),"background-pattern":new Je(ge.paint_background["background-pattern"]),"background-opacity":new Je(ge.paint_background["background-opacity"]),"background-emissive-strength":new Je(ge.paint_background["background-emissive-strength"]),"background-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}getDefaultProgramParams(r,e,i){return{overrideFog:!1}}is3D(r){return this.paint.get("background-pitch-alignment")==="viewport"}},raster:ix,"raster-particle":lx,sky:class extends hn{constructor(r,e,i,s){super(r,{layout:sx||(sx=new br({visibility:new Je(ge.layout_sky.visibility)})),paint:ox||(ox=new br({"sky-type":new Je(ge.paint_sky["sky-type"]),"sky-atmosphere-sun":new Je(ge.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new Je(ge.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new Je(ge.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new Je(ge.paint_sky["sky-gradient-radius"]),"sky-gradient":new Jo(ge.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new Je(ge.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new Je(ge.paint_sky["sky-atmosphere-color"]),"sky-opacity":new Je(ge.paint_sky["sky-opacity"]),"sky-gradient-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-halo-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(r){r==="sky-gradient"?this._updateColorRamp():r!=="sky-atmosphere-sun"&&r!=="sky-atmosphere-halo-color"&&r!=="sky-atmosphere-color"&&r!=="sky-atmosphere-sun-intensity"||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=qh({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(r){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){const e=r.style.light.properties.get("position");return this._lightPosition.azimuthal!==e.azimuthal||this._lightPosition.polar!==e.polar}return!1}getCenter(r,e){if(this.paint.get("sky-type")==="atmosphere"){const s=this.paint.get("sky-atmosphere-sun"),a=!s,u=r.style.light,h=u.properties.get("position");return a&&u.properties.get("anchor")==="viewport"&&ei("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),a?d_(h.azimuthal,90-h.polar,e):d_(s[0],90-s[1],e)}const i=this.paint.get("sky-gradient-center");return d_(i[0],90-i[1],e)}isSky(){return!0}markSkyboxValid(r){this._skyboxInvalidated=!1,this._lightPosition=r.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){const r=this.paint.get("sky-type");return r==="atmosphere"?["skyboxCapture","skybox"]:r==="gradient"?["skyboxGradient"]:null}},slot:class extends hn{constructor(r,e,i,s){super(r,{paint:ax||(ax=new br({}))},e,null)}},model:class extends hn{constructor(r,e,i,s){super(r,{layout:gx||(gx=new br({visibility:new Je(ge.layout_model.visibility),"model-id":new _t(ge.layout_model["model-id"])})),paint:yx||(yx=new br({"model-opacity":new _t(ge.paint_model["model-opacity"]),"model-rotation":new _t(ge.paint_model["model-rotation"]),"model-scale":new _t(ge.paint_model["model-scale"]),"model-translation":new _t(ge.paint_model["model-translation"]),"model-color":new _t(ge.paint_model["model-color"]),"model-color-mix-intensity":new _t(ge.paint_model["model-color-mix-intensity"]),"model-type":new Je(ge.paint_model["model-type"]),"model-cast-shadows":new Je(ge.paint_model["model-cast-shadows"]),"model-receive-shadows":new Je(ge.paint_model["model-receive-shadows"]),"model-ambient-occlusion-intensity":new Je(ge.paint_model["model-ambient-occlusion-intensity"]),"model-emissive-strength":new _t(ge.paint_model["model-emissive-strength"]),"model-roughness":new _t(ge.paint_model["model-roughness"]),"model-height-based-emissive-strength-multiplier":new _t(ge.paint_model["model-height-based-emissive-strength-multiplier"]),"model-cutoff-fade-range":new Je(ge.paint_model["model-cutoff-fade-range"]),"model-front-cutoff":new Je(ge.paint_model["model-front-cutoff"]),"model-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(r){return new __(r)}getProgramIds(){return["model"]}is3D(r){return!0}hasShadowPass(){return!0}canCastShadows(){return!0}hasLightBeamPass(){return!0}cutoffRange(){return this.paint.get("model-cutoff-fade-range")}queryRadius(r){return r instanceof gp?dt-1:0}queryIntersectsFeature(r,e,i,s,a,u){if(!this.modelManager)return!1;const h=this.modelManager,p=r.tile.getBucket(this);if(!(p&&p instanceof __))return!1;for(const _ in p.instancesPerModel){const g=p.instancesPerModel[_],x=e.id!==void 0?e.id:e.properties&&e.properties.hasOwnProperty("id")?e.properties.id:void 0;if(g.idToFeaturesIndex.hasOwnProperty(x)){const b=g.features[g.idToFeaturesIndex[x]],w=h.getModel(_,this.scope);if(!w)return!1;let E=st();const A=new V(0,0),P=p.canonical;let L=Number.MAX_VALUE;for(let k=0;k<b.instancedDataCount;++k){const j=16*(b.instancedDataOffset+k),G=g.instancedDataArray.float32,R=[G[j+4],G[j+5],G[j+6]];Sx(P,A,G[j],0|G[j+1]),vx(E,w,u,A,b.rotation,b.scale,R,!1,!1,!1),u.projection.name==="globe"&&(E=p_(E,u));const N=at([],u.projMatrix,E),q=r.queryGeometry,Z=fx(q.isPointQuery()?q.screenBounds:q.screenGeometry,u,N,w.aabb);Z!=null&&(L=Math.min(Z,L))}return L!==Number.MAX_VALUE&&L}}return!1}_handleOverridablePaintPropertyUpdate(r,e,i){return!(!this.layout||e.isDataDriven()||i.isDataDriven()||r!=="model-color"&&r!=="model-color-mix-intensity"&&r!=="model-rotation"&&r!=="model-scale"&&r!=="model-translation"&&r!=="model-emissive-strength")}_isPropertyZoomDependent(r){const e=this._transitionablePaint._values[r];return e!=null&&e.value!=null&&e.value.expression!=null&&e.value.expression instanceof kl}isZoomDependent(){return this._isPropertyZoomDependent("model-scale")||this._isPropertyZoomDependent("model-rotation")||this._isPropertyZoomDependent("model-translation")}},clip:class extends hn{constructor(r,e,i,s){super(r,{layout:sy||(sy=new br({"clip-layer-types":new Je(ge.layout_clip["clip-layer-types"]),"clip-layer-scope":new Je(ge.layout_clip["clip-layer-scope"])})),paint:oy||(oy=new br({}))},e,i,s)}recalculate(r,e){super.recalculate(r,e)}createBucket(r){return new ay(r)}is3D(r){return!0}}},x_=new Pi(0,0,0),b_={PATH_RULE_NON_ZERO:1,PATH_RULE_EVEN_ODD:2},w_={LINE_CAP_BUTT:1,LINE_CAP_ROUND:2,LINE_CAP_SQUARE:3},yp={LINE_JOIN_MITER:1,LINE_JOIN_MITER_CLIP:2,LINE_JOIN_ROUND:3,LINE_JOIN_BEVEL:4},Cw={PAINT_ORDER_FILL_AND_STROKE:1},gd={PATH_COMMAND_MOVE:1,PATH_COMMAND_LINE:2,PATH_COMMAND_QUAD:3,PATH_COMMAND_CUBIC:4,PATH_COMMAND_CLOSE:5},Ex={MASK_TYPE_LUMINANCE:1};function Mw(r,e,i){r===1&&e.icons.push(function(s,a){return function(u){if(u.usvg_tree.height||(u.usvg_tree.height=u.usvg_tree.width),!u.metadata)return u;const{metadata:h}=u;if(h.content_area){const{content_area:p}=h;p.top==null&&(p.top=p.left),p.width==null&&(p.width=u.usvg_tree.width),p.height==null&&(p.height=p.width)}return h.stretch_x&&h.stretch_x.length&&Ix(h,"x"),h.stretch_y&&h.stretch_y.length&&Ix(h,"y"),u}(s.readFields(Pw,{name:void 0},a))}(i,i.readVarint()+i.pos))}function Ix(r,e){const i=[],s=r[`stretch_${e}`];let a=null;for(let u=0;u<s.length;u++)a===null?a=i.length===0?s[0]:i[i.length-1][1]+s[u]:(i.push([a,a+s[u]]),a=null);r[`stretch_${e}_areas`]=i}function Pw(r,e,i){r===1?e.name=i.readString():r===2?e.metadata=function(s,a){return s.readFields(Rw,{stretch_x:null,stretch_y:null,stretch_x_areas:null,stretch_y_areas:null,variables:[]},a)}(i,i.readVarint()+i.pos):r===3&&(e.usvg_tree=function(s,a){return s.readFields(Dw,{width:20,children:[],linear_gradients:[],radial_gradients:[],clip_paths:[],masks:[]},a)}(i,i.readVarint()+i.pos),e.data="usvg_tree")}function Rw(r,e,i){r===1?e.stretch_x=i.readPackedVarint():r===2?e.stretch_y=i.readPackedVarint():r===3?e.content_area=function(s,a){return s.readFields(zw,{left:0},a)}(i,i.readVarint()+i.pos):r===4&&e.variables.push(function(s,a){return s.readFields(Lw,{name:void 0},a)}(i,i.readVarint()+i.pos))}function zw(r,e,i){r===1?e.left=i.readVarint():r===2?e.width=i.readVarint():r===3?e.top=i.readVarint():r===4&&(e.height=i.readVarint())}function Lw(r,e,i){r===1?e.name=i.readString():r===2&&(e.rgb_color=bp(i.readVarint()),e.value="rgb_color")}function Dw(r,e,i){r===1?e.width=e.height=i.readVarint():r===2?e.height=i.readVarint():r===3?e.children.push(vp(i,i.readVarint()+i.pos)):r===4?e.linear_gradients.push(function(s,a){return s.readFields(Uw,{spread_method:1,stops:[],x1:0,y1:0,x2:1,y2:0},a)}(i,i.readVarint()+i.pos)):r===5?e.radial_gradients.push(function(s,a){return s.readFields(Gw,{spread_method:1,stops:[],cx:.5,cy:.5,r:.5,fx:.5,fy:.5,fr:0},a)}(i,i.readVarint()+i.pos)):r===7?e.clip_paths.push(function(s,a){return s.readFields(qw,{children:[]},a)}(i,i.readVarint()+i.pos)):r===8&&e.masks.push(function(s,a){const u=s.readFields($w,{left:0,width:20,mask_type:Ex.MASK_TYPE_LUMINANCE,children:[]},a);return u.height==null&&(u.height=u.width),u.top==null&&(u.top=u.left),u}(i,i.readVarint()+i.pos))}function vp(r,e){return r.readFields(Ow,{},e)}function Ow(r,e,i){r===1?(e.group=function(s,a){return s.readFields(kw,{opacity:255,children:[]},a)}(i,i.readVarint()+i.pos),e.node="group"):r===2&&(e.path=function(s,a){return s.readFields(Bw,{paint_order:1,commands:[],step:1,diffs:[],rule:b_.PATH_RULE_NON_ZERO},a)}(i,i.readVarint()+i.pos),e.node="path")}function kw(r,e,i){r===1?e.transform=xp(i,i.readVarint()+i.pos):r===2?e.opacity=i.readVarint():r===5?e.clip_path_idx=i.readVarint():r===6?e.mask_idx=i.readVarint():r===7&&e.children.push(vp(i,i.readVarint()+i.pos))}function xp(r,e){return r.readFields(Fw,{sx:1,ky:0,kx:0,sy:1,tx:0,ty:0},e)}function Fw(r,e,i){r===1?e.sx=i.readFloat():r===2?e.ky=i.readFloat():r===3?e.kx=i.readFloat():r===4?e.sy=i.readFloat():r===5?e.tx=i.readFloat():r===6&&(e.ty=i.readFloat())}function Bw(r,e,i){r===1?e.fill=function(s,a){return s.readFields(Nw,{rgb_color:x_,paint:"rgb_color",opacity:255},a)}(i,i.readVarint()+i.pos):r===2?e.stroke=function(s,a){return s.readFields(Vw,{rgb_color:x_,paint:"rgb_color",dasharray:[],dashoffset:0,miterlimit:4,opacity:255,width:1,linecap:1,linejoin:1},a)}(i,i.readVarint()+i.pos):r===3?e.paint_order=i.readVarint():r===5?i.readPackedVarint(e.commands):r===6?e.step=i.readFloat():r===7?i.readPackedSVarint(e.diffs):r===8&&(e.rule=i.readVarint())}function Nw(r,e,i){r===1?(e.rgb_color=bp(i.readVarint()),e.paint="rgb_color"):r===2?(e.linear_gradient_idx=i.readVarint(),e.paint="linear_gradient_idx"):r===3?(e.radial_gradient_idx=i.readVarint(),e.paint="radial_gradient_idx"):r===5&&(e.opacity=i.readVarint())}function bp(r){return new Pi((r>>16&255)/255,(r>>8&255)/255,(255&r)/255,1)}function Vw(r,e,i){r===1?(e.rgb_color=bp(i.readVarint()),e.paint="rgb_color"):r===2?(e.linear_gradient_idx=i.readVarint(),e.paint="linear_gradient_idx"):r===3?(e.radial_gradient_idx=i.readVarint(),e.paint="radial_gradient_idx"):r===5?i.readPackedFloat(e.dasharray):r===6?e.dashoffset=i.readFloat():r===7?e.miterlimit=i.readFloat():r===8?e.opacity=i.readVarint():r===9?e.width=i.readFloat():r===10?e.linecap=i.readVarint():r===11&&(e.linejoin=i.readVarint())}function Uw(r,e,i){r===1?e.transform=xp(i,i.readVarint()+i.pos):r===2?e.spread_method=i.readVarint():r===3?e.stops.push(Ax(i,i.readVarint()+i.pos)):r===4?e.x1=i.readFloat():r===5?e.y1=i.readFloat():r===6?e.x2=i.readFloat():r===7&&(e.y2=i.readFloat())}function Ax(r,e){return r.readFields(jw,{offset:0,opacity:255,rgb_color:x_},e)}function jw(r,e,i){r===1?e.offset=i.readFloat():r===2?e.opacity=i.readVarint():r===3&&(e.rgb_color=bp(i.readVarint()))}function Gw(r,e,i){r===1?e.transform=xp(i,i.readVarint()+i.pos):r===2?e.spread_method=i.readVarint():r===3?e.stops.push(Ax(i,i.readVarint()+i.pos)):r===4?e.cx=i.readFloat():r===5?e.cy=i.readFloat():r===6?e.r=i.readFloat():r===7?e.fx=i.readFloat():r===8?e.fy=i.readFloat():r===9&&(e.fr=i.readFloat())}function qw(r,e,i){r===1?e.transform=xp(i,i.readVarint()+i.pos):r===2?e.clip_path_idx=i.readVarint():r===3&&e.children.push(vp(i,i.readVarint()+i.pos))}function $w(r,e,i){r===1?e.left=e.top=i.readFloat():r===2?e.width=e.height=i.readFloat():r===3?e.top=i.readFloat():r===4?e.height=i.readFloat():r===5?e.mask_type=i.readVarint():r===6?e.mask_idx=i.readVarint():r===7&&e.children.push(vp(i,i.readVarint()+i.pos))}class Hw{static calculate(e={},i=[]){const s=new Map,a=new Map;if(Object.keys(e).length===0)return s;i.forEach(u=>{a.set(u.name,u.rgb_color||new Pi(0,0,0))});for(const[u,h]of Object.entries(e))a.has(u)?s.set(a.get(u).toString(),h):console.warn(`Ignoring unknown image variable "${u}"`);return s}}function Au(r,e=255,i){const s=e/255,a=r.toString(),u=i.has(a)?i.get(a).clone():r.clone();return u.a*=s,u.toString()}function yd(r,e){if(!_c()){const i=document.createElement("canvas");return i.width=r,i.height=e,i}return new OffscreenCanvas(r,e)}function Zw(r,e){const i=Hw.calculate(e.params,r.metadata?r.metadata.variables:[]),s=r.usvg_tree,a=s.width,u=s.height,h=e.transform?e.transform:new DOMMatrix,p=Math.max(1,Math.round(a*h.a)),_=Math.max(1,Math.round(u*h.d)),g=new DOMMatrix([p/a,0,0,_/u,0,0]),x=yd(p,_).getContext("2d");return T_(x,g,s,s,i),x.getImageData(0,0,p,_)}function T_(r,e,i,s,a){for(const u of s.children)Cx(r,e,i,u,a)}function Cx(r,e,i,s,a){s.group?(r.save(),function(u,h,p,_,g){const x=_.mask_idx!=null?p.masks[_.mask_idx]:null,b=_.clip_path_idx!=null?p.clip_paths[_.clip_path_idx]:null;if(_.transform&&(h=Cu(_.transform).preMultiplySelf(h)),!function(A,P,L){return A.opacity!==255||P||L}(_,b!=null,x!=null))return void T_(u,h,p,_,g);const w=yd(u.canvas.width,u.canvas.height),E=w.getContext("2d");T_(E,h,p,_,g),b&&Ox(E,h,p,b),x&&kx(E,h,p,x,g),u.globalAlpha=_.opacity/255,u.drawImage(w,0,0)}(r,e,i,s.group,a),r.restore()):s.path&&(r.save(),function(u,h,p,_,g){u.setTransform(h),_.paint_order===Cw.PAINT_ORDER_FILL_AND_STROKE?(Mx(u,p,_,g),Rx(u,p,_,g)):(Rx(u,p,_,g),Mx(u,p,_,g))}(r,e,i,s.path,a),r.restore())}function Mx(r,e,i,s){const a=i.fill;if(!a)return;const u=a.opacity/255;switch(r.save(),r.beginPath(),Fx(i,r),a.paint){case"rgb_color":r.fillStyle=Au(a.rgb_color,a.opacity,s);break;case"linear_gradient_idx":{const h=e.linear_gradients[a.linear_gradient_idx];h.transform&&r.setTransform(Cu(h.transform).preMultiplySelf(r.getTransform())),r.fillStyle=zx(r,h,u,s);break}case"radial_gradient_idx":{const h=e.radial_gradients[a.radial_gradient_idx];h.transform&&r.setTransform(Cu(h.transform).preMultiplySelf(r.getTransform())),r.fillStyle=Lx(r,h,u,s)}}r.fill(Px(i)),r.restore()}function Px(r){return r.rule===b_.PATH_RULE_NON_ZERO?"nonzero":r.rule===b_.PATH_RULE_EVEN_ODD?"evenodd":void 0}function Rx(r,e,i,s){const a=i.stroke;if(!a)return;const u=Bx(i);r.lineWidth=a.width,r.miterLimit=a.miterlimit,r.setLineDash(a.dasharray),r.lineDashOffset=a.dashoffset;const h=a.opacity/255;switch(a.paint){case"rgb_color":r.strokeStyle=Au(a.rgb_color,a.opacity,s);break;case"linear_gradient_idx":r.strokeStyle=zx(r,e.linear_gradients[a.linear_gradient_idx],h,s,!0);break;case"radial_gradient_idx":r.strokeStyle=Lx(r,e.radial_gradients[a.radial_gradient_idx],h,s,!0)}switch(a.linejoin){case yp.LINE_JOIN_MITER_CLIP:case yp.LINE_JOIN_MITER:r.lineJoin="miter";break;case yp.LINE_JOIN_ROUND:r.lineJoin="round";break;case yp.LINE_JOIN_BEVEL:r.lineJoin="bevel"}switch(a.linecap){case w_.LINE_CAP_BUTT:r.lineCap="butt";break;case w_.LINE_CAP_ROUND:r.lineCap="round";break;case w_.LINE_CAP_SQUARE:r.lineCap="square"}r.stroke(u)}function zx(r,e,i,s,a=!1){if(e.stops.length===1){const w=e.stops[0];return Au(w.rgb_color,w.opacity*i,s)}const{x1:u,y1:h,x2:p,y2:_}=e;let g=new DOMPoint(u,h),x=new DOMPoint(p,_);if(a){const w=Cu(e.transform);g=w.transformPoint(g),x=w.transformPoint(x)}const b=r.createLinearGradient(g.x,g.y,x.x,x.y);for(const w of e.stops)b.addColorStop(w.offset,Au(w.rgb_color,w.opacity*i,s));return b}function Lx(r,e,i,s,a=!1){if(e.stops.length===1){const k=e.stops[0];return Au(k.rgb_color,k.opacity*i,s)}const u=Cu(e.transform),{fx:h,fy:p,fr:_,cx:g,cy:x,r:b}=e;let w=new DOMPoint(h,p),E=new DOMPoint(g,x),A=_,P=b;if(a){w=u.transformPoint(w),E=u.transformPoint(E);const k=(u.a+u.d)/2;A=_*k,P=e.r*k}const L=r.createRadialGradient(w.x,w.y,A,E.x,E.y,P);for(const k of e.stops)L.addColorStop(k.offset,Au(k.rgb_color,k.opacity*i,s));return L}function Dx(r,e,i,s){const a=s.transform?Cu(s.transform).preMultiplySelf(e):e,u=yd(r.canvas.width,r.canvas.height),h=u.getContext("2d");for(const _ of s.children)if(_.group)Dx(h,a,i,_.group);else if(_.path){const g=_.path,x=new Path2D;x.addPath(Bx(g),a),h.fill(x,Px(g))}const p=s.clip_path_idx!=null?i.clip_paths[s.clip_path_idx]:null;p&&Ox(h,a,i,p),r.globalCompositeOperation="source-over",r.drawImage(u,0,0)}function Ox(r,e,i,s){const a=yd(r.canvas.width,r.canvas.height);Dx(a.getContext("2d"),e,i,s),r.globalCompositeOperation="destination-in",r.drawImage(a,0,0)}function kx(r,e,i,s,a){if(s.children.length===0)return;const u=s.mask_idx!=null?i.masks[s.mask_idx]:null;u&&kx(r,e,i,u,a);const h=r.canvas.width,p=r.canvas.height,_=yd(h,p),g=_.getContext("2d"),x=s.width,b=s.height,w=s.left,E=s.top,A=new Path2D,P=new Path2D;P.rect(w,E,x,b),A.addPath(P,e),g.clip(A);for(const j of s.children)Cx(g,e,i,j,a);const L=g.getImageData(0,0,h,p),k=L.data;if(s.mask_type===Ex.MASK_TYPE_LUMINANCE)for(let j=0;j<k.length;j+=4)k[j+3]=k[j+3]/255*(.2126*k[j]+.7152*k[j+1]+.0722*k[j+2]);g.putImageData(L,0,0),r.globalCompositeOperation="destination-in",r.drawImage(_,0,0)}function Cu(r){return r?new DOMMatrix([r.sx,r.ky,r.kx,r.sy,r.tx,r.ty]):new DOMMatrix}function Fx(r,e){const i=r.step;let s=r.diffs[0]*i,a=r.diffs[1]*i;e.moveTo(s,a);for(let u=0,h=2;u<r.commands.length;u++)switch(r.commands[u]){case gd.PATH_COMMAND_MOVE:s+=r.diffs[h++]*i,a+=r.diffs[h++]*i,e.moveTo(s,a);break;case gd.PATH_COMMAND_LINE:s+=r.diffs[h++]*i,a+=r.diffs[h++]*i,e.lineTo(s,a);break;case gd.PATH_COMMAND_QUAD:{const p=s+r.diffs[h++]*i,_=a+r.diffs[h++]*i;s=p+r.diffs[h++]*i,a=_+r.diffs[h++]*i,e.quadraticCurveTo(p,_,s,a);break}case gd.PATH_COMMAND_CUBIC:{const p=s+r.diffs[h++]*i,_=a+r.diffs[h++]*i,g=p+r.diffs[h++]*i,x=_+r.diffs[h++]*i;s=g+r.diffs[h++]*i,a=x+r.diffs[h++]*i,e.bezierCurveTo(p,_,g,x,s,a);break}case gd.PATH_COMMAND_CLOSE:e.closePath()}return e}function Bx(r){return Fx(r,new Path2D)}class wp{constructor(e){this.capacity=e,this.cache=new Map}get(e){if(!this.cache.has(e))return;const i=this.cache.get(e);return this.cache.delete(e),this.cache.set(e,i),i}put(e,i){this.cache.has(e)?this.cache.delete(e):this.cache.size===this.capacity&&this.cache.delete(this.cache.keys().next().value),this.cache.set(e,i)}delete(e){this.cache.delete(e)}}bt(wp,"LRUCache");class S_{constructor(){this.cacheMap=new Map,this.cacheDependenciesMap=new Map}static _getImage(e){return new nn(e,e.data)}getFromCache(e,i,s){return this.cacheMap.has(s)||this.cacheMap.set(s,new wp(150)),this.cacheMap.get(s).get(Qo(e.toString(),i))}setInCache(e,i,s,a){this.cacheDependenciesMap.has(a)||this.cacheDependenciesMap.set(a,new Map),this.cacheMap.has(a)||this.cacheMap.set(a,new wp(150));const u=this.cacheDependenciesMap.get(a),h=Qo(e.id.toString(),s);u.get(h)||u.set(h,new Set);const p=this.cacheMap.get(a),_=e.toString();u.get(h).add(_),p.put(Qo(e.toString(),s),i)}removeImagesFromCacheByIds(e,i,s=0){if(!this.cacheMap.has(s)||!this.cacheDependenciesMap.has(s))return;const a=this.cacheMap.get(s),u=this.cacheDependenciesMap.get(s);for(const h of e){const p=Qo(h.toString(),i);if(u.has(p)){for(const _ of u.get(p))a.delete(_);u.delete(p)}}}rasterize(e,i,s,a,u=Zw){const h=this.getFromCache(e,s,a);if(h)return h.clone();const p=u(i.icon,e.options),_=S_._getImage(p);return this.setInCache(e,_,s,a),_.clone()}}class Nx{constructor(e){this.size=e,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(e,i){const s=this.toIdx(e,i);return{min:this.minimums[s],max:this.maximums[s]}}isLeaf(e,i){return this.leaves[this.toIdx(e,i)]}toIdx(e,i){return i*this.size+e}}function Vx(r,e,i,s){let a=0,u=Number.MAX_VALUE;for(let h=0;h<3;h++)if(Math.abs(s[h])<1e-15){if(i[h]<r[h]||i[h]>e[h])return null}else{const p=1/s[h];let _=(r[h]-i[h])*p,g=(e[h]-i[h])*p;if(_>g){const x=_;_=g,g=x}if(_>a&&(a=_),g<u&&(u=g),a>u)return null}return a}function Ux(r,e,i,s,a,u,h,p,_,g,x){const b=s-r,w=a-e,E=u-i,A=h-r,P=p-e,L=_-i,k=x[1]*L-x[2]*P,j=x[2]*A-x[0]*L,G=x[0]*P-x[1]*A,R=b*k+w*j+E*G;if(Math.abs(R)<1e-15)return null;const N=1/R,q=g[0]-r,Z=g[1]-e,ae=g[2]-i,ne=(q*k+Z*j+ae*G)*N;if(ne<0||ne>1)return null;const ce=Z*E-ae*w,me=ae*b-q*E,Re=q*w-Z*b,Xe=(x[0]*ce+x[1]*me+x[2]*Re)*N;return Xe<0||ne+Xe>1?null:(A*ce+P*me+L*Re)*N}function jx(r,e,i){return(r-e)/(i-e)}function Gx(r,e,i,s,a,u,h,p,_){const g=1<<i,x=u-s,b=h-a,w=(r+1)/g*x+s,E=(e+0)/g*b+a,A=(e+1)/g*b+a;p[0]=(r+0)/g*x+s,p[1]=E,_[0]=w,_[1]=A}class qx{constructor(e){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=e,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;const i=function(u){const h=Math.ceil(Math.log2(u.dim/8)),p=[];let _=Math.ceil(Math.pow(2,h));const g=1/_,x=(E,A,P,L,k)=>{const j=L?1:0,G=(E+1)*P-j,R=A*P,N=(A+1)*P-j;k[0]=E*P,k[1]=R,k[2]=G,k[3]=N};let b=new Nx(_);const w=[];for(let E=0;E<_*_;E++){x(E%_,Math.floor(E/_),g,!1,w);const A=Ja(w[0],w[1],u),P=Ja(w[2],w[1],u),L=Ja(w[2],w[3],u),k=Ja(w[0],w[3],u);b.minimums.push(Math.min(A,P,L,k)),b.maximums.push(Math.max(A,P,L,k)),b.leaves.push(1)}for(p.push(b),_/=2;_>=1;_/=2){const E=p[p.length-1];b=new Nx(_);for(let A=0;A<_*_;A++){x(A%_,Math.floor(A/_),2,!0,w);const P=E.getElevation(w[0],w[1]),L=E.getElevation(w[2],w[1]),k=E.getElevation(w[2],w[3]),j=E.getElevation(w[0],w[3]),G=E.isLeaf(w[0],w[1]),R=E.isLeaf(w[2],w[1]),N=E.isLeaf(w[2],w[3]),q=E.isLeaf(w[0],w[3]),Z=Math.min(P.min,L.min,k.min,j.min),ae=Math.max(P.max,L.max,k.max,j.max),ne=G&&R&&N&&q;b.maximums.push(ae),b.minimums.push(Z),b.leaves.push(ae-Z<=5&&ne?1:0)}p.push(b)}return p}(this.dem),s=i.length-1,a=i[s];this._addNode(a.minimums[0],a.maximums[0],a.leaves[0]),this._construct(i,0,0,s,0)}raycastRoot(e,i,s,a,u,h,p=1){return Vx([e,i,-100],[s,a,this.maximums[0]*p],u,h)}raycast(e,i,s,a,u,h,p=1){if(!this.nodeCount)return null;const _=this.raycastRoot(e,i,s,a,u,h,p);if(_==null)return null;const g=[],x=[],b=[],w=[],E=[{idx:0,t:_,nodex:0,nodey:0,depth:0}];for(;E.length>0;){const{idx:A,t:P,nodex:L,nodey:k,depth:j}=E.pop();if(this.leaves[A]){Gx(L,k,j,e,i,s,a,b,w);const R=1<<j,N=(L+0)/R,q=(L+1)/R,Z=(k+0)/R,ae=(k+1)/R,ne=Ja(N,Z,this.dem)*p,ce=Ja(q,Z,this.dem)*p,me=Ja(q,ae,this.dem)*p,Re=Ja(N,ae,this.dem)*p,Xe=Ux(b[0],b[1],ne,w[0],b[1],ce,w[0],w[1],me,u,h),Ve=Ux(w[0],w[1],me,b[0],w[1],Re,b[0],b[1],ne,u,h),We=Math.min(Xe!==null?Xe:Number.MAX_VALUE,Ve!==null?Ve:Number.MAX_VALUE);if(We!==Number.MAX_VALUE)return We;{const Ke=fn([],u,h,P);if($x(ne,ce,Re,me,jx(Ke[0],b[0],w[0]),jx(Ke[1],b[1],w[1]))>=Ke[2])return P}continue}let G=0;for(let R=0;R<this._siblingOffset.length;R++){Gx((L<<1)+this._siblingOffset[R][0],(k<<1)+this._siblingOffset[R][1],j+1,e,i,s,a,b,w),b[2]=-100,w[2]=this.maximums[this.childOffsets[A]+R]*p;const N=Vx(b,w,u,h);if(N!=null){const q=N;g[R]=q;let Z=!1;for(let ae=0;ae<G&&!Z;ae++)q>=g[x[ae]]&&(x.splice(ae,0,R),Z=!0);Z||(x[G]=R),G++}}for(let R=0;R<G;R++){const N=x[R];E.push({idx:this.childOffsets[A]+N,t:g[N],nodex:(L<<1)+this._siblingOffset[N][0],nodey:(k<<1)+this._siblingOffset[N][1],depth:j+1})}}return null}_addNode(e,i,s){return this.minimums.push(e),this.maximums.push(i),this.leaves.push(s),this.childOffsets.push(0),this.nodeCount++}_construct(e,i,s,a,u){if(e[a].isLeaf(i,s)===1)return;this.childOffsets[u]||(this.childOffsets[u]=this.nodeCount);const h=a-1,p=e[h];let _=0,g=0;for(let x=0;x<this._siblingOffset.length;x++){const b=2*i+this._siblingOffset[x][0],w=2*s+this._siblingOffset[x][1],E=p.getElevation(b,w),A=p.isLeaf(b,w),P=this._addNode(E.min,E.max,A);A&&(_|=1<<x),g||(g=P)}for(let x=0;x<this._siblingOffset.length;x++)_&1<<x||this._construct(e,2*i+this._siblingOffset[x][0],2*s+this._siblingOffset[x][1],h,g+x)}}function $x(r,e,i,s,a,u){return Ut(Ut(r,i,u),Ut(e,s,u),a)}function Ja(r,e,i){const s=i.dim,a=Q(r*s-.5,0,s-1),u=Q(e*s-.5,0,s-1),h=Math.floor(a),p=Math.floor(u),_=Math.min(h+1,s-1),g=Math.min(p+1,s-1);return $x(i.get(h,p),i.get(_,p),i.get(h,g),i.get(_,g),a-h,u-p)}const Ww={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};function Xw(r,e,i){return(256*r*256+256*e+i)/10-1e4}function Yw(r,e,i){return 256*r+e+i/256-32768}class Tp{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(e,i,s,a=!1){if(this.uid=e,i.height!==i.width)throw new RangeError("DEM tiles must be square");if(s&&s!=="mapbox"&&s!=="terrarium")return void ei(`"${s}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=i.height;const u=this.dim=i.height-2,h=new Uint32Array(i.data.buffer);if(this.pixels=new Uint8Array(i.data.buffer),this.floatView=new Float32Array(i.data.buffer),this.borderReady=a,this._modifiedForSources={},!a){for(let _=0;_<u;_++)h[this._idx(-1,_)]=h[this._idx(0,_)],h[this._idx(u,_)]=h[this._idx(u-1,_)],h[this._idx(_,-1)]=h[this._idx(_,0)],h[this._idx(_,u)]=h[this._idx(_,u-1)];h[this._idx(-1,-1)]=h[this._idx(0,0)],h[this._idx(u,-1)]=h[this._idx(u-1,0)],h[this._idx(-1,u)]=h[this._idx(0,u-1)],h[this._idx(u,u)]=h[this._idx(u-1,u-1)]}const p=s==="terrarium"?Yw:Xw;for(let _=0;_<h.length;++_){const g=4*_;this.floatView[_]=p(this.pixels[g],this.pixels[g+1],this.pixels[g+2])}this._timestamp=ns.now()}_buildQuadTree(){this._tree=new qx(this)}get(e,i,s=!1){s&&(e=Q(e,-1,this.dim),i=Q(i,-1,this.dim));const a=this._idx(e,i);return this.floatView[a]}set(e,i,s){const a=this._idx(e,i),u=this.floatView[a];return this.floatView[a]=s,s-u}static getUnpackVector(e){return Ww[e]}_idx(e,i){if(e<-1||e>=this.dim+1||i<-1||i>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(i+1)*this.stride+(e+1)}static pack(e,i){const s=[0,0,0,0],a=Tp.getUnpackVector(i);let u=Math.floor((e+a[3])/a[2]);return s[2]=u%256,u=Math.floor(u/256),s[1]=u%256,u=Math.floor(u/256),s[0]=u,s}getPixels(){return new $g({width:this.stride,height:this.stride},this.pixels)}backfillBorder(e,i,s){if(this.dim!==e.dim)throw new Error("dem dimension mismatch");let a=i*this.dim,u=i*this.dim+this.dim,h=s*this.dim,p=s*this.dim+this.dim;switch(i){case-1:a=u-1;break;case 1:u=a+1}switch(s){case-1:h=p-1;break;case 1:p=h+1}const _=-i*this.dim,g=-s*this.dim;for(let x=h;x<p;x++)for(let b=a;b<u;b++){const w=4*this._idx(b,x),E=4*this._idx(b+_,x+g);this.pixels[w+0]=e.pixels[E+0],this.pixels[w+1]=e.pixels[E+1],this.pixels[w+2]=e.pixels[E+2],this.pixels[w+3]=e.pixels[E+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}function Kw(r,e,i){r===1?e.headerLength=i.readFixed32():r===2?e.x=i.readVarint():r===3?e.y=i.readVarint():r===4?e.z=i.readVarint():r===5&&e.layers.push(function(s,a){return s.readFields(i2,{version:0,name:"",units:"",tileSize:0,buffer:0,pixelFormat:0,dataIndex:[]},a)}(i,i.readVarint()+i.pos))}function Jw(r,e,i){r===1?(e.delta_filter=function(s,a){return s.readFields(Qw,{blockSize:0},a)}(i,i.readVarint()+i.pos),e.filter="delta_filter"):r===2?(i.readVarint(),e.filter="zigzag_filter"):r===3?(i.readVarint(),e.filter="bitshuffle_filter"):r===4&&(i.readVarint(),e.filter="byteshuffle_filter")}function Qw(r,e,i){r===1&&(e.blockSize=i.readVarint())}function e2(r,e,i){r===1?(i.readVarint(),e.codec="gzip_data"):r===2?(i.readVarint(),e.codec="jpeg_image"):r===3?(i.readVarint(),e.codec="webp_image"):r===4&&(i.readVarint(),e.codec="png_image")}function t2(r,e,i){let s=0,a=0;r===1?e.firstByte=i.readFixed64():r===2?e.lastByte=i.readFixed64():r===3?e.filters.push(function(u,h){return u.readFields(Jw,{},h)}(i,i.readVarint()+i.pos)):r===4?e.codec=function(u,h){return u.readFields(e2,{},h)}(i,i.readVarint()+i.pos):r===5?a=i.readFloat():r===6?s=i.readFloat():r===7?e.bands.push(i.readString()):r===8?e.offset=i.readDouble():r===9&&(e.scale=i.readDouble()),e.offset===0&&(e.offset=a),e.scale===0&&(e.scale=s)}function i2(r,e,i){r===1?e.version=i.readVarint():r===2?e.name=i.readString():r===3?e.units=i.readString():r===4?e.tileSize=i.readVarint():r===5?e.buffer=i.readVarint():r===6?e.pixelFormat=i.readVarint():r===7&&e.dataIndex.push(function(s,a){return s.readFields(t2,{firstByte:0,lastByte:0,filters:[],codec:null,offset:0,scale:0,bands:[]},a)}(i,i.readVarint()+i.pos))}function r2(r,e,i){if(r===2)(function(s,a,u){s.readFields(n2,u,a)})(i,i.readVarint()+i.pos,e);else if(r===3)throw new Error("Not implemented")}function n2(r,e,i){if(r===1){let s=0;const a=i.readVarint()+i.pos;for(;i.pos<a;)e[s++]=i.readVarint()}}function s2(r,e){if(e.length!==4)throw new Error(`Expected data of dimension 4 but got ${e.length}.`);let i=e[3];for(let s=2;s>=1;s--){const a=s===1?1:0,u=s===2?1:0;for(let h=0;h<e[0];h++){const p=e[1]*h;for(let _=a;_<e[1];_++){const g=e[2]*(_+p);for(let x=u;x<e[2];x++){const b=e[3]*(x+g);for(let w=0;w<e[3];w++){const E=b+w;r[E]+=r[E-i]}}}}i*=e[s]}return r}function o2(r){for(let e=0,i=r.length;e<i;e++)r[e]=r[e]>>>1^-(1&r[e]);return r}function a2(r,e){switch(e){case"uint32":return r;case"uint16":for(let i=0;i<r.length;i+=2){const s=r[i],a=r[i+1];r[i]=(240&s)>>4|(61440&s)>>8|(240&a)<<4|61440&a,r[i+1]=15&s|(3840&s)>>4|(15&a)<<8|(3840&a)<<4}return r;case"uint8":for(let i=0;i<r.length;i+=4){const s=r[i],a=r[i+1],u=r[i+2],h=r[i+3];r[i+0]=(192&s)>>6|(192&a)>>4|(192&u)>>2|192&h,r[i+1]=(48&s)>>4|(48&a)>>2|48&u|(48&h)<<2,r[i+2]=(12&s)>>2|12&a|(12&u)<<2|(12&h)<<4,r[i+3]=3&s|(3&a)<<2|(3&u)<<4|(3&h)<<6}return r;default:throw new Error(`Invalid pixel format, "${e}"`)}}bt(Tp,"DEMData"),bt(qx,"DemMinMaxQuadTree",{omit:["dem"]});var ds=Uint8Array,vd=Uint16Array,l2=Int32Array,Hx=new ds([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Zx=new ds([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),c2=new ds([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Wx=function(r,e){for(var i=new vd(31),s=0;s<31;++s)i[s]=e+=1<<r[s-1];var a=new l2(i[30]);for(s=1;s<30;++s)for(var u=i[s];u<i[s+1];++u)a[u]=u-i[s]<<5|s;return{b:i,r:a}},Xx=Wx(Hx,2),Yx=Xx.b,u2=Xx.r;Yx[28]=258,u2[258]=28;for(var h2=Wx(Zx,0).b,Kx=new vd(32768),$r=0;$r<32768;++$r){var Mu=(43690&$r)>>1|(21845&$r)<<1;Kx[$r]=((65280&(Mu=(61680&(Mu=(52428&Mu)>>2|(13107&Mu)<<2))>>4|(3855&Mu)<<4))>>8|(255&Mu)<<8)>>1}var xd=function(r,e,i){for(var s=r.length,a=0,u=new vd(e);a<s;++a)r[a]&&++u[r[a]-1];var h,p=new vd(e);for(a=1;a<e;++a)p[a]=p[a-1]+u[a-1]<<1;h=new vd(1<<e);var _=15-e;for(a=0;a<s;++a)if(r[a])for(var g=a<<4|r[a],x=e-r[a],b=p[r[a]-1]++<<x,w=b|(1<<x)-1;b<=w;++b)h[Kx[b]>>_]=g;return h},bd=new ds(288);for($r=0;$r<144;++$r)bd[$r]=8;for($r=144;$r<256;++$r)bd[$r]=9;for($r=256;$r<280;++$r)bd[$r]=7;for($r=280;$r<288;++$r)bd[$r]=8;var Jx=new ds(32);for($r=0;$r<32;++$r)Jx[$r]=5;var d2=xd(bd,9),f2=xd(Jx,5),E_=function(r){for(var e=r[0],i=1;i<r.length;++i)r[i]>e&&(e=r[i]);return e},qs=function(r,e,i){var s=e/8|0;return(r[s]|r[s+1]<<8)>>(7&e)&i},I_=function(r,e){var i=e/8|0;return(r[i]|r[i+1]<<8|r[i+2]<<16)>>(7&e)},p2=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],$s=function(r,e,i){var s=new Error(e||p2[r]);if(s.code=r,Error.captureStackTrace&&Error.captureStackTrace(s,$s),!i)throw s;return s},m2=new ds(0),_2=typeof TextDecoder<"u"&&new TextDecoder;try{_2.decode(m2,{stream:!0})}catch{}const g2={gzip_data:"gzip"};class ws extends Error{constructor(e){super(e),this.name="MRTError"}}const y2={0:"uint32",1:"uint32",2:"uint16",3:"uint8"},Qx={uint32:1,uint16:2,uint8:4},v2={uint32:Uint32Array,uint16:Uint16Array,uint8:Uint8Array};let A_;class Sp{constructor(e=5){this.x=NaN,this.y=NaN,this.z=NaN,this.layers={},this._cacheSize=e}getLayer(e){const i=this.layers[e];if(!i)throw new ws(`Layer '${e}' not found`);return i}getHeaderLength(e){const i=new Uint8Array(e),s=new DataView(e);if(i[0]!==13)throw new ws("File is not a valid MRT.");return s.getUint32(1,!0)}parseHeader(e){const i=new Uint8Array(e),s=this.getHeaderLength(e);if(i.length<s)throw new ws(`Expected header with length >= ${s} but got buffer of length ${i.length}`);const a=function(u,h){return u.readFields(Kw,{headerLength:0,x:0,y:0,z:0,layers:[]},void 0)}(new A_(i.subarray(0,s)));if(!isNaN(this.x)&&(this.x!==a.x||this.y!==a.y||this.z!==a.z))throw new ws(`Invalid attempt to parse header ${a.z}/${a.x}/${a.y} for tile ${this.z}/${this.x}/${this.y}`);this.x=a.x,this.y=a.y,this.z=a.z;for(const u of a.layers)this.layers[u.name]=new e0(u,{cacheSize:this._cacheSize});return this}createDecodingTask(e){const i=[],s=this.getLayer(e.layerName);for(let a of e.blockIndices){const u=s.dataIndex[a],h=u.firstByte-e.firstByte,p=u.lastByte-e.firstByte;if(s._blocksInProgress.has(a))continue;const _={layerName:s.name,firstByte:h,lastByte:p,pixelFormat:s.pixelFormat,blockIndex:a,blockShape:[u.bands.length].concat(s.bandShape),buffer:s.buffer,codec:u.codec.codec,filters:u.filters.map(g=>g.filter)};s._blocksInProgress.add(a),i.push(_)}return new t0(i,()=>{i.forEach(a=>s._blocksInProgress.delete(a.blockIndex))},(a,u)=>{if(i.forEach(h=>s._blocksInProgress.delete(h.blockIndex)),a)throw a;u.forEach(h=>{this.getLayer(h.layerName).processDecodedData(h)})})}}class e0{constructor({version:e,name:i,units:s,tileSize:a,pixelFormat:u,buffer:h,dataIndex:p},_){if(this.version=e,this.version!==1)throw new ws(`Cannot parse raster layer encoded with MRT version ${e}`);this.name=i,this.units=s,this.tileSize=a,this.buffer=h,this.pixelFormat=y2[u],this.dataIndex=p,this.bandShape=[a+2*h,a+2*h,Qx[this.pixelFormat]],this._decodedBlocks=new wp(_?_.cacheSize:5),this._blocksInProgress=new Set}get dimension(){return Qx[this.pixelFormat]}get cacheSize(){return this._decodedBlocks.capacity}getBandList(){return this.dataIndex.map(({bands:e})=>e).flat()}processDecodedData(e){const i=e.blockIndex.toString();this._decodedBlocks.get(i)||this._decodedBlocks.put(i,e.data)}getBlockForBand(e){let i=0;switch(typeof e){case"string":for(const[s,a]of this.dataIndex.entries()){for(const[u,h]of a.bands.entries())if(h===e)return{bandIndex:i+u,blockIndex:s,blockBandIndex:u};i+=a.bands.length}break;case"number":for(const[s,a]of this.dataIndex.entries()){if(e>=i&&e<i+a.bands.length)return{bandIndex:e,blockIndex:s,blockBandIndex:e-i};i+=a.bands.length}break;default:throw new ws(`Invalid band \`${JSON.stringify(e)}\`. Expected string or integer.`)}return{blockIndex:-1,blockBandIndex:-1}}getDataRange(e){let i=1/0,s=-1/0;const a=[],u=new Set;for(const h of e){const{blockIndex:p}=this.getBlockForBand(h);if(p<0)throw new ws(`Invalid band: ${JSON.stringify(h)}`);const _=this.dataIndex[p];a.includes(p)||a.push(p),u.add(p),i=Math.min(i,_.firstByte),s=Math.max(s,_.lastByte)}if(u.size>this.cacheSize)throw new ws(`Number of blocks to decode (${u.size}) exceeds cache size (${this.cacheSize}).`);return{layerName:this.name,firstByte:i,lastByte:s,blockIndices:a}}hasBand(e){const{blockIndex:i}=this.getBlockForBand(e);return i>=0}hasDataForBand(e){const{blockIndex:i}=this.getBlockForBand(e);return i>=0&&!!this._decodedBlocks.get(i.toString())}getBandView(e){const{blockIndex:i,blockBandIndex:s}=this.getBlockForBand(e);if(i<0)throw new ws(`Band not found: ${JSON.stringify(e)}`);const a=this._decodedBlocks.get(i.toString());if(!a)throw new ws(`Data for band ${JSON.stringify(e)} of layer "${this.name}" not decoded.`);const u=this.dataIndex[i],h=this.bandShape.reduce((g,x)=>g*x,1),p=s*h,_=a.subarray(p,p+h);return{data:_,bytes:new Uint8Array(_.buffer).subarray(_.byteOffset,_.byteOffset+_.byteLength),tileSize:this.tileSize,buffer:this.buffer,pixelFormat:this.pixelFormat,dimension:this.dimension,offset:u.offset,scale:u.scale}}}Sp.setPbf=function(r){A_=r};class t0{constructor(e,i,s){this.tasks=e,this._onCancel=i,this._onComplete=s,this._finalized=!1}cancel(){this._finalized||(this._onCancel(),this._finalized=!0)}complete(e,i){this._finalized||(this._onComplete(e,i),this._finalized=!0)}}function uc(r,e){const i=r.json.bufferViews[e.bufferView],s=$f[e.componentType];return new s(r.buffers[i.buffer],(e.byteOffset||0)+(i.byteOffset||0),e.count*(i.byteStride&&i.byteStride!==rd[e.type]*s.BYTES_PER_ELEMENT?i.byteStride/s.BYTES_PER_ELEMENT:rd[e.type]))}function C_(r,e,i,s){const a=$f[e.componentType],u=function(x){switch(x){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:return 1}}(a),h=r.json.bufferViews[e.bufferView],p=h.byteStride?h.byteStride/a.BYTES_PER_ELEMENT:rd[e.type],_=i.float32,g=_.length/i.capacity;for(let x=0,b=0;x<e.count*p;x+=p,b+=g)for(let w=0;w<g;w++)_[b+w]=s[x+w]*u;i._trim()}function x2(r,e,i){const s=r.indices,a=r.attributes,u={};u.indexArray=new en;const h=e.json.accessors[s],p=h.count/3;u.indexArray.reserve(p);const _=uc(e,h);for(let w=0;w<p;w++)u.indexArray.emplaceBack(_[3*w],_[3*w+1],_[3*w+2]);u.indexArray._trim(),u.vertexArray=new ys;const g=e.json.accessors[a.POSITION];u.vertexArray.reserve(g.count);const x=uc(e,g);for(let w=0;w<g.count;w++)u.vertexArray.emplaceBack(x[3*w],x[3*w+1],x[3*w+2]);if(u.vertexArray._trim(),u.aabb=new Ti(g.min,g.max),u.centroid=function(w,E){const A=[0,0,0],P=w.length;if(P>0){for(let L=0;L<P;L++){const k=3*w[L];A[0]+=E[k],A[1]+=E[k+1],A[2]+=E[k+2]}A[0]/=P,A[1]/=P,A[2]/=P}return A}(_,x),a.COLOR_0!==void 0){const w=e.json.accessors[a.COLOR_0],E=rd[w.type],A=uc(e,w);u.colorArray=E===3?new ys:new Qr,u.colorArray.resize(w.count),C_(e,w,u.colorArray,A)}if(a.NORMAL!==void 0){u.normalArray=new ys;const w=e.json.accessors[a.NORMAL];u.normalArray.resize(w.count);const E=uc(e,w);C_(e,w,u.normalArray,E)}if(a.TEXCOORD_0!==void 0&&i.length>0){u.texcoordArray=new ea;const w=e.json.accessors[a.TEXCOORD_0];u.texcoordArray.resize(w.count);const E=uc(e,w);C_(e,w,u.texcoordArray,E)}if(a._FEATURE_ID_RGBA4444!==void 0){const w=e.json.accessors[a._FEATURE_ID_RGBA4444];e.json.extensionsUsed&&e.json.extensionsUsed.includes("EXT_meshopt_compression")&&(u.featureData=uc(e,w))}a._FEATURE_RGBA4444!==void 0&&(u.featureData=new Uint32Array(uc(e,e.json.accessors[a._FEATURE_RGBA4444]).buffer));const b=r.material;return u.material=function(w,E){const{emissiveFactor:A=[0,0,0],alphaMode:P="OPAQUE",alphaCutoff:L=.5,normalTexture:k,occlusionTexture:j,emissiveTexture:G,doubleSided:R}=w,{baseColorFactor:N=[1,1,1,1],metallicFactor:q=1,roughnessFactor:Z=1,baseColorTexture:ae,metallicRoughnessTexture:ne}=w.pbrMetallicRoughness||{},ce=j?E[j.index]:void 0;if(j&&j.extensions&&j.extensions.KHR_texture_transform&&ce){const me=j.extensions.KHR_texture_transform;ce.offsetScale=[me.offset[0],me.offset[1],me.scale[0],me.scale[1]]}return{pbrMetallicRoughness:{baseColorFactor:new Pi(...N),metallicFactor:q,roughnessFactor:Z,baseColorTexture:ae?E[ae.index]:void 0,metallicRoughnessTexture:ne?E[ne.index]:void 0},doubleSided:R,emissiveFactor:new Pi(...A),alphaMode:P,alphaCutoff:L,normalTexture:k?E[k.index]:void 0,occlusionTexture:ce,emissionTexture:G?E[G.index]:void 0,defined:w.defined===void 0}}(b!==void 0?e.json.materials[b]:{defined:!1},i),u}function i0(r,e,i){const{matrix:s,rotation:a,translation:u,scale:h,mesh:p,extras:_,children:g}=r,x={};if(x.matrix=s||function(b,w,E,A){var P=w[0],L=w[1],k=w[2],j=w[3],G=P+P,R=L+L,N=k+k,q=P*G,Z=P*R,ae=P*N,ne=L*R,ce=L*N,me=k*N,Re=j*G,Xe=j*R,Ve=j*N,We=A[0],Ke=A[1],Le=A[2];return b[0]=(1-(ne+me))*We,b[1]=(Z+Ve)*We,b[2]=(ae-Xe)*We,b[3]=0,b[4]=(Z-Ve)*Ke,b[5]=(1-(q+me))*Ke,b[6]=(ce+Re)*Ke,b[7]=0,b[8]=(ae+Xe)*Le,b[9]=(ce-Re)*Le,b[10]=(1-(q+ne))*Le,b[11]=0,b[12]=E[0],b[13]=E[1],b[14]=E[2],b[15]=1,b}([],a||[0,0,0,1],u||[0,0,0],h||[1,1,1]),p!==void 0){x.meshes=i[p];const b=x.anchor=[0,0];for(const w of x.meshes){const{min:E,max:A}=w.aabb;b[0]+=E[0]+A[0],b[1]+=E[1]+A[1]}b[0]=Math.floor(b[0]/x.meshes.length/2),b[1]=Math.floor(b[1]/x.meshes.length/2)}if(_&&(_.id&&(x.id=_.id),_.lights&&(x.lights=function(b){if(!b.length)return[];const w=function(k){const j=atob(k),G=new Uint8Array(j.length);for(let R=0;R<j.length;R++)G[R]=j.codePointAt(R);return G}(b),E=[],A=w.length/24,P=new Uint16Array(w.buffer),L=new Float32Array(w.buffer);for(let k=0;k<A;k++){const j=P[2*k*6]/30,G=P[2*k*6+1]/30,R=P[2*k*6+10]/100,N=L[6*k+1],q=L[6*k+2],Z=L[6*k+3],ae=L[6*k+4],ne=Z-N,ce=ae-q,me=Math.hypot(ne,ce);E.push({pos:[N+.5*ne,q+.5*ce,G],normal:[ce/me,-ne/me,0],width:me,height:j,depth:R,points:[N,q,Z,ae]})}return E}(_.lights))),g){const b=[];for(const w of g)b.push(i0(e.json.nodes[w],e,i));x.children=b}return x}function b2(r){if(r.vertices.length===0||r.indices.length===0)return null;const e=new Rm(r.vertices,r.indices,8,256),[i,s]=[e.min.clone(),e.max.clone()];return{vertices:r.vertices,indices:r.indices,grid:e,min:i,max:s}}function w2(r){if(!r.extras||!r.extras.ground)return null;const e=r.extras.ground;if(!e||!Array.isArray(e)||e.length===0)return null;const i=e[0];if(!i||!Array.isArray(i)||i.length===0)return null;const s=[];for(const h of i){if(!Array.isArray(h)||h.length!==2)continue;const p=h[0],_=h[1];typeof p=="number"&&typeof _=="number"&&s.push(new ut(p,_))}if(s.length<3)return null;s.length>1&&s[s.length-1].equals(s[0])&&s.pop();let a=0;for(let h=0;h<s.length;h++){const p=s[h],_=s[(h+1)%s.length],g=s[(h+2)%s.length];a+=(p.x-_.x)*(g.y-_.y)-(g.x-_.x)*(p.y-_.y)}a>0&&s.reverse();const u=$h(s.flatMap(h=>[h.x,h.y]),[]);return u.length===0?null:{vertices:s,indices:u}}function T2(r,e){const i=[],s=[];let a=0;const u=[];for(const h of r){a=i.length;const p=h.vertexArray.float32,_=h.indexArray.uint16;for(let g=0;g<h.vertexArray.length;g++)u[0]=p[3*g+0],u[1]=p[3*g+1],u[2]=p[3*g+2],ji(u,u,e),i.push(new ut(u[0],u[1]));for(let g=0;g<3*h.indexArray.length;g++)s.push(_[g]+a)}if(s.length%3!=0)return null;for(let h=0;h<s.length;h+=3){const p=i[s[h+0]],_=i[s[h+1]],g=i[s[h+2]];(p.x-_.x)*(g.y-_.y)-(g.x-_.x)*(p.y-_.y)>0&&([s[h+1],s[h+2]]=[s[h+2],s[h+1]])}return{vertices:i,indices:s}}function r0(r){const e=function(_,g){const x=[],b=WebGL2RenderingContext;if(_.json.textures)for(const w of _.json.textures){const E={magFilter:b.LINEAR,minFilter:b.NEAREST,wrapS:b.REPEAT,wrapT:b.REPEAT};w.sampler!==void 0&&Object.assign(E,_.json.samplers[w.sampler]),x.push({image:g[w.source],sampler:E,uploaded:!1})}return x}(r,r.images),i=function(_,g){const x=[];for(const b of _.json.meshes){const w=[];for(const E of b.primitives)w.push(x2(E,_,g));x.push(w)}return x}(r,e),{scenes:s,scene:a,nodes:u}=r.json,h=s?s[a||0].nodes:u,p=[];for(const _ of h)p.push(i0(u[_],r,i));return function(_,g,x){const b={},w=new Set;for(let E=0;E<_.length;E++){const A=x[g[E]];if(!A.extras)continue;const P=A.extras["mapbox:footprint:version"],L=A.extras["mapbox:footprint:id"];(P||L)&&w.add(E),P==="1.0.0"&&L&&(b[L]=E)}for(let E=0;E<_.length;E++){if(w.has(E))continue;const A=_[E],P=x[g[E]];if(!P.extras)continue;let L=null;A.id in b&&(L=T2(_[b[A.id]].meshes,A.matrix)),L||(L=w2(P)),L&&(A.footprint=b2(L))}if(w.size>0){const E=Array.from(w.values()).sort((A,P)=>A-P);for(let A=E.length-1;A>=0;A--)_.splice(E[A],1)}}(p,h,r.json.nodes),p}function S2(r){r.heightmap=new Float32Array(4096),r.heightmap.fill(-1);const e=r.vertexArray.float32,i=r.aabb.min[0]-1,s=r.aabb.min[1]-1,a=lc/(r.aabb.max[0]-i+2),u=lc/(r.aabb.max[1]-s+2);for(let h=0;h<e.length;h+=3){const p=e[h+2],_=(e[h+0]-i)*a|0,g=(e[h+1]-s)*u|0;p>r.heightmap[g*lc+_]&&(r.heightmap[g*lc+_]=p)}}function E2(r,e){const i={};i.indexArray=new en,i.indexArray.reserve(4*r.length),i.vertexArray=new ys,i.vertexArray.reserve(10*r.length),i.colorArray=new Qr,i.vertexArray.reserve(10*r.length);let s=0;for(const h of r){const p=Math.min(10,Math.max(4,1.3*h.height))*e,_=[-h.normal[1],h.normal[0],0],g=Math.min(.29,.1*h.width/h.depth),x=h.width-2*h.depth*e*(g+.01),b=fn([],h.pos,_,x/2),w=fn([],h.pos,_,-x/2),E=[b[0],b[1],b[2]+h.height],A=[w[0],w[1],w[2]+h.height],P=fn([],h.normal,_,g);rr(P,P,p);const L=fn([],h.normal,_,-g);rr(L,L,p),zr(P,b,P),zr(L,w,L),b[2]+=.1,w[2]+=.1,i.vertexArray.emplaceBack(P[0],P[1],P[2]),i.vertexArray.emplaceBack(L[0],L[1],L[2]),i.vertexArray.emplaceBack(b[0],b[1],b[2]),i.vertexArray.emplaceBack(w[0],w[1],w[2]),i.vertexArray.emplaceBack(E[0],E[1],E[2]),i.vertexArray.emplaceBack(A[0],A[1],A[2]),i.vertexArray.emplaceBack(b[0],b[1],b[2]),i.vertexArray.emplaceBack(w[0],w[1],w[2]),i.vertexArray.emplaceBack(P[0],P[1],P[2]),i.vertexArray.emplaceBack(L[0],L[1],L[2]);const k=x/p/2;i.colorArray.emplaceBack(-k-g,-1,k,.8),i.colorArray.emplaceBack(k+g,-1,k,.8),i.colorArray.emplaceBack(-k,0,k,1.3),i.colorArray.emplaceBack(k,0,k,1.3),i.colorArray.emplaceBack(k+g,-.8,k,.7),i.colorArray.emplaceBack(k+g,-.8,k,.7),i.colorArray.emplaceBack(0,0,k,1.3),i.colorArray.emplaceBack(0,0,k,1.3),i.colorArray.emplaceBack(k+g,-1.2,k,.8),i.colorArray.emplaceBack(k+g,-1.2,k,.8),i.indexArray.emplaceBack(6+s,4+s,8+s),i.indexArray.emplaceBack(7+s,9+s,5+s),i.indexArray.emplaceBack(0+s,1+s,2+s),i.indexArray.emplaceBack(1+s,3+s,2+s),s+=10}const a={defined:!0};a.emissiveFactor=Pi.black;const u={};return u.baseColorFactor=Pi.white,a.pbrMetallicRoughness=u,i.material=a,i.aabb=new Ti([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),i}Sp.performDecoding=function(r,e){const i=new Uint8Array(r);return Promise.all(e.tasks.map(s=>{const{layerName:a,firstByte:u,lastByte:h,pixelFormat:p,blockShape:_,blockIndex:g,filters:x,codec:b}=s,w=i.subarray(u,h+1),E=new Uint32Array(_[0]*_[1]*_[2]);let A;if(b!=="gzip_data")throw new ws(`Unhandled codec: ${b}`);return A=function(P,L){if(!globalThis.DecompressionStream&&L==="gzip_data")return Promise.resolve(((R=function(Z){Z[0]==31&&Z[1]==139&&Z[2]==8||$s(6,"invalid gzip data");var ae=Z[3],ne=10;4&ae&&(ne+=2+(Z[10]|Z[11]<<8));for(var ce=(ae>>3&1)+(ae>>4&1);ce>0;ce-=!Z[ne++]);return ne+(2&ae)}(G=P))+8>G.length&&$s(6,"invalid gzip data"),function(Z,ae,ne,ce){var me=Z.length;if(!me||ae.f&&!ae.l)return ne||new ds(0);var Re=!ne,Xe=Re||ae.i!=2,Ve=ae.i;Re&&(ne=new ds(3*me));var We,Ke,Le=function(Pr){var ar=ne.length;if(Pr>ar){var Yi=new ds(Math.max(2*ar,Pr));Yi.set(ne),ne=Yi}},He=ae.f||0,Me=ae.p||0,ze=ae.b||0,et=ae.l,it=ae.d,Ot=ae.m,At=ae.n,pt=8*me;do{if(!et){He=qs(Z,Me,1);var Qe=qs(Z,Me+1,3);if(Me+=3,!Qe){var Xt=Z[($=4+((Me+7)/8|0))-4]|Z[$-3]<<8,Et=$+Xt;if(Et>me){Ve&&$s(0);break}Xe&&Le(ze+Xt),ne.set(Z.subarray($,Et),ze),ae.b=ze+=Xt,ae.p=Me=8*Et,ae.f=He;continue}if(Qe==1)et=d2,it=f2,Ot=9,At=5;else if(Qe==2){var Mt=qs(Z,Me,31)+257,jt=qs(Z,Me+10,15)+4,Qt=Mt+qs(Z,Me+5,31)+1;Me+=14;for(var Jt=new ds(Qt),ai=new ds(19),ii=0;ii<jt;++ii)ai[c2[ii]]=qs(Z,Me+3*ii,7);Me+=3*jt;var li=E_(ai),Li=(1<<li)-1,er=xd(ai,li);for(ii=0;ii<Qt;){var $,W=er[qs(Z,Me,Li)];if(Me+=15&W,($=W>>4)<16)Jt[ii++]=$;else{var De=0,lt=0;for($==16?(lt=3+qs(Z,Me,3),Me+=2,De=Jt[ii-1]):$==17?(lt=3+qs(Z,Me,7),Me+=3):$==18&&(lt=11+qs(Z,Me,127),Me+=7);lt--;)Jt[ii++]=De}}var mt=Jt.subarray(0,Mt),ft=Jt.subarray(Mt);Ot=E_(mt),At=E_(ft),et=xd(mt,Ot),it=xd(ft,At)}else $s(1);if(Me>pt){Ve&&$s(0);break}}Xe&&Le(ze+131072);for(var St=(1<<Ot)-1,Vt=(1<<At)-1,hi=Me;;hi=Me){var di=(De=et[I_(Z,Me)&St])>>4;if((Me+=15&De)>pt){Ve&&$s(0);break}if(De||$s(2),di<256)ne[ze++]=di;else{if(di==256){hi=Me,et=null;break}var ri=di-254;di>264&&(ri=qs(Z,Me,(1<<(fi=Hx[ii=di-257]))-1)+Yx[ii],Me+=fi);var Bi=it[I_(Z,Me)&Vt],Xi=Bi>>4;if(Bi||$s(3),Me+=15&Bi,ft=h2[Xi],Xi>3){var fi=Zx[Xi];ft+=I_(Z,Me)&(1<<fi)-1,Me+=fi}if(Me>pt){Ve&&$s(0);break}Xe&&Le(ze+131072);var yr=ze+ri;if(ze<ft){var tr=0-ft,Di=Math.min(ft,yr);for(tr+ze<0&&$s(3);ze<Di;++ze)ne[ze]=(void 0)[tr+ze]}for(;ze<yr;++ze)ne[ze]=ne[ze-ft]}}ae.l=et,ae.p=hi,ae.b=ze,ae.f=He,et&&(He=1,ae.m=Ot,ae.d=it,ae.n=At)}while(!He);return ze!=ne.length&&Re?(We=ne,((Ke=ze)==null||Ke>We.length)&&(Ke=We.length),new ds(We.subarray(0,Ke))):ne.subarray(0,ze)}(G.subarray(R,-8),{i:2},new ds(((k=G)[(j=k.length)-4]|k[j-3]<<8|k[j-2]<<16|k[j-1]<<24)>>>0))));var k,j,G,R;const N=g2[L];if(!N)throw new Error(`Unhandled codec: ${L}`);const q=new globalThis.DecompressionStream(N);return new Response(new Blob([P]).stream().pipeThrough(q)).arrayBuffer().then(Z=>new Uint8Array(Z))}(w,b).then(P=>(function(L,k){L.readFields(r2,k)}(new A_(P),E),new v2[p](E.buffer))),A.then(P=>{for(let L=x.length-1;L>=0;L--)switch(x[L]){case"delta_filter":s2(P,_);break;case"zigzag_filter":o2(P);break;case"bitshuffle_filter":a2(P,p);break;default:throw new ws(`Unhandled filter "${x[L]}"`)}return{layerName:a,blockIndex:g,data:P}}).catch(P=>{throw P})}))},bt(t0,"MRTDecodingBatch",{omit:["_onCancel","_onComplete"]}),bt(Sp,"MapboxRasterTile"),bt(e0,"MapboxRasterLayer",{omit:["_blocksInProgress"]});class n0{constructor(e){this._stringToNumber={},this._numberToString=[];for(let i=0;i<e.length;i++){const s=e[i];this._stringToNumber[s]=i,this._numberToString[i]=s}}encode(e){return this._stringToNumber[e]}decode(e){return this._numberToString[e]}}const I2=["id","tile","layer","source","sourceLayer","state"];class Pu{constructor(e,i,s,a,u){this.type="Feature",this._vectorTileFeature=e,this._z=i,this._x=s,this._y=a,this.properties=e.properties,this.id=u}clone(){const e=new Pu(this._vectorTileFeature,this._z,this._x,this._y,this.id);return this.state&&(e.state=Object.assign({},this.state)),this.layer&&(e.layer=Object.assign({},this.layer)),this.source&&(e.source=this.source),this.sourceLayer&&(e.sourceLayer=this.sourceLayer),e}get geometry(){return this._geometry===void 0&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(e){this._geometry=e}toJSON(){const e={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};for(const i of I2)this[i]!==void 0&&(e[i]=this[i]);return e}}class s0{constructor(e,i){this.tileID=e,this.x=e.canonical.x,this.y=e.canonical.y,this.z=e.canonical.z,this.grid=new Os(dt,16,0),this.featureIndexArray=new wf,this.promoteId=i,this.is3DTile=!1,this.serializedLayersCache=new Map}insert(e,i,s,a,u,h=0,p=0){const _=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(s,a,u,h);const g=this.grid;for(let x=0;x<i.length;x++){const b=i[x],w=[1/0,1/0,-1/0,-1/0];for(let E=0;E<b.length;E++){const A=b[E];w[0]=Math.min(w[0],A.x),w[1]=Math.min(w[1],A.y),w[2]=Math.max(w[2],A.x),w[3]=Math.max(w[3],A.y)}p!==0&&(w[0]-=p,w[1]-=p,w[2]+=p,w[3]+=p),w[0]<dt&&w[1]<dt&&w[2]>=0&&w[3]>=0&&g.insert(_,w[0],w[1],w[2],w[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new ni.VectorTile(new Zf(this.rawTileData)).layers,this.sourceLayerCoder=new n0(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(const e in this.vtLayers)this.vtFeatures[e]=[]}return this.vtLayers}query(e,i){const{tilespaceGeometry:s,transform:a,tileTransform:u,pixelPosMatrix:h,availableImages:p,worldview:_}=i;this.loadVTLayers(),this.serializedLayersCache.clear();const g=s.bufferedTilespaceBounds,x=this.grid.query(g.min.x,g.min.y,g.max.x,g.max.y,(A,P,L,k)=>$a(s.bufferedTilespaceGeometry,A,P,L,k));x.sort(A2);let b=null;a.elevation&&x.length>0&&(b=Iu.create(a.elevation,this.tileID));const w={};let E;for(let A=0;A<x.length;A++){const P=x[A];if(P===E)continue;E=P;const L=this.featureIndexArray.get(P);let k=null;this.is3DTile?this.loadMatchingModelFeature(w,L,e,s,a,_):this.loadMatchingFeature(w,L,e,p,_,(j,G,R,N=0)=>(k||(k=Tt(j,this.tileID.canonical,u)),G.queryIntersectsFeature(s,j,R,k,this.z,a,h,b,N)))}return w}loadMatchingFeature(e,i,s,a,u,h){const{featureIndex:p,bucketIndex:_,sourceLayerIndex:g,layoutVertexArrayOffset:x}=i,b=this.bucketLayerIDs[_],w=s.layers,E=Object.keys(w);if(E.length&&!Yt(E,b))return;const A=s.sourceCache,P=this.sourceLayerCoder.decode(g),L=this.vtLayers[P].feature(p),k=this.getId(L,P);for(let j=0;j<b.length;j++){const G=b[j];if(!w[G])continue;const{styleLayer:R,targets:N}=w[G];let q={};k!==void 0&&(q=A.getFeatureState(R.sourceLayer,k));const Z=!h||h(L,R,q,x);if(!Z)continue;const ae=new Pu(L,this.z,this.x,this.y,k);ae.tile=this.tileID.canonical,ae.state=q;let ne=this.serializedLayersCache.get(G);ne||(ne=R.serialize(),ne.id=G,this.serializedLayersCache.set(G,ne)),ae.source=ne.source,ae.sourceLayer=ne["source-layer"],ae.layer=we({},ne),ae.layer.paint=o0(ne.paint,R.paint,L,q,a),ae.layer.layout=o0(ne.layout,R.layout,L,q,a);let ce=!1;for(const me of N){this.updateFeatureProperties(ae,me);const{filter:Re}=me;if(Re){if(L.properties=ae.properties,Re.needGeometry){const Xe=gt(L,!0);if(!Re.filter(new Gi(this.tileID.overscaledZ,{worldview:u}),Xe,this.tileID.canonical))continue}else if(!Re.filter(new Gi(this.tileID.overscaledZ,{worldview:u}),L))continue}ce=!0,me.targetId&&this.addFeatureVariant(ae,me)}ce&&this.appendToResult(e,G,p,ae,Z)}}loadMatchingModelFeature(e,i,s,a,u,h){const{featureIndex:p,bucketIndex:_}=i,g=this.bucketLayerIDs[_],x=s.layers,b=Object.keys(x);if(!b.length||Yt(b,g))for(let w=0;w<g.length;w++){const E=g[w],{styleLayer:A,targets:P}=x[E];if(A.type!=="model")continue;const L=a.tile,k=L.getBucket(A);if(!(k&&k instanceof gp))continue;const j=Iw(k,p,a,u);if(!j)continue;const{z:G,x:R,y:N}=L.tileID.canonical,{feature:q,intersectionZ:Z,position:ae}=j;let ne={};q.id!==void 0&&(ne=s.sourceCache.getFeatureState(A.sourceLayer,q.id));const ce=new Pu({},G,R,N,q.id);ce.tile=this.tileID.canonical,ce.state=ne,ce.properties=q.properties,ce.geometry={type:"Point",coordinates:[ae.lng,ae.lat]};let me=this.serializedLayersCache.get(E);me||(me=A.serialize(),me.id=E,this.serializedLayersCache.set(E,me)),ce.source=me.source,ce.sourceLayer=me["source-layer"],ce.layer=we({},me);let Re=!1;for(const Xe of P){this.updateFeatureProperties(ce,Xe);const{filter:Ve}=Xe;if(Ve){if(q.properties=ce.properties,Ve.needGeometry){if(!Ve.filter(new Gi(this.tileID.overscaledZ,{worldview:h}),q,this.tileID.canonical))continue}else if(!Ve.filter(new Gi(this.tileID.overscaledZ,{worldview:h}),q))continue}Re=!0,Xe.targetId&&this.addFeatureVariant(ce,Xe)}Re&&this.appendToResult(e,E,p,ce,Z)}}updateFeatureProperties(e,i,s){if(i.properties){const a={};for(const u in i.properties){const h=i.properties[u].evaluate({zoom:this.z},e._vectorTileFeature,e.state,e.tile,s);h!=null&&(a[u]=h)}e.properties=a}}addFeatureVariant(e,i,s){const a={target:i.target,namespace:i.namespace,uniqueFeatureID:i.uniqueFeatureID};i.properties&&(a.properties=e.properties),e.variants=e.variants||{},e.variants[i.targetId]=e.variants[i.targetId]||[],e.variants[i.targetId].push(a)}appendToResult(e,i,s,a,u){let h=e[i];h===void 0&&(h=e[i]=[]),h.push({featureIndex:s,feature:a,intersectionZ:u})}lookupSymbolFeatures(e,i,s,a,u,h){const p={};this.loadVTLayers();for(const _ of e)this.loadMatchingFeature(p,{bucketIndex:i,sourceLayerIndex:s,featureIndex:_,layoutVertexArrayOffset:0},a,u,h);return p}loadFeature(e){const{featureIndex:i,sourceLayerIndex:s}=e;this.loadVTLayers();const a=this.sourceLayerCoder.decode(s),u=this.vtFeatures[a];if(u[i])return u[i];const h=this.vtLayers[a].feature(i);return u[i]=h,h}hasLayer(e){for(const i of this.bucketLayerIDs)for(const s of i)if(e===s)return!0;return!1}getId(e,i){let s=e.id;if(this.promoteId){const a=Array.isArray(this.promoteId)||typeof this.promoteId!="object"?this.promoteId:this.promoteId[i];if(a!=null)if(Array.isArray(a)){if(!this.promoteIdExpression){const u=Ds(a);if(u.result!=="success"){const h=u.value.map(p=>`${p.key}: ${p.message}`).join(", ");return void ei(`Failed to create expression for promoteId: ${h}`)}this.promoteIdExpression=u.value}this.promoteIdExpression._evaluator||(this.promoteIdExpression._evaluator=new Tl),s=this.promoteIdExpression.evaluate({zoom:0},e)}else s=e.properties[a];typeof s=="boolean"&&(s=Number(s))}return s}}function o0(r,e,i,s,a){return Pt(r,(u,h)=>{const p=e instanceof Ko?e.get(h):null;return p&&p.evaluate?p.evaluate(i,s,void 0,a):p})}function A2(r,e){return e-r}bt(s0,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});const a0=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class M_{static from(e){if(!(e instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[i,s]=new Uint8Array(e,0,2);if(i!==219)throw new Error("Data does not appear to be in a KDBush format.");const a=s>>4;if(a!==1)throw new Error(`Got v${a} data when expected v1.`);const u=a0[15&s];if(!u)throw new Error("Unrecognized array type.");const[h]=new Uint16Array(e,2,1),[p]=new Uint32Array(e,4,1);return new M_(p,h,u,e)}constructor(e,i=64,s=Float64Array,a){if(isNaN(e)||e<0)throw new Error(`Unpexpected numItems value: ${e}.`);this.numItems=+e,this.nodeSize=Math.min(Math.max(+i,2),65535),this.ArrayType=s,this.IndexArrayType=e<65536?Uint16Array:Uint32Array;const u=a0.indexOf(this.ArrayType),h=2*e*this.ArrayType.BYTES_PER_ELEMENT,p=e*this.IndexArrayType.BYTES_PER_ELEMENT,_=(8-p%8)%8;if(u<0)throw new Error(`Unexpected typed array class: ${s}.`);a&&a instanceof ArrayBuffer?(this.data=a,this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+p+_,2*e),this._pos=2*e,this._finished=!0):(this.data=new ArrayBuffer(8+h+p+_),this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+p+_,2*e),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+u]),new Uint16Array(this.data,2,1)[0]=i,new Uint32Array(this.data,4,1)[0]=e)}add(e,i){const s=this._pos>>1;return this.ids[s]=s,this.coords[this._pos++]=e,this.coords[this._pos++]=i,s}finish(){const e=this._pos>>1;if(e!==this.numItems)throw new Error(`Added ${e} items when expected ${this.numItems}.`);return P_(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(e,i,s,a){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:u,coords:h,nodeSize:p}=this,_=[0,u.length-1,0],g=[];for(;_.length;){const x=_.pop()||0,b=_.pop()||0,w=_.pop()||0;if(b-w<=p){for(let L=w;L<=b;L++){const k=h[2*L],j=h[2*L+1];k>=e&&k<=s&&j>=i&&j<=a&&g.push(u[L])}continue}const E=w+b>>1,A=h[2*E],P=h[2*E+1];A>=e&&A<=s&&P>=i&&P<=a&&g.push(u[E]),(x===0?e<=A:i<=P)&&(_.push(w),_.push(E-1),_.push(1-x)),(x===0?s>=A:a>=P)&&(_.push(E+1),_.push(b),_.push(1-x))}return g}within(e,i,s){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:a,coords:u,nodeSize:h}=this,p=[0,a.length-1,0],_=[],g=s*s;for(;p.length;){const x=p.pop()||0,b=p.pop()||0,w=p.pop()||0;if(b-w<=h){for(let L=w;L<=b;L++)c0(u[2*L],u[2*L+1],e,i)<=g&&_.push(a[L]);continue}const E=w+b>>1,A=u[2*E],P=u[2*E+1];c0(A,P,e,i)<=g&&_.push(a[E]),(x===0?e-s<=A:i-s<=P)&&(p.push(w),p.push(E-1),p.push(1-x)),(x===0?e+s>=A:i+s>=P)&&(p.push(E+1),p.push(b),p.push(1-x))}return _}}function P_(r,e,i,s,a,u){if(a-s<=i)return;const h=s+a>>1;l0(r,e,h,s,a,u),P_(r,e,i,s,h-1,1-u),P_(r,e,i,h+1,a,1-u)}function l0(r,e,i,s,a,u){for(;a>s;){if(a-s>600){const g=a-s+1,x=i-s+1,b=Math.log(g),w=.5*Math.exp(2*b/3),E=.5*Math.sqrt(b*w*(g-w)/g)*(x-g/2<0?-1:1);l0(r,e,i,Math.max(s,Math.floor(i-x*w/g+E)),Math.min(a,Math.floor(i+(g-x)*w/g+E)),u)}const h=e[2*i+u];let p=s,_=a;for(wd(r,e,s,i),e[2*a+u]>h&&wd(r,e,s,a);p<_;){for(wd(r,e,p,_),p++,_--;e[2*p+u]<h;)p++;for(;e[2*_+u]>h;)_--}e[2*s+u]===h?wd(r,e,s,_):(_++,wd(r,e,_,a)),_<=i&&(s=_+1),i<=_&&(a=_-1)}}function wd(r,e,i,s){R_(r,i,s),R_(e,2*i,2*s),R_(e,2*i+1,2*s+1)}function R_(r,e,i){const s=r[e];r[e]=r[i],r[i]=s}function c0(r,e,i,s){const a=r-i,u=e-s;return a*a+u*u}o.$=Yr,o.A=Fo,o.B=zs,o.C=Qo,o.D=gu,o.E=Bo,o.F=2,o.G=ld,o.H=Av,o.I=Ln,o.J=no,o.K=class extends mp{},o.L=Vo,o.M=ls,o.N=Ll,o.O=zl,o.P=ut,o.Q=_h,o.R=fl,o.S=Zc,o.T=h_,o.U=Kc,o.V=mp,o.W=tf,o.X=Ds,o.Y=Dc,o.Z=Ia,o._=Ea,o.a=function(r){return Jr.API_CDN_URL_REGEX.test(r)},o.a$=Ie,o.a0=No,o.a1=Jc,o.a2=Dl,o.a3=mh,o.a4=function(r){const e=r.value;let i=[];if(!e)return i;const s=no(e);return s!=="string"?(i=i.concat([new mp(r.key,e,`string expected, "${s}" found`)]),i):(m_(e,!0)||(i=i.concat([new mp(r.key,e,`invalid url "${e}"`)])),i)},o.a5=ge,o.a6=lf,o.a7=br,o.a8=Je,o.a9=class{constructor(r){this.specification=r}possiblyEvaluate(r,e){return ur(r.expression.evaluate(e))}interpolate(r,e,i){return{x:Ut(r.x,e.x,i),y:Ut(r.y,e.y,i),z:Ut(r.z,e.z,i),azimuthal:Ut(r.azimuthal,e.azimuthal,i),polar:Ut(r.polar,e.polar,i)}}},o.aA=_n,o.aB=m,o.aC=bs,o.aD=J,o.aE=Se,o.aF=function(r,e){const i={};for(let s=0;s<e.length;s++){const a=e[s];a in r&&(i[a]=r[a])}return i},o.aG=H,o.aH=K,o.aI=class{constructor(r){this.entries={},this.scheduler=r}request(r,e,i,s){const a=this.entries[r]=this.entries[r]||{callbacks:[]};if(a.result){const[u,h]=a.result;return this.scheduler?this.scheduler.add(()=>{s(u,h)},e):s(u,h),()=>{}}return a.callbacks.push(s),a.cancel||(a.cancel=i((u,h)=>{a.result=[u,h];for(const p of a.callbacks)this.scheduler?this.scheduler.add(()=>{p(u,h)},e):p(u,h);setTimeout(()=>delete this.entries[r],3e3)})),()=>{a.result||(a.callbacks=a.callbacks.filter(u=>u!==s),a.callbacks.length||(a.cancel(),delete this.entries[r]))}}},o.aJ=function(r,e,i){const s=JSON.stringify(r.request);return r.data&&(this.deduped.entries[s]={result:[null,r.data]}),this.deduped.request(s,{type:"parseTile",isSymbolTile:r.isSymbolTile,zoom:r.tileZoom},a=>{const u=pl(r.request,(h,p,_,g)=>{h?a(h):p&&a(null,{vectorTile:i?void 0:new ni.VectorTile(new Zf(p)),rawData:p,cacheControl:_,expires:g})});return()=>{u.cancel(),a()}},e)},o.aK=function(r){Bu++,Bu>Ms&&(r.getActor().send("enforceCacheSizeLimit",ss),Bu=0)},o.aL=function(r){return r<=1?1:Math.pow(2,Math.floor(Math.log(r)/Math.LN2))},o.aM=wn,o.aN=ix,o.aO=lx,o.aP=tx,o.aQ=function(r,e){const i=document.createElement("video");i.muted=!0,i.onloadstart=function(){e(null,i)};for(let s=0;s<r.length;s++){const a=document.createElement("source");Lp(r[s])||(i.crossOrigin="Anonymous"),a.src=r[s],i.appendChild(a)}return{cancel:()=>{}}},o.aR=up,o.aS=function(r){return fetch(r).then(e=>e.arrayBuffer()).then(e=>Hy(e,0,r))},o.aT=r0,o.aU=class{constructor(r,e,i,s){this.id=r,this.position=e!=null?new V(e[0],e[1]):new V(0,0),this.orientation=i??[0,0,0],this.nodes=s,this.uploaded=!1,this.aabb=new Ti([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),this.matrix=[]}_applyTransformations(r,e){if(at(r.matrix,e,r.matrix),r.meshes)for(const i of r.meshes){const s=Ti.applyTransformFast(i.aabb,r.matrix);this.aabb.encapsulate(s)}if(r.children)for(const i of r.children)this._applyTransformations(i,r.matrix)}computeBoundsAndApplyParent(){const r=re([]);for(const e of this.nodes)this._applyTransformations(e,r)}computeModelMatrix(r,e,i,s,a,u,h=!1){vx(this.matrix,this,r.transform,this.position,e,i,s,a,u,h)}upload(r){if(!this.uploaded){for(const e of this.nodes)g_(e,r);for(const e of this.nodes)_p(e);this.uploaded=!0}}destroy(){for(const r of this.nodes)y_(r)}},o.aV=Ct,o.aW=ud,o.aX=se,o.aY=ye,o.aZ=Oa,o.a_=en,o.aa=Gi,o.ab=kl,o.ac=ue,o.ad=ji,o.ae=Rr,o.af=de,o.ag=Ko,o.ah=Ha,o.ai=Ut,o.aj=dt,o.ak=wc,o.al=wi,o.am=Pi,o.an=class{constructor(r){this.specification=r}possiblyEvaluate(r,e){return function([i,s]){const a=ur([1,i,s]);return{x:a.x,y:a.y,z:a.z}}(r.expression.evaluate(e))}interpolate(r,e,i){return{x:Ut(r.x,e.x,i),y:Ut(r.y,e.y,i),z:Ut(r.z,e.z,i)}}},o.ao=function(r,e,i=0,s=!0){const a=new ut(i,i),u=r.sub(a),h=e.add(a),p=[u,new ut(h.x,u.y),h,new ut(u.x,h.y)];return s&&p.push(u.clone()),p},o.ap=function(r,e){const i=[];for(let s=0;s<r.length;s++){const a=xe(s-1,-1,r.length-1),u=xe(s+1,-1,r.length-1),h=r[s],p=r[u],_=r[a].sub(h).unit(),g=p.sub(h).unit(),x=g.angleWithSep(_.x,_.y),b=_.add(g).unit().mult(-1*e/Math.sin(x/2));i.push(h.add(b))}return i},o.aq=Uv,o.ar=$a,o.as=function(r,e,i=0){return Ei(((e.x-i)*r.scale-r.x)*dt,(e.y*r.scale-r.y)*dt,ve(e.z,e.y))},o.at=Br,o.au=mr,o.av=sr,o.aw=Qy,o.ax=function(r){let e=1/0,i=1/0,s=-1/0,a=-1/0;for(const u of r)e=Math.min(e,u.x),i=Math.min(i,u.y),s=Math.max(s,u.x),a=Math.max(a,u.y);return{min:new ut(e,i),max:new ut(s,a)}},o.ay=Q,o.az=at,o.b=function(r){return Jr.API_FONTS_REGEX.test(r)},o.b$=function(r,e,i){i*=.5;var s=e[0],a=e[1],u=e[2],h=e[3],p=Math.sin(i),_=Math.cos(i);return r[0]=s*_+a*p,r[1]=a*_-s*p,r[2]=u*_+h*p,r[3]=h*_-u*p,r},o.b0=ou,o.b1=lp,o.b2=function(){Bs.isLoading()||Bs.isLoaded()||za()!=="deferred"||af()},o.b3=wh,o.b4=gt,o.b5=Pu,o.b6=Ii,o.b7=Gm,o.b8=Pm,o.b9=Tt,o.bA=function(r,e){const{x:i,y:s}=r.point,a=zg(i,s,r.worldSize/r._pixelsPerMercatorPixel,0,0);return at(a,a,xm(wo(e)))},o.bB=ot,o.bC=function(r){return r[0]=0,r[1]=0,r[2]=0,r},o.bD=function(r,e){return Math.hypot(e[0]-r[0],e[1]-r[1],e[2]-r[2])},o.bE=fn,o.bF=$i,o.bG=Ar,o.bH=ad,o.bI=Zn,o.bJ=Km,o.bK=function(r,e,i,s,a){const u=5*e+2;r.float32[u+0]=i,r.float32[u+1]=s,r.float32[u+2]=a},o.bL=ap,o.bM=Gf,o.bN=Cn,o.bO=Kr,o.bP=ly,o.bQ=px,o.bR=fy,o.bS=py,o.bT=Ym,o.bU=Dv,o.bV=t_,o.bW=M_,o.bX=xe,o.bY=rr,o.bZ=Ws,o.b_=Xs,o.ba=Ns,o.bb=Hl,o.bc=Ig,o.bd=Tr,o.be=$h,o.bf=l_,o.bg=function(r,e){const i=Ha(e.zoom);if(i===0)return wo(r);const s=zf(r),a=vm(s),u=J(s.getWest())*e.worldSize,h=J(s.getEast())*e.worldSize,p=K(s.getNorth())*e.worldSize,_=K(s.getSouth())*e.worldSize,g=[u,p,0],x=[h,p,0],b=[u,_,0],w=[h,_,0],E=Ge([],e.globeMatrix);return ji(g,g,E),ji(x,x,E),ji(b,b,E),ji(w,w,E),a[0]=ia(a[0],b,i),a[1]=ia(a[1],w,i),a[2]=ia(a[2],x,i),a[3]=ia(a[3],g,i),Ti.fromPoints(a)},o.bh=Df,o.bi=Ge,o.bj=Gh,o.bk=ia,o.bl=Ul,o.bm=g1,o.bn=yt,o.bo=It,o.bp=Sp,o.bq=Zf,o.br=pl,o.bs=function(r,e){const i=[];for(const s in r)s in e||i.push(s);return i},o.bt=fe,o.bu=["type","source","source-layer","minzoom","maxzoom","filter","layout"],o.bv=As,o.bw=function(r){var e=new Ce(16);return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[8]=r[8],e[9]=r[9],e[10]=r[10],e[11]=r[11],e[12]=r[12],e[13]=r[13],e[14]=r[14],e[15]=r[15],e},o.bx=re,o.by=Ye,o.bz=st,o.c=fc,o.c$=qf,o.c0=Ys,o.c1=xr,o.c2=function(r,e){return r[0]=-e[0],r[1]=-e[1],r[2]=-e[2],r[3]=e[3],r},o.c3=gi,o.c4=function(r,e,i,s,a){var u,h=1/Math.tan(e/2);return r[0]=h/i,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=h,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=-1,r[12]=0,r[13]=0,r[15]=0,a!=null&&a!==1/0?(r[10]=(a+s)*(u=1/(s-a)),r[14]=2*a*s*u):(r[10]=-1,r[14]=-2*s),r},o.c5=function(r,e,i,s,a,u,h){var p=1/(e-i),_=1/(s-a),g=1/(u-h);return r[0]=-2*p,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=-2*_,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=2*g,r[11]=0,r[12]=(e+i)*p,r[13]=(a+s)*_,r[14]=(h+u)*g,r[15]=1,r},o.c6=ie,o.c7=function(r,e,i){r[4*e+0]=i[0],r[4*e+1]=i[1],r[4*e+2]=i[2],r[4*e+3]=i[3]},o.c8=uu,o.c9=Yl,o.cA=fp,o.cB=xi,o.cC=cx,o.cD=function(r){const e=cx(r,!0);return ot([],[e[0],e[1],e[4],e[5]])},o.cE=vt,o.cF=Wi,o.cG=nt,o.cH=function(r){const{x:e,y:i}=r.point,{lng:s,lat:a}=r._center;return zg(e,i,r.worldSize,s,a)},o.cI=Nn,o.cJ=Ee,o.cK=mu,o.cL=y,o.cM=function(r,e,i){let s=0;for(let a=0;a<2;++a)r[a]>0&&(s+=(r[a]-0)*(r[a]-0)),e[a]<0&&(s+=(0-e[a])*(0-e[a]));return s},o.cN=function(r){return r*r*r*r*r},o.cO=ee,o.cP=45,o.cQ=hu,o.cR=function(r,e,i){const s=Math.sqrt(r*r+e*e+i*i),a=s>0?Math.acos(i/s)*sl:0;let u=r!==0||e!==0?Math.atan2(-e,-r)*sl+90:0;return u<0&&(u+=360),[s,u,a]},o.cS=Ei,o.cT=ur,o.cU=Pe,o.cV=zr,o.cW=Ti,o.cX=Or,o.cY=function(r){return[Math.pow(r[0],1/2.2),Math.pow(r[1],1/2.2),Math.pow(r[2],1/2.2)]},o.cZ=m_,o.c_=function(r,e){return r.readFields(Mw,{icons:[]},e)},o.ca=kr,o.cb=vs,o.cc=Ua,o.cd=V,o.ce=Hv,o.cf=function(){var r=new Ce(4);return Ce!=Float32Array&&(r[1]=0,r[2]=0),r[0]=1,r[3]=1,r},o.cg=function(r,e,i){var s=e[0],a=e[1],u=e[2],h=e[3],p=Math.sin(i),_=Math.cos(i);return r[0]=s*_+u*p,r[1]=a*_+h*p,r[2]=s*-p+u*_,r[3]=a*-p+h*_,r},o.ch=function(r,e){return r[0]===e[0]&&r[1]===e[1]&&r[2]===e[2]&&r[3]===e[3]},o.ci=rs,o.cj=function(r){return Math.hypot(r[0],r[1],r[2],r[3])},o.ck=Is,o.cl=Es,o.cm=Eg,o.cn=dr,o.co=ux,o.cp=tc,o.cq=Mg,o.cr=function(r,e,i,s,a,u,h,p,_){if(_.name==="globe")return Mg(r,e,new tc(i,s,a),!1);const g=ud({z:i,x:s,y:a},_);return new Ti([(u+g.x/g.scale)*e,e*(g.y/g.scale),h],[(u+g.x2/g.scale)*e,e*(g.y2/g.scale),p])},o.cs=function(r,e,i){return r[0]=Math.min(e[0],i[0]),r[1]=Math.min(e[1],i[1]),r[2]=Math.min(e[2],i[2]),r[3]=Math.min(e[3],i[3]),r},o.ct=function(r,e,i){return r[0]=Math.max(e[0],i[0]),r[1]=Math.max(e[1],i[1]),r[2]=Math.max(e[2],i[2]),r[3]=Math.max(e[3],i[3]),r},o.cu=function(r){const e=Math.round((r+45+360)%360/90)%4;return F[e]},o.cv=Oe,o.cw=Co,o.cx=v,o.cy=function(r){const e=re(new Float64Array(16));at(e,r.pixelMatrix,r.globeMatrix);const i=[0,I,0],s=[0,M,0];return ji(i,i,e),ji(s,s,e),[i[0]>0&&i[0]<=r.width&&i[1]>0&&i[1]<=r.height&&!wm(r,new V(r.center.lat,90)),s[0]>0&&s[0]<=r.width&&s[1]>0&&s[1]<=r.height&&!wm(r,new V(r.center.lat,-90))]},o.cz=function(r,e){const{scale:i}=r.tileTransform,s=i*dt/(r.tileSize*Math.pow(2,e.zoom-r.tileID.overscaledZ+r.tileID.canonical.z));return function(a,u,h){var p=u[1],_=u[2],g=u[3],x=h[0],b=h[1];return a[0]=u[0]*x,a[1]=p*x,a[2]=_*b,a[3]=g*b,a}(new Float32Array(4),e.inverseAdjustmentMatrix,[s,s])},o.d=function(r){return Jr.API_TILEJSON_REGEX.test(r)},o.d$=Oh,o.d0=wu,o.d1=Qm,o.d2=gc,o.d3=Yo,o.d4=Xn,o.d5=_l,o.d6=Wt,o.d7=function(r){const e=r.indexOf(Nl);return e>=0?r.slice(0,e):r},o.d8=function(r){return r.indexOf(Nl)>=0},o.d9=function(r){const e=r.lastIndexOf(Nl);return e>=0?r.slice(e+1):""},o.dA=Rg,o.dB=Sn,o.dC=ln,o.dD=256,o.dE=function(r,e){const i=[0,0,0];return ji(i,i,Df(wo(e.canonical))),ji(i,i,r),i},o.dF=r=>({u_matrix:new Ua(r),u_texsize:new vs(r),u_pixels_to_tile_units:new Kl(r),u_device_pixel_ratio:new kr(r),u_width_scale:new kr(r),u_floor_width_scale:new kr(r),u_image:new uu(r),u_units_to_pixels:new vs(r),u_tile_units_to_pixels:new kr(r),u_alpha_discard_threshold:new kr(r),u_trim_offset:new vs(r),u_trim_fade_range:new vs(r),u_trim_color:new hu(r),u_emissive_strength:new kr(r),u_zbias_factor:new kr(r),u_tile_to_meter:new kr(r),u_ground_shadow_factor:new Yl(r),u_pattern_transition:new kr(r)}),o.dG=r=>({u_matrix:new Ua(r),u_pixels_to_tile_units:new Kl(r),u_device_pixel_ratio:new kr(r),u_width_scale:new kr(r),u_floor_width_scale:new kr(r),u_units_to_pixels:new vs(r),u_dash_image:new uu(r),u_gradient_image:new uu(r),u_image_height:new kr(r),u_texsize:new vs(r),u_tile_units_to_pixels:new kr(r),u_alpha_discard_threshold:new kr(r),u_trim_offset:new vs(r),u_trim_fade_range:new vs(r),u_trim_color:new hu(r),u_emissive_strength:new kr(r),u_zbias_factor:new kr(r),u_tile_to_meter:new kr(r),u_ground_shadow_factor:new Yl(r)}),o.dH=r=>({u_camera_to_center_distance:new kr(r),u_extrude_scale:new Kl(r),u_device_pixel_ratio:new kr(r),u_matrix:new Ua(r),u_inv_rot_matrix:new Ua(r),u_merc_center:new vs(r),u_tile_id:new Yl(r),u_zoom_transition:new kr(r),u_up_dir:new Yl(r),u_emissive_strength:new kr(r)}),o.dI=Ph,o.dJ=Lb,o.dK=Og,o.dL=(r,e,i,s,a,u)=>{const h=r.transform,p=h.projection.name==="globe";let _;if(u.paint.get("circle-pitch-alignment")==="map")if(p){const x=Rg(h.zoom,e.canonical)*h._pixelsPerMercatorPixel;_=Float32Array.from([x,0,0,x])}else _=h.calculatePixelsToTileUnitsMatrix(i);else _=new Float32Array([h.pixelsToGLUnits[0],0,0,h.pixelsToGLUnits[1]]);const g={u_camera_to_center_distance:r.transform.getCameraToCenterDistance(h.projection),u_matrix:r.translatePosMatrix(e.projMatrix,i,u.paint.get("circle-translate"),u.paint.get("circle-translate-anchor")),u_device_pixel_ratio:ns.devicePixelRatio,u_extrude_scale:_,u_inv_rot_matrix:w1,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0],u_emissive_strength:u.paint.get("circle-emissive-strength")};if(p){g.u_inv_rot_matrix=s,g.u_merc_center=a,g.u_tile_id=[e.canonical.x,e.canonical.y,1<<e.canonical.z],g.u_zoom_transition=Ha(h.zoom);const x=a[0]*dt,b=a[1]*dt;g.u_up_dir=h.projection.upVector(new tc(0,0,0),x,b)}return g},o.dM=rv,o.dN=In,o.dO=(r,e,i,s,a,u,h,p,_,g)=>{const x=r.transform,b=x.pitch<15?ev(.07,.7,Q((14-x.zoom)/5,0,1)):.07,w=i.paint.get("line-trim-color-use-theme").constantOr("default")==="none";return{u_matrix:iv(r,e,i,s),u_texsize:e.imageAtlasTexture?e.imageAtlasTexture.size:[0,0],u_pixels_to_tile_units:x.calculatePixelsToTileUnitsMatrix(e),u_device_pixel_ratio:a,u_width_scale:u,u_floor_width_scale:h,u_image:0,u_tile_units_to_pixels:tv(e,x),u_units_to_pixels:[1/x.pixelsToGLUnits[0],1/x.pixelsToGLUnits[1]],u_alpha_discard_threshold:0,u_trim_offset:p,u_trim_fade_range:i.paint.get("line-trim-fade-range"),u_trim_color:i.paint.get("line-trim-color").toPremultipliedRenderColor(w?null:i.lut).toArray01(),u_emissive_strength:i.paint.get("line-emissive-strength"),u_zbias_factor:b,u_tile_to_meter:Pe(e.tileID.canonical,0),u_ground_shadow_factor:_,u_pattern_transition:g}},o.dP=(r,e,i,s,a,u,h,p,_,g)=>{const x=r.transform,b=x.calculatePixelsToTileUnitsMatrix(e),w=i.paint.get("line-trim-color-use-theme").constantOr("default")==="none",E=x.pitch<15?ev(.07,.7,Q((14-x.zoom)/5,0,1)):.07;return{u_matrix:iv(r,e,i,s),u_pixels_to_tile_units:b,u_device_pixel_ratio:u,u_width_scale:h,u_floor_width_scale:p,u_units_to_pixels:[1/x.pixelsToGLUnits[0],1/x.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:a,u_texsize:nv(i)&&e.lineAtlasTexture?e.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:tv(e,r.transform),u_alpha_discard_threshold:0,u_trim_offset:_,u_trim_fade_range:i.paint.get("line-trim-fade-range"),u_trim_color:i.paint.get("line-trim-color").toPremultipliedRenderColor(w?null:i.lut).toArray01(),u_emissive_strength:i.paint.get("line-emissive-strength"),u_zbias_factor:E,u_tile_to_meter:Pe(e.tileID.canonical,0),u_ground_shadow_factor:g}},o.dQ=ct,o.dR=qh,o.dS=ve,o.dT=m1,o.dU=jf,o.dV=Ay,o.dW=Wa,o.dX=450,o.dY=7,o.dZ=pw,o.d_=bi,o.da=function(r){const e=[],i=r.id;return i===void 0&&e.push({message:`layers.${i}: missing required property "id"`}),r.render===void 0&&e.push({message:`layers.${i}: missing required method "render"`}),r.renderingMode&&r.renderingMode!=="2d"&&r.renderingMode!=="3d"&&e.push({message:`layers.${i}: property "renderingMode" must be either "2d" or "3d"`}),e},o.db=function(r,e,i,s){return r.type==="custom"?new mw(r,e):new Aw[r.type](r,e,i,s)},o.dc=Ht,o.dd=function(r){const e=r.indexOf(Nl);return e>=0?r.slice(e+1):""},o.de=class extends Pu{constructor(r,e){super(r._vectorTileFeature,r._z,r._x,r._y,r.id),r.state&&(this.state=Object.assign({},r.state)),this.target=e.target,this.namespace=e.namespace,e.properties&&(this.properties=e.properties),this.target&&("featuresetId"in this.target&&!this.target.importId||"layerId"in this.target)&&(this.source=r.source,this.sourceLayer=r.sourceLayer,this.layer=r.layer)}toJSON(){const r=super.toJSON();return r.target=this.target,r.namespace=this.namespace,r}},o.df=Yc,o.dg=da,o.dh=function(r){return r({pluginStatus:bn,pluginURL:Fs}),Yc.on("pluginStateChange",r),r},o.di=Cf,o.dj=class extends Vs{constructor(r){super(r),this.current=Nh}set(r,e,i){if(this.fetchUniformLocation(r,e)){for(let s=0;s<9;s++)if(i[s]!==this.current[s]){this.current=i,this.gl.uniformMatrix3fv(this.location,!1,i);break}}}},o.dk=U,o.dl=function(r,e,i){const s=Ha(i.zoom),a=r.style.map._antialias,u=r.terrain&&r.terrain.exaggeration()>0;return s===0&&!a&&!u},o.dm=function(r){const e=r.pixelsPerMeter,i=e/ie(1,r.center.lat),s=re(new Float64Array(16));return It(s,s,[r.point.x,r.point.y,0]),vt(s,s,[i,i,e]),Float32Array.from(s)},o.dn=zf,o.dp=function(r){const e=Oe-5;r=Q(r,-80.051129,e)/e*90;const i=Math.pow(Math.abs(Math.sin(wi(r))),3);return Math.round(i*(C.length-1))},o.dq=function(r,e,i,s){const a=e.getNorth(),u=e.getSouth(),h=e.getWest(),p=e.getEast(),_=1<<r.z,g=p-h,x=a-u,b=g/S,w=-x/C[i],E=[0,b,0,w,0,0,a,h,0];if(r.z>0){const A=180/s;qt(E,E,[A/g+1,0,0,0,A/x+1,0,-.5*A/b,.5*A/w,1])}return E[2]=_,E[5]=r.x,E[8]=r.y,E},o.dr=wo,o.ds=function(r,e,i){const s=re(new Float64Array(16)),a=(e/(1<<r)-.5)*Math.PI*2;return $e(s,i.globeMatrix,a),Float32Array.from(s)},o.dt=class{isDataAvailableAtPoint(r){const e=this._source();if(this.isUsingMockSource()||!e||r.y<0||r.y>1)return!1;const i=e.getSource().maxzoom,s=1<<i,a=Math.floor(r.x),u=Math.floor((r.x-a)*s),h=Math.floor(r.y*s),p=this.findDEMTileFor(new wn(i,a,i,u,h));return!(!p||!p.dem)}getAtPointOrZero(r,e=0){return this.getAtPoint(r,e)||0}getAtPoint(r,e,i=!0){if(this.isUsingMockSource())return null;e==null&&(e=null);const s=this._source();if(!s||r.y<0||r.y>1)return e;const a=s.getSource().maxzoom,u=1<<a,h=Math.floor(r.x),p=r.x-h,_=new wn(a,h,a,Math.floor(p*u),Math.floor(r.y*u)),g=this.findDEMTileFor(_);if(!g||!g.dem)return e;const x=g.dem,b=1<<g.tileID.canonical.z,w=(p*b-g.tileID.canonical.x)*x.dim,E=(r.y*b-g.tileID.canonical.y)*x.dim,A=Math.floor(w),P=Math.floor(E);return(i?this.exaggeration():1)*Ut(Ut(x.get(A,P),x.get(A,P+1),E-P),Ut(x.get(A+1,P),x.get(A+1,P+1),E-P),w-A)}getAtTileOffset(r,e,i){const s=1<<r.canonical.z;return this.getAtPointOrZero(new ue(r.wrap+(r.canonical.x+e/dt)/s,(r.canonical.y+i/dt)/s))}getAtTileOffsetFunc(r,e,i,s){return a=>{const u=this.getAtTileOffset(r,a.x,a.y),h=s.upVector(r.canonical,a.x,a.y);return rr(h,h,u*s.upVectorScale(r.canonical,e,i).metersToTile),h}}getForTilePoints(r,e,i,s){if(this.isUsingMockSource())return!1;const a=Iu.create(this,r,s);return!!a&&(e.forEach(u=>{u[2]=this.exaggeration()*a.getElevationAt(u[0],u[1],i)}),!0)}getMinMaxForTile(r){if(this.isUsingMockSource())return null;const e=this.findDEMTileFor(r);if(!e||!e.dem)return null;const i=e.dem.tree,s=e.tileID,a=1<<r.canonical.z-s.canonical.z;let u=r.canonical.x/a-s.canonical.x,h=r.canonical.y/a-s.canonical.y,p=0;for(let _=0;_<r.canonical.z-s.canonical.z&&!i.leaves[p];_++){u*=2,h*=2;const g=2*Math.floor(h)+Math.floor(u);p=i.childOffsets[p]+g,u%=1,h%=1}return{min:this.exaggeration()*i.minimums[p],max:this.exaggeration()*i.maximums[p]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(r,e,i){throw new Error("Pure virtual method called.")}pointCoordinate(r){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(r){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}getMinMaxForVisibleTiles(){const r=this.visibleDemTiles;if(r.length===0)return null;let e=!1,i=Number.MAX_VALUE,s=Number.MIN_VALUE;for(const a of r){const u=this.getMinMaxForTile(a.tileID);u&&(i=Math.min(i,u.min),s=Math.max(s,u.max),e=!0)}return e?{min:i,max:s}:null}},o.du=$g,o.dv=Rf,o.dw=function(r,e){return[Math.pow(r[0],2.2)*e,Math.pow(r[1],2.2)*e,Math.pow(r[2],2.2)*e]},o.dx=ht,o.dy=function(r,e){var i=Math.sin(e),s=Math.cos(e);return r[0]=s,r[1]=i,r[2]=0,r[3]=-i,r[4]=s,r[5]=0,r[6]=0,r[7]=0,r[8]=1,r},o.dz=Ss,o.e=Jr,o.e$=n0,o.e0=256,o.e1=xm,o.e2=ys,o.e3=$e,o.e4=function(r,e){return r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[4],r[4]=e[5],r[5]=e[6],r[6]=e[8],r[7]=e[9],r[8]=e[10],r},o.e5=yo,o.e6=$l,o.e7=Yd,o.e8=function(r,e,i,s,a){return Q((r-e)/(i-e)*(a-s)+s,s,a)},o.e9=Ks,o.eA=function(r,e,i){return r[0]=e[0]/i[0],r[1]=e[1]/i[1],r[2]=e[2]/i[2],r},o.eB=na,o.eC=z,o.eD=Ts,o.eE=function(r,e,i,s){return r[0]=e,r[1]=i,r[2]=s,r},o.eF=function([r,e,i]){const s=Math.hypot(r,e,i),a=Math.atan2(r,i),u=.5*Math.PI-Math.acos(-e/s);return new V(Ee(a),Ee(u))},o.eG=rl,o.eH=f_,o.eI=function(r){const e=r.navigator?r.navigator.userAgent:null;return!!function(i){if(Cr==null){const s=i.navigator?i.navigator.userAgent:null;Cr=!!i.safari||!(!s||!(/\b(iPad|iPhone|iPod)\b/.test(s)||s.match("Safari")&&!s.match("Chrome")))}return Cr}(r)&&!(!e||!(e.match("Version/15.4")||e.match("Version/15.5")||e.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/)))},o.eJ=function(r,e){ss=r,Ms=e},o.eK=wm,o.eL=Lg,o.eM=function(r){const e=[0,0,0],i=re(new Float64Array(16));return at(i,r.pixelMatrix,r.globeMatrix),ji(e,e,i),new ut(e[0],e[1])},o.eN=function(){const r=td;r&&(r.isPreloaded()&&r.numActive()===1?(r.release(Fm),td=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},o.eO=function(){qf().acquire(Fm)},o.eP=za,o.eQ=function(r,e,i=!1){if(bn===On.deferred||bn===On.loading||bn===On.loaded)throw new Error("setRTLTextPlugin cannot be called multiple times.");Fs=ns.resolveURL(r),bn=On.deferred,bh=e,Xc(),i||af()},o.eR=function(r){yu=ns.resolveURL(r),vu||(vu=new gu(qf(),new Bo)),vu.broadcast("setMeshoptUrl",yu)},o.eS=Vy,o.eT=function(r){Nm=ns.resolveURL(r),vu||(vu=new gu(qf(),new Bo)),vu.broadcast("setDracoUrl",Nm)},o.eU=Ny,o.eV=ed,o.eW=function(r){const e=Lo();if(!e)return;const i=e.delete(Cs);r&&i.then(()=>r()).catch(r)},o.eX=sc,o.eY=bt,o.eZ=Za,o.e_=Gs,o.ea=function(r,e){var i=e[0],s=e[1],a=e[2],u=e[3],h=e[4],p=e[5],_=e[6],g=e[7],x=e[8],b=x*h-p*g,w=-x*u+p*_,E=g*u-h*_,A=i*b+s*w+a*E;return A?(r[0]=b*(A=1/A),r[1]=(-x*s+a*g)*A,r[2]=(p*s-a*h)*A,r[3]=w*A,r[4]=(x*i-a*_)*A,r[5]=(-p*i+a*u)*A,r[6]=E*A,r[7]=(-g*i+s*_)*A,r[8]=(h*i-s*u)*A,r):null},o.eb=Zs,o.ec=Ze,o.ed=p_,o.ee=function(r,e){if(r===e){var i=e[1],s=e[2],a=e[3],u=e[6],h=e[7],p=e[11];r[1]=e[4],r[2]=e[8],r[3]=e[12],r[4]=i,r[6]=e[9],r[7]=e[13],r[8]=s,r[9]=u,r[11]=e[14],r[12]=a,r[13]=h,r[14]=p}else r[0]=e[0],r[1]=e[4],r[2]=e[8],r[3]=e[12],r[4]=e[1],r[5]=e[5],r[6]=e[9],r[7]=e[13],r[8]=e[2],r[9]=e[6],r[10]=e[10],r[11]=e[14],r[12]=e[3],r[13]=e[7],r[14]=e[11],r[15]=e[15];return r},o.ef=Si,o.eg=[1,1,1],o.eh=class{constructor(r,e,i,s){this.context=r,this.format=s,this.size=i,this.texture=r.gl.createTexture();const[a,u,h]=this.size,{gl:p}=r;p.bindTexture(p.TEXTURE_3D,this.texture),r.pixelStoreUnpackFlipY.set(!1),r.pixelStoreUnpack.set(1),r.pixelStoreUnpackPremultiplyAlpha.set(!1),p.texImage3D(p.TEXTURE_3D,0,this.format,a,u,h,0,c_(this.format),u_(this.format),e.data)}bind(r,e){const{context:i}=this,{gl:s}=i;s.bindTexture(s.TEXTURE_3D,this.texture),r!==this.minFilter&&(s.texParameteri(s.TEXTURE_3D,s.TEXTURE_MAG_FILTER,r),s.texParameteri(s.TEXTURE_3D,s.TEXTURE_MIN_FILTER,r),this.minFilter=r),e!==this.wrapS&&(s.texParameteri(s.TEXTURE_3D,s.TEXTURE_WRAP_S,e),s.texParameteri(s.TEXTURE_3D,s.TEXTURE_WRAP_T,e),this.wrapS=e)}destroy(){const{gl:r}=this.context;r.deleteTexture(this.texture),this.texture=null}},o.ei=Iu,o.ej=function(r,e,i,s){var a=new Ce(4);return a[0]=r,a[1]=e,a[2]=i,a[3]=s,a},o.ek=mn,o.el=function(r,e,i,s){var a=e[0],u=e[1],h=e[2],p=e[3];return r[0]=a+s*(i[0]-a),r[1]=u+s*(i[1]-u),r[2]=h+s*(i[2]-h),r[3]=p+s*(i[3]-p),r},o.em=Eu,o.en=go,o.eo=ea,o.ep=function(r,e,i,s,a,u,h,p,_,g,x,b,w,E,A,P){var L=new Ce(16);return L[0]=r,L[1]=e,L[2]=i,L[3]=s,L[4]=a,L[5]=u,L[6]=h,L[7]=p,L[8]=_,L[9]=g,L[10]=x,L[11]=b,L[12]=w,L[13]=E,L[14]=A,L[15]=P,L},o.eq=O,o.er=nu,o.es=Lh,o.et=class{constructor(){this._updateTime=0,this._sourceIds=[],this._activeRegions=[],this._prevRegions=[],this._globalClipBounds={min:new ut(1/0,1/0),max:new ut(-1/0,-1/0)}}clear(){this._activeRegions.length>0&&++this._updateTime,this._activeRegions=[],this._prevRegions=[]}get updateTime(){return this._updateTime}getReplacementRegionsForTile(r,e=!1){const i=uy(new ut(0,0),new ut(dt,dt),r),s=[];if(e&&!zm(i,this._globalClipBounds))return s;for(const a of this._activeRegions){if(a.hiddenByOverlap||!zm(i,a))continue;const u=Y1(a.min,a.max,r);s.push({min:u.min,max:u.max,sourceId:this._sourceIds[a.priority],footprint:a.footprint,footprintTileId:a.tileId,order:a.order,clipMask:a.clipMask,clipScope:a.clipScope})}return s}setSources(r){this._setSources(r.map(e=>({getSourceId:()=>e.cache.id,getFootprints:()=>{const i=[];for(const s of e.cache.getVisibleCoordinates()){const a=e.cache.getTile(s).buckets[e.layer];a&&a.updateFootprints(s.toUnwrapped(),i)}return i},getOrder:()=>e.order,getClipMask:()=>e.clipMask,getClipScope:()=>e.clipScope})))}_addSource(r){const e=r.getFootprints();if(e.length===0)return;const i=r.getOrder(),s=r.getClipMask(),a=r.getClipScope();for(const u of e){if(!u.footprint)continue;const h=uy(u.footprint.min,u.footprint.max,u.id);this._activeRegions.push({min:h.min,max:h.max,hiddenByOverlap:!1,priority:this._sourceIds.length,tileId:u.id,footprint:u.footprint,order:i,clipMask:s,clipScope:a})}this._sourceIds.push(r.getSourceId())}_computeReplacement(){this._activeRegions.sort((e,i)=>e.priority-i.priority||Vf(e.min,i.min)||Vf(e.max,i.max)||e.order-i.order||e.clipMask-i.clipMask||function(s,a){const u=(h,p)=>h+p;return s.length-a.length||s.reduce(u,"").localeCompare(a.reduce(u,""))}(e.clipScope,i.clipScope));let r=this._activeRegions.length!==this._prevRegions.length;if(!r){let e=0;for(;!r&&e!==this._activeRegions.length;){const i=this._activeRegions[e],s=this._prevRegions[e];r=i.priority!==s.priority||!cy(i,s)||i.order!==s.order||i.clipMask!==s.clipMask||!As(i.clipScope,s.clipScope),++e}}if(r){++this._updateTime;for(const i of this._activeRegions)i.order!==Nf&&(this._globalClipBounds.min.x=Math.min(this._globalClipBounds.min.x,i.min.x),this._globalClipBounds.min.y=Math.min(this._globalClipBounds.min.y,i.min.y),this._globalClipBounds.max.x=Math.max(this._globalClipBounds.max.x,i.max.x),this._globalClipBounds.max.y=Math.max(this._globalClipBounds.max.y,i.max.y));const e=i=>{const s=this._activeRegions;if(i>=s.length)return i;const a=s[i].priority;for(;i<s.length&&s[i].priority===a;)++i;return i};if(this._sourceIds.length>1){let i=0,s=e(i);for(;i!==s;){let a=i;const u=i;for(;a!==s;){const h=this._activeRegions[a];h.hiddenByOverlap=!1;for(let p=0;p<u;p++){const _=this._activeRegions[p];if(!_.hiddenByOverlap&&h.order===Nf&&zm(h,_)&&(h.hiddenByOverlap=dy(h.footprint,h.tileId,_.footprint,_.tileId),h.hiddenByOverlap))break}++a}i=s,s=e(i)}}}}_setSources(r){[this._prevRegions,this._activeRegions]=[this._activeRegions,[]],this._sourceIds=[];for(let e=r.length-1;e>=0;e--)this._addSource(r[e]);this._computeReplacement()}},o.eu=Nf,o.ev=class{constructor(r){this._createGrid(r),this._createPoles(r)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(const r of this._poleSegments)r.destroy();for(const r of this._gridSegments)r.withSkirts.destroy(),r.withoutSkirts.destroy()}_fillGridMeshWithLods(r,e){const i=new Ns,s=new en,a=[],u=r+1+2,h=e[0]+1,p=e[0]+1+(1+e.length),_=(g,x,b)=>{let w=g===u-1?g-2:g===0?g:g-1;return w+=b?24575:0,[w,x]};for(let g=0;g<u;++g)i.emplaceBack(..._(g,0,!0));for(let g=0;g<h;++g)for(let x=0;x<u;++x)i.emplaceBack(..._(x,g,(x===0||x===u-1)&&!0));for(let g=0;g<e.length;++g){const x=e[g];for(let b=0;b<u;++b)i.emplaceBack(..._(b,x,!0))}for(let g=0;g<e.length;++g){const x=s.length,b=e[g]+1+2,w=new en;for(let P=0;P<b-1;P++){const L=P===b-2,k=L?u*(p-e.length+g-P):u;for(let j=0;j<u-1;j++){const G=P*u+j;P===0||L||j===0||j===u-2?(w.emplaceBack(G+1,G,G+k),w.emplaceBack(G+k,G+k+1,G+1)):(s.emplaceBack(G+1,G,G+k),s.emplaceBack(G+k,G+k+1,G+1))}}const E=Tr.simpleSegment(0,x,i.length,s.length-x);for(let P=0;P<w.uint16.length;P+=3)s.emplaceBack(w.uint16[P],w.uint16[P+1],w.uint16[P+2]);const A=Tr.simpleSegment(0,x,i.length,s.length-x);a.push({withoutSkirts:E,withSkirts:A})}return{vertices:i,indices:s,segments:a}}_createGrid(r){const e=this._fillGridMeshWithLods(S,C);this._gridSegments=e.segments,this._gridBuffer=r.createVertexBuffer(e.vertices,Ig.members),this._gridIndexBuffer=r.createIndexBuffer(e.indices,!0)}_createPoles(r){const e=new en;for(let h=0;h<=S;h++)e.emplaceBack(0,h+1,h+2);this._poleIndexBuffer=r.createIndexBuffer(e,!0);const i=new yo,s=new yo,a=new yo,u=new yo;this._poleSegments=[];for(let h=0,p=0;h<y;h++){const _=360/(1<<h);i.emplaceBack(0,-m,0,.5,0),s.emplaceBack(0,-m,0,.5,1),a.emplaceBack(0,-m,0,.5,.5),u.emplaceBack(0,-m,0,.5,.5);for(let g=0;g<=S;g++){let x=g/S,b=0;const w=Ut(0,_,x),[E,A,P]=D(x1,b1,w,m);i.emplaceBack(E,A,P,x,b),s.emplaceBack(E,A,P,x,1-b);const L=wi(w);x=.5+.5*Math.sin(L),b=.5+.5*Math.cos(L),a.emplaceBack(E,A,P,x,b),u.emplaceBack(E,A,P,x,1-b)}this._poleSegments.push(Tr.simpleSegment(p,0,66,64)),p+=66}this._poleNorthVertexBuffer=r.createVertexBuffer(i,Pf,!1),this._poleSouthVertexBuffer=r.createVertexBuffer(s,Pf,!1),this._texturedPoleNorthVertexBuffer=r.createVertexBuffer(a,Pf,!1),this._texturedPoleSouthVertexBuffer=r.createVertexBuffer(u,Pf,!1)}getGridBuffers(r,e){return[this._gridBuffer,this._gridIndexBuffer,e?this._gridSegments[r].withSkirts:this._gridSegments[r].withoutSkirts]}getPoleBuffers(r,e){return[e?this._texturedPoleNorthVertexBuffer:this._poleNorthVertexBuffer,e?this._texturedPoleSouthVertexBuffer:this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[r]]}},o.ew=X,o.ex=function(){return!!document.fullscreenElement||!!document.webkitFullscreenElement},o.ey=oe,o.ez=_e,o.f=function(r){return btoa(encodeURIComponent(r).replace(/%([0-9A-F]{2})/g,(e,i)=>String.fromCharCode(+("0x"+i))))},o.f0=s0,o.f1=Yy,o.f2=ui,o.f3="hd_road_elevation",o.f4=Hn,o.f5=Pt,o.f6=rc,o.f7=Jm,o.f8=oc,o.f9=function(r,e,i,s,a,u,h,p=1,_,g,x){r.createArrays(),r.tilePixelRatio=dt/(512*r.overscaling),r.compareText={},r.iconsNeedLinear=!1;const b=r.layers[0].layout,w=r.layers[0]._unevaluatedLayout._values,E={};E.scaleFactor=p,E.textSizeScaleRange=b.get("text-size-scale-range"),E.iconSizeScaleRange=b.get("icon-size-scale-range");const[A,P]=E.textSizeScaleRange,[L,k]=E.iconSizeScaleRange;E.textScaleFactor=Q(E.scaleFactor,A,P),E.iconScaleFactor=Q(E.scaleFactor,L,k);const j=w["text-size"],G=w["icon-size"];if(r.textSizeData.kind==="composite"){const{minZoom:ne,maxZoom:ce}=r.textSizeData;E.compositeTextSizes=[j.possiblyEvaluate(new Gi(ne,{worldview:x}),u),j.possiblyEvaluate(new Gi(ce,{worldview:x}),u)]}if(r.iconSizeData.kind==="composite"){const{minZoom:ne,maxZoom:ce}=r.iconSizeData;E.compositeIconSizes=[G.possiblyEvaluate(new Gi(ne,{worldview:x}),u),G.possiblyEvaluate(new Gi(ce,{worldview:x}),u)]}E.layoutTextSize=j.possiblyEvaluate(new Gi(h+1,{worldview:x}),u),E.layoutIconSize=G.possiblyEvaluate(new Gi(h+1,{worldview:x}),u),E.textMaxSize=j.possiblyEvaluate(new Gi(18,{worldview:x}),u);const R=b.get("symbol-placement"),N=b.get("text-rotation-alignment")==="map"&&R!=="point",q=b.get("text-size");let Z=!1;const ae=[];for(const ne of r.features){const ce=b.get("text-font").evaluate(ne,{},u).join(","),me=q.evaluate(ne,{},u)*E.textScaleFactor,Re=E.layoutTextSize.evaluate(ne,{},u)*E.textScaleFactor,Xe=E.layoutIconSize.evaluate(ne,{},u)*E.iconScaleFactor,Ve={horizontal:{},vertical:void 0},We=ne.text;let Ke,Le=[0,0];if(We){const jt=We.toString(),Qt=b.get("text-letter-spacing").evaluate(ne,{},u)*Kr,Jt=b.get("text-line-height").evaluate(ne,{},u)*Kr,ai=sm(jt)?Qt:0,ii=b.get("text-anchor").evaluate(ne,{},u),li=b.get("text-variable-anchor");if(!li){const De=b.get("text-radial-offset").evaluate(ne,{},u);if(De)Le=Dv(ii,[De*Kr,e_]);else{const lt=b.get("text-offset").evaluate(ne,{},u);Le=[lt[0]*Kr,lt[1]*Kr]}}let Li=N?"center":b.get("text-justify").evaluate(ne,{},u);const er=R==="point",$=er?b.get("text-max-width").evaluate(ne,{},u)*Kr:1/0,W=De=>{r.allowVerticalPlacement&&Fl(jt)&&(Ve.vertical=Xm(We,e,i,a,ce,$,Jt,ii,De,ai,Le,Zn.vertical,!0,Re,me,_))};if(!N&&li){const De=Li==="auto"?li.map(mt=>t_(mt)):[Li];let lt=!1;for(let mt=0;mt<De.length;mt++){const ft=De[mt];if(!Ve.horizontal[ft])if(lt)Ve.horizontal[ft]=Ve.horizontal[0];else{const St=Xm(We,e,i,a,ce,$,Jt,"center",ft,ai,Le,Zn.horizontal,!1,Re,me,_);St&&(Ve.horizontal[ft]=St,lt=St.positionedLines.length===1)}}W("left")}else{if(Li==="auto"&&(Li=t_(ii)),er||b.get("text-writing-mode").indexOf("horizontal")>=0||!Fl(jt)){const De=Xm(We,e,i,a,ce,$,Jt,ii,Li,ai,Le,Zn.horizontal,!1,Re,me,_);De&&(Ve.horizontal[Li]=De)}W(er?"left":Li)}}let He,Me,ze,et,it,Ot,At=!1;const pt=b.get("icon-text-fit").evaluate(ne,{},u);if(ne.icon&&ne.icon.hasPrimary()){const jt=kv(ne.icon,r.iconSizeData,w["icon-size"],u,r.zoom,ne,_,E.iconScaleFactor,x);He=jt.iconPrimary,ze=jt.iconSecondary;const Qt=He.toString();if(Me=s.get(Qt),Me&&(it=b.get("icon-offset").evaluate(ne,{},u),Ot=b.get("icon-anchor").evaluate(ne,{},u),Ke=qb(a.get(Qt),ze?a.get(ze.toString()):void 0,it,Ot),At=Me.sdf,r.sdfIcons===void 0?r.sdfIcons=Me.sdf:r.sdfIcons!==Me.sdf&&ei("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(Me.pixelRatio!==r.pixelRatio||b.get("icon-rotate").constantOr(1)!==0)&&(r.iconsNeedLinear=!0)),ze){const Jt=ze.toString();et=s.get(Jt)}}Z=Z||!(!ne.icon||!ne.icon.hasSecondary());const Qe=i_(Ve.horizontal)||Ve.vertical;r.iconsInText||(r.iconsInText=!!Qe&&Qe.iconsInText);const Xt=Re*E.textScaleFactor/Kr,{defaultShapedIcon:Et,verticallyShapedIcon:Mt}=ew(r,Ke,b,ne,u,Ve,Xt,it,pt);pt!=="none"&&Ke&&(yv(Ke)||vv(Ke))&&(Qf(0,Me,He,Ke,Et,pt,g,s,a),Qf(0,et,ze,Ke,Et,pt,g,s,a),Mt&&(Qf(0,Me,He,Ke,Mt,pt,g,s,a),Qf(0,et,ze,Ke,Mt,pt,g,s,a))),Ke=Et,ae.push({feature:ne,shapedTextOrientations:Ve,shapedText:Qe,shapedIcon:Ke,iconPrimary:He,iconSecondary:ze,iconOffset:it,iconAnchor:Ot,verticallyShapedIcon:Mt,layoutTextSize:Re,layoutIconSize:Xe,textOffset:Le,isSDFIcon:At,iconTextFit:pt})}return{featureData:ae,sizes:E,hasAnySecondaryIcon:Z,textAlongLine:N,symbolPlacement:R}},o.fa=Cv,o.fb=function(r,e,i,s,a,u,h,p,_,g){const{featureData:x,hasAnySecondaryIcon:b,sizes:w,textAlongLine:E,symbolPlacement:A}=e;for(const P of x){const{shapedIcon:L,verticallyShapedIcon:k,feature:j,shapedTextOrientations:G,shapedText:R,layoutTextSize:N,textOffset:q,isSDFIcon:Z,iconPrimary:ae,iconSecondary:ne,iconTextFit:ce,iconOffset:me}=P;Fv(L,g.iconPositions,ae,ne),Fv(k,g.iconPositions,ae,ne),Qb(G,g.iconPositions),Jb(ae,ne,g.iconPositions),(R||L)&&tw(r,j,G,L,k,_,w,N,0,q,Z,s,a,h,p,b,ce,me,E,A)}i&&r.generateCollisionDebugBuffers(u,r.collisionBoxArray,w.textScaleFactor)},o.fc=ni,o.fd=Tp,o.fe=Ro,o.ff=Kt,o.fg=uv,o.fh=eo,o.fi=function(r){let e=0;if(new Uint32Array(r,0,1)[0]!==jy){const i=new Uint32Array(r,0,7),[,,s,a,u,h]=i;e=i.byteLength+a+u+h+u,(s!==r.byteLength||e>=r.byteLength)&&ei("Invalid b3dm header information.")}return Hy(r,e)},o.fj=function(r,e){const i=r0(r);for(const s of i){for(const a of s.meshes)S2(a);s.lights&&(s.lightMeshIndex=s.meshes.length,s.meshes.push(E2(s.lights,e)))}return i},o.fk=gp,o.fl=ki,o.fm=Fy,o.fn=Bs,o.fo=On,o.fp=function(r){ua(),ms?.then(e=>{e.keys().then(i=>{for(let s=0;s<i.length-r;s++)e.delete(i[s]).catch(a=>ei(a.message))}).catch(i=>ei(i.message))}).catch(e=>ei(e.message))},o.g=function(r,e){return da(we(r,{method:"GET"}),e)},o.h=we,o.i=function(r){return Jr.API_STYLE_REGEX.test(r)&&!fc(r)},o.j=function(r){return r.indexOf("mapbox:")===0},o.k=to,o.l=Nu,o.m=function(r){return decodeURIComponent(atob(r).split("").map(e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)).join(""))},o.n=function(r,e){return da(we(r,{type:"json"}),e)},o.o=Vu,o.p=function(r,e){return da(we(r,{method:"POST"}),e)},o.q=ns,o.r=nn,o.s=function(r){try{const e=self[r];return e.setItem("_mapbox_test_",1),e.removeItem("_mapbox_test_"),!0}catch{return!1}},o.t=_c,o.u=function(){return function r(e){return e?(e^Math.random()*(16>>e/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,r)}()},o.v=function(r){return!!r&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(r)},o.w=ei,o.x=function(){return Bm||(Bm=new sc),Bm},o.y=S_,o.z=xc}),be(["./shared"],function(o){function Ae(Ee){const F=Ee?Ee.url.toString():void 0;return F?performance.getEntriesByName(F):[]}function Ce(Ee){if(typeof Ee=="number"||typeof Ee=="boolean"||typeof Ee=="string"||Ee==null)return JSON.stringify(Ee);if(Array.isArray(Ee)){let U="[";for(const X of Ee)U+=`${Ce(X)},`;return`${U}]`}let F="{";for(const U of Object.keys(Ee).sort())F+=`${U}:${Ce(Ee[U])},`;return`${F}}`}function ot(Ee){let F="";for(const U of o.bu)F+=`/${Ce(Ee[U])}`;return F}class ht{constructor(F){this.keyCache={},this._layers={},this._layerConfigs={},F&&this.replace(F)}replace(F,U){this._layerConfigs={},this._layers={},this.update(F,[],U)}update(F,U,X){this._options=X;for(const Q of F)this._layerConfigs[Q.id]=Q,(this._layers[Q.id]=o.db(Q,this.scope,null,this._options)).compileFilter(X),this.keyCache[Q.id]&&delete this.keyCache[Q.id];for(const Q of U)delete this.keyCache[Q],delete this._layerConfigs[Q],delete this._layers[Q];this.familiesBySource={};const oe=function(Q,de){const xe={};for(let we=0;we<Q.length;we++){const Ue=Q[we];let Ie=de&&de[Ue.id];Ie||(Ue.type==="symbol"?Ie=Ue.id:(Ie=ot(Ue),Ue.type==="line"&&Ue.paint&&function Ct(Pt){return typeof Pt=="string"&&Pt==="line-progress"||(Array.isArray(Pt)?Pt.some(Ct):!(!Pt||typeof Pt!="object")&&Object.values(Pt).some(Ct))}(Ue.paint["line-width"])&&(Ie+=`/${Ce(Ue.paint["line-width"])}`))),de&&(de[Ue.id]=Ie);let ct=xe[Ie];ct||(ct=xe[Ie]=[]),ct.push(Ue)}const fe=[];for(const we in xe)fe.push(xe[we]);return fe}(Object.values(this._layerConfigs),this.keyCache);for(const Q of oe){const de=Q.map(ct=>this._layers[ct.id]),xe=de[0];if(xe.visibility==="none")continue;const fe=xe.source||"";let we=this.familiesBySource[fe];we||(we=this.familiesBySource[fe]={});const Ue=xe.sourceLayer||"_geojsonTileLayer";let Ie=we[Ue];Ie||(Ie=we[Ue]=[]),Ie.push(de)}}}const zt=1*o.e_;class qt{constructor(F){const U={},X=[];for(const xe in F){const fe=F[xe],we=U[xe]={};for(const Ue in fe.glyphs){const Ie=fe.glyphs[+Ue];if(!Ie||Ie.bitmap.width===0||Ie.bitmap.height===0)continue;const ct=Ie.metrics.localGlyph?zt:1,Ct={x:0,y:0,w:Ie.bitmap.width+2*ct,h:Ie.bitmap.height+2*ct};X.push(Ct),we[Ue]=Ct}}const{w:oe,h:Q}=o.H(X),de=new o.eZ({width:oe||1,height:Q||1});for(const xe in F){const fe=F[xe];for(const we in fe.glyphs){const Ue=fe.glyphs[+we];if(!Ue||Ue.bitmap.width===0||Ue.bitmap.height===0)continue;const Ie=U[xe][we],ct=Ue.metrics.localGlyph?zt:1;o.eZ.copy(Ue.bitmap,de,{x:0,y:0},{x:Ie.x+ct,y:Ie.y+ct},Ue.bitmap)}}this.image=de,this.positions=U}}o.eY(qt,"GlyphAtlas");class st{constructor(F){this.tileID=new o.aM(F.tileID.overscaledZ,F.tileID.wrap,F.tileID.canonical.z,F.tileID.canonical.x,F.tileID.canonical.y),this.tileZoom=F.tileZoom,this.uid=F.uid,this.zoom=F.zoom,this.lut=F.lut,this.canonical=F.tileID.canonical,this.pixelRatio=F.pixelRatio,this.tileSize=F.tileSize,this.source=F.source,this.scope=F.scope,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=F.showCollisionBoxes,this.collectResourceTiming=!!F.request&&F.request.collectResourceTiming,this.promoteId=F.promoteId,this.isSymbolTile=F.isSymbolTile,this.tileTransform=o.aW(F.tileID.canonical,F.projection),this.projection=F.projection,this.worldview=F.worldview,this.localizableLayerIds=F.localizableLayerIds,this.brightness=F.brightness,this.extraShadowCaster=!!F.extraShadowCaster,this.tessellationStep=F.tessellationStep,this.scaleFactor=F.scaleFactor,this.worldview=F.worldview}parse(F,U,X,oe,Q,de){this.status="parsing",this.data=F,this.collisionBoxArray=new o.b0;const xe=new o.e$(Object.keys(F.layers).sort()),fe=new o.f0(this.tileID,this.promoteId);fe.bucketLayerIDs=[];const we={},Ue=new o.f1(256,256),Ie={featureIndex:fe,iconDependencies:new Map,patternDependencies:new Map,glyphDependencies:{},lineAtlas:Ue,availableImages:X,brightness:this.brightness,scaleFactor:this.scaleFactor,elevationFeatures:void 0},ct=[],Ct=U.familiesBySource[this.source];for(const Ht in Ct){const Wt=F.layers[Ht];if(!Wt)continue;let Yt=!1,ci=!1,ei=!1;for(const ki of Ct[Ht])ki[0].type==="symbol"?Yt=!0:ci=!0,ki[0].is3D()&&ki[0].type!=="model"&&(ei=!0);if(this.extraShadowCaster&&!ei||this.isSymbolTile===!0&&!Yt||this.isSymbolTile===!1&&!ci)continue;Wt.version===1&&o.w(`Vector tile source "${this.source}" layer "${Ht}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const Zi=xe.encode(Ht),cr=[];let ur=!1;for(let ki=0,Ii=0;ki<Wt.length;ki++){const Cr=Wt.feature(ki),xr=fe.getId(Cr,Ht);if(this.localizableLayerIds&&this.localizableLayerIds.has(Ht)){const _r=Cr.properties?Cr.properties.worldview:null;if(this.worldview&&typeof _r=="string")if(_r==="all")Cr.properties.$localized=!0;else{if(!_r.split(",").includes(this.worldview))continue;Cr.properties.$localized=!0,Cr.properties.worldview=this.worldview}}!ur&&Cr.properties&&Cr.properties.hasOwnProperty(o.f2)&&(ur=!0),cr.push({feature:Cr,id:xr,index:Ii,sourceLayerIndex:Zi}),Ii++}ur&&!Ie.elevationFeatures&&F.layers.hasOwnProperty(o.f3)&&(Ie.elevationFeatures=o.f4.parseFrom(F.layers[o.f3],this.canonical));for(const ki of Ct[Ht]){const Ii=ki[0];if(this.extraShadowCaster&&(!Ii.is3D()||Ii.type==="model")||this.isSymbolTile!==void 0&&Ii.type==="symbol"!==this.isSymbolTile||Ii.minzoom&&this.zoom<Math.floor(Ii.minzoom)||Ii.maxzoom&&this.zoom>=Ii.maxzoom||Ii.visibility==="none")continue;re(ki,this.zoom,Ie.brightness,X,this.worldview);const Cr=we[Ii.id]=Ii.createBucket({index:fe.bucketLayerIDs.length,layers:ki,zoom:this.zoom,lut:this.lut,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:Zi,sourceID:this.source,projection:this.projection.spec,tessellationStep:this.tessellationStep,styleDefinedModelURLs:oe,worldview:this.worldview});fe.bucketLayerIDs.push(ki.map(_r=>o.C(_r.id,_r.scope)));let xr=Cr.prepare?Cr.prepare():null;xr!=null?(xr=xr.then(()=>Cr.populate(cr,Ie,this.tileID.canonical,this.tileTransform)),ct.push(xr)):Cr.populate(cr,Ie,this.tileID.canonical,this.tileTransform)}}const Pt=()=>{let Ht,Wt,Yt,ci,ei,Zi;Ue.trim();const cr={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},ur=()=>{if(Ht)return this.status="done",de(Ht);if(this.extraShadowCaster)this.status="done",de(null,{buckets:Object.values(we).filter(Ii=>!Ii.isEmpty()),featureIndex:fe,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:Ie.brightness,glyphMap:null,iconMap:null,glyphPositions:null});else if(Wt&&Yt&&ci){const Ii=new qt(Wt),Cr=new Map;for(const[Xr,Sn]of Yt.entries()){const{imagePosition:ln}=o.f7(Xr,Sn,o.f8);Cr.set(Xr,ln)}const xr={};for(const Xr in we){const Sn=we[Xr];Sn instanceof o.b1&&(re(Sn.layers,this.zoom,Ie.brightness,X,this.worldview),xr[Xr]=o.f9(Sn,Wt,Ii.positions,Yt,Cr,this.tileID.canonical,this.tileZoom,this.scaleFactor,this.pixelRatio,ei,this.worldview))}const _r={iconsPending:!0,patternsPending:!0};this.rasterizeIfNeeded(Q,Yt,ei,()=>{_r.iconsPending=!1,ki(xr,Ii,_r)}),this.rasterizeIfNeeded(Q,ci,Zi,()=>{_r.patternsPending=!1,ki(xr,Ii,_r)})}},ki=(Ii,Cr,xr,_r)=>{if(xr.iconsPending||xr.patternsPending)return;const Xr=new o.fa(Yt,ci,this.lut);for(const Sn in we){const ln=we[Sn];if(Sn in Ii)o.fb(ln,Ii[Sn],this.showCollisionBoxes,X,this.tileID.canonical,this.tileZoom,this.projection,this.brightness,Yt,Xr);else if(ln.hasPattern&&(ln instanceof o.b7||ln instanceof o.b8||ln instanceof o.dU)){re(ln.layers,this.zoom,Ie.brightness,X,this.worldview);const ol=Object.fromEntries(Xr.patternPositions);ln.addFeatures(Ie,this.tileID.canonical,ol,X,this.tileTransform,this.brightness)}}this.status="done",de(null,{buckets:Object.values(we).filter(Sn=>!Sn.isEmpty()),featureIndex:fe,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:Cr.image,lineAtlas:Ue,imageAtlas:Xr,brightness:Ie.brightness})};if(!this.extraShadowCaster){const Ii=o.f5(Ie.glyphDependencies,_r=>Object.keys(_r).map(Number));Object.keys(Ii).length?Q.send("getGlyphs",{uid:this.uid,stacks:Ii,scope:this.scope},(_r,Xr)=>{Ht||(Ht=_r,Wt=Xr,ur())},void 0,!1,cr):Wt={};const Cr=Array.from(Ie.iconDependencies.keys()).map(_r=>o.I.parse(_r));Cr.length?Q.send("getImages",{images:Cr,source:this.source,scope:this.scope,tileID:this.tileID,type:"icons"},(_r,Xr)=>{Ht||(Ht=_r,Yt=new Map,ei=this.updateImageMapAndGetImageTaskQueue(Yt,Xr,Ie.iconDependencies),ur())},void 0,!1,cr):(Yt=new Map,ei=new Map);const xr=Array.from(Ie.patternDependencies.keys()).map(_r=>o.I.parse(_r));xr.length?Q.send("getImages",{images:xr,source:this.source,scope:this.scope,tileID:this.tileID,type:"patterns"},(_r,Xr)=>{Ht||(Ht=_r,ci=new Map,Zi=this.updateImageMapAndGetImageTaskQueue(ci,Xr,Ie.patternDependencies),ur())},void 0,!1,cr):(ci=new Map,Zi=new Map)}if(Ie.elevationFeatures&&Ie.elevationFeatures.length>0){const Ii=[];for(const xr of Object.values(we))if(xr instanceof o.b8){const _r=xr.getUnevaluatedPortalGraph();_r&&Ii.push(_r)}const Cr=o.f6.evaluate(Ii);for(const xr of Object.values(we))if(xr instanceof o.b8){const _r=F.layers[xe.decode(xr.sourceLayerIndex)];xr.setEvaluatedPortalGraph(Cr,_r,this.tileID.canonical,Ie.availableImages,Ie.brightness)}}ur()};ct.length>0?Promise.allSettled(ct).then(Pt).catch(de):Pt()}rasterizeIfNeeded(F,U,X,oe){Array.from(U.values()).some(Q=>Q.usvg)?this.rasterize(F,U,X,oe):oe()}updateImageMapAndGetImageTaskQueue(F,U,X){const oe=new Map;for(const Q of U.keys()){const de=X.get(Q)||[];for(const xe of de){const fe=xe.toString(),we=U.get(xe.id.toString());we.usvg?oe.has(fe)||(oe.set(fe,xe),F.set(fe,Object.assign({},we))):F.set(fe,we)}}return oe}rasterize(F,U,X,oe){this.rasterizeTask=F.send("rasterizeImages",{scope:this.scope,tasks:X},(Q,de)=>{if(!Q)for(const[xe,fe]of de.entries()){const we=Object.assign(U.get(xe),{data:fe});U.set(xe,we)}oe()})}cancelRasterize(){this.rasterizeTask&&this.rasterizeTask.cancel()}}function re(Ee,F,U,X,oe){const Q=new o.aa(F,{brightness:U,worldview:oe});for(const de of Ee)de.recalculate(Q,X)}class Ge extends o.E{constructor(F,U,X,oe,Q,de,xe){super(),this.actor=F,this.layerIndex=U,this.availableImages=X,this.availableModels=oe,this.loadVectorData=de||o.aJ,this.loading={},this.loaded={},this.deduped=new o.aI(F.scheduler),this.isSpriteLoaded=Q,this.scheduler=F.scheduler,this.brightness=xe}loadTile(F,U){const X=F.uid,oe=F&&F.request,Q=oe&&oe.collectResourceTiming,de=this.loading[X]=new st(F);de.abort=this.loadVectorData(F,(xe,fe)=>{const we=!this.loading[X];if(delete this.loading[X],de.cancelRasterize(),we||xe||!fe)return de.status="done",we||(this.loaded[X]=de),U(xe);const Ue=fe.rawData,Ie={};fe.expires&&(Ie.expires=fe.expires),fe.cacheControl&&(Ie.cacheControl=fe.cacheControl),de.vectorTile=fe.vectorTile||new o.fc.VectorTile(new o.bq(Ue));const ct=()=>{de.parse(de.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,(Ct,Pt)=>{if(Ct||!Pt)return U(Ct);const Ht={};if(Q){const Wt=Ae(oe);Wt.length>0&&(Ht.resourceTiming=JSON.parse(JSON.stringify(Wt)))}U(null,o.h({rawTileData:Ue.slice(0)},Pt,Ie,Ht))})};this.isSpriteLoaded?ct():this.once("isSpriteLoaded",()=>{this.scheduler?this.scheduler.add(ct,{type:"parseTile",isSymbolTile:F.isSymbolTile,zoom:F.tileZoom}):ct()}),this.loaded=this.loaded||{},this.loaded[X]=de})}reloadTile(F,U){const X=this.loaded,oe=F.uid;if(X&&X[oe]){const Q=X[oe];Q.scaleFactor=F.scaleFactor,Q.showCollisionBoxes=F.showCollisionBoxes,Q.projection=F.projection,Q.brightness=F.brightness,Q.tileTransform=o.aW(F.tileID.canonical,F.projection),Q.extraShadowCaster=F.extraShadowCaster,Q.lut=F.lut,Q.worldview=F.worldview;const de=(xe,fe)=>{const we=Q.reloadCallback;we&&(delete Q.reloadCallback,Q.parse(Q.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,we)),U(xe,fe)};Q.status==="parsing"?Q.reloadCallback=de:Q.status==="done"&&(Q.vectorTile?Q.parse(Q.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,de):de())}else U(null,void 0)}abortTile(F,U){const X=F.uid,oe=this.loading[X];oe&&(oe.abort&&oe.abort(),delete this.loading[X]),U()}removeTile(F,U){const X=this.loaded,oe=F.uid;X&&X[oe]&&delete X[oe],U()}}class at{loadTile(F,U){const{uid:X,encoding:oe,rawImageData:Q,padding:de}=F,xe=ImageBitmap&&Q instanceof ImageBitmap?this.getImageData(Q,de):Q;U(null,new o.fd(X,xe,oe,de<1))}reloadTile(F,U){U(null,null)}abortTile(F,U){U()}removeTile(F,U){U()}getImageData(F,U){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(F.width,F.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=F.width,this.offscreenCanvas.height=F.height,this.offscreenCanvasContext.drawImage(F,0,0,F.width,F.height);const X=this.offscreenCanvasContext.getImageData(-U,-U,F.width+2*U,F.height+2*U);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),X}}o.bp.setPbf(o.bq);class It{constructor(F){this._mrt=new o.bp(F.partial?30:1/0),this._isHeaderLoaded=!1,this.uid=F.uid,this.tileID=F.tileID,this.source=F.source}parse(F,U){const X=this._mrt;this.status="parsing",this._entireBuffer=F;try{X.parseHeader(F),this._isHeaderLoaded=!0;const oe=[];for(const Q in X.layers){const de=X.getLayer(Q),xe=de.getDataRange(de.getBandList()),fe=X.createDecodingTask(xe),we=F.slice(xe.firstByte,xe.lastByte+1),Ue=o.bp.performDecoding(we,fe).then(Ie=>fe.complete(null,Ie)).catch(Ie=>fe.complete(Ie,null));oe.push(Ue)}Promise.allSettled(oe).then(()=>U(null,X)).catch(Q=>U(Q))}catch(oe){U(oe)}}}class vt{constructor(F){this.actor=F,this.loading={},this.loaded={}}loadTile(F,U){const X=F.uid,oe=F.request,Q=this.loading[X]=new It(F),{cancel:de}=o.br(oe,(xe,fe,we,Ue)=>{const Ie=!this.loading[X];if(delete this.loading[X],Ie||xe||!fe)return Q.status="done",Ie||(this.loaded[X]=Q),U(xe);Q.parse(fe,(ct,Ct)=>{if(ct||!Ct)return U(ct);U(null,Ct,we,Ue)}),this.loaded[X]=Q});Q.abort=de}reloadTile(F,U){U(null,void 0)}abortTile(F,U){const X=F.uid,oe=this.loading[X];oe&&(oe.abort&&oe.abort(),delete this.loading[X]),U()}removeTile(F,U){const X=F.uid;this.loaded[X]&&delete this.loaded[X],U()}decodeRasterArray(F,U){o.bp.performDecoding(F.buffer,F.task).then(X=>U(null,X)).catch(X=>U(X))}}const nt=o.fc.VectorTileFeature.prototype.toGeoJSON;class $e{constructor(F){this._feature=F,this.extent=o.aj,this.type=F.type,this.properties=F.tags,"id"in F&&!isNaN(F.id)&&(this.id=parseInt(F.id,10))}loadGeometry(){if(this._feature.type===1){const F=[];for(const U of this._feature.geometry)F.push([new o.P(U[0],U[1])]);return F}{const F=[];for(const U of this._feature.geometry){const X=[];for(const oe of U)X.push(new o.P(oe[0],oe[1]));F.push(X)}return F}}toGeoJSON(F,U,X){return nt.call(this,F,U,X)}}class Ye{constructor(F){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=o.aj,this.length=F.length,this._features=F}feature(F){return new $e(this._features[F])}}class yt{constructor(F,U){this.name=F,this.extent=o.aj,this.length=U.length,this._features=U}feature(F){return new $e(this._features[F])}}class Gt extends Ye{constructor(F){super([]),this.layers={};for(const U in F)this.layers[U]=new yt(U,F[U])}}const gi=64/4096,xi=128;class Si{constructor(){this.features=new Map}clear(){this.features.clear()}load(F=[],U){for(const X of F){const oe=X.id;if(oe==null)continue;let Q=this.features.get(oe);Q&&this.updateCache(Q,U),X.geometry?(Q=Rr(X),this.updateCache(Q,U),this.features.set(oe,Q)):this.features.delete(oe),this.updateCache(Q,U)}}updateCache(F,U){for(const{canonical:X,uid:oe}of Object.values(U)){const{z:Q,x:de,y:xe}=X;Dr(F,Math.pow(2,Q),de,xe)&&delete U[oe]}}getTile(F,U,X){const oe=Math.pow(2,F),Q=[];for(const de of this.features.values())Dr(de,oe,U,X)&&Q.push(Nn(de,oe,U,X));return{features:Q}}getFeatures(){return[...this.features.values()]}}function Dr({minX:Ee,minY:F,maxX:U,maxY:X},oe,Q,de){return Ee<(Q+1+gi)/oe&&F<(de+1+gi)/oe&&U>(Q-gi)/oe&&X>(de-gi)/oe}function Rr(Ee){const{id:F,geometry:U,properties:X}=Ee;if(!U)return;if(U.type==="GeometryCollection")throw new Error("GeometryCollection not supported in dynamic mode.");const{type:oe,coordinates:Q}=U,de={id:F,type:1,geometry:[],tags:X,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0},xe=de.geometry;if(oe==="Point")Ei(Q,xe,de);else if(oe==="MultiPoint")for(const fe of Q)Ei(fe,xe,de);else if(oe==="LineString")de.type=2,zr(Q,xe,de);else if(oe==="MultiLineString")de.type=2,Or(Q,xe,de);else if(oe==="Polygon")de.type=3,Or(Q,xe,de,!0);else{if(oe!=="MultiPolygon")throw new Error("Input data is not a valid GeoJSON object.");de.type=3;for(const fe of Q)Or(fe,xe,de,!0)}return de}function Ei([Ee,F],U,X){const oe=o.aD(Ee);let Q=o.aH(F);Q=Q<0?0:Q>1?1:Q,U.push(oe,Q),X.minX=Math.min(X.minX,oe),X.minY=Math.min(X.minY,Q),X.maxX=Math.max(X.maxX,oe),X.maxY=Math.max(X.maxY,Q)}function zr(Ee,F,U,X=!1,oe=!1){const Q=[];for(const de of Ee)Ei(de,Q,U);F.push(Q),X&&function(de,xe){let fe=0;for(let we=0,Ue=de.length,Ie=Ue-2;we<Ue;Ie=we,we+=2)fe+=(de[we]-de[Ie])*(de[we+1]+de[Ie+1]);if(fe>0===xe)for(let we=0,Ue=de.length;we<Ue/2;we+=2){const Ie=de[we],ct=de[we+1];de[we]=de[Ue-2-we],de[we+1]=de[Ue-1-we],de[Ue-2-we]=Ie,de[Ue-1-we]=ct}}(Q,oe)}function Or(Ee,F,U,X=!1){for(let oe=0;oe<Ee.length;oe++)zr(Ee[oe],F,U,X,oe===0)}function Nn(Ee,F,U,X){const{id:oe,type:Q,geometry:de,tags:xe}=Ee,fe=[];if(Q===1)(function(we,Ue,Ie,ct,Ct){for(let Pt=0;Pt<we.length;Pt+=2){const Ht=Math.round(o.aj*(we[Pt+0]*Ue-Ie)),Wt=Math.round(o.aj*(we[Pt+1]*Ue-ct));Ct.push([Ht,Wt])}})(de,F,U,X,fe);else for(const we of de)Vn(we,F,U,X,fe);return{id:oe,type:Q,geometry:fe,tags:xe}}function Vn(Ee,F,U,X,oe){const de=o.aj+xi;let xe;for(let fe=0;fe<Ee.length-2;fe+=2){let we=Math.round(o.aj*(Ee[fe+0]*F-U)),Ue=Math.round(o.aj*(Ee[fe+1]*F-X)),Ie=Math.round(o.aj*(Ee[fe+2]*F-U)),ct=Math.round(o.aj*(Ee[fe+3]*F-X));const Ct=Ie-we,Pt=ct-Ue;we<-128&&Ie<-128||(we<-128?(Ue+=Math.round(Pt*((-128-we)/Ct)),we=-128):Ie<-128&&(ct=Ue+Math.round(Pt*((-128-we)/Ct)),Ie=-128),Ue<-128&&ct<-128||(Ue<-128?(we+=Math.round(Ct*((-128-Ue)/Pt)),Ue=-128):ct<-128&&(Ie=we+Math.round(Ct*((-128-Ue)/Pt)),ct=-128),we>=de&&Ie>=de||(we>=de?(Ue+=Math.round(Pt*((de-we)/Ct)),we=de):Ie>=de&&(ct=Ue+Math.round(Pt*((de-we)/Ct)),Ie=de),Ue>=de&&ct>=de||(Ue>=de?(we+=Math.round(Ct*((de-Ue)/Pt)),Ue=de):ct>=de&&(Ie=we+Math.round(Ct*((de-Ue)/Pt)),ct=de),xe&&we===xe[xe.length-1][0]&&Ue===xe[xe.length-1][1]||(xe=[[we,Ue]],oe.push(xe)),xe.push([Ie,ct])))))}}var Un,rr,fn,pn={exports:{}},Ts=function(){if(fn)return pn.exports;fn=1;var Ee=o.fg(),F=function(){if(rr)return Un;rr=1;var Ue=o.fe(),Ie=o.ff().VectorTileFeature;function ct(Pt,Ht){this.options=Ht||{},this.features=Pt,this.length=Pt.length}function Ct(Pt,Ht){this.id=typeof Pt.id=="number"?Pt.id:void 0,this.type=Pt.type,this.rawGeometry=Pt.type===1?[Pt.geometry]:Pt.geometry,this.properties=Pt.tags,this.extent=Ht||4096}return Un=ct,ct.prototype.feature=function(Pt){return new Ct(this.features[Pt],this.options.extent)},Ct.prototype.loadGeometry=function(){var Pt=this.rawGeometry;this.geometry=[];for(var Ht=0;Ht<Pt.length;Ht++){for(var Wt=Pt[Ht],Yt=[],ci=0;ci<Wt.length;ci++)Yt.push(new Ue(Wt[ci][0],Wt[ci][1]));this.geometry.push(Yt)}return this.geometry},Ct.prototype.bbox=function(){this.geometry||this.loadGeometry();for(var Pt=this.geometry,Ht=1/0,Wt=-1/0,Yt=1/0,ci=-1/0,ei=0;ei<Pt.length;ei++)for(var Zi=Pt[ei],cr=0;cr<Zi.length;cr++){var ur=Zi[cr];Ht=Math.min(Ht,ur.x),Wt=Math.max(Wt,ur.x),Yt=Math.min(Yt,ur.y),ci=Math.max(ci,ur.y)}return[Ht,Yt,Wt,ci]},Ct.prototype.toGeoJSON=Ie.prototype.toGeoJSON,Un}();function U(Ue){var Ie=new Ee;return function(ct,Ct){for(var Pt in ct.layers)Ct.writeMessage(3,X,ct.layers[Pt])}(Ue,Ie),Ie.finish()}function X(Ue,Ie){var ct;Ie.writeVarintField(15,Ue.version||1),Ie.writeStringField(1,Ue.name||""),Ie.writeVarintField(5,Ue.extent||4096);var Ct={keys:[],values:[],keycache:{},valuecache:{}};for(ct=0;ct<Ue.length;ct++)Ct.feature=Ue.feature(ct),Ie.writeMessage(2,oe,Ct);var Pt=Ct.keys;for(ct=0;ct<Pt.length;ct++)Ie.writeStringField(3,Pt[ct]);var Ht=Ct.values;for(ct=0;ct<Ht.length;ct++)Ie.writeMessage(4,we,Ht[ct])}function oe(Ue,Ie){var ct=Ue.feature;ct.id!==void 0&&Ie.writeVarintField(1,ct.id),Ie.writeMessage(2,Q,Ue),Ie.writeVarintField(3,ct.type),Ie.writeMessage(4,fe,ct)}function Q(Ue,Ie){var ct=Ue.feature,Ct=Ue.keys,Pt=Ue.values,Ht=Ue.keycache,Wt=Ue.valuecache;for(var Yt in ct.properties){var ci=ct.properties[Yt],ei=Ht[Yt];if(ci!==null){ei===void 0&&(Ct.push(Yt),Ht[Yt]=ei=Ct.length-1),Ie.writeVarint(ei);var Zi=typeof ci;Zi!=="string"&&Zi!=="boolean"&&Zi!=="number"&&(ci=JSON.stringify(ci));var cr=Zi+":"+ci,ur=Wt[cr];ur===void 0&&(Pt.push(ci),Wt[cr]=ur=Pt.length-1),Ie.writeVarint(ur)}}}function de(Ue,Ie){return(Ie<<3)+(7&Ue)}function xe(Ue){return Ue<<1^Ue>>31}function fe(Ue,Ie){for(var ct=Ue.loadGeometry(),Ct=Ue.type,Pt=0,Ht=0,Wt=ct.length,Yt=0;Yt<Wt;Yt++){var ci=ct[Yt],ei=1;Ct===1&&(ei=ci.length),Ie.writeVarint(de(1,ei));for(var Zi=Ct===3?ci.length-1:ci.length,cr=0;cr<Zi;cr++){cr===1&&Ct!==1&&Ie.writeVarint(de(2,Zi-1));var ur=ci[cr].x-Pt,ki=ci[cr].y-Ht;Ie.writeVarint(xe(ur)),Ie.writeVarint(xe(ki)),Pt+=ur,Ht+=ki}Ct===3&&Ie.writeVarint(de(7,1))}}function we(Ue,Ie){var ct=typeof Ue;ct==="string"?Ie.writeStringField(1,Ue):ct==="boolean"?Ie.writeBooleanField(7,Ue):ct==="number"&&(Ue%1!=0?Ie.writeDoubleField(3,Ue):Ue<0?Ie.writeSVarintField(6,Ue):Ie.writeVarintField(5,Ue))}return pn.exports=U,pn.exports.fromVectorTileJs=U,pn.exports.fromGeojsonVt=function(Ue,Ie){Ie=Ie||{};var ct={};for(var Ct in Ue)ct[Ct]=new F(Ue[Ct].features,Ie),ct[Ct].name=Ct,ct[Ct].version=Ie.version,ct[Ct].extent=Ie.extent;return U({layers:ct})},pn.exports.GeoJSONWrapper=F,pn.exports}(),Zs=o.fh(Ts);const mr={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:Ee=>Ee},Ar=Math.fround||($i=new Float32Array(1),Ee=>($i[0]=+Ee,$i[0]));var $i;const Zr=3,ji=5,Ss=6;class Es{constructor(F){this.options=Object.assign(Object.create(mr),F),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(F){const{log:U,minZoom:X,maxZoom:oe}=this.options;U&&console.time("total time");const Q=`prepare ${F.length} points`;U&&console.time(Q),this.points=F;const de=[];for(let fe=0;fe<F.length;fe++){const we=F[fe];if(!we.geometry)continue;const[Ue,Ie]=we.geometry.coordinates,ct=Ar(na(Ue)),Ct=Ar(Ws(Ie));de.push(ct,Ct,1/0,fe,-1,1),this.options.reduce&&de.push(0)}let xe=this.trees[oe+1]=this._createTree(de);U&&console.timeEnd(Q);for(let fe=oe;fe>=X;fe--){const we=+Date.now();xe=this.trees[fe]=this._createTree(this._cluster(xe,fe)),U&&console.log("z%d: %d clusters in %dms",fe,xe.numItems,+Date.now()-we)}return U&&console.timeEnd("total time"),this}getClusters(F,U){let X=((F[0]+180)%360+360)%360-180;const oe=Math.max(-90,Math.min(90,F[1]));let Q=F[2]===180?180:((F[2]+180)%360+360)%360-180;const de=Math.max(-90,Math.min(90,F[3]));if(F[2]-F[0]>=360)X=-180,Q=180;else if(X>Q){const Ie=this.getClusters([X,oe,180,de],U),ct=this.getClusters([-180,oe,Q,de],U);return Ie.concat(ct)}const xe=this.trees[this._limitZoom(U)],fe=xe.range(na(X),Ws(de),na(Q),Ws(oe)),we=xe.data,Ue=[];for(const Ie of fe){const ct=this.stride*Ie;Ue.push(we[ct+ji]>1?rs(we,ct,this.clusterProps):this.points[we[ct+Zr]])}return Ue}getChildren(F){const U=this._getOriginId(F),X=this._getOriginZoom(F),oe="No cluster with the specified id.",Q=this.trees[X];if(!Q)throw new Error(oe);const de=Q.data;if(U*this.stride>=de.length)throw new Error(oe);const xe=this.options.radius/(this.options.extent*Math.pow(2,X-1)),fe=Q.within(de[U*this.stride],de[U*this.stride+1],xe),we=[];for(const Ue of fe){const Ie=Ue*this.stride;de[Ie+4]===F&&we.push(de[Ie+ji]>1?rs(de,Ie,this.clusterProps):this.points[de[Ie+Zr]])}if(we.length===0)throw new Error(oe);return we}getLeaves(F,U,X){const oe=[];return this._appendLeaves(oe,F,U=U||10,X=X||0,0),oe}getTile(F,U,X){const oe=this.trees[this._limitZoom(F)],Q=Math.pow(2,F),{extent:de,radius:xe}=this.options,fe=xe/de,we=(X-fe)/Q,Ue=(X+1+fe)/Q,Ie={features:[]};return this._addTileFeatures(oe.range((U-fe)/Q,we,(U+1+fe)/Q,Ue),oe.data,U,X,Q,Ie),U===0&&this._addTileFeatures(oe.range(1-fe/Q,we,1,Ue),oe.data,Q,X,Q,Ie),U===Q-1&&this._addTileFeatures(oe.range(0,we,fe/Q,Ue),oe.data,-1,X,Q,Ie),Ie.features.length?Ie:null}getClusterExpansionZoom(F){let U=this._getOriginZoom(F)-1;for(;U<=this.options.maxZoom;){const X=this.getChildren(F);if(U++,X.length!==1)break;F=X[0].properties.cluster_id}return U}_appendLeaves(F,U,X,oe,Q){const de=this.getChildren(U);for(const xe of de){const fe=xe.properties;if(fe&&fe.cluster?Q+fe.point_count<=oe?Q+=fe.point_count:Q=this._appendLeaves(F,fe.cluster_id,X,oe,Q):Q<oe?Q++:F.push(xe),F.length===X)break}return Q}_createTree(F){const U=new o.bW(F.length/this.stride|0,this.options.nodeSize,Float32Array);for(let X=0;X<F.length;X+=this.stride)U.add(F[X],F[X+1]);return U.finish(),U.data=F,U}_addTileFeatures(F,U,X,oe,Q,de){for(const xe of F){const fe=xe*this.stride,we=U[fe+ji]>1;let Ue,Ie,ct;if(we)Ue=Br(U,fe,this.clusterProps),Ie=U[fe],ct=U[fe+1];else{const Ht=this.points[U[fe+Zr]];Ue=Ht.properties;const[Wt,Yt]=Ht.geometry.coordinates;Ie=na(Wt),ct=Ws(Yt)}const Ct={type:1,geometry:[[Math.round(this.options.extent*(Ie*Q-X)),Math.round(this.options.extent*(ct*Q-oe))]],tags:Ue};let Pt;Pt=we||this.options.generateId?U[fe+Zr]:this.points[U[fe+Zr]].id,Pt!==void 0&&(Ct.id=Pt),de.features.push(Ct)}}_limitZoom(F){return Math.max(this.options.minZoom,Math.min(Math.floor(+F),this.options.maxZoom+1))}_cluster(F,U){const{radius:X,extent:oe,reduce:Q,minPoints:de}=this.options,xe=X/(oe*Math.pow(2,U)),fe=F.data,we=[],Ue=this.stride;for(let Ie=0;Ie<fe.length;Ie+=Ue){if(fe[Ie+2]<=U)continue;fe[Ie+2]=U;const ct=fe[Ie],Ct=fe[Ie+1],Pt=F.within(fe[Ie],fe[Ie+1],xe),Ht=fe[Ie+ji];let Wt=Ht;for(const Yt of Pt){const ci=Yt*Ue;fe[ci+2]>U&&(Wt+=fe[ci+ji])}if(Wt>Ht&&Wt>=de){let Yt,ci=ct*Ht,ei=Ct*Ht,Zi=-1;const cr=(Ie/Ue<<5)+(U+1)+this.points.length;for(const ur of Pt){const ki=ur*Ue;if(fe[ki+2]<=U)continue;fe[ki+2]=U;const Ii=fe[ki+ji];ci+=fe[ki]*Ii,ei+=fe[ki+1]*Ii,fe[ki+4]=cr,Q&&(Yt||(Yt=this._map(fe,Ie,!0),Zi=this.clusterProps.length,this.clusterProps.push(Yt)),Q(Yt,this._map(fe,ki)))}fe[Ie+4]=cr,we.push(ci/Wt,ei/Wt,1/0,cr,-1,Wt),Q&&we.push(Zi)}else{for(let Yt=0;Yt<Ue;Yt++)we.push(fe[Ie+Yt]);if(Wt>1)for(const Yt of Pt){const ci=Yt*Ue;if(!(fe[ci+2]<=U)){fe[ci+2]=U;for(let ei=0;ei<Ue;ei++)we.push(fe[ci+ei])}}}}return we}_getOriginId(F){return F-this.points.length>>5}_getOriginZoom(F){return(F-this.points.length)%32}_map(F,U,X){if(F[U+ji]>1){const de=this.clusterProps[F[U+Ss]];return X?Object.assign({},de):de}const oe=this.points[F[U+Zr]].properties,Q=this.options.map(oe);return X&&Q===oe?Object.assign({},Q):Q}}function rs(Ee,F,U){return{type:"Feature",id:Ee[F+Zr],properties:Br(Ee,F,U),geometry:{type:"Point",coordinates:[(X=Ee[F],360*(X-.5)),mn(Ee[F+1])]}};var X}function Br(Ee,F,U){const X=Ee[F+ji],oe=X>=1e4?`${Math.round(X/1e3)}k`:X>=1e3?Math.round(X/100)/10+"k":X,Q=Ee[F+Ss],de=Q===-1?{}:Object.assign({},U[Q]);return Object.assign(de,{cluster:!0,cluster_id:Ee[F+Zr],point_count:X,point_count_abbreviated:oe})}function na(Ee){return Ee/360+.5}function Ws(Ee){const F=Math.sin(Ee*Math.PI/180),U=.5-.25*Math.log((1+F)/(1-F))/Math.PI;return U<0?0:U>1?1:U}function mn(Ee){const F=(180-360*Ee)*Math.PI/180;return 360*Math.atan(Math.exp(F))/Math.PI-90}function Co(Ee,F,U,X){let oe=X;const Q=F+(U-F>>1);let de,xe=U-F;const fe=Ee[F],we=Ee[F+1],Ue=Ee[U],Ie=Ee[U+1];for(let ct=F+3;ct<U;ct+=3){const Ct=rl(Ee[ct],Ee[ct+1],fe,we,Ue,Ie);if(Ct>oe)de=ct,oe=Ct;else if(Ct===oe){const Pt=Math.abs(ct-Q);Pt<xe&&(de=ct,xe=Pt)}}oe>X&&(de-F>3&&Co(Ee,F,de,X),Ee[de+2]=oe,U-de>3&&Co(Ee,de,U,X))}function rl(Ee,F,U,X,oe,Q){let de=oe-U,xe=Q-X;if(de!==0||xe!==0){const fe=((Ee-U)*de+(F-X)*xe)/(de*de+xe*xe);fe>1?(U=oe,X=Q):fe>0&&(U+=de*fe,X+=xe*fe)}return de=Ee-U,xe=F-X,de*de+xe*xe}function _n(Ee,F,U,X){const oe={id:Ee??null,type:F,geometry:U,tags:X,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if(F==="Point"||F==="MultiPoint"||F==="LineString")Pn(oe,U);else if(F==="Polygon")Pn(oe,U[0]);else if(F==="MultiLineString")for(const Q of U)Pn(oe,Q);else if(F==="MultiPolygon")for(const Q of U)Pn(oe,Q[0]);return oe}function Pn(Ee,F){for(let U=0;U<F.length;U+=3)Ee.minX=Math.min(Ee.minX,F[U]),Ee.minY=Math.min(Ee.minY,F[U+1]),Ee.maxX=Math.max(Ee.maxX,F[U]),Ee.maxY=Math.max(Ee.maxY,F[U+1])}function Xs(Ee,F,U,X){if(!F.geometry)return;const oe=F.geometry.coordinates;if(oe&&oe.length===0)return;const Q=F.geometry.type,de=Math.pow(U.tolerance/((1<<U.maxZoom)*U.extent),2);let xe=[],fe=F.id;if(U.promoteId?fe=F.properties[U.promoteId]:U.generateId&&(fe=X||0),Q==="Point")Ys(oe,xe);else if(Q==="MultiPoint")for(const we of oe)Ys(we,xe);else if(Q==="LineString")Ks(oe,xe,de,!1);else if(Q==="MultiLineString"){if(U.lineMetrics){for(const we of oe)xe=[],Ks(we,xe,de,!1),Ee.push(_n(fe,"LineString",xe,F.properties));return}gn(oe,xe,de,!1)}else if(Q==="Polygon")gn(oe,xe,de,!0);else{if(Q!=="MultiPolygon"){if(Q==="GeometryCollection"){for(const we of F.geometry.geometries)Xs(Ee,{id:fe,geometry:we,properties:F.properties},U,X);return}throw new Error("Input data is not a valid GeoJSON object.")}for(const we of oe){const Ue=[];gn(we,Ue,de,!0),xe.push(Ue)}}Ee.push(_n(fe,Q,xe,F.properties))}function Ys(Ee,F){F.push(sa(Ee[0]),oa(Ee[1]),0)}function Ks(Ee,F,U,X){let oe,Q,de=0;for(let fe=0;fe<Ee.length;fe++){const we=sa(Ee[fe][0]),Ue=oa(Ee[fe][1]);F.push(we,Ue,0),fe>0&&(de+=X?(oe*Ue-we*Q)/2:Math.sqrt(Math.pow(we-oe,2)+Math.pow(Ue-Q,2))),oe=we,Q=Ue}const xe=F.length-3;F[2]=1,Co(F,0,xe,U),F[xe+2]=1,F.size=Math.abs(de),F.start=0,F.end=F.size}function gn(Ee,F,U,X){for(let oe=0;oe<Ee.length;oe++){const Q=[];Ks(Ee[oe],Q,U,X),F.push(Q)}}function sa(Ee){return Ee/360+.5}function oa(Ee){const F=Math.sin(Ee*Math.PI/180),U=.5-.25*Math.log((1+F)/(1-F))/Math.PI;return U<0?0:U>1?1:U}function Rn(Ee,F,U,X,oe,Q,de,xe){if(X/=F,Q>=(U/=F)&&de<X)return Ee;if(de<U||Q>=X)return null;const fe=[];for(const we of Ee){const Ue=we.geometry;let Ie=we.type;const ct=oe===0?we.minX:we.minY,Ct=oe===0?we.maxX:we.maxY;if(ct>=U&&Ct<X){fe.push(we);continue}if(Ct<U||ct>=X)continue;let Pt=[];if(Ie==="Point"||Ie==="MultiPoint")nl(Ue,Pt,U,X,oe);else if(Ie==="LineString")Is(Ue,Pt,U,X,oe,!1,xe.lineMetrics);else if(Ie==="MultiLineString")an(Ue,Pt,U,X,oe,!1);else if(Ie==="Polygon")an(Ue,Pt,U,X,oe,!0);else if(Ie==="MultiPolygon")for(const Ht of Ue){const Wt=[];an(Ht,Wt,U,X,oe,!0),Wt.length&&Pt.push(Wt)}if(Pt.length){if(xe.lineMetrics&&Ie==="LineString"){for(const Ht of Pt)fe.push(_n(we.id,Ie,Ht,we.tags));continue}Ie!=="LineString"&&Ie!=="MultiLineString"||(Pt.length===1?(Ie="LineString",Pt=Pt[0]):Ie="MultiLineString"),Ie!=="Point"&&Ie!=="MultiPoint"||(Ie=Pt.length===3?"Point":"MultiPoint"),fe.push(_n(we.id,Ie,Pt,we.tags))}}return fe.length?fe:null}function nl(Ee,F,U,X,oe){for(let Q=0;Q<Ee.length;Q+=3){const de=Ee[Q+oe];de>=U&&de<=X&&Wn(F,Ee[Q],Ee[Q+1],Ee[Q+2])}}function Is(Ee,F,U,X,oe,Q,de){let xe=aa(Ee);const fe=oe===0?Mo:Js;let we,Ue,Ie=Ee.start;for(let Wt=0;Wt<Ee.length-3;Wt+=3){const Yt=Ee[Wt],ci=Ee[Wt+1],ei=Ee[Wt+2],Zi=Ee[Wt+3],cr=Ee[Wt+4],ur=oe===0?Yt:ci,ki=oe===0?Zi:cr;let Ii=!1;de&&(we=Math.sqrt(Math.pow(Yt-Zi,2)+Math.pow(ci-cr,2))),ur<U?ki>U&&(Ue=fe(xe,Yt,ci,Zi,cr,U),de&&(xe.start=Ie+we*Ue)):ur>X?ki<X&&(Ue=fe(xe,Yt,ci,Zi,cr,X),de&&(xe.start=Ie+we*Ue)):Wn(xe,Yt,ci,ei),ki<U&&ur>=U&&(Ue=fe(xe,Yt,ci,Zi,cr,U),Ii=!0),ki>X&&ur<=X&&(Ue=fe(xe,Yt,ci,Zi,cr,X),Ii=!0),!Q&&Ii&&(de&&(xe.end=Ie+we*Ue),F.push(xe),xe=aa(Ee)),de&&(Ie+=we)}let ct=Ee.length-3;const Ct=Ee[ct],Pt=Ee[ct+1],Ht=oe===0?Ct:Pt;Ht>=U&&Ht<=X&&Wn(xe,Ct,Pt,Ee[ct+2]),ct=xe.length-3,Q&&ct>=3&&(xe[ct]!==xe[0]||xe[ct+1]!==xe[1])&&Wn(xe,xe[0],xe[1],xe[2]),xe.length&&F.push(xe)}function aa(Ee){const F=[];return F.size=Ee.size,F.start=Ee.start,F.end=Ee.end,F}function an(Ee,F,U,X,oe,Q){for(const de of Ee)Is(de,F,U,X,oe,Q,!1)}function Wn(Ee,F,U,X){Ee.push(F,U,X)}function Mo(Ee,F,U,X,oe,Q){const de=(Q-F)/(X-F);return Wn(Ee,Q,U+(oe-U)*de,1),de}function Js(Ee,F,U,X,oe,Q){const de=(Q-U)/(oe-U);return Wn(Ee,F+(X-F)*de,Q,1),de}function Po(Ee,F){const U=[];for(let X=0;X<Ee.length;X++){const oe=Ee[X],Q=oe.type;let de;if(Q==="Point"||Q==="MultiPoint"||Q==="LineString")de=Qs(oe.geometry,F);else if(Q==="MultiLineString"||Q==="Polygon"){de=[];for(const xe of oe.geometry)de.push(Qs(xe,F))}else if(Q==="MultiPolygon"){de=[];for(const xe of oe.geometry){const fe=[];for(const we of xe)fe.push(Qs(we,F));de.push(fe)}}U.push(_n(oe.id,Q,de,oe.tags))}return U}function Qs(Ee,F){const U=[];U.size=Ee.size,Ee.start!==void 0&&(U.start=Ee.start,U.end=Ee.end);for(let X=0;X<Ee.length;X+=3)U.push(Ee[X]+F,Ee[X+1],Ee[X+2]);return U}function la(Ee,F){if(Ee.transformed)return Ee;const U=1<<Ee.z,X=Ee.x,oe=Ee.y;for(const Q of Ee.features){const de=Q.geometry,xe=Q.type;if(Q.geometry=[],xe===1)for(let fe=0;fe<de.length;fe+=2)Q.geometry.push(pr(de[fe],de[fe+1],F,U,X,oe));else for(let fe=0;fe<de.length;fe++){const we=[];for(let Ue=0;Ue<de[fe].length;Ue+=2)we.push(pr(de[fe][Ue],de[fe][Ue+1],F,U,X,oe));Q.geometry.push(we)}}return Ee.transformed=!0,Ee}function pr(Ee,F,U,X,oe,Q){return[Math.round(U*(Ee*X-oe)),Math.round(U*(F*X-Q))]}function eo(Ee,F,U,X,oe){const Q=F===oe.maxZoom?0:oe.tolerance/((1<<F)*oe.extent),de={features:[],numPoints:0,numSimplified:0,numFeatures:Ee.length,source:null,x:U,y:X,z:F,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(const xe of Ee)ca(de,xe,Q,oe);return de}function ca(Ee,F,U,X){const oe=F.geometry,Q=F.type,de=[];if(Ee.minX=Math.min(Ee.minX,F.minX),Ee.minY=Math.min(Ee.minY,F.minY),Ee.maxX=Math.max(Ee.maxX,F.maxX),Ee.maxY=Math.max(Ee.maxY,F.maxY),Q==="Point"||Q==="MultiPoint")for(let xe=0;xe<oe.length;xe+=3)de.push(oe[xe],oe[xe+1]),Ee.numPoints++,Ee.numSimplified++;else if(Q==="LineString")zn(de,oe,Ee,U,!1,!1);else if(Q==="MultiLineString"||Q==="Polygon")for(let xe=0;xe<oe.length;xe++)zn(de,oe[xe],Ee,U,Q==="Polygon",xe===0);else if(Q==="MultiPolygon")for(let xe=0;xe<oe.length;xe++){const fe=oe[xe];for(let we=0;we<fe.length;we++)zn(de,fe[we],Ee,U,!0,we===0)}if(de.length){let xe=F.tags||null;if(Q==="LineString"&&X.lineMetrics){xe={};for(const we in F.tags)xe[we]=F.tags[we];xe.mapbox_clip_start=oe.start/oe.size,xe.mapbox_clip_end=oe.end/oe.size}const fe={geometry:de,type:Q==="Polygon"||Q==="MultiPolygon"?3:Q==="LineString"||Q==="MultiLineString"?2:1,tags:xe};F.id!==null&&(fe.id=F.id),Ee.features.push(fe)}}function zn(Ee,F,U,X,oe,Q){const de=X*X;if(X>0&&F.size<(oe?de:X))return void(U.numPoints+=F.length/3);const xe=[];for(let fe=0;fe<F.length;fe+=3)(X===0||F[fe+2]>de)&&(U.numSimplified++,xe.push(F[fe],F[fe+1])),U.numPoints++;oe&&function(fe,we){let Ue=0;for(let Ie=0,ct=fe.length,Ct=ct-2;Ie<ct;Ct=Ie,Ie+=2)Ue+=(fe[Ie]-fe[Ct])*(fe[Ie+1]+fe[Ct+1]);if(Ue>0===we)for(let Ie=0,ct=fe.length;Ie<ct/2;Ie+=2){const Ct=fe[Ie],Pt=fe[Ie+1];fe[Ie]=fe[ct-2-Ie],fe[Ie+1]=fe[ct-1-Ie],fe[ct-2-Ie]=Ct,fe[ct-1-Ie]=Pt}}(xe,Q),Ee.push(xe)}const ku={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class dc{constructor(F,U){const X=(U=this.options=function(Q,de){for(const xe in de)Q[xe]=de[xe];return Q}(Object.create(ku),U)).debug;if(X&&console.time("preprocess data"),U.maxZoom<0||U.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(U.promoteId&&U.generateId)throw new Error("promoteId and generateId cannot be used together.");let oe=function(Q,de){const xe=[];if(Q.type==="FeatureCollection")for(let fe=0;fe<Q.features.length;fe++)Xs(xe,Q.features[fe],de,fe);else Xs(xe,Q.type==="Feature"?Q:{geometry:Q},de);return xe}(F,U);this.tiles={},this.tileCoords=[],X&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",U.indexMaxZoom,U.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),oe=function(Q,de){const xe=de.buffer/de.extent;let fe=Q;const we=Rn(Q,1,-1-xe,xe,0,-1,2,de),Ue=Rn(Q,1,1-xe,2+xe,0,-1,2,de);return(we||Ue)&&(fe=Rn(Q,1,-xe,1+xe,0,-1,2,de)||[],we&&(fe=Po(we,1).concat(fe)),Ue&&(fe=fe.concat(Po(Ue,-1)))),fe}(oe,U),oe.length&&this.splitTile(oe,0,0,0),X&&(oe.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(F,U,X,oe,Q,de,xe){const fe=[F,U,X,oe],we=this.options,Ue=we.debug;for(;fe.length;){oe=fe.pop(),X=fe.pop(),U=fe.pop(),F=fe.pop();const Ie=1<<U,ct=Ro(U,X,oe);let Ct=this.tiles[ct];if(!Ct&&(Ue>1&&console.time("creation"),Ct=this.tiles[ct]=eo(F,U,X,oe,we),this.tileCoords.push({z:U,x:X,y:oe}),Ue)){Ue>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",U,X,oe,Ct.numFeatures,Ct.numPoints,Ct.numSimplified),console.timeEnd("creation"));const Ii=`z${U}`;this.stats[Ii]=(this.stats[Ii]||0)+1,this.total++}if(Ct.source=F,Q==null){if(U===we.indexMaxZoom||Ct.numPoints<=we.indexMaxPoints)continue}else{if(U===we.maxZoom||U===Q)continue;if(Q!=null){const Ii=Q-U;if(X!==de>>Ii||oe!==xe>>Ii)continue}}if(Ct.source=null,F.length===0)continue;Ue>1&&console.time("clipping");const Pt=.5*we.buffer/we.extent,Ht=.5-Pt,Wt=.5+Pt,Yt=1+Pt;let ci=null,ei=null,Zi=null,cr=null,ur=Rn(F,Ie,X-Pt,X+Wt,0,Ct.minX,Ct.maxX,we),ki=Rn(F,Ie,X+Ht,X+Yt,0,Ct.minX,Ct.maxX,we);F=null,ur&&(ci=Rn(ur,Ie,oe-Pt,oe+Wt,1,Ct.minY,Ct.maxY,we),ei=Rn(ur,Ie,oe+Ht,oe+Yt,1,Ct.minY,Ct.maxY,we),ur=null),ki&&(Zi=Rn(ki,Ie,oe-Pt,oe+Wt,1,Ct.minY,Ct.maxY,we),cr=Rn(ki,Ie,oe+Ht,oe+Yt,1,Ct.minY,Ct.maxY,we),ki=null),Ue>1&&console.timeEnd("clipping"),fe.push(ci||[],U+1,2*X,2*oe),fe.push(ei||[],U+1,2*X,2*oe+1),fe.push(Zi||[],U+1,2*X+1,2*oe),fe.push(cr||[],U+1,2*X+1,2*oe+1)}}getTile(F,U,X){F=+F,U=+U,X=+X;const oe=this.options,{extent:Q,debug:de}=oe;if(F<0||F>24)return null;const xe=1<<F,fe=Ro(F,U=U+xe&xe-1,X);if(this.tiles[fe])return la(this.tiles[fe],Q);de>1&&console.log("drilling down to z%d-%d-%d",F,U,X);let we,Ue=F,Ie=U,ct=X;for(;!we&&Ue>0;)Ue--,Ie>>=1,ct>>=1,we=this.tiles[Ro(Ue,Ie,ct)];return we&&we.source?(de>1&&(console.log("found parent tile z%d-%d-%d",Ue,Ie,ct),console.time("drilling down")),this.splitTile(we.source,Ue,Ie,ct,F,U,X),de>1&&console.timeEnd("drilling down"),this.tiles[fe]?la(this.tiles[fe],Q):null):null}}function Ro(Ee,F,U){return 32*((1<<Ee)*U+F)+Ee}function ut(Ee,F){const U=Ee.tileID.canonical;if(!this._geoJSONIndex)return void F(null,null);const X=this._geoJSONIndex.getTile(U.z,U.x,U.y);if(!X)return void F(null,null);const oe=fe=>fe.tags&&"3d_elevation_id"in fe.tags&&"source"in fe.tags&&fe.tags.source==="elevation",Q=X.features.filter(fe=>oe(fe));let de;if(Q.length>0){const fe=X.features.filter(we=>!oe(we));de=new Gt({_geojsonTileLayer:fe,hd_road_elevation:Q})}else de=new Ye(X.features);let xe=Zs(de);xe.byteOffset===0&&xe.byteLength===xe.buffer.byteLength||(xe=new Uint8Array(xe)),F(null,{vectorTile:de,rawData:xe.buffer})}class As extends Ge{constructor(F,U,X,oe,Q,de,xe){super(F,U,X,oe,Q,ut,xe),de&&(this.loadGeoJSON=de),this._dynamicIndex=new Si}loadData(F,U){const X=F&&F.request,oe=X&&X.collectResourceTiming;this.loadGeoJSON(F,(Q,de)=>{if(Q||!de)return U(Q);if(typeof de!="object")return U(new Error(`Input data given to '${F.source}' is not a valid GeoJSON object.`));{try{if(F.filter){const fe=o.X(F.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(fe.result==="error")throw new Error(fe.value.map(we=>`${we.key}: ${we.message}`).join(", "));de.features=de.features.filter(we=>fe.value.evaluate({zoom:0},we))}F.dynamic?(de.type==="Feature"&&(de={type:"FeatureCollection",features:[de]}),F.append||(this._dynamicIndex.clear(),this.loaded={}),this._dynamicIndex.load(de.features,this.loaded),F.cluster&&(de.features=this._dynamicIndex.getFeatures())):this.loaded={},this._geoJSONIndex=F.cluster?new Es(function({superclusterOptions:fe,clusterProperties:we}){if(!we||!fe)return fe;const Ue={},Ie={},ct={accumulated:null,zoom:0},Ct={properties:null},Pt=Object.keys(we);for(const Ht of Pt){const[Wt,Yt]=we[Ht],ci=o.X(Yt),ei=o.X(typeof Wt=="string"?[Wt,["accumulated"],["get",Ht]]:Wt);Ue[Ht]=ci.value,Ie[Ht]=ei.value}return fe.map=Ht=>{Ct.properties=Ht;const Wt={};for(const Yt of Pt)Wt[Yt]=Ue[Yt].evaluate(ct,Ct);return Wt},fe.reduce=(Ht,Wt)=>{Ct.properties=Wt;for(const Yt of Pt)ct.accumulated=Ht[Yt],Ht[Yt]=Ie[Yt].evaluate(ct,Ct)},fe}(F)).load(de.features):F.dynamic?this._dynamicIndex:function(fe,we){return new dc(fe,we)}(de,F.geojsonVtOptions)}catch(fe){return U(fe)}const xe={};if(oe){const fe=Ae(X);fe&&(xe.resourceTiming={},xe.resourceTiming[F.source]=JSON.parse(JSON.stringify(fe)))}U(null,xe)}})}reloadTile(F,U){const X=this.loaded;return X&&X[F.uid]?F.partial?U(null,void 0):super.reloadTile(F,U):this.loadTile(F,U)}loadGeoJSON(F,U){if(F.request)o.n(F.request,U);else{if(typeof F.data!="string")return U(new Error(`Input data given to '${F.source}' is not a valid GeoJSON object.`));try{return U(null,JSON.parse(F.data))}catch{return U(new Error(`Input data given to '${F.source}' is not a valid GeoJSON object.`))}}}getClusterExpansionZoom(F,U){try{U(null,this._geoJSONIndex.getClusterExpansionZoom(F.clusterId))}catch(X){U(X)}}getClusterChildren(F,U){try{U(null,this._geoJSONIndex.getChildren(F.clusterId))}catch(X){U(X)}}getClusterLeaves(F,U){try{U(null,this._geoJSONIndex.getLeaves(F.clusterId,F.limit,F.offset))}catch(X){U(X)}}}class Fu{constructor(F,U,X){this.tileID=new o.aM(F.tileID.overscaledZ,F.tileID.wrap,F.tileID.canonical.z,F.tileID.canonical.x,F.tileID.canonical.y),this.tileZoom=F.tileZoom,this.uid=F.uid,this.zoom=F.zoom,this.canonical=F.tileID.canonical,this.pixelRatio=F.pixelRatio,this.tileSize=F.tileSize,this.source=F.source,this.overscaling=this.tileID.overscaleFactor(),this.projection=F.projection,this.brightness=U,this.worldview=X}parse(F,U,X,oe){this.status="parsing";const Q=new o.aM(X.tileID.overscaledZ,X.tileID.wrap,X.tileID.canonical.z,X.tileID.canonical.x,X.tileID.canonical.y),de=[],xe=U.familiesBySource[X.source],fe=new o.f0(Q,X.promoteId);fe.bucketLayerIDs=[],fe.is3DTile=!0,o.fi(F).then(we=>{if(!we)return oe(new Error("Could not parse tile"));const Ue=we.json.extensionsUsed&&we.json.extensionsUsed.includes("MAPBOX_mesh_features")||we.json.asset.extras&&we.json.asset.extras.MAPBOX_mesh_features,Ie=we.json.extensionsUsed&&we.json.extensionsUsed.includes("EXT_meshopt_compression"),ct=new o.aa(this.zoom,{brightness:this.brightness,worldview:this.worldview});for(const Ct in xe)for(const Pt of xe[Ct]){const Ht=Pt[0];fe.bucketLayerIDs.push(Pt.map(ci=>o.C(ci.id,ci.scope))),Ht.recalculate(ct,[]);const Wt=o.fj(we,1/o.cU(X.tileID.canonical)),Yt=new o.fk(Pt,Wt,Q,Ue,Ie,this.brightness,fe,this.worldview);Ue||(Yt.needsUpload=!0),de.push(Yt),Yt.evaluate(Ht)}this.status="done",oe(null,{buckets:de,featureIndex:fe,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:null})}).catch(we=>oe(new Error(we.message)))}}class sl{constructor(F,U,X,oe,Q,de,xe,fe){this.actor=F,this.layerIndex=U,this.availableImages=X,this.availableModels=oe,this.brightness=xe,this.loading={},this.loaded={},this.worldview=fe}loadTile(F,U){const X=F.uid,oe=this.loading[X]=new Fu(F,this.brightness,this.worldview);o.br(F.request,(Q,de)=>{const xe=!this.loading[X];return delete this.loading[X],xe||Q?(oe.status="done",xe||(this.loaded[X]=oe),U(Q)):de&&de.byteLength!==0?void oe.parse(de,this.layerIndex,F,(fe,we)=>{oe.status="done",this.loaded=this.loaded||{},this.loaded[X]=oe,fe||!we?U(fe):U(null,we)}):(oe.status="done",this.loaded[X]=oe,U())})}reloadTile(F,U){const X=this.loaded,oe=F.uid;if(X&&X[oe]){const Q=X[oe];Q.projection=F.projection,Q.brightness=F.brightness;const de=(xe,fe)=>{Q.reloadCallback&&(delete Q.reloadCallback,this.loadTile(F,U)),U(xe,fe)};Q.status==="parsing"?Q.reloadCallback=de:Q.status==="done"&&this.loadTile(F,U)}}abortTile(F,U){const X=F.uid;this.loading[X]&&delete this.loading[X],U()}removeTile(F,U){const X=this.loaded,oe=F.uid;X&&X[oe]&&delete X[oe],U()}}class wi{constructor(F){this.self=F,this.actor=new o.fm(F,this),this.layerIndexes={},this.availableImages={},this.availableModels={},this.isSpriteLoaded={},this.imageRasterizer=new o.y,this.rtlPluginParsingListeners=[],this.projections={},this.defaultProjection=o.ce({name:"mercator"}),this.workerSourceTypes={vector:Ge,geojson:As,"raster-dem":at,"raster-array":vt,"batched-model":sl},this.workerSources={},this.self.registerWorkerSource=(U,X)=>{if(this.workerSourceTypes[U])throw new Error(`Worker source with name "${U}" already registered.`);this.workerSourceTypes[U]=X},this.self.registerRTLTextPlugin=U=>{if(o.fn.isParsed())throw new Error("RTL text plugin already registered.");o.fn.setState({pluginStatus:o.fo.parsed,pluginURL:o.fn.getPluginURL()}),o.fn.applyArabicShaping=U.applyArabicShaping,o.fn.processBidirectionalText=U.processBidirectionalText,o.fn.processStyledBidirectionalText=U.processStyledBidirectionalText;for(const X of this.rtlPluginParsingListeners)X(null,!0);this.rtlPluginParsingListeners=[]}}clearCaches(F,U,X){delete this.layerIndexes[F],delete this.availableImages[F],delete this.availableModels[F],delete this.workerSources[F],X()}checkIfReady(F,U,X){X()}setReferrer(F,U){this.referrer=U}spriteLoaded(F,U){this.isSpriteLoaded[F]||(this.isSpriteLoaded[F]={});const{scope:X,isLoaded:oe}=U;if(this.isSpriteLoaded[F][X]=oe,this.workerSources[F]&&this.workerSources[F][X])for(const Q in this.workerSources[F][X]){const de=this.workerSources[F][X][Q];for(const xe in de){const fe=de[xe];fe instanceof Ge&&(fe.isSpriteLoaded=oe,fe.fire(new o.A("isSpriteLoaded")))}}}setImages(F,U,X){this.availableImages[F]||(this.availableImages[F]={});const{scope:oe,images:Q}=U;if(this.availableImages[F][oe]=Q,this.workerSources[F]&&this.workerSources[F][oe]){for(const de in this.workerSources[F][oe]){const xe=this.workerSources[F][oe][de];for(const fe in xe)xe[fe].availableImages=Q}X()}else X()}setModels(F,{scope:U,models:X},oe){if(this.availableModels[F]||(this.availableModels[F]={}),this.availableModels[F][U]=X,this.workerSources[F]&&this.workerSources[F][U]){for(const Q in this.workerSources[F][U]){const de=this.workerSources[F][U][Q];for(const xe in de)de[xe].availableModels=X}oe()}else oe()}setProjection(F,U){this.projections[F]=o.ce(U)}setBrightness(F,U,X){this.brightness=U,X()}setWorldview(F,U,X){this.worldview=U,X()}setLayers(F,U,X){this.getLayerIndex(F,U.scope).replace(U.layers,U.options),X()}updateLayers(F,U,X){this.getLayerIndex(F,U.scope).update(U.layers,U.removedIds,U.options),X()}loadTile(F,U,X){U.projection=this.projections[F]||this.defaultProjection,this.getWorkerSource(F,U.type,U.source,U.scope).loadTile(U,X)}decodeRasterArray(F,U,X){this.getWorkerSource(F,U.type,U.source,U.scope).decodeRasterArray(U,X)}reloadTile(F,U,X){U.projection=this.projections[F]||this.defaultProjection,this.getWorkerSource(F,U.type,U.source,U.scope).reloadTile(U,X)}abortTile(F,U,X){this.getWorkerSource(F,U.type,U.source,U.scope).abortTile(U,X)}removeTile(F,U,X){this.getWorkerSource(F,U.type,U.source,U.scope).removeTile(U,X)}removeSource(F,U,X){if(!(this.workerSources[F]&&this.workerSources[F][U.scope]&&this.workerSources[F][U.scope][U.type]&&this.workerSources[F][U.scope][U.type][U.source]))return;const oe=this.workerSources[F][U.scope][U.type][U.source];delete this.workerSources[F][U.scope][U.type][U.source],oe.removeSource!==void 0?oe.removeSource(U,X):X()}loadWorkerSource(F,U,X){try{this.self.importScripts(U.url),X()}catch(oe){X(oe.toString())}}syncRTLPluginState(F,U,X){if(o.fn.isParsed())X(null,!0);else if(o.fn.isParsing())this.rtlPluginParsingListeners.push(X);else try{o.fn.setState(U);const oe=o.fn.getPluginURL();!o.fn.isLoaded()||o.fn.isParsed()||o.fn.isParsing()||oe==null||(o.fn.setState({pluginStatus:o.fo.parsing,pluginURL:o.fn.getPluginURL()}),this.self.importScripts(oe),o.fn.isParsed()?X(null,!0):this.rtlPluginParsingListeners.push(X))}catch(oe){X(oe.toString())}}setDracoUrl(F,U){this.dracoUrl=U}getAvailableImages(F,U){this.availableImages[F]||(this.availableImages[F]={});let X=this.availableImages[F][U];return X||(X=[]),X}getAvailableModels(F,U){this.availableModels[F]||(this.availableModels[F]={});let X=this.availableModels[F][U];return X||(X={}),X}getLayerIndex(F,U){this.layerIndexes[F]||(this.layerIndexes[F]={});let X=this.layerIndexes[F][U];return X||(X=this.layerIndexes[F][U]=new ht,X.scope=U),X}getWorkerSource(F,U,X,oe){const Q=this.workerSources;return Q[F]||(Q[F]={}),Q[F][oe]||(Q[F][oe]={}),Q[F][oe][U]||(Q[F][oe][U]={}),this.isSpriteLoaded[F]||(this.isSpriteLoaded[F]={}),Q[F][oe][U][X]||(Q[F][oe][U][X]=new this.workerSourceTypes[U]({send:(de,xe,fe,we,Ue,Ie)=>this.actor.send(de,xe,fe,F,Ue,Ie),scheduler:this.actor.scheduler},this.getLayerIndex(F,oe),this.getAvailableImages(F,oe),this.getAvailableModels(F,oe),this.isSpriteLoaded[F][oe],void 0,this.brightness,this.worldview)),Q[F][oe][U][X]}rasterizeImagesWorker(F,U,X){const oe=new Map;for(const[Q,{image:de,imageVariant:xe}]of U.tasks.entries()){const fe=this.imageRasterizer.rasterize(xe,de,U.scope,F);oe.set(Q,fe)}X(void 0,oe)}removeRasterizedImages(F,U,X){this.imageRasterizer.removeImagesFromCacheByIds(U.imageIds,U.scope,F),X()}enforceCacheSizeLimit(F,U){o.fp(U)}getWorkerPerformanceMetrics(F,U,X){X(void 0,void 0)}}return o.fl(self)&&(self.worker=new wi(self)),wi}),be(["./shared"],function(o){var Ae="3.13.0";const Ce={create:"create",load:"load",fullLoad:"fullLoad"},ot={mark(l){performance.mark(l)},measure(l,t,n){performance.measure(l,t,n)}};function ht(l){const t=l.name.split("?")[0];return o.a(t)&&t.includes("mapbox-gl.js")?"javascript":o.a(t)&&t.includes("mapbox-gl.css")?"css":o.b(t)?"fontRange":o.c(t)?"sprite":o.i(t)?"style":o.d(t)?"tilejson":"other"}var zt,qt={},st=function(){if(zt)return qt;function l(c){return!t(c)}function t(c){return typeof window>"u"||typeof document>"u"?"not a browser":function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var f,m,y=new Blob([""],{type:"text/javascript"}),v=URL.createObjectURL(y);try{m=new Worker(v),f=!0}catch{f=!1}return m&&m.terminate(),URL.revokeObjectURL(v),f}()?function(){var f=document.createElement("canvas");f.width=f.height=1;var m=f.getContext("2d");if(!m)return!1;var y=m.getImageData(0,0,1,1);return y&&y.width===f.width}()?(n[d=c&&c.failIfMajorPerformanceCaveat]===void 0&&(n[d]=function(f){var m,y=function(v){var T=document.createElement("canvas"),S=Object.create(l.webGLContextAttributes);return S.failIfMajorPerformanceCaveat=v,T.getContext("webgl2",S)}(f);if(!y)return!1;try{m=y.createShader(y.VERTEX_SHADER)}catch{return!1}return!(!m||y.isContextLost())&&(y.shaderSource(m,"void main() {}"),y.compileShader(m),y.getShaderParameter(m,y.COMPILE_STATUS)===!0)}(d)),n[d]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL2 support"):"insufficient Canvas/getImageData support":"insufficient worker support";var d}zt=1,qt.supported=l,qt.notSupportedReason=t;var n={};return l.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0},qt}();function re(l,t,n){const c=document.createElement(l);return t!=null&&(c.className=t),n&&n.appendChild(c),c}function Ge(l,t,n){const c=document.createElementNS("http://www.w3.org/2000/svg",l);for(const d of Object.keys(t))c.setAttributeNS(null,d,String(t[d]));return n&&n.appendChild(c),c}const at=typeof document<"u"?document.documentElement&&document.documentElement.style:null,It=at&&at.userSelect!==void 0?"userSelect":"WebkitUserSelect";let vt;function nt(){at&&It&&(vt=at[It],at[It]="none")}function $e(){at&&It&&(at[It]=vt)}function Ye(l){l.preventDefault(),l.stopPropagation(),window.removeEventListener("click",Ye,!0)}function yt(){window.addEventListener("click",Ye,!0),window.setTimeout(()=>{window.removeEventListener("click",Ye,!0)},0)}function Gt(l,t){const n=l.getBoundingClientRect();return Si(l,n,t)}function gi(l,t){const n=l.getBoundingClientRect(),c=[];for(let d=0;d<t.length;d++)c.push(Si(l,n,t[d]));return c}function xi(l){return/firefox/i.test(navigator.userAgent)&&/macintosh/i.test(navigator.userAgent)&&l.button===2&&l.ctrlKey?0:l.button}function Si(l,t,n){const c=l.offsetWidth===t.width?1:l.offsetWidth/t.width;return new o.P((n.clientX-t.left)*c,(n.clientY-t.top)*c)}const Dr="01",Rr="NO_ACCESS_TOKEN";class Ei{constructor(t,n,c){this._transformRequestFn=t,this._customAccessToken=n,this._silenceAuthErrors=!!c,this._createSkuToken()}_createSkuToken(){const t=function(){let n="";for(let c=0;c<10;c++)n+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",Dr,n].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=t.token,this._skuTokenExpiresAt=t.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(t,n){return this._transformRequestFn&&this._transformRequestFn(t,n)||{url:t}}normalizeStyleURL(t,n){if(!o.j(t))return t;const c=Or(t);return c.params.push(`sdk=js-${Ae}`),c.path=`/styles/v1${c.path}`,this._makeAPIURL(c,this._customAccessToken||n)}normalizeGlyphsURL(t,n){if(!o.j(t))return t;const c=Or(t);return c.path=`/fonts/v1${c.path}`,this._makeAPIURL(c,this._customAccessToken||n)}normalizeModelURL(t,n){if(!o.j(t))return t;const c=Or(t);return c.path=`/models/v1${c.path}`,this._makeAPIURL(c,this._customAccessToken||n)}normalizeSourceURL(t,n,c,d){if(!o.j(t))return t;const f=Or(t);return f.path=`/v4/${f.authority}.json`,f.params.push("secure"),c&&f.params.push(`language=${c}`),d&&f.params.push(`worldview=${d}`),this._makeAPIURL(f,this._customAccessToken||n)}normalizeIconsetURL(t,n){const c=Or(t);return o.j(t)?(c.path=`/styles/v1${c.path}/iconset.pbf`,this._makeAPIURL(c,this._customAccessToken||n)):Nn(c)}normalizeSpriteURL(t,n,c,d){const f=Or(t);return o.j(t)?(f.path=`/styles/v1${f.path}/sprite${n}${c}`,this._makeAPIURL(f,this._customAccessToken||d)):(f.path+=`${n}${c}`,Nn(f))}normalizeTileURL(t,n,c){if(this._isSkuTokenExpired()&&this._createSkuToken(),t&&!o.j(t))return t;const d=Or(t);d.path=d.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${n||c&&d.authority!=="raster"&&c===512?"@2x":""}${o.l.supported?".webp":"$1"}`),d.authority==="raster"?d.path=`/${o.e.RASTER_URL_PREFIX}${d.path}`:d.authority==="rasterarrays"?d.path=`/${o.e.RASTERARRAYS_URL_PREFIX}${d.path}`:d.authority==="3dtiles"?d.path=`/${o.e.TILES3D_URL_PREFIX}${d.path}`:(d.path=d.path.replace(/^.+\/v4\//,"/"),d.path=`/${o.e.TILE_URL_VERSION}${d.path}`);const f=this._customAccessToken||function(m){for(const y of m){const v=y.match(/^access_token=(.*)$/);if(v)return v[1]}return null}(d.params)||o.e.ACCESS_TOKEN;return o.e.REQUIRE_ACCESS_TOKEN&&f&&this._skuToken&&d.params.push(`sku=${this._skuToken}`),this._makeAPIURL(d,f)}canonicalizeTileURL(t,n){const c=Or(t);if(!c.path.match(/^(\/v4\/|\/(raster|rasterarrays)\/v1\/)/)||!c.path.match(/\.[\w]+$/))return t;let d="mapbox://";c.path.match(/^\/raster\/v1\//)?d+=`raster/${c.path.replace(`/${o.e.RASTER_URL_PREFIX}/`,"")}`:c.path.match(/^\/rasterarrays\/v1\//)?d+=`rasterarrays/${c.path.replace(`/${o.e.RASTERARRAYS_URL_PREFIX}/`,"")}`:d+=`tiles/${c.path.replace(`/${o.e.TILE_URL_VERSION}/`,"")}`;let f=c.params;return n&&(f=f.filter(m=>!m.match(/^access_token=/))),f.length&&(d+=`?${f.join("&")}`),d}canonicalizeTileset(t,n){const c=!!n&&o.j(n),d=[];for(const f of t.tiles||[])o.k(f)?d.push(this.canonicalizeTileURL(f,c)):d.push(f);return d}_makeAPIURL(t,n){const c="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",d=Or(o.e.API_URL);if(t.protocol=d.protocol,t.authority=d.authority,t.protocol==="http"){const f=t.params.indexOf("secure");f>=0&&t.params.splice(f,1)}if(d.path!=="/"&&(t.path=`${d.path}${t.path}`),!o.e.REQUIRE_ACCESS_TOKEN)return Nn(t);if(n=n||o.e.ACCESS_TOKEN,!this._silenceAuthErrors){if(!n)throw new Error(`An API access token is required to use Mapbox GL. ${c}`);if(n[0]==="s")throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${c}`)}return t.params=t.params.filter(f=>f.indexOf("access_token")===-1),t.params.push(`access_token=${n||""}`),Nn(t)}}const zr=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function Or(l){const t=l.match(zr);if(!t)throw new Error("Unable to parse URL object");return{protocol:t[1],authority:t[2],path:t[3]||"/",params:t[4]?t[4].split("&"):[]}}function Nn(l){const t=l.params.length?`?${l.params.join("&")}`:"";return`${l.protocol}://${l.authority}${l.path}${t}`}const Vn="mapbox.eventData";function Un(l){if(!l)return null;const t=l.split(".");if(!t||t.length!==3)return null;try{return JSON.parse(o.m(t[1]))}catch{return null}}class rr{constructor(t){this.type=t,this.anonId=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(t){const n=Un(o.e.ACCESS_TOKEN);let c="";return c=n&&n.u?o.f(n.u):o.e.ACCESS_TOKEN||"",t?`${Vn}.${t}:${c}`:`${Vn}:${c}`}fetchEventData(){const t=o.s("localStorage"),n=this.getStorageKey(),c=this.getStorageKey("uuid");if(t)try{const d=localStorage.getItem(n);d&&(this.eventData=JSON.parse(d));const f=localStorage.getItem(c);f&&(this.anonId=f)}catch{o.w("Unable to read from LocalStorage")}}saveEventData(){const t=o.s("localStorage"),n=this.getStorageKey(),c=this.getStorageKey("uuid"),d=this.anonId;if(t&&d)try{localStorage.setItem(c,d),Object.keys(this.eventData).length>=1&&localStorage.setItem(n,JSON.stringify(this.eventData))}catch{o.w("Unable to write to LocalStorage")}}processRequests(t){}postEvent(t,n,c,d){if(!o.e.EVENTS_URL)return;const f=Or(o.e.EVENTS_URL);f.params.push(`access_token=${d||o.e.ACCESS_TOKEN||""}`);const m={event:this.type,created:new Date(t).toISOString()},y=n?o.h(m,n):m,v={url:Nn(f),headers:{"Content-Type":"text/plain"},body:JSON.stringify([y])};this.pendingRequest=o.p(v,T=>{this.pendingRequest=null,c(T),this.saveEventData(),this.processRequests(d)})}queueRequest(t,n){this.queue.push(t),this.processRequests(n)}}const fn=new class extends rr{constructor(l){super("appUserTurnstile"),this._customAccessToken=l}postTurnstileEvent(l,t){o.e.EVENTS_URL&&o.e.ACCESS_TOKEN&&Array.isArray(l)&&l.some(n=>o.j(n)||o.k(n))&&this.queueRequest(Date.now(),t)}processRequests(l){if(this.pendingRequest||this.queue.length===0)return;this.anonId&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();const t=Un(o.e.ACCESS_TOKEN),n=t?t.u:o.e.ACCESS_TOKEN;let c=n!==this.eventData.tokenU;o.v(this.anonId)||(this.anonId=o.u(),c=!0);const d=this.queue.shift();if(this.eventData.lastSuccess){const f=new Date(this.eventData.lastSuccess),m=new Date(d),y=(d-this.eventData.lastSuccess)/864e5;c=c||y>=1||y<-1||f.getDate()!==m.getDate()}else c=!0;c?this.postEvent(d,{sdkIdentifier:"mapbox-gl-js",sdkVersion:Ae,skuId:Dr,"enabled.telemetry":!1,userId:this.anonId},f=>{f||(this.eventData.lastSuccess=d,this.eventData.tokenU=n)},l):this.processRequests()}},pn=fn.postTurnstileEvent.bind(fn),Ts=new class extends rr{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(l,t,n,c){this.skuToken=t,this.errorCb=c,o.e.EVENTS_URL&&(n||o.e.ACCESS_TOKEN?this.queueRequest({id:l,timestamp:Date.now()},n):this.errorCb(new Error(Rr)))}processRequests(l){if(this.pendingRequest||this.queue.length===0)return;const{id:t,timestamp:n}=this.queue.shift();t&&this.success[t]||(this.anonId||this.fetchEventData(),o.v(this.anonId)||(this.anonId=o.u()),this.postEvent(n,{sdkIdentifier:"mapbox-gl-js",sdkVersion:Ae,skuId:Dr,skuToken:this.skuToken,userId:this.anonId},c=>{c?this.errorCb(c):t&&(this.success[t]=!0)},l))}remove(){this.errorCb=null}},Zs=Ts.postMapLoadEvent.bind(Ts),mr=new class extends rr{constructor(){super("style.load"),this.eventIdPerMapInstanceMap=new Map,this.mapInstanceIdMap=new WeakMap}getMapInstanceId(l){let t=this.mapInstanceIdMap.get(l);return t||(t=o.u(),this.mapInstanceIdMap.set(l,t)),t}getEventId(l){const t=this.eventIdPerMapInstanceMap.get(l)||0;return this.eventIdPerMapInstanceMap.set(l,t+1),t}postStyleLoadEvent(l,t){const{map:n,style:c,importedStyles:d}=t;if(!o.e.EVENTS_URL||!l&&!o.e.ACCESS_TOKEN)return;const f=this.getMapInstanceId(n),m={mapInstanceId:f,eventId:this.getEventId(f),style:c};d.length&&(m.importedStyles=d),this.queueRequest({timestamp:Date.now(),payload:m},l)}processRequests(l){if(this.pendingRequest||this.queue.length===0)return;const{timestamp:t,payload:n}=this.queue.shift();this.postEvent(t,n,()=>{},l)}},Ar=mr.postStyleLoadEvent.bind(mr),$i=new class extends rr{constructor(){super("gljs.performance")}postPerformanceEvent(l,t){o.e.EVENTS_URL&&(l||o.e.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:t},l)}processRequests(l){if(this.pendingRequest||this.queue.length===0)return;const{timestamp:t,performanceData:n}=this.queue.shift(),c=function(d){const f=performance.getEntriesByType("resource"),m=performance.getEntriesByType("mark"),y=function(M){const D={};if(M){for(const z in M)if(z!=="other")for(const O of M[z]){const B=`${z}ResolveRangeMin`,V=`${z}ResolveRangeMax`,H=`${z}RequestCount`,Y=`${z}RequestCachedCount`;D[B]=Math.min(D[B]||1/0,O.startTime),D[V]=Math.max(D[V]||-1/0,O.responseEnd);const te=ee=>{D[ee]===void 0&&(D[ee]=0),++D[ee]};O.transferSize!==void 0&&O.transferSize===0&&te(Y),te(H)}}return D}(function(M,D){const z={};if(M)for(const O of M){const B=D(O);z[B]===void 0&&(z[B]=[]),z[B].push(O)}return z}(f,ht)),v=window.devicePixelRatio,T=navigator.connection||navigator.mozConnection||navigator.webkitConnection,S=T?T.effectiveType:void 0,C={counters:[],metadata:[],attributes:[]},I=(M,D,z)=>{z!=null&&M.push({name:D,value:z.toString()})};for(const M in y)I(C.counters,M,y[M]);if(d.interactionRange[0]!==1/0&&d.interactionRange[1]!==-1/0&&(I(C.counters,"interactionRangeMin",d.interactionRange[0]),I(C.counters,"interactionRangeMax",d.interactionRange[1])),m)for(const M of Object.keys(Ce)){const D=Ce[M],z=m.find(O=>O.name===D);z&&I(C.counters,D,z.startTime)}return I(C.counters,"visibilityHidden",d.visibilityHidden),I(C.attributes,"style",function(M){if(M)for(const D of M){const z=D.name.split("?")[0];if(o.i(z)){const O=z.split("/").slice(-2);if(O.length===2)return`mapbox://styles/${O[0]}/${O[1]}`}}}(f)),I(C.attributes,"terrainEnabled",d.terrainEnabled?"true":"false"),I(C.attributes,"fogEnabled",d.fogEnabled?"true":"false"),I(C.attributes,"projection",d.projection),I(C.attributes,"zoom",d.zoom),I(C.metadata,"devicePixelRatio",v),I(C.metadata,"connectionEffectiveType",S),I(C.metadata,"navigatorUserAgent",navigator.userAgent),I(C.metadata,"screenWidth",window.screen.width),I(C.metadata,"screenHeight",window.screen.height),I(C.metadata,"windowWidth",window.innerWidth),I(C.metadata,"windowHeight",window.innerHeight),I(C.metadata,"mapWidth",d.width/v),I(C.metadata,"mapHeight",d.height/v),I(C.metadata,"webglRenderer",d.renderer),I(C.metadata,"webglVendor",d.vendor),I(C.metadata,"sdkVersion",Ae),I(C.metadata,"sdkIdentifier","mapbox-gl-js"),C}(n);for(const d of c.metadata);for(const d of c.counters);for(const d of c.attributes);this.postEvent(t,c,()=>{},l)}},Zr=$i.postPerformanceEvent.bind($i),ji=new class extends rr{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(l,t,n,c){if(!o.e.API_URL||!o.e.SESSION_PATH)return;const d=Or(o.e.API_URL+o.e.SESSION_PATH);d.params.push(`sku=${t||""}`),d.params.push(`access_token=${c||o.e.ACCESS_TOKEN||""}`);const f={url:Nn(d),headers:{"Content-Type":"text/plain"}};this.pendingRequest=o.g(f,m=>{this.pendingRequest=null,n(m),this.saveEventData(),this.processRequests(c)})}getSessionAPI(l,t,n,c){this.skuToken=t,this.errorCb=c,o.e.SESSION_PATH&&o.e.API_URL&&(n||o.e.ACCESS_TOKEN?this.queueRequest({id:l,timestamp:Date.now()},n):this.errorCb(new Error(Rr)))}processRequests(l){if(this.pendingRequest||this.queue.length===0)return;const{id:t,timestamp:n}=this.queue.shift();t&&this.success[t]||this.getSession(n,this.skuToken,c=>{c?this.errorCb(c):t&&(this.success[t]=!0)},l)}remove(){this.errorCb=null}},Ss=ji.getSessionAPI.bind(ji),Es=new Set;function rs(l,t){t?Es.add(l):Es.delete(l)}class Br{constructor(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps=new Set,this._updatedImages={}}isDirty(){return this._changed}setDirty(){this._changed=!0}getUpdatedSourceCaches(){return this._updatedSourceCaches}updateSourceCache(t,n){this._updatedSourceCaches[t]=n,this.setDirty()}discardSourceCacheUpdate(t){delete this._updatedSourceCaches[t]}updateLayer(t){const n=t.scope;this._updatedLayers[n]=this._updatedLayers[n]||new Set,this._updatedLayers[n].add(t.id),this.setDirty()}removeLayer(t){const n=t.scope;this._removedLayers[n]=this._removedLayers[n]||{},this._updatedLayers[n]=this._updatedLayers[n]||new Set,this._removedLayers[n][t.id]=t,this._updatedLayers[n].delete(t.id),this._updatedPaintProps.delete(t.fqid),this.setDirty()}getRemovedLayer(t){return this._removedLayers[t.scope]?this._removedLayers[t.scope][t.id]:null}discardLayerRemoval(t){this._removedLayers[t.scope]&&delete this._removedLayers[t.scope][t.id]}getLayerUpdatesByScope(){const t={};for(const n in this._updatedLayers)t[n]=t[n]||{},t[n].updatedIds=Array.from(this._updatedLayers[n].values());for(const n in this._removedLayers)t[n]=t[n]||{},t[n].removedIds=Object.keys(this._removedLayers[n]);return t}getUpdatedPaintProperties(){return this._updatedPaintProps}updatePaintProperties(t){this._updatedPaintProps.add(t.fqid),this.setDirty()}getUpdatedImages(t){return this._updatedImages[t]?Array.from(this._updatedImages[t].values()):[]}updateImage(t,n){this._updatedImages[n]=this._updatedImages[n]||new Set,this._updatedImages[n].add(o.I.toString(t)),this.setDirty()}resetUpdatedImages(t){this._updatedImages[t]&&this._updatedImages[t].clear()}reset(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps.clear(),this._updatedImages={}}}function na(l){const{userImage:t}=l;return!!(t&&t.render&&t.render())&&(l.data.replace(new Uint8Array(t.data.buffer)),!0)}class Ws extends o.E{constructor(t){super(),this.imageProviders=new Map,this.images=new Map,this.updatedImages=new Map,this.callbackDispatchedThisFrame=new Map,this.loaded=new Map,this.requestors=[],this.patterns=new Map,this.patternsInFlight=new Set,this.atlasImage=new Map,this.atlasTexture=new Map,this.dirty=!0,this.spriteFormat=t,t!=="raster"&&o.t()&&(this.imageRasterizerDispatcher=new o.D(o.x(),this,"Image Rasterizer Worker",1))}addScope(t){this.loaded.set(t,!1),this.imageProviders.set(t,new Map),this.images.set(t,new Map),this.updatedImages.set(t,new Set),this.callbackDispatchedThisFrame.set(t,new Set),this.patterns.set(t,new Map),this.atlasImage.set(t,new o.r({width:1,height:1}))}removeScope(t){this.loaded.delete(t),this.imageProviders.delete(t),this.images.delete(t),this.updatedImages.delete(t),this.callbackDispatchedThisFrame.delete(t),this.patterns.delete(t),this.atlasImage.delete(t);const n=this.atlasTexture.get(t);n&&(n.destroy(),this.atlasTexture.delete(t))}addImageProvider(t,n){this.imageProviders.has(n)||this.imageProviders.set(n,new Map),this.imageProviders.get(n).set(t.id,t)}removeImageProvider(t,n){this.imageProviders.has(n)&&this.imageProviders.get(n).delete(t)}getPendingImageProviders(){const t=[];for(const n of this.imageProviders.values())for(const c of n.values())c.hasPendingRequests()&&t.push(c);return t}get imageRasterizer(){return this._imageRasterizer||(this._imageRasterizer=new o.y),this._imageRasterizer}isLoaded(){for(const t of this.loaded.keys())if(!this.loaded.get(t))return!1;return!0}setLoaded(t,n){if(this.loaded.get(n)!==t&&(this.loaded.set(n,t),t)){for(const{ids:c,callback:d}of this.requestors)this._notify(c,n,d);this.requestors=[]}}hasImage(t,n){return!!this.getImage(t,n)}getImage(t,n){return this.images.get(n).get(t.toString())}addImage(t,n,c){this._validate(t,c)&&this.images.get(n).set(t.toString(),c)}_validate(t,n){let c=!0;return this._validateStretch(n.stretchX,n.data&&n.data.width)||(this.fire(new o.z(new Error(`Image "${t.name}" has invalid "stretchX" value`))),c=!1),this._validateStretch(n.stretchY,n.data&&n.data.height)||(this.fire(new o.z(new Error(`Image "${t.name}" has invalid "stretchY" value`))),c=!1),this._validateContent(n.content,n)||(this.fire(new o.z(new Error(`Image "${t.name}" has invalid "content" value`))),c=!1),c}_validateStretch(t,n){if(!t)return!0;let c=0;for(const d of t){if(d[0]<c||d[1]<d[0]||n<d[1])return!1;c=d[1]}return!0}_validateContent(t,n){return t?t.length!==4||!n.usvg&&(t[0]<0||n.data.width<t[0]||t[1]<0||n.data.height<t[1]||t[2]<0||n.data.width<t[2]||t[3]<0||n.data.height<t[3])?!1:!(t[2]<t[0]||t[3]<t[1]):!0}updateImage(t,n,c){const d=this.images.get(n).get(t.toString());c.version=d.version+1,this.images.get(n).set(t.toString(),c),this.updatedImages.get(n).add(t),this.removeFromImageRasterizerCache(t,n)}clearUpdatedImages(t){this.updatedImages.get(t).clear()}removeFromImageRasterizerCache(t,n){this.spriteFormat!=="raster"&&(o.t()?this.imageRasterizerDispatcher.getActor().send("removeRasterizedImages",{imageIds:[t],scope:n}):this.imageRasterizer.removeImagesFromCacheByIds([t],n))}removeImage(t,n){const c=this.images.get(n),d=c.get(t.toString());c.delete(t.toString()),this.patterns.get(n).delete(t.toString()),this.removeFromImageRasterizerCache(t,n),d.userImage&&d.userImage.onRemove&&d.userImage.onRemove()}listImages(t){return Array.from(this.images.get(t).keys()).map(n=>o.I.from(n))}getImages(t,n,c){const d=[],f=[],m=this.imageProviders.get(n);for(const S of t){if(!S.iconsetId){d.push(S);continue}const C=m.get(S.iconsetId);C&&(this.getImage(S,n)?f.push(S):C.addPendingRequest(S))}if(d.length===0)return void this._notify(f,n,c);let y=!0;const v=!!this.loaded.get(n),T=this.images.get(n);if(!v)for(const S of d)T.has(S.toString())||(y=!1);v||y?this._notify(d,n,c):this.requestors.push({ids:d,scope:n,callback:c})}rasterizeImages(t,n){const c=new Map,{tasks:d,scope:f}=t;for(const[m,y]of d.entries()){const v=this.getImage(y.id,f);v&&c.set(m,{image:v,imageVariant:y})}this._rasterizeImages(f,c,n)}_rasterizeImages(t,n,c){if(o.t())this.imageRasterizerDispatcher.getActor().send("rasterizeImagesWorker",{tasks:n,scope:t},c);else{const d=new Map;for(const[f,{image:m,imageVariant:y}]of n.entries())d.set(f,this.imageRasterizer.rasterize(y,m,t,0));c(void 0,d)}}getUpdatedImages(t){return this.updatedImages.get(t)||new Set}_notify(t,n,c){const d=this.images.get(n),f=new Map;for(const m of t){if(!d.get(m.toString())){if(m.iconsetId)continue;this.fire(new o.A("styleimagemissing",{id:m.name}))}const y=d.get(m.toString());if(!y){o.w(`Image "${m.name}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`);continue}const v={data:y.usvg?null:y.data.clone(),pixelRatio:y.pixelRatio,sdf:y.sdf,usvg:y.usvg,version:y.version,stretchX:y.stretchX,stretchY:y.stretchY,content:y.content,hasRenderCallback:!!(y.userImage&&y.userImage.render)};y.usvg&&Object.assign(v,{width:y.icon.usvg_tree.width,height:y.icon.usvg_tree.height}),f.set(o.I.toString(m),v)}c(null,f)}getPixelSize(t){const{width:n,height:c}=this.atlasImage.get(t);return{width:n,height:c}}getPattern(t,n,c){const d=t.toString(),f=this.patterns.get(n),m=f.get(d),y=this.getImage(t,n);if(!y)return null;if(m){if(m.position.version===y.version)return m.position;m.position.version=y.version}else{if(y.usvg&&!y.data){const v=this.getPatternInFlightId(d,n);if(this.patternsInFlight.has(v))return null;this.patternsInFlight.add(v);const T=new o.B(t).scaleSelf(o.q.devicePixelRatio),S=new Map([[T.toString(),{image:y,imageVariant:T}]]);return this._rasterizeImages(n,S,(C,I)=>this.storePatternImage(T,n,y,c,I)),null}this.storePattern(t,n,y)}return this._updatePatternAtlas(n,c),f.get(d).position}getPatternInFlightId(t,n){return o.C(t,n)}hasPatternsInFlight(){return this.patternsInFlight.size!==0}storePatternImage(t,n,c,d,f){const m=t.toString(),y=f?f.get(m):void 0;y&&(c.data=y,this.storePattern(t.id,n,c),this._updatePatternAtlas(n,d),this.patternsInFlight.delete(this.getPatternInFlightId(t.id.toString(),n)))}storePattern(t,n,c){const d={w:c.data.width+2*o.F,h:c.data.height+2*o.F,x:0,y:0},f=new o.G(d,c,o.F);this.patterns.get(n).set(t.toString(),{bin:d,position:f})}bind(t,n){const c=t.gl;let d=this.atlasTexture.get(n);d?this.dirty&&(d.update(this.atlasImage.get(n)),this.dirty=!1):(d=new o.T(t,this.atlasImage.get(n),c.RGBA8),this.atlasTexture.set(n,d)),d.bind(c.LINEAR,c.CLAMP_TO_EDGE)}_updatePatternAtlas(t,n){const c=this.patterns.get(t),d=Array.from(c.values()).map(({bin:T})=>T),{w:f,h:m}=o.H(d),y=this.atlasImage.get(t);y.resize({width:f||1,height:m||1});const v=this.images.get(t);for(const[T,{bin:S,position:C}]of c.entries()){let I=C.padding;const M=S.x+I,D=S.y+I,z=v.get(T).data,O=z.width,B=z.height;I=I>1?I-1:I,o.r.copy(z,y,{x:0,y:0},{x:M,y:D},{width:O,height:B},n),o.r.copy(z,y,{x:0,y:B-I},{x:M,y:D-I},{width:O,height:I},n),o.r.copy(z,y,{x:0,y:0},{x:M,y:D+B},{width:O,height:I},n),o.r.copy(z,y,{x:O-I,y:0},{x:M-I,y:D},{width:I,height:B},n),o.r.copy(z,y,{x:0,y:0},{x:M+O,y:D},{width:I,height:B},n),o.r.copy(z,y,{x:O-I,y:B-I},{x:M-I,y:D-I},{width:I,height:I},n),o.r.copy(z,y,{x:0,y:B-I},{x:M+O,y:D-I},{width:I,height:I},n),o.r.copy(z,y,{x:0,y:0},{x:M+O,y:D+B},{width:I,height:I},n),o.r.copy(z,y,{x:O-I,y:0},{x:M-I,y:D+B},{width:I,height:I},n)}this.dirty=!0}beginFrame(){for(const t of this.images.keys())this.callbackDispatchedThisFrame.set(t,new Set)}dispatchRenderCallbacks(t,n){const c=this.images.get(n);for(const d of t){if(this.callbackDispatchedThisFrame.get(n).has(d.toString()))continue;this.callbackDispatchedThisFrame.get(n).add(d.toString());const f=c.get(d.toString());na(f)&&this.updateImage(d,n,f)}}}function mn(l){const t=l.key,n=l.value,c=l.valueSpec||{},d=l.objectElementValidators||{},f=l.style,m=l.styleSpec;let y=[];const v=o.J(n);if(v!=="object")return[new o.V(t,n,`object expected, ${v} found`)];for(const T in n){const S=T.split(".")[0];let C;d[S]?C=d[S]:c[S]?C=pr:d["*"]?C=d["*"]:c["*"]&&(C=pr),C?y=y.concat(C({key:(t&&`${t}.`)+T,value:n[T],valueSpec:c[S]||c["*"],style:f,styleSpec:m,object:n,objectKey:T},n)):y.push(new o.K(t,n[T],`unknown property "${T}"`))}for(const T in c)d[T]||c[T].required&&c[T].default===void 0&&n[T]===void 0&&y.push(new o.V(t,n,`missing required property "${T}"`));return y}function Co(l){const t=l.value,n=l.valueSpec,c=l.style,d=l.styleSpec,f=l.key,m=l.arrayElementValidator||pr;if(o.J(t)!=="array")return[new o.V(f,t,`array expected, ${o.J(t)} found`)];if(n.length&&t.length!==n.length)return[new o.V(f,t,`array length ${n.length} expected, length ${t.length} found`)];if(n["min-length"]&&t.length<n["min-length"])return[new o.V(f,t,`array length at least ${n["min-length"]} expected, length ${t.length} found`)];let y={type:n.value,values:n.values,minimum:n.minimum,maximum:n.maximum,function:void 0};d.$version<7&&(y.function=n.function),o.J(n.value)==="object"&&(y=n.value);let v=[];for(let T=0;T<t.length;T++)v=v.concat(m({array:t,arrayIndex:T,value:t[T],valueSpec:y,style:c,styleSpec:d,key:`${f}[${T}]`},!0));return v}function rl(l){const t=l.key,n=l.value,c=l.valueSpec;let d=o.J(n);if(d==="number"&&n!=n&&(d="NaN"),d!=="number")return[new o.V(t,n,`number expected, ${d} found`)];if("minimum"in c){let f=c.minimum;if(o.J(c.minimum)==="array"&&(f=c.minimum[l.arrayIndex]),n<f)return[new o.V(t,n,`${n} is less than the minimum value ${f}`)]}if("maximum"in c){let f=c.maximum;if(o.J(c.maximum)==="array"&&(f=c.maximum[l.arrayIndex]),n>f)return[new o.V(t,n,`${n} is greater than the maximum value ${f}`)]}return[]}function _n(l){const t=l.valueSpec,n=o.M(l.value.type);let c,d,f,m={};const y=n!=="categorical"&&l.value.property===void 0,v=!y,T=o.J(l.value.stops)==="array"&&o.J(l.value.stops[0])==="array"&&o.J(l.value.stops[0][0])==="object",S=mn({key:l.key,value:l.value,valueSpec:l.styleSpec.function,style:l.style,styleSpec:l.styleSpec,objectElementValidators:{stops:function(M){if(n==="identity")return[new o.V(M.key,M.value,'identity function may not have a "stops" property')];let D=[];const z=M.value;return D=D.concat(Co({key:M.key,value:z,valueSpec:M.valueSpec,style:M.style,styleSpec:M.styleSpec,arrayElementValidator:C})),o.J(z)==="array"&&z.length===0&&D.push(new o.V(M.key,z,"array must have at least one stop")),D},default:function(M){return pr({key:M.key,value:M.value,valueSpec:t,style:M.style,styleSpec:M.styleSpec})}}});return n==="identity"&&y&&S.push(new o.V(l.key,l.value,'missing required property "property"')),n==="identity"||l.value.stops||S.push(new o.V(l.key,l.value,'missing required property "stops"')),n==="exponential"&&l.valueSpec.expression&&!o.N(l.valueSpec)&&S.push(new o.V(l.key,l.value,"exponential functions not supported")),l.styleSpec.$version>=8&&(v&&!o.O(l.valueSpec)?S.push(new o.V(l.key,l.value,"property functions not supported")):y&&!o.Q(l.valueSpec)&&S.push(new o.V(l.key,l.value,"zoom functions not supported"))),n!=="categorical"&&!T||l.value.property!==void 0||S.push(new o.V(l.key,l.value,'"property" property is required')),S;function C(M){let D=[];const z=M.value,O=M.key;if(o.J(z)!=="array")return[new o.V(O,z,`array expected, ${o.J(z)} found`)];if(z.length!==2)return[new o.V(O,z,`array length 2 expected, length ${z.length} found`)];if(T){if(o.J(z[0])!=="object")return[new o.V(O,z,`object expected, ${o.J(z[0])} found`)];if(z[0].zoom===void 0)return[new o.V(O,z,"object stop key must have zoom")];if(z[0].value===void 0)return[new o.V(O,z,"object stop key must have value")];const B=o.M(z[0].zoom);if(typeof B!="number")return[new o.V(O,z[0].zoom,"stop zoom values must be numbers")];if(f&&f>B)return[new o.V(O,z[0].zoom,"stop zoom values must appear in ascending order")];B!==f&&(f=B,d=void 0,m={}),D=D.concat(mn({key:`${O}[0]`,value:z[0],valueSpec:{zoom:{}},style:M.style,styleSpec:M.styleSpec,objectElementValidators:{zoom:rl,value:I}}))}else D=D.concat(I({key:`${O}[0]`,value:z[0],style:M.style,styleSpec:M.styleSpec},z));return o.S(o.U(z[1]))?D.concat([new o.V(`${O}[1]`,z[1],"expressions are not allowed in function stops.")]):D.concat(pr({key:`${O}[1]`,value:z[1],valueSpec:t,style:M.style,styleSpec:M.styleSpec}))}function I(M,D){const z=o.J(M.value),O=o.M(M.value),B=M.value!==null?M.value:D;if(c){if(z!==c)return[new o.V(M.key,B,`${z} stop domain type must match previous stop domain type ${c}`)]}else c=z;if(z!=="number"&&z!=="string"&&z!=="boolean"&&typeof O!="number"&&typeof O!="string"&&typeof O!="boolean")return[new o.V(M.key,B,"stop domain value must be a number, string, or boolean")];if(z!=="number"&&n!=="categorical"){let V=`number expected, ${z} found`;return o.O(t)&&n===void 0&&(V+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new o.V(M.key,B,V)]}return n!=="categorical"||z!=="number"||typeof O=="number"&&isFinite(O)&&Math.floor(O)===O?n!=="categorical"&&z==="number"&&typeof O=="number"&&typeof d=="number"&&d!==void 0&&O<d?[new o.V(M.key,B,"stop domain values must appear in ascending order")]:(d=O,n==="categorical"&&O in m?[new o.V(M.key,B,"stop domain values must be unique")]:(m[O]=!0,[])):[new o.V(M.key,B,`integer expected, found ${String(O)}`)]}}function Pn(l){const t=(l.expressionContext==="property"?o.W:o.X)(o.U(l.value),l.valueSpec);if(t.result==="error")return t.value.map(c=>new o.V(`${l.key}${c.key}`,l.value,c.message));const n=t.value.expression||t.value._styleExpression.expression;if(l.expressionContext==="property"&&l.propertyKey==="text-font"&&!n.outputDefined())return[new o.V(l.key,l.value,`Invalid data expression for "${l.propertyKey}". Output values must be contained as literals within the expression.`)];if(l.expressionContext==="property"&&l.propertyType==="layout"&&!o.Y(n))return[new o.V(l.key,l.value,'"feature-state" data expressions are not supported with layout properties.')];if(l.expressionContext==="filter")return Xs(n,l);if(l.expressionContext&&l.expressionContext.indexOf("cluster")===0){if(!o.Z(n,["zoom","feature-state"]))return[new o.V(l.key,l.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(l.expressionContext==="cluster-initial"&&!o._(n))return[new o.V(l.key,l.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function Xs(l,t){const n=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(t.valueSpec&&t.valueSpec.expression)for(const d of t.valueSpec.expression.parameters)n.delete(d);if(n.size===0)return[];const c=[];return l instanceof o.$&&n.has(l.name)?[new o.V(t.key,t.value,`["${l.name}"] expression is not supported in a filter for a ${t.object.type} layer with id: ${t.object.id}`)]:(l.eachChild(d=>{c.push(...Xs(d,t))}),c)}function Ys(l){const t=l.key,n=l.value,c=l.valueSpec,d=[];return Array.isArray(c.values)?c.values.indexOf(o.M(n))===-1&&d.push(new o.V(t,n,`expected one of [${c.values.join(", ")}], ${JSON.stringify(n)} found`)):Object.keys(c.values).indexOf(o.M(n))===-1&&d.push(new o.V(t,n,`expected one of [${Object.keys(c.values).join(", ")}], ${JSON.stringify(n)} found`)),d}function Ks(l){return o.a1(o.U(l.value))?Pn(o.L({},l,{expressionContext:"filter",valueSpec:l.styleSpec[`filter_${l.layerType||"fill"}`]})):gn(l)}function gn(l){const t=l.value,n=l.key;if(o.J(t)!=="array")return[new o.V(n,t,`array expected, ${o.J(t)} found`)];const c=l.styleSpec;let d,f=[];if(t.length<1)return[new o.V(n,t,"filter array must have at least 1 element")];switch(f=f.concat(Ys({key:`${n}[0]`,value:t[0],valueSpec:c.filter_operator,style:l.style,styleSpec:l.styleSpec})),o.M(t[0])){case"<":case"<=":case">":case">=":t.length>=2&&o.M(t[1])==="$type"&&f.push(new o.V(n,t,`"$type" cannot be use with operator "${t[0]}"`));case"==":case"!=":t.length!==3&&f.push(new o.V(n,t,`filter array for operator "${t[0]}" must have 3 elements`));case"in":case"!in":t.length>=2&&(d=o.J(t[1]),d!=="string"&&f.push(new o.V(`${n}[1]`,t[1],`string expected, ${d} found`)));for(let m=2;m<t.length;m++)d=o.J(t[m]),o.M(t[1])==="$type"?f=f.concat(Ys({key:`${n}[${m}]`,value:t[m],valueSpec:c.geometry_type,style:l.style,styleSpec:l.styleSpec})):d!=="string"&&d!=="number"&&d!=="boolean"&&f.push(new o.V(`${n}[${m}]`,t[m],`string, number, or boolean expected, ${d} found`));break;case"any":case"all":case"none":for(let m=1;m<t.length;m++)f=f.concat(gn({key:`${n}[${m}]`,value:t[m],style:l.style,styleSpec:l.styleSpec}));break;case"has":case"!has":d=o.J(t[1]),t.length!==2?f.push(new o.V(n,t,`filter array for "${t[0]}" operator must have 2 elements`)):d!=="string"&&f.push(new o.V(`${n}[1]`,t[1],`string expected, ${d} found`))}return f}function sa(l,t){const n=l.key,c=l.style,d=l.layer,f=l.styleSpec,m=l.value,y=l.objectKey,v=f[`${t}_${l.layerType}`];if(!v)return[];const T=y.match(/^(.*)-use-theme$/);if(t==="paint"&&T&&v[T[1]])return o.S(m)?[].concat(pr({key:l.key,value:m,valueSpec:{type:"string",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},style:c,styleSpec:f,expressionContext:"property",propertyType:t,propertyKey:y})):pr({key:n,value:m,valueSpec:{type:"string"},style:c,styleSpec:f});const S=y.match(/^(.*)-transition$/);if(t==="paint"&&S&&v[S[1]]&&v[S[1]].transition)return pr({key:n,value:m,valueSpec:f.transition,style:c,styleSpec:f});const C=l.valueSpec||v[y];if(!C)return[new o.K(n,m,`unknown property "${y}"`)];let I;if(o.J(m)==="string"&&o.O(C)&&!C.tokens&&(I=/^{([^}]+)}$/.exec(m))){const D=`\`{ "type": "identity", "property": ${I?JSON.stringify(I[1]):'"_"'} }\``;return[new o.V(n,m,`"${y}" does not support interpolation syntax
Use an identity property function instead: ${D}.`)]}const M=[];if(l.layerType==="symbol")y!=="text-field"||!c||c.glyphs||c.imports||M.push(new o.V(n,m,'use of "text-field" requires a style "glyphs" property')),y==="text-font"&&o.a2(o.U(m))&&o.M(m.type)==="identity"&&M.push(new o.V(n,m,'"text-font" does not support identity functions'));else if(l.layerType==="model"&&t==="paint"&&d&&d.layout&&d.layout.hasOwnProperty("model-id")&&o.O(C)&&(o.a3(C)||o.Q(C))){const D=o.W(o.U(m),C),z=D.value.expression||D.value._styleExpression.expression;z&&!o.Z(z,["measure-light"])&&(y==="model-emissive-strength"&&o._(z)&&o.Y(z)||M.push(new o.V(n,m,`${y} does not support measure-light expressions when the model layer source is vector tile or GeoJSON.`)))}return M.concat(pr({key:l.key,value:m,valueSpec:C,style:c,styleSpec:f,expressionContext:"property",propertyType:t,propertyKey:y}))}function oa(l){return sa(l,"paint")}function Rn(l){return sa(l,"layout")}function nl(l){let t=[];const n=l.value,c=l.key,d=l.style,f=l.styleSpec;n.type||n.ref||t.push(new o.V(c,n,'either "type" or "ref" is required'));let m=o.M(n.type);const y=o.M(n.ref);if(n.id){const v=o.M(n.id);for(let T=0;T<l.arrayIndex;T++){const S=d.layers[T];o.M(S.id)===v&&t.push(new o.V(c,n.id,`duplicate layer id "${n.id}", previously used at line ${S.id.__line__}`))}}if("ref"in n){let v;["type","source","source-layer","filter","layout"].forEach(T=>{T in n&&t.push(new o.V(c,n[T],`"${T}" is prohibited for ref layers`))}),d.layers.forEach(T=>{o.M(T.id)===y&&(v=T)}),v?v.ref?t.push(new o.V(c,n.ref,"ref cannot reference another ref layer")):m=o.M(v.type):typeof y=="string"&&t.push(new o.V(c,n.ref,`ref layer "${y}" not found`))}else if(m!=="background"&&m!=="sky"&&m!=="slot")if(n.source){const v=d.sources&&d.sources[n.source],T=v&&o.M(v.type);v?T==="vector"&&m==="raster"?t.push(new o.V(c,n.source,`layer "${n.id}" requires a raster source`)):T==="raster"&&m!=="raster"?t.push(new o.V(c,n.source,`layer "${n.id}" requires a vector source`)):T!=="vector"||n["source-layer"]?T==="raster-dem"&&m!=="hillshade"?t.push(new o.V(c,n.source,"raster-dem source can only be used with layer type 'hillshade'.")):T!=="raster-array"||["raster","raster-particle"].includes(m)?m==="line"&&n.paint&&(n.paint["line-gradient"]||n.paint["line-trim-offset"])&&T==="geojson"&&!v.lineMetrics?t.push(new o.V(c,n,`layer "${n.id}" specifies a line-gradient, which requires the GeoJSON source to have \`lineMetrics\` enabled.`)):m==="raster-particle"&&T!=="raster-array"&&t.push(new o.V(c,n.source,`layer "${n.id}" requires a 'raster-array' source.`)):t.push(new o.V(c,n.source,"raster-array source can only be used with layer type 'raster'.")):t.push(new o.V(c,n,`layer "${n.id}" must specify a "source-layer"`)):t.push(new o.V(c,n.source,`source "${n.source}" not found`))}else t.push(new o.V(c,n,'missing required property "source"'));return t=t.concat(mn({key:c,value:n,valueSpec:f.layer,style:l.style,styleSpec:l.styleSpec,objectElementValidators:{"*":()=>[],type:()=>pr({key:`${c}.type`,value:n.type,valueSpec:f.layer.type,style:l.style,styleSpec:l.styleSpec,object:n,objectKey:"type"}),filter:v=>Ks(o.L({layerType:m},v)),layout:v=>mn({layer:n,key:v.key,value:v.value,valueSpec:{},style:v.style,styleSpec:v.styleSpec,objectElementValidators:{"*":T=>Rn(o.L({layerType:m},T))}}),paint:v=>mn({layer:n,key:v.key,value:v.value,valueSpec:{},style:v.style,styleSpec:v.styleSpec,objectElementValidators:{"*":T=>oa(o.L({layerType:m,layer:n},T))}})}})),t}function Is(l){const t=l.value,n=l.key,c=o.J(t);return c!=="string"?[new o.V(n,t,`string expected, ${c} found`)]:[]}const aa={promoteId:function l({key:t,value:n}){if(o.J(n)==="string")return Is({key:t,value:n});if(Array.isArray(n)){const c=[],d=o.U(n),f=o.X(d);return f.result==="error"&&f.value.forEach(m=>{c.push(new o.V(`${t}${m.key}`,null,`${m.message}`))}),o.Z(f.value.expression,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])||c.push(new o.V(`${t}`,null,"promoteId expression should be only feature dependent")),c}{const c=[];for(const d in n)c.push(...l({key:`${t}.${d}`,value:n[d]}));return c}}};function an(l){const t=l.value,n=l.key,c=l.styleSpec,d=l.style;if(!t.type)return[new o.V(n,t,'"type" is required')];const f=o.M(t.type);let m=[];switch(["vector","raster","raster-dem","raster-array"].includes(f)&&(t.url||t.tiles||m.push(new o.K(n,t,'Either "url" or "tiles" is required.'))),f){case"vector":case"raster":case"raster-dem":case"raster-array":return m=m.concat(mn({key:n,value:t,valueSpec:c[`source_${f.replace("-","_")}`],style:l.style,styleSpec:c,objectElementValidators:aa})),m;case"geojson":if(m=mn({key:n,value:t,valueSpec:c.source_geojson,style:d,styleSpec:c,objectElementValidators:aa}),t.cluster)for(const y in t.clusterProperties){const[v,T]=t.clusterProperties[y],S=typeof v=="string"?[v,["accumulated"],["get",y]]:v;m.push(...Pn({key:`${n}.${y}.map`,value:T,expressionContext:"cluster-map"})),m.push(...Pn({key:`${n}.${y}.reduce`,value:S,expressionContext:"cluster-reduce"}))}return m;case"video":return mn({key:n,value:t,valueSpec:c.source_video,style:d,styleSpec:c});case"image":return mn({key:n,value:t,valueSpec:c.source_image,style:d,styleSpec:c});case"canvas":return[new o.V(n,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return Ys({key:`${n}.type`,value:t.type,valueSpec:{values:Wn(c)}})}}function Wn(l){return l.source.reduce((t,n)=>{const c=l[n];return c.type.type==="enum"&&(t=t.concat(Object.keys(c.type.values))),t},[])}function Mo(l){const t=l.value,n=l.styleSpec,c=n.light,d=l.style;let f=[];const m=o.J(t);if(t===void 0)return f;if(m!=="object")return f=f.concat([new o.V("light",t,`object expected, ${m} found`)]),f;for(const y in t){const v=y.match(/^(.*)-transition$/),T=y.match(/^(.*)-use-theme$/);f=f.concat(T&&c[T[1]]?pr({key:y,value:t[y],valueSpec:{type:"string"},style:d,styleSpec:n}):v&&c[v[1]]&&c[v[1]].transition?pr({key:y,value:t[y],valueSpec:n.transition,style:d,styleSpec:n}):c[y]?pr({key:y,value:t[y],valueSpec:c[y],style:d,styleSpec:n}):[new o.V(y,t[y],`unknown property "${y}"`)])}return f}function Js(l){const t=l.value;let n=[];if(!t)return n;const c=o.J(t);if(c!=="object")return n=n.concat([new o.V("light-3d",t,`object expected, ${c} found`)]),n;const d=l.styleSpec,f=d["light-3d"],m=l.key,y=l.style,v=l.style.lights;for(const C of["type","id"])if(!(C in t))return n=n.concat([new o.V("light-3d",t,`missing property ${C} on light`)]),n;if(t.type&&v)for(let C=0;C<l.arrayIndex;C++){const I=o.M(t.type),M=v[C];o.M(M.type)===I&&n.push(new o.V(m,t.id,`duplicate light type "${t.type}", previously defined at line ${M.id.__line__}`))}const T=`properties_light_${t.type}`;if(!(T in d))return n=n.concat([new o.V("light-3d",t,`Invalid light type ${t.type}`)]),n;const S=d[T];for(const C in t)if(C==="properties"){const I=t[C],M=o.J(I);if(M!=="object")return n=n.concat([new o.V("properties",I,`object expected, ${M} found`)]),n;for(const D in I){const z=D.match(/^(.*)-transition$/),O=D.match(/^(.*)-use-theme$/);n=n.concat(O&&S[O[1]]?pr({key:C,value:I[D],valueSpec:{type:"string"},style:y,styleSpec:d}):z&&S[z[1]]&&S[z[1]].transition?pr({key:C,value:t[C],valueSpec:d.transition,style:y,styleSpec:d}):S[D]?pr({key:D,value:I[D],valueSpec:S[D],style:y,styleSpec:d}):[new o.K(l.key,I[D],`unknown property "${D}"`)])}}else n=n.concat(f[C]?pr({key:C,value:t[C],valueSpec:f[C],style:y,styleSpec:d}):[new o.K(C,t[C],`unknown property "${C}"`)]);return n}function Po(l){const t=l.value,n=l.key,c=l.style,d=l.styleSpec,f=d.terrain;let m=[];const y=o.J(t);if(t===void 0||y==="null")return m;if(y!=="object")return m=m.concat([new o.V("terrain",t,`object expected, ${y} found`)]),m;for(const v in t){const T=v.match(/^(.*)-transition$/),S=v.match(/^(.*)-use-theme$/);m=m.concat(S&&f[S[1]]?pr({key:v,value:t[v],valueSpec:{type:"string"},style:c,styleSpec:d}):T&&f[T[1]]&&f[T[1]].transition?pr({key:v,value:t[v],valueSpec:d.transition,style:c,styleSpec:d}):f[v]?pr({key:v,value:t[v],valueSpec:f[v],style:c,styleSpec:d}):[new o.K(v,t[v],`unknown property "${v}"`)])}if(t.source){const v=c.sources&&c.sources[t.source],T=v&&o.M(v.type);v?T!=="raster-dem"&&m.push(new o.V(n,t.source,`terrain cannot be used with a source of type ${String(T)}, it only be used with a "raster-dem" source type`)):m.push(new o.V(n,t.source,`source "${t.source}" not found`))}else m.push(new o.V(n,t,'terrain is missing required property "source"'));return m}function Qs(l){const t=l.value,n=l.style,c=l.styleSpec,d=c.fog;let f=[];const m=o.J(t);if(t===void 0)return f;if(m!=="object")return f=f.concat([new o.V("fog",t,`object expected, ${m} found`)]),f;for(const y in t){const v=y.match(/^(.*)-transition$/),T=y.match(/^(.*)-use-theme$/);f=f.concat(T&&d[T[1]]?pr({key:y,value:t[y],valueSpec:{type:"string"},style:n,styleSpec:c}):v&&d[v[1]]&&d[v[1]].transition?pr({key:y,value:t[y],valueSpec:c.transition,style:n,styleSpec:c}):d[y]?pr({key:y,value:t[y],valueSpec:d[y],style:n,styleSpec:c}):[new o.K(y,t[y],`unknown property "${y}"`)])}return f}const la={"*":()=>[],array:Co,boolean:function(l){const t=l.value,n=l.key,c=o.J(t);return c!=="boolean"?[new o.V(n,t,`boolean expected, ${c} found`)]:[]},number:rl,color:function(l){const t=l.key,n=l.value,c=o.J(n);return c!=="string"?[new o.V(t,n,`color expected, ${c} found`)]:o.a0.parseCSSColor(n)===null?[new o.V(t,n,`color expected, "${n}" found`)]:[]},enum:Ys,filter:Ks,function:_n,layer:nl,object:mn,source:an,model:o.a4,light:Mo,"light-3d":Js,terrain:Po,fog:Qs,string:Is,formatted:function(l){return Is(l).length===0?[]:Pn(l)},resolvedImage:function(l){return Is(l).length===0?[]:Pn(l)},projection:function(l){const t=l.value,n=l.styleSpec,c=n.projection,d=l.style;let f=[];const m=o.J(t);if(m==="object")for(const y in t)f=f.concat(pr({key:y,value:t[y],valueSpec:c[y],style:d,styleSpec:n}));else m!=="string"&&(f=f.concat([new o.V("projection",t,`object or string expected, ${m} found`)]));return f},import:function(l){const{value:t,styleSpec:n}=l,{data:c,...d}=t;Object.defineProperty(d,"__line__",{value:t.__line__,enumerable:!1});let f=mn(o.L({},l,{value:d,valueSpec:n.import}));return o.M(d.id)===""&&f.push(new o.V(`${l.key}.id`,d,"import id can't be an empty string")),c&&(f=f.concat(ca(c,n,{key:`${l.key}.data`}))),f},iconset:function(l){const t=l.value,n=l.key,c=l.styleSpec,d=l.style;if(!t.type)return[new o.V(n,t,'"type" is required')];const f=o.M(t.type);let m=[];if(m=m.concat(mn({key:n,value:t,valueSpec:c[`iconset_${f}`],style:d,styleSpec:c})),f==="source"&&t.source){const y=d.sources&&d.sources[t.source],v=y&&o.M(y.type);y?v!=="raster-array"&&m.push(new o.V(n,t.source,`iconset cannot be used with a source of type ${String(v)}, it only be used with a "raster-array" source type`)):m.push(new o.V(n,t.source,`source "${t.source}" not found`))}return m}};function pr(l,t=!1){const n=l.value,c=l.valueSpec,d=l.styleSpec;if(c.expression&&o.a2(o.M(n)))return _n(l);if(c.expression&&o.S(o.U(n)))return Pn(l);if(c.type&&la[c.type]){const f=la[c.type](l);return t===!0&&f.length>0&&o.J(l.value)==="array"?Pn(l):f}return mn(o.L({},l,{valueSpec:c.type?d[c.type]:c}))}function eo(l){const t=l.value,n=l.key,c=Is(l);return c.length||(t.indexOf("{fontstack}")===-1&&c.push(new o.V(n,t,'"glyphs" url must include a "{fontstack}" token')),t.indexOf("{range}")===-1&&c.push(new o.V(n,t,'"glyphs" url must include a "{range}" token'))),c}function ca(l,t=o.a5,n={}){return pr({key:n.key||"",value:l,valueSpec:t.$root,styleSpec:t,style:l,objectElementValidators:{glyphs:eo,"*":()=>[]}})}function zn(l,t=o.a5){return oe(ca(l,t))}const ku=l=>oe(an(l)),dc=l=>oe(Mo(l)),Ro=l=>oe(Js(l)),ut=l=>oe(Po(l)),As=l=>oe(Qs(l)),Fu=l=>oe(function(t){const n=t.value,c=t.style,d=t.styleSpec,f=d.snow;let m=[];const y=o.J(n);if(n===void 0)return m;if(y!=="object")return m=m.concat([new o.V("snow",n,`object expected, ${y} found`)]),m;for(const v in n){const T=v.match(/^(.*)-transition$/);m=m.concat(T&&f[T[1]]&&f[T[1]].transition?pr({key:v,value:n[v],valueSpec:d.transition,style:c,styleSpec:d}):f[v]?pr({key:v,value:n[v],valueSpec:f[v],style:c,styleSpec:d}):[new o.K(v,n[v],`unknown property "${v}"`)])}return m}(l)),sl=l=>oe(function(t){const n=t.value,c=t.style,d=t.styleSpec,f=d.rain;let m=[];const y=o.J(n);if(n===void 0)return m;if(y!=="object")return m=m.concat([new o.V("rain",n,`object expected, ${y} found`)]),m;for(const v in n){const T=v.match(/^(.*)-transition$/);m=m.concat(T&&f[T[1]]&&f[T[1]].transition?pr({key:v,value:n[v],valueSpec:d.transition,style:c,styleSpec:d}):f[v]?pr({key:v,value:n[v],valueSpec:f[v],style:c,styleSpec:d}):[new o.K(v,n[v],`unknown property "${v}"`)])}return m}(l)),wi=l=>oe(nl(l)),Ee=l=>oe(Ks(l)),F=l=>oe(oa(l)),U=l=>oe(Rn(l)),X=l=>oe(o.a4(l));function oe(l){return l.slice().sort((t,n)=>t.line&&n.line?t.line-n.line:0)}function Q(l,t){let n=!1;if(t&&t.length)for(const c of t)c instanceof o.K?o.w(c.message):(l.fire(new o.z(new Error(c.message))),n=!0);return n}let de;class xe extends o.E{constructor(t,n="flat"){super(),this._transitionable=new o.a6(de||(de=new o.a7({anchor:new o.a8(o.a5.light.anchor),position:new o.a9(o.a5.light.position),color:new o.a8(o.a5.light.color),intensity:new o.a8(o.a5.light.intensity)}))),this.setLight(t,n),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(t,n,c={}){this._validate(dc,t,c)||(this._transitionable.setTransitionOrValue(t),this.id=n)}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,n,c){return(!c||c.validate!==!1)&&Q(this,t.call(zn,o.h({value:n,style:{glyphs:!0,sprite:!0},styleSpec:o.a5})))}}let fe=class extends o.E{constructor(l,t,n,c,d){super(),this.scope=n,this._transitionable=new o.a6(new o.a7({source:new o.a8(o.a5.terrain.source),exaggeration:new o.a8(o.a5.terrain.exaggeration)}),n,c),this._transitionable.setTransitionOrValue(l,c),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=t,this.worldview=d}get(){return this._transitionable.serialize()}set(l,t){this._transitionable.setTransitionOrValue(l,t)}updateTransitions(l){this._transitioning=this._transitionable.transitioned(l,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(l){this.properties=this._transitioning.possiblyEvaluate(l)}getExaggeration(l){return this._transitioning.possiblyEvaluate(new o.aa(l,{worldview:this.worldview})).get("exaggeration")}getAttenuationRange(){if(!this.isZoomDependent())return null;const l=this._transitionable._values.exaggeration;if(!l)return null;const t=l.value.expression;if(!t)return null;let n=-1,c=-1,d=1;for(const f of t.zoomStops)d=t.evaluate(new o.aa(f,{worldview:this.worldview})),d>.01?(n=f,c=-1):c=f;return d<.01&&n>0&&c>n?[n,c]:null}isZoomDependent(){const l=this._transitionable._values.exaggeration;return l!=null&&l.value!=null&&l.value.expression!=null&&l.value.expression instanceof o.ab}};const we=45,Ue=65,Ie=.05;function ct(l,t,n,c){const d=o.af(we,Ue,n),[f,m]=Ct(l,c);let y=1-Math.min(1,Math.exp((t-f)/(m-f)*-6));return y*=y*y,y=Math.min(1,1.00747*y),y*d*l.alpha}function Ct(l,t){const n=.5/Math.tan(.5*t);return[l.range[0]+n,l.range[1]+n]}function Pt(l,t,n,c,d){const f=o.ad([],[t,n,c],d.mercatorFogMatrix);return ct(l,o.ae(f),d.pitch,d._fov)}function Ht(l,t,n,c,d,f,m){const y=[[n,c,0],[d,c,0],[d,f,0],[n,f,0]];let v=Number.MAX_VALUE,T=-Number.MAX_VALUE;for(const S of y){const C=o.ad([],S,t),I=o.ae(C);v=Math.min(v,I),T=Math.max(T,I)}return[ct(l,v,m.pitch,m._fov),ct(l,T,m.pitch,m._fov)]}class Wt extends o.E{constructor(t,n,c,d){super();const f=new o.a7({range:new o.a8(o.a5.fog.range),color:new o.a8(o.a5.fog.color),"color-use-theme":new o.a8({type:"string","property-type":"data-constant",default:"default"}),"high-color":new o.a8(o.a5.fog["high-color"]),"high-color-use-theme":new o.a8({type:"string","property-type":"data-constant",default:"default"}),"space-color":new o.a8(o.a5.fog["space-color"]),"space-color-use-theme":new o.a8({type:"string","property-type":"data-constant",default:"default"}),"horizon-blend":new o.a8(o.a5.fog["horizon-blend"]),"star-intensity":new o.a8(o.a5.fog["star-intensity"]),"vertical-range":new o.a8(o.a5.fog["vertical-range"])});this._transitionable=new o.a6(f,c,new Map(d)),this.set(t,d),this._transitioning=this._transitionable.untransitioned(),this._transform=n,this.properties=new o.ag(f),this.scope=c}get state(){const t=this._transform,n=t.projection.name==="globe",c=o.ah(t.zoom),d=this.properties.get("range"),f=[.5,3];return{range:n?[o.ai(f[0],d[0],c),o.ai(f[1],d[1],c)]:d,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(t,n,c={}){if(this._validate(As,t,c))return;const d=o.h({},t);for(const f of Object.keys(o.a5.fog))d[f]===void 0&&(d[f]=o.a5.fog[f].default);this._options=d,this._transitionable.setTransitionOrValue(this._options,n)}getOpacity(t){if(!this._transform.projection.supportsFog)return 0;const n=this.properties&&this.properties.get("color")||1;return(this._transform.projection.name==="globe"?1:o.af(we,Ue,t))*n.a}getOpacityAtLatLng(t,n){return this._transform.projection.supportsFog?function(c,d,f){const m=o.ac.fromLngLat(d),y=f.elevation?f.elevation.getAtPointOrZero(m):0;return Pt(c,m.x,m.y,y,f)}(this.state,t,n):0}getOpacityForTile(t){if(!this._transform.projection.supportsFog)return[1,1];const n=this._transform.calculateFogTileMatrix(t.toUnwrapped());return Ht(this.state,n,0,0,o.aj,o.aj,this._transform)}getOpacityForBounds(t,n,c,d,f){return this._transform.projection.supportsFog?Ht(this.state,t,n,c,d,f,this._transform):[1,1]}getFovAdjustedRange(t){return this._transform.projection.supportsFog?Ct(this.state,t):[0,1]}isVisibleOnFrustum(t){if(!this._transform.projection.supportsFog)return!1;const n=[4,5,6,7];for(const c of n){const d=t.points[c];let f;if(d[2]>=0)f=d;else{const m=t.points[c-4];f=o.ak(m,d,m[2]/(m[2]-d[2]))}if(Pt(this.state,f[0],f[1],0,this._transform)>=Ie)return!0}return!1}updateConfig(t){this._transitionable.setTransitionOrValue(this._options,new Map(t))}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,n,c){return(!c||c.validate!==!1)&&Q(this,t.call(zn,o.h({value:n,style:{glyphs:!0,sprite:!0},styleSpec:o.a5})))}}let Yt,ci,ei,Zi,cr=class extends o.E{constructor(l,t,n,c){super();const d=Yt||(Yt=new o.a7({density:new o.a8(o.a5.snow.density),intensity:new o.a8(o.a5.snow.intensity),color:new o.a8(o.a5.snow.color),opacity:new o.a8(o.a5.snow.opacity),vignette:new o.a8(o.a5.snow.vignette),"vignette-color":new o.a8(o.a5.snow["vignette-color"]),"center-thinning":new o.a8(o.a5.snow["center-thinning"]),direction:new o.a8(o.a5.snow.direction),"flake-size":new o.a8(o.a5.snow["flake-size"])}));this._transitionable=new o.a6(d,n,new Map(c)),this.set(l,c),this._transitioning=this._transitionable.untransitioned(),this.properties=new o.ag(d),this.scope=n}get state(){const l=this.properties.get("opacity"),t=this.properties.get("color"),n=this.properties.get("direction"),c=o.al(n[0]),d=-Math.max(o.al(n[1]),.01),f=[Math.cos(c)*Math.cos(d),Math.sin(c)*Math.cos(d),Math.sin(d)],m=this.properties.get("vignette"),y=this.properties.get("vignette-color");return y.a=m,{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new o.am(t.r,t.g,t.b,t.a*l),direction:f,centerThinning:this.properties.get("center-thinning"),flakeSize:this.properties.get("flake-size"),vignetteColor:y}}get(){return this._transitionable.serialize()}set(l,t,n={}){if(this._validate(Fu,l,n))return;const c=o.h({},l);for(const d of Object.keys(o.a5.snow))c[d]===void 0&&(c[d]=o.a5.snow[d].default);this._options=c,this._transitionable.setTransitionOrValue(this._options,t)}updateConfig(l){this._transitionable.setTransitionOrValue(this._options,new Map(l))}updateTransitions(l){this._transitioning=this._transitionable.transitioned(l,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(l){this.properties=this._transitioning.possiblyEvaluate(l)}_validate(l,t,n){return(!n||n.validate!==!1)&&Q(this,l.call(zn,o.h({value:t,style:{glyphs:!0,sprite:!0},styleSpec:o.a5})))}},ur=class extends o.E{constructor(l,t,n,c){super();const d=ci||(ci=new o.a7({density:new o.a8(o.a5.rain.density),intensity:new o.a8(o.a5.rain.intensity),color:new o.a8(o.a5.rain.color),opacity:new o.a8(o.a5.rain.opacity),vignette:new o.a8(o.a5.rain.vignette),"vignette-color":new o.a8(o.a5.rain["vignette-color"]),"center-thinning":new o.a8(o.a5.rain["center-thinning"]),direction:new o.a8(o.a5.rain.direction),"droplet-size":new o.a8(o.a5.rain["droplet-size"]),"distortion-strength":new o.a8(o.a5.rain["distortion-strength"])}));this._transitionable=new o.a6(d,n,new Map(c)),this.set(l,c),this._transitioning=this._transitionable.untransitioned(),this.properties=new o.ag(d),this.scope=n}get state(){const l=this.properties.get("opacity"),t=this.properties.get("color"),n=this.properties.get("direction"),c=o.al(n[0]),d=-Math.max(o.al(n[1]),.01),f=[Math.cos(c)*Math.cos(d),Math.sin(c)*Math.cos(d),Math.sin(d)],m=this.properties.get("vignette-color");return m.a=this.properties.get("vignette"),{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new o.am(t.r,t.g,t.b,t.a*l),direction:f,centerThinning:this.properties.get("center-thinning"),dropletSize:this.properties.get("droplet-size"),distortionStrength:this.properties.get("distortion-strength"),vignetteColor:m}}get(){return this._transitionable.serialize()}set(l,t,n={}){if(this._validate(sl,l,n))return;const c=o.h({},l);for(const d of Object.keys(o.a5.rain))c[d]===void 0&&(c[d]=o.a5.rain[d].default);this._options=c,this._transitionable.setTransitionOrValue(this._options,t)}updateConfig(l){this._transitionable.setTransitionOrValue(this._options,new Map(l))}updateTransitions(l){this._transitioning=this._transitionable.transitioned(l,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(l){this.properties=this._transitioning.possiblyEvaluate(l)}_validate(l,t,n){return(!n||n.validate!==!1)&&Q(this,l.call(zn,o.h({value:t,style:{glyphs:!0,sprite:!0},styleSpec:o.a5})))}};class ki extends o.E{constructor(t,n,c,d){super(),this.scope=c,this._options=t,this.properties=new o.ag(n),this._transitionable=new o.a6(n,c,new Map(d)),this._transitionable.setTransitionOrValue(t.properties),this._transitioning=this._transitionable.untransitioned()}updateConfig(t){this._transitionable.setTransitionOrValue(this._options.properties,new Map(t))}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}get(){return this._options.properties=this._transitionable.serialize(),this._options}set(t,n){this._options=t,this._transitionable.setTransitionOrValue(t.properties,n)}shadowsEnabled(){return!!this.properties&&this.properties.get("cast-shadows")===!0}}class Ii{constructor(t,n,c,d){this.screenBounds=t,this.cameraPoint=n,this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=c,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,d)}static createFromScreenPoints(t,n){let c,d;if(t instanceof o.P||typeof t[0]=="number"){const f=o.P.convert(t);c=[f],d=n.isPointAboveHorizon(f)}else{const f=o.P.convert(t[0]),m=o.P.convert(t[1]),y=f.add(m)._div(2);c=[f,m],d=o.ao(f,m).every(v=>n.isPointAboveHorizon(v))&&n.isPointAboveHorizon(y)}return new Ii(c,n.getCameraPoint(),d,n)}isPointQuery(){return this.screenBounds.length===1}bufferedScreenGeometry(t){return o.ao(this.screenBounds[0],this.screenBounds.length===1?this.screenBounds[0]:this.screenBounds[1],t)}bufferedCameraGeometry(t){const n=this.screenBounds[0],c=this.screenBounds.length===1?this.screenBounds[0].add(new o.P(1,1)):this.screenBounds[1],d=o.ao(n,c,0,!1);return this.cameraPoint.y>c.y&&(this.cameraPoint.x>n.x&&this.cameraPoint.x<c.x?d.splice(3,0,this.cameraPoint):this.cameraPoint.x>=c.x?d[2]=this.cameraPoint:this.cameraPoint.x<=n.x&&(d[3]=this.cameraPoint)),o.ap(d,t)}bufferedCameraGeometryGlobe(t){const n=this.screenBounds[0],c=this.screenBounds.length===1?this.screenBounds[0].add(new o.P(1,1)):this.screenBounds[1],d=o.ao(n,c,t),f=this.cameraPoint.clone();switch(3*((f.y>n.y)+(f.y>c.y))+((f.x>n.x)+(f.x>c.x))){case 0:d[0]=f,d[4]=f.clone();break;case 1:d.splice(1,0,f);break;case 2:d[1]=f;break;case 3:d.splice(4,0,f);break;case 5:d.splice(2,0,f);break;case 6:d[3]=f;break;case 7:d.splice(3,0,f);break;case 8:d[2]=f}return d}containsTile(t,n,c,d=0){const f=t.queryPadding/n._pixelsPerMercatorPixel+1,m=c?this._bufferedCameraMercator(f,n):this._bufferedScreenMercator(f,n);let y=t.tileID.wrap+(m.unwrapped?d:0);const v=m.polygon.map(O=>o.aq(t.tileTransform,O,y));if(!o.ar(v,0,0,o.aj,o.aj))return;y=t.tileID.wrap+(this.screenGeometryMercator.unwrapped?d:0);const T=this.screenGeometryMercator.polygon.map(O=>o.as(t.tileTransform,O,y)),S=T.map(O=>new o.P(O[0],O[1])),C=n.getFreeCameraOptions().position||new o.ac(0,0,0),I=o.as(t.tileTransform,C,y),M=T.map(O=>{const B=o.at(O,O,I);return o.au(B,B),new o.av(I,B)}),D=o.aw(t,1,n.zoom)*n._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:S,tilespaceRays:M,bufferedTilespaceGeometry:v,bufferedTilespaceBounds:(z=o.ax(v),z.min.x=o.ay(z.min.x,0,o.aj),z.min.y=o.ay(z.min.y,0,o.aj),z.max.x=o.ay(z.max.x,0,o.aj),z.max.y=o.ay(z.max.y,0,o.aj),z),tile:t,tileID:t.tileID,pixelToTileUnitsFactor:D};var z}_bufferedScreenMercator(t,n){const c=_r(t);if(this._screenRaycastCache[c])return this._screenRaycastCache[c];{let d;return d=n.projection.name==="globe"?this._projectAndResample(this.bufferedScreenGeometry(t),n):{polygon:this.bufferedScreenGeometry(t).map(f=>n.pointCoordinate3D(f)),unwrapped:!0},this._screenRaycastCache[c]=d,d}}_bufferedCameraMercator(t,n){const c=_r(t);if(this._cameraRaycastCache[c])return this._cameraRaycastCache[c];{let d;return d=n.projection.name==="globe"?this._projectAndResample(this.bufferedCameraGeometryGlobe(t),n):{polygon:this.bufferedCameraGeometry(t).map(f=>n.pointCoordinate3D(f)),unwrapped:!0},this._cameraRaycastCache[c]=d,d}}_projectAndResample(t,n){const c=function(f,m){const y=o.az([],m.pixelMatrix,m.globeMatrix),v=[0,-o.aB,0,1],T=[0,o.aB,0,1],S=[0,0,0,1];o.aA(v,v,y),o.aA(T,T,y),o.aA(S,S,y);const C=new o.P(v[0]/v[3],v[1]/v[3]),I=new o.P(T[0]/T[3],T[1]/T[3]),M=o.aC(f,C)&&v[3]<S[3],D=o.aC(f,I)&&T[3]<S[3];if(!M&&!D)return null;const z=function(J,K,ie){for(let se=1;se<J.length;se++){const ye=xr(K.pointCoordinate3D(J[se-1]).x),ve=xr(K.pointCoordinate3D(J[se]).x);if(ie<0){if(ye<ve)return{idx:se,t:-ye/(ve-1-ye)}}else if(ve<ye)return{idx:se,t:(1-ye)/(ve+1-ye)}}return null}(f,m,M?-1:1);if(!z)return null;const{idx:O,t:B}=z;let V=O>1?Cr(f.slice(0,O),m):[],H=O<f.length?Cr(f.slice(O),m):[];V=V.map(J=>new o.P(xr(J.x),J.y)),H=H.map(J=>new o.P(xr(J.x),J.y));const Y=[...V];Y.length===0&&Y.push(H[H.length-1]);const te=o.ai(Y[Y.length-1].y,(H.length===0?V[0]:H[0]).y,B);let ee;return ee=M?[new o.P(0,te),new o.P(0,0),new o.P(1,0),new o.P(1,te)]:[new o.P(1,te),new o.P(1,1),new o.P(0,1),new o.P(0,te)],Y.push(...ee),H.length===0?Y.push(V[0]):Y.push(...H),{polygon:Y.map(J=>new o.ac(J.x,J.y)),unwrapped:!1}}(t,n);if(c)return c;const d=function(f,m){let y=!1,v=-1/0,T=0;for(let C=0;C<f.length-1;C++)f[C].x>v&&(v=f[C].x,T=C);for(let C=0;C<f.length-1;C++){const I=(T+C)%(f.length-1),M=f[I],D=f[I+1];Math.abs(M.x-D.x)>.5&&(M.x<D.x?(M.x+=1,I===0&&(f[f.length-1].x+=1)):(D.x+=1,I+1===f.length-1&&(f[0].x+=1)),y=!0)}const S=o.aD(m.center.lng);return y&&S<Math.abs(S-1)&&f.forEach(C=>{C.x-=1}),{polygon:f,unwrapped:y}}(Cr(t,n).map(f=>new o.P(xr(f.x),f.y)),n);return{polygon:d.polygon.map(f=>new o.ac(f.x,f.y)),unwrapped:d.unwrapped}}}function Cr(l,t){return o.aE(l,n=>{const c=t.pointCoordinate3D(n);n.x=c.x,n.y=c.y},1/256)}function xr(l){return l<0?1+l%1:l%1}function _r(l){return 100*l|0}function Xr(l,t,n,c,d){const f=function(y,v){if(y)return d(y);if(v){if(l.url&&v.tiles&&l.tiles&&delete l.tiles,v.variants){if(!Array.isArray(v.variants))return d(new Error("variants must be an array"));for(const S of v.variants){if(S==null||typeof S!="object"||S.constructor!==Object)return d(new Error("variant must be an object"));if(!Array.isArray(S.capabilities))return d(new Error("capabilities must be an array"));if(S.capabilities.length===1&&S.capabilities[0]==="meshopt"){v=o.h(v,S);break}}}const T=o.aF(o.h({},v,l),["tilejson","tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","extra_bounds","scheme","tileSize","encoding","vector_layers","raster_layers","worldview_options","worldview_default","worldview"]);T.tiles=t.canonicalizeTileset(T,l.url),d(null,T)}},m=function(y,v,T){if(!y)return null;if(!v&&!T)return y;T=T||y.worldview_default;const S=Object.values(y.language||{});if(S.length===0)return null;const C=Object.values(y.worldview||{});if(C.length===0)return null;const I=S.every(D=>D===v),M=C.every(D=>D===T);return I&&M?y:v in(y.language_options||{})||T in(y.worldview_options||{})?null:y.language_options&&y.worldview_options?y:null}(l.data,n,c);return m?o.q.frame(()=>f(null,m)):l.url?o.n(t.transformRequest(t.normalizeSourceURL(l.url,null,n,c),o.R.Source),f):o.q.frame(()=>{const{data:y,...v}=l;f(null,v)})}function Sn(l,t){const n=Math.pow(2,t.z),c=Math.floor(o.aD(l.getWest())*n),d=Math.floor(o.aH(l.getNorth())*n),f=Math.ceil(o.aD(l.getEast())*n),m=Math.ceil(o.aH(l.getSouth())*n);return t.x>=c&&t.x<f&&t.y>=d&&t.y<m}class ln{constructor(t,n,c){this.bounds=t?o.aG.convert(this.validateBounds(t)):null,this.minzoom=n||0,this.maxzoom=c||24}validateBounds(t){return Array.isArray(t)&&t.length===4?[Math.max(-180,t[0]),Math.max(-90,t[1]),Math.min(180,t[2]),Math.min(90,t[3])]:[-180,-90,180,90]}addExtraBounds(t){if(t){this.extraBounds||(this.extraBounds=[]);for(const n of t)this.extraBounds.push(o.aG.convert(this.validateBounds(n)))}}contains(t){if(t.z>this.maxzoom||t.z<this.minzoom||this.bounds&&!Sn(this.bounds,t))return!1;if(!this.extraBounds)return!0;for(const n of this.extraBounds)if(Sn(n,t))return!0;return!1}static fromTileJSON(t){if(!t.bounds&&!t.extra_bounds)return null;const n=new ln(t.bounds,t.minzoom,t.maxzoom);return n.addExtraBounds(t.extra_bounds),n}}class ol extends o.E{constructor(t,n,c,d){if(super(),this.id=t,this.dispatcher=c,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,o.h(this,o.aF(n,["url","scheme","tileSize","promoteId"])),this._options=o.h({type:"vector"},n),this._collectResourceTiming=!!n.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(d),this._tileWorkers={},this._deduped=new o.aI}load(t){this._loaded=!1,this.fire(new o.A("dataloading",{dataType:"source"}));const n=Array.isArray(this.map._language)?this.map._language.join():this.map._language,c=this.map.getWorldview();this._tileJSONRequest=Xr(this._options,this.map._requestManager,n,c,(d,f)=>{if(this._tileJSONRequest=null,this._loaded=!0,d)n&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${n}`),c&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${c}`),this.fire(new o.z(d));else if(f){if(o.h(this,f),this.hasWorldviews=!!f.worldview_options,f.worldview_default&&(this.worldviewDefault=f.worldview_default),f.vector_layers){this.vectorLayers=f.vector_layers,this.vectorLayerIds=[],this.localizableLayerIds=new Set;for(const m of f.vector_layers)this.vectorLayerIds.push(m.id),f.worldview&&f.worldview[m.source]&&this.localizableLayerIds.add(m.id)}this.tileBounds=ln.fromTileJSON(f),pn(f.tiles,this.map._requestManager._customAccessToken),this.fire(new o.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new o.A("data",{dataType:"source",sourceDataType:"content"}))}t&&t(d)})}loaded(){return this._loaded}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}onAdd(t){this.map=t,this.load()}reload(){this.cancelTileJSONRequest();const t=o.C(this.id,this.scope);this.load(()=>this.map.style.clearSource(t))}setTiles(t){return this._options.tiles=t,this.reload(),this}setUrl(t){return this.url=t,this._options.url=t,this.reload(),this}onRemove(t){this.cancelTileJSONRequest()}serialize(){return o.h({},this._options)}loadTile(t,n){const c=t.tileID.canonical.url(this.tiles,this.scheme),d=this.map._requestManager.normalizeTileURL(c),f=this.map._requestManager.transformRequest(d,o.R.Tile),m=this.map.style?this.map.style.getLut(this.scope):null,y=m?{image:m.image.clone()}:null,v={request:f,data:void 0,uid:t.uid,tileID:t.tileID,tileZoom:t.tileZoom,zoom:t.tileID.overscaledZ,maxZoom:this.maxzoom,lut:y,tileSize:this.tileSize*t.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,pixelRatio:o.q.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:t.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:t.isExtraShadowCaster,tessellationStep:this.map._tessellationStep,scaleFactor:this.map.getScaleFactor(),worldview:this.map.getWorldview()||this.worldviewDefault};if(this.hasWorldviews&&o.j(c)&&(v.localizableLayerIds=this.localizableLayerIds),v.request.collectResourceTiming=this._collectResourceTiming,t.actor&&t.state!=="expired")t.state==="loading"?t.reloadCallback=n:t.request=t.actor.send("reloadTile",v,T.bind(this));else if(t.actor=this._tileWorkers[d]=this._tileWorkers[d]||this.dispatcher.getActor(),this.dispatcher.ready)t.request=t.actor.send("loadTile",v,T.bind(this),void 0,!0);else{const S=o.aJ.call({deduped:this._deduped},v,(C,I)=>{C||!I?T.call(this,C):(v.data={cacheControl:I.cacheControl,expires:I.expires,rawData:I.rawData.slice(0)},t.actor&&t.actor.send("loadTile",v,T.bind(this),void 0,!0))},!0);t.request={cancel:S}}function T(S,C){return delete t.request,t.aborted?n(null):S&&S.status!==404?n(S):(C&&C.resourceTiming&&(t.resourceTiming=C.resourceTiming),this.map._refreshExpiredTiles&&C&&t.setExpiryData(C),t.loadVectorData(C,this.map.painter),o.aK(this.dispatcher),n(null),void(t.reloadCallback&&(this.loadTile(t,t.reloadCallback),t.reloadCallback=null)))}}abortTile(t){t.request&&(t.request.cancel(),delete t.request),t.actor&&t.actor.send("abortTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(t,n){t.actor&&t.actor.send("removeTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope}),t.destroy()}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class Jr extends o.E{constructor(t,n,c,d){super(),this.id=t,this.dispatcher=c,this.setEventedParent(d),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=o.h({type:"raster"},n),o.h(this,o.aF(n,["url","scheme","tileSize"]))}load(t){this._loaded=!1,this.fire(new o.A("dataloading",{dataType:"source"}));const n=this.map.getWorldview();this._tileJSONRequest=Xr(this._options,this.map._requestManager,null,n,(c,d)=>{this._tileJSONRequest=null,this._loaded=!0,c?this.fire(new o.z(c)):d&&(o.h(this,d),d.raster_layers&&(this.rasterLayers=d.raster_layers,this.rasterLayerIds=this.rasterLayers.map(f=>f.id)),this.tileBounds=ln.fromTileJSON(d),pn(d.tiles),this.fire(new o.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new o.A("data",{dataType:"source",sourceDataType:"content"}))),t&&t(c)})}loaded(){return this._loaded}onAdd(t){this.map=t,this.load()}reload(){this.cancelTileJSONRequest();const t=o.C(this.id,this.scope);this.load(()=>this.map.style.clearSource(t))}setTiles(t){return this._options.tiles=t,this.reload(),this}setUrl(t){return this.url=t,this._options.url=t,this.reload(),this}onRemove(t){this.cancelTileJSONRequest()}serialize(){return o.h({},this._options)}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}loadTile(t,n){const c=o.q.devicePixelRatio>=2,d=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),c,this.tileSize);t.request=o.o(this.map._requestManager.transformRequest(d,o.R.Tile),(f,m,y,v)=>(delete t.request,t.aborted?(t.state="unloaded",n(null)):f?(t.state="errored",n(f)):m?(this.map._refreshExpiredTiles&&t.setExpiryData({cacheControl:y,expires:v}),t.setTexture(m,this.map.painter),t.state="loaded",o.aK(this.dispatcher),void n(null)):n(null)))}abortTile(t,n){t.request&&(t.request.cancel(),delete t.request),n&&n()}unloadTile(t,n){t.texture&&t.texture instanceof o.T?(t.destroy(!0),t.texture&&t.texture instanceof o.T&&this.map.painter.saveTileTexture(t.texture)):t.destroy(),n&&n()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class to extends Jr{constructor(t,n,c,d){super(t,n,c,d),this.type="raster-array",this.maxzoom=22,this.partial=!0,this._options=o.h({type:"raster-array"},n)}triggerRepaint(t){const n=this.map.painter._terrain,c=this.map.style.getSourceCache(this.id);n&&n.enabled&&c&&n._clearRenderCacheForTile(c.id,t.tileID),this.map.triggerRepaint()}loadTile(t,n){const c=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),d=this.map._requestManager.transformRequest(c,o.R.Tile),f={request:d,uid:t.uid,tileID:t.tileID,type:this.type,source:this.id,scope:this.scope,partial:this.partial};t.source=this.id,t.scope=this.scope,t.requestParams=d,t.actor||(t.actor=this.dispatcher.getActor());const m=(y,v,T,S)=>{if(delete t.request,t.aborted)return t.state="unloaded",n(null);if(y)return y.name==="AbortError"?void 0:(t.state="errored",n(y));if(this.map._refreshExpiredTiles&&v&&t.setExpiryData({cacheControl:T,expires:S}),this.partial)t.state="empty";else{if(!v)return n(null);t.state="loaded",t._isHeaderLoaded=!0,t._mrt=v}n(null)};t.request=this.partial?t.fetchHeader(void 0,m.bind(this)):t.actor.send("loadTile",f,m.bind(this),void 0,!0)}abortTile(t){t.request&&(t.request.cancel(),delete t.request),t.actor&&t.actor.send("abortTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(t,n){const c=t.texture;c&&c instanceof o.T?(t.destroy(!0),this.map.painter.saveTileTexture(c)):(t.destroy(),t.flushQueues(),t._isHeaderLoaded=!1,delete t._mrt,delete t.textureDescriptor),t.fbo&&(t.fbo.destroy(),delete t.fbo),delete t.request,delete t.requestParams,delete t.neighboringTiles,t.state="unloaded"}prepareTile(t,n,c){t._isHeaderLoaded&&(t.state!=="empty"&&(t.state="reloading"),t.fetchBand(n,c,(d,f)=>{if(d)return t.state="errored",this.fire(new o.z(d)),void this.triggerRepaint(t);f&&(t._isHeaderLoaded=!0,t.setTexture(f,this.map.painter),t.state="loaded",this.triggerRepaint(t))}))}getInitialBand(t){if(!this.rasterLayers)return 0;const n=this.rasterLayers.find(({id:f})=>f===t),c=n&&n.fields,d=c&&c.bands&&c.bands;return d?d[0]:0}getTextureDescriptor(t,n,c){if(!t)return;const d=n.sourceLayer||this.rasterLayerIds&&this.rasterLayerIds[0];if(!d)return;let f=null;n instanceof o.aN?f=n.paint.get("raster-array-band"):n instanceof o.aO&&(f=n.paint.get("raster-particle-array-band"));const m=f||this.getInitialBand(d);if(m!=null)if(t.textureDescriptor){if(!t.updateNeeded(d,m)||c)return Object.assign({},t.textureDescriptor,{texture:t.texture})}else this.prepareTile(t,d,m)}getImages(t,n){const c=new Map;for(const d of t)for(const f of n){const[m,y]=f.split("/"),v=d.getLayer(m);if(!v||!v.hasBand(y)||!v.hasDataForBand(y))continue;const{bytes:T,tileSize:S,buffer:C}=v.getBandView(y),I=S+2*C,M={data:new o.r({width:I,height:I},T),pixelRatio:2,sdf:!1,usvg:!1,version:0};c.set(f,M)}return c}}const fc={vector:ol,raster:Jr,"raster-dem":class extends Jr{constructor(l,t,n,c){super(l,t,n,c),this.type="raster-dem",this.maxzoom=22,this._options=o.h({type:"raster-dem"},t),this.encoding=t.encoding||"mapbox"}loadTile(l,t){const n=this.map._requestManager.normalizeTileURL(l.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function c(d,f){d&&(l.state="errored",t(d)),f&&(l.dem=f,l.dem.onDeserialize(),l.needsHillshadePrepare=!0,l.needsDEMTextureUpload=!0,l.state="loaded",t(null))}l.request=o.o(this.map._requestManager.transformRequest(n,o.R.Tile),(function(d,f,m,y){if(delete l.request,l.aborted)l.state="unloaded",t(null);else if(d)l.state="errored",t(d);else if(f){this.map._refreshExpiredTiles&&l.setExpiryData({cacheControl:m,expires:y});const v=ImageBitmap&&f instanceof ImageBitmap&&o.t(),T=1-(f.width-o.aL(f.width))/2;T<1||l.neighboringTiles||(l.neighboringTiles=this._getNeighboringTiles(l.tileID));const S=v?f:o.q.getImageData(f,T),C={uid:l.uid,tileID:l.tileID,source:this.id,type:this.type,scope:this.scope,rawImageData:S,encoding:this.encoding,padding:T};l.actor&&l.state!=="expired"||(l.actor=this.dispatcher.getActor(),l.actor.send("loadTile",C,c.bind(this),void 0,!0))}}).bind(this))}_getNeighboringTiles(l){const t=l.canonical,n=Math.pow(2,t.z),c=(t.x-1+n)%n,d=t.x===0?l.wrap-1:l.wrap,f=(t.x+1+n)%n,m=t.x+1===n?l.wrap+1:l.wrap,y={};return y[new o.aM(l.overscaledZ,d,t.z,c,t.y).key]={backfilled:!1},y[new o.aM(l.overscaledZ,m,t.z,f,t.y).key]={backfilled:!1},t.y>0&&(y[new o.aM(l.overscaledZ,d,t.z,c,t.y-1).key]={backfilled:!1},y[new o.aM(l.overscaledZ,l.wrap,t.z,t.x,t.y-1).key]={backfilled:!1},y[new o.aM(l.overscaledZ,m,t.z,f,t.y-1).key]={backfilled:!1}),t.y+1<n&&(y[new o.aM(l.overscaledZ,d,t.z,c,t.y+1).key]={backfilled:!1},y[new o.aM(l.overscaledZ,l.wrap,t.z,t.x,t.y+1).key]={backfilled:!1},y[new o.aM(l.overscaledZ,m,t.z,f,t.y+1).key]={backfilled:!1}),y}},"raster-array":to,geojson:class extends o.E{constructor(l,t,n,c){super(),this.id=l,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=n.getActor(),this.setEventedParent(c),this._data=t.data,this._options=o.h({},t),this._collectResourceTiming=t.collectResourceTiming,t.maxzoom!==void 0&&(this.maxzoom=t.maxzoom),t.minzoom!==void 0&&(this.minzoom=t.minzoom),t.type&&(this.type=t.type),t.attribution&&(this.attribution=t.attribution),this.promoteId=t.promoteId;const d=o.aj/this.tileSize;this.workerOptions=o.h({source:this.id,scope:this.scope,cluster:t.cluster||!1,geojsonVtOptions:{buffer:(t.buffer!==void 0?t.buffer:128)*d,tolerance:(t.tolerance!==void 0?t.tolerance:.375)*d,extent:o.aj,maxZoom:this.maxzoom,lineMetrics:t.lineMetrics||!1,generateId:t.generateId||!1},superclusterOptions:{maxZoom:t.clusterMaxZoom!==void 0?t.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,t.clusterMinPoints||2),extent:o.aj,radius:(t.clusterRadius!==void 0?t.clusterRadius:50)*d,log:!1,generateId:t.generateId||!1},clusterProperties:t.clusterProperties,filter:t.filter,dynamic:t.dynamic},t.workerOptions)}onAdd(l){this.map=l,this.setData(this._data)}setData(l){return this._data=l,this._updateWorkerData(),this}updateData(l){if(!this._options.dynamic)return this.fire(new o.z(new Error("Can't call updateData on a GeoJSON source with dynamic set to false.")));if(typeof l!="string"&&(l.type==="Feature"&&(l={type:"FeatureCollection",features:[l]}),l.type!=="FeatureCollection"))return this.fire(new o.z(new Error("Data to update should be a feature or a feature collection.")));if(this._coalesce&&typeof l!="string"&&typeof this._data!="string"&&this._data.type==="FeatureCollection"){const t=new Map;for(const n of this._data.features)t.set(n.id,n);for(const n of l.features)t.set(n.id,n);this._data.features=[...t.values()]}else this._data=l;return this._updateWorkerData(!0),this}getClusterExpansionZoom(l,t){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:l,source:this.id,scope:this.scope},t),this}getClusterChildren(l,t){return this.actor.send("geojson.getClusterChildren",{clusterId:l,source:this.id,scope:this.scope},t),this}getClusterLeaves(l,t,n,c){return this.actor.send("geojson.getClusterLeaves",{source:this.id,scope:this.scope,clusterId:l,limit:t,offset:n},c),this}_updateWorkerData(l=!1){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new o.A("dataloading",{dataType:"source"})),this._loaded=!1;const t=o.h({append:l},this.workerOptions);t.scope=this.scope;const n=this._data;typeof n=="string"?(t.request=this.map._requestManager.transformRequest(o.q.resolveURL(n),o.R.Source),t.request.collectResourceTiming=this._collectResourceTiming):t.data=JSON.stringify(n),this._pendingLoad=this.actor.send(`${this.type}.loadData`,t,(c,d)=>{if(this._loaded=!0,this._pendingLoad=null,c)this.fire(new o.z(c));else{const f={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&d&&d.resourceTiming&&d.resourceTiming[this.id]&&(f.resourceTiming=d.resourceTiming[this.id]),l&&(this._partialReload=!0),this.fire(new o.A("data",f)),this._partialReload=!1,this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(l),this._coalesce=!1)})}loaded(){return this._loaded}reload(){const l=o.C(this.id,this.scope);this.map.style.clearSource(l),this._updateWorkerData()}loadTile(l,t){const n=l.actor?"reloadTile":"loadTile";l.actor=this.actor;const c=this.map.style?this.map.style.getLut(this.scope):null,d=c?{image:c.image.clone()}:null,f=this._partialReload,m={type:this.type,uid:l.uid,tileID:l.tileID,tileZoom:l.tileZoom,zoom:l.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,lut:d,scope:this.scope,pixelRatio:o.q.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:l.isExtraShadowCaster,scaleFactor:this.map.getScaleFactor(),partial:f,worldview:this.map.getWorldview()};l.request=this.actor.send(n,m,(y,v)=>f&&!v?(l.state="loaded",t(null)):(delete l.request,l.destroy(),l.aborted?t(null):y?t(y):(l.loadVectorData(v,this.map.painter,n==="reloadTile"),t(null))),void 0,n==="loadTile")}abortTile(l){l.request&&(l.request.cancel(),delete l.request),l.aborted=!0}unloadTile(l,t){this.actor.send("removeTile",{uid:l.uid,type:this.type,source:this.id,scope:this.scope}),l.destroy()}onRemove(l){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return o.h({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends o.aP{constructor(l,t,n,c){super(l,t,n,c),this.roundZoom=!0,this.type="video",this.options=t}load(){this._loaded=!1;const l=this.options;this.urls=[];for(const t of l.urls)this.urls.push(this.map._requestManager.transformRequest(t,o.R.Source).url);o.aQ(this.urls,(t,n)=>{this._loaded=!0,t?this.fire(new o.z(t)):n&&(this.video=n,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading())})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(l){if(this.video){const t=this.video.seekable;l<t.start(0)||l>t.end(0)?this.fire(new o.z(new o.V(`sources.${this.id}`,null,`Playback for this video can be set only between the ${t.start(0)} and ${t.end(0)}-second mark.`))):this.video.currentTime=l}}getVideo(){return this.video}onAdd(l){this.map||(this.map=l,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;const l=this.map.painter.context,t=l.gl;this.texture?this.video.paused||(this.texture.bind(t.LINEAR,t.CLAMP_TO_EDGE),t.texSubImage2D(t.TEXTURE_2D,0,0,0,t.RGBA,t.UNSIGNED_BYTE,this.video)):(this.texture=new o.T(l,this.video,t.RGBA8),this.texture.bind(t.LINEAR,t.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(l)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:o.aP,model:class extends o.E{constructor(l,t,n,c){super(),this.id=l,this.type="model",this.models=[],this._loaded=!1,this._options=t}load(){const l=[];for(const t in this._options.models){const n=this._options.models[t],c=o.aS(this.map._requestManager.transformRequest(n.uri,o.R.Model).url).then(d=>{if(!d)return;const f=o.aT(d),m=new o.aU(t,n.position,n.orientation,f);m.computeBoundsAndApplyParent(),this.models.push(m)}).catch(d=>{this.fire(new o.z(new Error(`Could not load model ${t} from ${n.uri}: ${d.message}`)))});l.push(c)}Promise.allSettled(l).then(()=>{this._loaded=!0,this.fire(new o.A("data",{dataType:"source",sourceDataType:"metadata"}))}).catch(t=>{this._loaded=!0,this.fire(new o.z(new Error(`Could not load models: ${t.message}`)))})}onAdd(l){this.map=l,this.load()}hasTransition(){return!1}loaded(){return this._loaded}getModels(){return this.models}loadTile(l,t){}serialize(){return this._options}},"batched-model":class extends o.E{constructor(l,t,n,c){super(),this.type="batched-model",this.id=l,this.tileSize=512,this._options=t,this.tiles=this._options.tiles,this.maxzoom=t.maxzoom||19,this.minzoom=t.minzoom||0,this.roundZoom=!0,this.usedInConflation=!0,this.dispatcher=n,this.reparseOverscaled=!1,this.scheme="xyz",this._loaded=!1,this.setEventedParent(c)}onAdd(l){this.map=l,this.load()}reload(){this.cancelTileJSONRequest();const l=o.C(this.id,this.scope);this.load(()=>this.map.style.clearSource(l))}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}load(l){this._loaded=!1,this.fire(new o.A("dataloading",{dataType:"source"}));const t=Array.isArray(this.map._language)?this.map._language.join():this.map._language,n=this.map.getWorldview();this._tileJSONRequest=Xr(this._options,this.map._requestManager,t,n,(c,d)=>{this._tileJSONRequest=null,this._loaded=!0,c?(t&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${t}`),n&&n.length!==2&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${n}`),this.fire(new o.z(c))):d&&(o.h(this,d),d.bounds&&(this.tileBounds=new ln(d.bounds,this.minzoom,this.maxzoom)),pn(d.tiles,this.map._requestManager._customAccessToken),this.fire(new o.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new o.A("data",{dataType:"source",sourceDataType:"content"}))),l&&l(c)})}hasTransition(){return!1}hasTile(l){return!this.tileBounds||this.tileBounds.contains(l.canonical)}loaded(){return this._loaded}loadTile(l,t){const n=this.map._requestManager.normalizeTileURL(l.tileID.canonical.url(this.tiles,this.scheme)),c={request:this.map._requestManager.transformRequest(n,o.R.Tile),data:void 0,uid:l.uid,tileID:l.tileID,tileZoom:l.tileZoom,zoom:l.tileID.overscaledZ,tileSize:this.tileSize*l.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,showCollisionBoxes:this.map.showCollisionBoxes,isSymbolTile:l.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,pixelRatio:o.q.devicePixelRatio,promoteId:this.promoteId};if(l.actor&&l.state!=="expired")if(l.state==="loading")l.reloadCallback=t;else{if(l.buckets){const f=Object.values(l.buckets);for(const m of f)m.dirty=!0;return void(l.state="loaded")}l.request=l.actor.send("reloadTile",c,d.bind(this))}else l.actor=this.dispatcher.getActor(),l.request=l.actor.send("loadTile",c,d.bind(this),void 0,!0);function d(f,m){return l.aborted?t(null):f&&f.status!==404?t(f):(this.map._refreshExpiredTiles&&m&&l.setExpiryData(m),l.loadModelData(m,this.map.painter),l.state="loaded",void t(null))}}serialize(){return o.h({},this._options)}},canvas:class extends o.aP{constructor(l,t,n,c){super(l,t,n,c),t.coordinates?Array.isArray(t.coordinates)&&t.coordinates.length===4&&!t.coordinates.some(d=>!Array.isArray(d)||d.length!==2||d.some(f=>typeof f!="number"))||this.fire(new o.z(new o.V(`sources.${l}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new o.z(new o.V(`sources.${l}`,null,'missing required property "coordinates"'))),t.animate&&typeof t.animate!="boolean"&&this.fire(new o.z(new o.V(`sources.${l}`,null,'optional "animate" property must be a boolean value'))),t.canvas?typeof t.canvas=="string"||t.canvas instanceof HTMLCanvasElement||this.fire(new o.z(new o.V(`sources.${l}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new o.z(new o.V(`sources.${l}`,null,'missing required property "canvas"'))),this.options=t,this.animate=t.animate===void 0||t.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new o.z(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(l){this.map=l,this.load(),this.canvas&&this.animate&&this.play()}onRemove(l){this.pause()}prepare(){let l=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,l=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,l=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;const t=this.map.painter.context;this.texture?!l&&!this._playing||this.texture instanceof o.aR||this.texture.update(this.canvas,{premultiply:!0}):this.texture=new o.T(t,this.canvas,t.gl.RGBA8,{premultiply:!0}),this._prepareData(t)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const l of[this.canvas.width,this.canvas.height])if(isNaN(l)||l<=0)return!0;return!1}},custom:class extends o.E{constructor(l,t,n,c){super(),this.id=l,this.type="custom",this._dataType="raster",this._dispatcher=n,this._implementation=t,this.setEventedParent(c),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new o.z(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new o.z(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new ln(this._implementation.bounds,this.minzoom,this.maxzoom)),t.update=this._update.bind(this),t.clearTiles=this._clearTiles.bind(this),t.coveringTiles=this._coveringTiles.bind(this),o.h(this,o.aF(t,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return o.aF(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new o.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new o.A("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(l){this.map=l,this._loaded=!1,this.fire(new o.A("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(l),this.load()}onRemove(l){this._implementation.onRemove&&this._implementation.onRemove(l)}hasTile(l){if(this._implementation.hasTile){const{x:t,y:n,z:c}=l.canonical;return this._implementation.hasTile({x:t,y:n,z:c})}return!this.tileBounds||this.tileBounds.contains(l.canonical)}loadTile(l,t){const{x:n,y:c,z:d}=l.tileID.canonical,f=new AbortController;l.request=Promise.resolve(this._implementation.loadTile({x:n,y:c,z:d},{signal:f.signal})).then((function(m){return delete l.request,l.aborted?(l.state="unloaded",t(null)):m===void 0?(l.state="errored",t(null)):m===null?(this.loadTileData(l,{width:this.tileSize,height:this.tileSize,data:null}),l.state="loaded",t(null)):function(y){return y instanceof ImageData||y instanceof HTMLCanvasElement||y instanceof ImageBitmap||y instanceof HTMLImageElement}(m)?(this.loadTileData(l,m),l.state="loaded",void t(null)):(l.state="errored",t(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)))}).bind(this)).catch(m=>{m.name!=="AbortError"&&(l.state="errored",t(m))}),l.request.cancel=()=>f.abort()}loadTileData(l,t){l.setTexture(t,this.map.painter)}unloadTile(l,t){if(l.texture&&l.texture instanceof o.T?(l.destroy(!0),l.texture&&l.texture instanceof o.T&&this.map.painter.saveTileTexture(l.texture)):l.destroy(),this._implementation.unloadTile){const{x:n,y:c,z:d}=l.tileID.canonical;this._implementation.unloadTile({x:n,y:c,z:d})}t&&t()}abortTile(l,t){l.request&&l.request.cancel&&(l.request.cancel(),delete l.request),t&&t()}hasTransition(){return!1}_coveringTiles(){return this.map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map(l=>({x:l.canonical.x,y:l.canonical.y,z:l.canonical.z}))}_clearTiles(){const l=o.C(this.id,this.scope);this.map.style.clearSource(l)}_update(){this.fire(new o.A("data",{dataType:"source",sourceDataType:"content"}))}}},al=function(l,t,n,c){const d=new fc[t.type](l,t,n,c);if(d.id!==l)throw new Error(`Expected Source id to be ${l} instead of ${d.id}`);return o.aV(["load","abort","unload","serialize","prepare"],d),d};function ll(l,t,n=""){return`${n}:${t.id||""}:${t.layer.id}:${function(c){if("layerId"in c)return`layer:${c.layerId}`;{const{featuresetId:d,importId:f}=c;return`featureset:${d}${f?`:import:${f}`:""}`}}(l.target)}`}function pc(l,t,n,c=""){if(l.uniqueFeatureID){const d=ll(l,t,c);if(n.has(d))return!0;n.add(d)}return!1}function mc(l,t,n,c,d=!1){const f=t.sourceCache.transform,m=t.sourceCache.tilesIn(l,t.has3DLayers,d);m.sort(_c);const y=[];for(const v of m){const T=v.tile.queryRenderedFeatures(t,v,n,c,f,d);Object.keys(T).length&&y.push({wrappedTileID:v.tile.tileID.wrapped().key,queryResults:T})}return y.length===0?{}:function(v){const T={},S={};for(const C of v){const I=C.queryResults,M=C.wrappedTileID,D=S[M]=S[M]||{};for(const z in I){const O=I[z],B=D[z]=D[z]||{},V=T[z]=T[z]||[];for(const H of O)B[H.featureIndex]||(B[H.featureIndex]=!0,V.push(H))}}return T}(y)}function zo(l,t,n,c,d,f){const m={},y=c.queryRenderedSymbols(l),v=[];for(const T of Object.keys(y).map(Number))v.push(d[T]);v.sort(_c);for(const T of v){const S=T.featureIndex.lookupSymbolFeatures(y[T.bucketInstanceId],T.bucketIndex,T.sourceLayerIndex,t,n,f);for(const C in S){const I=m[C]=m[C]||[],M=S[C];M.sort((D,z)=>{const O=T.featureSortOrder;if(O){const B=O.indexOf(D.featureIndex);return O.indexOf(z.featureIndex)-B}return z.featureIndex-D.featureIndex});for(const D of M)I.push(D)}}return m}function cl(l,t){const n=l.getRenderableIds().map(f=>l.getTileByID(f)),c=[],d={};for(let f=0;f<n.length;f++){const m=n[f],y=m.tileID.canonical.key;d[y]||(d[y]=!0,m.querySourceFeatures(c,t))}return c}function _c(l,t){const n=l.tileID,c=t.tileID;return n.overscaledZ-c.overscaledZ||n.canonical.y-c.canonical.y||n.wrap-c.wrap||n.canonical.x-c.canonical.x}function ns(l,t){const n={};if(!t)return n;for(const c of l){const d=c.layerIds.map(f=>t.getLayer(f)).filter(Boolean);if(d.length!==0){c.layers=d,c.stateDependentLayerIds&&(c.stateDependentLayers=c.stateDependentLayerIds.map(f=>d.filter(m=>m.id===f)[0]));for(const f of d)n[f.fqid]=c}}return n}const jn=32,Xn=33,Cs=new Uint16Array(8184);for(let l=0;l<2046;l++){let t=l+2,n=0,c=0,d=0,f=0,m=0,y=0;for(1&t?d=f=m=jn:n=c=y=jn;(t>>=1)>1;){const T=n+d>>1,S=c+f>>1;1&t?(d=n,f=c,n=m,c=y):(n=d,c=f,d=m,f=y),m=T,y=S}const v=4*l;Cs[v+0]=n,Cs[v+1]=c,Cs[v+2]=d,Cs[v+3]=f}const ss=new Uint16Array(2178),Ms=new Uint8Array(1089),ul=new Uint16Array(1089);function ms(l){return l===0?-.03125:l===32?.03125:0}const hl={type:2,extent:o.aj,loadGeometry:()=>[[new o.P(0,0),new o.P(o.aj+1,0),new o.P(o.aj+1,o.aj+1),new o.P(0,o.aj+1),new o.P(0,0)]]};class Lo{constructor(t,n,c,d,f,m){this.tileID=t,this.uid=o.a$(),this.uses=0,this.tileSize=n,this.tileZoom=c,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=f,d&&d.style&&(this._lastUpdatedBrightness=d.style.getBrightness()),this.expiredRequestCount=0,this.state="loading",d&&d.transform&&(this.projection=d.transform.projection),this.worldview=m}registerFadeDuration(t){const n=t+this.timeAdded;n<o.q.now()||this.fadeEndTime&&n<this.fadeEndTime||(this.fadeEndTime=n)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}get tileTransform(){return this._tileTransform||(this._tileTransform=o.aW(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(t,n,c){if(this.unloadVectorData(),this.state="loaded",t){t.featureIndex&&(this.latestFeatureIndex=t.featureIndex,t.rawTileData?(this.latestRawTileData=t.rawTileData,this.latestFeatureIndex.rawTileData=t.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=t.collisionBoxArray,this.buckets=ns(t.buckets,n.style),this.hasSymbolBuckets=!1;for(const d in this.buckets){const f=this.buckets[d];if(f instanceof o.b1){if(this.hasSymbolBuckets=!0,!c)break;f.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const d in this.buckets){const f=this.buckets[d];if(f instanceof o.b1&&f.hasRTLText){this.hasRTLText=!0,o.b2();break}}this.queryPadding=0;for(const d in this.buckets){const f=this.buckets[d],m=n.style.getOwnLayer(d);if(!m)continue;const y=m.queryRadius(f);this.queryPadding=Math.max(this.queryPadding,y)}t.imageAtlas&&(this.imageAtlas=t.imageAtlas),t.glyphAtlasImage&&(this.glyphAtlasImage=t.glyphAtlasImage),t.lineAtlas&&(this.lineAtlas=t.lineAtlas),this._lastUpdatedBrightness=t.brightness}else this.collisionBoxArray=new o.b0}unloadVectorData(){if(this.hasData()){for(const t in this.buckets)this.buckets[t].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}loadModelData(t,n,c){t&&(t.resourceTiming&&(this.resourceTiming=t.resourceTiming),this.buckets=Object.assign({},this.buckets,ns(t.buckets,n.style)),t.featureIndex&&(this.latestFeatureIndex=t.featureIndex))}getBucket(t){return this.buckets[t.fqid]}upload(t){for(const d in this.buckets){const f=this.buckets[d];f.uploadPending()&&f.upload(t)}const n=t.gl,c=this.imageAtlas;c&&!c.uploaded&&(this.imageAtlasTexture=new o.T(t,c.image,n.RGBA8,{useMipmap:!!c.patternPositions.size}),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new o.T(t,this.glyphAtlasImage,n.R8),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new o.T(t,this.lineAtlas.image,n.R8),this.lineAtlas.uploaded=!0)}prepare(t,n,c){if(this.imageAtlas&&this.imageAtlasTexture&&this.imageAtlas.patchUpdatedImages(t,this.imageAtlasTexture,c),!n||!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData)return;const d=n.style.getBrightness();(this._lastUpdatedBrightness||d)&&(this._lastUpdatedBrightness&&d&&Math.abs(this._lastUpdatedBrightness-d)<.001||(this.updateBuckets(n,this._lastUpdatedBrightness!==d),this._lastUpdatedBrightness=d))}queryRenderedFeatures(t,n,c,d,f,m){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData&&!this.latestFeatureIndex.is3DTile)return{};const y=function(v,T){const S=o.bn([],[.5*v.width,.5*-v.height,1]);return o.bo(S,S,[1,-1,0]),o.az(S,S,v.calculateProjMatrix(T.toUnwrapped())),Float32Array.from(S)}(f,this.tileID);return this.latestFeatureIndex.query(t,{tilespaceGeometry:n,pixelPosMatrix:y,transform:d,availableImages:c,tileTransform:this.tileTransform,worldview:this.worldview})}querySourceFeatures(t,n){const c=this.latestFeatureIndex;if(!c||!c.rawTileData)return;const d=c.loadVTLayers(),f=n?n.sourceLayer:"",m=d._geojsonTileLayer||d[f];if(!m)return;const y=o.b3(n&&n.filter),{z:v,x:T,y:S}=this.tileID.canonical,C={z:v,x:T,y:S};for(let I=0;I<m.length;I++){const M=m.feature(I);if(y.needGeometry){const O=o.b4(M,!0);if(!y.filter(new o.aa(this.tileID.overscaledZ,{worldview:this.worldview}),O,this.tileID.canonical))continue}else if(!y.filter(new o.aa(this.tileID.overscaledZ,{worldview:this.worldview}),M))continue;const D=c.getId(M,f),z=new o.b5(M,v,T,S,D);z.tile=C,t.push(z)}}loaded(){return this.state==="loaded"||this.state==="errored"}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return!!this.imageAtlas&&!!this.imageAtlas.patternPositions.size}setExpiryData(t){const n=this.expirationTime;if(t.cacheControl){const c=o.b6(t.cacheControl);c["max-age"]&&(this.expirationTime=Date.now()+1e3*c["max-age"])}else t.expires&&(this.expirationTime=new Date(t.expires).getTime());if(this.expirationTime){const c=Date.now();let d=!1;if(this.expirationTime>c)d=!1;else if(n)if(this.expirationTime<n)d=!0;else{const f=this.expirationTime-n;f?this.expirationTime=c+Math.max(f,3e4):d=!0}else d=!0;d?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}refreshFeatureState(t){this.latestFeatureIndex&&(this.latestFeatureIndex.rawTileData||this.latestFeatureIndex.is3DTile)&&t&&this.updateBuckets(t)}updateBuckets(t,n){if(!this.latestFeatureIndex||!t.style)return;const c=this.latestFeatureIndex.loadVTLayers(),d=t.style.listImages(),f=t.style.getBrightness();for(const m in this.buckets){if(!t.style.hasLayer(m))continue;const y=this.buckets[m],v=y.layers[0],T=v.sourceLayer||"_geojsonTileLayer",S=c[T],C=t.style.getLayerSourceCache(v);let I={};C&&(I=C._state.getState(T,void 0));const M=this.imageAtlas?Object.fromEntries(this.imageAtlas.patternPositions):{},D=Object.keys(I).length>0&&!n;D&&!y.stateDependentLayers.length&&!n||y.update(I,S,d,M,D?y.stateDependentLayers:y.layers,n,f),(y instanceof o.b7||y instanceof o.b8)&&t._terrain&&t._terrain.enabled&&C&&y.uploadPending()&&t._terrain._clearRenderCacheForTile(C.id,this.tileID);const z=t&&t.style&&t.style.getOwnLayer(m);z&&(this.queryPadding=Math.max(this.queryPadding,z.queryRadius(y)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<o.q.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(t){this.symbolFadeHoldUntil=o.q.now()+t}setTexture(t,n){const c=n.context,d=c.gl;this.texture=this.texture||n.getTileTexture(t.width),this.texture&&this.texture instanceof o.T?this.texture.update(t):(this.texture=new o.T(c,t,d.RGBA8,{useMipmap:!0}),this.texture.bind(d.LINEAR,d.CLAMP_TO_EDGE))}setDependencies(t,n){const c={};for(const d of n)c[d]=!0;this.dependencies[t]=c}hasDependency(t,n){for(const c of t){const d=this.dependencies[c];if(d){for(const f of n)if(d[f])return!0}}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(t,n){if(!n||n.name==="mercator"||this._tileDebugBuffer)return;const c=o.b9(hl,this.tileID.canonical,this.tileTransform)[0],d=new o.ba,f=new o.bb;for(let m=0;m<c.length;m++){const{x:y,y:v}=c[m];d.emplaceBack(y,v),f.emplaceBack(m)}f.emplaceBack(0),this._tileDebugIndexBuffer=t.createIndexBuffer(f),this._tileDebugBuffer=t.createVertexBuffer(d,o.bc.members),this._tileDebugSegments=o.bd.simpleSegment(0,0,d.length,f.length)}_makeTileBoundsBuffers(t,n){if(this._tileBoundsBuffer||!n||n.name==="mercator")return;const c=o.b9(hl,this.tileID.canonical,this.tileTransform)[0];let d,f;if(this.isRaster){const m=function(y,v){const T=o.aW(y,v),S=Math.pow(2,y.z);for(let O=0;O<Xn;O++)for(let B=0;B<Xn;B++){const V=o.aX((y.x+(B+ms(B))/jn)/S),H=o.aY((y.y+(O+ms(O))/jn)/S),Y=v.project(V,H),te=O*Xn+B;ss[2*te+0]=Math.round((Y.x*T.scale-T.x)*o.aj),ss[2*te+1]=Math.round((Y.y*T.scale-T.y)*o.aj)}Ms.fill(0),ul.fill(0);for(let O=2045;O>=0;O--){const B=4*O,V=Cs[B+0],H=Cs[B+1],Y=Cs[B+2],te=Cs[B+3],ee=V+Y>>1,J=H+te>>1,K=ee+J-H,ie=J+V-ee,se=H*Xn+V,ye=te*Xn+Y,ve=J*Xn+ee,Oe=Math.hypot((ss[2*se+0]+ss[2*ye+0])/2-ss[2*ve+0],(ss[2*se+1]+ss[2*ye+1])/2-ss[2*ve+1])>=16;Ms[ve]=Ms[ve]||(Oe?1:0),O<1022&&(Ms[ve]=Ms[ve]||Ms[(H+ie>>1)*Xn+(V+K>>1)]||Ms[(te+ie>>1)*Xn+(Y+K>>1)])}const C=new o.aZ,I=new o.a_;let M=0;function D(O,B){const V=B*Xn+O;return ul[V]===0&&(C.emplaceBack(ss[2*V+0],ss[2*V+1],O*o.aj/jn,B*o.aj/jn),ul[V]=++M),ul[V]-1}function z(O,B,V,H,Y,te){const ee=O+V>>1,J=B+H>>1;if(Math.abs(O-Y)+Math.abs(B-te)>1&&Ms[J*Xn+ee])z(Y,te,O,B,ee,J),z(V,H,Y,te,ee,J);else{const K=D(O,B),ie=D(V,H),se=D(Y,te);I.emplaceBack(K,ie,se)}}return z(0,0,jn,jn,jn,0),z(jn,jn,0,0,0,jn),{vertices:C,indices:I}}(this.tileID.canonical,n);d=m.vertices,f=m.indices}else{d=new o.aZ,f=new o.a_;for(const{x:y,y:v}of c)d.emplaceBack(y,v,0,0);const m=o.be(d.int16.subarray(0,4*d.length),void 0,4);for(let y=0;y<m.length;y+=3)f.emplaceBack(m[y],m[y+1],m[y+2])}this._tileBoundsBuffer=t.createVertexBuffer(d,o.bf.members),this._tileBoundsIndexBuffer=t.createIndexBuffer(f),this._tileBoundsSegments=o.bd.simpleSegment(0,0,d.length,f.length)}_makeGlobeTileDebugBuffers(t,n){const c=n.projection;if(!c||c.name!=="globe"||n.freezeTileCoverage)return;const d=this.tileID.canonical,f=o.bg(d,n),m=o.bh(f),y=o.ah(n.zoom);let v;y>0&&(v=o.bi(new Float64Array(16),n.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(t,d,n,m,v,y),this._makeGlobeTileDebugTextBuffer(t,d,n,m,v,y)}_globePoint(t,n,c,d,f,m,y){let v=o.bj(t,n,c);if(m){const T=1<<c.z,S=o.aD(d.center.lng),C=o.aH(d.center.lat),I=(c.x+.5)/T-S;let M=0;I>.5?M=-1:I<-.5&&(M=1);let D=(t/o.aj+c.x)/T+M,z=(n/o.aj+c.y)/T;D=(D-S)*d._pixelsPerMercatorPixel+S,z=(z-C)*d._pixelsPerMercatorPixel+C;const O=[D*d.worldSize,z*d.worldSize,0];o.ad(O,O,m),v=o.bk(v,O,y)}return o.ad(v,v,f)}_makeGlobeTileDebugBorderBuffer(t,n,c,d,f,m){const y=new o.ba,v=new o.bb,T=new o.bl,S=(I,M,D,z,O)=>{const B=(D-I)/(O-1),V=(z-M)/(O-1),H=y.length;for(let Y=0;Y<O;Y++){const te=I+Y*B,ee=M+Y*V;y.emplaceBack(te,ee);const J=this._globePoint(te,ee,n,c,d,f,m);T.emplaceBack(J[0],J[1],J[2]),v.emplaceBack(H+Y)}},C=o.aj;S(0,0,C,0,16),S(C,0,C,C,16),S(C,C,0,C,16),S(0,C,0,0,16),this._tileDebugIndexBuffer=t.createIndexBuffer(v),this._tileDebugBuffer=t.createVertexBuffer(y,o.bc.members),this._globeTileDebugBorderBuffer=t.createVertexBuffer(T,o.bm.members),this._tileDebugSegments=o.bd.simpleSegment(0,0,y.length,v.length)}_makeGlobeTileDebugTextBuffer(t,n,c,d,f,m){const y=o.aj/4,v=new o.ba,T=new o.a_,S=new o.bl,C=25;T.reserve(32),v.reserve(C),S.reserve(C);const I=(M,D)=>C*M+D;for(let M=0;M<C;M++){const D=M*y;for(let z=0;z<C;z++){const O=z*y;v.emplaceBack(O,D);const B=this._globePoint(O,D,n,c,d,f,m);S.emplaceBack(B[0],B[1],B[2])}}for(let M=0;M<4;M++)for(let D=0;D<4;D++){const z=I(M,D),O=I(M,D+1),B=I(M+1,D),V=I(M+1,D+1);T.emplaceBack(z,O,B),T.emplaceBack(B,O,V)}this._tileDebugTextIndexBuffer=t.createIndexBuffer(T),this._tileDebugTextBuffer=t.createVertexBuffer(v,o.bc.members),this._globeTileDebugTextBuffer=t.createVertexBuffer(S,o.bm.members),this._tileDebugTextSegments=o.bd.simpleSegment(0,0,C,32)}destroy(t=!1){for(const n in this.buckets)this.buckets[n].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&(this.imageAtlasTexture.destroy(),delete this.imageAtlasTexture),this.glyphAtlasTexture&&(this.glyphAtlasTexture.destroy(),delete this.glyphAtlasTexture),this.lineAtlasTexture&&(this.lineAtlasTexture.destroy(),delete this.lineAtlasTexture),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),!t&&this.texture&&this.texture instanceof o.T&&(this.texture.destroy(),delete this.texture),this.hillshadeFBO&&(this.hillshadeFBO.destroy(),delete this.hillshadeFBO),this.dem&&delete this.dem,this.neighboringTiles&&delete this.neighboringTiles,this.demTexture&&(this.demTexture.destroy(),delete this.demTexture),this.rasterParticleState&&(this.rasterParticleState.destroy(),delete this.rasterParticleState),this.latestFeatureIndex=null,this.state="unloaded"}}o.bp.setPbf(o.bq);class ua extends Lo{constructor(t,n,c,d,f){super(t,n,c,d,f),this._workQueue=[],this._fetchQueue=[],this._isHeaderLoaded=!1}getLayers(){return this._mrt?Object.values(this._mrt.layers):[]}getLayer(t){return this._mrt&&this._mrt.getLayer(t)}setTexture(t,n){const c=n.context,d=c.gl;this.texture=this.texture||n.getTileTexture(t.width),this.texture&&this.texture instanceof o.T?this.texture.update(t,{premultiply:!1}):this.texture=new o.T(c,t,d.RGBA8,{premultiply:!1})}flushQueues(){for(;this._workQueue.length;)this._workQueue.pop()();for(;this._fetchQueue.length;)this._fetchQueue.pop()()}fetchHeader(t=16384,n){const c=this._mrt=new o.bp(30),d=Object.assign({},this.requestParams,{headers:{Range:"bytes=0-"+(t-1)}});return this.entireBuffer=null,this.request=o.br(d,(f,m,y,v)=>{if(f)n(f);else try{const T=c.getHeaderLength(m);if(T>t)return void(this.request=this.fetchHeader(T,n));c.parseHeader(m),this._isHeaderLoaded=!0;let S=0;for(const C of Object.values(c.layers))S=Math.max(S,C.dataIndex[C.dataIndex.length-1].lastByte);m.byteLength>=S&&(this.entireBuffer=m),n(null,this.entireBuffer||m,y,v)}catch(T){n(T)}}),this.request}fetchBand(t,n,c){const d=this._mrt;if(!this._isHeaderLoaded||!d)return void c(new Error("Tile header is not ready"));const f=this.actor;if(!f)return void c(new Error("Can't fetch tile band without an actor"));let m;const y=(C,I)=>{m.complete(C,I),C?c(C):(this.updateTextureDescriptor(t,n),c(null,this.textureDescriptor&&this.textureDescriptor.img))},v=(C,I)=>{if(C)return c(C);const M=f.send("decodeRasterArray",{type:"raster-array",source:this.source,scope:this.scope,tileID:this.tileID,uid:this.uid,buffer:I,task:m},y,void 0,!0);this._workQueue.push(()=>{M&&M.cancel(),m.cancel()})},T=d.getLayer(t);if(!T)return void c(new Error(`Unknown sourceLayer "${t}"`));if(T.hasDataForBand(n))return this.updateTextureDescriptor(t,n),void c(null,this.textureDescriptor?this.textureDescriptor.img:null);const S=T.getDataRange([n]);if(m=d.createDecodingTask(S),!m||m.tasks.length)if(this.flushQueues(),this.entireBuffer)v(null,this.entireBuffer.slice(S.firstByte,S.lastByte+1));else{const C=Object.assign({},this.requestParams,{headers:{Range:`bytes=${S.firstByte}-${S.lastByte}`}}),I=o.br(C,v);this._fetchQueue.push(()=>{I.cancel(),m.cancel()})}else c(null)}updateNeeded(t,n){return(!this.textureDescriptor||this.textureDescriptor.band!==n||this.textureDescriptor.layer!==t)&&this.state!=="errored"}updateTextureDescriptor(t,n){if(!this._mrt)return;const c=this._mrt.getLayer(t);if(!c||!c.hasBand(n)||!c.hasDataForBand(n))return;const{bytes:d,tileSize:f,buffer:m,offset:y,scale:v}=c.getBandView(n),T=f+2*m,S=new o.r({width:T,height:T},d),C=this.texture;C&&C instanceof o.T&&C.update(S,{premultiply:!1}),this.textureDescriptor={layer:t,band:n,img:S,buffer:m,offset:y,tileSize:f,format:c.pixelFormat,mix:[v,256*v,65536*v,16777216*v]}}}class Bu{constructor(t,n){this.max=t,this.onRemove=n,this.reset()}reset(){for(const t in this.data)for(const n of this.data[t])n.timeout&&clearTimeout(n.timeout),this.onRemove(n.value);return this.data={},this.order=[],this}add(t,n,c){const d=t.wrapped().key;this.data[d]===void 0&&(this.data[d]=[]);const f={value:n,timeout:void 0};if(c!==void 0&&(f.timeout=setTimeout(()=>{this.remove(t,f)},c)),this.data[d].push(f),this.order.push(d),this.order.length>this.max){const m=this._getAndRemoveByKey(this.order[0]);m&&this.onRemove(m)}return this}has(t){return t.wrapped().key in this.data}getAndRemove(t){return this.has(t)?this._getAndRemoveByKey(t.wrapped().key):null}_getAndRemoveByKey(t){const n=this.data[t].shift();return n.timeout&&clearTimeout(n.timeout),this.data[t].length===0&&delete this.data[t],this.order.splice(this.order.indexOf(t),1),n.value}getByKey(t){const n=this.data[t];return n?n[0].value:null}get(t){return this.has(t)?this.data[t.wrapped().key][0].value:null}remove(t,n){if(!this.has(t))return this;const c=t.wrapped().key,d=n===void 0?0:this.data[c].indexOf(n),f=this.data[c][d];return this.data[c].splice(d,1),f.timeout&&clearTimeout(f.timeout),this.data[c].length===0&&delete this.data[c],this.onRemove(f.value),this.order.splice(this.order.indexOf(c),1),this}setMaxSize(t){for(this.max=t;this.order.length>this.max;){const n=this._getAndRemoveByKey(this.order[0]);n&&this.onRemove(n)}return this}filter(t){const n=[];for(const c in this.data)for(const d of this.data[c])t(d.value)||n.push(d);for(const c of n)this.remove(c.value.tileID,c)}}class Nu{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(t,n,c){const d=String(n);if(this.stateChanges[t]=this.stateChanges[t]||{},this.stateChanges[t][d]=this.stateChanges[t][d]||{},o.h(this.stateChanges[t][d],c),this.deletedStates[t]===null){this.deletedStates[t]={};for(const f in this.state[t])f!==d&&(this.deletedStates[t][f]=null)}else if(this.deletedStates[t]&&this.deletedStates[t][d]===null){this.deletedStates[t][d]={};for(const f in this.state[t][d])c[f]||(this.deletedStates[t][d][f]=null)}else for(const f in c)this.deletedStates[t]&&this.deletedStates[t][d]&&this.deletedStates[t][d][f]===null&&delete this.deletedStates[t][d][f]}removeFeatureState(t,n,c){if(this.deletedStates[t]===null)return;const d=String(n);if(this.deletedStates[t]=this.deletedStates[t]||{},c&&n!==void 0)this.deletedStates[t][d]!==null&&(this.deletedStates[t][d]=this.deletedStates[t][d]||{},this.deletedStates[t][d][c]=null);else if(n!==void 0)if(this.stateChanges[t]&&this.stateChanges[t][d])for(c in this.deletedStates[t][d]={},this.stateChanges[t][d])this.deletedStates[t][d][c]=null;else this.deletedStates[t][d]=null;else this.deletedStates[t]=null}getState(t,n){const c=this.state[t]||{},d=this.stateChanges[t]||{},f=this.deletedStates[t];if(f===null)return{};if(n!==void 0){const y=String(n),v=o.h({},c[y],d[y]);if(f){const T=f[n];if(T===null)return{};for(const S in T)delete v[S]}return v}const m=o.h({},c,d);if(f)for(const y in f)delete m[y];return m}initializeTileState(t,n){t.refreshFeatureState(n)}coalesceChanges(t,n){const c={};for(const d in this.stateChanges){this.state[d]=this.state[d]||{};const f={};for(const m in this.stateChanges[d])this.state[d][m]||(this.state[d][m]={}),o.h(this.state[d][m],this.stateChanges[d][m]),f[m]=this.state[d][m];c[d]=f}for(const d in this.deletedStates){this.state[d]=this.state[d]||{};const f={};if(this.deletedStates[d]===null)for(const m in this.state[d])f[m]={},this.state[d][m]={};else for(const m in this.deletedStates[d]){if(this.deletedStates[d][m]===null)this.state[d][m]={};else if(this.state[d][m])for(const y of Object.keys(this.deletedStates[d][m]))delete this.state[d][m][y];f[m]=this.state[d][m]}c[d]=c[d]||{},o.h(c[d],f)}if(this.stateChanges={},this.deletedStates={},Object.keys(c).length!==0)for(const d in t)t[d].refreshFeatureState(n)}}class En extends o.E{constructor(t,n,c){super(),this.id=t,this._onlySymbols=c,n.on("data",d=>{d.dataType==="source"&&d.sourceDataType==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&d.dataType==="source"&&d.sourceDataType==="content"&&(this.reload(),this.transform&&this.update(this.transform))}),n.on("error",()=>{this._sourceErrored=!0}),this._source=n,this._tiles={},this._cache=new Bu(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=n.minTileCacheSize,this._maxTileCacheSize=n.maxTileCacheSize,this._loadedParentTiles={},this.castsShadows=!1,this.tileCoverLift=0,this._coveredTiles={},this._shadowCasterTiles={},this._state=new Nu,this._isRaster=this._source.type==="raster"||this._source.type==="raster-dem"||this._source.type==="raster-array"||this._source.type==="custom"&&this._source._dataType==="raster"}onAdd(t){this.map=t,this._minTileCacheSize=this._minTileCacheSize===void 0&&t?t._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=this._maxTileCacheSize===void 0&&t?t._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;for(const t in this._tiles)if(!this._tiles[t].loaded())return!1;return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const t=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,t&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(t,n){return t.isSymbolTile=this._onlySymbols,t.isExtraShadowCaster=this._shadowCasterTiles[t.tileID.key],this._source.loadTile(t,n)}_unloadTile(t){if(this._source.unloadTile)return this._source.unloadTile(t)}_abortTile(t){if(this._source.abortTile)return this._source.abortTile(t)}serialize(){return this._source.serialize()}prepare(t){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const n in this._tiles){const c=this._tiles[n];c.upload(t),c.prepare(this.map.style.imageManager,this.map?this.map.painter:null,this._source.scope)}}getIds(){return Object.values(this._tiles).map(t=>t.tileID).sort(Do).map(t=>t.key)}getRenderableIds(t,n){const c=[];for(const d in this._tiles)this._isIdRenderable(+d,t,n)&&c.push(this._tiles[d]);return t?c.sort((d,f)=>{const m=d.tileID,y=f.tileID,v=new o.P(m.canonical.x,m.canonical.y)._rotate(this.transform.angle),T=new o.P(y.canonical.x,y.canonical.y)._rotate(this.transform.angle);return m.overscaledZ-y.overscaledZ||T.y-v.y||T.x-v.x}).map(d=>d.tileID.key):c.map(d=>d.tileID).sort(Do).map(d=>d.key)}hasRenderableParent(t){const n=this.findLoadedParent(t,0);return!!n&&this._isIdRenderable(n.tileID.key)}_isIdRenderable(t,n,c){return this._tiles[t]&&this._tiles[t].hasData()&&!this._coveredTiles[t]&&(n||!this._tiles[t].holdingForFade())&&(c||!this._shadowCasterTiles[t])}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const t in this._tiles)this._tiles[t].state!=="errored"&&this._reloadTile(+t,"reloading")}}_reloadTile(t,n){const c=this._tiles[t];c&&(c.state!=="loading"&&(c.state=n),this._loadTile(c,this._tileLoaded.bind(this,c,t,n)))}_tileLoaded(t,n,c,d){if(d)if(t.state="errored",d.status!==404)this._source.fire(new o.z(d,{tile:t}));else{if(this._source.fire(new o.A("data",{dataType:"source",sourceDataType:"error",sourceId:this._source.id,tile:t})),!(t.tileID.key in this._loadedParentTiles))return;if(this._source.type==="raster-dem"&&this.usedForTerrain&&this.map.painter.terrain){const f=this.map.painter.terrain;this.update(this.transform,f.getScaledDemTileSize(),!0),f.resetTileLookupCache(this.id)}else this.update(this.transform)}else t.timeAdded=o.q.now(),c==="expired"&&(t.refreshedUponExpiration=!0),this._setTileReloadTimer(n,t),this._source.type==="raster-dem"&&t.dem&&this._backfillDEM(t),this._state.initializeTileState(t,this.map?this.map.painter:null),this._source.fire(new o.A("data",{dataType:"source",tile:t,coord:t.tileID,sourceCacheId:this.id}))}_backfillDEM(t){const n=this.getRenderableIds();for(let d=0;d<n.length;d++){const f=n[d];if(t.neighboringTiles&&t.neighboringTiles[f]){const m=this.getTileByID(f);c(t,m),c(m,t)}}function c(d,f){if(!d.dem||d.dem.borderReady)return;d.needsHillshadePrepare=!0,d.needsDEMTextureUpload=!0;let m=f.tileID.canonical.x-d.tileID.canonical.x;const y=f.tileID.canonical.y-d.tileID.canonical.y,v=Math.pow(2,d.tileID.canonical.z),T=f.tileID.key;m===0&&y===0||Math.abs(y)>1||(Math.abs(m)>1&&(Math.abs(m+v)===1?m+=v:Math.abs(m-v)===1&&(m-=v)),f.dem&&d.dem&&(d.dem.backfillBorder(f.dem,m,y),d.neighboringTiles&&d.neighboringTiles[T]&&(d.neighboringTiles[T].backfilled=!0)))}}getTile(t){return this.getTileByID(t.key)}getTileByID(t){return this._tiles[t]}_retainLoadedChildren(t,n,c,d){for(const f in this._tiles){let m=this._tiles[f];if(d[f]||!m.hasData()||m.tileID.overscaledZ<=n||m.tileID.overscaledZ>c)continue;let y=m.tileID;for(;m&&m.tileID.overscaledZ>n+1;){const T=m.tileID.scaledTo(m.tileID.overscaledZ-1);m=this._tiles[T.key],m&&m.hasData()&&(y=T)}let v=y;for(;v.overscaledZ>n;)if(v=v.scaledTo(v.overscaledZ-1),t[v.key]){d[y.key]=y;break}}}findLoadedParent(t,n){if(t.key in this._loadedParentTiles){const c=this._loadedParentTiles[t.key];return c&&c.tileID.overscaledZ>=n?c:null}for(let c=t.overscaledZ-1;c>=n;c--){const d=t.scaledTo(c),f=this._getLoadedTile(d);if(f)return f}}_getLoadedTile(t){const n=this._tiles[t.key];return n&&n.hasData()?n:this._cache.getByKey(this._source.reparseOverscaled?t.wrapped().key:t.canonical.key)}updateCacheSize(t,n){n=n||this._source.tileSize;const c=Math.ceil(t.width/n)+1,d=Math.ceil(t.height/n)+1,f=Math.floor(c*d*5),m=typeof this._minTileCacheSize=="number"?Math.max(this._minTileCacheSize,f):f,y=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,m):m;this._cache.setMaxSize(y)}handleWrapJump(t){const n=Math.round((t-(this._prevLng===void 0?t:this._prevLng))/360);if(this._prevLng=t,n){const c={};for(const d in this._tiles){const f=this._tiles[d];f.tileID=f.tileID.unwrapTo(f.tileID.wrap+n),c[f.tileID.key]=f}this._tiles=c;for(const d in this._timers)clearTimeout(this._timers[d]),delete this._timers[d];for(const d in this._tiles)this._setTileReloadTimer(+d,this._tiles[d])}}update(t,n,c,d,f){if(this.transform=t,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage||this.usedForTerrain&&!c)return;this.updateCacheSize(t,n),this.transform.projection.name!=="globe"&&this.handleWrapJump(this.transform.center.lng),this._shadowCasterTiles={},this._coveredTiles={};const m=this._source.type==="batched-model";let y,v=this._source.maxzoom;const T=this.map&&this.map.painter?this.map.painter._terrain:null;if(T&&T.sourceCache===this&&T.attenuationRange()){const I=T.attenuationRange()[0],M=Math.floor(I)-Math.log2(T.getDemUpscale());v>M&&(v=M)}if(this.used||this.usedForTerrain){if(this._source.tileID)y=t.getVisibleUnwrappedCoordinates(this._source.tileID).map(I=>new o.aM(I.canonical.z,I.wrap,I.canonical.z,I.canonical.x,I.canonical.y));else if(this.tileCoverLift!==0){const I=t.clone();I.tileCoverLift=this.tileCoverLift,y=I.coveringTiles({tileSize:n||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:v,roundZoom:this._source.roundZoom&&!c,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:m}),this._source.minzoom<=1&&t.projection.name==="globe"&&(y.push(new o.aM(1,0,1,0,0)),y.push(new o.aM(1,0,1,1,0)),y.push(new o.aM(1,0,1,0,1)),y.push(new o.aM(1,0,1,1,1)))}else if(y=t.coveringTiles({tileSize:n||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:v,roundZoom:this._source.roundZoom&&!c,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:m}),this._source.hasTile){const I=this._source.hasTile.bind(this._source);y=y.filter(M=>I(M))}}else y=[];if(y.length>0&&this.transform.projection.name!=="globe"&&!this.usedForTerrain&&!dl(this._source.type)){const I=t.coveringZoomLevel({tileSize:n||this._source.tileSize,roundZoom:this._source.roundZoom&&!c}),M=Math.min(I,this._source.maxzoom);if(m){const D=t.extendTileCover(y,M);for(const z of D)y.push(z)}else if(f){const D=t.extendTileCover(y,M,this.transform._camera.forward());for(const z of D)y.push(z)}else if(this.castsShadows&&d){const D=t.extendTileCover(y,M,d);for(const z of D)this._shadowCasterTiles[z.key]=!0,y.push(z)}}const S=this._updateRetainedTiles(y);if(dl(this._source.type)&&y.length!==0){const I={},M={},D=Object.keys(S);for(const O of D){const B=S[O],V=this._tiles[O];if(!V||V.fadeEndTime&&V.fadeEndTime<=o.q.now())continue;const H=this.findLoadedParent(B,Math.max(B.overscaledZ-En.maxOverzooming,this._source.minzoom));H&&(this._addTile(H.tileID),I[H.tileID.key]=H.tileID),M[O]=B}const z=y[y.length-1].overscaledZ;for(const O in this._tiles){const B=this._tiles[O];if(S[O]||!B.hasData())continue;let V=B.tileID;for(;V.overscaledZ>z;){V=V.scaledTo(V.overscaledZ-1);const H=this._tiles[V.key];if(H&&H.hasData()&&M[V.key]){S[O]=B.tileID;break}}}for(const O in I)S[O]||(this._coveredTiles[O]=!0,S[O]=I[O])}for(const I in S)this._tiles[I].clearFadeHold();const C=o.bs(this._tiles,S);for(const I of C){const M=this._tiles[I];M.hasSymbolBuckets&&!M.holdingForFade()?M.setHoldDuration(this.map._fadeDuration):M.hasSymbolBuckets&&!M.symbolFadeFinished()||this._removeTile(+I)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(const t in this._tiles)this._tiles[t].holdingForFade()&&this._removeTile(+t)}_updateRetainedTiles(t){const n={};if(t.length===0)return n;const c={},d=t.reduce((T,S)=>Math.min(T,S.overscaledZ),1/0),f=t[0].overscaledZ,m=Math.max(f-En.maxOverzooming,this._source.minzoom),y=Math.max(f+En.maxUnderzooming,this._source.minzoom),v={};for(const T of t){const S=this._addTile(T);n[T.key]=T,S.hasData()||d<this._source.maxzoom&&(v[T.key]=T)}this._retainLoadedChildren(v,d,y,n);for(const T of t){let S=this._tiles[T.key];if(S.hasData())continue;if(T.canonical.z>=this._source.maxzoom){const I=T.children(this._source.maxzoom)[0],M=this.getTile(I);if(M&&M.hasData()){n[I.key]=I;continue}}else{const I=T.children(this._source.maxzoom);if(n[I[0].key]&&n[I[1].key]&&n[I[2].key]&&n[I[3].key])continue}let C=S.wasRequested();for(let I=T.overscaledZ-1;I>=m;--I){const M=T.scaledTo(I);if(c[M.key]||(c[M.key]=!0,S=this.getTile(M),!S&&C&&(S=this._addTile(M)),S&&(n[M.key]=M,C=S.wasRequested(),S.hasData())))break}}return n}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const t in this._tiles){const n=[];let c,d=this._tiles[t].tileID;for(;d.overscaledZ>0;){if(d.key in this._loadedParentTiles){c=this._loadedParentTiles[d.key];break}n.push(d.key);const f=d.scaledTo(d.overscaledZ-1);if(c=this._getLoadedTile(f),c)break;d=f}for(const f of n)this._loadedParentTiles[f]=c}}_addTile(t){let n=this._tiles[t.key];if(n)return n.isExtraShadowCaster!==!0||this._shadowCasterTiles[t.key]||this._reloadTile(t.key,"reloading"),n;n=this._cache.getAndRemove(t),n&&(this._setTileReloadTimer(t.key,n),n.tileID=t,this._state.initializeTileState(n,this.map?this.map.painter:null),this._cacheTimers[t.key]&&(clearTimeout(this._cacheTimers[t.key]),delete this._cacheTimers[t.key],this._setTileReloadTimer(t.key,n)));const c=!!n;if(!c){const d=this.map?this.map.painter:null,f=this._source.tileSize*t.overscaleFactor();n=this._source.type==="raster-array"?new ua(t,f,this.transform.tileZoom,d,this._isRaster):new Lo(t,f,this.transform.tileZoom,d,this._isRaster,this._source.worldview),this._loadTile(n,this._tileLoaded.bind(this,n,t.key,n.state))}return n.uses++,this._tiles[t.key]=n,c||this._source.fire(new o.A("dataloading",{tile:n,coord:n.tileID,dataType:"source"})),n}_setTileReloadTimer(t,n){t in this._timers&&(clearTimeout(this._timers[t]),delete this._timers[t]);const c=n.getExpiryTimeout();c&&(this._timers[t]=setTimeout(()=>{this._reloadTile(t,"expired"),delete this._timers[t]},c))}_removeTile(t){const n=this._tiles[t];n&&(n.uses--,delete this._tiles[t],this._timers[t]&&(clearTimeout(this._timers[t]),delete this._timers[t]),n.uses>0||(n.hasData()&&n.state!=="reloading"||n.state==="empty"?this._cache.add(n.tileID,n,n.getExpiryTimeout()):(n.aborted=!0,this._abortTile(n),this._unloadTile(n))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const t in this._tiles)this._removeTile(+t);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(t,n,c){const d=[],f=this.transform;if(!f)return d;const m=f.projection.name==="globe",y=o.aD(f.center.lng);for(const v in this._tiles){const T=this._tiles[v];if(c&&T.clearQueryDebugViz(),T.holdingForFade())continue;let S;if(m){const C=T.tileID.canonical;if(C.z===0){const I=[Math.abs(o.ay(y,...ha(C,-1))-y),Math.abs(o.ay(y,...ha(C,1))-y)];S=[0,2*I.indexOf(Math.min(...I))-1]}else{const I=[Math.abs(o.ay(y,...ha(C,-1))-y),Math.abs(o.ay(y,...ha(C,0))-y),Math.abs(o.ay(y,...ha(C,1))-y)];S=[I.indexOf(Math.min(...I))-1]}}else S=[0];for(const C of S){const I=t.containsTile(T,f,n,C);I&&d.push(I)}}return d}getShadowCasterCoordinates(){return this._getRenderableCoordinates(!1,!0)}getVisibleCoordinates(t){return this._getRenderableCoordinates(t)}_getRenderableCoordinates(t,n){const c=this.getRenderableIds(t,n).map(f=>this._tiles[f].tileID),d=this.transform.projection.name==="globe";for(const f of c)f.projMatrix=this.transform.calculateProjMatrix(f.toUnwrapped()),f.expandedProjMatrix=d?this.transform.calculateProjMatrix(f.toUnwrapped(),!1,!0):f.projMatrix;return c}sortCoordinatesByDistance(t){const n=t.slice(),c=this.transform._camera.position,d=this.transform._camera.forward(),f={};for(const m of n){const y=1/(1<<m.canonical.z);f[m.key]=((m.canonical.x+.5)*y+m.wrap-c[0])*d[0]+((m.canonical.y+.5)*y-c[1])*d[1]-c[2]*d[2]}return n.sort((m,y)=>f[m.key]-f[y.key]),n}hasTransition(){if(this._source.hasTransition())return!0;if(dl(this._source.type))for(const t in this._tiles){const n=this._tiles[t];if(n.fadeEndTime!==void 0&&n.fadeEndTime>=o.q.now())return!0}return!1}setFeatureState(t,n,c){this._state.updateState(t=t||"_geojsonTileLayer",n,c)}removeFeatureState(t,n,c){this._state.removeFeatureState(t=t||"_geojsonTileLayer",n,c)}getFeatureState(t,n){return this._state.getState(t=t||"_geojsonTileLayer",n)}setDependencies(t,n,c){const d=this._tiles[t];d&&d.setDependencies(n,c)}reloadTilesForDependencies(t,n){for(const c in this._tiles)this._tiles[c].hasDependency(t,n)&&this._reloadTile(+c,"reloading");this._cache.filter(c=>!c.hasDependency(t,n))}_preloadTiles(t,n){if(!this._sourceLoaded){const v=()=>{this._sourceLoaded&&(this._source.off("data",v),this._preloadTiles(t,n))};return void this._source.on("data",v)}const c=new Map,d=Array.isArray(t)?t:[t],f=this.map.painter.terrain,m=this.usedForTerrain&&f?f.getScaledDemTileSize():this._source.tileSize;for(const v of d){const T=v.coveringTiles({tileSize:m,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(const S of T)c.set(S.key,S);this.usedForTerrain&&v.updateElevation(!1)}const y=Array.from(c.values());o.bt(y,(v,T)=>{const S=new Lo(v,this._source.tileSize*v.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster,this._source.worldview);this._loadTile(S,C=>{this._source.type==="raster-dem"&&S.dem&&this._backfillDEM(S),T(C,S)})},n)}}function Do(l,t){const n=Math.abs(2*l.wrap)-+(l.wrap<0),c=Math.abs(2*t.wrap)-+(t.wrap<0);return l.overscaledZ-t.overscaledZ||c-n||t.canonical.y-l.canonical.y||t.canonical.x-l.canonical.x}function dl(l){return l==="raster"||l==="image"||l==="video"||l==="custom"}function ha(l,t){const n=1<<l.z;return[l.x/n+t,(l.x+1)/n+t]}En.maxOverzooming=10,En.maxUnderzooming=3;class Cd{constructor(t){this.style=t,this.layersGotHidden=!1,this.layers=[]}processLayersChanged(){this.layers=[];const t=!1,n=!1;for(const c in this.style._mergedLayers){const d=this.style._mergedLayers[c];if(d.type==="fill-extrusion"||d.type==="building")this.layers.push({layer:d,visible:t,visibilityChanged:n});else if(d.type==="model"){const f=this.style.getLayerSource(d);f&&f.type==="batched-model"&&this.layers.push({layer:d,visible:t,visibilityChanged:n})}}}onNewFrame(t){this.layersGotHidden=!1;for(const n of this.layers){const c=n.layer;let d=!1;c.type==="fill-extrusion"?d=!c.isHidden(t)&&c.paint.get("fill-extrusion-opacity")>0:c.type==="building"?d=!c.isHidden(t)&&c.paint.get("building-opacity")>0:c.type==="model"&&(d=!c.isHidden(t)&&c.paint.get("model-opacity").constantOr(1)>0),this.layersGotHidden=this.layersGotHidden||!d&&n.visible,n.visible=d}}updateZOffset(t,n){this.currentBuildingBuckets=[];for(const d of this.layers){const f=d.layer,m=this.style.getLayerSourceCache(f);let y=1;f.type==="fill-extrusion"?y=d.visible?f.paint.get("fill-extrusion-vertical-scale"):0:f.type==="building"&&(y=d.visible?f.paint.get("building-vertical-scale"):0);let v=m?m.getTile(n):null;if(!v&&m&&n.canonical.z>m.getSource().minzoom){let T=n.scaledTo(Math.min(m.getSource().maxzoom,n.overscaledZ-1));for(;T.overscaledZ>=m.getSource().minzoom&&(v=m.getTile(T),!v&&T.overscaledZ!==0);)T=T.scaledTo(T.overscaledZ-1)}this.currentBuildingBuckets.push({bucket:v?v.getBucket(f):null,tileID:v?v.tileID:n,verticalScale:y})}t.hasAnyZOffset=!1;let c=!1;for(let d=0;d<t.symbolInstances.length;d++){const f=t.symbolInstances.get(d),m=f.zOffset,y=this._getHeightAtTileOffset(n,f.tileAnchorX,f.tileAnchorY);f.zOffset=y!==Number.NEGATIVE_INFINITY?y:m,c||m===f.zOffset||(c=!0),t.hasAnyZOffset||f.zOffset===0||(t.hasAnyZOffset=!0)}c&&(t.zOffsetBuffersNeedUpload=!0,t.zOffsetSortDirty=!0)}_mapCoordToOverlappingTile(t,n,c,d){let f=n,m=c;if(t.canonical.z!==d.canonical.z){const y=d.canonical,v=1/(1<<t.canonical.z-y.z);f=(n+t.canonical.x*o.aj)*v-y.x*o.aj|0,m=(c+t.canonical.y*o.aj)*v-y.y*o.aj|0}return{tileX:f,tileY:m}}_getHeightAtTileOffset(t,n,c){let d,f;for(let m=0;m<this.layers.length;++m){const y=this.layers[m].layer;if(y.type!=="fill-extrusion"&&y.type!=="building")continue;const{bucket:v,tileID:T,verticalScale:S}=this.currentBuildingBuckets[m];if(!v)continue;const{tileX:C,tileY:I}=this._mapCoordToOverlappingTile(t,n,c,T),M=v.getHeightAtTileCoord(C,I);M&&M.height!==void 0&&(M.hidden?d=M.height:f=Math.max(M.height*S,f||0))}if(f!==void 0)return f;for(let m=0;m<this.layers.length;++m){const y=this.layers[m];if(y.layer.type!=="model"||!y.visible)continue;const{bucket:v,tileID:T}=this.currentBuildingBuckets[m];if(!v)continue;const{tileX:S,tileY:C}=this._mapCoordToOverlappingTile(t,n,c,T),I=v.getHeightAtTileCoord(S,C);if(I&&!I.hidden)return I.height===void 0&&d!==void 0?Math.min(I.maxHeight,d)*I.verticalScale:I.height?I.height*I.verticalScale:Number.NEGATIVE_INFINITY}return this.layersGotHidden?0:Number.NEGATIVE_INFINITY}}function Md(l,t){const n={};for(const c in l)c!=="ref"&&(n[c]=l[c]);return o.bu.forEach(c=>{c in t&&(n[c]=t[c])}),n}function fl(l){l=l.slice();const t=Object.create(null);for(let n=0;n<l.length;n++)t[l[n].id]=l[n];for(let n=0;n<l.length;n++)"ref"in l[n]&&(l[n]=Md(l[n],t[l[n].ref]));return l}const vi={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setSlot:"setSlot",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setSnow:"setSnow",setRain:"setRain",setCamera:"setCamera",setLights:"setLights",setProjection:"setProjection",addImport:"addImport",removeImport:"removeImport",updateImport:"updateImport",addIconset:"addIconset",removeIconset:"removeIconset"};function gc(l,t,n){n.push({command:vi.addSource,args:[l,t[l]]})}function da(l,t,n){t.push({command:vi.removeSource,args:[l]}),n[l]=!0}function pl(l,t,n,c){da(l,n,c),gc(l,t,n)}function Lp(l,t,n){let c;for(c in l[n])if(l[n].hasOwnProperty(c)&&c!=="data"&&!o.bv(l[n][c],t[n][c]))return!1;for(c in t[n])if(t[n].hasOwnProperty(c)&&c!=="data"&&!o.bv(l[n][c],t[n][c]))return!1;return!0}function ml(l,t,n,c,d,f){let m;for(m in t=t||{},l=l||{})l.hasOwnProperty(m)&&(o.bv(l[m],t[m])||n.push({command:f,args:[c,m,t[m],d]}));for(m in t)t.hasOwnProperty(m)&&!l.hasOwnProperty(m)&&(o.bv(l[m],t[m])||n.push({command:f,args:[c,m,t[m],d]}))}function Oo(l){return l.id}function io(l,t){return l[t.id]=t,l}class Vu{constructor(t,n){this.reset(t,n)}reset(t,n){this.points=t||[],this._distances=[0];for(let c=1;c<this.points.length;c++)this._distances[c]=this._distances[c-1]+this.points[c].dist(this.points[c-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(n||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(t){if(this.points.length===1)return this.points[0];t=o.ay(t,0,1);let n=1,c=this._distances[n];const d=t*this.paddedLength+this.padding;for(;c<d&&n<this._distances.length;)c=this._distances[++n];const f=n-1,m=this._distances[f],y=c-m,v=y>0?(d-m)/y:0;return this.points[f].mult(1-v).add(this.points[n].mult(v))}}class Uu{constructor(t,n,c){const d=this.boxCells=[],f=this.circleCells=[];this.xCellCount=Math.ceil(t/c),this.yCellCount=Math.ceil(n/c);for(let m=0;m<this.xCellCount*this.yCellCount;m++)d.push([]),f.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=t,this.height=n,this.xScale=this.xCellCount/t,this.yScale=this.yCellCount/n,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(t,n,c,d,f){this._forEachCell(n,c,d,f,this._insertBoxCell,this.boxUid++),this.boxKeys.push(t),this.bboxes.push(n),this.bboxes.push(c),this.bboxes.push(d),this.bboxes.push(f)}insertCircle(t,n,c,d){this._forEachCell(n-d,c-d,n+d,c+d,this._insertCircleCell,this.circleUid++),this.circleKeys.push(t),this.circles.push(n),this.circles.push(c),this.circles.push(d)}_insertBoxCell(t,n,c,d,f,m){this.boxCells[f].push(m)}_insertCircleCell(t,n,c,d,f,m){this.circleCells[f].push(m)}_query(t,n,c,d,f,m){if(c<0||t>this.width||d<0||n>this.height)return!f&&[];const y=[];if(t<=0&&n<=0&&this.width<=c&&this.height<=d){if(f)return!0;for(let v=0;v<this.boxKeys.length;v++)y.push({key:this.boxKeys[v],x1:this.bboxes[4*v],y1:this.bboxes[4*v+1],x2:this.bboxes[4*v+2],y2:this.bboxes[4*v+3]});for(let v=0;v<this.circleKeys.length;v++){const T=this.circles[3*v],S=this.circles[3*v+1],C=this.circles[3*v+2];y.push({key:this.circleKeys[v],x1:T-C,y1:S-C,x2:T+C,y2:S+C})}return m?y.filter(m):y}return this._forEachCell(t,n,c,d,this._queryCell,y,{hitTest:f,seenUids:{box:{},circle:{}}},m),f?y.length>0:y}_queryCircle(t,n,c,d,f){const m=t-c,y=t+c,v=n-c,T=n+c;if(y<0||m>this.width||T<0||v>this.height)return!d&&[];const S=[];return this._forEachCell(m,v,y,T,this._queryCellCircle,S,{hitTest:d,circle:{x:t,y:n,radius:c},seenUids:{box:{},circle:{}}},f),d?S.length>0:S}query(t,n,c,d,f){return this._query(t,n,c,d,!1,f)}hitTest(t,n,c,d,f){return this._query(t,n,c,d,!0,f)}hitTestCircle(t,n,c,d){return this._queryCircle(t,n,c,!0,d)}_queryCell(t,n,c,d,f,m,y,v){const T=y.seenUids,S=this.boxCells[f];if(S!==null){const I=this.bboxes;for(const M of S)if(!T.box[M]){T.box[M]=!0;const D=4*M;if(t<=I[D+2]&&n<=I[D+3]&&c>=I[D+0]&&d>=I[D+1]&&(!v||v(this.boxKeys[M]))){if(y.hitTest)return m.push(!0),!0;m.push({key:this.boxKeys[M],x1:I[D],y1:I[D+1],x2:I[D+2],y2:I[D+3]})}}}const C=this.circleCells[f];if(C!==null){const I=this.circles;for(const M of C)if(!T.circle[M]){T.circle[M]=!0;const D=3*M;if(this._circleAndRectCollide(I[D],I[D+1],I[D+2],t,n,c,d)&&(!v||v(this.circleKeys[M]))){if(y.hitTest)return m.push(!0),!0;{const z=I[D],O=I[D+1],B=I[D+2];m.push({key:this.circleKeys[M],x1:z-B,y1:O-B,x2:z+B,y2:O+B})}}}}}_queryCellCircle(t,n,c,d,f,m,y,v){const T=y.circle,S=y.seenUids,C=this.boxCells[f];if(C!==null){const M=this.bboxes;for(const D of C)if(!S.box[D]){S.box[D]=!0;const z=4*D;if(this._circleAndRectCollide(T.x,T.y,T.radius,M[z+0],M[z+1],M[z+2],M[z+3])&&(!v||v(this.boxKeys[D])))return m.push(!0),!0}}const I=this.circleCells[f];if(I!==null){const M=this.circles;for(const D of I)if(!S.circle[D]){S.circle[D]=!0;const z=3*D;if(this._circlesCollide(M[z],M[z+1],M[z+2],T.x,T.y,T.radius)&&(!v||v(this.circleKeys[D])))return m.push(!0),!0}}}_forEachCell(t,n,c,d,f,m,y,v){const T=this._convertToXCellCoord(t),S=this._convertToYCellCoord(n),C=this._convertToXCellCoord(c),I=this._convertToYCellCoord(d);for(let M=T;M<=C;M++)for(let D=S;D<=I;D++)if(f.call(this,t,n,c,d,this.xCellCount*D+M,m,y,v))return}_convertToXCellCoord(t){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(t*this.xScale)))}_convertToYCellCoord(t){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(t*this.yScale)))}_circlesCollide(t,n,c,d,f,m){const y=d-t,v=f-n,T=c+m;return T*T>y*y+v*v}_circleAndRectCollide(t,n,c,d,f,m,y){const v=(m-d)/2,T=Math.abs(t-(d+v));if(T>v+c)return!1;const S=(y-f)/2,C=Math.abs(n-(f+S));if(C>S+c)return!1;if(T<=v||C<=S)return!0;const I=T-v,M=C-S;return I*I+M*M<=c*c}}const ko={unknown:0,flipRequired:1,flipNotRequired:2},Pd=Math.tan(85*Math.PI/180);function Ps(l,t,n,c,d,f,m){const y=o.bz();if(n)if(f.name==="globe"){const v=o.bA(d,t);o.az(y,y,v)}else{const v=o.bB([],m);y[0]=v[0],y[1]=v[1],y[4]=v[2],y[5]=v[3],c||o.by(y,y,d.angle)}else o.az(y,d.labelPlaneMatrix,l);return y}function yc(l,t,n,c,d,f,m){const y=Ps(l,t,n,c,d,f,m);return f.name==="globe"&&n||(y[2]=y[6]=y[10]=y[14]=0),y}function vc(l,t,n,c,d,f,m){if(n){if(f.name==="globe"){const y=Ps(l,t,n,c,d,f,m);return o.bi(y,y),o.az(y,l,y),y}{const y=o.bw(l),v=o.bx([]);return v[0]=m[0],v[1]=m[1],v[4]=m[2],v[5]=m[3],o.az(y,y,v),c||o.by(y,y,-d.angle),y}}return d.glCoordMatrix}function os(l,t,n,c){const d=[l,t,n,1];n?o.aA(d,d,c):Pi(d,d,c);const f=d[3];return d[0]/=f,d[1]/=f,d[2]/=f,d}function _l(l,t){return Math.min(.5+l/t*.5,1.5)}function Fo(l,t){const n=l[0]/l[3],c=l[1]/l[3];return n>=-t[0]&&n<=t[0]&&c>=-t[1]&&c<=t[1]}function xc(l,t,n,c,d,f,m,y,v,T){const S=n.transform,C=c?l.textSizeData:l.iconSizeData,I=o.bH(C,n.transform.zoom),M=S.projection.name==="globe",D=[256/n.width*2+1,256/n.height*2+1],z=c?l.text.dynamicLayoutVertexArray:l.icon.dynamicLayoutVertexArray;z.clear();let O=null;M&&(O=c?l.text.globeExtVertexArray:l.icon.globeExtVertexArray);const B=l.lineVertexArray,V=c?l.text.placedSymbolArray:l.icon.placedSymbolArray,H=n.transform.width/n.transform.height;let Y,te=!1;for(let ee=0;ee<V.length;ee++){const J=V.get(ee),{numGlyphs:K,writingMode:ie}=J;if(ie!==o.bI.vertical||te||Y===o.bI.horizontal||(te=!0),Y=ie,(J.hidden||ie===o.bI.vertical)&&!te){No(K,z);continue}te=!1;const se=new o.P(J.tileAnchorX,J.tileAnchorY);let{x:ye,y:ve,z:Oe}=S.projection.projectTilePoint(se.x,se.y,T.canonical);if(v){const[wt,Tt,gt]=v(se);ye+=wt,ve+=Tt,Oe+=gt}const ke=[ye,ve,Oe,1];if(o.aA(ke,ke,t),!Fo(ke,D)){No(K,z);continue}const Ze=ke[3],_e=_l(n.transform.getCameraToCenterDistance(S.projection),Ze),Pe=o.bJ(C,I,J),ue=m?Pe/_e:Pe*_e,Ne=os(ye,ve,Oe,d);if(Ne[3]<=0){No(K,z);continue}let Se={};const qe=o.al(l.layers[0].layout.get("text-max-angle")),rt=Math.cos(qe),Fe=m?null:v,tt=Bo(J,ue,!1,y,t,d,f,l.glyphOffsetArray,B,z,O,Ne,se,Se,H,Fe,S.projection,T,m,rt);te=tt.useVertical,Fe&&tt.needsFlipping&&(Se={}),(tt.notEnoughRoom||te||tt.needsFlipping&&Bo(J,ue,!0,y,t,d,f,l.glyphOffsetArray,B,z,O,Ne,se,Se,H,Fe,S.projection,T,m,rt).notEnoughRoom)&&No(K,z)}c?(l.text.dynamicLayoutVertexBuffer.updateData(z),O&&l.text.globeExtVertexBuffer&&l.text.globeExtVertexBuffer.updateData(O)):(l.icon.dynamicLayoutVertexBuffer.updateData(z),O&&l.icon.globeExtVertexBuffer&&l.icon.globeExtVertexBuffer.updateData(O))}function ju(l,t,n,c,d,f,m,y,v,T,S,C,I,M,D,z,O){const{lineStartIndex:B,glyphStartIndex:V,segment:H}=y,Y=V+y.numGlyphs,te=B+y.lineLength,ee=t.getoffsetX(V),J=t.getoffsetX(Y-1),K=fa(l*ee,n,c,d,f,m,H,B,te,v,T,S,C,I,!0,M,D,z,O);if(!K)return null;const ie=fa(l*J,n,c,d,f,m,H,B,te,v,T,S,C,I,!0,M,D,z,O);return ie?{first:K,last:ie}:null}function bc(l,t,n,c){return l===o.bI.horizontal&&Math.abs(c)>Math.abs(n)?{useVertical:!0}:l===o.bI.vertical?c>0?{needsFlipping:!0}:null:t!==ko.unknown&&function(d,f){return d===0||Math.abs(f/d)>Pd}(n,c)?t===ko.flipRequired?{needsFlipping:!0}:null:n<0?{needsFlipping:!0}:null}function Bo(l,t,n,c,d,f,m,y,v,T,S,C,I,M,D,z,O,B,V,H){const Y=t/24,te=l.lineOffsetX*Y,ee=l.lineOffsetY*Y,{lineStartIndex:J,glyphStartIndex:K,numGlyphs:ie,segment:se,writingMode:ye,flipState:ve}=l,Oe=J+l.lineLength,ke=Ze=>{if(S){const[Ne,Se,qe]=Ze.up,rt=T.length;o.bK(S,rt+0,Ne,Se,qe),o.bK(S,rt+1,Ne,Se,qe),o.bK(S,rt+2,Ne,Se,qe),o.bK(S,rt+3,Ne,Se,qe)}const[_e,Pe,ue]=Ze.point;o.bL(T,_e,Pe,ue,Ze.angle)};if(ie>1){const Ze=ju(Y,y,te,ee,n,C,I,l,v,f,M,z,!1,O,B,V,H);if(!Ze)return{notEnoughRoom:!0};if(c&&!n){let[_e,Pe,ue]=Ze.first.point,[Ne,Se,qe]=Ze.last.point;[_e,Pe]=os(_e,Pe,ue,m),[Ne,Se]=os(Ne,Se,qe,m);const rt=bc(ye,ve,(Ne-_e)*D,Se-Pe);if(l.flipState=rt&&rt.needsFlipping?ko.flipRequired:ko.flipNotRequired,rt)return rt}ke(Ze.first);for(let _e=K+1;_e<K+ie-1;_e++){const Pe=fa(Y*y.getoffsetX(_e),te,ee,n,C,I,se,J,Oe,v,f,M,z,!1,!1,O,B,V,H);if(!Pe)return T.length-=4*(_e-K),{notEnoughRoom:!0};ke(Pe)}ke(Ze.last)}else{if(c&&!n){const _e=os(I.x,I.y,0,d),Pe=J+se+1,ue=new o.P(v.getx(Pe),v.gety(Pe)),Ne=os(ue.x,ue.y,0,d),Se=Ne[3]>0?Ne:Gu(I,ue,_e,1,d,void 0,O,B.canonical),qe=bc(ye,ve,(Se[0]-_e[0])*D,Se[1]-_e[1]);if(l.flipState=qe&&qe.needsFlipping?ko.flipRequired:ko.flipNotRequired,qe)return qe}const Ze=fa(Y*y.getoffsetX(K),te,ee,n,C,I,se,J,Oe,v,f,M,z,!1,!1,O,B,V,H);if(!Ze)return{notEnoughRoom:!0};ke(Ze)}return{}}function Ln(l,t,n,c,d){const{x:f,y:m,z:y}=c.projectTilePoint(l.x,l.y,t);if(!d)return os(f,m,y,n);const[v,T,S]=d(l);return os(f+v,m+T,y+S,n)}function Gu(l,t,n,c,d,f,m,y){const v=Ln(l.sub(t)._unit()._add(l),y,d,m,f);return o.at(v,n,v),o.au(v,v),o.bE(v,n,v,c)}function fa(l,t,n,c,d,f,m,y,v,T,S,C,I,M,D,z,O,B,V){const H=c?l-t:l+t;let Y=H>0?1:-1,te=0;c&&(Y*=-1,te=Math.PI),Y<0&&(te+=Math.PI);let ee=y+m+(Y>0?0:1)|0,J=d,K=d,ie=0,se=0;const ye=Math.abs(H),ve=[],Oe=[];let ke=f,Ze=ke,_e=o.bC([]);const Pe=()=>Gu(Ze,ke,K,ye-ie+1,S,I,z,O.canonical);for(;ie+se<=ye;){if(ee+=Y,ee<y||ee>=v)return null;if(K=J,Ze=ke,ve.push(K),M&&Oe.push(Ze),ke=new o.P(T.getx(ee),T.gety(ee)),J=C[ee],!J){const gt=Ln(ke,O.canonical,S,z,I);J=gt[3]>0?C[ee]=gt:Pe()}ie+=se;const wt=o.at([],J,K),Tt=o.bD(K,J);if(n&&Tt>0&&se>0&&o.bG(_e,wt)/(se*Tt)<V)return null;se=Tt,_e=wt}D&&I&&(C[ee]&&(J=Pe(),se=o.bD(K,J),_e=o.at([],J,K)),C[ee]=J);const ue=(ye-ie)/se,Ne=ke.sub(Ze)._mult(ue)._add(Ze),Se=o.bE([],K,_e,ue);let qe=[0,0,1],rt=_e[0],Fe=_e[1];if(B&&(qe=z.upVector(O.canonical,Ne.x,Ne.y),qe[0]!==0||qe[1]!==0||qe[2]!==1)){const wt=[qe[2],0,-qe[0]],Tt=o.bF([],qe,wt);o.au(wt,wt),o.au(Tt,Tt),rt=o.bG(_e,wt),Fe=o.bG(_e,Tt)}if(n){const wt=o.bF([],qe,_e);o.au(wt,wt),o.bE(Se,Se,wt,n*Y)}const tt=te+Math.atan2(Fe,rt);return ve.push(Se),M&&Oe.push(Ne),{point:Se,angle:tt,path:ve,tilePath:Oe,up:qe}}function No(l,t){const n=t.length,c=n+4*l;t.resize(c),t.float32.fill(-1/0,4*n,4*c)}function Pi(l,t,n){const c=t[0],d=t[1];return l[0]=n[0]*c+n[4]*d+n[12],l[1]=n[1]*c+n[5]*d+n[13],l[3]=n[3]*c+n[7]*d+n[15],l}const as=100;class Dp{constructor(t,n,c=new Uu(t.width+200,t.height+200,25),d=new Uu(t.width+200,t.height+200,25)){this.transform=t,this.grid=c,this.ignoredGrid=d,this.pitchfactor=Math.cos(t._pitch)*t.cameraToCenterDistance,this.screenRightBoundary=t.width+as,this.screenBottomBoundary=t.height+as,this.gridRightBoundary=t.width+200,this.gridBottomBoundary=t.height+200,this.fogState=n}placeCollisionBox(t,n,c,d,f,m,y,v){let T=c.projectedAnchorX,S=c.projectedAnchorY,C=c.projectedAnchorZ;const I=c.elevation,M=c.tileID,D=t.getProjection();if(I&&M){const[ee,J,K]=D.upVector(M.canonical,c.tileAnchorX,c.tileAnchorY),ie=D.upVectorScale(M.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;T+=ee*I*ie,S+=J*I*ie,C+=K*I*ie}const z=this.projectAndGetPerspectiveRatio(y,T,S,C,c.tileID,D.name==="globe"||!!I||this.transform.pitch>0,D),O=m*z.perspectiveRatio,B=(c.x1*n+d.x-c.padding)*O+z.point.x,V=(c.y1*n+d.y-c.padding)*O+z.point.y,H=(c.x2*n+d.x+c.padding)*O+z.point.x,Y=(c.y2*n+d.y+c.padding)*O+z.point.y,te=z.perspectiveRatio<=.55||z.occluded;return!this.isInsideGrid(B,V,H,Y)||!f&&this.grid.hitTest(B,V,H,Y,v)||te?{box:[],offscreen:!1,occluded:z.occluded}:{box:[B,V,H,Y],offscreen:this.isOffscreen(B,V,H,Y),occluded:!1}}placeCollisionCircles(t,n,c,d,f,m,y,v,T,S,C,I,M,D,z){const O=[],B=this.transform.elevation,V=t.getProjection(),H=B?B.getAtTileOffsetFunc(z,this.transform.center.lat,this.transform.worldSize,V):null,Y=new o.P(c.tileAnchorX,c.tileAnchorY);let{x:te,y:ee,z:J}=V.projectTilePoint(Y.x,Y.y,z.canonical);if(H){const[qe,rt,Fe]=H(Y);te+=qe,ee+=rt,J+=Fe}const K=V.name==="globe",ie=this.projectAndGetPerspectiveRatio(y,te,ee,J,z,K||!!B||this.transform.pitch>0,V),{perspectiveRatio:se}=ie,ye=(C?m/se:m*se)/o.bO,ve=os(te,ee,J,v),Oe=c.lineOffsetX*ye,ke=c.lineOffsetY*ye,Ze=o.al(t.layers[0].layout.get("text-max-angle")),_e=Math.cos(Ze),Pe=ie.signedDistanceFromCamera>0?ju(ye,f,Oe,ke,!1,ve,Y,c,d,v,{},B&&!C?H:null,C&&!!B,V,z,C,_e):null;let ue=!1,Ne=!1,Se=!0;if(Pe&&!ie.occluded){const qe=.5*M*se+D,rt=new o.P(-100,-100),Fe=new o.P(this.screenRightBoundary,this.screenBottomBoundary),tt=new Vu,{first:wt,last:Tt}=Pe,gt=wt.path.length;let Rt=[];for(let $t=gt-1;$t>=1;$t--)Rt.push(wt.path[$t]);for(let $t=1;$t<Tt.path.length;$t++)Rt.push(Tt.path[$t]);const Dt=2.5*qe;T&&(Rt=Rt.map(([$t,ti,zi],Ji)=>(H&&!K&&(zi=H(Ji<gt-1?wt.tilePath[gt-1-Ji]:Tt.tilePath[Ji-gt+2])[2]),os($t,ti,zi,T))),Rt.some($t=>$t[3]<=0)&&(Rt=[]));let kt=[];if(Rt.length>0){let $t=1/0,ti=-1/0,zi=1/0,Ji=-1/0;for(const Fi of Rt)$t=Math.min($t,Fi[0]),zi=Math.min(zi,Fi[1]),ti=Math.max(ti,Fi[0]),Ji=Math.max(Ji,Fi[1]);ti>=rt.x&&$t<=Fe.x&&Ji>=rt.y&&zi<=Fe.y&&(kt=[Rt.map(Fi=>new o.P(Fi[0],Fi[1]))],($t<rt.x||ti>Fe.x||zi<rt.y||Ji>Fe.y)&&(kt=o.bM(kt,rt.x,rt.y,Fe.x,Fe.y)))}for(const $t of kt){tt.reset($t,.25*qe);let ti=0;ti=tt.length<=.5*qe?1:Math.ceil(tt.paddedLength/Dt)+1;for(let zi=0;zi<ti;zi++){const Ji=zi/Math.max(ti-1,1),Fi=tt.lerp(Ji),Vi=Fi.x+as,Mr=Fi.y+as;O.push(Vi,Mr,qe,0);const Kt=Vi-qe,ni=Mr-qe,ui=Vi+qe,nr=Mr+qe;if(Se=Se&&this.isOffscreen(Kt,ni,ui,nr),Ne=Ne||this.isInsideGrid(Kt,ni,ui,nr),!n&&this.grid.hitTestCircle(Vi,Mr,qe,I)&&(ue=!0,!S))return{circles:[],offscreen:!1,collisionDetected:ue,occluded:!1}}}}return{circles:!S&&ue||!Ne?[]:O,offscreen:Se,collisionDetected:ue,occluded:ie.occluded}}queryRenderedSymbols(t){if(t.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};const n=[];let c=1/0,d=1/0,f=-1/0,m=-1/0;for(const S of t){const C=new o.P(S.x+as,S.y+as);c=Math.min(c,C.x),d=Math.min(d,C.y),f=Math.max(f,C.x),m=Math.max(m,C.y),n.push(C)}const y=this.grid.query(c,d,f,m).concat(this.ignoredGrid.query(c,d,f,m)),v={},T={};for(const S of y){const C=S.key;if(v[C.bucketInstanceId]===void 0&&(v[C.bucketInstanceId]={}),v[C.bucketInstanceId][C.featureIndex])continue;const I=[new o.P(S.x1,S.y1),new o.P(S.x2,S.y1),new o.P(S.x2,S.y2),new o.P(S.x1,S.y2)];o.bN(n,I)&&(v[C.bucketInstanceId][C.featureIndex]=!0,T[C.bucketInstanceId]===void 0&&(T[C.bucketInstanceId]=[]),T[C.bucketInstanceId].push(C.featureIndex))}return T}insertCollisionBox(t,n,c,d,f){(n?this.ignoredGrid:this.grid).insert({bucketInstanceId:c,featureIndex:d,collisionGroupID:f},t[0],t[1],t[2],t[3])}insertCollisionCircles(t,n,c,d,f){const m=n?this.ignoredGrid:this.grid,y={bucketInstanceId:c,featureIndex:d,collisionGroupID:f};for(let v=0;v<t.length;v+=4)m.insertCircle(y,t[v],t[v+1],t[v+2])}projectAndGetPerspectiveRatio(t,n,c,d,f,m,y){const v=[n,c,d,1];let T=!1;d||this.transform.pitch>0?(o.aA(v,v,t),this.fogState&&f&&y.name!=="globe"&&(T=function(I,M,D,z,O,B){const V=B.calculateFogTileMatrix(O),H=[M,D,z];return o.ad(H,H,V),ct(I,o.ae(H),B.pitch,B._fov)}(this.fogState,n,c,d,f.toUnwrapped(),this.transform)>.9)):Pi(v,v,t);const S=v[3];return{point:new o.P((v[0]/S+1)/2*this.transform.width+as,(-v[1]/S+1)/2*this.transform.height+as),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(y)/S*.5,1.5),signedDistanceFromCamera:S,occluded:m&&v[2]>S||T}}isOffscreen(t,n,c,d){return c<as||t>=this.screenRightBoundary||d<as||n>this.screenBottomBoundary}isInsideGrid(t,n,c,d){return c>=0&&t<this.gridRightBoundary&&d>=0&&n<this.gridBottomBoundary}getViewportMatrix(){const t=o.bx([]);return o.bo(t,t,[-100,-100,0]),t}}function qu(l,t,n){const c=t.createTileMatrix(l,l.worldSize,n.toUnwrapped());return o.az(new Float32Array(16),l.projMatrix,c)}function Ut(l,t,n){if(t.projection.name===n.projection.name)return l.projMatrix;const c=n.clone();return c.setProjection(t.projection),qu(c,t.getProjection(),l)}function wc(l,t,n){return t.name===n.projection.name?l.projMatrix:qu(n,t,l)}class gl{constructor(t,n,c,d){this.opacity=t?Math.max(0,Math.min(1,t.opacity+(t.placed?n:-n))):d&&c?1:0,this.placed=c}isHidden(){return this.opacity===0&&!this.placed}}class Vo{constructor(t,n,c,d,f,m=!1){this.text=new gl(t?t.text:null,n,c,f),this.icon=new gl(t?t.icon:null,n,d,f),this.clipped=m}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class Gn{constructor(t,n,c,d=!1){this.text=t,this.icon=n,this.skipFade=c,this.clipped=d}}class $u{constructor(){this.invProjMatrix=o.bz(),this.viewportMatrix=o.bz(),this.circles=[]}}class pa{constructor(t,n,c,d,f){this.bucketInstanceId=t,this.featureIndex=n,this.sourceLayerIndex=c,this.bucketIndex=d,this.tileID=f}}class Lt{constructor(t){this.crossSourceCollisions=t,this.maxGroupID=0,this.collisionGroups={}}get(t){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[t]){const n=++this.maxGroupID;this.collisionGroups[t]={ID:n,predicate:c=>c.collisionGroupID===n}}return this.collisionGroups[t]}}function Ni(l,t,n,c,d){const{horizontalAlign:f,verticalAlign:m}=o.bT(l),y=-(f-.5)*t,v=-(m-.5)*n,T=o.bU(l,c);return new o.P(y+T[0]*d,v+T[1]*d)}function Ci(l,t,n,c,d){const f=new o.P(l,t);return n&&f._rotate(c?d:-d),f}class Dn{constructor(t,n,c,d,f,m){this.transform=t.clone(),this.projection=t.projection.name,this.collisionIndex=new Dp(this.transform,f),this.buildingIndex=m,this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=n,this.retainedQueryData={},this.collisionGroups=new Lt(c),this.collisionCircleArrays={},this.prevPlacement=d,d&&(d.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(t,n,c,d,f=1){const m=c.getBucket(n),y=c.latestFeatureIndex;if(!m||!y||n.fqid!==m.layerIds[0])return;const v=m.layers[0].layout,T=m.layers[0].paint,S=c.collisionBoxArray,C=Math.pow(2,this.transform.zoom-c.tileID.overscaledZ),I=c.tileSize/o.aj,M=c.tileID.toUnwrapped();this.transform.setProjection(m.projection);const D=(z=c.tileID,O=m.getProjection(),B=this.transform,O.name===this.projection?B.calculateProjMatrix(z.toUnwrapped()):qu(B,O,z));var z,O,B;const V=v.get("text-pitch-alignment")==="map",H=v.get("text-rotation-alignment")==="map";n.compileFilter(n.options);const Y=n.dynamicFilter(),te=n.dynamicFilterNeedsFeature(),ee=this.transform.calculatePixelsToTileUnitsMatrix(c),J=yc(D,c.tileID.canonical,V,H,this.transform,m.getProjection(),ee);let K=null;if(V){const Pe=vc(D,c.tileID.canonical,V,H,this.transform,m.getProjection(),ee);K=o.az([],this.transform.labelPlaneMatrix,Pe)}let ie=null;Y&&c.latestFeatureIndex&&(ie={unwrappedTileID:M,dynamicFilter:Y,dynamicFilterNeedsFeature:te}),this.retainedQueryData[m.bucketInstanceId]=new pa(m.bucketInstanceId,y,m.sourceLayerIndex,m.index,c.tileID);const[se,ye]=m.layers[0].layout.get("text-size-scale-range"),ve=o.ay(f,se,ye),[Oe,ke]=v.get("icon-size-scale-range"),Ze=o.ay(f,Oe,ke),_e={bucket:m,layout:v,paint:T,posMatrix:D,textLabelPlaneMatrix:J,labelToScreenMatrix:K,clippingData:ie,scale:C,textPixelRatio:I,holdingForFade:c.holdingForFade(),collisionBoxArray:S,partiallyEvaluatedTextSize:o.bH(m.textSizeData,this.transform.zoom,ve),partiallyEvaluatedIconSize:o.bH(m.iconSizeData,this.transform.zoom,Ze),collisionGroup:this.collisionGroups.get(m.sourceID),latestFeatureIndex:c.latestFeatureIndex};if(d)for(const Pe of m.sortKeyRanges){const{sortKey:ue,symbolInstanceStart:Ne,symbolInstanceEnd:Se}=Pe;t.push({sortKey:ue,symbolInstanceStart:Ne,symbolInstanceEnd:Se,parameters:_e})}else t.push({symbolInstanceStart:0,symbolInstanceEnd:m.symbolInstances.length,parameters:_e})}attemptAnchorPlacement(t,n,c,d,f,m,y,v,T,S,C,I,M,D,z,O,B,V){const{textOffset0:H,textOffset1:Y,crossTileID:te}=I,ee=[H,Y],J=Ni(t,c,d,ee,f),K=this.collisionIndex.placeCollisionBox(D,f,n,Ci(J.x,J.y,m,y,this.transform.angle),C,v,T,S.predicate);if(O){const ie=D.getSymbolInstanceIconSize(V,this.transform.zoom,I.placedIconSymbolIndex);if(this.collisionIndex.placeCollisionBox(D,ie,O,Ci(J.x,J.y,m,y,this.transform.angle),C,v,T,S.predicate).box.length===0)return}if(K.box.length>0){let ie;return this.prevPlacement&&this.prevPlacement.variableOffsets[te]&&this.prevPlacement.placements[te]&&this.prevPlacement.placements[te].text&&(ie=this.prevPlacement.variableOffsets[te].anchor),this.variableOffsets[te]={textOffset:ee,width:c,height:d,anchor:t,textScale:f,prevAnchor:ie},this.markUsedJustification(D,t,I,z),D.allowVerticalPlacement&&(this.markUsedOrientation(D,z,I),this.placedOrientations[te]=z),{shift:J,placedGlyphBoxes:K}}}placeLayerBucketPart(t,n,c,d,f=1){const{bucket:m,layout:y,paint:v,posMatrix:T,textLabelPlaneMatrix:S,labelToScreenMatrix:C,clippingData:I,textPixelRatio:M,holdingForFade:D,collisionBoxArray:z,partiallyEvaluatedTextSize:O,partiallyEvaluatedIconSize:B,collisionGroup:V,latestFeatureIndex:H}=t.parameters,Y=y.get("text-optional"),te=y.get("icon-optional"),ee=y.get("text-allow-overlap"),J=y.get("icon-allow-overlap"),K=y.get("text-rotation-alignment")==="map",ie=y.get("text-pitch-alignment")==="map",se=v.get("symbol-z-offset"),ye=y.get("symbol-elevation-reference")==="sea",[ve,Oe]=y.get("text-size-scale-range"),[ke,Ze]=y.get("icon-size-scale-range"),_e=o.ay(f,ve,Oe),Pe=o.ay(f,ke,Ze);this.transform.setProjection(m.projection);let ue=ee&&(J||!m.hasIconData()||te),Ne=J&&(ee||!m.hasTextData()||Y);const Se=!se.isConstant();!m.collisionArrays&&z&&m.deserializeCollisionBoxes(z),c&&d&&m.updateCollisionDebugBuffers(this.transform.zoom,z,_e,Pe);const qe=(Fe,tt,wt)=>{const{crossTileID:Tt,numVerticalGlyphVertices:gt}=Fe;let Rt=null;if(I&&I.dynamicFilterNeedsFeature||Se){const Wi=this.retainedQueryData[m.bucketInstanceId];Rt=H.loadFeature({featureIndex:Fe.featureIndex,bucketIndex:Wi.bucketIndex,sourceLayerIndex:Wi.sourceLayerIndex,layoutVertexArrayOffset:0})}if(I&&!(0,I.dynamicFilter)({zoom:this.transform.zoom,pitch:this.transform.pitch},Rt,this.retainedQueryData[m.bucketInstanceId].tileID.canonical,new o.P(Fe.tileAnchorX,Fe.tileAnchorY),this.transform.calculateDistanceTileData(I.unwrappedTileID)))return this.placements[Tt]=new Gn(!1,!1,!1,!0),void n.add(Tt);const Dt=se.evaluate(Rt,{});if(n.has(Tt))return;if(D)return void(this.placements[Tt]=new Gn(!1,!1,!1));let kt=!1,$t=!1,ti=!0,zi=!1,Ji=!1,Fi=null,Vi={box:null,offscreen:null,occluded:null},Mr={box:null},Kt=null,ni=null,ui=null,nr=0,Vr=0,Qi=0;wt.textFeatureIndex?nr=wt.textFeatureIndex:Fe.useRuntimeCollisionCircles&&(nr=Fe.featureIndex),wt.verticalTextFeatureIndex&&(Vr=wt.verticalTextFeatureIndex);const Ai=Wi=>{Wi.tileID=this.retainedQueryData[m.bucketInstanceId].tileID;const or=this.transform.elevation;Wi.elevation=ye?Dt:Dt+(or?or.getAtTileOffset(Wi.tileID,Wi.tileAnchorX,Wi.tileAnchorY):0),Wi.elevation+=Fe.zOffset},wr=wt.textBox;if(wr){Ai(wr);const Wi=Mi=>{let Sr=o.bI.horizontal;if(m.allowVerticalPlacement&&!Mi&&this.prevPlacement){const tn=this.prevPlacement.placedOrientations[Tt];tn&&(this.placedOrientations[Tt]=tn,Sr=tn,this.markUsedOrientation(m,Sr,Fe))}return Sr},or=(Mi,Sr)=>{if(m.allowVerticalPlacement&&gt>0&&wt.verticalTextBox){for(const tn of m.writingModes)if(tn===o.bI.vertical?(Vi=Sr(),Mr=Vi):Vi=Mi(),Vi&&Vi.box&&Vi.box.length)break}else Vi=Mi()};if(y.get("text-variable-anchor")){let Mi=y.get("text-variable-anchor");if(this.prevPlacement&&this.prevPlacement.variableOffsets[Tt]){const dr=this.prevPlacement.variableOffsets[Tt];Mi.indexOf(dr.anchor)>0&&(Mi=Mi.filter(Ti=>Ti!==dr.anchor),Mi.unshift(dr.anchor))}const Sr=(dr,Ti,kn)=>{const An=m.getSymbolInstanceTextSize(O,Fe,this.transform.zoom,tt),Hn=(dr.x2-dr.x1)*An+2*dr.padding,us=(dr.y2-dr.y1)*An+2*dr.padding,ts=Fe.hasIconTextFit&&!J?Ti:null;ts&&Ai(ts);let Cn={box:[],offscreen:!1,occluded:!1};const vo=ee?2*Mi.length:Mi.length;for(let hs=0;hs<vo;++hs){const xo=this.attemptAnchorPlacement(Mi[hs%Mi.length],dr,Hn,us,An,K,ie,M,T,V,hs>=Mi.length,Fe,tt,m,kn,ts,O,B);if(xo&&(Cn=xo.placedGlyphBoxes,Cn&&Cn.box&&Cn.box.length)){kt=!0,Fi=xo.shift;break}}return Cn};or(()=>Sr(wr,wt.iconBox,o.bI.horizontal),()=>{const dr=wt.verticalTextBox;return dr&&Ai(dr),m.allowVerticalPlacement&&!(Vi&&Vi.box&&Vi.box.length)&&gt>0&&dr?Sr(dr,wt.verticalIconBox,o.bI.vertical):{box:null,offscreen:null,occluded:null}}),Vi&&(kt=Vi.box,ti=Vi.offscreen,zi=Vi.occluded);const tn=Wi(!(!Vi||!Vi.box));if(!kt&&this.prevPlacement){const dr=this.prevPlacement.variableOffsets[Tt];dr&&(this.variableOffsets[Tt]=dr,this.markUsedJustification(m,dr.anchor,Fe,tn))}}else{const Mi=(Sr,tn)=>{const dr=m.getSymbolInstanceTextSize(O,Fe,this.transform.zoom,tt,f),Ti=this.collisionIndex.placeCollisionBox(m,dr,Sr,new o.P(0,0),ee,M,T,V.predicate);return Ti&&Ti.box&&Ti.box.length&&(this.markUsedOrientation(m,tn,Fe),this.placedOrientations[Tt]=tn),Ti};or(()=>Mi(wr,o.bI.horizontal),()=>{const Sr=wt.verticalTextBox;return m.allowVerticalPlacement&&gt>0&&Sr?(Ai(Sr),Mi(Sr,o.bI.vertical)):{box:null,offscreen:null,occluded:null}}),Wi(!!(Vi&&Vi.box&&Vi.box.length))}}if(Kt=Vi,kt=Kt&&Kt.box&&Kt.box.length>0,ti=Kt&&Kt.offscreen,zi=Kt&&Kt.occluded,Fe.useRuntimeCollisionCircles){const Wi=m.text.placedSymbolArray.get(Fe.centerJustifiedTextSymbolIndex>=0?Fe.centerJustifiedTextSymbolIndex:Fe.verticalPlacedTextSymbolIndex),or=o.bJ(m.textSizeData,O,Wi),Mi=y.get("text-padding");ni=this.collisionIndex.placeCollisionCircles(m,ee,Wi,m.lineVertexArray,m.glyphOffsetArray,or,T,S,C,c,ie,V.predicate,Fe.collisionCircleDiameter*or/o.bO,Mi,this.retainedQueryData[m.bucketInstanceId].tileID),kt=ee||ni.circles.length>0&&!ni.collisionDetected,ti=ti&&ni.offscreen,zi=ni.occluded}if(wt.iconFeatureIndex&&(Qi=wt.iconFeatureIndex),wt.iconBox){const Wi=or=>{Ai(or);const Mi=Fe.hasIconTextFit&&Fi?Ci(Fi.x,Fi.y,K,ie,this.transform.angle):new o.P(0,0),Sr=m.getSymbolInstanceIconSize(B,this.transform.zoom,Fe.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(m,Sr,or,Mi,J,M,T,V.predicate)};Mr&&Mr.box&&Mr.box.length&&wt.verticalIconBox?(ui=Wi(wt.verticalIconBox),$t=ui.box.length>0):(ui=Wi(wt.iconBox),$t=ui.box.length>0),ti=ti&&ui.offscreen,Ji=ui.occluded}const mi=Y||Fe.numHorizontalGlyphVertices===0&&gt===0,Fr=te||Fe.numIconVertices===0;if(mi||Fr?Fr?mi||($t=$t&&kt):kt=$t&&kt:$t=kt=$t&&kt,kt&&Kt&&Kt.box&&this.collisionIndex.insertCollisionBox(Kt.box,y.get("text-ignore-placement"),m.bucketInstanceId,Mr&&Mr.box&&Vr?Vr:nr,V.ID),$t&&ui&&this.collisionIndex.insertCollisionBox(ui.box,y.get("icon-ignore-placement"),m.bucketInstanceId,Qi,V.ID),ni&&(kt&&this.collisionIndex.insertCollisionCircles(ni.circles,y.get("text-ignore-placement"),m.bucketInstanceId,nr,V.ID),c)){const Wi=m.bucketInstanceId;let or=this.collisionCircleArrays[Wi];or===void 0&&(or=this.collisionCircleArrays[Wi]=new $u);for(let Mi=0;Mi<ni.circles.length;Mi+=4)or.circles.push(ni.circles[Mi+0]),or.circles.push(ni.circles[Mi+1]),or.circles.push(ni.circles[Mi+2]),or.circles.push(ni.collisionDetected?1:0)}const sr=m.projection.name!=="globe";ue=ue&&(sr||!zi),Ne=Ne&&(sr||!Ji),this.placements[Tt]=new Gn(kt||ue,$t||Ne,ti||m.justReloaded),n.add(Tt)},rt=this.retainedQueryData[m.bucketInstanceId].tileID;if(m.elevationType==="offset"&&this.buildingIndex&&this.buildingIndex.updateZOffset(m,rt),m.elevationType==="road"&&m.updateRoadElevation(rt.canonical),m.updateZOffset(),m.sortFeaturesByY){const Fe=m.getSortedSymbolIndexes(this.transform.angle);for(let tt=Fe.length-1;tt>=0;--tt){const wt=Fe[tt];qe(m.symbolInstances.get(wt),wt,m.collisionArrays[wt])}m.hasAnyZOffset&&o.w(`${m.layerIds[0]} layer symbol-z-elevate: symbols are not sorted by elevation if symbol-z-order is evaluated to viewport-y`)}else if(m.hasAnyZOffset){const Fe=m.getSortedIndexesByZOffset();for(let tt=0;tt<Fe.length;++tt){const wt=Fe[tt];qe(m.symbolInstances.get(wt),wt,m.collisionArrays[wt])}}else for(let Fe=t.symbolInstanceStart;Fe<t.symbolInstanceEnd;Fe++)qe(m.symbolInstances.get(Fe),Fe,m.collisionArrays[Fe]);if(c&&m.bucketInstanceId in this.collisionCircleArrays){const Fe=this.collisionCircleArrays[m.bucketInstanceId];o.bi(Fe.invProjMatrix,T),Fe.viewportMatrix=this.collisionIndex.getViewportMatrix()}m.justReloaded=!1}markUsedJustification(t,n,c,d){const{leftJustifiedTextSymbolIndex:f,centerJustifiedTextSymbolIndex:m,rightJustifiedTextSymbolIndex:y,verticalPlacedTextSymbolIndex:v,crossTileID:T}=c,S=o.bV(n),C=d===o.bI.vertical?v:S==="left"?f:S==="center"?m:S==="right"?y:-1;f>=0&&(t.text.placedSymbolArray.get(f).crossTileID=C>=0&&f!==C?0:T),m>=0&&(t.text.placedSymbolArray.get(m).crossTileID=C>=0&&m!==C?0:T),y>=0&&(t.text.placedSymbolArray.get(y).crossTileID=C>=0&&y!==C?0:T),v>=0&&(t.text.placedSymbolArray.get(v).crossTileID=C>=0&&v!==C?0:T)}markUsedOrientation(t,n,c){const d=n===o.bI.horizontal||n===o.bI.horizontalOnly?n:0,f=n===o.bI.vertical?n:0,{leftJustifiedTextSymbolIndex:m,centerJustifiedTextSymbolIndex:y,rightJustifiedTextSymbolIndex:v,verticalPlacedTextSymbolIndex:T}=c,S=t.text.placedSymbolArray;m>=0&&(S.get(m).placedOrientation=d),y>=0&&(S.get(y).placedOrientation=d),v>=0&&(S.get(v).placedOrientation=d),T>=0&&(S.get(T).placedOrientation=f)}commit(t){this.commitTime=t,this.zoomAtLastRecencyCheck=this.transform.zoom;const n=this.prevPlacement;let c=!1;this.prevZoomAdjustment=n?n.zoomAdjustment(this.transform.zoom):0;const d=n?n.symbolFadeChange(t):1,f=n?n.opacities:{},m=n?n.variableOffsets:{},y=n?n.placedOrientations:{};for(const v in this.placements){const T=this.placements[v],S=f[v];S?(this.opacities[v]=new Vo(S,d,T.text,T.icon,null,T.clipped),c=c||T.text!==S.text.placed||T.icon!==S.icon.placed):(this.opacities[v]=new Vo(null,d,T.text,T.icon,T.skipFade,T.clipped),c=c||T.text||T.icon)}for(const v in f){const T=f[v];if(!this.opacities[v]){const S=new Vo(T,d,!1,!1);S.isHidden()||(this.opacities[v]=S,c=c||T.text.placed||T.icon.placed)}}for(const v in m)this.variableOffsets[v]||!this.opacities[v]||this.opacities[v].isHidden()||(this.variableOffsets[v]=m[v]);for(const v in y)this.placedOrientations[v]||!this.opacities[v]||this.opacities[v].isHidden()||(this.placedOrientations[v]=y[v]);c?this.lastPlacementChangeTime=t:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=n?n.lastPlacementChangeTime:t)}updateLayerOpacities(t,n,c,d){const f=new Set;for(const m of n){const y=m.getBucket(t);y&&m.latestFeatureIndex&&t.fqid===y.layerIds[0]&&(this.updateBucketOpacities(y,f,m,m.collisionBoxArray,c,d,m.tileID,t.scope),y.elevationType==="offset"&&this.buildingIndex&&this.buildingIndex.updateZOffset(y,m.tileID),y.elevationType==="road"&&y.updateRoadElevation(m.tileID.canonical),y.updateZOffset())}}updateBucketOpacities(t,n,c,d,f,m,y,v){t.hasTextData()&&t.text.opacityVertexArray.clear(),t.hasIconData()&&t.icon.opacityVertexArray.clear(),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexArray.clear(),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexArray.clear();const T=t.layers[0].layout,S=t.layers[0].paint,C=!!t.layers[0].dynamicFilter(),I=new Vo(null,0,!1,!1,!0),M=T.get("text-allow-overlap"),D=T.get("icon-allow-overlap"),z=T.get("text-variable-anchor"),O=T.get("text-rotation-alignment")==="map",B=T.get("text-pitch-alignment")==="map",V=S.get("symbol-z-offset"),H=T.get("symbol-elevation-reference")==="sea",Y=!V.isConstant(),te=new Vo(null,0,M&&(D||!t.hasIconData()||T.get("icon-optional")),D&&(M||!t.hasTextData()||T.get("text-optional")),!0);!t.collisionArrays&&d&&(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData())&&t.deserializeCollisionBoxes(d);const ee=(K,ie,se)=>{for(let ye=0;ye<ie/4;ye++)K.opacityVertexArray.emplaceBack(se)};let J=0;m&&t.updateReplacement(y,m);for(let K=0;K<t.symbolInstances.length;K++){const ie=t.symbolInstances.get(K),{numHorizontalGlyphVertices:se,numVerticalGlyphVertices:ye,crossTileID:ve,numIconVertices:Oe,tileAnchorX:ke,tileAnchorY:Ze}=ie;let _e=null;const Pe=this.retainedQueryData[t.bucketInstanceId];Y&&ie&&Pe&&(_e=c.latestFeatureIndex.loadFeature({featureIndex:ie.featureIndex,bucketIndex:Pe.bucketIndex,sourceLayerIndex:Pe.sourceLayerIndex,layoutVertexArrayOffset:0}));const ue=V.evaluate(_e,{}),Ne=n.has(ve);let Se=this.opacities[ve];Ne?Se=I:Se||(Se=te,this.opacities[ve]=Se),n.add(ve);const qe=se>0||ye>0,rt=Oe>0,Fe=this.placedOrientations[ve],tt=Fe===o.bI.vertical,wt=Fe===o.bI.horizontal||Fe===o.bI.horizontalOnly;!qe&&!rt||Se.isHidden()||J++;let Tt=!1;if((qe||rt)&&m)for(const gt of t.activeReplacements){if(o.bP(gt,f,o.bQ.Symbol,v)||gt.min.x>ke||ke>gt.max.x||gt.min.y>Ze||Ze>gt.max.y)continue;const Rt=o.bR(ke,Ze,y.canonical,gt.footprintTileId.canonical);if(Tt=o.bS(Rt,gt.footprint),Tt)break}if(qe){const gt=Tt?ro:ma(Se.text);ee(t.text,se,tt?ro:gt),ee(t.text,ye,wt?ro:gt);const Rt=Se.text.isHidden(),{leftJustifiedTextSymbolIndex:Dt,centerJustifiedTextSymbolIndex:kt,rightJustifiedTextSymbolIndex:$t,verticalPlacedTextSymbolIndex:ti}=ie,zi=t.text.placedSymbolArray,Ji=Rt||tt?1:0;Dt>=0&&(zi.get(Dt).hidden=Ji),kt>=0&&(zi.get(kt).hidden=Ji),$t>=0&&(zi.get($t).hidden=Ji),ti>=0&&(zi.get(ti).hidden=Rt||wt?1:0);const Fi=this.variableOffsets[ve];Fi&&this.markUsedJustification(t,Fi.anchor,ie,Fe);const Vi=this.placedOrientations[ve];Vi&&(this.markUsedJustification(t,"left",ie,Vi),this.markUsedOrientation(t,Vi,ie))}if(rt){const gt=Tt?ro:ma(Se.icon),{placedIconSymbolIndex:Rt,verticalPlacedIconSymbolIndex:Dt}=ie,kt=t.icon.placedSymbolArray,$t=Se.icon.isHidden()?1:0;Rt>=0&&(ee(t.icon,Oe,tt?ro:gt),kt.get(Rt).hidden=$t),Dt>=0&&(ee(t.icon,ie.numVerticalIconVertices,wt?ro:gt),kt.get(Dt).hidden=$t)}if(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData()){const gt=t.collisionArrays[K];if(gt){let Rt=new o.P(0,0),Dt=!0;if(gt.textBox||gt.verticalTextBox){if(z){const $t=this.variableOffsets[ve];$t?(Rt=Ni($t.anchor,$t.width,$t.height,$t.textOffset,$t.textScale),O&&Rt._rotate(B?this.transform.angle:-this.transform.angle)):Dt=!1}C&&(Dt=!Se.clipped),gt.textBox&&Rs(t.textCollisionBox.collisionVertexArray,Se.text.placed,!Dt||tt,ue,H,Rt.x,Rt.y),gt.verticalTextBox&&Rs(t.textCollisionBox.collisionVertexArray,Se.text.placed,!Dt||wt,ue,H,Rt.x,Rt.y)}const kt=Dt&&!!(!wt&&gt.verticalIconBox);gt.iconBox&&Rs(t.iconCollisionBox.collisionVertexArray,Se.icon.placed,kt,ue,H,ie.hasIconTextFit?Rt.x:0,ie.hasIconTextFit?Rt.y:0),gt.verticalIconBox&&Rs(t.iconCollisionBox.collisionVertexArray,Se.icon.placed,!kt,ue,H,ie.hasIconTextFit?Rt.x:0,ie.hasIconTextFit?Rt.y:0)}}}if(t.fullyClipped=J===0,t.sortFeatures(this.transform.angle),this.retainedQueryData[t.bucketInstanceId]&&(this.retainedQueryData[t.bucketInstanceId].featureSortOrder=t.featureSortOrder),t.hasTextData()&&t.text.opacityVertexBuffer&&t.text.opacityVertexBuffer.updateData(t.text.opacityVertexArray),t.hasIconData()&&t.icon.opacityVertexBuffer&&t.icon.opacityVertexBuffer.updateData(t.icon.opacityVertexArray),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexBuffer&&t.iconCollisionBox.collisionVertexBuffer.updateData(t.iconCollisionBox.collisionVertexArray),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexBuffer&&t.textCollisionBox.collisionVertexBuffer.updateData(t.textCollisionBox.collisionVertexArray),t.bucketInstanceId in this.collisionCircleArrays){const K=this.collisionCircleArrays[t.bucketInstanceId];t.placementInvProjMatrix=K.invProjMatrix,t.placementViewportMatrix=K.viewportMatrix,t.collisionCircleArray=K.circles,delete this.collisionCircleArrays[t.bucketInstanceId]}}symbolFadeChange(t){return this.fadeDuration===0?1:(t-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(t){return Math.max(0,(this.transform.zoom-t)/1.5)}hasTransitions(t){return this.stale||t-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(t,n){const c=this.zoomAtLastRecencyCheck===n?1-this.zoomAdjustment(n):1;return this.zoomAtLastRecencyCheck=n,this.commitTime+this.fadeDuration*c>t}setStale(){this.stale=!0}}function Rs(l,t,n,c,d,f,m){l.emplaceBack(t?1:0,n?1:0,f||0,m||0,c,d?1:0),l.emplaceBack(t?1:0,n?1:0,f||0,m||0,c,d?1:0),l.emplaceBack(t?1:0,n?1:0,f||0,m||0,c,d?1:0),l.emplaceBack(t?1:0,n?1:0,f||0,m||0,c,d?1:0)}const Ri=Math.pow(2,25),Tc=Math.pow(2,24),yl=Math.pow(2,17),vl=Math.pow(2,16),yn=Math.pow(2,9),jr=Math.pow(2,8),Op=Math.pow(2,1);function ma(l){if(l.opacity===0&&!l.placed)return 0;if(l.opacity===1&&l.placed)return 4294967295;const t=l.placed?1:0,n=Math.floor(127*l.opacity);return n*Ri+t*Tc+n*yl+t*vl+n*yn+t*jr+n*Op+t}const ro=0;class xl{constructor(t){this._sortAcrossTiles=t.layout.get("symbol-z-order")!=="viewport-y"&&t.layout.get("symbol-sort-key").constantOr(1)!==void 0,this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs=new Set,this._bucketParts=[]}continuePlacement(t,n,c,d,f,m){const y=this._bucketParts;for(;this._currentTileIndex<t.length;)if(n.getBucketParts(y,d,t[this._currentTileIndex],this._sortAcrossTiles,m),this._currentTileIndex++,f())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,y.sort((v,T)=>v.sortKey-T.sortKey));this._currentPartIndex<y.length;){const v=y[this._currentPartIndex];if(n.placeLayerBucketPart(v,this._seenCrossTileIDs,c,v.symbolInstanceStart===0,m),this._currentPartIndex++,f())return!0}return!1}}class Sc{constructor(t,n,c,d,f,m,y,v,T){this.placement=new Dn(t,f,m,y,v,T),this._currentPlacementIndex=n.length-1,this._forceFullPlacement=c,this._showCollisionBoxes=d,this._done=!1}isDone(){return this._done}continuePlacement(t,n,c,d,f){const m=o.q.now(),y=()=>{const v=o.q.now()-m;return!this._forceFullPlacement&&v>2};for(;this._currentPlacementIndex>=0;){const v=n[t[this._currentPlacementIndex]],T=this.placement.collisionIndex.transform.zoom;if(v.type==="symbol"&&(!v.minzoom||v.minzoom<=T)&&(!v.maxzoom||v.maxzoom>T)){const S=v,C=S.layout.get("symbol-z-elevate"),I=S.layout.get("symbol-sort-key").constantOr(1)!==void 0,M=S.layout.get("symbol-z-order"),D=M==="viewport-y"||M==="auto"&&!(M!=="viewport-y"&&I),z=S.layout.get("text-allow-overlap")||S.layout.get("icon-allow-overlap")||S.layout.get("text-ignore-placement")||S.layout.get("icon-ignore-placement"),O=D&&z,B=this._inProgressLayer=this._inProgressLayer||new xl(S),V=o.C(v.source,v.scope);if(B.continuePlacement(C||O?d[V]:c[V],this.placement,this._showCollisionBoxes,v,y,f))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(t){return this.placement.commit(t),this.placement}}const bl=512/o.aj/2;class Ec{constructor(t,n,c){this.tileID=t,this.bucketInstanceId=c,this.index=new o.bW(n.length,16,Int32Array),this.keys=[],this.crossTileIDs=[];const d=t.canonical.x*o.aj,f=t.canonical.y*o.aj;for(let m=0;m<n.length;m++){const{key:y,crossTileID:v,tileAnchorX:T,tileAnchorY:S}=n.get(m),C=Math.floor((d+T)*bl),I=Math.floor((f+S)*bl);this.index.add(C,I),this.keys.push(y),this.crossTileIDs.push(v)}this.index.finish()}findMatches(t,n,c){const d=this.tileID.canonical.z<n.canonical.z?1:Math.pow(2,this.tileID.canonical.z-n.canonical.z),f=bl/Math.pow(2,n.canonical.z-this.tileID.canonical.z),m=n.canonical.x*o.aj,y=n.canonical.y*o.aj;for(let v=0;v<t.length;v++){const T=t.get(v);if(T.crossTileID)continue;const{key:S,tileAnchorX:C,tileAnchorY:I}=T,M=Math.floor((m+C)*f),D=Math.floor((y+I)*f),z=this.index.range(M-d,D-d,M+d,D+d).sort((O,B)=>O-B);for(const O of z){const B=this.crossTileIDs[O];if(this.keys[O]===S&&!c.has(B)){c.add(B),T.crossTileID=B;break}}}}}class vn{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class zs{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(t){const n=Math.round((t-this.lng)/360);if(n!==0)for(const c in this.indexes){const d=this.indexes[c],f={};for(const m in d){const y=d[m];y.tileID=y.tileID.unwrapTo(y.tileID.wrap+n),f[y.tileID.key]=y}this.indexes[c]=f}this.lng=t}addBucket(t,n,c){if(this.indexes[t.overscaledZ]&&this.indexes[t.overscaledZ][t.key]){if(this.indexes[t.overscaledZ][t.key].bucketInstanceId===n.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(t.overscaledZ,this.indexes[t.overscaledZ][t.key])}for(let f=0;f<n.symbolInstances.length;f++)n.symbolInstances.get(f).crossTileID=0;this.usedCrossTileIDs[t.overscaledZ]||(this.usedCrossTileIDs[t.overscaledZ]=new Set);const d=this.usedCrossTileIDs[t.overscaledZ];for(const f in this.indexes){const m=this.indexes[f];if(Number(f)>t.overscaledZ)for(const y in m){const v=m[y];v.tileID.isChildOf(t)&&v.findMatches(n.symbolInstances,t,d)}else{const y=m[t.scaledTo(Number(f)).key];y&&y.findMatches(n.symbolInstances,t,d)}}for(let f=0;f<n.symbolInstances.length;f++){const m=n.symbolInstances.get(f);m.crossTileID||(m.crossTileID=c.generate(),d.add(m.crossTileID))}return this.indexes[t.overscaledZ]===void 0&&(this.indexes[t.overscaledZ]={}),this.indexes[t.overscaledZ][t.key]=new Ec(t,n.symbolInstances,n.bucketInstanceId),!0}removeBucketCrossTileIDs(t,n){for(const c of n.crossTileIDs)this.usedCrossTileIDs[t].delete(c)}removeStaleBuckets(t){let n=!1;for(const c in this.indexes){const d=this.indexes[c];for(const f in d)t[d[f].bucketInstanceId]||(this.removeBucketCrossTileIDs(c,d[f]),delete d[f],n=!0)}return n}}class In{constructor(){this.layerIndexes={},this.crossTileIDs=new vn,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(t,n,c,d){let f=this.layerIndexes[t.fqid];f===void 0&&(f=this.layerIndexes[t.fqid]=new zs);let m=!1;const y={};d.name!=="globe"&&f.handleWrapJump(c);for(const v of n){const T=v.getBucket(t);T&&t.fqid===T.layerIds[0]&&(T.bucketInstanceId||(T.bucketInstanceId=++this.maxBucketInstanceId),f.addBucket(v.tileID,T,this.crossTileIDs)&&(m=!0),y[T.bucketInstanceId]=!0)}return f.removeStaleBuckets(y)&&(m=!0),m}pruneUnusedLayers(t){const n={};t.forEach(c=>{n[c]=!0});for(const c in this.layerIndexes)n[c]||delete this.layerIndexes[c]}}const Uo=771;class oi{constructor(t,n,c,d){this.blendFunction=t,this.blendColor=n.toNonPremultipliedRenderColor(null),this.mask=c,this.blendEquation=d}}oi.Replace=[1,0,1,0],oi.disabled=new oi(oi.Replace,o.am.transparent,[!1,!1,!1,!1]),oi.unblended=new oi(oi.Replace,o.am.transparent,[!0,!0,!0,!0]),oi.alphaBlended=new oi([1,Uo,1,Uo],o.am.transparent,[!0,!0,!0,!0]),oi.alphaBlendedNonPremultiplied=new oi([770,Uo,770,Uo],o.am.transparent,[!0,!0,!0,!0]),oi.multiply=new oi([774,0,774,0],o.am.transparent,[!0,!0,!0,!0]);class xt{constructor(t,n,c){this.func=t,this.mask=n,this.range=c}}xt.ReadOnly=!1,xt.ReadWrite=!0,xt.disabled=new xt(519,xt.ReadOnly,[0,1]);const Yn=7680;class Zt{constructor(t,n,c,d,f,m){this.test=t,this.ref=n,this.mask=c,this.fail=d,this.depthFail=f,this.pass=m}}Zt.disabled=new Zt({func:519,mask:0},0,0,Yn,Yn,Yn);const Nr=1029,wl=2305;class Nt{constructor(t,n,c){this.enable=t,this.mode=n,this.frontFace=c}}function _a(l,t){const n=o.c1(l,3);o.c3(l,t),o.c7(l,3,n)}function ga(l,t){const n=o.b_([]);return o.b$(n,n,-t),o.c0(n,n,-l),n}function no(l,t){const n=[l[0],l[1],0],c=[t[0],t[1],0];if(o.ae(n)>=1e-15){const m=o.au([],n);o.bY(c,m,o.bG(c,m)),t[0]=c[0],t[1]=c[1]}const d=o.bF([],t,l);if(o.bZ(d)<1e-15)return null;const f=Math.atan2(-d[1],d[0]);return ga(Math.atan2(Math.sqrt(l[0]*l[0]+l[1]*l[1]),-l[2]),f)}Nt.disabled=new Nt(!1,Nr,wl),Nt.backCCW=new Nt(!0,Nr,wl),Nt.backCW=new Nt(!0,Nr,2304),Nt.frontCW=new Nt(!0,1028,2304),Nt.frontCCW=new Nt(!0,1028,wl);class Rd{constructor(t,n){this.position=t,this.orientation=n}get position(){return this._position}set position(t){if(t){const n=t instanceof o.ac?t:new o.ac(t[0],t[1],t[2]);this._renderWorldCopies&&(n.x=o.bX(n.x,0,1)),this._position=n}else this._position=null}lookAtPoint(t,n){if(this.orientation=null,!this.position)return;const c=this.position,d=this._elevation?this._elevation.getAtPointOrZero(o.ac.fromLngLat(t)):0,f=o.ac.fromLngLat(t,d),m=[f.x-c.x,f.y-c.y,f.z-c.z];n||(n=[0,0,1]),n[2]=Math.abs(n[2]),this.orientation=no(m,n)}setPitchBearing(t,n){this.orientation=ga(o.al(t),o.al(-n))}}class Kn{constructor(t,n){this._transform=o.bx([]),this.orientation=n,this.position=t}get mercatorPosition(){const t=this.position;return new o.ac(t[0],t[1],t[2])}get position(){const t=o.c1(this._transform,3);return[t[0],t[1],t[2]]}set position(t){var n;t&&o.c7(this._transform,3,[(n=t)[0],n[1],n[2],1])}get orientation(){return this._orientation}set orientation(t){this._orientation=t||o.b_([]),t&&_a(this._transform,this._orientation)}getPitchBearing(){const t=this.forward(),n=this.right();return{bearing:Math.atan2(-n[1],n[0]),pitch:Math.atan2(Math.sqrt(t[0]*t[0]+t[1]*t[1]),-t[2])}}setPitchBearing(t,n){this._orientation=ga(t,n),_a(this._transform,this._orientation)}forward(){const t=o.c1(this._transform,2);return[-t[0],-t[1],-t[2]]}up(){const t=o.c1(this._transform,1);return[-t[0],-t[1],-t[2]]}right(){const t=o.c1(this._transform,0);return[t[0],t[1],t[2]]}getCameraToWorld(t,n){const c=new Float64Array(16);return o.bi(c,this.getWorldToCamera(t,n)),c}getCameraToWorldMercator(){return this._transform}getWorldToCameraPosition(t,n,c){const d=this.position;o.bY(d,d,-t);const f=new Float64Array(16);return o.bn(f,[c,c,c]),o.bo(f,f,d),f[10]*=n,f}getWorldToCamera(t,n){const c=new Float64Array(16),d=new Float64Array(4),f=this.position;return o.c2(d,this._orientation),o.bY(f,f,-t),o.c3(c,d),o.bo(c,c,f),c[1]*=-1,c[5]*=-1,c[9]*=-1,c[13]*=-1,c[8]*=n,c[9]*=n,c[10]*=n,c[11]*=n,c}getCameraToClipPerspective(t,n,c,d){const f=new Float64Array(16);return o.c4(f,t,n,c,d),f}getCameraToClipOrthographic(t,n,c,d,f,m){const y=new Float64Array(16);return o.c5(y,t,n,c,d,f,m),y}getDistanceToElevation(t,n=!1){const c=t===0?0:o.c6(t,n?o.aY(this.position[1]):this.position[1]),d=this.forward();return(c-this.position[2])/d[2]}clone(){return new Kn([...this.position],[...this.orientation])}}const xn={BaseColor:5,MetallicRoughness:6,Normal:7,Occlusion:8,Emission:9,LUT:10,ShadowMap0:11};class Tl{constructor(t=0,n=0,c=0,d=0){if(isNaN(t)||t<0||isNaN(n)||n<0||isNaN(c)||c<0||isNaN(d)||d<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=t,this.bottom=n,this.left=c,this.right=d}interpolate(t,n,c){return n.top!=null&&t.top!=null&&(this.top=o.ai(t.top,n.top,c)),n.bottom!=null&&t.bottom!=null&&(this.bottom=o.ai(t.bottom,n.bottom,c)),n.left!=null&&t.left!=null&&(this.left=o.ai(t.left,n.left,c)),n.right!=null&&t.right!=null&&(this.right=o.ai(t.right,n.right,c)),this}getCenter(t,n){const c=o.ay((this.left+t-this.right)/2,0,t),d=o.ay((this.top+n-this.bottom)/2,0,n);return new o.P(c,d)}equals(t){return this.top===t.top&&this.bottom===t.bottom&&this.left===t.left&&this.right===t.right}clone(){return new Tl(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}const Yr=15;class Hu{constructor(t,n,c,d,f,m,y){this.tileSize=512,this._renderWorldCopies=f===void 0||f,this._minZoom=t||0,this._maxZoom=n||22,this._minPitch=c??0,this._maxPitch=d??60,this.setProjection(m),this.setMaxBounds(y),this.width=0,this.height=0,this._center=new o.cd(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new Tl,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._expandedProjMatrixCache={},this._distanceTileDataCache={},this._camera=new Kn,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._tileCoverLift=0,this.freezeTileCoverage=!1,this._horizonShift=.1,this._orthographicProjectionAtLowPitch=!1,this._allowWorldUnderZoom=!1}clone(){const t=new Hu(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection(),this.maxBounds);return t._elevation=this._elevation,t._centerAltitude=this._centerAltitude,t._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,t.tileSize=this.tileSize,t.mercatorFromTransition=this.mercatorFromTransition,t.width=this.width,t.height=this.height,t.cameraElevationReference=this.cameraElevationReference,t._center=this._center,t._setZoom(this.zoom),t._seaLevelZoom=this._seaLevelZoom,t.angle=this.angle,t._fov=this._fov,t._pitch=this._pitch,t._nearZ=this._nearZ,t._farZ=this._farZ,t._averageElevation=this._averageElevation,t._orthographicProjectionAtLowPitch=this._orthographicProjectionAtLowPitch,t._unmodified=this._unmodified,t._edgeInsets=this._edgeInsets.clone(),t._camera=this._camera.clone(),t._calcMatrices(),t.freezeTileCoverage=this.freezeTileCoverage,t.frustumCorners=this.frustumCorners,t._allowWorldUnderZoom=this._allowWorldUnderZoom,t}get isOrthographic(){return this.projection.name!=="globe"&&this._orthographicProjectionAtLowPitch&&this.pitch<Yr}get elevation(){return this._elevation}set elevation(t){this._elevation!==t&&(this._elevation=t,this._updateCameraOnTerrain(),this._calcMatrices())}get depthOcclusionForSymbolsAndCircles(){return this.projection.name!=="globe"&&!this.isOrthographic}updateElevation(t,n=!1){const c=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(this._seaLevelZoom==null||c)&&this._updateCameraOnTerrain(),(t||c)&&this._constrainCamera(n),this._calcMatrices()}getProjection(){return o.aF(this.projection,["name","center","parallels"])}setProjection(t){this.projectionOptions=t||{name:"mercator"};const n=this.projection?this.getProjection():void 0;this.projection=o.ce(this.projectionOptions);const c=this.getProjection(),d=!o.bv(n,c);return d&&this._calcMatrices(),this.mercatorFromTransition=!1,d}setOrthographicProjectionAtLowPitch(t){return this._orthographicProjectionAtLowPitch!==t&&(this._orthographicProjectionAtLowPitch=t,this._calcMatrices(),!0)}setMercatorFromTransition(){const t=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=o.ce({name:"mercator"});const n=t!==this.projection.name;return n&&this._calcMatrices(),n}get minZoom(){return this._minZoom}set minZoom(t){this._minZoom!==t&&(this._minZoom=t,this.zoom=Math.max(this.zoom,t))}get maxZoom(){return this._maxZoom}set maxZoom(t){this._maxZoom!==t&&(this._maxZoom=t,this.zoom=Math.min(this.zoom,t))}get minPitch(){return this._minPitch}set minPitch(t){this._minPitch!==t&&(this._minPitch=t,this.pitch=Math.max(this.pitch,t))}get maxPitch(){return this._maxPitch}set maxPitch(t){this._maxPitch!==t&&(this._maxPitch=t,this.pitch=Math.min(this.pitch,t))}get renderWorldCopies(){return this._renderWorldCopies&&this.projection.supportsWorldCopies===!0}set renderWorldCopies(t){t===void 0?t=!0:t===null&&(t=!1),this._renderWorldCopies=t}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){const t=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(t))}get cameraWorldSize(){const t=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(t))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return o.c6(1,this.center.lat)*this.cameraWorldSizeForFog}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new o.P(this.width,this.height)}get bearing(){return o.bX(this.rotation,-180,180)}set bearing(t){this.rotation=t}get rotation(){return-this.angle/Math.PI*180}set rotation(t){const n=-t*Math.PI/180;this.angle!==n&&(this._unmodified=!1,this.angle=n,this._calcMatrices(),this.rotationMatrix=o.cf(),o.cg(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(t){const n=o.ay(t,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==n&&(this._unmodified=!1,this._pitch=n,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}set fov(t){t=Math.max(.01,Math.min(60,t)),this._fov!==t&&(this._unmodified=!1,this._fov=o.al(t),this._calcMatrices())}get fovX(){return this._fov}get fovY(){const t=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/t)}get averageElevation(){return this._averageElevation}set averageElevation(t){this._averageElevation=t,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(t){const n=Math.min(Math.max(t,this.minZoom),this.maxZoom);this._zoom!==n&&(this._unmodified=!1,this._setZoom(n),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(t){this._zoom=t,this.scale=this.zoomScale(t),this.tileZoom=Math.floor(t),this.zoomFraction=t-this.tileZoom}get tileCoverLift(){return this._tileCoverLift}set tileCoverLift(t){this._tileCoverLift!==t&&(this._tileCoverLift=t)}_updateCameraOnTerrain(){const t=this.elevation?this.elevation.getAtPoint(this.locationCoordinate(this.center),Number.NEGATIVE_INFINITY):Number.NEGATIVE_INFINITY,n=this.elevation&&t===Number.NEGATIVE_INFINITY&&this.elevation.visibleDemTiles.length>0&&this.elevation.exaggeration()>0&&this._centerAltitudeValidForExaggeration;if(!this._elevation||t===Number.NEGATIVE_INFINITY&&(!n||!this._centerAltitude))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);const c=this._elevation;n||this._centerAltitude&&this._centerAltitudeValidForExaggeration&&c.exaggeration()&&this._centerAltitudeValidForExaggeration!==c.exaggeration()?(this._centerAltitude=this._centerAltitude/this._centerAltitudeValidForExaggeration*c.exaggeration(),this._centerAltitudeValidForExaggeration=c.exaggeration()):(this._centerAltitude=t||0,this._centerAltitudeValidForExaggeration=c.exaggeration()),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){if(this._centerAltitudeValidForExaggeration===void 0)return;const t=Math.max(0,(this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize);this._seaLevelZoom=this._zoomFromMercatorZ(t)}sampleAverageElevation(){if(!this._elevation)return 0;const t=this._elevation,n=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],c=this.horizonLineFromTop();let d=0,f=0;for(let m=0;m<n.length;m++){const y=new o.P(n[m][0]*this.width,c+n[m][1]*(this.height-c)),v=t.pointCoordinate(y);if(!v)continue;const T=1/Math.hypot(v[0]-this._camera.position[0],v[1]-this._camera.position[1]);d+=v[3]*T,f+=T}return f===0?NaN:d/f}get center(){return this._center}set center(t){t.lat===this._center.lat&&t.lng===this._center.lng||(this._unmodified=!1,this._center=t,this._terrainEnabled()&&(this.cameraElevationReference==="ground"?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(this._seaLevelZoom==null||!this._elevation)return;const t=this._seaLevelZoom,n=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),c=this.pixelsPerMeter/this.worldSize*n,d=this._mercatorZfromZoom(t),f=this._mercatorZfromZoom(this._maxZoom),m=Math.max(d-c,f);this._setZoom(this._zoomFromMercatorZ(m))}get padding(){return this._edgeInsets.toJSON()}set padding(t){this._edgeInsets.equals(t)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,t,1),this._calcMatrices())}computeZoomRelativeTo(t){const n=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,t.toAltitude()));let c;c=t.z<this._camera.position[2]?[n.x,n.y,n.z]:[t.x,t.y,t.z];const d=o.ae(o.at([],this._camera.position,c));return o.ay(this._zoomFromMercatorZ(d),this._minZoom,this._maxZoom)}setFreeCameraOptions(t){if(!this.height||!t.position&&!t.orientation)return;this._updateCameraState();let n=!1;if(t.orientation&&!o.ch(t.orientation,this._camera.orientation)&&(n=this._setCameraOrientation(t.orientation)),t.position){const c=[t.position.x,t.position.y,t.position.z];o.ci(c,this._camera.position)||(this._setCameraPosition(c),n=!0)}n&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();const t=this._camera.position,n=new Rd;return n.position=new o.ac(t[0],t[1],t[2]),n.orientation=this._camera.orientation,n._elevation=this.elevation,n._renderWorldCopies=this.renderWorldCopies,n}_setCameraOrientation(t){if(!o.cj(t))return!1;o.ck(t,t);const n=o.cl([],[0,0,-1],t),c=o.cl([],[0,-1,0],t);if(c[2]<0)return!1;const d=no(n,c);return!!d&&(this._camera.orientation=d,!0)}_setCameraPosition(t){const n=this.zoomScale(this.minZoom)*this.tileSize,c=this.zoomScale(this.maxZoom)*this.tileSize,d=this.cameraToCenterDistance;t[2]=o.ay(t[2],d/c,d/n),this._camera.position=t}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(t){return this._edgeInsets.equals(t)}interpolatePadding(t,n,c){this._unmodified=!1,this._edgeInsets.interpolate(t,n,c),this._constrain(),this._calcMatrices()}coveringZoomLevel(t){const n=(t.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/t.tileSize));return Math.max(0,n)}getVisibleUnwrappedCoordinates(t){const n=[new o.cm(0,t)];if(this.renderWorldCopies){const c=this.pointCoordinate(new o.P(0,0)),d=this.pointCoordinate(new o.P(this.width,0)),f=this.pointCoordinate(new o.P(this.width,this.height)),m=this.pointCoordinate(new o.P(0,this.height)),y=Math.floor(Math.min(c.x,d.x,f.x,m.x)),v=Math.floor(Math.max(c.x,d.x,f.x,m.x)),T=1;for(let S=y-T;S<=v+T;S++)S!==0&&n.push(new o.cm(S,t))}return n}isLODDisabled(t){return(!t||this.pitch<=60)&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace}extendTileCover(t,n,c){let d=[];const f=c!=null,m=!f;if(m&&this.zoom<n||f&&c[0]===0&&c[1]===0)return d;const y=new Set,v=(S,C,I,M,D)=>{const z=o.cK(C,S,I,M,D);y.has(z)||(d.push(new o.aM(S,C,I,M,D)),y.add(z))};for(let S=0;S<t.length;S++){const C=t[S];if(m&&C.canonical.z!==n)continue;const I=C.canonical,M=C.overscaledZ,D=C.wrap,z=1<<I.z,O=I.x+1<z,B=I.x>0,V=I.y+1<z,H=I.y>0,Y=C.wrap-(B?0:1),te=C.wrap+(O?0:1),ee=B?I.x-1:z-1,J=O?I.x+1:0;if(f)c[0]<0?(v(M,te,I.z,J,I.y),c[1]<0&&V&&(v(M,D,I.z,I.x,I.y+1),v(M,te,I.z,J,I.y+1)),c[1]>0&&H&&(v(M,D,I.z,I.x,I.y-1),v(M,te,I.z,J,I.y-1))):c[0]>0?(v(M,Y,I.z,ee,I.y),c[1]<0&&V&&(v(M,D,I.z,I.x,I.y+1),v(M,Y,I.z,ee,I.y+1)),c[1]>0&&H&&(v(M,D,I.z,I.x,I.y-1),v(M,Y,I.z,ee,I.y-1))):c[1]<0&&V?v(M,D,I.z,I.x,I.y+1):H&&v(M,D,I.z,I.x,I.y-1);else{const K=C.visibleQuadrants;1&K&&(v(M,Y,I.z,ee,I.y),H&&(v(M,D,I.z,I.x,I.y-1),v(M,Y,I.z,ee,I.y-1))),2&K&&(v(M,te,I.z,J,I.y),H&&(v(M,D,I.z,I.x,I.y-1),v(M,te,I.z,J,I.y-1))),4&K&&(v(M,Y,I.z,ee,I.y),V&&(v(M,D,I.z,I.x,I.y+1),v(M,Y,I.z,ee,I.y+1))),8&K&&(v(M,te,I.z,J,I.y),V&&(v(M,D,I.z,I.x,I.y+1),v(M,te,I.z,J,I.y+1)))}}const T=[];for(const S of d)d.some(C=>S.isChildOf(C))||T.push(S);if(d=T.filter(S=>!t.some(C=>!!(S.overscaledZ<n&&C.isChildOf(S))||S.equals(C)||S.isChildOf(C))),m){const S=1<<n,C=this.projection.name==="globe"?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),I=[S*C.x,S*C.y],M=4,D=M*M;d=d.filter(z=>{const O=z.canonical.x+.5-I[0],B=z.canonical.y+.5-I[1];return O*O+B*B<D})}return d}coveringTiles(t){let n=this.coveringZoomLevel(t);const c=n,d=this.elevation&&this.elevation.exaggeration(),f=d&&!t.isTerrainDEM,m=this.projection.name==="mercator";if(t.minzoom!==void 0&&n<t.minzoom)return[];t.maxzoom!==void 0&&n>t.maxzoom&&(n=t.maxzoom);const y=this.locationCoordinate(this.center),v=this.center.lat,T=1<<n,S=[T*y.x,T*y.y,0],C=this.projection.name==="globe",I=!C,M=o.cn.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,n,I),D=C?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),z=T*o.c6(1,this.center.lat),O=this._camera.position[2]/o.c6(1,this.center.lat),B=[T*D.x,T*D.y,O*(I?1:z)],V=C||d,H=this.cameraToCenterDistance/t.tileSize*(t.roundZoom?1:.502),Y=this.isLODDisabled(!0)?n:0;let te;if(this._elevation&&t.isTerrainDEM)te=1e4*this._elevation.exaggeration();else if(this._elevation){const ue=this._elevation.getMinMaxForVisibleTiles();te=ue?ue.max:this._centerAltitude}else te=this._centerAltitude;const ee=t.isTerrainDEM?-te:this._elevation?this._elevation.getMinElevationBelowMSL():0,J=this.projection.isReprojectedInTileSpace?o.co(this):1,K=ue=>{const Se=new o.ac(ue.x+25e-6,ue.y,ue.z),qe=new o.ac(ue.x,ue.y+25e-6,ue.z),rt=ue.toLngLat(),Fe=Se.toLngLat(),tt=qe.toLngLat(),wt=this.locationCoordinate(rt),Tt=this.locationCoordinate(Fe),gt=this.locationCoordinate(tt),Rt=Math.hypot(Tt.x-wt.x,Tt.y-wt.y),Dt=Math.hypot(gt.x-wt.x,gt.y-wt.y);return Math.sqrt(Rt*Dt)*J/25e-6},ie=ue=>{const Ne=te,Se=ee;return{aabb:o.cr(this,T,0,0,0,ue,Se,Ne,this.projection),zoom:0,x:0,y:0,minZ:Se,maxZ:Ne,wrap:ue,fullyVisible:!1}},se=[];let ye=[];const ve=n,Oe=t.reparseOverscaled?c:n,ke=(O-this._centerAltitude)*z,Ze=ue=>{if(!this._elevation||!ue.tileID||!m)return;const Ne=this._elevation.getMinMaxForTile(ue.tileID),Se=ue.aabb;Ne?(Se.min[2]=Ne.min,Se.max[2]=Ne.max,Se.center[2]=(Se.min[2]+Se.max[2])/2):(ue.shouldSplit=Pe(ue),ue.shouldSplit||(Se.min[2]=Se.max[2]=Se.center[2]=this._centerAltitude))},_e=(ue,Ne)=>{if(.707*Ne<ue)return 1;const Se=Ne/ue;return Se/(1.4144271570014144+(Math.pow(1.1,Se-1.4144271570014144+1)-1)/(1.1-1)-1)},Pe=ue=>{if(ue.zoom<Y)return!0;if(ue.zoom===ve)return!1;if(ue.shouldSplit!=null)return ue.shouldSplit;const Ne=ue.aabb.distanceX(B),Se=ue.aabb.distanceY(B);let qe=ke,rt=1;if(C){qe=ue.aabb.distanceZ(B);const Dt=Math.pow(2,ue.zoom),kt=o.aY((ue.y+1)/Dt),$t=o.aY(ue.y/Dt),ti=Math.min(Math.max(v,kt),$t),zi=o.cO(ti)/o.cO(v);if(rt=ti===v?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,zi/this._mercatorScaleRatio),this.zoom<=o.cL&&ue.zoom===ve-1&&zi>=.9)return!0}else if(f&&(qe=ue.aabb.distanceZ(B)*z),this.projection.isReprojectedInTileSpace&&c<=5){const Dt=Math.pow(2,ue.zoom),kt=K(new o.ac((ue.x+.5)/Dt,(ue.y+.5)/Dt));rt=kt>.85?1:kt}if(!m){const Dt=Math.sqrt(Ne*Ne+Se*Se+qe*qe);let kt=(1<<ve-ue.zoom)*H*rt;return kt*=_e(Math.max(qe,ke),Dt),Dt<kt}let Fe=Number.MAX_VALUE,tt=0;const wt=ue.aabb.getCorners(),Tt=[];for(const Dt of wt){o.at(Tt,Dt,B),C||(f?Tt[2]*=z:Tt[2]=ke);const kt=o.bG(Tt,this._camera.forward());kt<Fe&&(Fe=kt,tt=Math.abs(Tt[2]))}let gt=(1<<ve-ue.zoom)*H*rt;if(gt*=_e(Math.max(tt,ke),Fe),Fe<gt)return!0;const Rt=ue.aabb.closestPoint(S);return Rt[0]===S[0]&&Rt[1]===S[1]};if(this.renderWorldCopies)for(let ue=1;ue<=3;ue++)se.push(ie(-ue)),se.push(ie(ue));for(se.push(ie(0));se.length>0;){const ue=se.pop(),Ne=ue.x,Se=ue.y;let qe=ue.fullyVisible;const rt=()=>this.projection.name==="globe"&&(ue.y===0||ue.y===(1<<ue.zoom)-1);if(!qe){let Fe=V?ue.aabb.intersects(M):ue.aabb.intersectsFlat(M);if(Fe===0&&rt()){const tt=new o.cp(ue.zoom,Ne,Se);Fe=o.cq(this,T,tt,!0).intersects(M)}if(Fe===0)continue;qe=Fe===2}if(ue.zoom!==ve&&Pe(ue))for(let Fe=0;Fe<4;Fe++){const tt=(Ne<<1)+Fe%2,wt=(Se<<1)+(Fe>>1),Tt={aabb:m?ue.aabb.quadrant(Fe):o.cr(this,T,ue.zoom+1,tt,wt,ue.wrap,ue.minZ,ue.maxZ,this.projection),zoom:ue.zoom+1,x:tt,y:wt,wrap:ue.wrap,fullyVisible:qe,tileID:void 0,shouldSplit:void 0,minZ:ue.minZ,maxZ:ue.maxZ};f&&!C&&(Tt.tileID=new o.aM(ue.zoom+1===ve?Oe:ue.zoom+1,ue.wrap,ue.zoom+1,tt,wt),Ze(Tt)),se.push(Tt)}else{const Fe=ue.zoom===ve?Oe:ue.zoom;if(t.minzoom&&t.minzoom>Fe)continue;let tt=0;if(!qe){let Rt=V?ue.aabb.intersectsPrecise(M):ue.aabb.intersectsPreciseFlat(M);if(Rt===0&&rt()){const Dt=new o.cp(ue.zoom,Ne,Se);Rt=o.cq(this,T,Dt,!0).intersectsPrecise(M)}if(Rt===0)continue;if(t.calculateQuadrantVisibility)if(M.containsPoint(ue.aabb.center))tt=15;else for(let Dt=0;Dt<4;Dt++)ue.aabb.quadrant(Dt).intersects(M)!==0&&(tt|=1<<Dt)}const wt=S[0]-(.5+Ne+(ue.wrap<<ue.zoom))*(1<<n-ue.zoom),Tt=S[1]-.5-Se,gt=ue.tileID?ue.tileID:new o.aM(Fe,ue.wrap,ue.zoom,Ne,Se);t.calculateQuadrantVisibility&&(gt.visibleQuadrants=tt),ye.push({tileID:gt,distanceSq:wt*wt+Tt*Tt})}}if(this.fogCullDistSq){const ue=this.fogCullDistSq,Ne=this.horizonLineFromTop();ye=ye.filter(Se=>{const qe=[0,0,0,1],rt=[o.aj,o.aj,0,1],Fe=this.calculateFogTileMatrix(Se.tileID.toUnwrapped());o.aA(qe,qe,Fe),o.aA(rt,rt,Fe);const tt=o.cs([],qe,rt),wt=o.ct([],qe,rt),Tt=o.cM(tt,wt);if(Tt===0)return!0;let gt=!1;const Rt=this._elevation;if(Rt&&Tt>ue&&Ne!==0){const Dt=this.calculateProjMatrix(Se.tileID.toUnwrapped());let kt;t.isTerrainDEM||(kt=Rt.getMinMaxForTile(Se.tileID)),kt||(kt={min:ee,max:te});const $t=o.cu(this.rotation),ti=[$t[0]*o.aj,$t[1]*o.aj,kt.max];o.ad(ti,ti,Dt),gt=(1-ti[1])*this.height*.5<Ne}return Tt<ue||gt})}return ye.sort((ue,Ne)=>ue.distanceSq-Ne.distanceSq).map(ue=>ue.tileID)}resize(t,n){this.width=t,this.height=n,this.pixelsToGLUnits=[2/t,-2/n],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(t){return Math.pow(2,t)}scaleZoom(t){return Math.log(t)/Math.LN2}project(t){const n=o.ay(t.lat,-85.051129,o.cv),c=this.projection.project(t.lng,n);return new o.P(c.x*this.worldSize,c.y*this.worldSize)}unproject(t){return this.projection.unproject(t.x/this.worldSize,t.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/o.c6(1,this.center.lat)/this.worldSize}setLocationAtPoint(t,n){let c,d;const f=this.centerPoint;if(this.projection.name==="globe"){const y=this.worldSize;c=(n.x-f.x)/y,d=(n.y-f.y)/y}else{const y=this.pointCoordinate(n),v=this.pointCoordinate(f);c=y.x-v.x,d=y.y-v.y}const m=this.locationCoordinate(t);this.setLocation(new o.ac(m.x-c,m.y-d))}setLocation(t){this.center=this.coordinateLocation(t),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(t,n){return this.projection.locationPoint(this,t,n)}locationPoint3D(t,n){return this.projection.locationPoint(this,t,n,!0)}pointLocation(t){return this.coordinateLocation(this.pointCoordinate(t))}pointLocation3D(t,n){return this.coordinateLocation(this.pointCoordinate3D(t,n))}locationCoordinate(t,n){const c=n?o.c6(n,t.lat):void 0,d=this.projection.project(t.lng,t.lat);return new o.ac(d.x,d.y,c)}coordinateLocation(t){return this.projection.unproject(t.x,t.y)}pointRayIntersection(t,n){const c=n??this._centerAltitude,d=[t.x,t.y,0,1],f=[t.x,t.y,1,1];o.aA(d,d,this.pixelMatrixInverse),o.aA(f,f,this.pixelMatrixInverse);const m=f[3];o.cw(d,d,1/d[3]),o.cw(f,f,1/m);const y=d[2],v=f[2];return{p0:d,p1:f,t:y===v?0:(c-y)/(v-y)}}screenPointToMercatorRay(t){const n=[t.x,t.y,0,1],c=[t.x,t.y,1,1];return o.aA(n,n,this.pixelMatrixInverse),o.aA(c,c,this.pixelMatrixInverse),o.cw(n,n,1/n[3]),o.cw(c,c,1/c[3]),n[2]=o.c6(n[2],this._center.lat)*this.worldSize,c[2]=o.c6(c[2],this._center.lat)*this.worldSize,o.cw(n,n,1/this.worldSize),o.cw(c,c,1/this.worldSize),new o.av([n[0],n[1],n[2]],o.au([],o.at([],c,n)))}rayIntersectionCoordinate(t){const{p0:n,p1:c,t:d}=t,f=o.c6(n[2],this._center.lat),m=o.c6(c[2],this._center.lat);return new o.ac(o.ai(n[0],c[0],d)/this.worldSize,o.ai(n[1],c[1],d)/this.worldSize,o.ai(f,m,d))}pointCoordinate(t,n=this._centerAltitude){return this.projection.pointCoordinate(this,t.x,t.y,n)}pointCoordinate3D(t,n){if(!this.elevation)return this.pointCoordinate(t,n);let c=this.projection.pointCoordinate3D(this,t.x,t.y);if(c)return new o.ac(c[0],c[1],c[2]);let d=0,f=this.horizonLineFromTop();if(t.y>f)return this.pointCoordinate(t,n);const m=.02*f,y=t.clone();for(let v=0;v<10&&f-d>m;v++){y.y=o.ai(d,f,.66);const T=this.projection.pointCoordinate3D(this,y.x,y.y);T?(f=y.y,c=T):d=y.y}return c?new o.ac(c[0],c[1],c[2]):this.pointCoordinate(t)}isPointAboveHorizon(t){return this.projection.isPointAboveHorizon(this,t)}isPointOnSurface(t){if(t.y<0||t.y>this.height||t.x<0||t.x>this.width)return!1;if(this.elevation||this.zoom>=o.cx)return!this.isPointAboveHorizon(t);const n=this.pointCoordinate(t);return n.y>=0&&n.y<=1}_coordinatePoint(t,n){const c=n&&this.elevation?this.elevation.getAtPointOrZero(t,this._centerAltitude):this._centerAltitude,d=[t.x*this.worldSize,t.y*this.worldSize,c+t.toAltitude(),1];return o.aA(d,d,this.pixelMatrix),d[3]>0?new o.P(d[0]/d[3],d[1]/d[3]):new o.P(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){const{top:t,left:n}=this._edgeInsets,c=this.height-this._edgeInsets.bottom,d=this.width-this._edgeInsets.right,f=this.pointLocation3D(new o.P(n,t)),m=this.pointLocation3D(new o.P(d,t)),y=this.pointLocation3D(new o.P(d,c)),v=this.pointLocation3D(new o.P(n,c));let T=Math.min(f.lng,m.lng,y.lng,v.lng),S=Math.max(f.lng,m.lng,y.lng,v.lng),C=Math.min(f.lat,m.lat,y.lat,v.lat),I=Math.max(f.lat,m.lat,y.lat,v.lat);const M=Math.pow(2,-this.zoom)/16*270,D=this.projection.name==="globe"?1:4,z=(O,B,V,H,Y)=>{const te=(O+V)/2,ee=(B+H)/2,J=new o.P(te,ee),{lng:K,lat:ie}=this.pointLocation3D(J),se=Math.max(0,T-K,C-ie,K-S,ie-I);T=Math.min(T,K),S=Math.max(S,K),C=Math.min(C,ie),I=Math.max(I,ie),(Y<D||se>M)&&(z(O,B,te,ee,Y+1),z(te,ee,V,H,Y+1))};if(z(n,t,d,t,1),z(d,t,d,c,1),z(d,c,n,c,1),z(n,c,n,t,1),this.projection.name==="globe"){const[O,B]=o.cy(this);O?(I=90,S=180,T=-180):B&&(C=-90,S=180,T=-180)}return new o.aG(new o.cd(T,C),new o.cd(S,I))}_getBoundsRectangular(t,n){const{top:c,left:d}=this._edgeInsets,f=this.height-this._edgeInsets.bottom,m=this.width-this._edgeInsets.right,y=new o.P(d,c),v=new o.P(m,c),T=new o.P(m,f),S=new o.P(d,f);let C=this.pointCoordinate(y,t),I=this.pointCoordinate(v,t);const M=this.pointCoordinate(T,n),D=this.pointCoordinate(S,n),z=(O,B)=>(B.y-O.y)/(B.x-O.x);return C.y>1&&I.y>=0?C=new o.ac((1-D.y)/z(D,C)+D.x,1):C.y<0&&I.y<=1&&(C=new o.ac(-D.y/z(D,C)+D.x,0)),I.y>1&&C.y>=0?I=new o.ac((1-M.y)/z(M,I)+M.x,1):I.y<0&&C.y<=1&&(I=new o.ac(-M.y/z(M,I)+M.x,0)),new o.aG().extend(this.coordinateLocation(C)).extend(this.coordinateLocation(I)).extend(this.coordinateLocation(D)).extend(this.coordinateLocation(M))}_getBoundsRectangularTerrain(){const t=this.elevation;if(!t.visibleDemTiles.length||t.isUsingMockSource())return this._getBoundsRectangular(0,0);const n=t.visibleDemTiles.reduce((c,d)=>{if(d.dem){const f=d.dem.tree;c.min=Math.min(c.min,f.minimums[0]),c.max=Math.max(c.max,f.maximums[0])}return c},{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(n.min*t.exaggeration(),n.max*t.exaggeration())}getBounds(){return this.projection.name==="mercator"||this.projection.name==="equirectangular"?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(t=!0){const n=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))-this.centerOffset.y,c=this.height/2-n*(1-this._horizonShift);return t?Math.max(0,c):c}getMaxBounds(){return this.maxBounds}setMaxBounds(t){this.maxBounds=t,this.minLat=-85.051129,this.maxLat=o.cv,this.minLng=-180,this.maxLng=180,t&&(this.minLat=t.getSouth(),this.maxLat=t.getNorth(),this.minLng=t.getWest(),this.maxLng=t.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=o.aD(this.minLng)*this.tileSize,this.worldMaxX=o.aD(this.maxLng)*this.tileSize,this.worldMinY=o.aH(this.maxLat)*this.tileSize,this.worldMaxY=o.aH(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(t,n){return this.projection.createTileMatrix(this,n,t)}calculateDistanceTileData(t){const n=t.key,c=this._distanceTileDataCache;if(c[n])return c[n];const d=t.canonical,f=1/this.height,m=this.cameraWorldSize,y=m/this.zoomScale(d.z),v=(d.x+Math.pow(2,d.z)*t.wrap)*y,T=d.y*y,S=this.point;S.x*=m/this.worldSize,S.y*=m/this.worldSize;const C=this.angle,I=Math.sin(-C),M=-Math.cos(-C);return c[n]={bearing:[I,M],center:[(S.x-v)*f,(S.y-T)*f],scale:y/o.aj*f},c[n]}calculateFogTileMatrix(t){const n=t.key,c=this._fogTileMatrixCache;if(c[n])return c[n];const d=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,t);return o.az(d,this.worldToFogMatrix,d),c[n]=new Float32Array(d),c[n]}calculateProjMatrix(t,n=!1,c=!1){const d=t.key;let f;if(f=c?this._expandedProjMatrixCache:n?this._alignedProjMatrixCache:this._projMatrixCache,f[d])return f[d];const m=this.calculatePosMatrix(t,this.worldSize);let y;return y=this.projection.isReprojectedInTileSpace?this.mercatorMatrix:c?this.expandedFarZProjMatrix:n?this.alignedProjMatrix:this.projMatrix,o.az(m,y,m),f[d]=new Float32Array(m),f[d]}calculatePixelsToTileUnitsMatrix(t){const n=t.tileID.key,c=this._pixelsToTileUnitsCache;if(c[n])return c[n];const d=o.cz(t,this);return c[n]=d,c[n]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if(this.projection.name==="globe"){const t=1/this.worldSize,n=o.bn([],[t,t,t]);return o.az(n,n,this.globeMatrix),n}}recenterOnTerrain(){if(!this._elevation||this.projection.name==="globe")return;const t=this._elevation;this._updateCameraState();const n=o.c6(1,this._center.lat)*this.worldSize,c=this._computeCameraPosition(n),d=this._camera.forward(),f=o.c6(1,this._center.lat);c[2]/=f,d[2]/=f,o.au(d,d);const m=t.raycast(c,d,t.exaggeration());if(m){const y=o.bE([],c,d,m),v=new o.ac(y[0],y[1],o.c6(y[2],o.aY(y[1]))),T=(v.z+o.ae([v.x-c[0],v.y-c[1],v.z-c[2]*f]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(T),this._centerAltitude=v.toAltitude(),this._center=this.coordinateLocation(v),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(t=!1){if(!this._elevation)return;const n=this._elevation,c=o.c6(1,this._center.lat)*this.worldSize,d=this._computeCameraPosition(c),f=n.getAtPointOrZero(new o.ac(...d)),m=this.pixelsPerMeter/this.worldSize*f,y=this._minimumHeightOverTerrain(),v=d[2]-m;if(v<=y)if(v<0||t){const T=this.locationCoordinate(this._center,this._centerAltitude),S=[d[0],d[1],T.z-d[2]],C=o.ae(S);S[2]-=(y-v)/this._pixelsPerMercatorPixel;const I=o.ae(S);if(I===0)return;o.bY(S,S,C/I*this._pixelsPerMercatorPixel),this._camera.position=[d[0],d[1],T.z*this._pixelsPerMercatorPixel-S[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;const t=this.projection.name==="globe"||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||t){const I=this.center;return I.lat=o.ay(I.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!t)&&(I.lng=o.ay(I.lng,this.minLng,this.maxLng)),this.center=I,void(this._constraining=!1)}const n=this._unmodified,{x:c,y:d}=this.point;let f=0,m=c,y=d;const v=this.width/2,T=this.height/2,S=this.worldMinY*this.scale,C=this.worldMaxY*this.scale;if(d-T<S&&(y=S+T),d+T>C&&(y=C-T),C-S<this.height&&(f=Math.max(f,this.height/(C-S)),y=(C+S)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){const I=this.worldMinX*this.scale,M=this.worldMaxX*this.scale,D=this.worldSize/2-(I+M)/2;m=(c+D+this.worldSize)%this.worldSize-D,m-v<I&&(m=I+v),m+v>M&&(m=M-v),M-I<this.width&&(f=Math.max(f,this.width/(M-I)),m=(M+I)/2)}m===c&&y===d||this._allowWorldUnderZoom||(this.center=this.unproject(new o.P(m,y))),f&&!this._allowWorldUnderZoom&&(this.zoom+=this.scaleZoom(f)),this._constrainCamera(),this._unmodified=n,this._constraining=!1}_minZoomForBounds(){let t=Math.max(0,this.scaleZoom(Math.max(0,this.height)/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(t=Math.max(t,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),t}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;const t=this.centerOffset,n=this.projection.name==="globe",c=this.pixelsPerMeter;this.projection.name==="globe"&&(this._mercatorScaleRatio=o.c6(1,this.center.lat)/o.c6(1,o.cP));const d=o.cA(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,d),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;const f=this.projection.zAxisUnit==="meters"?c:1,m=this._camera.getWorldToCamera(this.worldSize,f);let y;const v=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);if(v[8]=2*-t.x/this.width,v[9]=2*t.y/this.height,this.isOrthographic){let ie=.5*this.height/Math.tan(this._fov/2)*1*Math.tan(.5*this._fov),se=ie*this.aspect,ye=-se,ve=-ie;se-=t.x,ye-=t.x,ie+=t.y,ve+=t.y,y=this._camera.getCameraToClipOrthographic(ye,se,ve,ie,this._nearZ,this._farZ),((Oe,ke,Ze,_e)=>{for(let Pe=0;Pe<16;Pe++)Oe[Pe]=o.ai(ke[Pe],Ze[Pe],_e)})(y,y,v,o.cN(this.pitch>=Yr?1:this.pitch/Yr))}else y=v;const T=o.cB([],v,m);let S=o.cB([],y,m);if(this.projection.isReprojectedInTileSpace){const ie=this.locationCoordinate(this.center),se=o.bx([]);o.bo(se,se,[ie.x*this.worldSize,ie.y*this.worldSize,0]),o.az(se,se,o.cC(this)),o.bo(se,se,[-ie.x*this.worldSize,-ie.y*this.worldSize,0]),o.az(S,S,se),o.az(T,T,se),this.inverseAdjustmentMatrix=o.cD(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];if(this.mercatorMatrix=o.cE([],S,[this.worldSize,this.worldSize,this.worldSize/f,1]),this.projMatrix=S,this.invProjMatrix=o.bi(new Float64Array(16),this.projMatrix),n){const ie=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,1/0);ie[8]=2*-t.x/this.width,ie[9]=2*t.y/this.height,this.expandedFarZProjMatrix=o.cB([],ie,m)}else this.expandedFarZProjMatrix=this.projMatrix;const C=o.bi([],y);this.frustumCorners=o.cF.fromInvProjectionMatrix(C,this.horizonLineFromTop(),this.height),this.cameraFrustum=o.cn.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,0,!n);const I=new Float32Array(16);o.bx(I),o.cE(I,I,[1,-1,1]),o.cG(I,I,this._pitch),o.by(I,I,this.angle);const M=o.c4(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ);this.starsProjMatrix=o.bw(M);const D=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;M[8]=2*-t.x/this.width,M[9]=2*(t.y+D)/this.height,this.skyboxMatrix=o.az(I,M,I);const z=this.point,O=z.x,B=z.y,V=this.width%2/2,H=this.height%2/2,Y=Math.cos(this.angle),te=Math.sin(this.angle),ee=O-Math.round(O)+Y*V+te*H,J=B-Math.round(B)+Y*H+te*V,K=new Float64Array(S);if(o.bo(K,K,[ee>.5?ee-1:ee,J>.5?J-1:J,0]),this.alignedProjMatrix=K,S=o.bz(),o.cE(S,S,[this.width/2,-this.height/2,1]),o.bo(S,S,[1,-1,0]),this.labelPlaneMatrix=S,S=o.bz(),o.cE(S,S,[1,-1,1]),o.bo(S,S,[-1,-1,0]),o.cE(S,S,[2/this.width,2/this.height,1]),this.glCoordMatrix=S,this.pixelMatrix=o.az(new Float64Array(16),this.labelPlaneMatrix,T),this._calcFogMatrices(),this._distanceTileDataCache={},S=o.bi(new Float64Array(16),this.pixelMatrix),!S)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=S,this.projection.name==="globe"||this.mercatorFromTransition){this.globeMatrix=o.cH(this);const ie=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=o.ad(ie,ie,m),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=S;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={},this._expandedProjMatrixCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};const t=this.cameraWorldSizeForFog,n=this.cameraPixelsPerMeter,c=this._camera.position,d=1/this.height/this._pixelsPerMercatorPixel,f=[t,t,n];o.bY(f,f,d),o.bY(c,c,-1),o.cI(c,c,f);const m=o.bz();o.bo(m,m,c),o.cE(m,m,f),this.mercatorFogMatrix=m,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(t,n,d)}_computeCameraPosition(t){const n=(t=t||this.pixelsPerMeter)/this.pixelsPerMeter,c=this._camera.forward(),d=this.point,f=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*n-t/this.worldSize*this._centerAltitude;return[d.x/this.worldSize-c[0]*f,d.y/this.worldSize-c[1]*f,t/this.worldSize*this._centerAltitude-c[2]*f]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(t){const n=this._maxCameraBoundsDistance()*Math.cos(this._pitch),c=this._camera.position[2],d=t[2];let f=1;this.projection.wrap&&(this.center=this.center.wrap()),d>0&&(f=Math.min((n-c)/d,1)),this._camera.position=o.bE([],this._camera.position,t,f),this._updateStateFromCamera()}_updateStateFromCamera(){const t=this._camera.position,n=this._camera.forward(),{pitch:c,bearing:d}=this._camera.getPitchBearing(),f=o.c6(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,m=this._mercatorZfromZoom(this._maxZoom)*Math.cos(o.al(this._maxPitch)),y=Math.max((t[2]-f)/Math.cos(c),m),v=this._zoomFromMercatorZ(y);o.bE(t,t,n,y),this._pitch=o.ay(c,o.al(this.minPitch),o.al(this.maxPitch)),this.angle=o.bX(d,-Math.PI,Math.PI),this._setZoom(o.ay(v,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new o.ac(t[0],t[1],t[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(t){return Math.pow(2,t)*this.tileSize}_mercatorZfromZoom(t){return this.cameraToCenterDistance/this._worldSizeFromZoom(t)}_minimumHeightOverTerrain(){const t=Math.min(this._seaLevelZoom!=null?this._seaLevelZoom:this._zoom,this._maxZoom)+4;return this._mercatorZfromZoom(t)}_zoomFromMercatorZ(t){return this.scaleZoom(this.cameraToCenterDistance/(Math.max(0,t)*this.tileSize))}zoomFromMercatorZAdjusted(t){let n=0,c=o.cx,d=0,f=1/0;for(;c-n>1e-6&&c>n;){const m=n+.5*(c-n),y=this.tileSize*Math.pow(2,m),v=this.getCameraToCenterDistance(this.projection,m,y),T=this.scaleZoom(v/(Math.max(0,t)*this.tileSize)),S=Math.abs(m-T);S<f&&(f=S,d=m),m<T?n=m:c=m}return d}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(o.w("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(t,n){const c=Math.min(t.x,n.x),d=Math.max(t.x,n.x),f=Math.min(t.y,n.y),m=Math.max(t.y,n.y);if(f<this.horizonLineFromTop(!1))return!0;if(this.projection.name!=="mercator")return!1;const y=[new o.P(c,f),new o.P(d,m),new o.P(c,m),new o.P(d,f)],v=this.renderWorldCopies?-3:0,T=this.renderWorldCopies?4:1;for(const S of y){const C=this.pointRayIntersection(S);if(C.t<0)return!0;const I=this.rayIntersectionCoordinate(C);if(I.x<v||I.y<0||I.x>T||I.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+o.cJ(this.fovAboveCenter)>88||this.anyCornerOffEdge(new o.P(0,0),new o.P(this.width,this.height))}zoomDeltaToMovement(t,n){const c=o.ae(o.at([],this._camera.position,t)),d=this._zoomFromMercatorZ(c)+n;return c-this._mercatorZfromZoom(d)}getCameraPoint(){if(this.projection.name==="globe"){const t=function([n,c,d],f){const m=[n,c,d,1];o.aA(m,m,f);const y=m[3]=Math.max(m[3],1e-6);return m[0]/=y,m[1]/=y,m[2]/=y,m}([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new o.P(t[0],t[1])}{const t=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new o.P(0,t))}}getCameraToCenterDistance(t,n=this.zoom,c=this.worldSize){const d=o.cA(t,n,this.width,this.height,1024),f=t.pixelSpaceConversion(this.center.lat,c,d);let m=.5/Math.tan(.5*this._fov)*this.height*f;return this.isOrthographic&&(m=o.ai(1,m,o.cN(this.pitch>=Yr?1:this.pitch/Yr))),m}getWorldToCameraMatrix(){const t=this._camera.getWorldToCamera(this.worldSize,this.projection.zAxisUnit==="meters"?this.pixelsPerMeter:1);return this.projection.name==="globe"&&o.az(t,t,this.globeMatrix),t}getFrustum(t){return o.cn.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,t,this.projection.zAxisUnit==="meters")}}const _s=(l,t)=>{if(t>0&&l.terrain&&o.w("Cutoff is currently disabled on terrain"),t<=0||l.terrain)return{shouldRenderCutoff:!1,uniformValues:{u_cutoff_params:[0,0,0,1]}};const n=l.transform,c=Math.max(Math.abs(n._zoom-(l.minCutoffZoom-1)),1),d=n.isLODDisabled(!1)?o.af(60,45,n.pitch):o.af(30,15,n.pitch),f=n._farZ-n._nearZ,m=t*n.height,y=((1-(v=d))*n.cameraToCenterDistance+v*(n._farZ+m))*c;var v;return{shouldRenderCutoff:d<1,uniformValues:{u_cutoff_params:[n._nearZ,n._farZ,(y-n._nearZ)/f,(y-m-n._nearZ)/f]}}},cn={cascadeCount:2,normalOffset:3,shadowMapResolution:2048};class Sl{constructor(t,n){this.aabb=t,this.lastCascade=n}}class kp{add(t,n){const c=this.receivers[t.key];c!==void 0?(c.aabb.min[0]=Math.min(c.aabb.min[0],n.min[0]),c.aabb.min[1]=Math.min(c.aabb.min[1],n.min[1]),c.aabb.min[2]=Math.min(c.aabb.min[2],n.min[2]),c.aabb.max[0]=Math.max(c.aabb.max[0],n.max[0]),c.aabb.max[1]=Math.max(c.aabb.max[1],n.max[1]),c.aabb.max[2]=Math.max(c.aabb.max[2],n.max[2])):this.receivers[t.key]=new Sl(n,null)}clear(){this.receivers={}}get(t){return this.receivers[t.key]}computeRequiredCascades(t,n,c){const d=o.cW.fromPoints(t.points);let f=0;for(const m in this.receivers){const y=this.receivers[m];if(!y||!d.intersectsAabb(y.aabb))continue;y.aabb.min=d.closestPoint(y.aabb.min),y.aabb.max=d.closestPoint(y.aabb.max);const v=y.aabb.getCorners();for(let T=0;T<c.length;T++){let S=!0;for(const C of v){const I=[C[0]*n,C[1]*n,C[2]];if(o.ad(I,I,c[T].matrix),I[0]<-1||I[0]>1||I[1]<-1||I[1]>1){S=!1;break}}if(y.lastCascade=T,f=Math.max(f,T),S)break}}return f+1}}class Fp{constructor(t){this.painter=t,this._enabled=!1,this._shadowLayerCount=0,this._numCascadesToRender=0,this._cascades=[],this._groundShadowTiles=[],this._receivers=new kp,this._depthMode=new xt(t.context.gl.LEQUAL,xt.ReadWrite,[0,1]),this._uniformValues={u_light_matrix_0:new Float32Array(16),u_light_matrix_1:new Float32Array(16),u_shadow_intensity:0,u_fade_range:[0,0],u_shadow_normal_offset:[1,1,1],u_shadow_texel_size:1,u_shadow_map_resolution:1,u_shadow_direction:[0,0,1],u_shadow_bias:[36e-5,.0012,.012],u_shadowmap_0:0,u_shadowmap_1:0},this._forceDisable=!1,this.useNormalOffset=!1,t.tp.registerParameter(this,["Shadows"],"_forceDisable",{label:"forceDisable"},()=>{this.painter.style.map.triggerRepaint()}),t.tp.registerParameter(cn,["Shadows"],"cascadeCount",{min:1,max:2,step:1}),t.tp.registerParameter(cn,["Shadows"],"normalOffset",{min:0,max:10,step:.05}),t.tp.registerParameter(cn,["Shadows"],"shadowMapResolution",{min:32,max:2048,step:32}),t.tp.registerBinding(this,["Shadows"],"_numCascadesToRender",{readonly:!0,label:"numCascadesToRender"})}destroy(){for(const t of this._cascades)t.texture.destroy(),t.framebuffer.destroy();this._cascades=[]}updateShadowParameters(t,n){const c=this.painter;if(this._enabled=!1,this._shadowLayerCount=0,this._receivers.clear(),!n||!n.properties)return;const d=n.properties.get("shadow-intensity");if(!n.shadowsEnabled()||d<=0||(this._shadowLayerCount=c.style.order.reduce((D,z)=>{const O=c.style._mergedLayers[z];return D+(O.hasShadowPass()&&!O.isHidden(t.zoom)?1:0)},0),this._enabled=this._shadowLayerCount>0,!this.enabled))return;const f=c.context,m=cn.shadowMapResolution,y=cn.shadowMapResolution;if(this._cascades.length===0||cn.shadowMapResolution!==this._cascades[0].texture.size[0]){this._cascades=[];for(let D=0;D<cn.cascadeCount;++D){const z=c._shadowMapDebug,O=f.gl,B=f.createFramebuffer(m,y,z,"texture"),V=new o.T(f,{width:m,height:y,data:null},O.DEPTH_COMPONENT16);if(B.depthAttachment.set(V.texture),z){const H=new o.T(f,{width:m,height:y,data:null},O.RGBA8);B.colorAttachment.set(H.texture)}this._cascades.push({framebuffer:B,texture:V,matrix:[],far:0,boundingSphereRadius:0,frustum:new o.cn,scale:0})}}this.shadowDirection=ya(n);let v=0;if(t.elevation){const D=t.elevation,z=[1e4,-1e4];D.visibleDemTiles.filter(O=>O.dem).forEach(O=>{const B=O.dem.tree;z[0]=Math.min(z[0],B.minimums[0]),z[1]=Math.max(z[1],B.maximums[0])}),z[0]!==1e4&&(v=(z[1]-z[0])*D.exaggeration())}const T=1.5*t.cameraToCenterDistance,S=3*T,C=new Float64Array(16);for(let D=0;D<this._cascades.length;++D){const z=this._cascades[D];let O=t.height/50,B=1;cn.cascadeCount===1?B=S:D===0?B=T:(O=T,B=S);const[V,H]=va(t,this.shadowDirection,O,B,cn.shadowMapResolution,v);z.scale=t.scale,z.matrix=V,z.boundingSphereRadius=H,o.bi(C,z.matrix),z.frustum=o.cn.fromInvProjectionMatrix(C,1,0,!0),z.far=B}const I=this._cascades.length-1;this._uniformValues.u_fade_range=[.75*this._cascades[I].far,this._cascades[I].far],this._uniformValues.u_shadow_intensity=d,this._uniformValues.u_shadow_direction=[this.shadowDirection[0],this.shadowDirection[1],this.shadowDirection[2]],this._uniformValues.u_shadow_texel_size=1/cn.shadowMapResolution,this._uniformValues.u_shadow_map_resolution=cn.shadowMapResolution,this._uniformValues.u_shadowmap_0=xn.ShadowMap0,this._uniformValues.u_shadowmap_1=xn.ShadowMap0+1,this._groundShadowTiles=c.transform.coveringTiles({tileSize:512,renderWorldCopies:!0});const M=c.transform.elevation;for(const D of this._groundShadowTiles){let z={min:0,max:0};if(M){const O=M.getMinMaxForTile(D);O&&(z=O)}this.addShadowReceiver(D.toUnwrapped(),z.min,z.max)}}get enabled(){return this._enabled&&!this._forceDisable}set enabled(t){this._enabled=t}drawShadowPass(t,n){if(!this.enabled)return;const c=this.painter,d=c.context;this._numCascadesToRender=this._receivers.computeRequiredCascades(c.transform.getFrustum(0),c.transform.worldSize,this._cascades),d.viewport.set([0,0,cn.shadowMapResolution,cn.shadowMapResolution]);for(let f=0;f<this._numCascadesToRender;++f){c.currentShadowCascade=f,d.bindFramebuffer.set(this._cascades[f].framebuffer.framebuffer),d.clear({color:o.am.white,depth:1});for(const m of t.order){const y=t._mergedLayers[m];if(!y.hasShadowPass()||y.isHidden(c.transform.zoom))continue;const v=t.getLayerSourceCache(y),T=v?n[v.id]:void 0;(y.type==="model"||T&&T.length)&&c.renderLayer(c,v,y,T)}}c.currentShadowCascade=0}drawGroundShadows(){if(!this.enabled)return;const t=this.painter,n=t.style,c=t.context,d=c.gl,f=n.directionalLight,m=n.ambientLight;if(!f||!m)return;const y=[],v=_s(t,t.longestCutoffRange);v.shouldRenderCutoff&&y.push("RENDER_CUTOFF"),y.push("RENDER_SHADOWS","DEPTH_TEXTURE"),this.useNormalOffset&&y.push("NORMAL_OFFSET");const T=jo(n,f,m),S=new xt(d.LEQUAL,xt.ReadOnly,t.depthRangeFor3D),C=new Zt({func:d.EQUAL,mask:255},0,255,d.KEEP,d.KEEP,d.KEEP);for(const I of this._groundShadowTiles){const M=I.toUnwrapped(),D=t.isTileAffectedByFog(I),z=t.getOrCreateProgram("groundShadow",{defines:y,overrideFog:D});this.setupShadows(M,z),t.uploadCommonUniforms(c,z,M,null,v);const O={u_matrix:t.transform.calculateProjMatrix(M),u_ground_shadow_factor:T};z.draw(t,d.TRIANGLES,S,C,oi.multiply,Nt.disabled,O,"ground_shadow",t.tileExtentBuffer,t.quadTriangleIndexBuffer,t.tileExtentSegments,null,t.transform.zoom,null,null)}}getShadowPassColorMode(){return this.painter._shadowMapDebug?oi.unblended:oi.disabled}getShadowPassDepthMode(){return this._depthMode}getShadowCastingLayerCount(){return this._shadowLayerCount}calculateShadowPassMatrixFromTile(t){const n=this.painter.transform,c=n.calculatePosMatrix(t,n.worldSize);return o.az(c,this._cascades[this.painter.currentShadowCascade].matrix,c),Float32Array.from(c)}calculateShadowPassMatrixFromMatrix(t){return o.az(t,this._cascades[this.painter.currentShadowCascade].matrix,t),Float32Array.from(t)}setupShadows(t,n,c,d=0){if(!this.enabled)return;const f=this.painter.transform,m=this.painter.context,y=m.gl,v=this._uniformValues,T=new Float64Array(16),S=f.calculatePosMatrix(t,f.worldSize);for(let C=0;C<this._cascades.length;C++)o.az(T,this._cascades[C].matrix,S),v[C===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(T),m.activeTexture.set(y.TEXTURE0+xn.ShadowMap0+C),this._cascades[C].texture.bindExtraParam(y.LINEAR,y.LINEAR,y.CLAMP_TO_EDGE,y.CLAMP_TO_EDGE,y.GREATER);if(this.useNormalOffset=!!c,this.useNormalOffset){const C=o.cU(t.canonical),I=2/f.tileSize*o.aj/cn.shadowMapResolution,M=I*this._cascades[0].boundingSphereRadius,D=I*this._cascades[this._cascades.length-1].boundingSphereRadius,z=(c==="vector-tile"?1:3)/Math.pow(2,d-t.canonical.z-(1-f.zoom+Math.floor(f.zoom)));v.u_shadow_normal_offset=[C,M*z,D*z],v.u_shadow_bias=[6e-5,.0012,.012]}else v.u_shadow_bias=[36e-5,.0012,.012];n.setShadowUniformValues(m,v)}setupShadowsFromMatrix(t,n,c=!1){if(!this.enabled)return;const d=this.painter.context,f=d.gl,m=this._uniformValues,y=new Float64Array(16);for(let v=0;v<cn.cascadeCount;v++)o.az(y,this._cascades[v].matrix,t),m[v===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(y),d.activeTexture.set(f.TEXTURE0+xn.ShadowMap0+v),this._cascades[v].texture.bindExtraParam(f.LINEAR,f.LINEAR,f.CLAMP_TO_EDGE,f.CLAMP_TO_EDGE,f.GREATER);if(this.useNormalOffset=c,c){const v=cn.normalOffset;m.u_shadow_normal_offset=[1,v,v],m.u_shadow_bias=[6e-5,.0012,.012]}else m.u_shadow_bias=[36e-5,.0012,.012];n.setShadowUniformValues(d,m)}getShadowUniformValues(){return this._uniformValues}getCurrentCascadeFrustum(){return this._cascades[this.painter.currentShadowCascade].frustum}computeSimplifiedTileShadowVolume(t,n,c,d){if(d[2]>=0)return{};const f=function(v,T,S){const C=S/(1<<v.canonical.z);return new o.cW([v.canonical.x*C+v.wrap*S,v.canonical.y*C+v.wrap*S,0],[(v.canonical.x+1)*C+v.wrap*S,(v.canonical.y+1)*C+v.wrap*S,T])}(t,n,c).getCorners(),m=n/-d[2];d[0]<0?(o.cV(f[0],f[0],[d[0]*m,0,0]),o.cV(f[3],f[3],[d[0]*m,0,0])):d[0]>0&&(o.cV(f[1],f[1],[d[0]*m,0,0]),o.cV(f[2],f[2],[d[0]*m,0,0])),d[1]<0?(o.cV(f[0],f[0],[0,d[1]*m,0]),o.cV(f[1],f[1],[0,d[1]*m,0])):d[1]>0&&(o.cV(f[2],f[2],[0,d[1]*m,0]),o.cV(f[3],f[3],[0,d[1]*m,0]));const y={};return y.vertices=f,y.planes=[so(f[1],f[0],f[4]),so(f[2],f[1],f[5]),so(f[3],f[2],f[6]),so(f[0],f[3],f[7])],y}addShadowReceiver(t,n,c){this._receivers.add(t,o.cW.fromTileIdAndHeight(t,n,c))}getMaxCascadeForTile(t){const n=this._receivers.get(t);return n&&n.lastCascade?n.lastCascade:0}}function so(l,t,n){const c=o.at([],n,t),d=o.at([],l,t),f=o.bF([],c,d),m=o.ae(f);return m===0?[0,0,1,0]:(o.bY(f,f,1/m),[f[0],f[1],f[2],-o.bG(f,t)])}function ya(l){const t=l.properties.get("direction"),n=o.cR(t.x,t.y,t.z);n[2]=o.ay(n[2],0,75);const c=o.cT([n[0],n[1],n[2]]);return o.cS(c.x,c.y,c.z)}function jo(l,t,n){const c=t.properties.get("color-use-theme")==="none",d=t.properties.get("color"),f=t.properties.get("intensity"),m=t.properties.get("direction"),y=[m.x,m.y,m.z],v=n.properties.get("color-use-theme")==="none",T=n.properties.get("color"),S=n.properties.get("intensity"),C=Math.max(o.bG([0,0,1],y),0),I=[0,0,0];o.bY(I,T.toPremultipliedRenderColor(v?null:l.getLut(t.scope)).toArray01Linear().slice(0,3),S);const M=[0,0,0];return o.bY(M,d.toPremultipliedRenderColor(c?null:l.getLut(n.scope)).toArray01Linear().slice(0,3),C*f),o.cY([I[0]>0?I[0]/(I[0]+M[0]):0,I[1]>0?I[1]/(I[1]+M[1]):0,I[2]>0?I[2]/(I[2]+M[2]):0])}function va(l,t,n,c,d,f){const m=l.zoom,y=l.scale,v=l.worldSize,T=1/v,S=l.aspect,C=Math.sqrt(1+S*S)*Math.tan(.5*l.fovX),I=C*C,M=c-n,D=c+n;let z,O;I>M/D?(z=c,O=c*C):(z=.5*D*(1+I),O=.5*Math.sqrt(M*M+2*(c*c+n*n)*I+D*D*I*I));const B=l.projection.pixelsPerMeter(l.center.lat,v),V=l._camera.getCameraToWorldMercator(),H=[0,0,-z*T];o.ad(H,H,V);let Y=O*T;const te=l._edgeInsets;if(!(te.left===0&&te.top===0&&te.right===0&&te.bottom===0||te.left===te.right&&te.top===te.bottom)){const qe=l._camera.getWorldToCamera(l.worldSize,l.projection.zAxisUnit==="meters"?B:1),rt=l._camera.getCameraToClipPerspective(l._fov,l.width/l.height,n,c);rt[8]=2*-l.centerOffset.x/l.width,rt[9]=2*l.centerOffset.y/l.height;const Fe=new Float64Array(16);o.cB(Fe,rt,qe);const tt=new Float64Array(16);o.bi(tt,Fe);const wt=o.cn.fromInvProjectionMatrix(tt,v,m,!0);for(const Tt of wt.points){const gt=((ee=Tt)[0]/=y,ee[1]/=y,ee[2]=o.c6(ee[2],l._center.lat),ee);Y=Math.max(Y,o.bZ(o.cX([],H,gt)))}}var ee;Y*=d/(d-1);const J=Math.acos(t[2]),K=Math.atan2(-t[0],-t[1]),ie=new Kn;ie.position=H,ie.setPitchBearing(J,K);const se=ie.getWorldToCamera(v,B),ye=Y*v,ve=Math.min(l._mercatorZfromZoom(17)*v*-2,-2*ye),Oe=ie.getCameraToClipOrthographic(-ye,ye,-ye,ye,ve,(ye+f*B)/t[2]),ke=new Float64Array(16);o.az(ke,Oe,se);const Ze=o.cS(Math.floor(1e6*H[0])/1e6*v,Math.floor(1e6*H[1])/1e6*v,0),_e=.5*d,Pe=[0,0,0];o.ad(Pe,Ze,ke),o.bY(Pe,Pe,_e);const ue=[Math.floor(Pe[0]),Math.floor(Pe[1]),Math.floor(Pe[2])],Ne=[0,0,0];o.at(Ne,Pe,ue),o.bY(Ne,Ne,-1/_e);const Se=new Float64Array(16);return o.bx(Se),o.bo(Se,Se,Ne),o.az(ke,Se,ke),[ke,ye]}class zd extends o.E{constructor(t){super(),this.requestManager=t,this.models={"":{}},this.modelUris={"":{}},this.modelByURL={},this.numModelsLoading={}}loadModel(t,n){return o.aS(this.requestManager.transformRequest(n,o.R.Model).url).then(c=>{if(!c)return;const d=o.aT(c),f=new o.aU(t,void 0,void 0,d);return f.computeBoundsAndApplyParent(),f}).catch(c=>{if(c&&c.status===404)return null;this.fire(new o.z(new Error(`Could not load model ${t} from ${n}: ${c.message}`)))})}load(t,n,c={forceReload:!1}){this.models[n]||(this.models[n]={});const d=Object.keys(t),f=[],m=[];for(const y of d){const v=t[y];this.hasURLBeenRequested(v)&&!c.forceReload||(this.modelByURL[v]={modelId:y,scope:n},f.push(this.loadModel(y,v)),m.push(y)),this.models[n][y]||(this.models[n][y]={model:null,numReferences:1})}this.numModelsLoading[n]=(this.numModelsLoading[n]||0)+m.length,Promise.allSettled(f).then(y=>{for(let v=0;v<y.length;v++){const{status:T}=y[v];if(T==="rejected")continue;const{value:S}=y[v];this.models[n][m[v]]||(this.models[n][m[v]]={model:null,numReferences:1}),this.models[n][m[v]].model=S}this.numModelsLoading[n]-=m.length,this.fire(new o.A("data",{dataType:"style"}))}).catch(y=>{this.fire(new o.z(new Error(`Could not load models: ${y.message}`)))})}isLoaded(){for(const t in this.numModelsLoading)if(this.numModelsLoading[t]>0)return!1;return!0}hasModel(t,n,c={exactIdMatch:!1}){return!!(c.exactIdMatch?this.getModel(t,n):this.getModelByURL(this.modelUris[n][t]))}getModel(t,n){return this.models[n]||(this.models[n]={}),this.models[n][t]?this.models[n][t].model:void 0}getModelByURL(t){if(!t)return null;const n=this.modelByURL[t];return n?this.models[n.scope][n.modelId].model:null}hasModelBeenAdded(t,n){return this.models[n]&&this.models[n][t]!==void 0}getModelURIs(t){return this.modelUris[t]||{}}addModel(t,n,c){this.models[c]||(this.models[c]={}),this.modelUris[c]||(this.modelUris[c]={});const d=this.requestManager.normalizeModelURL(n);if((this.hasModel(t,c,{exactIdMatch:!0})||this.hasModelBeenAdded(t,c))&&this.modelUris[c][t]===d)this.models[c][t].numReferences++;else if(this.hasURLBeenRequested(d)){const{scope:f,modelId:m}=this.modelByURL[d];this.models[f][m].numReferences++}else this.modelUris[c][t]=d,this.load({[t]:this.modelUris[c][t]},c)}addModelURLs(t,n){this.models[n]||(this.models[n]={}),this.modelUris[n]||(this.modelUris[n]={});const c=this.modelUris[n];for(const d in t)c[d]=this.requestManager.normalizeModelURL(t[d])}reloadModels(t){this.load(this.modelUris[t],t,{forceReload:!0})}addModelsFromBucket(t,n){this.models[n]||(this.models[n]={}),this.modelUris[n]||(this.modelUris[n]={});const c={};for(const d of t)this.hasModel(d,n,{exactIdMatch:!0})||this.hasURLBeenRequested(d)?this.models[n][d].numReferences++:this.modelUris[n][d]&&!this.hasURLBeenRequested(d)?c[d]=this.modelUris[n][d]:!this.hasURLBeenRequested(d)&&o.cZ(d,!1)&&(this.modelUris[n][d]=this.requestManager.normalizeModelURL(d),c[d]=this.modelUris[n][d]);this.load(c,n)}hasURLBeenRequested(t){return this.modelByURL[t]!==void 0}removeModel(t,n,c=!1){if(this.models[n]&&this.models[n][t]&&(this.models[n][t].numReferences--,this.models[n][t].numReferences===0)){const d=this.modelUris[n][t];c||delete this.modelUris[n][t],delete this.modelByURL[d];const f=this.models[n][t].model;if(!f)return;delete this.models[n][t],f.destroy()}}destroy(){for(const t of Object.keys(this.models))for(const n of Object.keys(this.models[t])){const c=this.models[t][n].model;delete this.models[t][n],c&&c.destroy()}this.models={"":{}},this.modelUris={"":{}},this.modelByURL={},this.numModelsLoading={}}listModels(t){return this.models[t]||(this.models[t]={}),Object.keys(this.models[t])}upload(t,n){this.models[n]||(this.models[n]={});for(const c in this.models[n])this.models[n][c].model&&this.models[n][c].model.upload(t.context)}}const Ic=new o.a7({data:new o.a8(o.a5.colorTheme.data)}),Zu={"mbx-indoor-active-floorplans":{default:["literal",[]]},"mbx-indoor-underground":{default:["literal",!1]},"mbx-indoor-loaded-levels":{default:["literal",[]]},"mbx-indoor-level-height":{default:["literal",{}]},"mbx-indoor-level-base":{default:["literal",{}]},"mbx-indoor-level-selected":{default:["literal",{}]},"mbx-indoor-level-overlapped":{default:["literal",{}]}};function Ls(l){return l=l||{},Object.assign(l,Zu)}class Bp extends o.E{constructor(t){super(),this.mergeFloors=!0,this._scope=void 0,this._queryFeatureSetId=void 0,this._buildingEntryFeatureSetId=void 0,this._selectedFloorplan=void 0,this._indoorData=void 0,this._floorplanStates={},o.aV(["_onLoad","_onMove","_checkFloorplanVisible"],this),this._map=t,this._checkFloorplanVisible(),this._map.on("load",this._onLoad),this._map.on("move",this._onMove)}destroy(){this._map.indoor.off("load",this._onLoad),this._map.indoor.off("move",this._onMove),this._map=void 0}_onLoad(){this._map.style.forEachFragmentStyle(t=>{t.stylesheet.indoor&&(this._queryFeatureSetId?this.fire(new o.z(new Error("Multiple indoor map styles detected, simultaneous usage is not allowed currently."))):(this._queryFeatureSetId=t.stylesheet.indoor.floorplanFeaturesetId,this._buildingEntryFeatureSetId=t.stylesheet.indoor.buildingFeaturesetId,this._scope=t.scope))}),this._queryFeatureSetId&&this._buildingEntryFeatureSetId&&this._map.addInteraction("mbx-indoor-buildingclick",{type:"click",target:{featuresetId:this._buildingEntryFeatureSetId,importId:this._scope},handler:t=>(t.feature&&t.feature.properties.floorplan&&this.selectFloorplan(t.feature.properties.floorplan),!0)}),this._checkFloorplanVisible()}_onMove(){this._checkFloorplanVisible()}_checkFloorplanVisible(){if(!this._queryFeatureSetId||!this._map.isStyleLoaded())return;const t=()=>{this._indoorData=void 0,this._selectedFloorplan=void 0,this._map.setConfigProperty(this._scope,"mbx-indoor-underground",!1),this._map.setConfigProperty(this._scope,"mbx-indoor-active-floorplans",["literal",[]]),this.fire(new o.A("floorplangone"))};if(this._map.transform.zoom<13)return void t();const n={target:{featuresetId:this._queryFeatureSetId,importId:this._scope}},c=this._map.transform.width,d=this._map.transform.height,f=c*(2/3),m=d*(2/3),y=.5*(c-f),v=.5*(d-m),T=[new o.P(y,v),new o.P(y+f,v+m)],S=this._map.queryRenderedFeatures(T,n);S.length>0?this._selectedFloorplan&&S[0].properties.id===this._selectedFloorplan.properties.id||(this._selectedFloorplan=S[0],this._floorplanSelected()):t()}_floorplanSelected(){this._indoorData=JSON.parse(this._selectedFloorplan.properties["indoor-data"]),this._indoorData.id=this._selectedFloorplan.properties.id,this._floorplanStates[this._indoorData.id]=this._floorplanStates[this._indoorData.id]||{},this._map.setConfigProperty(this._scope,"mbx-indoor-active-floorplans",["literal",[this._indoorData.id]]);const t=this._floorplanStates[this._indoorData.id].selectedBuilding,n=t?this._indoorData.buildings.find(y=>y.id===t):this._indoorData.buildings.length>0?this._indoorData.buildings[0]:null,c=this._floorplanStates[this._indoorData.id].selectedLevel,d=this._indoorData.levels.find(y=>y.id===c),f=this._indoorData.levels.find(y=>!(!n||!n.levels)&&Number(y.levelOrder)===0&&n.levels.includes(y.id)),m=d?d.id:f?f.id:void 0;this.fire(new o.A("floorplanselected",{buildings:this._indoorData.buildings,levels:this._indoorData.levels,selectedLevelId:m})),n&&this._buildingSelected(n,!1),m&&this._levelSelected(m)}_buildingSelected(t,n){if(!t||!t.id)return void console.warn("IndoorManager: Building or building id is undefined");n&&t.extent&&this._map.fitBounds(t.extent,{pitch:this._map.getPitch(),bearing:this._map.getBearing()}),this._floorplanStates[this._indoorData.id].selectedBuilding=t?t.id:void 0;const c=this._indoorData.levels.filter(d=>t.levels.includes(d.id));this.fire(new o.A("buildingselected",{buildingId:t.id,levels:c}))}_levelSelected(t){const n=this._indoorData.levels.find(c=>c.id===t);n?(this._updateLevels(n,!0),this.fire(new o.A("levelselected",{levelId:n.id}))):console.warn(`IndoorManager: Level with ID ${t} not found in the current floorplan.`)}_updateLevels(t,n){if(!t||!t.id)throw new Error("IndoorManager: Selected level or level ID is undefined");function c(T){const S=T.indexOf("/floor/");if(S===-1)return T;const C=S+7,I=T.indexOf("/",C);return I===-1?T.slice(C):T.slice(C,I)}this._floorplanStates[this._indoorData.id].selectedLevel=t.id;const d=[],f={},m={},y={},v={};for(const T of this._indoorData.levels){if(d.push(T.id),f[T.id]=T.levelOrder>=0?3*Math.abs(T.levelOrder+1):3*Math.abs(T.levelOrder),m[T.id]=T.levelOrder>=0?3*T.levelOrder:0,this.mergeFloors){const S=c(t.id),C=c(T.id);y[T.id]=C===S?"true":"false"}else y[T.id]=T.id===t.id?"true":"false";v[T.id]=T.levelOrder<t.levelOrder?"true":"false"}this._map.setConfigProperty(this._scope,"mbx-indoor-loaded-levels",["literal",d]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-height",["literal",f]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-base",["literal",m]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-selected",["literal",y]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-overlapped",["literal",v]),this._map.setConfigProperty(this._scope,"mbx-indoor-underground",t.levelOrder<0)}selectFloorplan(t){const n={target:{featuresetId:this._queryFeatureSetId,importId:this._scope}},c=[new o.P(0,0),new o.P(this._map.transform.width,this._map.transform.height)],d=this._map.queryRenderedFeatures(c,n);if(d.length>0){for(const f of d)if(JSON.parse(f.properties["indoor-data"]).id===t){this._selectedFloorplan=f,this._floorplanSelected();break}}}selectBuilding(t){const n=this._indoorData.buildings.find(c=>c.id===t);this._buildingSelected(n,!0)}selectLevel(t){this._levelSelected(t)}}function Np(l){if(!l.metadata||!l.metadata.content_area)return;const t=o.q.devicePixelRatio,{left:n,top:c,width:d,height:f}=l.metadata.content_area,m=n*t,y=c*t;return[m,y,m+d*t,y+f*t]}function Ld(l){if(l)return l.map(([t,n])=>[t*o.q.devicePixelRatio,n*o.q.devicePixelRatio])}class Dd{constructor(t,n,c){this.id=t,this.scope=n,this.sourceCache=c,this.pendingRequests=new Set,this.missingRequests=new Set}addPendingRequest(t){this.missingRequests.has(t.name)||this.pendingRequests.has(t.name)||this.pendingRequests.add(t.name)}hasPendingRequests(){return this.pendingRequests.size>0}resolvePendingRequests(){const t=new Map;if(!this.sourceCache.loaded())return t;const n=this.sourceCache.getVisibleCoordinates();if(n.length===0)return t;const c=this.sourceCache.getSource();if(!(c instanceof to))return t;const d=n.map(m=>this.sourceCache.getTile(m)),f=c.getImages(d,Array.from(this.pendingRequests));for(const[m,y]of f)t.set(o.I.from({name:m,iconsetId:this.id}),y),this.pendingRequests.delete(m);for(const m of this.pendingRequests)this.missingRequests.add(m);return this.pendingRequests.clear(),t}}const Go=(l,t)=>Q(l,t&&t.filter(n=>n.identifier!=="source.canvas")),Wu=o.aF(vi,["addLayer","removeLayer","setLights","setPaintProperty","setLayoutProperty","setSlot","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setSnow","setRain","setProjection","setCamera","addImport","removeImport","updateImport","addIconset","removeIconset"]),Od=o.aF(vi,["setCenter","setZoom","setBearing","setPitch"]),Ac=new Set(["background","sky","slot","custom"]),Xu={version:8,layers:[],sources:{}},Yu={duration:300,delay:0};class un extends o.E{constructor(t,n={}){super(),this.map=t,this.scope=n.scope||"",this.globalId=null,this.fragments=[],this.importDepth=n.importDepth||0,this.importsCache=n.importsCache||new Map,this.resolvedImports=n.resolvedImports||new Set,this.transition=o.h({},Yu),this._buildingIndex=new Cd(this),this.crossTileSymbolIndex=new In,this._mergedOrder=[],this._drapedFirstOrder=[],this._mergedLayers={},this._mergedSourceCaches={},this._mergedOtherSourceCaches={},this._mergedSymbolSourceCaches={},this._clipLayerPresent=!1,this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this._changes=n.styleChanges||new Br,this.dispatcher=n.dispatcher?n.dispatcher:new o.D(o.c$(),this),n.imageManager?this.imageManager=n.imageManager:(this.imageManager=new Ws(this.map._spriteFormat),this.imageManager.setEventedParent(this)),this.imageManager.addScope(this.scope),this.glyphManager=n.glyphManager?n.glyphManager:new o.d0(t._requestManager,n.localFontFamily?o.d1.all:n.localIdeographFontFamily?o.d1.ideographs:o.d1.none,n.localFontFamily||n.localIdeographFontFamily),n.modelManager?this.modelManager=n.modelManager:(this.modelManager=new zd(t._requestManager),this.modelManager.setEventedParent(this)),this._layers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._precompileDone=!1,this._shouldPrecompile=!1,this._availableImages=[],this._availableModels={},this._order=[],this._markersNeedUpdate=!1,this.options=n.configOptions?n.configOptions:new Map,this._configDependentLayers=n.configDependentLayers?n.configDependentLayers:new Set,this._config=n.config,this._styleColorTheme={lut:null,lutLoading:!1,lutLoadingCorrelationID:0,colorTheme:null,colorThemeOverride:n.colorThemeOverride},this._styleColorThemeForScope={},this._initialConfig=n.initialConfig,this.dispatcher.broadcast("setReferrer",o.d2());const c=this;this._rtlTextPluginCallback=un.registerForPluginStateChange(d=>{c.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:d.pluginStatus,pluginURL:d.pluginURL},(f,m)=>{if(o.d3(f),m&&m.every(y=>y))for(const y in c._sourceCaches){const v=c._sourceCaches[y],T=v.getSource().type;T!=="vector"&&T!=="geojson"||v.reload()}})}),this.on("data",d=>{if(d.dataType!=="source"||d.sourceDataType!=="metadata")return;const f=this.getOwnSource(d.sourceId);if(f&&f.vectorLayerIds)for(const m in this._layers){const y=this._layers[m];y.source===f.id&&this._validateLayer(y)}})}load(t){return t?(typeof t=="string"?this.loadURL(t):this.loadJSON(t),this):this}_getGlobalId(t){if(!t)return null;if(typeof t=="string"){if(o.j(t))return t;const n=o.d4(t);if(!n.startsWith("http"))try{return new URL(n,location.href).toString()}catch{return n}return n}return`json://${o.d5(JSON.stringify(t))}`}_diffStyle(t,n,c){this.globalId=this._getGlobalId(t);const d=(f,m)=>{try{m(null,this.setState(f,c))}catch(y){m(y,!1)}};if(typeof t=="string"){const f=this.map._requestManager.normalizeStyleURL(t),m=this.map._requestManager.transformRequest(f,o.R.Style);o.n(m,(y,v)=>{y?this.fire(new o.z(y)):v&&d(v,n)})}else typeof t=="object"&&d(t,n)}loadURL(t,n={}){this.fire(new o.A("dataloading",{dataType:"style"}));const c=typeof n.validate=="boolean"?n.validate:!o.j(t);this.globalId=this._getGlobalId(t),t=this.map._requestManager.normalizeStyleURL(t,n.accessToken),this.resolvedImports.add(t);const d=this.importsCache.get(t);if(d)return this._load(d,c);const f=this.map._requestManager.transformRequest(t,o.R.Style);this._request=o.n(f,(m,y)=>{if(this._request=null,m)this.fire(new o.z(m));else if(y)return this.importsCache.set(t,y),this._load(y,c)})}loadJSON(t,n={}){this.fire(new o.A("dataloading",{dataType:"style"})),this.globalId=this._getGlobalId(t),this._request=o.q.frame(()=>{this._request=null,this._load(t,n.validate!==!1)})}loadEmpty(){this.fire(new o.A("dataloading",{dataType:"style"})),this._load(Xu,!1)}_loadImports(t,n,c){if(this.importDepth>=4)return o.w("Style doesn't support nesting deeper than 5"),Promise.resolve();const d=[];for(const f of t){const m=this._createFragmentStyle(f),y=new Promise(S=>{m.once("style.import.load",S),m.once("error",S)}).then(()=>this.mergeAll());if(d.push(y),this.resolvedImports.has(f.url)){m.loadEmpty();continue}const v=f.data||this.importsCache.get(f.url);v?(m.loadJSON(v,{validate:n}),this._isInternalStyle(v)&&(m.globalId=null)):f.url?m.loadURL(f.url,{validate:n}):m.loadEmpty();const T={style:m,id:f.id,config:f.config};if(c){const S=this.fragments.findIndex(({id:C})=>C===c);this.fragments=this.fragments.slice(0,S).concat(T).concat(this.fragments.slice(S))}else this.fragments.push(T)}return Promise.allSettled(d)}getImportGlobalIds(t=this,n=new Set){for(const c of t.fragments)c.style.globalId&&n.add(c.style.globalId),this.getImportGlobalIds(c.style,n);return[...n.values()]}_createFragmentStyle(t){const n=this.scope?o.C(t.id,this.scope):t.id;let c;const d=this._initialConfig&&this._initialConfig[n];(t.config||d)&&(c=o.h({},t.config,d));const f=new un(this.map,{scope:n,styleChanges:this._changes,importDepth:this.importDepth+1,importsCache:this.importsCache,resolvedImports:new Set(this.resolvedImports),dispatcher:this.dispatcher,imageManager:this.imageManager,glyphManager:this.glyphManager,modelManager:this.modelManager,config:c,configOptions:this.options,colorThemeOverride:t["color-theme"],configDependentLayers:this._configDependentLayers});return f.setEventedParent(this.map,{style:f}),f}_reloadImports(){this.mergeAll(),this._updateMapProjection(),this.updateConfigDependencies(),this.map._triggerCameraUpdate(this.camera),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),this._shouldPrecompile=this.map._precompilePrograms&&this.isRootStyle()}_isInternalStyle(t){return this.isRootStyle()&&(t.fragment||!!t.schema&&t.fragment!==!1)}_load(t,n){const c=t.indoor?Ls(t.schema):t.schema;if(this._isInternalStyle(t)){const m=o.h({},Xu,{imports:[{id:"basemap",data:t,url:""}]});return void this._load(m,n)}if(this.updateConfig(this._config,c),n&&Go(this,zn(t)))return;this._loaded=!0,this.stylesheet=o.d6(t);const d=()=>{for(const T in t.sources)this.addSource(T,t.sources[T],{validate:!1,isInitialLoad:!0});if(t.iconsets)for(const T in t.iconsets)this.addIconset(T,t.iconsets[T]);t.sprite?this._loadIconset(t.sprite):(this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0})),this.setGlyphsUrl(t.glyphs);const m=fl(this.stylesheet.layers);if(this._order=m.map(T=>T.id),this.stylesheet.light&&o.w("The `light` root property is deprecated, prefer using `lights` with `flat` light type instead."),this.stylesheet.lights)if(this.stylesheet.lights.length===1&&this.stylesheet.lights[0].type==="flat"){const T=this.stylesheet.lights[0];this.light=new xe(T.properties,T.id)}else this.setLights(this.stylesheet.lights);this.light||(this.light=new xe(this.stylesheet.light)),this._layers={};for(const T of m){const S=o.db(T,this.scope,this._styleColorTheme.lut,this.options);S.configDependencies.size!==0&&this._configDependentLayers.add(S.fqid),S.setEventedParent(this,{layer:{id:S.id}}),this._layers[S.id]=S;const C=this.getOwnLayerSourceCache(S),I=!!this.directionalLight&&this.directionalLight.shadowsEnabled();C&&S.canCastShadows()&&I&&(C.castsShadows=!0)}this.stylesheet.featuresets&&this.setFeaturesetSelectors(this.stylesheet.featuresets),this.stylesheet.models&&this.addModelURLs(this.stylesheet.models);const y=this.stylesheet.terrain;y&&(this.checkCanvasFingerprintNoise(),this.disableElevatedTerrain||this.terrainSetForDrapingOnly()||this._createTerrain(y,1)),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this.stylesheet.snow&&this._createSnow(this.stylesheet.snow),this.stylesheet.rain&&this._createRain(this.stylesheet.rain),this.stylesheet.transition&&this.setTransition(this.stylesheet.transition),this.fire(new o.A("data",{dataType:"style"}));const v=this.isRootStyle();t.imports?this._loadImports(t.imports,n).then(()=>{this._reloadImports(),this.fire(new o.A(v?"style.load":"style.import.load"))}).catch(T=>{this.fire(new o.z(new Error("Failed to load imports",T))),this.fire(new o.A(v?"style.load":"style.import.load"))}):(this._reloadImports(),this.fire(new o.A(v?"style.load":"style.import.load")))};this._styleColorTheme.colorTheme=this.stylesheet["color-theme"];const f=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(f){const m=this._evaluateColorThemeData(f);this._loadColorTheme(m).then(()=>{d()}).catch(y=>{o.w(`Couldn't load color theme from the stylesheet: ${y}`),d()})}else this._styleColorTheme.lut=null,d()}isRootStyle(){return this.importDepth===0}mergeAll(){let t,n,c,d,f,m,y,v,T,S;const C={};this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(I=>{if(I.stylesheet){if(I.light!=null&&(t=I.light),I.stylesheet.lights)for(const M of I.stylesheet.lights)M.type==="ambient"&&I.ambientLight!=null&&(n=I.ambientLight),M.type==="directional"&&I.directionalLight!=null&&(c=I.directionalLight);d=this._prioritizeTerrain(d,I.terrain,I.stylesheet.terrain),I.stylesheet.fog&&I.fog!=null&&(f=I.fog),I.stylesheet.snow&&I.snow!=null&&(m=I.snow),I.stylesheet.rain&&I.rain!=null&&(y=I.rain),I.stylesheet.camera!=null&&(S=I.stylesheet.camera),I.stylesheet.projection!=null&&(v=I.stylesheet.projection),I.stylesheet.transition!=null&&(T=I.stylesheet.transition),C[I.scope]=I._styleColorTheme}}),this.light=t,this.ambientLight=n,this.directionalLight=c,this.fog=f,this.snow=m,this.rain=y,this._styleColorThemeForScope=C,d===null?delete this.terrain:this.terrain=d,this.camera=S||{"camera-projection":"perspective"},this.projection=v||{name:"mercator"},this.transition=o.h({},Yu,T),this.mergeSources(),this.mergeLayers()}forEachFragmentStyle(t){const n=c=>{for(const d of c.fragments)n(d.style);t(c)};n(this)}_prioritizeTerrain(t,n,c){const d=t&&t.drapeRenderMode===0;return c===null?n&&n.drapeRenderMode===0?n:d?t:null:n!=null&&(!t||d||n&&n.drapeRenderMode===1)?n:t}mergeTerrain(){let t;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(n=>{t=this._prioritizeTerrain(t,n.terrain,n.stylesheet.terrain)}),t===null?delete this.terrain:this.terrain=t}mergeProjection(){let t;this.forEachFragmentStyle(n=>{n.stylesheet.projection!=null&&(t=n.stylesheet.projection)}),this.projection=t||{name:"mercator"}}mergeSources(){const t={},n={},c={};this.forEachFragmentStyle(d=>{for(const f in d._sourceCaches){const m=o.C(f,d.scope);t[m]=d._sourceCaches[f]}for(const f in d._otherSourceCaches){const m=o.C(f,d.scope);n[m]=d._otherSourceCaches[f]}for(const f in d._symbolSourceCaches){const m=o.C(f,d.scope);c[m]=d._symbolSourceCaches[f]}}),this._mergedSourceCaches=t,this._mergedOtherSourceCaches=n,this._mergedSymbolSourceCaches=c}mergeLayers(){const t={},n=[],c={};this._mergedSlots=[],this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this.forEachFragmentStyle(f=>{for(const m of f._order){const y=f._layers[m];if(y.type==="slot"){const v=o.d7(m);if(t[v])continue;t[v]=[]}y.slot&&t[y.slot]?t[y.slot].push(y):n.push(y)}}),this._mergedOrder=[];const d=(f=[])=>{for(const m of f)if(m.type==="slot"){const y=o.d7(m.id);t[y]&&d(t[y]),this._mergedSlots.push(y)}else{const y=o.C(m.id,m.scope);this._mergedOrder.push(y),c[y]=m,m.is3D(!!this.terrain)&&(this._has3DLayers=!0),m.type==="circle"&&(this._hasCircleLayers=!0),m.type==="symbol"&&(this._hasSymbolLayers=!0),m.type==="clip"&&(this._clipLayerPresent=!0)}};d(n),this._mergedOrder.sort((f,m)=>{const y=c[f],v=c[m];return y.hasInitialOcclusionOpacityProperties?v.is3D(!!this.terrain)?1:0:y.is3D(!!this.terrain)&&v.hasInitialOcclusionOpacityProperties?-1:0}),this._mergedLayers=c,this.updateDrapeFirstLayers(),this._buildingIndex.processLayersChanged()}terrainSetForDrapingOnly(){return!!this.terrain&&this.terrain.drapeRenderMode===0}getCamera(){return this.stylesheet.camera}setCamera(t){return this.stylesheet.camera=o.h({},this.stylesheet.camera,t),this.camera=this.stylesheet.camera,this}_evaluateColorThemeData(t){return t.data?function(n,c,d,f){const m=o.h({},c);for(const v of Object.keys(o.a5.colorTheme))m[v]===void 0&&(m[v]=o.a5.colorTheme[v].default);const y=new o.a6(Ic,n,new Map(d));return y.setTransitionOrValue(m,d),y.untransitioned().possiblyEvaluate(new o.aa(0,{worldview:void 0}))}(this.scope,t,this.options).get("data"):null}_loadColorTheme(t){this._styleColorTheme.lutLoading=!0,this._styleColorTheme.lutLoadingCorrelationID+=1;const n=this._styleColorTheme.lutLoadingCorrelationID;return new Promise((c,d)=>{const f="data:image/png;base64,";if(!t||t.length===0)return this._styleColorTheme.lut=null,this._styleColorTheme.lutLoading=!1,void c();let m=t;m.startsWith(f)||(m=f+m);const y=o.I.from("mapbox-reserved-lut"),v=new Image;v.src=m,v.onerror=()=>{this._styleColorTheme.lutLoading=!1,d(new Error("Failed to load image data"))},v.onload=()=>{if(this._styleColorTheme.lutLoadingCorrelationID!==n)return void c();this._styleColorTheme.lutLoading=!1;const{width:T,height:S,data:C}=o.q.getImageData(v);if(S>32)return void d(new Error("The height of the image must be less than or equal to 32 pixels."));if(T!==S*S)return void d(new Error("The width of the image must be equal to the height squared."));this.getImage(y)&&this.removeImage(y),this.addImage(y,{data:new o.r({width:T,height:S},C),pixelRatio:1,sdf:!1,usvg:!1,version:0});const I=this.imageManager.getImage(y,this.scope);I?(this._styleColorTheme.lut={image:I.data,data:t},c()):d(new Error("Missing LUT image."))}})}getLut(t){const n=this._styleColorThemeForScope[t];return n?n.lut:null}setProjection(t){t?this.stylesheet.projection=t:delete this.stylesheet.projection,this.mergeProjection(),this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?(this.getTerrain()||this.stylesheet.terrain)&&!this.disableElevatedTerrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null,0))}_updateMapProjection(){this.isRootStyle()&&(this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.projection))}_loadSprite(t){this._spriteRequest=function(n,c,d){let f,m,y;const v=o.q.devicePixelRatio>1?"@2x":"";let T=o.n(c.transformRequest(c.normalizeSpriteURL(n,v,".json"),o.R.SpriteJSON),(I,M)=>{T=null,y||(y=I,f=M,C())}),S=o.o(c.transformRequest(c.normalizeSpriteURL(n,v,".png"),o.R.SpriteImage),(I,M)=>{S=null,y||(y=I,m=M,C())});function C(){if(y)d(y);else if(f&&m){const I=o.q.getImageData(m),M={};for(const D in f){const{width:z,height:O,x:B,y:V,sdf:H,pixelRatio:Y,stretchX:te,stretchY:ee,content:J}=f[D],K=new o.r({width:z,height:O});o.r.copy(I,K,{x:B,y:V},{x:0,y:0},{width:z,height:O},null),M[D]={data:K,pixelRatio:Y,sdf:H,stretchX:te,stretchY:ee,content:J,usvg:!1}}d(null,M)}}return{cancel(){T&&(T.cancel(),T=null),S&&(S.cancel(),S=null)}}}(t,this.map._requestManager,(n,c)=>{if(this._spriteRequest=null,n)this.fire(new o.z(n));else if(c){const d=new Map;for(const f in c)d.set(o.I.from(f),c[f]);this.addImages(d)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new o.A("data",{dataType:"style"}))})}addIconset(t,n){if(n.type==="sprite")return void this._loadSprite(n.url);const c=this.getOwnSourceCache(n.source);if(!c)return void this.fire(new o.z(new Error(`Source "${n.source}" as specified by iconset "${t}" does not exist and cannot be used as an iconset source`)));const d=c.getSource();if(d.type!=="raster-array")return void this.fire(new o.z(new Error(`Source "${n.source}" as specified by iconset "${t}" is not a "raster-array" source and cannot be used as an iconset source`)));d.partial=!1;const f=new Dd(t,this.scope,c);this.imageManager.addImageProvider(f,this.scope)}removeIconset(t){this.imageManager.removeImageProvider(t,this.scope)}_loadIconset(t){if(!o.j(t)&&this.map._spriteFormat!=="icon_set"||this.map._spriteFormat==="raster")return void this._loadSprite(t);const n=this.map._spriteFormat==="auto";var c,d;this._spriteRequest=(d=(f,m)=>{if(this._spriteRequest=null,f)n?this._loadSprite(t):this.fire(new o.z(f));else if(m){const y=new Map;for(const v in m)y.set(o.I.from(v),m[v]);this.addImages(y)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new o.A("data",{dataType:"style"}))},o.br((c=this.map._requestManager).transformRequest(c.normalizeIconsetURL(t),o.R.Iconset),(f,m)=>{if(f)return void d(f);const y={},v=o.c_(new o.bq(m));for(const T of v.icons){const S={version:1,pixelRatio:o.q.devicePixelRatio,content:Np(T),stretchX:T.metadata?Ld(T.metadata.stretch_x_areas):void 0,stretchY:T.metadata?Ld(T.metadata.stretch_y_areas):void 0,sdf:!1,usvg:!0,icon:T};y[T.name]=S}d(null,y)}))}_validateLayer(t){const n=this.getOwnSource(t.source);if(!n)return;const c=t.sourceLayer;c&&(n.type==="geojson"||n.vectorLayerIds&&n.vectorLayerIds.indexOf(c)===-1)&&this.fire(new o.z(new Error(`Source layer "${c}" does not exist on source "${n.id}" as specified by style layer "${t.id}"`)))}loaded(){if(!this._loaded||Object.keys(this._changes.getUpdatedSourceCaches()).length)return!1;for(const t in this._sourceCaches)if(!this._sourceCaches[t].loaded())return!1;if(!this.imageManager.isLoaded()||this.imageManager.hasPatternsInFlight()||!this.modelManager.isLoaded()||this._styleColorTheme.lutLoading)return!1;for(const{style:t}of this.fragments)if(!t.loaded())return!1;return!0}_serializeImports(){if(this.stylesheet.imports)return this.stylesheet.imports.map((t,n)=>{const c=this.fragments[n];return c&&c.style&&(t.data=c.style.serialize()),t})}_serializeSources(){const t={};for(const n in this._sourceCaches){const c=this._sourceCaches[n].getSource();t[c.id]||(t[c.id]=c.serialize())}return t}_serializeLayers(t){const n=[];for(const c of t){const d=this._layers[c];d&&d.type!=="custom"&&n.push(d.serialize())}return n}hasLightTransitions(){return!(!this.light||!this.light.hasTransition())||!(!this.ambientLight||!this.ambientLight.hasTransition())||!(!this.directionalLight||!this.directionalLight.hasTransition())}hasFogTransition(){return!!this.fog&&this.fog.hasTransition()}hasSnowTransition(){return!!this.snow&&this.snow.hasTransition()}hasRainTransition(){return!!this.rain&&this.rain.hasTransition()}hasTransitions(){if(this.hasLightTransitions()||this.hasFogTransition()||this.hasSnowTransition()||this.hasRainTransition())return!0;for(const t in this._sourceCaches)if(this._sourceCaches[t].hasTransition())return!0;for(const t in this._layers)if(this._layers[t].hasTransition())return!0;return!1}get order(){return this.terrain?this._drapedFirstOrder:this._mergedOrder}_getOrder(t){return t?this.order:this._mergedOrder}isLayerDraped(t){return!!this.terrain&&t.isDraped(this.getLayerSourceCache(t))}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}_checkLayer(t){const n=this.getOwnLayer(t);if(n)return n;this.fire(new o.z(new Error(`The layer '${t}' does not exist in the map's style.`)))}_checkSource(t){const n=this.getOwnSource(t);if(n)return n;this.fire(new o.z(new Error(`The source '${t}' does not exist in the map's style.`)))}precompilePrograms(t,n){const c=this.map.painter;if(c)for(let d=t.minzoom||0;d<(t.maxzoom||25.5);d++){const f=t.getProgramIds();if(f)for(const m of f){const y=t.getDefaultProgramParams(m,n.zoom,this._styleColorTheme.lut);y&&(c.style=this,this.fog&&(c._fogVisible=!0,y.overrideFog=!0,c.getOrCreateProgram(m,y)),c._fogVisible=!1,y.overrideFog=!1,c.getOrCreateProgram(m,y),(this.stylesheet.terrain||this.stylesheet.projection&&this.stylesheet.projection.name==="globe")&&(y.overrideRtt=!0,c.getOrCreateProgram(m,y)))}}}update(t){if(!this._loaded)return;this.ambientLight&&this.ambientLight.recalculate(t),this.directionalLight&&this.directionalLight.recalculate(t);const n=this.calculateLightsBrightness();t.brightness=n||0,n!==this._brightness&&(this._brightness=n,this.dispatcher.broadcast("setBrightness",n)),t.worldview!==this._worldview&&(this._worldview=t.worldview,this.dispatcher.broadcast("setWorldview",this._worldview));const c=this._changes.isDirty();let d=!1;if(this._changes.isDirty()){const y=this._changes.getLayerUpdatesByScope();for(const v in y){const{updatedIds:T,removedIds:S}=y[v];(T||S)&&(this._updateWorkerLayers(v,T,S),d=!0)}this.updateSourceCaches(),this._updateTilesForChangedImages(),this.updateLayers(t),this.light&&this.light.updateTransitions(t),this.ambientLight&&this.ambientLight.updateTransitions(t),this.directionalLight&&this.directionalLight.updateTransitions(t),this.fog&&this.fog.updateTransitions(t),this.snow&&this.snow.updateTransitions(t),this.rain&&this.rain.updateTransitions(t),this._changes.reset()}const f={};for(const y in this._mergedSourceCaches){const v=this._mergedSourceCaches[y];f[y]=v.used,v.used=!1,v.tileCoverLift=0}for(const y of this._mergedOrder){const v=this._mergedLayers[y];if(v.recalculate(t,this._availableImages),!v.isHidden(t.zoom)){const T=this.getLayerSourceCache(v);T&&(T.used=!0,T.tileCoverLift=Math.max(T.tileCoverLift,v.tileCoverLift()))}!this._precompileDone&&this._shouldPrecompile&&("requestIdleCallback"in window?requestIdleCallback(()=>{this.precompilePrograms(v,t)}):this.precompilePrograms(v,t))}this._shouldPrecompile&&(this._precompileDone=!0),this.terrain&&d&&this.mergeLayers();const m=this.imageManager.getPendingImageProviders();for(const y of m)y.sourceCache.used=!0;for(const y in f){const v=this._mergedSourceCaches[y];f[y]!==v.used&&v.getSource().fire(new o.A("data",{sourceDataType:"visibility",dataType:"source",sourceId:v.getSource().id}))}this.light&&this.light.recalculate(t),this.terrain&&this.terrain.recalculate(t),this.fog&&this.fog.recalculate(t),this.snow&&this.snow.recalculate(t),this.rain&&this.rain.recalculate(t),this.z=t.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),this.imageManager.clearUpdatedImages(this.scope),c&&this.fire(new o.A("data",{dataType:"style"}))}updateImageProviders(){const t=this.imageManager.getPendingImageProviders();for(const n of t){const c=n.resolvePendingRequests(),d=this.getFragmentStyle(n.scope);d&&d.addImages(c)}}_updateTilesForChangedImages(){const t={};for(const n in this._mergedSourceCaches){const c=this._mergedSourceCaches[n].getSource().scope;t[c]=t[c]||this._changes.getUpdatedImages(c),t[c].length!==0&&this._mergedSourceCaches[n].reloadTilesForDependencies(["icons","patterns"],t[c])}for(const n in t)this._changes.resetUpdatedImages(n)}_updateWorkerLayers(t,n,c){const d=this.getFragmentStyle(t);d&&this.dispatcher.broadcast("updateLayers",{layers:n?d._serializeLayers(n):[],scope:t,removedIds:c||[],options:d.options})}setState(t,n){if(this._checkLoaded(),Go(this,zn(t)))return!1;(t=o.d6(t)).layers=fl(t.layers);const c=function(m,y){if(!m)return[{command:vi.setStyle,args:[y]}];let v=[];try{if(!o.bv(m.version,y.version))return[{command:vi.setStyle,args:[y]}];if(o.bv(m.center,y.center)||v.push({command:vi.setCenter,args:[y.center]}),o.bv(m.zoom,y.zoom)||v.push({command:vi.setZoom,args:[y.zoom]}),o.bv(m.bearing,y.bearing)||v.push({command:vi.setBearing,args:[y.bearing]}),o.bv(m.pitch,y.pitch)||v.push({command:vi.setPitch,args:[y.pitch]}),o.bv(m.sprite,y.sprite)||v.push({command:vi.setSprite,args:[y.sprite]}),o.bv(m.glyphs,y.glyphs)||v.push({command:vi.setGlyphs,args:[y.glyphs]}),o.bv(m.imports,y.imports)||function(M=[],D=[],z){D=D||[];const O=(M=M||[]).map(Oo),B=D.map(Oo),V=M.reduce(io,{}),H=D.reduce(io,{}),Y=O.slice();let te,ee,J,K;for(te=0,ee=0;te<O.length;te++)J=O[te],H.hasOwnProperty(J)?ee++:(z.push({command:vi.removeImport,args:[J]}),Y.splice(Y.indexOf(J,ee),1));for(te=0,ee=0;te<B.length;te++)J=B[B.length-1-te],Y[Y.length-1-te]!==J&&(V.hasOwnProperty(J)?(z.push({command:vi.removeImport,args:[J]}),Y.splice(Y.lastIndexOf(J,Y.length-ee),1)):ee++,K=Y[Y.length-te],z.push({command:vi.addImport,args:[H[J],K]}),Y.splice(Y.length-te,0,J));for(const ie of D){const se=V[ie.id];se&&(delete se.data,o.bv(se,ie)||z.push({command:vi.updateImport,args:[ie.id,ie]}))}}(m.imports,y.imports,v),o.bv(m.transition,y.transition)||v.push({command:vi.setTransition,args:[y.transition]}),o.bv(m.light,y.light)||v.push({command:vi.setLight,args:[y.light]}),o.bv(m.fog,y.fog)||v.push({command:vi.setFog,args:[y.fog]}),o.bv(m.snow,y.snow)||v.push({command:vi.setSnow,args:[y.snow]}),o.bv(m.rain,y.rain)||v.push({command:vi.setRain,args:[y.rain]}),o.bv(m.projection,y.projection)||v.push({command:vi.setProjection,args:[y.projection]}),o.bv(m.lights,y.lights)||v.push({command:vi.setLights,args:[y.lights]}),o.bv(m.camera,y.camera)||v.push({command:vi.setCamera,args:[y.camera]}),o.bv(m.iconsets,y.iconsets)||function(M,D,z){let O;for(O in D=D||{},M=M||{})M.hasOwnProperty(O)&&(D.hasOwnProperty(O)||z.push({command:vi.removeIconset,args:[O]}));for(O in D){if(!D.hasOwnProperty(O))continue;const B=D[O];M.hasOwnProperty(O)?o.bv(M[O],B)||(z.push({command:vi.removeIconset,args:[O]}),z.push({command:vi.addIconset,args:[O,B]})):z.push({command:vi.addIconset,args:[O,B]})}}(m.iconsets,y.iconsets,v),!o.bv(m["color-theme"],y["color-theme"]))return[{command:vi.setStyle,args:[y]}];const T={},S=[];(function(M,D,z,O){let B;for(B in D=D||{},M=M||{})M.hasOwnProperty(B)&&(D.hasOwnProperty(B)||da(B,z,O));for(B in D){if(!D.hasOwnProperty(B))continue;const V=D[B];M.hasOwnProperty(B)?o.bv(M[B],V)||(M[B].type==="geojson"&&V.type==="geojson"&&Lp(M,D,B)?z.push({command:vi.setGeoJSONSourceData,args:[B,V.data]}):pl(B,D,z,O)):gc(B,D,z)}})(m.sources,y.sources,S,T);const C=[];m.layers&&m.layers.forEach(M=>{M.source&&T[M.source]?v.push({command:vi.removeLayer,args:[M.id]}):C.push(M)});let I=m.terrain;I&&T[I.source]&&(v.push({command:vi.setTerrain,args:[void 0]}),I=void 0),v=v.concat(S),o.bv(I,y.terrain)||v.push({command:vi.setTerrain,args:[y.terrain]}),function(M,D,z){D=D||[];const O=(M=M||[]).map(Oo),B=D.map(Oo),V=M.reduce(io,{}),H=D.reduce(io,{}),Y=O.slice(),te=Object.create(null);let ee,J,K,ie,se,ye,ve;for(ee=0,J=0;ee<O.length;ee++)K=O[ee],H.hasOwnProperty(K)?J++:(z.push({command:vi.removeLayer,args:[K]}),Y.splice(Y.indexOf(K,J),1));for(ee=0,J=0;ee<B.length;ee++)K=B[B.length-1-ee],Y[Y.length-1-ee]!==K&&(V.hasOwnProperty(K)?(z.push({command:vi.removeLayer,args:[K]}),Y.splice(Y.lastIndexOf(K,Y.length-J),1)):J++,ye=Y[Y.length-ee],z.push({command:vi.addLayer,args:[H[K],ye]}),Y.splice(Y.length-ee,0,K),te[K]=!0);for(ee=0;ee<B.length;ee++)if(K=B[ee],ie=V[K],se=H[K],!te[K]&&!o.bv(ie,se))if(o.bv(ie.source,se.source)&&o.bv(ie["source-layer"],se["source-layer"])&&o.bv(ie.type,se.type)){for(ve in ml(ie.layout,se.layout,z,K,null,vi.setLayoutProperty),ml(ie.paint,se.paint,z,K,null,vi.setPaintProperty),o.bv(ie.slot,se.slot)||z.push({command:vi.setSlot,args:[K,se.slot]}),o.bv(ie.filter,se.filter)||z.push({command:vi.setFilter,args:[K,se.filter]}),o.bv(ie.minzoom,se.minzoom)&&o.bv(ie.maxzoom,se.maxzoom)||z.push({command:vi.setLayerZoomRange,args:[K,se.minzoom,se.maxzoom]}),ie)ie.hasOwnProperty(ve)&&ve!=="layout"&&ve!=="paint"&&ve!=="filter"&&ve!=="metadata"&&ve!=="minzoom"&&ve!=="maxzoom"&&ve!=="slot"&&(ve.indexOf("paint.")===0?ml(ie[ve],se[ve],z,K,ve.slice(6),vi.setPaintProperty):o.bv(ie[ve],se[ve])||z.push({command:vi.setLayerProperty,args:[K,ve,se[ve]]}));for(ve in se)se.hasOwnProperty(ve)&&!ie.hasOwnProperty(ve)&&ve!=="layout"&&ve!=="paint"&&ve!=="filter"&&ve!=="metadata"&&ve!=="minzoom"&&ve!=="maxzoom"&&ve!=="slot"&&(ve.indexOf("paint.")===0?ml(ie[ve],se[ve],z,K,ve.slice(6),vi.setPaintProperty):o.bv(ie[ve],se[ve])||z.push({command:vi.setLayerProperty,args:[K,ve,se[ve]]}))}else z.push({command:vi.removeLayer,args:[K]}),ye=Y[Y.lastIndexOf(K)+1],z.push({command:vi.addLayer,args:[se,ye]})}(C,y.layers,v)}catch(T){console.warn("Unable to compute style diff:",T),v=[{command:vi.setStyle,args:[y]}]}return v}(this.serialize(),t).filter(m=>!(m.command in Od));if(c.length===0)return!1;const d=c.filter(m=>!(m.command in Wu));if(d.length>0)throw new Error(`Unimplemented: ${d.map(m=>m.command).join(", ")}.`);const f=[];return c.forEach(m=>{f.push(this[m.command](...m.args))}),n&&Promise.all(f).then(n).catch(n),this.stylesheet=t,this.mergeAll(),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),!0}_updateWorkerImages(){this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages})}_updateWorkerModels(){this._availableModels=this.modelManager.getModelURIs(this.scope),this.dispatcher.broadcast("setModels",{scope:this.scope,models:this._availableModels})}addImages(t){for(const[n,c]of t.entries()){if(this.getImage(n))return this.fire(new o.z(new Error(`An image with the name "${n.name}" already exists.`)));this.imageManager.addImage(n,this.scope,c),this._changes.updateImage(n,this.scope)}return this._updateWorkerImages(),this.fire(new o.A("data",{dataType:"style"})),this}addImage(t,n){return this.getImage(t)?this.fire(new o.z(new Error(`An image with the name "${t.name}" already exists.`))):(this.imageManager.addImage(t,this.scope,n),this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new o.A("data",{dataType:"style"})),this)}updateImage(t,n,c=!1){this.imageManager.updateImage(t,this.scope,n),c&&(this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new o.A("data",{dataType:"style"})))}getImage(t){return this.imageManager.getImage(t,this.scope)}removeImage(t){return this.getImage(t)?(this.imageManager.removeImage(t,this.scope),this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new o.A("data",{dataType:"style"})),this):this.fire(new o.z(new Error("No image with this name exists.")))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addModelURLs(t){return this.modelManager.addModelURLs(t,this.scope),this._updateWorkerModels(),this.fire(new o.A("data",{dataType:"style"})),this}addModel(t,n,c={}){return this._checkLoaded(),this._validate(X,`models.${t}`,n,null,c)||(this.modelManager.addModel(t,n,this.scope),this.fire(new o.A("data",{dataType:"style"}))),this}hasModel(t){return this.modelManager.hasModel(t,this.scope)}removeModel(t){return this.hasModel(t)?(this.modelManager.removeModel(t,this.scope),this.fire(new o.A("data",{dataType:"style"})),this):this.fire(new o.z(new Error("No model with this ID exists.")))}listModels(){return this._checkLoaded(),this.modelManager.listModels(this.scope)}addSource(t,n,c={}){if(this._checkLoaded(),this.getOwnSource(t)!==void 0)throw new Error(`There is already a source with ID "${t}".`);if(!n.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(n).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(n.type)>=0&&this._validate(ku,`sources.${t}`,n,null,c))return;this.map&&this.map._collectResourceTiming&&(n.collectResourceTiming=!0);const d=al(t,n,this.dispatcher,this);d.scope=this.scope,d.setEventedParent(this,()=>({isSourceLoaded:this._isSourceCacheLoaded(d.id),source:d.serialize(),sourceId:d.id}));const f=m=>{const y=(m?"symbol:":"other:")+d.id,v=o.C(y,this.scope),T=this._sourceCaches[y]=new En(v,d,m);(m?this._symbolSourceCaches:this._otherSourceCaches)[d.id]=T,T.onAdd(this.map)};f(!1),n.type!=="vector"&&n.type!=="geojson"||f(!0),d.onAdd&&d.onAdd(this.map),c.isInitialLoad||(this.mergeSources(),this._changes.setDirty())}removeSource(t){this._checkLoaded();const n=this.getOwnSource(t);if(!n)throw new Error("There is no source with this ID");for(const d in this._layers)if(this._layers[d].source===t)return this.fire(new o.z(new Error(`Source "${t}" cannot be removed while layer "${d}" is using it.`)));if(this.terrain&&this.terrain.scope===this.scope&&this.terrain.get().source===t)return this.fire(new o.z(new Error(`Source "${t}" cannot be removed while terrain is using it.`)));if(this.stylesheet.iconsets){const d=Object.entries(this.stylesheet.iconsets).find(([f,m])=>m.type==="source"&&m.source===t);if(d)return this.fire(new o.z(new Error(`Source "${t}" cannot be removed while iconset "${d[0]}" is using it.`)))}const c=this.getOwnSourceCaches(t);for(const d of c){const f=o.d7(d.id);delete this._sourceCaches[f],this._changes.discardSourceCacheUpdate(d.id),d.fire(new o.A("data",{sourceDataType:"metadata",dataType:"source",sourceId:d.getSource().id})),d.setEventedParent(null),d.clearTiles()}return delete this._otherSourceCaches[t],delete this._symbolSourceCaches[t],this.mergeSources(),n.setEventedParent(null),n.onRemove&&n.onRemove(this.map),this._changes.setDirty(),this}setGeoJSONSourceData(t,n){this._checkLoaded(),this.getOwnSource(t).setData(n),this._changes.setDirty()}getOwnSource(t){const n=this.getOwnSourceCache(t);return n&&n.getSource()}getOwnSources(){const t=[];for(const n in this._otherSourceCaches){const c=this.getOwnSourceCache(n);c&&t.push(c.getSource())}return t}areTilesLoaded(){const t=this._mergedSourceCaches;for(const n in t){const c=t[n]._tiles;for(const d in c){const f=c[d];if(f.state!=="loaded"&&f.state!=="errored")return!1}}return!0}setLights(t){if(this._checkLoaded(),!t)return delete this.ambientLight,void delete this.directionalLight;const n=this._getTransitionParameters();for(const f of t){if(this._validate(Ro,"lights",f))return;switch(f.type){case"ambient":if(this.ambientLight){const m=this.ambientLight;m.set(f),m.updateTransitions(n)}else this.ambientLight=new ki(f,ei||(ei=new o.a7({color:new o.a8(o.a5.properties_light_ambient.color),"color-use-theme":new o.a8({type:"string",default:"default","property-type":"data-constant"}),intensity:new o.a8(o.a5.properties_light_ambient.intensity)})),this.scope,this.options);break;case"directional":if(this.directionalLight){const m=this.directionalLight;m.set(f),m.updateTransitions(n)}else this.directionalLight=new ki(f,Zi||(Zi=new o.a7({direction:new o.an(o.a5.properties_light_directional.direction),color:new o.a8(o.a5.properties_light_directional.color),"color-use-theme":new o.a8({type:"string",default:"default","property-type":"data-constant"}),intensity:new o.a8(o.a5.properties_light_directional.intensity),"cast-shadows":new o.a8(o.a5.properties_light_directional["cast-shadows"]),"shadow-quality":new o.a8(o.a5.properties_light_directional["shadow-quality"]),"shadow-intensity":new o.a8(o.a5.properties_light_directional["shadow-intensity"])})),this.scope,this.options)}}const c=Object.assign(n,{worldview:this.map.getWorldview()}),d=new o.aa(this.z||0,c);this.ambientLight&&this.ambientLight.recalculate(d),this.directionalLight&&this.directionalLight.recalculate(d),this._brightness=this.calculateLightsBrightness(),this.dispatcher.broadcast("setBrightness",this._brightness)}calculateLightsBrightness(){const t=this.directionalLight,n=this.ambientLight;if(!t||!n)return;const c=I=>.2126*(I[0]<=.03928?I[0]/12.92:Math.pow((I[0]+.055)/1.055,2.4))+.7152*(I[1]<=.03928?I[1]/12.92:Math.pow((I[1]+.055)/1.055,2.4))+.0722*(I[2]<=.03928?I[2]/12.92:Math.pow((I[2]+.055)/1.055,2.4)),d=t.properties.get("color").toNonPremultipliedRenderColor(null).toArray01(),f=t.properties.get("intensity"),m=t.properties.get("direction"),y=1-o.cR(m.x,m.y,m.z)[2]/90,v=c(d)*f*y,T=n.properties.get("color").toNonPremultipliedRenderColor(null).toArray01(),S=n.properties.get("intensity"),C=c(T)*S;return Number(((v+C)/2).toFixed(6))}getBrightness(){return this._brightness}getLights(){if(!this.enable3dLights())return null;const t=[];return this.directionalLight&&t.push(this.directionalLight.get()),this.ambientLight&&t.push(this.ambientLight.get()),t}enable3dLights(){return!!this.ambientLight&&!!this.directionalLight}getFragmentStyle(t){if(t==null||t===""&&this.isRootStyle())return this;if(o.d8(t)){const n=o.d9(t),c=this.fragments.find(({id:f})=>f===n);if(!c)return;const d=o.d7(t);return c.style.getFragmentStyle(d)}{const n=this.fragments.find(({id:c})=>c===t);return n?n.style:void 0}}setFeaturesetSelectors(t){if(!t)return;const n={},c=(d,f="")=>`${d}::${f}`;this._featuresetSelectors={};for(const d in t){const f=this._featuresetSelectors[d]=[];for(const m of t[d].selectors){if(m.featureNamespace){const v=this.getOwnLayer(m.layer);if(!v){o.w(`Layer is undefined for selector: ${m.layer}`);continue}const T=c(v.source,v.sourceLayer);if(T in n&&n[T]!==m.featureNamespace){o.w(`"featureNamespace ${m.featureNamespace} of featureset ${d}'s selector is not associated to the same source, skip this selector`);continue}n[T]=m.featureNamespace}let y;if(m.properties)for(const v in m.properties){const T=o.X(m.properties[v]);T.result==="success"&&(y=y||{},y[v]=T.value)}f.push({layerId:m.layer,namespace:m.featureNamespace,properties:y,uniqueFeatureID:m._uniqueFeatureID})}}}getFeaturesetDescriptors(t){const n=this.getFragmentStyle(t);if(!n||!n.stylesheet.featuresets)return[];const c=[];for(const d in n.stylesheet.featuresets)c.push({featuresetId:d,importId:n.scope?n.scope:void 0});return c}getFeaturesetLayers(t,n){const c=this.getFragmentStyle(n),d=c.stylesheet.featuresets;if(!d||!d[t])return this.fire(new o.z(new Error(`The featureset '${t}' does not exist in the map's style and cannot be queried.`))),[];const f=[];for(const m of d[t].selectors){const y=c.getOwnLayer(m.layer);y&&f.push(y)}return f}getConfigProperty(t,n){const c=this.getFragmentStyle(t);if(!c)return null;const d=o.C(n,c.scope),f=c.options.get(d),m=f?f.value||f.default:null;return m?m.serialize():null}setConfigProperty(t,n,c){const d=this.getFragmentStyle(t);if(!d)return;const f=d.stylesheet.indoor?Ls(d.stylesheet.schema):d.stylesheet.schema;if(!f||!f[n])return;const m=o.X(c);if(m.result!=="success")return void Go(this,m.value);const y=m.value.expression,v=o.C(n,d.scope),T=d.options.get(v);if(!T)return;let S;const{minValue:C,maxValue:I,stepValue:M,type:D,values:z}=f[n],O=o.X(f[n].default);O.result==="success"&&(S=O.value.expression),S?(this.options.set(v,Object.assign({},T,{value:y,default:S,minValue:C,maxValue:I,stepValue:M,type:D,values:z})),this.updateConfigDependencies(n)):this.fire(new o.z(new Error(`No schema defined for the config option "${n}" in the "${t}" fragment.`)))}getConfig(t){const n=this.getFragmentStyle(t);if(!n)return null;const c=n.stylesheet.schema;if(!c)return null;const d={};for(const f in c){const m=o.C(f,n.scope),y=n.options.get(m),v=y?y.value||y.default:null;d[f]=v?v.serialize():null}return d}setConfig(t,n){const c=this.getFragmentStyle(t);c&&(c.updateConfig(n,c.stylesheet.schema),this.updateConfigDependencies())}getSchema(t){const n=this.getFragmentStyle(t);return n?n.stylesheet.schema:null}setSchema(t,n){const c=this.getFragmentStyle(t);c&&(c.stylesheet.schema=n,c.updateConfig(c._config,n),this.updateConfigDependencies())}updateConfig(t,n){if(this._config=t,t||n)if(n)for(const c in n){let d,f;const m=o.X(n[c].default);if(m.result==="success"&&(d=m.value.expression),t&&t[c]!==void 0){const I=o.X(t[c]);I.result==="success"&&(f=I.value.expression)}const{minValue:y,maxValue:v,stepValue:T,type:S,values:C}=n[c];if(d){const I=o.C(c,this.scope);this.options.set(I,{default:d,value:f,minValue:y,maxValue:v,stepValue:T,type:S,values:C})}else this.fire(new o.z(new Error(`No schema defined for config option "${c}".`)))}else this.fire(new o.z(new Error("Attempting to set config for a style without schema.")))}updateConfigDependencies(t){for(const n of this._configDependentLayers){const c=this.getLayer(n);if(c){if(t&&!c.configDependencies.has(t))continue;c.possiblyEvaluateVisibility(),this._updateLayer(c)}}this.ambientLight&&this.ambientLight.updateConfig(this.options),this.directionalLight&&this.directionalLight.updateConfig(this.options),this.fog&&this.fog.updateConfig(this.options),this.snow&&this.snow.updateConfig(this.options),this.rain&&this.rain.updateConfig(this.options),this.forEachFragmentStyle(n=>{const c=n._styleColorTheme.colorThemeOverride?n._styleColorTheme.colorThemeOverride:n._styleColorTheme.colorTheme;if(c){const d=n._evaluateColorThemeData(c);(!n._styleColorTheme.lut&&d!==""||n._styleColorTheme.lut&&d!==n._styleColorTheme.lut.data)&&n.setColorTheme(c)}}),this._changes.setDirty()}addLayer(t,n,c={}){this._checkLoaded();const d=t.id;if(this._layers[d])return void this.fire(new o.z(new Error(`Layer with id "${d}" already exists on this map`)));let f;if(t.type==="custom"){if(Go(this,o.da(t)))return;f=o.db(t,this.scope,this._styleColorTheme.lut,this.options)}else{if(typeof t.source=="object"&&(this.addSource(d,t.source),t=o.d6(t),t=o.h(t,{source:d})),this._validate(wi,`layers.${d}`,t,{arrayIndex:-1},c))return;f=o.db(t,this.scope,this._styleColorTheme.lut,this.options),this._validateLayer(f),f.setEventedParent(this,{layer:{id:d}})}f.configDependencies.size!==0&&this._configDependentLayers.add(f.fqid);let m=this._order.length;if(n){const S=this._order.indexOf(n);if(S===-1)return void this.fire(new o.z(new Error(`Layer with id "${n}" does not exist on this map.`)));f.slot===this._layers[n].slot?m=S:o.w(`Layer with id "${n}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(m,0,d),this._layerOrderChanged=!0,this._layers[d]=f;const y=this.getOwnLayerSourceCache(f),v=!!this.directionalLight&&this.directionalLight.shadowsEnabled();y&&f.canCastShadows()&&v&&(y.castsShadows=!0);const T=this._changes.getRemovedLayer(f);if(T&&f.source&&y&&f.type!=="custom"){this._changes.discardLayerRemoval(f);const S=o.C(f.source,f.scope);T.type!==f.type?this._changes.updateSourceCache(S,"clear"):(this._changes.updateSourceCache(S,"reload"),y.pause())}this._updateLayer(f),f.onAdd&&f.onAdd(this.map),f.scope=this.scope,this.mergeLayers()}moveLayer(t,n){this._checkLoaded();const c=this._checkLayer(t);if(!c||t===n)return;const d=this._order.indexOf(t);this._order.splice(d,1);let f=this._order.length;if(n){const m=this._order.indexOf(n);if(m===-1)return void this.fire(new o.z(new Error(`Layer with id "${n}" does not exist on this map.`)));c.slot===this._layers[n].slot?f=m:o.w(`Layer with id "${n}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(f,0,t),this._changes.setDirty(),this._layerOrderChanged=!0,this.mergeLayers()}removeLayer(t){this._checkLoaded();const n=this._checkLayer(t);if(!n)return;n.setEventedParent(null);const c=this._order.indexOf(t);this._order.splice(c,1),delete this._layers[t],this._changes.setDirty(),this._layerOrderChanged=!0,this._configDependentLayers.delete(n.fqid),this._changes.removeLayer(n);const d=this.getOwnLayerSourceCache(n);if(d&&d.castsShadows){let f=!1;for(const m in this._layers)if(this._layers[m].source===n.source&&this._layers[m].canCastShadows()){f=!0;break}d.castsShadows=f}n.onRemove&&n.onRemove(this.map),this.mergeLayers()}getOwnLayer(t){return this._layers[t]}hasLayer(t){return t in this._mergedLayers}hasLayerType(t){for(const n in this._layers)if(this._layers[n].type===t)return!0;return!1}setLayerZoomRange(t,n,c){this._checkLoaded();const d=this._checkLayer(t);d&&(d.minzoom===n&&d.maxzoom===c||(n!=null&&(d.minzoom=n),c!=null&&(d.maxzoom=c),this._updateLayer(d)))}getSlots(){return this._checkLoaded(),this._mergedSlots}setSlot(t,n){this._checkLoaded();const c=this._checkLayer(t);c&&c.slot!==n&&(c.slot=n,this._updateLayer(c))}setFilter(t,n,c={}){this._checkLoaded();const d=this._checkLayer(t);if(d&&!o.bv(d.filter,n))return n==null?(d.filter=void 0,void this._updateLayer(d)):void(this._validate(Ee,`layers.${d.id}.filter`,n,{layerType:d.type},c)||(d.filter=o.d6(n),this._updateLayer(d)))}getFilter(t){const n=this._checkLayer(t);if(n)return o.d6(n.filter)}setLayoutProperty(t,n,c,d={}){this._checkLoaded();const f=this._checkLayer(t);if(f&&!o.bv(f.getLayoutProperty(n),c)){if(c!=null&&(!d||d.validate!==!1)&&Go(f,U.call(zn,{key:`layers.${t}.layout.${n}`,layerType:f.type,objectKey:n,value:c,styleSpec:o.a5,style:{glyphs:!0,sprite:!0}})))return;f.setLayoutProperty(n,c),f.configDependencies.size!==0&&this._configDependentLayers.add(f.fqid),this._updateLayer(f)}}getLayoutProperty(t,n){const c=this._checkLayer(t);if(c)return c.getLayoutProperty(n)}setPaintProperty(t,n,c,d={}){this._checkLoaded();const f=this._checkLayer(t);if(!f||o.bv(f.getPaintProperty(n),c)||c!=null&&(!d||d.validate!==!1)&&Go(f,F.call(zn,{key:`layers.${t}.paint.${n}`,layerType:f.type,objectKey:n,value:c,styleSpec:o.a5})))return;const m=f.setPaintProperty(n,c);f.configDependencies.size!==0&&this._configDependentLayers.add(f.fqid),m&&this._updateLayer(f),this._changes.updatePaintProperties(f)}getPaintProperty(t,n){const c=this._checkLayer(t);if(c)return c.getPaintProperty(n)}setFeatureState(t,n){if(this._checkLoaded(),"target"in t){if("featuresetId"in t.target){const{featuresetId:v,importId:T}=t.target,S=this.getFragmentStyle(T),C=S.getFeaturesetLayers(v);for(const{source:I,sourceLayer:M}of C)S.setFeatureState({id:t.id,source:I,sourceLayer:M},n)}else if("layerId"in t.target){const{layerId:v}=t.target,T=this.getLayer(v);this.setFeatureState({id:t.id,source:T.source,sourceLayer:T.sourceLayer},n)}return}const c=t.source,d=t.sourceLayer,f=this._checkSource(c);if(!f)return;const m=f.type;if(m==="geojson"&&d)return void this.fire(new o.z(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if(m==="vector"&&!d)return void this.fire(new o.z(new Error("The sourceLayer parameter must be provided for vector source types.")));t.id===void 0&&this.fire(new o.z(new Error("The feature id parameter must be provided.")));const y=this.getOwnSourceCaches(c);for(const v of y)v.setFeatureState(d,t.id,n)}removeFeatureState(t,n){if(this._checkLoaded(),"target"in t){if("featuresetId"in t.target){const{featuresetId:v,importId:T}=t.target,S=this.getFragmentStyle(T),C=S.getFeaturesetLayers(v);for(const{source:I,sourceLayer:M}of C)S.removeFeatureState({id:t.id,source:I,sourceLayer:M},n)}else if("layerId"in t.target){const{layerId:v}=t.target,T=this.getLayer(v);this.removeFeatureState({id:t.id,source:T.source,sourceLayer:T.sourceLayer},n)}return}const c=t.source,d=this._checkSource(c);if(!d)return;const f=d.type,m=f==="vector"?t.sourceLayer:void 0;if(f==="vector"&&!m)return void this.fire(new o.z(new Error("The sourceLayer parameter must be provided for vector source types.")));if(n&&typeof t.id!="string"&&typeof t.id!="number")return void this.fire(new o.z(new Error("A feature id is required to remove its specific state property.")));const y=this.getOwnSourceCaches(c);for(const v of y)v.removeFeatureState(m,t.id,n)}getFeatureState(t){if(this._checkLoaded(),"target"in t){let f;if("featuresetId"in t.target){const{featuresetId:m,importId:y}=t.target,v=this.getFragmentStyle(y),T=v.getFeaturesetLayers(m);for(const{source:S,sourceLayer:C}of T){const I=v.getFeatureState({id:t.id,source:S,sourceLayer:C});if(I&&!f)f=I;else if(!o.bv(f,I))return void this.fire(new o.z(new Error("The same feature id exists in multiple sources in the featureset, but their feature states are not consistent through the sources.")))}}else if("layerId"in t.target){const{layerId:m}=t.target,y=this.getLayer(m);f=this.getFeatureState({id:t.id,source:y.source,sourceLayer:y.sourceLayer})}return f}const n=t.source,c=t.sourceLayer,d=this._checkSource(n);if(d){if(d.type!=="vector"||c)return t.id===void 0&&this.fire(new o.z(new Error("The feature id parameter must be provided."))),this.getOwnSourceCaches(n)[0].getFeatureState(c,t.id);this.fire(new o.z(new Error("The sourceLayer parameter must be provided for vector source types.")))}}setTransition(t){return this.stylesheet.transition=o.h({},this.stylesheet.transition,t),this.transition=this.stylesheet.transition,this}getTransition(){return o.h({},this.stylesheet.transition)}serialize(){this._checkLoaded();const t=this.getTerrain(),n=t&&this.terrain&&this.terrain.scope===this.scope?t:this.stylesheet.terrain;return o.dc({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,fragment:this.stylesheet.fragment,iconsets:this.stylesheet.iconsets,imports:this._serializeImports(),schema:this.stylesheet.schema,camera:this.stylesheet.camera,light:this.stylesheet.light,lights:this.stylesheet.lights,terrain:n,fog:this.stylesheet.fog,snow:this.stylesheet.snow,rain:this.stylesheet.rain,center:this.stylesheet.center,"color-theme":this.stylesheet["color-theme"],zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:this._serializeSources(),layers:this._serializeLayers(this._order)},c=>c!==void 0)}_updateFilteredLayers(t){for(const n of Object.values(this._mergedLayers))t(n)&&this._updateLayer(n)}_updateLayer(t){this._changes.updateLayer(t);const n=this.getLayerSourceCache(t),c=o.C(t.source,t.scope),d=this._changes.getUpdatedSourceCaches();t.source&&!d[c]&&n&&n.getSource().type!=="raster"&&(this._changes.updateSourceCache(c,"reload"),n.pause()),t.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(t){const n=y=>this._mergedLayers[y].is3D(!!this.terrain),c=this.order,d={},f=[];for(let y=c.length-1;y>=0;y--){const v=c[y];if(n(v)){d[v]=y;for(const T of t){const S=T[v];if(S)for(const C of S)f.push(C)}}}f.sort((y,v)=>v.intersectionZ-y.intersectionZ);const m=[];for(let y=c.length-1;y>=0;y--){const v=c[y];if(n(v))for(let T=f.length-1;T>=0;T--){const S=f[T].feature;if(S.layer&&d[S.layer.id]<y)break;m.push(S),f.pop()}else for(const T of t){const S=T[v];if(S)for(const C of S)m.push(C.feature)}}return m}queryRenderedFeatures(t,n,c){let d;n&&!Array.isArray(n)&&n.filter&&(this._validate(Ee,"queryRenderedFeatures.filter",n.filter,null,n),d=o.b3(n.filter));const f={},m=S=>{if(Ac.has(S.type))return;const C=this.getOwnLayerSourceCache(S),I=f[C.id]=f[C.id]||{sourceCache:C,layers:{},has3DLayers:!1};S.is3D(!!this.terrain)&&(I.has3DLayers=!0),I.layers[S.fqid]=I.layers[S.fqid]||{styleLayer:S,targets:[]},I.layers[S.fqid].targets.push({filter:d})};if(n&&n.layers){if(!Array.isArray(n.layers))return this.fire(new o.z(new Error("parameters.layers must be an Array."))),[];for(const S of n.layers){const C=this._layers[S];if(!C)return this.fire(new o.z(new Error(`The layer '${S}' does not exist in the map's style and cannot be queried for features.`))),[];m(C)}}else for(const S in this._layers)m(this._layers[S]);const y=this._queryRenderedFeatures(t,f,c),v=this._flattenAndSortRenderedFeatures(y),T=[];for(const S of v)o.dd(S.layer.id)===this.scope&&T.push(S);return T}queryRenderedFeatureset(t,n,c){let d;n&&!Array.isArray(n)&&n.filter&&(this._validate(Ee,"queryRenderedFeatures.filter",n.filter,null,n),d=o.b3(n.filter));const f="mock",m=[];if(n&&n.target)m.push(Object.assign({},n,{targetId:f,filter:d}));else{const S=this.getFeaturesetDescriptors();for(const C of S)m.push({targetId:f,filter:d,target:C});for(const{style:C}of this.fragments){const I=C.getFeaturesetDescriptors();for(const M of I)m.push({targetId:f,filter:d,target:M})}}const y=this.queryRenderedTargets(t,m,c),v=[],T=new Set;for(const S of y)for(const C of S.variants[f])pc(C,S,T)||v.push(new o.de(S,C));return v}queryRenderedTargets(t,n,c){const d={},f=(y,v,T,S)=>{const C=d[v.id]=d[v.id]||{sourceCache:v,layers:{},has3DLayers:!1};if(C.layers[y.fqid]=C.layers[y.fqid]||{styleLayer:y,targets:[]},y.is3D(!!this.terrain)&&(C.has3DLayers=!0),!S)return T.uniqueFeatureID=!1,void C.layers[y.fqid].targets.push(T);C.layers[y.fqid].targets.push(Object.assign({},T,{namespace:S.namespace,properties:S.properties,uniqueFeatureID:S.uniqueFeatureID}))};for(const y of n)if("featuresetId"in y.target){const{featuresetId:v,importId:T}=y.target,S=this.getFragmentStyle(T);if(!S||!S._featuresetSelectors)continue;const C=S._featuresetSelectors[v];if(!C){this.fire(new o.z(new Error(`The featureset '${v}' does not exist in the map's style and cannot be queried for features.`)));continue}for(const I of C){const M=S.getOwnLayer(I.layerId);M&&!Ac.has(M.type)&&f(M,S.getOwnLayerSourceCache(M),y,I)}}else if("layerId"in y.target){const{layerId:v}=y.target,T=this.getLayer(v);if(!T||Ac.has(T.type))continue;f(T,this.getLayerSourceCache(T),y)}const m=this._queryRenderedFeatures(t,d,c);return this._flattenAndSortRenderedFeatures(m)}_queryRenderedFeatures(t,n,c){const d=[],f=!!this.map._showQueryGeometry,m=Ii.createFromScreenPoints(t,c);for(const y in n){const v=mc(m,n[y],this._availableImages,c,f);Object.keys(v).length&&d.push(v)}if(this.placement)for(const y in n){if(!n[y].sourceCache._onlySymbols)continue;const v=zo(m.screenGeometry,n[y],this._availableImages,this.placement.collisionIndex,this.placement.retainedQueryData,this.map.getWorldview());Object.keys(v).length&&d.push(v)}return d}querySourceFeatures(t,n){const c=n&&n.filter;c&&this._validate(Ee,"querySourceFeatures.filter",c,null,n);let d=[];const f=this.getOwnSourceCaches(t);for(const m of f)d=d.concat(cl(m,n));return d}addSourceType(t,n,c){return un.getSourceType(t)?c(new Error(`A source type called "${t}" already exists.`)):(un.setSourceType(t,n),n.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:t,url:n.workerSourceURL},c):c(null,null))}getFlatLight(){return this.light.getLight()}setFlatLight(t,n,c={}){this._checkLoaded();const d=this.light.getLight();let f=!1;for(const y in t)if(!o.bv(t[y],d[y])){f=!0;break}if(!f)return;const m=this._getTransitionParameters();this.light.setLight(t,n,c),this.light.updateTransitions(m)}getTerrain(){return this.terrain&&this.terrain.drapeRenderMode===1?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}checkCanvasFingerprintNoise(){this.disableElevatedTerrain===void 0&&(this.disableElevatedTerrain=o.q.hasCanvasFingerprintNoise(),this.disableElevatedTerrain&&o.w("Terrain and hillshade are disabled because of Canvas2D limitations when fingerprinting protection is enabled (e.g. in private browsing mode)."))}setTerrain(t,n=1){if(this._checkLoaded(),!t)return this.terrainSetForDrapingOnly()||(delete this.terrain,this.map.transform.projection.requiresDraping&&this.setTerrainForDraping()),n===0&&delete this.terrain,t===null?this.stylesheet.terrain=null:delete this.stylesheet.terrain,this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);this.checkCanvasFingerprintNoise();let c=t;const d=t.source==null;if(n===1){if(this.disableElevatedTerrain)return;if(typeof c.source=="object"){const y="terrain-dem-src";this.addSource(y,c.source),c=o.d6(c),c=o.h(c,{source:y})}const f=o.h({},c),m={};if(this.terrain&&d){f.source=this.terrain.get().source;const y=this.terrain?this.getFragmentStyle(this.terrain.scope):null;y&&(m.style=y.serialize())}if(this._validate(ut,"terrain",f,m))return}if(!this.terrain||this.terrain.scope!==this.scope&&!d||this.terrain&&n!==this.terrain.drapeRenderMode){if(!c)return;this._createTerrain(c,n),this.fire(new o.A("data",{dataType:"style"}))}else{const f=this.terrain,m=f.get();for(const y of Object.keys(o.a5.terrain))!c.hasOwnProperty(y)&&o.a5.terrain[y].default&&(c[y]=o.a5.terrain[y].default);for(const y in t)if(!o.bv(t[y],m[y])){f.set(t,this.options),this.stylesheet.terrain=t;const v=this._getTransitionParameters({duration:0});f.updateTransitions(v),this.fire(new o.A("data",{dataType:"style"}));break}}this.mergeTerrain(),this.updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(t){const n=this.fog=new Wt(t,this.map.transform,this.scope,this.options);this.stylesheet.fog=n.get();const c=this._getTransitionParameters({duration:0});n.updateTransitions(c)}_createSnow(t){const n=this.snow=new cr(t,this.map.transform,this.scope,this.options);this.stylesheet.snow=n.get();const c=this._getTransitionParameters({duration:0});n.updateTransitions(c)}_createRain(t){const n=this.rain=new ur(t,this.map.transform,this.scope,this.options);this.stylesheet.rain=n.get();const c=this._getTransitionParameters({duration:0});n.updateTransitions(c)}_updateMarkersOpacity(){this.map._markers.length!==0&&this.map._requestDomTask(()=>{for(const t of this.map._markers)t._evaluateOpacity()})}getFog(){return this.fog?this.fog.get():null}setFog(t){if(this._checkLoaded(),!t)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){const n=this.fog;if(!o.bv(n.get(),t)){n.set(t,this.options),this.stylesheet.fog=n.get();const c=this._getTransitionParameters({duration:0});n.updateTransitions(c)}}else this._createFog(t);this._markersNeedUpdate=!0}getSnow(){return this.snow?this.snow.get():null}setSnow(t){if(this._checkLoaded(),!t)return delete this.snow,void delete this.stylesheet.snow;if(this.snow){const n=this.snow;if(!o.bv(n.get(),t)){n.set(t,this.options),this.stylesheet.snow=n.get();const c=this._getTransitionParameters({duration:0});n.updateTransitions(c)}}else this._createSnow(t);this._markersNeedUpdate=!0}getRain(){return this.rain?this.rain.get():null}setRain(t){if(this._checkLoaded(),!t)return delete this.rain,void delete this.stylesheet.rain;if(this.rain){const n=this.rain;if(!o.bv(n.get(),t)){n.set(t,this.options),this.stylesheet.rain=n.get();const c=this._getTransitionParameters({duration:0});n.updateTransitions(c)}}else this._createRain(t);this._markersNeedUpdate=!0}_reloadColorTheme(){const t=()=>{for(const d in this._layers)this._layers[d].lut=this._styleColorTheme.lut;for(const d in this._sourceCaches)this._sourceCaches[d].clearTiles()},n=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(!n)return this._styleColorTheme.lut=null,void t();const c=this._evaluateColorThemeData(n);this._loadColorTheme(c).then(()=>{this.fire(new o.A("colorthemeset")),t()}).catch(d=>{o.w(`Couldn't set color theme: ${d}`)})}setColorTheme(t){this._checkLoaded(),this._styleColorTheme.colorThemeOverride&&o.w("Note: setColorTheme is called on a style with a color-theme override, the passed color-theme won't be visible."),this._styleColorTheme.colorTheme=t,this._reloadColorTheme()}setImportColorTheme(t,n){const c=this.getFragmentStyle(t);c&&(c._styleColorTheme.colorThemeOverride=n,c._reloadColorTheme())}_getTransitionParameters(t){return{now:o.q.now(),transition:o.h(this.transition,t)}}updateDrapeFirstLayers(){if(!this.terrain)return;const t=[],n=[];for(const c of this._mergedOrder)this.isLayerDraped(this._mergedLayers[c])?t.push(c):n.push(c);this._drapedFirstOrder=[],this._drapedFirstOrder.push(...t),this._drapedFirstOrder.push(...n)}_createTerrain(t,n){const c=this.terrain=new fe(t,n,this.scope,this.options,this.map.getWorldview());n===1&&(this.stylesheet.terrain=t),this.mergeTerrain(),this.updateDrapeFirstLayers(),this._force3DLayerUpdate();const d=this._getTransitionParameters({duration:0});c.updateTransitions(d)}_force3DLayerUpdate(){for(const t in this._layers){const n=this._layers[t];n.type==="fill-extrusion"&&this._updateLayer(n)}}_forceSymbolLayerUpdate(){for(const t in this._layers){const n=this._layers[t];n.type==="symbol"&&this._updateLayer(n)}}_validate(t,n,c,d,f={}){if(f&&f.validate===!1)return!1;const m=o.h({},this.serialize());return Go(this,t.call(zn,o.h({key:n,style:m,value:c,styleSpec:o.a5},d)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),o.df.off("pluginStateChange",this._rtlTextPluginCallback);for(const t in this._mergedLayers)this._mergedLayers[t].setEventedParent(null);for(const t in this._mergedSourceCaches)this._mergedSourceCaches[t].clearTiles(),this._mergedSourceCaches[t].setEventedParent(null);this.imageManager.removeScope(this.scope),this.setEventedParent(null),delete this.fog,delete this.snow,delete this.rain,delete this.terrain,delete this.ambientLight,delete this.directionalLight,this.isRootStyle()&&(this.imageManager.setEventedParent(null),this.modelManager.setEventedParent(null),this.modelManager.destroy(),this.dispatcher.remove())}clearSource(t){const n=this.getSourceCaches(t);for(const c of n)c.clearTiles()}clearSources(){for(const t in this._mergedSourceCaches)this._mergedSourceCaches[t].clearTiles()}reloadSource(t){const n=this.getSourceCaches(t);for(const c of n)c.resume(),c.reload()}reloadSources(){for(const t of this.getSources())t.reload&&t.reload()}reloadModels(){this.modelManager.reloadModels(""),this.forEachFragmentStyle(t=>{t.modelManager.reloadModels(t.scope)})}updateSources(t){let n;this.directionalLight&&(n=ya(this.directionalLight));const c=new Set;for(const d in this._mergedLayers){const f=this._mergedLayers[d];f.hasElevation()&&!c.has(f.source)&&c.add(f.source)}for(const d in this._mergedSourceCaches){const f=this._mergedSourceCaches[d],m=c.has(f._source.id);f.update(t,void 0,void 0,n,m)}}_generateCollisionBoxes(){for(const t in this._sourceCaches){const n=this._sourceCaches[t];n.resume(),n.reload()}}_updatePlacement(t,n,c,d,f,m,y=!1){let v=!1,T=!1;const S={},C={};for(const I of this._mergedOrder){const M=this._mergedLayers[I];if(M.type!=="symbol")continue;const D=o.C(M.source,M.scope);let z=S[D];if(!z){const B=this.getLayerSourceCache(M);if(!B)continue;const V=B.getRenderableIds(!0).map(H=>B.getTileByID(H));C[D]=V.slice(),z=S[D]=V.sort((H,Y)=>Y.tileID.overscaledZ-H.tileID.overscaledZ||(H.tileID.isLessThan(Y.tileID)?-1:1))}const O=this.crossTileSymbolIndex.addLayer(M,z,n.center.lng,n.projection);v=v||O}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._mergedOrder),y=y||this._layerOrderChanged||d===0,this._layerOrderChanged&&this.fire(new o.A("neworder")),(y||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(o.q.now(),n.zoom))&&(this.pauseablePlacement=new Sc(n,this._mergedOrder,y,c,d,f,this.placement,this.fog&&n.projection.supportsFog?this.fog.state:null,this._buildingIndex),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._mergedOrder,this._mergedLayers,S,C,this.map.painter.scaleFactor),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(o.q.now()),T=!0),v&&this.pauseablePlacement.placement.setStale()),T||v){this._buildingIndex.onNewFrame(n.zoom);for(let I=0;I<this._mergedOrder.length;I++){const M=this._mergedLayers[this._mergedOrder[I]];if(M.type!=="symbol")continue;const D=this.isLayerClipped(M);this.placement.updateLayerOpacities(M,S[o.C(M.source,M.scope)],I,D?m:null)}}return{needsRerender:!this.pauseablePlacement.isDone()||this.placement.hasTransitions(o.q.now())}}_releaseSymbolFadeTiles(){for(const t in this._sourceCaches)this._sourceCaches[t].releaseSymbolFadeTiles()}addImport(t,n){this._checkLoaded();const c=this.stylesheet.imports=this.stylesheet.imports||[];if(c.findIndex(({id:f})=>f===t.id)!==-1)return void this.fire(new o.z(new Error(`Import with id '${t.id}' already exists in the map's style.`)));if(!n)return c.push(t),this._loadImports([t],!0);const d=c.findIndex(({id:f})=>f===n);return d===-1&&this.fire(new o.z(new Error(`Import with id "${n}" does not exist on this map.`))),this.stylesheet.imports=c.slice(0,d).concat(t).concat(c.slice(d)),this._loadImports([t],!0,n)}updateImport(t,n){this._checkLoaded();const c=this.stylesheet.imports||[],d=this.getImportIndex(t);return d===-1?this:typeof n=="string"?(this.setImportUrl(t,n),this):(n.url&&n.url!==c[d].url&&this.setImportUrl(t,n.url),o.bv(n.config,c[d].config)||this.setImportConfig(t,n.config,n.data.schema),o.bv(n.data,c[d].data)||this.setImportData(t,n.data),this)}moveImport(t,n){this._checkLoaded();let c=this.stylesheet.imports||[];const d=this.getImportIndex(t);if(d===-1)return this;const f=this.getImportIndex(n);if(f===-1)return this;const m=c[d],y=this.fragments[d];return c=c.filter(({id:v})=>v!==t),this.fragments=this.fragments.filter(({id:v})=>v!==t),this.stylesheet.imports=c.slice(0,f).concat(m).concat(c.slice(f)),this.fragments=this.fragments.slice(0,f).concat(y).concat(this.fragments.slice(f)),this.mergeLayers(),this}setImportUrl(t,n){this._checkLoaded();const c=this.stylesheet.imports||[],d=this.getImportIndex(t);if(d===-1)return this;c[d].url=n;const f=this.fragments[d];return f.style=this._createFragmentStyle(c[d]),f.style.on("style.import.load",()=>this.mergeAll()),f.style.loadURL(n),this}setImportData(t,n){this._checkLoaded();const c=this.getImportIndex(t),d=this.stylesheet.imports||[];return c===-1?this:n?(this.fragments[c].style.setState(n),this._reloadImports(),this):(delete d[c].data,this.setImportUrl(t,d[c].url))}setImportConfig(t,n,c){this._checkLoaded();const d=this.getImportIndex(t),f=this.stylesheet.imports||[];if(d===-1)return this;n?f[d].config=n:delete f[d].config;const m=this.fragments[d];c&&m.style.stylesheet&&(m.style.stylesheet.schema=c);const y=m.style.stylesheet&&m.style.stylesheet.schema;return m.config=n,m.style.updateConfig(n,y),this.updateConfigDependencies(),this}removeImport(t){this._checkLoaded();const n=this.stylesheet.imports||[],c=this.getImportIndex(t);c!==-1&&(n.splice(c,1),this.fragments[c].style._remove(),this.fragments.splice(c,1),this._reloadImports())}getImportIndex(t){const n=(this.stylesheet.imports||[]).findIndex(c=>c.id===t);return n===-1&&this.fire(new o.z(new Error(`Import '${t}' does not exist in the map's style and cannot be updated.`))),n}getLayer(t){return this._mergedLayers[t]}getSources(){const t=[];for(const n in this._mergedOtherSourceCaches){const c=this._mergedOtherSourceCaches[n];c&&t.push(c.getSource())}return t}getSource(t,n){const c=this.getSourceCache(t,n);return c&&c.getSource()}getLayerSource(t){const n=this.getLayerSourceCache(t);return n&&n.getSource()}getSourceCache(t,n){const c=o.C(t,n);return this._mergedOtherSourceCaches[c]}getLayerSourceCache(t){const n=o.C(t.source,t.scope);return t.type==="symbol"?this._mergedSymbolSourceCaches[n]:this._mergedOtherSourceCaches[n]}getSourceCaches(t){if(t==null)return Object.values(this._mergedSourceCaches);const n=[];return this._mergedOtherSourceCaches[t]&&n.push(this._mergedOtherSourceCaches[t]),this._mergedSymbolSourceCaches[t]&&n.push(this._mergedSymbolSourceCaches[t]),n}updateSourceCaches(){const t=this._changes.getUpdatedSourceCaches();for(const n in t){const c=t[n];c==="reload"?this.reloadSource(n):c==="clear"&&this.clearSource(n)}}updateLayers(t){const n=this._changes.getUpdatedPaintProperties();for(const c of n){const d=this.getLayer(c);d&&d.updateTransitions(t)}}getGlyphsUrl(){return this.stylesheet.glyphs}setGlyphsUrl(t){this.stylesheet.glyphs=t,this.glyphManager.setURL(t,this.scope)}getImages(t,n,c){this.imageManager.getImages(n.images,n.scope,c),this._updateTilesForChangedImages();const d=m=>{if(m){const y=n.images.map(v=>o.I.toString(v));m.setDependencies(n.tileID.key,n.type,y)}},f=o.C(n.source,n.scope);d(this._mergedOtherSourceCaches[f]),d(this._mergedSymbolSourceCaches[f])}rasterizeImages(t,n,c){this.imageManager.rasterizeImages(n,c)}getGlyphs(t,n,c){this.glyphManager.getGlyphs(n.stacks,n.scope,c)}getResource(t,n,c){return o.dg(n,c)}getOwnSourceCache(t){return this._otherSourceCaches[t]}getOwnLayerSourceCache(t){return t.type==="symbol"?this._symbolSourceCaches[t.source]:this._otherSourceCaches[t.source]}getOwnSourceCaches(t){const n=[];return this._otherSourceCaches[t]&&n.push(this._otherSourceCaches[t]),this._symbolSourceCaches[t]&&n.push(this._symbolSourceCaches[t]),n}_isSourceCacheLoaded(t){const n=this.getOwnSourceCaches(t);return n.length===0?(this.fire(new o.z(new Error(`There is no source with ID '${t}'`))),!1):n.every(c=>c.loaded())}has3DLayers(){return this._has3DLayers}hasSymbolLayers(){return this._hasSymbolLayers}hasCircleLayers(){return this._hasCircleLayers}isLayerClipped(t,n){if(!this._clipLayerPresent&&t.type!=="fill-extrusion"&&t.type!=="building")return!1;const c=t.type==="fill-extrusion"&&t.sourceLayer==="building",d=t.type==="building";if(t.is3D(!!this.terrain)){if(c||d||n&&n.type==="batched-model"||t.type==="model")return!0}else if(t.type==="symbol")return!0;return!1}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.fragments.forEach(t=>{t.style._remove()}),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}un.getSourceType=function(l){return fc[l]},un.setSourceType=function(l,t){fc[l]=t},un.registerForPluginStateChange=o.dh;var El=`
#define EPSILON 0.0000001
#define PI 3.141592653589793
#ifdef RENDER_CUTOFF
float cutoff_opacity(vec4 cutoff_params,float depth) {float near=cutoff_params.x;float far=cutoff_params.y;float cutoffStart=cutoff_params.z;float cutoffEnd=cutoff_params.w;float linearDepth=(depth-near)/(far-near);return clamp((linearDepth-cutoffStart)/(cutoffEnd-cutoffStart),0.0,1.0);}
#endif`,Ku=`
out vec4 glFragColor;highp float unpack_depth(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}
#ifdef INDICATOR_CUTOUT
uniform vec3 u_indicator_cutout_centers;uniform vec4 u_indicator_cutout_params;
#endif
vec4 applyCutout(vec4 color,float height) {
#ifdef INDICATOR_CUTOUT
float verticalFadeRange=u_indicator_cutout_centers.z*0.25;float holeMinOpacity=mix(1.0,u_indicator_cutout_params.x,smoothstep(u_indicator_cutout_centers.z,u_indicator_cutout_centers.z+verticalFadeRange,height));float holeRadius=max(u_indicator_cutout_params.y,0.0);float holeAspectRatio=u_indicator_cutout_params.z;float fadeStart=u_indicator_cutout_params.w;float distA=distance(vec2(gl_FragCoord.x,gl_FragCoord.y*holeAspectRatio),vec2(u_indicator_cutout_centers[0],u_indicator_cutout_centers[1]*holeAspectRatio));return color*min(smoothstep(fadeStart,holeRadius,distA)+holeMinOpacity,1.0);
#else
return color;
#endif
}
#ifdef DEBUG_WIREFRAME
#define HANDLE_WIREFRAME_DEBUG \\
glFragColor=vec4(0.7,0.0,0.0,0.7); \\
gl_FragDepth=gl_FragCoord.z-0.0001;
#else
#define HANDLE_WIREFRAME_DEBUG
#endif
#ifdef RENDER_CUTOFF
uniform highp vec4 u_cutoff_params;in float v_cutoff_opacity;
#endif
vec4 textureLodCustom(sampler2D image,highp vec2 pos,highp vec2 lod_coord) {highp vec2 size=vec2(textureSize(image,0));highp vec2 dx=dFdx(lod_coord.xy*size);highp vec2 dy=dFdy(lod_coord.xy*size);highp float delta_max_sqr=max(dot(dx,dx),dot(dy,dy));highp float lod=0.5*log2(delta_max_sqr);return textureLod(image,pos,lod);}vec4 applyLUT(highp sampler3D lut,vec4 col) {vec3 size=vec3(textureSize(lut,0));vec3 uvw=(col.rbg*float(size-1.0)+0.5)/size;return vec4(texture(lut,uvw).rgb,col.a);}vec3 applyLUT(highp sampler3D lut,vec3 col) {return applyLUT(lut,vec4(col,1.0)).rgb;}`,Ju=`
#define EXTENT 8192.0
#define RAD_TO_DEG 180.0/PI
#define DEG_TO_RAD PI/180.0
#define GLOBE_RADIUS EXTENT/PI/2.0
float wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}
#ifdef PROJECTION_GLOBE_VIEW
vec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {
#ifndef PROJECTED_POS_ON_VIEWPORT
float tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;
#else
return vec3(0.0);
#endif
}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(
unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const vec2 units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (units_to_pixels*pos+offset)/pattern_size;}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {return get_pattern_pos(pixel_coord_upper,pixel_coord_lower,pattern_size,vec2(tile_units_to_pixels),pos);}float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(PI/4.0+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}
#ifdef RENDER_CUTOFF
uniform vec4 u_cutoff_params;out float v_cutoff_opacity;
#endif
const vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);const float skirtOffset=24575.0;vec3 decomposeToPosAndSkirt(vec2 posWithComposedSkirt)
{float skirt=float(posWithComposedSkirt.x >=skirtOffset);vec2 pos=posWithComposedSkirt-vec2(skirt*skirtOffset,0.0);return vec3(pos,skirt);}`,xa="in highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;out highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",ba=`
#define ELEVATION_SCALE 7.0
#define ELEVATION_OFFSET 450.0
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(
mix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}
#else
vec3 elevationVector(vec2 pos) { return vec3(0,0,1); }
#endif
#ifdef TERRAIN
uniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float currentElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(dd,0)).r;float bl=texture(u_dem,pos+vec2(0,dd)).r;float br=texture(u_dem,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}float prevElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem_prev,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem_prev,pos).r;float tr=texture(u_dem_prev,pos+vec2(dd,0)).r;float bl=texture(u_dem_prev,pos+vec2(0,dd)).r;float br=texture(u_dem_prev,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}
#ifdef TERRAIN_VERTEX_MORPHING
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
float nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}
#else
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
return currentElevation(apos);}
#endif
vec4 fourSample(vec2 pos,vec2 off) {float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(off.x,0.0)).r;float bl=texture(u_dem,pos+vec2(0.0,off.y)).r;float br=texture(u_dem,pos+off).r;return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}
#else
float elevation(vec2 pos) { return 0.0; }
#endif
#ifdef DEPTH_OCCLUSION
uniform highp sampler2D u_depth;uniform highp vec2 u_depth_size_inv;uniform highp vec2 u_depth_range_unpack;uniform highp float u_occluder_half_size;uniform highp float u_occlusion_depth_offset;
#ifdef DEPTH_D24
float unpack_depth(float depth) {return depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}vec4 unpack_depth4(vec4 depth) {return depth*u_depth_range_unpack.x+vec4(u_depth_range_unpack.y);}
#else
highp float unpack_depth_rgba(vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}
#endif
bool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;
#ifdef DEPTH_D24
float depth=unpack_depth(texture(u_depth,(coord.xy+1.0)*0.5).r);
#else
float depth=unpack_depth_rgba(texture(u_depth,(coord.xy+1.0)*0.5));
#endif
return coord.z+u_occlusion_depth_offset > depth;}highp vec4 getCornerDepths(vec2 coord) {highp vec3 df=vec3(u_occluder_half_size*u_depth_size_inv,0.0);highp vec2 uv=0.5*coord.xy+0.5;
#ifdef DEPTH_D24
highp vec4 depth=vec4(
texture(u_depth,uv-df.xz).r,texture(u_depth,uv+df.xz).r,texture(u_depth,uv-df.zy).r,texture(u_depth,uv+df.zy).r
);depth=unpack_depth4(depth);
#else
highp vec4 depth=vec4(
unpack_depth_rgba(texture(u_depth,uv-df.xz)),unpack_depth_rgba(texture(u_depth,uv+df.xz)),unpack_depth_rgba(texture(u_depth,uv-df.zy)),unpack_depth_rgba(texture(u_depth,uv+df.zy))
);
#endif
return depth;}highp float occlusionFadeMultiSample(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec2 uv=0.5*coord.xy+0.5;int NX=3;int NY=4;highp vec2 df=u_occluder_half_size*u_depth_size_inv;highp vec2 oneStep=2.0*u_occluder_half_size*u_depth_size_inv/vec2(NX-1,NY-1);highp float res=0.0;for (int y=0; y < NY;++y) {for (int x=0; x < NX;++x) {
#ifdef DEPTH_D24
highp float depth=unpack_depth(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)).r);
#else
highp float depth=unpack_depth_rgba(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)));
#endif
res+=1.0-clamp(300.0*(coord.z+u_occlusion_depth_offset-depth),0.0,1.0);}}res=clamp(2.0*res/float(NX*NY)-0.5,0.0,1.0);return res;}highp float occlusionFade(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec4 depth=getCornerDepths(coord.xy);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z+u_occlusion_depth_offset)-depth),0.0,1.0));}
#else
bool isOccluded(vec4 frag) { return false; }highp float occlusionFade(vec4 frag) { return 1.0; }highp float occlusionFadeMultiSample(vec4 frag) { return 1.0; }
#endif//DEPTH_OCCLUSION`,Qu=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;out vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}
#endif`,Cc=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump vec2 u_fog_vertical_limit;uniform mediump float u_fog_temporal_offset;in vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos,float opacity_limit) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,min(opacity,opacity_limit));}vec3 fog_apply(vec3 color,vec3 pos) {return fog_apply(color,pos,1.0);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec4 fog_apply_premultiplied(vec4 color,vec3 pos,float heightMeters) {float verticalProgress=(u_fog_vertical_limit.x > 0.0 || u_fog_vertical_limit.y > 0.0) ? smoothstep(u_fog_vertical_limit.x,u_fog_vertical_limit.y,heightMeters) : 0.0;float opacityLimit=1.0-smoothstep(0.9,1.0,fog_opacity(pos));return mix(fog_apply_premultiplied(color,pos),color,min(verticalProgress,opacityLimit));}vec3 fog_dither(vec3 color) {return color;}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}
#endif`,qn=`#ifdef RASTER_ARRAY
uniform highp sampler2D u_image0;uniform sampler2D u_image1;const vec4 NODATA=vec4(1);ivec4 _raTexLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}vec2 _raTexLinearMix(highp vec2 fxy,highp vec4 colorMix,highp float colorOffset,highp vec4 t00,highp vec4 t10,highp vec4 t01,highp vec4 t11) {vec2 c00=t00==NODATA ? vec2(0) : vec2(colorOffset+dot(t00,colorMix),1);vec2 c10=t10==NODATA ? vec2(0) : vec2(colorOffset+dot(t10,colorMix),1);vec2 c01=t01==NODATA ? vec2(0) : vec2(colorOffset+dot(t01,colorMix),1);vec2 c11=t11==NODATA ? vec2(0) : vec2(colorOffset+dot(t11,colorMix),1);return mix(mix(c01,c11,fxy.x),mix(c00,c10,fxy.x),fxy.y);}vec2 raTexture2D_image0_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image0,c.yz,0),texelFetch(u_image0,c.xz,0),texelFetch(u_image0,c.yw,0),texelFetch(u_image0,c.xw,0)
);}vec2 raTexture2D_image1_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image1,c.yz,0),texelFetch(u_image1,c.xz,0),texelFetch(u_image1,c.yw,0),texelFetch(u_image1,c.xw,0)
);}vec2 raTexture2D_image0_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image0,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}vec2 raTexture2D_image1_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image1,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}
#endif`,Mc=`#ifdef RASTER_ARRAY
uniform sampler2D u_velocity;uniform mediump vec2 u_velocity_res;uniform mediump float u_max_speed;const vec4 NO_DATA=vec4(1);const vec2 INVALID_VELOCITY=vec2(-1);uniform highp vec2 u_uv_offset;uniform highp float u_data_offset;uniform highp vec2 u_data_scale;ivec4 rasterArrayLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}highp vec2 lookup_velocity(highp vec2 uv) {uv=u_uv_offset.x+u_uv_offset.y*uv;highp vec2 fxy;ivec4 c=rasterArrayLinearCoord(uv,u_velocity_res,fxy);highp vec4 tl=texelFetch(u_velocity,c.yz,0);highp vec4 tr=texelFetch(u_velocity,c.xz,0);highp vec4 bl=texelFetch(u_velocity,c.yw,0);highp vec4 br=texelFetch(u_velocity,c.xw,0);if (tl==NO_DATA) {return INVALID_VELOCITY;}if (tr==NO_DATA) {return INVALID_VELOCITY;}if (bl==NO_DATA) {return INVALID_VELOCITY;}if (br==NO_DATA) {return INVALID_VELOCITY;}highp vec4 t=mix(mix(bl,br,fxy.x),mix(tl,tr,fxy.x),fxy.y);highp vec2 velocity=u_data_offset+vec2(dot(t.rg,u_data_scale),dot(t.ba,u_data_scale));velocity.y=-velocity.y;velocity/=max(u_max_speed,length(velocity));return velocity;}
#endif
uniform highp float u_particle_pos_scale;uniform highp vec2 u_particle_pos_offset;highp vec4 pack_pos_to_rgba(highp vec2 p) {highp vec2 v=(p+u_particle_pos_offset)/u_particle_pos_scale;highp vec4 r=vec4(v.x,fract(v.x*255.0),v.y,fract(v.y*255.0));return vec4(r.x-r.y/255.0,r.y,r.z-r.w/255.0,r.w);}highp vec2 unpack_pos_from_rgba(highp vec4 v) {v=floor(v*255.0+0.5)/255.0;highp vec2 p=vec2(v.x+(v.y/255.0),v.z+(v.w/255.0));return u_particle_pos_scale*p-u_particle_pos_offset;}`,dt=`#ifdef RENDER_SHADOWS
uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_normal_offset;vec3 shadow_normal_offset(vec3 normal) {float tileInMeters=u_shadow_normal_offset[0];vec3 n=vec3(-normal.xy,tileInMeters*normal.z);float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return n*dotScale;}vec3 shadow_normal_offset_model(vec3 normal) {vec3 transformed_normal=vec3(-normal.xy,normal.z);float NDotL=dot(normalize(transformed_normal),u_shadow_direction);float dotScale=min(1.0-NDotL,1.0)*0.5+0.5;return normal*dotScale;}float shadow_normal_offset_multiplier0() {return u_shadow_normal_offset[1];}float shadow_normal_offset_multiplier1() {return u_shadow_normal_offset[2];}
#endif//RENDER_SHADOWS`,eh=`#ifdef RENDER_SHADOWS
precision highp sampler2DShadow;uniform sampler2DShadow u_shadowmap_0;uniform sampler2DShadow u_shadowmap_1;uniform float u_shadow_intensity;uniform float u_shadow_map_resolution;uniform float u_shadow_texel_size;uniform highp vec3 u_shadow_normal_offset;uniform vec2 u_fade_range;uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_bias;float shadow_sample(sampler2DShadow shadowmap,highp vec3 pos,highp float bias) {highp vec3 coord=vec3(pos.xy*0.5+0.5,pos.z*0.5+0.5-bias);return texture(shadowmap,coord);}float shadow_occlusion(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,highp float bias) {light_view_pos0.xyz/=light_view_pos0.w;
#ifdef SHADOWS_SINGLE_CASCADE
vec2 abs_bounds=abs(light_view_pos0.xy);if (abs_bounds.x >=1.0 || abs_bounds.y >=1.0) {return 0.0;}return shadow_sample(u_shadowmap_0,light_view_pos0.xyz,bias);
#else
light_view_pos1.xyz/=light_view_pos1.w;vec4 abs_bounds=abs(vec4(light_view_pos0.xy,light_view_pos1.xy));if (abs_bounds.x < 1.0 && abs_bounds.y < 1.0) {return shadow_sample(u_shadowmap_0,light_view_pos0.xyz,bias);}if (abs_bounds.z >=1.0 || abs_bounds.w >=1.0) {return 0.0;}float occlusion1=shadow_sample(u_shadowmap_1,light_view_pos1.xyz,bias);return clamp(mix(occlusion1,0.0,smoothstep(u_fade_range.x,u_fade_range.y,view_depth)),0.0,1.0);
#endif
}highp float calculate_shadow_bias(float NDotL) {
#ifdef NORMAL_OFFSET
return 0.5*u_shadow_bias.x;
#else
return 0.5*(u_shadow_bias.x+clamp(u_shadow_bias.y*tan(acos(NDotL)),0.0,u_shadow_bias.z));
#endif
}float shadowed_light_factor_normal(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_opacity(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,float shadow_opacity) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias)*shadow_opacity;return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_unbiased(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}highp vec2 compute_receiver_plane_depth_bias(highp vec3 pos_dx,highp vec3 pos_dy)
{highp vec2 biasUV=vec2(
pos_dy.y*pos_dx.z-pos_dx.y*pos_dy.z,pos_dx.x*pos_dy.z-pos_dy.x*pos_dx.z);biasUV*=1.0/((pos_dx.x*pos_dy.y)-(pos_dx.y*pos_dy.x));return biasUV;}float shadowed_light_factor_plane_bias(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {highp vec3 light_view_pos0_xyz=light_view_pos0.xyz/light_view_pos0.w*0.5+0.5;highp vec3 light_view_pos0_ddx=dFdx(light_view_pos0_xyz);highp vec3 light_view_pos0_ddy=dFdy(light_view_pos0_xyz);highp vec2 plane_depth_bias=compute_receiver_plane_depth_bias(light_view_pos0_ddx,light_view_pos0_ddy);highp float bias=dot(vec2(u_shadow_texel_size,u_shadow_texel_size),plane_depth_bias)+0.0001;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadowed_light_factor(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadow_occlusion(float ndotl,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=calculate_shadow_bias(ndotl);return shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);}
#endif`;const wa=[];Jn(El,wa),Jn(Ju,wa),Jn(Ku,wa);const Ta={"_prelude_fog.vertex.glsl":Qu,"_prelude_terrain.vertex.glsl":ba,"_prelude_shadow.vertex.glsl":dt,"_prelude_fog.fragment.glsl":Cc,"_prelude_shadow.fragment.glsl":eh,"_prelude_lighting.glsl":`
#ifdef LIGHTING_3D_MODE
uniform mediump vec3 u_lighting_ambient_color;uniform mediump vec3 u_lighting_directional_dir;uniform mediump vec3 u_lighting_directional_color;uniform mediump vec3 u_ground_radiance;float calculate_ambient_directional_factor(vec3 normal) {float NdotL=dot(normal,u_lighting_directional_dir);const float factor_reduction_max=0.3;float dir_luminance=dot(u_lighting_directional_color,vec3(0.2126,0.7152,0.0722));float directional_factor_min=1.0-factor_reduction_max*min(dir_luminance,1.0);float ambient_directional_factor=mix(directional_factor_min,1.0,min((NdotL+1.0),1.0));const float vertical_factor_min=0.92;float vertical_factor=mix(vertical_factor_min,1.0,normal.z*0.5+0.5);return vertical_factor*ambient_directional_factor;}vec3 linearProduct(vec3 srgbIn,vec3 k) {return srgbIn*pow(k,vec3(1./2.2));}vec3 apply_lighting(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return linearProduct(color,ambient_contrib+directional_contrib);}vec4 apply_lighting(vec4 color,vec3 normal,float dir_factor) {return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting(vec3 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return apply_lighting(color.rgb,normal,dir_factor);}vec4 apply_lighting(vec4 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting_ground(vec3 color) {return color*u_ground_radiance;}vec4 apply_lighting_ground(vec4 color) {return vec4(apply_lighting_ground(color.rgb),color.a);}float calculate_NdotL(vec3 normal) {const float ext=0.70710678118;return (clamp(dot(normal,u_lighting_directional_dir),-ext,1.0)+ext)/(1.0+ext);}vec4 apply_lighting_with_emission_ground(vec4 color,float emissive_strength) {return mix(apply_lighting_ground(color),color,emissive_strength);}vec3 compute_flood_lighting(vec3 flood_light_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=flood_light_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);float occlusion_ramp=smoothstep(0.0,0.2,1.0-occlusion);return mix(fully_occluded_color,flood_light_color,occlusion_ramp);}vec3 compute_emissive_draped(vec3 unlit_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=unlit_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);return mix(fully_occluded_color,unlit_color,1.0-occlusion);}
#endif//LIGHTING_3D_MODE`,"_prelude_raster_array.glsl":qn,"_prelude_raster_particle.glsl":Mc},Il={};pi("",ba),pi(Cc,Qu),pi(eh,dt),pi(qn,""),pi(Mc,"");const Al=pi(Ku,Ju),gs=El;var Pc={background:pi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec4 u_color;uniform float u_opacity;
#ifdef LIGHTING_3D_MODE
in vec4 v_color;
#endif
void main() {vec4 out_color;
#ifdef LIGHTING_3D_MODE
out_color=v_color;
#else
out_color=u_color;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_lighting.glsl"
in vec2 a_pos;uniform mat4 u_matrix;
#ifdef LIGHTING_3D_MODE
uniform mediump vec4 u_color;out vec4 v_color;uniform float u_emissive_strength;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef LIGHTING_3D_MODE
v_color=apply_lighting_with_emission_ground(u_color,u_emissive_strength);
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),backgroundPattern:pi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_pattern_tl;uniform vec2 u_pattern_br;uniform vec2 u_texsize;uniform float u_opacity;uniform float u_emissive_strength;uniform sampler2D u_image;in highp vec2 v_pos;void main() {highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(u_pattern_tl/u_texsize,u_pattern_br/u_texsize,imagecoord);vec4 out_color=textureLodCustom(u_image,pos,v_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pattern_size;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec2 u_pattern_units_to_pixels;in vec2 a_pos;out highp vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_pattern_size,u_pattern_units_to_pixels,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),building:pi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec4 v_color;in highp vec3 v_normal;in highp float v_height;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;
#endif
uniform lowp float u_opacity;vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 apply_lighting_linear(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return color*(ambient_contrib+directional_contrib);}void main() {vec4 color=vec4(v_color.rgb,1.0);vec3 normal=normalize(v_normal);vec3 xy_flipped_normal=vec3(-normal.xy,normal.z);float shadowed_lighting_factor=0.0;
#ifdef RENDER_SHADOWS
shadowed_lighting_factor=shadowed_light_factor_normal(xy_flipped_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
shadowed_lighting_factor=dot(normal,u_lighting_directional_dir);
#endif
color.rgb=apply_lighting_linear(color.rgb,xy_flipped_normal,shadowed_lighting_factor);color.rgb=mix(color.rgb,v_color.rgb,v_color.a);
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos,v_height));
#endif
color.rgb=linearTosRGB(color.rgb);color*=u_opacity;
#ifdef RENDER_CUTOFF
color*=v_cutoff_opacity;
#endif
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,v_height);
#endif
glFragColor=color; 
#ifdef DEBUG_SHOW_NORMALS
color.rgb=xy_flipped_normal*0.5+vec3(0.5,0.5,0.5);color.a=1.0;glFragColor=color;
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec3 a_pos_3f;in vec3 a_normal_3f;out vec4 v_color;out highp vec3 v_normal;out highp float v_height;uniform mat4 u_matrix;uniform mat4 u_normal_matrix;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;
#endif
vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}
#pragma mapbox: define-attribute-vertex-shader-only highp vec2 part_color_emissive
void main() {
#pragma mapbox: initialize-attribute-custom highp vec2 part_color_emissive
vec4 color_emissive=decode_color(part_color_emissive);v_color=vec4(sRGBToLinear(color_emissive.rgb),color_emissive.a);v_normal=vec3(u_normal_matrix*vec4(a_normal_3f,0.0));vec3 pos=a_pos_3f;v_height=pos.z;gl_Position=u_matrix*vec4(pos,1.0);
#ifdef RENDER_SHADOWS
vec3 shadow_pos=pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset_model(v_normal);shadow_pos+=offset*shadow_normal_offset_multiplier0();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shadow_pos,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(shadow_pos,1.0);v_depth_shadows=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
}`),buildingDepth:pi(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,"in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;void main() {gl_Position=u_matrix*vec4(a_pos_3f,1.0);v_depth=gl_Position.z/gl_Position.w;}"),circle:pi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec3 v_data;in float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
uniform float u_emissive_strength;void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float blur_positive=blur < 0.0 ? 0.0 : 1.0;lowp float antialiasblur=v_data.z;float extrude_length=length(extrude)+antialiasblur*(1.0-blur_positive);float antialiased_blur=-max(abs(blur),antialiasblur);float antialiase_blur_opacity=smoothstep(0.0,antialiasblur,extrude_length-1.0);float opacity_t=blur_positive==1.0 ? 
smoothstep(0.0,-antialiased_blur,1.0-extrude_length) : 
smoothstep(antialiased_blur,0.0,extrude_length-1.0)-antialiase_blur_opacity;float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(
antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)
);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_apply_premultiplied(out_color,v_fog_pos);
#endif
glFragColor=out_color*(v_visibility*opacity_t);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define NUM_VISIBILITY_RINGS 2
#define INV_SQRT2 0.70710678
#define ELEVATION_BIAS 0.0001
#define NUM_SAMPLES_PER_RING 16
uniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
#ifdef ELEVATED_ROADS
in float a_circle_z_offset;
#endif
out vec3 v_data;out float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
vec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {
#if defined(TERRAIN)
return elevation(pos)+ELEVATION_BIAS;
#else
return 0.0;
#endif
}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);
#ifdef PITCH_WITH_MAP
#ifdef PROJECTION_GLOBE_VIEW
return u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );
#else
return u_matrix*( world_center+vec4(sample_offset,0,0) );
#endif
#else
return projected_center+vec4(sample_offset,0,0);
#endif
}float get_sample_step() {
#ifdef PITCH_WITH_MAP
return 2.0*PI/float(NUM_SAMPLES_PER_RING);
#else
return PI/float(NUM_SAMPLES_PER_RING);
#endif
}void main(void) {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);
#else 
surface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);
#endif
#ifdef ELEVATED_ROADS
world_center.z+=a_circle_z_offset+ELEVATION_BIAS;
#endif
vec4 projected_center=u_matrix*world_center;float view_scale=0.0;
#ifdef PITCH_WITH_MAP
#ifdef SCALE_WITH_MAP
view_scale=1.0;
#else
view_scale=projected_center.w/u_camera_to_center_distance;
#endif
#else
#ifdef SCALE_WITH_MAP
view_scale=u_camera_to_center_distance;
#else
view_scale=projected_center.w;
#endif
#endif
gl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;
#ifdef TERRAIN
float step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;
#ifdef PITCH_WITH_MAP
float cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;
#else
occlusion_world_center=world_center;occlusion_projected_center=projected_center;
#endif
for(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);
#else
visibility=1.0;
#endif
#ifdef PROJECTION_GLOBE_VIEW
visibility=1.0;
#endif
v_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);
#ifdef FOG
v_fog_pos=fog_position(world_center.xyz);
#endif
}`),clippingMask:pi("void main() {glFragColor=vec4(1.0);}","in vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:pi(`#include "_prelude_fog.fragment.glsl"
uniform highp float u_intensity;in vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);glFragColor=vec4(val,1.0,1.0,1.0);
#ifdef FOG
if (u_is_globe==0) {glFragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
out vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main(void) {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#else
pos=vec3(tilePos+extrude,elevation(tilePos));
#endif
gl_Position=u_matrix*vec4(pos,1);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),heatmapTexture:pi(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));glFragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(0.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,"in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:pi("in float v_placed;in float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);glFragColor =mix(red,blue,step(0.5,v_placed))*0.5;glFragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",`#include "_prelude_terrain.vertex.glsl"
in vec3 a_pos;in vec2 a_anchor_pos;in vec2 a_extrude;in vec2 a_placed;in vec2 a_shift;in vec2 a_elevation_from_sea;in float a_size_scale;in vec2 a_padding;in float a_auto_z_offset;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;out float v_placed;out float v_notUsed;void main() {float feature_elevation=a_elevation_from_sea.x+a_auto_z_offset;float terrain_elevation=(a_elevation_from_sea.y==1.0 ? 0.0 : elevation(a_anchor_pos));vec4 projectedPoint=u_matrix*vec4(a_pos+elevationVector(a_anchor_pos)*(feature_elevation+terrain_elevation),1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}`),collisionCircle:pi("in float v_radius;in vec2 v_extrude;in float v_perspective_ratio;in float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);glFragColor=color*alpha*opacity_t;}",`in vec2 a_pos_2f;in float a_radius;in vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;out float v_radius;out vec2 v_extrude;out float v_perspective_ratio;out float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(
mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}`),debug:pi("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);glFragColor=mix(u_color,overlay_color,overlay_color.a);}",`#include "_prelude_terrain.vertex.glsl"
in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;
#endif
out vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
gl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);
#else
gl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);
#endif
}`),elevatedStructuresDepth:pi(`void main() {
#ifndef DEPTH_TEXTURE
glFragColor=vec4(0.);
#endif
}`,"in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform float u_depth_bias;void main() {gl_Position=u_matrix*vec4(a_pos,a_height,1);gl_Position.z=gl_Position.z+u_depth_bias;}"),elevatedStructuresDepthReconstruct:pi(`#ifdef DEPTH_RECONSTRUCTION
in float v_height;
#endif
void main() {
#ifdef DEPTH_RECONSTRUCTION
if (v_height >=0.0)
discard;
#endif
glFragColor=vec4(1.0,0.0,0.0,1.0);}`,`in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform vec3 u_camera_pos;uniform highp float u_depth_bias;uniform lowp float u_height_scale;uniform lowp float u_reset_depth;
#ifdef DEPTH_RECONSTRUCTION
out float v_height;
#endif
void main() {vec3 vpos=vec3(a_pos,a_height*u_height_scale);
#ifdef DEPTH_RECONSTRUCTION
if (u_camera_pos.z > vpos.z) {vpos-=(u_camera_pos-vpos)*(vpos.z/(u_camera_pos.z-vpos.z));}v_height=a_height;
#endif
gl_Position=u_matrix*vec4(vpos,1);gl_Position.z=u_reset_depth==1.0 ? gl_Position.w : gl_Position.z+u_depth_bias;}`),elevatedStructures:pi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
in vec3 v_normal;in float v_height;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth;
#endif
vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}vec3 compute_view_dependent_emissive_color(float ndotl,float emissive_strength,vec3 color)
{color=sRGBToLinear(color);color=color*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);color=linearTosRGB(color.rgb);return color;}uniform float u_emissive_strength;
#pragma mapbox: define highp vec4 structure_color
void main() {
#pragma mapbox: initialize highp vec4 structure_color
vec3 color=structure_color.xyz;
#ifdef LIGHTING_3D_MODE
vec3 normal=normalize(v_normal);vec3 transformed_normal=vec3(-normal.xy,normal.z);float ndotl=calculate_NdotL(transformed_normal);float emissive_strength=u_emissive_strength;emissive_strength=0.0;vec3 emissive_color=compute_view_dependent_emissive_color(ndotl,emissive_strength,color.xyz);
#ifdef RENDER_SHADOWS
float shadowed_lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth);color.rgb=apply_lighting(color.rgb,transformed_normal,shadowed_lighting_factor);
#else
color=apply_lighting(color,transformed_normal);
#endif
color=mix(color,emissive_color,emissive_strength);if (v_height < 0.0) {float penetration=max(v_height+7.5,0.0);float occlusion=1.0-1.0/PI*acos(1.0-penetration/4.0);color=color*(1.0-pow(occlusion,2.0)*0.3);}
#endif
#ifdef FOG
color=fog_apply(color,v_fog_pos);
#endif
vec4 out_color=vec4(color,1.0);
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_height);
#endif
glFragColor=out_color;HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;in float a_height;in vec3 a_pos_normal_3;uniform mat4 u_matrix;out vec3 v_normal;out float v_height;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth;
#endif
#pragma mapbox: define highp vec4 structure_color
void main() {
#pragma mapbox: initialize highp vec4 structure_color
v_normal=a_pos_normal_3/16384.0;v_height=a_height;vec3 pos=vec3(a_pos,a_height);gl_Position=u_matrix*vec4(pos,1);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=pos;vec3 shd_pos1=pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(-v_normal.xy,v_normal.z));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fill:pi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
vec4 out_color=color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
out_color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
out_color*=opacity;
#ifdef INDICATOR_CUTOUT
if (v_z_offset >=0.0) {out_color=applyCutout(out_color,v_z_offset);}
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;out highp float v_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
uniform mat4 u_matrix;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp float z_offset
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;v_road_z_offset=z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=z_offset;
#endif
}`),fillOutline:pi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
in highp vec2 v_pos;uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
uniform mat4 u_matrix;uniform vec2 u_world;out highp vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp float z_offset
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutlinePattern:pi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FILL_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
in highp vec2 v_pos;in highp vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);float dist=length(v_pos_world-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef FILL_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
out highp vec2 v_pos;out highp vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define lowp float pixel_ratio
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize lowp float pixel_ratio
#pragma mapbox: initialize highp float z_offset
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);v_pos_world=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillPattern:pi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FILL_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
in highp vec2 v_pos;uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef FILL_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
out_color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;out highp float v_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
out highp vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define lowp float pixel_ratio
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
#pragma mapbox: initialize highp float z_offset
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;v_road_z_offset=z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillExtrusion:pi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec4 v_color;in vec4 v_flat;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;
#endif
uniform lowp float u_opacity;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec2 v_ao;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
in vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
in highp vec3 v_normal;
#endif
uniform vec3 u_flood_light_color;uniform highp float u_vertical_scale;uniform float u_flood_light_intensity;uniform vec3 u_ground_shadow_factor;
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
in float v_flood_radius;in float v_has_floodlight;
#endif
in float v_height;
#pragma mapbox: define highp float emissive_strength
void main() {
#pragma mapbox: initialize highp float emissive_strength
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
vec3 normal=normalize(v_normal);
#endif
float z;vec4 color=v_color;
#ifdef ZERO_ROOF_RADIUS
z=float(normal.z > 0.00001);
#ifdef LIGHTING_3D_MODE
normal=mix(normal,vec3(0.0,0.0,1.0),z);
#else
color=mix(v_color,v_roof_color,z);
#endif
#endif
float h=max(0.0,v_height);float ao_shade=1.0;
#ifdef FAUX_AO
float intensity=u_ao[0];float h_floors=h/(u_ao[1]*u_vertical_scale);float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);ao_shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;
#ifdef ZERO_ROOF_RADIUS
concave*=(1.0-z);
#endif
float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);ao_shade*=mix(1.0,x_shade*x_shade*x_shade,concave);
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
color.rgb*=mix(ao_shade,1.0,v_has_floodlight);
#else
color.rgb*=ao_shade;
#endif
#else
color.rgb*=ao_shade;
#endif
#endif
#ifdef LIGHTING_3D_MODE
float flood_radiance=0.0;
#ifdef FLOOD_LIGHT
flood_radiance=(1.0-min(h/v_flood_radius,1.0))*u_flood_light_intensity*v_has_floodlight;
#endif
#ifdef RENDER_SHADOWS
#ifdef FLOOD_LIGHT
float ndotl_unclamped=dot(normal,u_shadow_direction);float ndotl=max(0.0,ndotl_unclamped);float occlusion=ndotl_unclamped < 0.0 ? 1.0 : shadow_occlusion(ndotl,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 litColor=apply_lighting(color.rgb,normal,(1.0-u_shadow_intensity*occlusion)*ndotl);vec3 floodLitColor=compute_flood_lighting(u_flood_light_color*u_opacity,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=mix(litColor,floodLitColor,flood_radiance);
#else
float shadowed_lighting_factor;
#ifdef RENDER_CUTOFF
shadowed_lighting_factor=shadowed_light_factor_normal_opacity(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,v_cutoff_opacity);if (v_cutoff_opacity==0.0) {discard;}
#else
shadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);
#endif
color.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);
#endif
#else
color.rgb=apply_lighting(color.rgb,normal);
#ifdef FLOOD_LIGHT
color.rgb=mix(color.rgb,u_flood_light_color*u_opacity,flood_radiance);
#endif
#endif
color.rgb=mix(color.rgb,v_flat.rgb,emissive_strength);color*=u_opacity;
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos,h));
#endif
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,h);
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_lighting.glsl"
uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;uniform float u_width_scale;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
uniform highp float u_vertical_scale;out vec4 v_color;out vec4 v_flat;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
out vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
out highp vec3 v_normal;
#endif
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec2 v_ao;
#endif
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
out float v_flood_radius;out float v_has_floodlight;
#endif
out float v_height;vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
#pragma mapbox: define highp float flood_light_wall_radius
#pragma mapbox: define highp float line_width
#pragma mapbox: define highp float emissive_strength
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize highp float flood_light_wall_radius
#pragma mapbox: initialize highp float line_width
#pragma mapbox: initialize highp float emissive_strength
base*=u_vertical_scale;height*=u_vertical_scale;vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
v_normal=normal;
#endif
base=max(0.0,base);float attr_height=height;height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=0.0;float c_ele=0.0;vec3 pos;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);
#else
h=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
float cutoff=1.0;vec3 scaled_pos=pos;
#ifdef RENDER_CUTOFF
vec3 centroid_random=vec3(centroid_pos.xy,centroid_pos.x+centroid_pos.y+1.0);vec3 ground_pos=centroid_pos.x==0.0 ? pos.xyz : (centroid_random/8.0);vec4 ground=u_matrix*vec4(ground_pos.xy,ele,1.0);cutoff=cutoff_opacity(u_cutoff_params,ground.z);if (centroid_pos.y !=0.0 && centroid_pos.x !=0.0) {vec3 g=floor(ground_pos);vec3 mod_=centroid_random-g*8.0;float seed=min(1.0,0.1*(min(3.5,max(mod_.x+mod_.y,0.2*attr_height))*0.35+mod_.z));if (cutoff < 0.8-seed) {cutoff=0.0;}}float cutoff_scale=cutoff;v_cutoff_opacity=cutoff;scaled_pos.z=mix(c_ele,h,cutoff_scale);
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (cutoff==0.0 && centroid_pos.x !=0.0) || (color.a==0.0));
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);scaled_pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;scaled_pos.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
gl_Position=mix(u_matrix*vec4(scaled_pos,1),AWAY,hidden);h=h-ele;v_height=h;
#ifdef RENDER_SHADOWS
vec3 shd_pos0=pos;vec3 shd_pos1=pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);
#endif
float NdotL=0.0;float colorvalue=0.0;
#ifndef LIGHTING_3D_MODE
colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),NdotL);if (normal.y !=0.0) {float r=0.84;r=mix(0.7,0.98,1.0-u_lightintensity);NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#endif
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec2(mix(concave,-concave,start),y_ground);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
float is_wall=1.0-float(t > 0.0 && top_up_ny.y > 0.0);v_has_floodlight=float(flood_light_wall_radius > 0.0 && is_wall > 0.0);v_flood_radius=flood_light_wall_radius*u_vertical_scale;
#endif
v_color=vec4(color.rgb,1.0);float ndotl=calculate_NdotL(normal);v_flat.rgb=sRGBToLinear(color.rgb);v_flat.rgb=v_flat.rgb*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);v_flat=vec4(linearTosRGB(v_flat.rgb),1.0);
#else
v_color=vec4(0.0,0.0,0.0,1.0);v_color.rgb+=clamp(color.rgb*NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
float roofNdotL=clamp(u_lightpos.z,0.0,1.0);roofNdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roofNdotL);v_roof_color=vec4(0.0,0.0,0.0,1.0);v_roof_color.rgb+=clamp(color.rgb*roofNdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_roof_color*=u_opacity;
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),fillExtrusionDepth:pi(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;uniform float u_edge_radius;uniform float u_width_scale;uniform float u_vertical_scale;
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp float line_width
#pragma mapbox: define highp vec4 color
out highp float v_depth;void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp float line_width
#pragma mapbox: initialize highp vec4 color
base*=u_vertical_scale;height*=u_vertical_scale;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
vec3 pos;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;float ele=elevation(pos_nx.xy);float c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);float h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);
#else
pos=vec3(pos_nx.xy,t > 0.0 ? height : base);
#endif
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;pos.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);v_depth=gl_Position.z/gl_Position.w;}`),fillExtrusionPattern:pi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
in vec3 v_normal;
#endif
in highp vec2 v_pos;in vec4 v_lighting;uniform lowp float u_opacity;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define highp float pixel_ratio
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize highp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting(out_color,normalize(v_normal))*u_opacity;
#else
out_color=out_color*v_lighting;
#endif
#ifdef FAUX_AO
float intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,height);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_lighting.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform float u_tile_units_to_pixels;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_width_scale;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
out highp vec2 v_pos;out vec4 v_lighting;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
out vec3 v_normal;
#endif
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define highp float pixel_ratio
#pragma mapbox: define highp float line_width
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize highp float pixel_ratio
#pragma mapbox: initialize highp float line_width
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=z;vec3 p;float c_ele;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;p=vec3(pos_nx.xy,h);
#else
p=vec3(pos_nx.xy,z);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);p.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;p.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0
? pos_nx.xy
: vec2(edgedistance,z*u_height_factor);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float NdotL=0.0;
#ifdef LIGHTING_3D_MODE
NdotL=calculate_NdotL(normal);
#else
NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),NdotL);
#endif
if (normal.y !=0.0) {float r=0.84;
#ifndef LIGHTING_3D_MODE
r=mix(0.7,0.98,1.0-u_lightintensity);
#endif
NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
v_normal=normal;
#else
v_lighting.rgb+=clamp(NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;
#endif
#ifdef FOG
v_fog_pos=fog_position(p);
#endif
}`),groundShadow:pi(`#include "_prelude_shadow.fragment.glsl"
precision highp float;uniform vec3 u_ground_shadow_factor;in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;
#ifdef FOG
in float v_fog_opacity;
#endif
void main() {float light=shadowed_light_factor_plane_bias(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 shadow=mix(u_ground_shadow_factor,vec3(1.0),light);
#ifdef RENDER_CUTOFF
shadow=mix(vec3(1.0),shadow,cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w));
#endif
#ifdef FOG
shadow=mix(shadow,vec3(1.0),v_fog_opacity);
#endif
#ifdef INDICATOR_CUTOUT
shadow=mix(shadow,vec3(1.0),1.0-applyCutout(vec4(1.0),0.0).r);
#endif
glFragColor=vec4(shadow,1.0);}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;in vec2 a_pos;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;
#ifdef FOG
out float v_fog_opacity;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0.0,1.0);v_pos_light_view_0=u_light_matrix_0*vec4(a_pos,0.0,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(a_pos,0.0,1.0);
#ifdef FOG
v_fog_pos=fog_position(a_pos);v_fog_opacity=fog(v_fog_pos);
#endif
}`),fillExtrusionGroundEffect:pi(`uniform highp float u_ao_pass;uniform highp float u_opacity;uniform highp float u_flood_light_intensity;uniform highp vec3 u_flood_light_color;uniform highp float u_attenuation;uniform sampler2D u_fb;uniform float u_fb_size;
#ifdef SDF_SUBPASS
in highp vec2 v_pos;in highp vec4 v_line_segment;in highp float v_flood_light_radius_tile;in highp vec2 v_ao;float line_df(highp vec2 a,highp vec2 b,highp vec2 p) {highp vec2 ba=b-a;highp vec2 pa=p-a;highp float r=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);return length(pa-r*ba);}
#ifdef FOG
in highp float v_fog;
#endif
#endif
void main() {
#ifdef CLEAR_SUBPASS
vec4 color=vec4(1.0);
#ifdef CLEAR_FROM_TEXTURE
color=texture(u_fb,gl_FragCoord.xy/vec2(u_fb_size));
#endif
glFragColor=color;
#else
#ifdef SDF_SUBPASS
highp float d=line_df(v_line_segment.xy,v_line_segment.zw,v_pos);highp float effect_radius=mix(v_flood_light_radius_tile,v_ao.y,u_ao_pass);d/=effect_radius;d=min(d,1.0);d=1.0-pow(1.0-d,u_attenuation);highp float effect_intensity=mix(u_flood_light_intensity,v_ao.x,u_ao_pass);highp float fog=1.0;
#ifdef FOG
fog=v_fog;
#endif
#ifdef RENDER_CUTOFF
fog*=v_cutoff_opacity;
#endif
glFragColor=vec4(vec3(0.0),mix(1.0,d,effect_intensity*u_opacity*fog));
#else
vec4 color=mix(vec4(u_flood_light_color,1.0),vec4(vec3(0.0),1.0),u_ao_pass);
#ifdef OVERDRAW_INSPECTOR
color=vec4(1.0);
#endif
glFragColor=color;
#endif
HANDLE_WIREFRAME_DEBUG;
#endif
}`,`#include "_prelude_fog.vertex.glsl"
in highp vec4 a_pos_end;in highp float a_angular_offset_factor;in highp float a_hidden_by_landmark;
#ifdef SDF_SUBPASS
out highp vec2 v_pos;out highp vec4 v_line_segment;out highp float v_flood_light_radius_tile;out highp vec2 v_ao;
#ifdef FOG
out highp float v_fog;
#endif
#endif
uniform highp float u_flood_light_intensity;uniform highp mat4 u_matrix;uniform highp float u_ao_pass;uniform highp float u_meter_to_tile;uniform highp float u_edge_radius;uniform highp float u_dynamic_offset;uniform highp vec2 u_ao;
#pragma mapbox: define highp float flood_light_ground_radius
const float TANGENT_CUTOFF=4.0;const float NORM=32767.0;void main() {
#pragma mapbox: initialize highp float flood_light_ground_radius
vec2 p=a_pos_end.xy;vec2 q=floor(a_pos_end.zw*0.5);vec2 start_bottom=a_pos_end.zw-q*2.0;float fl_ground_radius=flood_light_ground_radius;fl_ground_radius=abs(flood_light_ground_radius);float direction=flood_light_ground_radius < 0.0 ?-1.0 : 1.0;float flood_radius_tile=fl_ground_radius*u_meter_to_tile;vec2 v=normalize(q-p);float ao_radius=u_ao.y/3.5;float effect_radius=mix(flood_radius_tile,ao_radius,u_ao_pass)+u_edge_radius;float angular_offset_factor=a_angular_offset_factor/NORM*TANGENT_CUTOFF;float angular_offset=direction*angular_offset_factor*effect_radius;float top=1.0-start_bottom.y;float side=(0.5-start_bottom.x)*2.0;vec2 extrusion_parallel=v*side*mix(u_dynamic_offset,angular_offset,top);vec2 perp=vec2(v.y,-v.x);vec2 extrusion_perp=direction*perp*effect_radius*top;vec3 pos=vec3(mix(q,p,start_bottom.x),0.0);pos.xy+=extrusion_parallel+extrusion_perp;
#ifdef SDF_SUBPASS
v_pos=pos.xy;v_line_segment=vec4(p,q)+perp.xyxy*u_edge_radius;v_flood_light_radius_tile=flood_radius_tile;v_ao=vec2(u_ao.x,ao_radius);
#ifdef FOG
v_fog_pos=fog_position(pos);v_fog=1.0-fog(v_fog_pos);
#endif
#endif
float hidden_by_landmark=0.0;
#ifdef HAS_CENTROID
hidden_by_landmark=a_hidden_by_landmark;
#endif
float isFloodlit=float(fl_ground_radius > 0.0 && u_flood_light_intensity > 0.0);float hidden=mix(1.0-isFloodlit,isFloodlit,u_ao_pass);hidden+=hidden_by_landmark;gl_Position=mix(u_matrix*vec4(pos,1.0),AWAY,float(hidden > 0.0));
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
}`),hillshadePrepare:pi(`precision highp float;uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;float getElevation(vec2 coord) {return texture(u_image,coord).r/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos+vec2(epsilon.x,0));float f=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float g=getElevation(v_pos+vec2(0,epsilon.y));float h=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(
(c+e+e+h)-(a+d+d+f),(f+g+g+h)-(a+b+b+c)
)/pow(2.0,exaggeration+(19.2562-u_zoom));glFragColor=clamp(vec4(
deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:pi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;uniform float u_emissive_strength;void main() {vec4 pixel=texture(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);glFragColor=accent_color*(1.0-shade_color.a)+shade_color;
#ifdef LIGHTING_3D_MODE
glFragColor=apply_lighting_with_emission_ground(glFragColor,u_emissive_strength);
#endif
#ifdef FOG
glFragColor=fog_dither(fog_apply_premultiplied(glFragColor,v_fog_pos));
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),line:pi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform lowp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_floor_width_scale;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec3 v_uv;
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef RENDER_LINE_DASH
uniform sampler2D u_dash_image;in vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform sampler2D u_gradient_image;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
float luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}uniform float u_emissive_strength;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
float linearstep(float edge0,float edge1,float x) {return  clamp((x-edge0)/(edge1-edge0),0.0,1.0);}void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);
#ifdef RENDER_LINE_DASH
float sdfdist=texture(u_dash_image,v_tex).r;float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/dash.z;float scaled_floorwidth=(floorwidth*u_floor_width_scale);alpha*=linearstep(0.5-sdfgamma/scaled_floorwidth,0.5+sdfgamma/scaled_floorwidth,sdfdist);
#endif
highp vec4 out_color;
#ifdef RENDER_LINE_GRADIENT
out_color=texture(u_gradient_image,v_uv.xy);
#else
out_color=color;
#endif
float trim_alpha=1.0;
#ifdef RENDER_LINE_TRIM_OFFSET
highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);out_color=mix(out_color,u_trim_color,transition_factor);trim_alpha=1.0-transition_factor;}
#endif
if (u_alpha_discard_threshold !=0.0) {if (alpha < u_alpha_discard_threshold) {discard;}}
#ifdef RENDER_LINE_BORDER
float edgeBlur=((border_width*u_width_scale)+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);if (border_color.a==0.0) {float Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}} else {out_color=mix(border_color*trim_alpha,out_color,smoothAlpha);}}
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
out_color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
out_color*=(alpha*opacity);
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_z_offset);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define EXTRUDE_SCALE 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#if defined(ELEVATED) || defined(ELEVATED_ROADS) || defined(VARIABLE_LINE_WIDTH)
in vec3 a_z_offset_width;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
in highp vec3 a_packed;
#endif
#ifdef RENDER_LINE_DASH
in float a_linesofar;
#endif
uniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;uniform float u_width_scale;uniform highp float u_floor_width_scale;
#ifdef ELEVATED
uniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {
#ifdef ELEVATION_REFERENCE_SEA
return 0.0;
#else
return elevation(apos);
#endif
}
#endif
out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec3 v_uv;
#ifdef ELEVATED_ROADS
out highp float v_road_z_offset;
#endif
#ifdef RENDER_LINE_DASH
uniform vec2 u_texsize;uniform float u_tile_units_to_pixels;out vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform float u_image_height;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
float a_z_offset;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
a_z_offset=a_z_offset_width.x;
#endif
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth;
#ifdef VARIABLE_LINE_WIDTH
float left=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);halfwidth=(u_width_scale*(left==1.0 ? a_z_offset_width.y : a_z_offset_width.z))/2.0;
#else
halfwidth=(u_width_scale*width)/2.0;
#endif
offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;
#ifdef ELEVATED_ROADS
v_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;
#else
#ifdef ELEVATED
vec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;
#ifdef CROSS_SLOPE_VERTICAL
float top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);
#else
#ifdef CROSS_SLOPE_HORIZONTAL
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;
#else
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;
#endif
#endif
gl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);
#else
gl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);
#endif
#endif
#ifdef ELEVATED_ROADS
#ifdef RENDER_SHADOWS
vec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#endif
#ifndef RENDER_TO_TEXTURE
float epsilon=0.0001;float extrude_length_without_perspective=max(length(dist),epsilon);float extrude_length_with_perspective=max(length(projected_extrude_xy/gl_Position.w*u_units_to_pixels),epsilon);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));
#else
v_gamma_scale=1.0;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
highp float a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float line_progress=a_packed[2];
#ifdef RENDER_LINE_GRADIENT
highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec3(a_uv_x,a_split_index*texel_height-half_texel_height,line_progress);
#else
v_uv=vec3(a_uv_x,0.0,line_progress);
#endif
#endif
#ifdef RENDER_LINE_DASH
float scale=dash.z==0.0 ? 0.0 : u_tile_units_to_pixels/dash.z;float height=dash.y;v_tex=vec2(a_linesofar*scale/(floorwidth*u_floor_width_scale),(-normal.y*height+dash.x+0.5)/u_texsize.y);
#endif
v_width2=vec2(outset,inset);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=a_z_offset;
#endif
}`),linePattern:pi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform highp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_alpha_discard_threshold;uniform highp vec2 u_texsize;uniform highp float u_tile_units_to_pixels;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;uniform sampler2D u_image;
#ifdef LINE_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
in vec2 v_normal;in vec2 v_width2;in highp float v_linesofar;in float v_gamma_scale;in float v_width;
#ifdef RENDER_LINE_TRIM_OFFSET
in highp vec3 v_uv;
#endif
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef LINE_JOIN_NONE
in vec2 v_pattern_data;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
uniform float u_emissive_strength;
#pragma mapbox: define mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define mediump float pixel_ratio
#pragma mapbox: define mediump float blur
#pragma mapbox: define mediump float opacity
void main() {
#pragma mapbox: initialize mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize mediump float pixel_ratio
#pragma mapbox: initialize mediump float blur
#pragma mapbox: initialize mediump float opacity
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;highp float pattern_size=display_size.x/u_tile_units_to_pixels;float aspect=display_size.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);highp float pattern_x=v_linesofar/pattern_size*aspect;highp float x=mod(pattern_x,1.0);highp float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;highp vec2 pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(x,y));highp vec2 lod_pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(pattern_x,y));vec4 color=textureLodCustom(u_image,pos,lod_pos);
#ifdef LINE_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl*texel_size-texel_size,pattern_b_br*texel_size+texel_size,vec2(x,y));vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);color=color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);color=mix(color,color.a*u_trim_color,transition_factor);}
#endif
#ifdef LINE_JOIN_NONE
highp float pattern_len=pattern_size/aspect;highp float segment_phase=pattern_len-mod(v_linesofar-v_pattern_data.x+pattern_len,pattern_len);highp float visible_start=segment_phase-step(pattern_len*0.5,segment_phase)*pattern_len;highp float visible_end=floor((v_pattern_data.y-segment_phase)/pattern_len)*pattern_len+segment_phase;visible_end+=step(pattern_len*0.5,v_pattern_data.y-visible_end)*pattern_len;if (v_pattern_data.x < visible_start || v_pattern_data.x >=visible_end) {color=vec4(0.0);}
#endif
#ifdef LIGHTING_3D_MODE
color=apply_lighting_with_emission_ground(color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=(alpha*opacity);if (u_alpha_discard_threshold !=0.0) {if (color.a < u_alpha_discard_threshold) {discard;}}
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,v_z_offset);
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define scale 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
in vec3 a_z_offset_width;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
in highp vec3 a_packed;
#endif
in highp float a_linesofar;
#ifdef LINE_JOIN_NONE
in highp vec3 a_pattern_data;out vec2 v_pattern_data;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
uniform mat4 u_matrix;uniform float u_tile_units_to_pixels;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform float u_device_pixel_ratio;uniform float u_width_scale;uniform float u_floor_width_scale;
#ifdef ELEVATED
uniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {
#ifdef ELEVATION_REFERENCE_SEA
return 0.0;
#else
return elevation(apos);
#endif
}
#endif
out vec2 v_normal;out vec2 v_width2;out highp float v_linesofar;out float v_gamma_scale;out float v_width;
#ifdef RENDER_LINE_TRIM_OFFSET
out highp vec3 v_uv;
#endif
#ifdef ELEVATED_ROADS
out highp float v_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define mediump float blur
#pragma mapbox: define mediump float opacity
#pragma mapbox: define mediump float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define mediump float floorwidth
#pragma mapbox: define mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define mediump float pixel_ratio
void main() {
#pragma mapbox: initialize mediump float blur
#pragma mapbox: initialize mediump float opacity
#pragma mapbox: initialize mediump float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize mediump float floorwidth
#pragma mapbox: initialize mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize mediump float pixel_ratio
float a_z_offset;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
a_z_offset=a_z_offset_width.x;
#endif
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=(u_width_scale*width)/2.0;offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);vec2 dist=outset*a_extrude*scale;float u=0.5*a_direction;float t=1.0-abs(u);vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;
#ifdef ELEVATED_ROADS
v_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;
#else
#ifdef ELEVATED
vec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;
#ifdef CROSS_SLOPE_VERTICAL
float top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);
#else
#ifdef CROSS_SLOPE_HORIZONTAL
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;
#else
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;
#endif
#endif
gl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);
#else
gl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);
#endif
#endif
#ifdef ELEVATED_ROADS
#ifdef RENDER_SHADOWS
vec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#endif
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude_xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));
#else
v_gamma_scale=1.0;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
highp float a_uv_x=a_packed[0];highp float line_progress=a_packed[2];v_uv=vec3(a_uv_x,0.0,line_progress);
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=(floorwidth*u_floor_width_scale);
#ifdef LINE_JOIN_NONE
v_width=(floorwidth*u_floor_width_scale)+ANTIALIASING;mediump float pixels_to_tile_units=1.0/u_tile_units_to_pixels;mediump float pixel_ratio_inverse=1.0/pixel_ratio;mediump float aspect=v_width/((pattern.w-pattern.y)*pixel_ratio_inverse);highp float subt_multiple=(pattern.z-pattern.x)*pixel_ratio_inverse*pixels_to_tile_units*aspect*32.0;highp float subt=floor(a_pattern_data.z/subt_multiple)*subt_multiple;float offset_sign=(fract(a_pattern_data.x)-0.5)*4.0;float line_progress_offset=offset_sign*v_width*0.5*pixels_to_tile_units;v_linesofar=(a_pattern_data.z-subt)+a_linesofar+line_progress_offset;v_pattern_data=vec2(a_pattern_data.x+line_progress_offset,a_pattern_data.y);
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=a_z_offset;
#endif
}`),raster:pi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_raster_array.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;uniform highp float u_zoom_transition;in vec2 v_pos0;in vec2 v_pos1;in float v_depth;
#ifdef PROJECTION_GLOBE_VIEW
in float v_split_fade;
#endif
uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;uniform float u_emissive_strength;
#ifndef RASTER_ARRAY
uniform highp sampler2D u_image0;uniform sampler2D u_image1;
#endif
#ifdef RASTER_COLOR
uniform sampler2D u_color_ramp;uniform highp vec4 u_colorization_mix;uniform highp float u_colorization_offset;uniform vec2 u_texture_res;
#endif
void main() {vec4 color0,color1,color;vec2 value;
#ifdef RASTER_COLOR
#ifdef RASTER_ARRAY
#ifdef RASTER_ARRAY_LINEAR
value=mix(
raTexture2D_image0_linear(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_linear(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#else
value=mix(
raTexture2D_image0_nearest(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_nearest(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#endif
if (value.y > 0.0) value.x/=value.y;
#else
color=mix(texture(u_image0,v_pos0),texture(u_image1,v_pos1),u_fade_t);value=vec2(u_colorization_offset+dot(color.rgb,u_colorization_mix.rgb),color.a);
#endif
color=texture(u_color_ramp,vec2(value.x,0.5));if (color.a > 0.0) color.rgb/=color.a;color.a*=value.y;
#else
color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);
#endif
color.a*=u_opacity;
#ifdef GLOBE_POLES
color.a*=1.0-smoothstep(0.0,0.05,u_zoom_transition);
#endif
vec3 rgb=color.rgb;rgb=vec3(
dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),u_emissive_strength).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef PROJECTION_GLOBE_VIEW
glFragColor*=mix(1.0,1.0-smoothstep(0.0,0.05,u_zoom_transition),smoothstep(0.8,0.9,v_split_fade));
#endif
#ifdef RENDER_CUTOFF
glFragColor=glFragColor*cutoff_opacity(u_cutoff_params,v_depth);
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;uniform vec2 u_texture_offset;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;in vec2 a_texture_pos;
#endif
out vec2 v_pos0;out vec2 v_pos1;out float v_depth;
#ifdef PROJECTION_GLOBE_VIEW
out float v_split_fade;
#endif
void main() {vec2 uv;
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;gl_Position=u_matrix*u_globe_matrix*vec4(globe_pos   ,1.0);uv=a_uv;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(a_globe_pos,1.0)).xyz);
#endif
#else
float w=1.0+dot(a_texture_pos,u_perspective_transform);uv=a_texture_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);    
v_split_fade=0.0;if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;float opposite_merc_center=mod(u_merc_center.x+0.5,1.0);float dist_from_poles=(abs(mercatorY-0.5)*2.0);float range=0.1;v_split_fade=abs(opposite_merc_center-mercatorX);v_split_fade=clamp(1.0-v_split_fade,0.0,1.0);v_split_fade=max(smoothstep(1.0-range,1.0,dist_from_poles),max(smoothstep(1.0-range,1.0,v_split_fade),smoothstep(1.0-range,1.0,1.0-v_split_fade)));}float tiles=u_grid_matrix[0][2];if (tiles > 0.0) {float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvY=mercatorY*tiles-idy;float uvX=mercatorX*tiles-idx;uv=vec2(uvX,uvY);}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;v_pos0=u_texture_offset.x+u_texture_offset.y*v_pos0;v_pos1=u_texture_offset.x+u_texture_offset.y*v_pos1;
#ifdef RENDER_CUTOFF
v_depth=gl_Position.z;
#endif
}`),rasterParticle:pi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;in vec2 v_pos0;in vec2 v_pos1;uniform sampler2D u_image0;uniform sampler2D u_image1;void main() {vec4 color0,color1,color;color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 out_color=color.rgb;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),0.0).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8
in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {float w=1.0;vec2 uv;
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvX=mercatorX*tiles-idx;float uvY=mercatorY*tiles-idy;uv=vec2(uvX,uvY);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
uv=a_texture_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}`),rasterParticleDraw:pi("uniform sampler2D u_color_ramp;in float v_particle_speed;void main() {glFragColor=texture(u_color_ramp,vec2(v_particle_speed,0.5));}",`#include "_prelude_raster_particle.glsl"
in float a_index;uniform sampler2D u_particle_texture;uniform float u_particle_texture_side_len;uniform vec2 u_tile_offset;out float v_particle_speed;void main() {ivec2 pixel_coord=ivec2(
mod(a_index,u_particle_texture_side_len),a_index/u_particle_texture_side_len);vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);vec2 pos=unpack_pos_from_rgba(pixel)+u_tile_offset;vec2 tex_coord=fract(pos);vec2 velocity=lookup_velocity(tex_coord);if (velocity==INVALID_VELOCITY) {gl_Position=AWAY;v_particle_speed=0.0;} else {gl_Position=vec4(2.0*pos-1.0,0,1);v_particle_speed=length(velocity);}gl_PointSize=1.0;}`),rasterParticleTexture:pi("uniform sampler2D u_texture;uniform float u_opacity;in vec2 v_tex_pos;void main() {vec4 color=texture(u_texture,v_tex_pos);glFragColor=vec4(floor(255.0*color*u_opacity)/255.0);}","in vec2 a_pos;out vec2 v_tex_pos;void main() {vec2 uv=0.5*a_pos+vec2(0.5);v_tex_pos=uv;gl_Position=vec4(a_pos,0.0,1.0);}"),rasterParticleUpdate:pi(`#include "_prelude_raster_particle.glsl"
uniform sampler2D u_particle_texture;uniform mediump float u_particle_texture_side_len;uniform mediump float u_speed_factor;uniform highp float u_reset_rate;uniform highp float u_rand_seed;in highp vec2 v_tex_coord;vec2 linearstep(vec2 edge0,vec2 edge1,vec2 x) {return  clamp((x-edge0)/(edge1-edge0),vec2(0),vec2(1));}const highp vec3 rand_constants=vec3(12.9898,78.233,4375.85453);highp float rand(const highp vec2 co) {highp float t=dot(rand_constants.xy,co);return fract(sin(t)*(rand_constants.z+t));}void main() {ivec2 pixel_coord=ivec2(v_tex_coord*u_particle_texture_side_len);highp vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);highp vec2 pos=unpack_pos_from_rgba(pixel);highp vec2 velocity=lookup_velocity(clamp(pos,0.0,1.0));highp vec2 dp=velocity==INVALID_VELOCITY ? vec2(0) : velocity*u_speed_factor;pos=pos+dp;highp vec2 seed=(pos+v_tex_coord)*u_rand_seed;highp vec2 random_pos=vec2(rand(seed+1.3),rand(seed+2.1));highp vec2 persist_rate=pow(
linearstep(vec2(-u_particle_pos_offset),vec2(0),pos)*linearstep(vec2(1.0+u_particle_pos_offset),vec2(1),pos),vec2(4)
);highp vec2 per_frame_persist=pow(persist_rate,abs(dp)/u_particle_pos_offset);highp float drop_rate=1.0-per_frame_persist.x*per_frame_persist.y;drop_rate=any(greaterThanEqual(abs(pos-0.5),vec2(0.5+u_particle_pos_offset))) ? 1.0 : drop_rate;highp float drop=step(1.0-drop_rate-u_reset_rate,rand(seed));highp vec2 next_pos=mix(pos,random_pos,drop);glFragColor=pack_pos_to_rgba(next_pos);}`,"in vec2 a_pos;out vec2 v_tex_coord;void main() {v_tex_coord=0.5*(a_pos+vec2(1.0));gl_Position=vec4(a_pos,0.0,1.0);}"),symbol:pi(`#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;uniform bool u_is_halo;uniform lowp float u_scale_factor;
#ifdef ICON_TRANSITION
uniform float u_icon_transition;
#endif
#ifdef COLOR_ADJUSTMENT
uniform mat4 u_color_adj_mat;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#else
#ifdef Z_OFFSET
#ifdef RENDER_SHADOWS
in highp float v_z_offset;
#endif
#endif
#endif
in vec2 v_tex_a;
#ifdef ICON_TRANSITION
in vec2 v_tex_b;
#endif
in float v_draw_halo;in vec3 v_gamma_scale_size_fade_opacity;
#ifdef RENDER_TEXT_AND_SYMBOL
in float is_sdf;in vec2 v_tex_a_icon;
#endif
#ifdef Z_OFFSET
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#endif
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
vec4 out_color;float fade_opacity=v_gamma_scale_size_fade_opacity[2];
#ifdef RENDER_TEXT_AND_SYMBOL
if (is_sdf==ICON) {vec2 tex_icon=v_tex_a_icon;lowp float alpha=opacity*fade_opacity;glFragColor=texture(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
return;}
#endif
#ifdef RENDER_SDF
float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_gamma_scale_size_fade_opacity.x;float size=v_gamma_scale_size_fade_opacity.y;float fontScale=u_is_text ? size/24.0 : size;out_color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {out_color=halo_color;gamma=(halo_blur*u_scale_factor*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width*u_scale_factor/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,v_tex_a).r;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);out_color*=alpha;
#else
#ifdef ICON_TRANSITION
vec4 a=texture(u_texture,v_tex_a)*(1.0-u_icon_transition);vec4 b=texture(u_texture,v_tex_b)*u_icon_transition;out_color=(a+b);
#else
out_color=texture(u_texture,v_tex_a);
#endif
#ifdef COLOR_ADJUSTMENT
out_color=u_color_adj_mat*out_color;
#endif
#endif
out_color*=opacity*fade_opacity;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,emissive_strength);
#ifdef Z_OFFSET
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(v_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#endif
#endif
#endif
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_z_offset);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;
#ifdef Z_OFFSET
in float a_auto_z_offset;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_globe_anchor;in vec3 a_globe_normal;
#endif
#ifdef ICON_TRANSITION
in vec2 a_texb;
#endif
#ifdef OCCLUSION_QUERIES
in float a_occlusion_query_opacity;
#endif
#ifdef ELEVATED_ROADS
in vec3 a_x_axis;in vec3 a_y_axis;uniform float u_normal_scale;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#else
#ifdef Z_OFFSET
#ifdef RENDER_SHADOWS
out highp float v_z_offset;
#endif
#endif
#endif
uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_elevation_from_sea;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;uniform bool u_is_halo;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
out vec2 v_tex_a;
#ifdef ICON_TRANSITION
out vec2 v_tex_b;
#endif
out float v_draw_halo;out vec3 v_gamma_scale_size_fade_opacity;
#ifdef RENDER_TEXT_AND_SYMBOL
out float is_sdf;out vec2 v_tex_a_icon;
#endif
#ifdef Z_OFFSET
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#endif
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
#pragma mapbox: define lowp float occlusion_opacity
#pragma mapbox: define lowp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
#pragma mapbox: initialize lowp float occlusion_opacity
#pragma mapbox: initialize lowp float z_offset
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=u_elevation_from_sea ? z_offset : z_offset+elevation(tile_anchor);
#ifdef Z_OFFSET
e+=a_auto_z_offset;
#endif
vec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;vec3 world_pos_globe;
#ifdef PROJECTION_GLOBE_VIEW
mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos_globe=a_globe_anchor+h;world_pos=mix_globe_mercator(world_pos_globe,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
world_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;vec2 a;
#ifdef PROJECTION_GLOBE_VIEW
vec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);vec4 projected_point_globe=u_matrix*vec4(world_pos_globe,1);a=projected_point_globe.xy/projected_point_globe.w;
#else
offsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);a=projected_point.xy/projected_point.w;
#endif
vec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;
#ifdef PROJECTION_GLOBE_VIEW
#ifdef PROJECTED_POS_ON_VIEWPORT
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xyz+h,1.0);
#else
vec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz,mercator_pos,u_zoom_transition)+h;projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);    
#endif
#else
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);
#ifdef TERRAIN
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
#endif
#ifdef Z_OFFSET
z+=u_pitch_with_map ? a_auto_z_offset+z_offset : 0.0;
#else
z+=u_pitch_with_map ? z_offset : 0.0;
#endif
float occlusion_fade=globe_occlusion_fade;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float out_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));
#ifdef DEPTH_OCCLUSION
float depth_occlusion=occlusionFadeMultiSample(projected_point);float depth_occlusion_multplier=mix(occlusion_opacity,1.0,depth_occlusion);out_fade_opacity*=depth_occlusion_multplier;
#endif
#ifdef OCCLUSION_QUERIES
float occludedFadeMultiplier=mix(occlusion_opacity,1.0,a_occlusion_query_opacity);out_fade_opacity*=occludedFadeMultiplier;
#endif
float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);vec3 pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);pos=projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y;
#else
#ifdef ELEVATED_ROADS
vec3 xAxis=vec3(a_x_axis.xy,a_x_axis.z*u_normal_scale);vec3 yAxis=vec3(a_y_axis.xy,a_y_axis.z*u_normal_scale);pos=projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y;
#else
pos=vec3(projected_pos.xy/projected_pos.w+offset,z);
#endif
#endif
gl_Position=mix(u_coord_matrix*vec4(pos,1.0),AWAY,hidden);float gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_gamma_scale_size_fade_opacity=vec3(gamma_scale,size,out_fade_opacity);v_tex_a=a_tex/u_texsize;
#ifdef RENDER_TEXT_AND_SYMBOL
is_sdf=a_size[0]-2.0*a_size_min;v_tex_a_icon=a_tex/u_texsize_icon;
#endif
#ifdef ICON_TRANSITION
v_tex_b=a_texb/u_texsize;
#endif
#ifdef Z_OFFSET
#ifdef RENDER_SHADOWS
vec4 shd_pos=u_inv_matrix*vec4(pos,1.0);vec3 shd_pos0=shd_pos.xyz;vec3 shd_pos1=shd_pos.xyz;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=e;
#else
#ifdef Z_OFFSET
#ifdef RENDER_SHADOWS
v_z_offset=e;
#endif
#endif
#endif
}`),terrainRaster:pi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;in vec2 v_pos0;
#ifdef FOG
in float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;
#endif
uniform vec3 u_ground_shadow_factor;void main() {vec4 image_color=texture(u_image0,v_pos0);vec4 color;
#ifdef LIGHTING_3D_MODE
const vec3 normal=vec3(0.0,0.0,1.0);
#ifdef RENDER_SHADOWS
float cutoffOpacity=1.0;
#ifdef RENDER_CUTOFF
cutoffOpacity=cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w);
#endif
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
vec3 unlit_base=image_color.rgb*(1.0-image_color.a);vec3 emissive_base=image_color.rgb*image_color.a;float ndotl=u_shadow_direction.z;float occlusion=ndotl < 0.0 ? 1.0 : shadow_occlusion(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,0.0);ndotl=max(0.0,ndotl);vec3 lit=apply_lighting(unlit_base,normal,mix(1.0,(1.0-(u_shadow_intensity*occlusion))*ndotl,cutoffOpacity));vec3 emissive=compute_emissive_draped(emissive_base,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=lit+emissive;color.a=1.0;
#else
float lighting_factor=shadowed_light_factor_normal_unbiased(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);color=apply_lighting(image_color,normal,mix(1.0,lighting_factor,cutoffOpacity));
#endif
#else
float lighting_factor=u_lighting_directional_dir.z;color=apply_lighting(image_color,normal,lighting_factor);
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
color.rgb=mix(color.rgb,image_color.rgb,image_color.a);color.a=1.0;
#endif
#endif
#else
color=image_color;
#endif
#ifdef FOG
#ifdef ZERO_EXAGGERATION
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#else
color=fog_dither(fog_apply_from_vert(color,v_fog_opacity));
#endif
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;uniform float u_skirt_height;in vec2 a_pos;out vec2 v_pos0;
#ifdef FOG
out float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;out float v_depth;
#endif
void main() {vec3 decomposedPosAndSkirt=decomposeToPosAndSkirt(a_pos);float skirt=decomposedPosAndSkirt.z;vec2 decodedPos=decomposedPosAndSkirt.xy;float elevation=elevation(decodedPos)-skirt*u_skirt_height;v_pos0=decodedPos/8192.0;gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);
#ifdef FOG
#ifdef ZERO_EXAGGERATION
v_fog_pos=fog_position(decodedPos);
#else
v_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));
#endif
#endif
#ifdef RENDER_SHADOWS
vec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);
#endif
}`),terrainDepth:pi("precision highp float;in float v_depth;void main() {glFragColor=pack_depth(v_depth);}",`#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;out float v_depth;void main() {float elevation=elevation(a_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}`),skybox:pi(`#include "_prelude_fog.fragment.glsl"
in lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(
cos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=texture(u_cubemap,uv).rgb;
#ifdef FOG
sky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);
#endif
sky_color+=0.1*sun_disk(v_uv,u_sun_direction);glFragColor=vec4(sky_color*u_opacity,u_opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,xa),skyboxGradient:pi(`#include "_prelude_fog.fragment.glsl"
in highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture(u_color_ramp,vec2(progress,0.5));
#ifdef FOG
color.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;
#endif
color*=u_opacity;glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,xa),skyboxCapture:pi(`
in highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;precision highp float;
#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)
#define BETA_M                  vec3(21e-6,21e-6,21e-6)
#define MIE_G                   0.76
#define DENSITY_HEIGHT_SCALE_R  8000.0
#define DENSITY_HEIGHT_SCALE_M  1200.0
#define PLANET_RADIUS           6360e3
#define ATMOSPHERE_RADIUS       6420e3
#define SAMPLE_STEPS            10
#define DENSITY_STEPS           4
float ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;glFragColor=vec4(color,1.0);}`,"in highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;out highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:pi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;uniform float u_far_z_cutoff;in vec2 v_pos0;
#ifndef FOG
uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;
#endif
void main() {vec4 color;
#ifdef CUSTOM_ANTIALIASING
highp vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;highp float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);highp float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
raster=apply_lighting_with_emission_ground(raster,raster.a);color=vec4(clamp(raster.rgb,vec3(0),vec3(1))*antialias,antialias);
#else
raster=apply_lighting_ground(raster);color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
color=apply_lighting_with_emission_ground(color,color.a);color.a=1.0;
#else
color=apply_lighting_ground(color);
#endif
#endif
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=1.0-step(u_far_z_cutoff,1.0/gl_FragCoord.w);glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;uniform float u_skirt_height;
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;
#endif
out vec2 v_pos0;void main() {
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;vec2 uv=a_uv;
#else
float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);
#endif
v_pos0=uv;vec2 tile_pos=uv*EXTENT;vec3 globe_derived_up_vector=normalize(globe_pos)*u_tile_up_scale;
#ifdef GLOBE_POLES
vec3 up_vector=globe_derived_up_vector;
#else
vec3 up_vector=elevationVector(tile_pos);
#endif
float height=elevation(tile_pos);globe_pos+=up_vector*height;
#ifndef GLOBE_POLES
globe_pos-=globe_derived_up_vector*u_skirt_height*decomposed_pos_and_skirt.z;
#endif
#ifdef GLOBE_POLES
vec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);
#else
vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height-u_skirt_height*decomposed_pos_and_skirt.z,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);
#endif
gl_Position=u_proj_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
}`),globeAtmosphere:pi(`#include "_prelude_fog.fragment.glsl"
uniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec4 u_color;uniform vec4 u_high_color;uniform vec4 u_space_color;uniform float u_horizon_angle;in highp vec3 v_ray_dir;in highp vec3 v_horizon_dir;void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;
#ifdef PROJECTION_GLOBE_VIEW
globe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {
#ifdef ALPHA_PASS
glFragColor=vec4(0,0,0,0);return;
#else
#ifdef NATIVE
glFragColor=vec4(1,1,1,1);
#else
glFragColor=vec4(0,0,0,1);
#endif
return;
#endif
}
#endif
highp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?
0.0 : max(acos(clamp(dot(dir,horizon_dir),-1.0,1.0)),0.0);float horizon_angle;
#ifdef PROJECTION_GLOBE_VIEW
highp vec3 closest_point=globe_pos_dot_dir*dir;highp float closest_point_to_center=length(closest_point-u_globe_pos);highp float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?
PI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);
#else
horizon_angle=horizon_angle_mercator;
#endif
horizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;
#ifdef ALPHA_PASS
float a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);glFragColor=vec4(1.0,1.0,1.0,a);
#else
vec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c=c2;glFragColor=vec4(c*t,t);
#endif
}`,`in vec3 a_pos;in vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;out highp vec3 v_ray_dir;out highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(
mix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}`),model:pi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_opacity;uniform vec3 u_lightcolor;uniform vec3 u_lightpos;uniform float u_lightintensity;uniform vec4 u_baseColorFactor;uniform vec4 u_emissiveFactor;uniform float u_metallicFactor;uniform float u_roughnessFactor;uniform float u_emissive_strength;in highp vec4 v_position_height;in lowp vec4 v_color_mix;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;
#endif
#ifdef OCCLUSION_TEXTURE_TRANSFORM
uniform vec4 u_occlusionTextureTransform;
#endif
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#ifdef HAS_ATTRIBUTE_a_pbr
in lowp vec4 v_roughness_metallic_emissive_alpha;in mediump vec4 v_height_based_emission_params;
#endif
#ifdef HAS_TEXTURE_u_baseColorTexture
uniform sampler2D u_baseColorTexture;uniform bool u_baseTextureIsAlpha;uniform bool u_alphaMask;uniform float u_alphaCutoff;
#endif
#ifdef HAS_TEXTURE_u_metallicRoughnessTexture
uniform sampler2D u_metallicRoughnessTexture;
#endif
#ifdef HAS_TEXTURE_u_occlusionTexture
uniform sampler2D u_occlusionTexture;uniform float u_aoIntensity;
#endif
#ifdef HAS_TEXTURE_u_normalTexture
uniform sampler2D u_normalTexture;
#endif
#ifdef HAS_TEXTURE_u_emissionTexture
uniform sampler2D u_emissionTexture;
#endif
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
in highp float v_depth;uniform highp sampler2D u_depthTexture;uniform highp vec2 u_inv_depth_size;uniform highp vec2 u_depth_range_unpack;
#ifdef DEPTH_D24
highp float unpack_depth(highp float depth) {return  depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}
#else
highp float unpack_depth_rgba(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}
#endif
bool isOccluded() {highp vec2 coord=gl_FragCoord.xy*u_inv_depth_size;
#ifdef DEPTH_D24
highp float depth=unpack_depth(texture(u_depthTexture,coord).r);
#else
highp float depth=unpack_depth_rgba(texture(u_depthTexture,coord));
#endif
return v_depth > depth+0.0005;}
#endif
#define saturate(_x) clamp(_x,0.,1.)
vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}float calculate_NdotL(vec3 normal,vec3 lightDir) {const float ext=0.70710678118;return (clamp(dot(normal,lightDir),-ext,1.0)+ext)/(1.0+ext);}vec3 getDiffuseShadedColor(vec3 albedo,vec3 normal,vec3 lightDir,vec3 lightColor)
{
#ifdef LIGHTING_3D_MODE
vec3 transformed_normal=vec3(-normal.xy,normal.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=saturate(dot(transformed_normal,u_lighting_directional_dir));
#endif
return apply_lighting(albedo,transformed_normal,lighting_factor);
#else
vec3 n=normal;float colorvalue=((albedo.x*0.2126)+(albedo.y*0.7152))+(albedo.z*0.0722);vec3 c=vec3(0.03,0.03,0.03);float directional=clamp(dot(n,vec3(lightDir)),0.0,1.0);directional=mix(1.0-u_lightintensity,max((1.0-colorvalue)+u_lightintensity,1.0),directional);vec3 c3=c+clamp((albedo*directional)*lightColor,mix(vec3(0.0),vec3(0.3),vec3(1.0)-lightColor),vec3(1.0));return c3;
#endif
}vec4 getBaseColor() {vec4 albedo=u_baseColorFactor;
#ifdef HAS_ATTRIBUTE_a_color_3f
albedo*=vec4(color_3f,1.0);
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#else
#ifdef HAS_ATTRIBUTE_a_color_4f
albedo*=color_4f;
#endif
#endif
#if defined (HAS_TEXTURE_u_baseColorTexture) && defined (HAS_ATTRIBUTE_a_uv_2f)
vec4 texColor=texture(u_baseColorTexture,uv_2f);if(u_alphaMask) {if (texColor.w < u_alphaCutoff) {discard;}}
#ifdef UNPREMULT_TEXTURE_IN_SHADER
if(texColor.w > 0.0) {texColor.rgb/=texColor.w;}texColor.w=1.0;
#endif
if(u_baseTextureIsAlpha) {if (texColor.r < 0.5) {discard;}} else {texColor.rgb=sRGBToLinear(texColor.rgb);albedo*=texColor;}
#endif
vec4 color=vec4(mix(albedo.rgb,v_color_mix.rgb,v_color_mix.a),albedo.a);
#ifdef APPLY_LUT_ON_GPU
color=applyLUT(u_lutTexture,color);
#endif
return color;}highp mat3 cotangentFrame(highp vec3 N,highp vec3 p,highp vec2 uv ) {
#ifdef HAS_TEXTURE_u_normalTexture
highp vec3 dp1=vec3(dFdx(p.x),dFdx(p.y),dFdx(p.z));highp vec3 dp2=vec3(dFdy(p.x),dFdy(p.y),dFdy(p.z));highp vec2 duv1=vec2(dFdx(uv.x),dFdx(uv.y));highp vec2 duv2=vec2(dFdy(uv.x),dFdy(uv.y));highp vec3 dp2perp=cross( dp2,N );highp vec3 dp1perp=cross( N,dp1 );highp vec3 T=dp2perp*duv1.x+dp1perp*duv2.x;highp vec3 B=dp2perp*duv1.y+dp1perp*duv2.y;highp float lengthT=dot(T,T);highp float lengthB=dot(B,B);highp float maxLength=max(lengthT,lengthB);highp float invmax=inversesqrt( maxLength );highp mat3 res=mat3( T*invmax,B*invmax,N );return res;
#else
return mat3(1.0);
#endif
}highp vec3 getNormal(){highp vec3 n;
#ifdef HAS_ATTRIBUTE_a_normal_3f
n=normalize(normal_3f);
#else
highp vec3 fdx=vec3(dFdx(v_position_height.x),dFdx(v_position_height.y),dFdx(v_position_height.z));highp vec3 fdy=vec3(dFdy(v_position_height.x),dFdy(v_position_height.y),dFdy(v_position_height.z));n=normalize(cross(fdx,fdy))*-1.0;
#endif
#if defined(HAS_TEXTURE_u_normalTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
vec3 nMap=texture( u_normalTexture,uv_2f).xyz;nMap=normalize(2.0*nMap-vec3(1.0));highp vec3 v=normalize(-v_position_height.xyz);highp mat3 TBN=cotangentFrame(n,v,uv_2f);n=normalize(TBN*nMap);
#endif
return n;}struct Material {float perceptualRoughness;float alphaRoughness;float metallic;vec3 f90;vec4 baseColor;vec3 diffuseColor;vec3 specularColor;highp vec3 normal;};Material getPBRMaterial() {Material mat;mat.baseColor=getBaseColor();mat.perceptualRoughness=u_roughnessFactor;mat.metallic=u_metallicFactor;
#ifdef HAS_ATTRIBUTE_a_pbr
mat.perceptualRoughness=v_roughness_metallic_emissive_alpha.x;mat.metallic=v_roughness_metallic_emissive_alpha.y;mat.baseColor.w*=v_roughness_metallic_emissive_alpha.w;
#endif
#if defined(HAS_TEXTURE_u_metallicRoughnessTexture) && defined(HAS_ATTRIBUTE_a_uv_2f) 
vec4 mrSample=texture(u_metallicRoughnessTexture,uv_2f);mat.perceptualRoughness*=mrSample.g;mat.metallic*=mrSample.b;
#endif
const float c_minRoughness=0.04;mat.perceptualRoughness=clamp(mat.perceptualRoughness,c_minRoughness,1.0);mat.metallic=saturate(mat.metallic);mat.alphaRoughness=mat.perceptualRoughness*mat.perceptualRoughness;const vec3 f0=vec3(0.04);mat.diffuseColor=mat.baseColor.rgb*(vec3(1.0)-f0);mat.diffuseColor*=1.0-mat.metallic;mat.specularColor=mix(f0,mat.baseColor.rgb,mat.metallic);highp float reflectance=max(max(mat.specularColor.r,mat.specularColor.g),mat.specularColor.b);highp float reflectance90=saturate(reflectance*25.0);mat.f90=vec3(reflectance90);mat.normal=getNormal();return mat;}float V_GGX(float NdotL,float NdotV,float roughness)
{float a2=roughness*roughness;float GGXV=NdotL*sqrt(NdotV*NdotV*(1.0-a2)+a2);float GGXL=NdotV*sqrt(NdotL*NdotL*(1.0-a2)+a2);return 0.5/(GGXV+GGXL);}float V_GGXFast(float NdotL,float NdotV,float roughness) {float a=roughness;float GGXV=NdotL*(NdotV*(1.0-a)+a);float GGXL=NdotV*(NdotL*(1.0-a)+a);return 0.5/(GGXV+GGXL);}vec3 F_Schlick(vec3 specularColor,vec3 f90,float VdotH)
{return specularColor+(f90-specularColor)*pow(clamp(1.0-VdotH,0.0,1.0),5.0);}vec3 F_SchlickFast(vec3 specularColor,float VdotH)
{float x=1.0-VdotH;float x4=x*x*x*x;return specularColor+(1.0-specularColor)*x4*x;}float D_GGX(highp float NdotH,float alphaRoughness)
{highp float a4=alphaRoughness*alphaRoughness;highp float f=(NdotH*a4-NdotH)*NdotH+1.0;return a4/(PI*f*f);}vec3 diffuseBurley(Material mat,float LdotH,float NdotL,float NdotV)
{float f90=2.0*LdotH*LdotH*mat.alphaRoughness-0.5;return (mat.diffuseColor/PI)*(1.0+f90*pow((1.0-NdotL),5.0))*(1.0+f90*pow((1.0-NdotV),5.0));}vec3 diffuseLambertian(Material mat)
{
#ifdef LIGHTING_3D_MODE
return mat.diffuseColor;
#else
return mat.diffuseColor/PI;
#endif
}vec3 EnvBRDFApprox(vec3 specularColor,float roughness,highp float NdotV)
{vec4 c0=vec4(-1,-0.0275,-0.572,0.022);vec4 c1=vec4(1,0.0425,1.04,-0.04);highp vec4 r=roughness*c0+c1;highp float a004=min(r.x*r.x,exp2(-9.28*NdotV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}vec3 computeIndirectLightContribution(Material mat,float NdotV,vec3 normal)
{vec3 env_light=vec3(0.65,0.65,0.65);
#ifdef LIGHTING_3D_MODE
float ambient_factor=calculate_ambient_directional_factor(normal);env_light=u_lighting_ambient_color*ambient_factor;
#endif
vec3 envBRDF=EnvBRDFApprox(mat.specularColor,mat.perceptualRoughness,NdotV);vec3 indirectSpecular= envBRDF*env_light;vec3 indirectDiffuse=mat.diffuseColor*env_light;return indirectSpecular+indirectDiffuse;}vec3 computeLightContribution(Material mat,vec3 lightPosition,vec3 lightColor)
{highp vec3 n=mat.normal;highp vec3 v=normalize(-v_position_height.xyz);highp vec3 l=normalize(lightPosition);highp vec3 h=normalize(v+l);float NdotV=clamp(abs(dot(n,v)),0.001,1.0);float NdotL=saturate(dot(n,l));highp float NdotH=saturate(dot(n,h));float VdotH=saturate(dot(v,h));vec3 f=F_SchlickFast(mat.specularColor,VdotH);float g=V_GGXFast(NdotL,NdotV,mat.alphaRoughness);float d=D_GGX(NdotH,mat.alphaRoughness);vec3 diffuseTerm=(1.0-f)*diffuseLambertian(mat);vec3 specularTerm=f*g*d;vec3 transformed_normal=vec3(-n.xy,n.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=NdotL;
#endif
vec3 directLightColor=(specularTerm+diffuseTerm)*lighting_factor*lightColor;vec3 indirectLightColor=computeIndirectLightContribution(mat,NdotV,transformed_normal);vec3 color=(saturate(directLightColor)+indirectLightColor);float intensityFactor=1.0;
#if !defined(LIGHTING_3D_MODE)
const vec3 luminosityFactor=vec3(0.2126,0.7152,0.0722);float luminance=dot(diffuseTerm,luminosityFactor);intensityFactor=mix((1.0-u_lightintensity),max((1.0-luminance+u_lightintensity),1.0),NdotL);
#endif
color*=intensityFactor;return color;}void main() {
#ifdef TERRAIN_FRAGMENT_OCCLUSION
if (isOccluded()) {discard;}
#endif
vec3 lightDir=u_lightpos;vec3 lightColor=u_lightcolor;
#ifdef LIGHTING_3D_MODE
lightDir=u_lighting_directional_dir;lightDir.xy=-lightDir.xy;lightColor=u_lighting_directional_color;
#endif
vec4 finalColor;
#ifdef DIFFUSE_SHADED
vec3 N=getNormal();vec3 baseColor=getBaseColor().rgb;vec3 diffuse=getDiffuseShadedColor(baseColor,N,lightDir,lightColor);
#ifdef HAS_TEXTURE_u_occlusionTexture
float ao=(texture(u_occlusionTexture,uv_2f).r-1.0)*u_aoIntensity+1.0;diffuse*=ao;
#endif
finalColor=vec4(mix(diffuse,baseColor,u_emissive_strength),1.0)*u_opacity;
#else
Material mat=getPBRMaterial();vec3 color=computeLightContribution(mat,lightDir,lightColor);float ao=1.0;
#if defined (HAS_TEXTURE_u_occlusionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
#ifdef OCCLUSION_TEXTURE_TRANSFORM
vec2 uv=uv_2f.xy*u_occlusionTextureTransform.zw+u_occlusionTextureTransform.xy;
#else
vec2 uv=uv_2f;
#endif
ao=(texture(u_occlusionTexture,uv).x-1.0)*u_aoIntensity+1.0;color*=ao;
#endif
vec4 emissive=u_emissiveFactor;
#if defined(HAS_TEXTURE_u_emissionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
emissive.rgb*=sRGBToLinear(texture(u_emissionTexture,uv_2f).rgb);
#endif
#ifdef APPLY_LUT_ON_GPU
float emissiveFactorLength=max(length(u_emissiveFactor.rgb),0.001);emissive.rgb=sRGBToLinear(applyLUT(u_lutTexture,linearTosRGB(emissive.rgb/emissiveFactorLength).rbg))*emissiveFactorLength;
#endif
color+=emissive.rgb;float opacity=mat.baseColor.w*u_opacity;
#ifdef HAS_ATTRIBUTE_a_pbr
float resEmission=v_roughness_metallic_emissive_alpha.z;resEmission*=v_height_based_emission_params.z+v_height_based_emission_params.w*pow(clamp(v_height_based_emission_params.x,0.0,1.0),v_height_based_emission_params.y);vec3 color_mix=v_color_mix.rgb;
#ifdef APPLY_LUT_ON_GPU
color_mix=applyLUT(u_lutTexture,color_mix);
#endif
color=mix(color,color_mix,min(1.0,resEmission));
#ifdef HAS_ATTRIBUTE_a_color_4f
float distance=length(vec2(1.3*max(0.0,abs(color_4f.x)-color_4f.z),color_4f.y));distance+= mix(0.5,0.0,clamp(resEmission-1.0,0.0,1.0));opacity*=v_roughness_metallic_emissive_alpha.w*saturate(1.0-distance*distance);
#endif
#endif
vec3 unlitColor=mat.baseColor.rgb*ao+emissive.rgb;color=mix(color,unlitColor,u_emissive_strength);color=linearTosRGB(color);color*=opacity;finalColor=vec4(color,opacity);
#endif
#ifdef FOG
finalColor=fog_dither(fog_apply_premultiplied(finalColor,v_fog_pos,v_position_height.w));
#endif
#ifdef RENDER_CUTOFF
finalColor*=v_cutoff_opacity;
#endif
#ifdef INDICATOR_CUTOUT
finalColor=applyCutout(finalColor,v_position_height.w);
#endif
glFragColor=finalColor;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec3 a_pos_3f;
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute-vertex-shader-only highp vec4 pbr
#pragma mapbox: define-attribute-vertex-shader-only highp vec3 heightBasedEmissiveStrength
uniform mat4 u_matrix;uniform mat4 u_node_matrix;uniform mat4 u_lighting_matrix;uniform vec3 u_camera_pos;uniform vec4 u_color_mix;
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_normal_matrix;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;
#endif
out vec4 v_position_height;out lowp vec4 v_color_mix;
#ifdef TERRAIN_FRAGMENT_OCCLUSION
out highp float v_depth;
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
out lowp vec4 v_roughness_metallic_emissive_alpha;out mediump vec4 v_height_based_emission_params;
#endif
vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute-custom highp vec4 pbr
#pragma mapbox: initialize-attribute-custom highp vec3 heightBasedEmissiveStrength
highp mat4 normal_matrix;
#ifdef INSTANCED_ARRAYS
normal_matrix=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
normal_matrix=u_normal_matrix;
#endif
vec3 local_pos;mat3 rs;
#ifdef MODEL_POSITION_ON_GPU
vec3 pos_color=normal_matrix[0].xyz;vec4 translate=normal_matrix[1];vec3 pos_a=floor(pos_color);vec3 rgb=1.05*(pos_color-pos_a);float hidden=float(pos_a.x > EXTENT);float color_mix=pos_a.z/100.0;v_color_mix=vec4(sRGBToLinear(rgb),color_mix);float meter_to_tile=normal_matrix[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);rs[0].x=normal_matrix[1].w;rs[0].yz=normal_matrix[2].xy;rs[1].xy=normal_matrix[2].zw;rs[1].z=normal_matrix[3].x;rs[2].xyz=normal_matrix[3].yzw;vec4 pos_node=u_lighting_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;local_pos=pos.xyz;gl_Position=mix(u_matrix*pos,AWAY,hidden);pos.z*=meter_to_tile;v_position_height.xyz=pos.xyz-u_camera_pos;
#else
local_pos=a_pos_3f;gl_Position=u_matrix*vec4(a_pos_3f,1);v_position_height.xyz=vec3(u_lighting_matrix*vec4(a_pos_3f,1));v_color_mix=vec4(sRGBToLinear(u_color_mix.rgb),u_color_mix.a);
#endif
v_position_height.w=a_pos_3f.z;
#ifdef HAS_ATTRIBUTE_a_pbr
vec4 albedo_c=decode_color(pbr.xy);vec2 e_r_m=unpack_float(pbr.z);vec2 r_m= unpack_float(e_r_m.y*16.0);r_m.r=r_m.r*16.0;v_color_mix=vec4(albedo_c.rgb,1.0);v_roughness_metallic_emissive_alpha=vec4(vec3(r_m,e_r_m.x)/255.0,albedo_c.a);v_roughness_metallic_emissive_alpha.z*=2.0;float heightBasedRelativeIntepolation=a_pos_3f.z*heightBasedEmissiveStrength.x+heightBasedEmissiveStrength.y;v_height_based_emission_params.x=heightBasedRelativeIntepolation;v_height_based_emission_params.y=heightBasedEmissiveStrength.z;vec2 emissionMultiplierValues=unpack_float(pbr.w)/256.0;v_height_based_emission_params.z=emissionMultiplierValues.x;v_height_based_emission_params.w=emissionMultiplierValues.y-emissionMultiplierValues.x;
#endif
#ifdef FOG
v_fog_pos=fog_position(local_pos);
#endif
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
float x_squared_scale=dot(rs[0],rs[0]);float y_squared_scale=dot(rs[1],rs[1]);float z_squared_scale=dot(rs[2],rs[2]);vec3 squared_scale=vec3(x_squared_scale,y_squared_scale,z_squared_scale);normal_3f=rs*((u_lighting_matrix*vec4(normal_3f,0.0)).xyz/squared_scale);normal_3f=normalize(normal_3f);
#else
normal_3f=vec3(normal_matrix*vec4(normal_3f,0));
#endif
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#ifdef HAS_ATTRIBUTE_a_color_4f
v_roughness_metallic_emissive_alpha.w=clamp(color_4f.a*v_roughness_metallic_emissive_alpha.w*(v_roughness_metallic_emissive_alpha.z-1.0),0.0,1.0);
#endif
#endif
#ifdef RENDER_SHADOWS
vec4 shadow_pos=u_node_matrix*vec4(local_pos,1.0);
#ifdef NORMAL_OFFSET
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
vec3 offset=shadow_normal_offset(vec3(-normal_3f.xy,normal_3f.z));shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();
#else
vec3 offset=shadow_normal_offset_model(normal_3f);shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();
#endif
#endif
#endif
v_pos_light_view_0=u_light_matrix_0*shadow_pos;v_pos_light_view_1=u_light_matrix_1*shadow_pos;v_depth_shadows=gl_Position.w;
#endif
}`),modelDepth:pi(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;
#ifdef MODEL_POSITION_ON_GPU
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_instance;
#endif
uniform highp mat4 u_node_matrix;
#endif
void main() {
#ifdef MODEL_POSITION_ON_GPU
highp mat4 instance;
#ifdef INSTANCED_ARRAYS
instance=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
instance=u_instance;
#endif
vec3 pos_color=instance[0].xyz;vec4 translate=instance[1];vec3 pos_a=floor(pos_color);float hidden=float(pos_a.x > EXTENT);float meter_to_tile=instance[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);mat3 rs;rs[0].x=instance[1].w;rs[0].yz=instance[2].xy;rs[1].xy=instance[2].zw;rs[1].z=instance[3].x;rs[2].xyz=instance[3].yzw;vec4 pos_node=u_node_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;gl_Position=mix(u_matrix*pos,AWAY,hidden);
#else
gl_Position=u_matrix*vec4(a_pos_3f,1);
#endif
v_depth=gl_Position.z/gl_Position.w;}`),stars:pi(`in highp vec2 v_uv;in mediump float v_intensity;float shapeCircle(in vec2 uv)
{float beginFade=0.6;float lengthFromCenter=length(v_uv);return 1.0-clamp((lengthFromCenter-beginFade)/(1.0-beginFade),0.0,1.0);}void main() {float alpha=shapeCircle(v_uv);vec3 color=vec3(1.0,1.0,1.0);alpha*=v_intensity;glFragColor=vec4(color*alpha,alpha);HANDLE_WIREFRAME_DEBUG;}`,`
in vec3 a_pos_3f;in vec2 a_uv;in float a_size_scale;in float a_fade_opacity;uniform mat4 u_matrix;uniform vec3 u_up;uniform vec3 u_right;uniform float u_intensity_multiplier;out highp vec2 v_uv;out mediump float v_intensity;void main() {v_uv=a_uv;v_intensity=a_fade_opacity*u_intensity_multiplier;vec3 pos=a_pos_3f;pos+=a_uv.x*u_right*a_size_scale;pos+=a_uv.y*u_up*a_size_scale;gl_Position=u_matrix*vec4(pos,1.0);}`),snowParticle:pi("in highp vec2 uv;in highp float alphaMultiplier;uniform vec4 u_particleColor;uniform vec2 u_simpleShapeParameters;void main() {float t=clamp((length(uv)-u_simpleShapeParameters.x)/(1.0-u_simpleShapeParameters.x),0.0,1.0);float alpha=1.0-pow(t,pow(10.0,u_simpleShapeParameters.y));alpha*=alphaMultiplier;alpha*=u_particleColor.a;vec3 color=u_particleColor.rgb*alpha;glFragColor=vec4(color,alpha) ;HANDLE_WIREFRAME_DEBUG;}",`
in highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_snowParticleData;in highp vec4 a_snowParticleDataHorizontalOscillation;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform vec2 u_screenSize;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; 
uniform float u_velocity;uniform vec3 u_direction;uniform float u_horizontalOscillationRadius; 
uniform float u_horizontalOscillationRate; 
uniform float u_billboardSize;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;out highp vec2 uv;out highp float alphaMultiplier;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos.xyz*=halfBoxSize;pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_snowParticleData.z;float coneAngleHeadingRad=a_snowParticleData.w*radians(360.0);vec3 localZ=normalize(u_direction);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 direction;direction.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.z=cos(coneAnglePichRad);direction=normalize(direction);vec3 simPosLocal=vec3(0,0,0);float velocityScale=(1.0+3.0*a_snowParticleData.y)*u_velocity;simPosLocal+=direction*velocityScale*u_time;float horizontalOscillationRadius=u_horizontalOscillationRadius*a_snowParticleDataHorizontalOscillation.x;float horizontalOscillationAngle=u_horizontalOscillationRate*u_time*(-1.0+2.0*a_snowParticleDataHorizontalOscillation.y);simPosLocal.xy+=horizontalOscillationRadius*vec2(cos(horizontalOscillationAngle),sin(horizontalOscillationAngle));vec3 simPos=localX*simPosLocal.x+
localY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);float clipZ=-u_cam_pos.z+pos.z;vec4 posView=u_modelview*vec4(pos,1.0);float size=u_billboardSize;alphaMultiplier=1.0;vec4 posScreen=u_projection*posView;posScreen/=posScreen.w;posScreen.xy=vec2(0.5)+posScreen.xy*0.5;posScreen.xy*=u_screenSize;vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=u_screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-posScreen.xy)/(0.5*u_screenSize));screenDist+=a_snowParticleData.x*u_thinningParticleOffset;float scaleFactorMode=0.0;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);if (a_snowParticleData.x < u_thinningAffectedRatio) {scaleFactorMode=1.0-thinningFadeRatio;alphaMultiplier=thinningFadeRatio;}}vec4 posScreen1=u_projection*vec4(posView.x-size,posView.yzw);posScreen1/=posScreen1.w;vec4 posScreen2=u_projection*vec4(posView.x+size,posView.yzw);posScreen2/=posScreen2.w;posScreen1.xy=vec2(0.5)+posScreen1.xy*0.5;posScreen1.xy*=u_screenSize;posScreen2.xy=vec2(0.5)+posScreen2.xy*0.5;posScreen2.xy*=u_screenSize;float screenLength=length(posScreen1.xy-posScreen2.xy);float screenEpsilon=3.0;float scaleFactor=1.0;if (screenLength < screenEpsilon) {scaleFactor=screenEpsilon/max(screenLength,0.01);scaleFactor=mix(scaleFactor,1.0,scaleFactorMode);}float screenEpsilon2=15.0;if (screenLength > screenEpsilon2) {scaleFactor=screenEpsilon2/max(screenLength,0.01);}size*=scaleFactor;vec2 right=size*vec2(1,0);vec2 up=size*vec2(0,1);posView.xy+=right*a_uv.x;posView.xy+=up*a_uv.y;uv=a_uv;gl_Position=u_projection*posView;}`),rainParticle:pi("in highp vec2 uv;in highp float particleRandomValue;uniform sampler2D u_texScreen;uniform float u_distortionStrength;uniform vec4 u_color;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;uniform float u_shapeDirectionalPower;uniform float u_mode;void main() {vec2 st=uv*0.5+vec2(0.5);vec2 uvm=uv;uvm.y=-1.0+2.0*pow(st.y,u_shapeDirectionalPower);float shape=clamp(1.0-length(uvm),0.0,1.0);float alpha=abs(shape)*u_color.a;vec2 screenSize=vec2(textureSize(u_texScreen,0));vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-gl_FragCoord.xy)/(0.5*screenSize));screenDist+=(0.5+0.5*particleRandomValue)*u_thinningParticleOffset;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;float thinningAlpha=1.0;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);thinningAlpha*=thinningFadeRatio;}vec2 offsetXY=normalize(uvm)*abs(shape);vec2 stScreen=(gl_FragCoord.xy+offsetXY*u_distortionStrength*thinningAlpha)/screenSize;vec3 colorScreen=texture(u_texScreen,stScreen).rgb;alpha*=thinningAlpha;glFragColor=mix(vec4(colorScreen,1.0),vec4(u_color.rgb*alpha,alpha),u_mode);HANDLE_WIREFRAME_DEBUG;}",`
in highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_rainParticleData;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; 
uniform float u_velocity; 
uniform vec2 u_rainDropletSize;uniform vec3 u_rainDirection;out highp vec2 uv;out highp float particleRandomValue;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos*=halfBoxSize; 
pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_rainParticleData.z;float coneAngleHeadingRad=a_rainParticleData.w*radians(360.0);vec3 localZ=normalize(u_rainDirection);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 directionLocal;directionLocal.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.z=cos(coneAnglePichRad);directionLocal=normalize(directionLocal);vec3 directionWorld=localX*directionLocal.x+localY*directionLocal.y+localZ*directionLocal.z;float velocityScale=(1.0+3.0*a_rainParticleData.y)*u_velocity;vec3 simPosLocal=vec3(0,0,0);simPosLocal+=directionLocal*velocityScale*u_time;vec3 simPos=localX*simPosLocal.x+
localY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);vec4 posView=u_modelview*vec4(pos,1.0);vec3 directionView=normalize((u_modelview*vec4(directionWorld,0.0)).xyz);vec3 side=cross(directionView,normalize(posView.xyz));posView.xyz+=side*a_uv.x*u_rainDropletSize.x;posView.xyz+=directionView*a_uv.y*u_rainDropletSize.y;uv=a_uv;particleRandomValue=a_rainParticleData.x;gl_Position=u_projection*posView;}`),vignette:pi("uniform vec3 u_vignetteShape;uniform vec4 u_vignetteColor;in vec2 st;void main() {float screenDist=length(st);float alpha=clamp((screenDist-u_vignetteShape.x)/u_vignetteShape.y,0.0,1.0);alpha=pow(alpha,u_vignetteShape.z)*u_vignetteColor.a;vec3 color=u_vignetteColor.rgb;glFragColor=vec4(color*alpha,alpha) ;}","in vec2 a_pos_2f;out vec2 st;void main() {st=a_pos_2f;gl_Position=vec4(a_pos_2f,0,1);}"),occlusion:pi("uniform vec4 u_color;void main() {glFragColor=u_color;}",`#include "_prelude_terrain.vertex.glsl"
in highp vec2 a_offset_xy;uniform highp vec3 u_anchorPos;uniform mat4 u_matrix;uniform vec2 u_screenSizePx;uniform vec2 u_occluderSizePx;void main() {vec3 world_pos=u_anchorPos;
#ifdef TERRAIN
float e=elevation(world_pos.xy);world_pos.z+=e;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1.0);projected_point.xy+=projected_point.w*a_offset_xy*0.5*u_occluderSizePx/u_screenSizePx;gl_Position=projected_point;}`)};function Jn(l,t){const n=l.replace(/\s*\/\/[^\n]*\n/g,`
`).split(`
`);for(let c of n)if(c=c.trim(),c[0]==="#"&&c.includes("if")&&!c.includes("endif")){c=c.replace("#","").replace(/ifdef|ifndef|elif|if/g,"").replace(/!|defined|\(|\)|\|\||&&/g,"").replace(/\s+/g," ").trim();const d=c.split(" ");for(const f of d)t.includes(f)||t.push(f)}}function pi(l,t){const n=/#include\s+"([^"]+)"/g,c=/#pragma mapbox: ([\w\-]+) ([\w]+) ([\w]+) ([\w]+)/g;let d=t.match(/(attribute(\S*)|(^\s*|;)in) (highp |mediump |lowp )?([\w]+) ([\w]+)/gm);d&&(d=d.map(T=>{const S=T.split(" ");return S[S.length-1]}),d=[...new Set(d)]);const f={},m=[],y=[];if(l=l.replace(n,(T,S)=>(y.push(S),"")),(t=t.replace(n,(T,S)=>(m.push(S),""))).includes("flat out"))return void console.error('The usage of "flat" qualifier is disallowed, see: https://bugs.webkit.org/show_bug.cgi?id=268071');let v=[...wa];Jn(l,v),Jn(t,v);for(const T of[...m,...y])Ta[T]||console.error(`Undefined include: ${T}`),Il[T]||(Il[T]=[],Jn(Ta[T],Il[T])),v=[...v,...Il[T]];return{fragmentSource:l=l.replace(c,(T,S,C,I,M)=>(f[M]=!0,S==="define"?`
#ifndef HAS_UNIFORM_u_${M}
in ${C} ${I} ${M};
#else
uniform ${C} ${I} u_${M};
#endif
`:S==="initialize"?`
#ifdef HAS_UNIFORM_u_${M}
    ${C} ${I} ${M} = u_${M};
#endif
`:S==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${M}
    in ${C} ${I} ${M};
#endif
`:S==="initialize-attribute"?"":void 0)),vertexSource:t=t.replace(c,(T,S,C,I,M)=>{const D=I==="float"?"vec2":I,z=M.match(/color/)?"color":D;return S==="define-attribute-vertex-shader-only"?`
#ifdef HAS_ATTRIBUTE_a_${M}
in ${C} ${I} a_${M};
#endif
`:f[M]?S==="define"?`
#ifndef HAS_UNIFORM_u_${M}
uniform lowp float u_${M}_t;
in ${C} ${D} a_${M};
out ${C} ${I} ${M};
#else
uniform ${C} ${I} u_${M};
#endif
`:S==="initialize"?z==="vec4"?`
#ifndef HAS_UNIFORM_u_${M}
    ${M} = a_${M};
#else
    ${C} ${I} ${M} = u_${M};
#endif
`:`
#ifndef HAS_UNIFORM_u_${M}
    ${M} = unpack_mix_${z}(a_${M}, u_${M}_t);
#else
    ${C} ${I} ${M} = u_${M};
#endif
`:S==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${M}
    in ${C} ${I} a_${M};
    out ${C} ${I} ${M};
#endif
`:S==="initialize-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${M}
    ${M} = a_${M};
#endif
`:void 0:S==="define"?`
#ifndef HAS_UNIFORM_u_${M}
uniform lowp float u_${M}_t;
in ${C} ${D} a_${M};
#else
uniform ${C} ${I} u_${M};
#endif
`:S==="define-instanced"?z==="mat4"?`
#ifdef INSTANCED_ARRAYS
in vec4 a_${M}0;
in vec4 a_${M}1;
in vec4 a_${M}2;
in vec4 a_${M}3;
#else
uniform ${C} ${I} u_${M};
#endif
`:`
#ifdef INSTANCED_ARRAYS
in ${C} ${D} a_${M};
#else
uniform ${C} ${I} u_${M};
#endif
`:S==="initialize-attribute-custom"?`
#ifdef HAS_ATTRIBUTE_a_${M}
    ${C} ${I} ${M} = a_${M};
#endif
`:z==="vec4"?`
#ifndef HAS_UNIFORM_u_${M}
    ${C} ${I} ${M} = a_${M};
#else
    ${C} ${I} ${M} = u_${M};
#endif
`:`
#ifndef HAS_UNIFORM_u_${M}
    ${C} ${I} ${M} = unpack_mix_${z}(a_${M}, u_${M}_t);
#else
    ${C} ${I} ${M} = u_${M};
#endif
`}),staticAttributes:d,usedDefines:v,vertexIncludes:m,fragmentIncludes:y}}class Sa{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(t,n,c,d,f,m,y,v){this.context=t;let T=this.boundPaintVertexBuffers.length!==d.length;for(let C=0;!T&&C<d.length;C++)this.boundPaintVertexBuffers[C]!==d[C]&&(T=!0);let S=this.boundDynamicVertexBuffers.length!==y.length;for(let C=0;!S&&C<y.length;C++)this.boundDynamicVertexBuffers[C]!==y[C]&&(S=!0);if(!this.vao||this.boundProgram!==n||this.boundLayoutVertexBuffer!==c||T||S||this.boundIndexBuffer!==f||this.boundVertexOffset!==m)this.freshBind(n,c,d,f,m,y,v);else{t.bindVertexArrayOES.set(this.vao);for(const C of y)C&&(C.bind(),v&&C.instanceCount&&C.setVertexAttribDivisor(t.gl,n,v));f&&f.dynamicDraw&&f.bind()}}freshBind(t,n,c,d,f,m,y){const v=t.numAttributes,T=this.context,S=T.gl;this.vao&&this.destroy(),this.vao=T.gl.createVertexArray(),T.bindVertexArrayOES.set(this.vao),this.boundProgram=t,this.boundLayoutVertexBuffer=n,this.boundPaintVertexBuffers=c,this.boundIndexBuffer=d,this.boundVertexOffset=f,this.boundDynamicVertexBuffers=m,n.enableAttributes(S,t),n.bind(),n.setVertexAttribPointers(S,t,f);for(const C of c)C.enableAttributes(S,t),C.bind(),C.setVertexAttribPointers(S,t,f);for(const C of m)C&&(C.enableAttributes(S,t),C.bind(),C.setVertexAttribPointers(S,t,f),y&&C.instanceCount&&C.setVertexAttribDivisor(S,t,y));d&&d.bind(),T.currentNumAttributes=v}destroy(){this.vao&&(this.context.gl.deleteVertexArray(this.vao),this.vao=null)}}function Vp(l,t){const n=Math.pow(2,t.canonical.z),c=t.canonical.y;return[new o.ac(0,c/n).toLngLat().lat,new o.ac(0,(c+1)/n).toLngLat().lat]}function Up(l,t,n,c,d,f,m){const y=l.context,v=y.gl,T=n.hillshadeFBO;if(!T)return;l.prepareDrawTile();const S=l.isTileAffectedByFog(t),C=l.getOrCreateProgram("hillshade",{overrideFog:S});y.activeTexture.set(v.TEXTURE0),v.bindTexture(v.TEXTURE_2D,T.colorAttachment.get());const I=((O,B,V,H)=>{const Y=V.paint.get("hillshade-shadow-color"),te=V.paint.get("hillshade-shadow-color-use-theme").constantOr("default")==="none",ee=V.paint.get("hillshade-highlight-color"),J=V.paint.get("hillshade-highlight-color-use-theme").constantOr("default")==="none",K=V.paint.get("hillshade-accent-color"),ie=V.paint.get("hillshade-accent-color-use-theme").constantOr("default")==="none",se=V.paint.get("hillshade-emissive-strength");let ye=o.al(V.paint.get("hillshade-illumination-direction"));if(V.paint.get("hillshade-illumination-anchor")==="viewport")ye-=O.transform.angle;else if(O.style&&O.style.enable3dLights()&&O.style.directionalLight){const Oe=O.style.directionalLight.properties.get("direction"),ke=o.cR(Oe.x,Oe.y,Oe.z);ye=o.al(ke[1])}const ve=!O.options.moving;return{u_matrix:H||O.transform.calculateProjMatrix(B.tileID.toUnwrapped(),ve),u_image:0,u_latrange:Vp(0,B.tileID),u_light:[V.paint.get("hillshade-exaggeration"),ye],u_shadow:Y.toPremultipliedRenderColor(te?null:V.lut),u_highlight:ee.toPremultipliedRenderColor(J?null:V.lut),u_emissive_strength:se,u_accent:K.toPremultipliedRenderColor(ie?null:V.lut)}})(l,n,c,l.terrain?t.projMatrix:null);l.uploadCommonUniforms(y,C,t.toUnwrapped());const{tileBoundsBuffer:M,tileBoundsIndexBuffer:D,tileBoundsSegments:z}=l.getTileBoundsBuffers(n);C.draw(l,v.TRIANGLES,d,f,m,Nt.disabled,I,c.id,M,D,z)}function Rc(l,t,n){if(!t.needsDEMTextureUpload)return;const c=l.context,d=c.gl;c.pixelStoreUnpackPremultiplyAlpha.set(!1),t.demTexture=t.demTexture||l.getTileTexture(n.stride);const f=n.getPixels();t.demTexture?t.demTexture.update(f,{premultiply:!1}):t.demTexture=new o.T(c,f,d.R32F,{premultiply:!1}),t.needsDEMTextureUpload=!1}function jp(l,t,n){const c=l.context,d=c.gl;if(!t.dem)return;const f=t.dem;if(c.activeTexture.set(d.TEXTURE1),Rc(l,t,f),!t.demTexture)return;t.demTexture.bind(d.NEAREST,d.CLAMP_TO_EDGE);const m=f.dim;c.activeTexture.set(d.TEXTURE0);let y=t.hillshadeFBO;if(!y){const I=new o.T(c,{width:m,height:m,data:null},d.RGBA8);I.bind(d.LINEAR,d.CLAMP_TO_EDGE),y=t.hillshadeFBO=c.createFramebuffer(m,m,!0,"renderbuffer"),y.colorAttachment.set(I.texture)}c.bindFramebuffer.set(y.framebuffer),c.viewport.set([0,0,m,m]);const{tileBoundsBuffer:v,tileBoundsIndexBuffer:T,tileBoundsSegments:S}=l.getMercatorTileBoundsBuffers(),C=[];l.linearFloatFilteringSupported()&&C.push("TERRAIN_DEM_FLOAT_FORMAT"),l.getOrCreateProgram("hillshadePrepare",{defines:C}).draw(l,d.TRIANGLES,xt.disabled,Zt.disabled,oi.unblended,Nt.disabled,((I,M)=>{const D=M.stride,z=o.bz();return o.c5(z,0,o.aj,-8192,0,0,1),o.bo(z,z,[0,-8192,0]),{u_matrix:z,u_image:1,u_dimension:[D,D],u_zoom:I.overscaledZ}})(t.tileID,f),n.id,v,T,S),t.needsHillshadePrepare=!1}class gr{constructor(t){this.gl=t.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(t){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class kd extends gr{getDefault(){return o.am.transparent.toNonPremultipliedRenderColor(null)}set(t){const n=this.current;(t.r!==n.r||t.g!==n.g||t.b!==n.b||t.a!==n.a||this.dirty)&&(this.gl.clearColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class th extends gr{getDefault(){return 1}set(t){(t!==this.current||this.dirty)&&(this.gl.clearDepth(t),this.current=t,this.dirty=!1)}}class Gp extends gr{getDefault(){return 0}set(t){(t!==this.current||this.dirty)&&(this.gl.clearStencil(t),this.current=t,this.dirty=!1)}}class qp extends gr{getDefault(){return[!0,!0,!0,!0]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||t[2]!==n[2]||t[3]!==n[3]||this.dirty)&&(this.gl.colorMask(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class $p extends gr{getDefault(){return!0}set(t){(t!==this.current||this.dirty)&&(this.gl.depthMask(t),this.current=t,this.dirty=!1)}}class Hp extends gr{getDefault(){return 255}set(t){(t!==this.current||this.dirty)&&(this.gl.stencilMask(t),this.current=t,this.dirty=!1)}}class Fd extends gr{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(t){const n=this.current;(t.func!==n.func||t.ref!==n.ref||t.mask!==n.mask||this.dirty)&&(this.gl.stencilFunc(t.func,t.ref,t.mask),this.current=t,this.dirty=!1)}}class Zp extends gr{getDefault(){const t=this.gl;return[t.KEEP,t.KEEP,t.KEEP]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||t[2]!==n[2]||this.dirty)&&(this.gl.stencilOp(t[0],t[1],t[2]),this.current=t,this.dirty=!1)}}class zc extends gr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;t?n.enable(n.STENCIL_TEST):n.disable(n.STENCIL_TEST),this.current=t,this.dirty=!1}}class Wp extends gr{getDefault(){return[0,1]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||this.dirty)&&(this.gl.depthRange(t[0],t[1]),this.current=t,this.dirty=!1)}}class Bd extends gr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;t?n.enable(n.DEPTH_TEST):n.disable(n.DEPTH_TEST),this.current=t,this.dirty=!1}}class ih extends gr{getDefault(){return this.gl.LESS}set(t){(t!==this.current||this.dirty)&&(this.gl.depthFunc(t),this.current=t,this.dirty=!1)}}class Lc extends gr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;t?n.enable(n.BLEND):n.disable(n.BLEND),this.current=t,this.dirty=!1}}class rh extends gr{getDefault(){const t=this.gl;return[t.ONE,t.ZERO,t.ONE,t.ZERO]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||t[2]!==n[2]||t[3]!==n[3]||this.dirty)&&(this.gl.blendFuncSeparate(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class qo extends gr{getDefault(){return o.am.transparent.toNonPremultipliedRenderColor(null)}set(t){const n=this.current;(t.r!==n.r||t.g!==n.g||t.b!==n.b||t.a!==n.a||this.dirty)&&(this.gl.blendColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class Ea extends gr{getDefault(){return this.gl.FUNC_ADD}set(t){(t!==this.current||this.dirty)&&(this.gl.blendEquationSeparate(t,t),this.current=t,this.dirty=!1)}}class Dc extends gr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;t?n.enable(n.CULL_FACE):n.disable(n.CULL_FACE),this.current=t,this.dirty=!1}}class Oc extends gr{getDefault(){return this.gl.BACK}set(t){(t!==this.current||this.dirty)&&(this.gl.cullFace(t),this.current=t,this.dirty=!1)}}class Ia extends gr{getDefault(){return this.gl.CCW}set(t){(t!==this.current||this.dirty)&&(this.gl.frontFace(t),this.current=t,this.dirty=!1)}}let Nd=class extends gr{getDefault(){return null}set(l){(l!==this.current||this.dirty)&&(this.gl.useProgram(l),this.current=l,this.dirty=!1)}};class nh extends gr{getDefault(){return this.gl.TEXTURE0}set(t){(t!==this.current||this.dirty)&&(this.gl.activeTexture(t),this.current=t,this.dirty=!1)}}class Vd extends gr{getDefault(){const t=this.gl;return[0,0,t.drawingBufferWidth,t.drawingBufferHeight]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||t[2]!==n[2]||t[3]!==n[3]||this.dirty)&&(this.gl.viewport(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class Aa extends gr{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.bindFramebuffer(n.FRAMEBUFFER,t),this.current=t,this.dirty=!1}}class kc extends gr{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.bindRenderbuffer(n.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class Fc extends gr{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.bindTexture(n.TEXTURE_2D,t),this.current=t,this.dirty=!1}}class sh extends gr{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.bindBuffer(n.ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class Bc extends gr{getDefault(){return null}set(t){const n=this.gl;n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class Cl extends gr{getDefault(){return null}set(t){this.gl&&(t!==this.current||this.dirty)&&(this.gl.bindVertexArray(t),this.current=t,this.dirty=!1)}}class Ud extends gr{getDefault(){return 4}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.pixelStorei(n.UNPACK_ALIGNMENT,t),this.current=t,this.dirty=!1}}class jd extends gr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t),this.current=t,this.dirty=!1}}class Gd extends gr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,t),this.current=t,this.dirty=!1}}class oo extends gr{constructor(t,n){super(t),this.context=t,this.parent=n}getDefault(){return null}}class qd extends oo{setDirty(){this.dirty=!0}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const n=this.gl;n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class $d extends oo{attachment(){return this.gl.DEPTH_ATTACHMENT}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const n=this.gl;n.framebufferRenderbuffer(n.FRAMEBUFFER,this.attachment(),n.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class Xp extends oo{attachment(){return this.gl.DEPTH_ATTACHMENT}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const n=this.gl;n.framebufferTexture2D(n.FRAMEBUFFER,this.attachment(),n.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class Yp extends $d{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}const oh=(l,t,n)=>({u_matrix:l,u_image0:0,u_skirt_height:t,u_ground_shadow_factor:n}),Nc=(l,t,n,c,d,f,m,y,v,T,S,C,I,M,D,z)=>({u_proj_matrix:Float32Array.from(l),u_globe_matrix:t,u_normalize_matrix:Float32Array.from(c),u_merc_matrix:n,u_zoom_transition:d,u_merc_center:f,u_image0:0,u_frustum_tl:m,u_frustum_tr:y,u_frustum_br:v,u_frustum_bl:T,u_globe_pos:S,u_globe_radius:C,u_viewport:I,u_grid_matrix:z?Float32Array.from(z):new Float32Array(9),u_skirt_height:M,u_far_z_cutoff:D});function Vc(l,t){return l!=null&&t!=null&&!(!l.hasData()||!t.hasData())&&l.demTexture!=null&&t.demTexture!=null&&l.tileID.key!==t.tileID.key}const ao=new class{constructor(){this.operations={}}newMorphing(l,t,n,c,d){if(l in this.operations){const f=this.operations[l];f.to.tileID.key!==n.tileID.key&&(f.queued=n)}else this.operations[l]={startTime:c,phase:0,duration:d,from:t,to:n,queued:null}}getMorphValuesForProxy(l){if(!(l in this.operations))return null;const t=this.operations[l];return{from:t.from,to:t.to,phase:t.phase}}update(l){for(const t in this.operations){const n=this.operations[t];for(n.phase=(l-n.startTime)/n.duration;n.phase>=1||!this._validOp(n);)if(!this._nextOp(n,l)){delete this.operations[t];break}}}_nextOp(l,t){return!!l.queued&&(l.from=l.to,l.to=l.queued,l.queued=null,l.phase=0,l.startTime=t,!0)}_validOp(l){return l.from.hasData()&&l.to.hasData()}},ah={0:null,1:"TERRAIN_VERTEX_MORPHING"};function lh(l,t,n){if(t===0)return 0;const c=t<1&&n===514?.25/t:1;return 6*Math.pow(1.5,22-l)*Math.max(t,1)*c}function Kp(l,t){const n=1<<l.z;return!t&&(l.x===0||l.x===n-1)||l.y===0||l.y===n-1}const $o=l=>({u_matrix:l});function Ho(l,t,n,c,d){if(d>0){const f=o.q.now(),m=(f-l.timeAdded)/d,y=t?(f-t.timeAdded)/d:-1,v=n.getSource(),T=c.coveringZoomLevel({tileSize:v.tileSize,roundZoom:v.roundZoom}),S=!t||Math.abs(t.tileID.overscaledZ-T)>Math.abs(l.tileID.overscaledZ-T),C=S&&l.refreshedUponExpiration?1:o.ay(S?m:1-y,0,1);return l.refreshedUponExpiration&&m>=1&&(l.refreshedUponExpiration=!1),t?{opacity:1,mix:1-C}:{opacity:C,mix:0}}return{opacity:1,mix:0}}class Hd extends En{constructor(t){const n={type:"raster-dem",maxzoom:t.transform.maxZoom},c=new o.D(o.c$(),null),d=al("mock-dem",n,c,t.style);super("mock-dem",d,!1),d.setEventedParent(this),this._sourceLoaded=!0}_loadTile(t,n){t.state="loaded",n(null)}}class $n extends En{constructor(t){const n=al("proxy",{type:"geojson",maxzoom:t.transform.maxZoom},new o.D(o.c$(),null),t.style);super("proxy",n,!1),n.setEventedParent(this),this.map=this.getSource().map=t,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(t,n,c){if(t.freezeTileCoverage)return;this.transform=t;const d=t.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce((f,m)=>{if(f[m.key]="",!this._tiles[m.key]){const y=new Lo(m,this._source.tileSize*m.overscaleFactor(),t.tileZoom,void 0,void 0,this._source.worldview);y.state="loaded",this._tiles[m.key]=y}return f},{});for(const f in this._tiles)f in d||(this.freeFBO(f),this._tiles[f].unloadVectorData(),delete this._tiles[f])}freeFBO(t){const n=this.proxyCachedFBO[t];if(n!==void 0){const c=Object.values(n);this.renderCachePool.push(...c),delete this.proxyCachedFBO[t]}}deallocRenderCache(){this.renderCache.forEach(t=>t.fb.destroy()),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class Uc extends o.aM{constructor(t,n,c){super(t.overscaledZ,t.wrap,t.canonical.z,t.canonical.x,t.canonical.y),this.proxyTileKey=n,this.projMatrix=c}}class Ml extends o.dt{constructor(t,n){super(),this._debugParams={sortTilesHiZFirst:!0,disableRenderCache:!1},t.tp.registerParameter(this._debugParams,["Terrain"],"sortTilesHiZFirst",{},()=>{this._style.map.triggerRepaint()}),t.tp.registerParameter(this._debugParams,["Terrain"],"disableRenderCache",{},()=>{this._style.map.triggerRepaint()}),t.tp.registerButton(["Terrain"],"Invalidate Render Cache",()=>{this.invalidateRenderCache=!0,this._style.map.triggerRepaint()}),this.painter=t,this.terrainTileForTile={},this.prevTerrainTileForTile={};const[c,d,f]=function(v){const T=new o.ba,S=new o.a_,C=131;T.reserve(17161),S.reserve(33800);const I=o.aj/128,M=o.aj+I/2,D=M+I;for(let O=-64;O<D;O+=I)for(let B=-64;B<D;B+=I){const V=B<0||B>M||O<0||O>M?24575:0,H=o.ay(Math.round(B),0,o.aj),Y=o.ay(Math.round(O),0,o.aj);T.emplaceBack(H+V,Y)}const z=(O,B)=>{const V=B*C+O;S.emplaceBack(V+1,V,V+C),S.emplaceBack(V+C,V+C+1,V+1)};for(let O=1;O<129;O++)for(let B=1;B<129;B++)z(B,O);return[0,129].forEach(O=>{for(let B=0;B<130;B++)z(B,O),z(O,B)}),[T,S,32768]}(),m=t.context;this.gridBuffer=m.createVertexBuffer(c,o.bc.members),this.gridIndexBuffer=m.createIndexBuffer(d),this.gridSegments=o.bd.simpleSegment(0,0,c.length,d.length),this.gridNoSkirtSegments=o.bd.simpleSegment(0,0,c.length,f),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new $n(n.map),this.orthoMatrix=o.bz(),o.c5(this.orthoMatrix,this.painter.transform.projection.name==="globe"?.015:0,o.aj,0,o.aj,0,1);const y=m.gl;this._overlapStencilMode=new Zt({func:y.GEQUAL,mask:255},0,255,y.KEEP,y.KEEP,y.REPLACE),this._previousZoom=t.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=n,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new Hd(n.map),this._pendingGroundEffectLayers=[]}set style(t){t.on("data",this._onStyleDataEvent.bind(this)),this._style=t,this._style.map.on("moveend",()=>{this._clearLineLayersFromRenderCache()})}update(t,n,c){if(t&&t.terrain){this._style!==t&&(this.style=t,this._evaluationZoom=void 0);const d=t.terrain.properties,f=t.terrain.drapeRenderMode===0,m=t.terrain.isZoomDependent();this._previousUpdateTimestamp=this.enabled?this._updateTimestamp:void 0,this._updateTimestamp=o.q.now();const y=t.terrain&&t.terrain.scope,v=d.get("source"),T=f?this._mockSourceCache:t.getSourceCache(v,y);if(!T)return void o.w(`Couldn't find terrain source "${v}".`);if(this.sourceCache=T,this._attenuationRange=t.terrain.getAttenuationRange(),this._exaggeration=m?this.calculateExaggeration(n):d.get("exaggeration"),!n.projection.requiresDraping&&m&&this._exaggeration===0)return void this._disable();this.enabled=!0;const S=()=>{this.sourceCache.used&&o.w(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.
This leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);const C=this.getScaledDemTileSize();this.sourceCache.update(n,C,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,S(),this._initializing=!0),S(),n.updateElevation(!0,c),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(n),this._emptyDEMTextureDirty=!0,this._previousZoom=n.zoom}else this._disable()}calculateExaggeration(t){if(this._attenuationRange&&t.zoom>=Math.ceil(this._attenuationRange[1]))return this._style.terrain.getExaggeration(t.zoom);const n=this._previousCameraAltitude,c=t.getFreeCameraOptions().position.z/t.pixelsPerMeter*t.worldSize;this._previousCameraAltitude=c;const d=n!=null?c-n:Number.MAX_VALUE;if(Math.abs(d)<2)return this._exaggeration;const f=t.zoom,m=this._style.terrain;if(!this._previousUpdateTimestamp)return m.getExaggeration(f);let y=f-this._previousZoom;const v=this._previousUpdateTimestamp;let T=f;this._evaluationZoom!=null&&(T=this._evaluationZoom,Math.abs(f-T)>.5&&(y=.5*(f-T+y)),y*d<0&&(T+=y)),this._evaluationZoom=T;const S=m.getExaggeration(T),C=S===m.getExaggeration(Math.max(0,T-.1));if(C&&Math.abs(S-this._exaggeration)<.01)return S;let I=Math.min(.1,.00375*(this._updateTimestamp-v));return(C||S<.1||Math.abs(y)<1e-4)&&(I=Math.min(.2,4*I)),o.ai(this._exaggeration,S,I)}resetTileLookupCache(t){this._findCoveringTileCache[t]={}}attenuationRange(){return this._attenuationRange}getDemUpscale(){return this.proxySourceCache.getSource().tileSize/128}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_onStyleDataEvent(t){t.coord&&t.dataType==="source"?this._clearRenderCacheForTile(t.sourceCacheId,t.coord):t.dataType==="style"&&(this.invalidateRenderCache=!0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this._previousCameraAltitude=void 0)}_disable(){if(this.enabled&&(this.enabled=!1,this._emptyDEMTextureDirty=!0,this._sharedDepthStencil=void 0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(const t in this._style._mergedSourceCaches)this._style._mergedSourceCaches[t].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this.pool.forEach(t=>t.fb.destroy()),this.pool=[],this.framebufferCopyTexture&&this.framebufferCopyTexture.destroy()}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this.enabled?this._exaggeration:0}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){const t=2*this.proxySourceCache.getSource().tileSize;return[t,t]}set useVertexMorphing(t){this._useVertexMorphing=t}updateTileBinding(t){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;const n=this.proxySourceCache,c=this.painter.transform;this._initializing&&(this._initializing=c._centerAltitude===0&&this.getAtPointOrZero(o.ac.fromLngLat(c.center),-1)===-1,this._emptyDEMTextureDirty=!this._initializing);const d=this.proxyCoords=n.getIds().map(v=>{const T=n.getTileByID(v).tileID;return T.projMatrix=c.calculateProjMatrix(T.toUnwrapped()),T});(function(v,T){const S=T.transform.pointCoordinate(T.transform.getCameraPoint()),C=new o.P(S.x,S.y);v.sort((I,M)=>{if(M.overscaledZ-I.overscaledZ)return M.overscaledZ-I.overscaledZ;const D=new o.P(I.canonical.x+(1<<I.canonical.z)*I.wrap,I.canonical.y),z=new o.P(M.canonical.x+(1<<M.canonical.z)*M.wrap,M.canonical.y),O=C.mult(1<<I.canonical.z);return O.x-=.5,O.y-=.5,O.distSqr(D)-O.distSqr(z)})})(d,this.painter);const f=this.proxyToSource||{};this.proxyToSource={},d.forEach(v=>{this.proxyToSource[v.key]={}}),this.terrainTileForTile={};const m=this._style._mergedSourceCaches;for(const v in m){const T=m[v];if(!T.used||(T!==this.sourceCache&&this.resetTileLookupCache(T.id),this._setupProxiedCoordsForOrtho(T,t[v],f),T.usedForTerrain))continue;const S=t[v];T.getSource().reparseOverscaled&&this._assignTerrainTiles(S)}this.proxiedCoords[n.id]=d.map(v=>new Uc(v,v.key,this.orthoMatrix)),this._assignTerrainTiles(d),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(f),this.renderingToTexture=!1;const y={};this._visibleDemTiles=[];for(const v of this.proxyCoords){const T=this.terrainTileForTile[v.key];if(!T)continue;const S=T.tileID.key;S in y||(this._visibleDemTiles.push(T),y[S]=S)}}_assignTerrainTiles(t){this._initializing||t.forEach(n=>{if(this.terrainTileForTile[n.key])return;const c=this._findTileCoveringTileID(n,this.sourceCache);c&&(this.terrainTileForTile[n.key]=c)})}_prepareDEMTextures(){const t=this.painter.context,n=t.gl;for(const c in this.terrainTileForTile){const d=this.terrainTileForTile[c],f=d.dem;!f||d.demTexture&&!d.needsDEMTextureUpload||(t.activeTexture.set(n.TEXTURE1),Rc(this.painter,d,f))}}_prepareDemTileUniforms(t,n,c,d){if(!n||n.demTexture==null)return!1;const f=t.tileID.canonical,m=Math.pow(2,n.tileID.canonical.z-f.z),y=d||"";return c[`u_dem_tl${y}`]=[f.x*m%1,f.y*m%1],c[`u_dem_scale${y}`]=m,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}_getLoadedAreaMinimum(){if(!this.enabled)return 0;let t=0;const n=this._visibleDemTiles.reduce((c,d)=>{if(!d.dem)return c;const f=d.dem.tree.minimums[0];return f>0&&t++,c+f},0);return t?n/t:0}_updateEmptyDEMTexture(){const t=this.painter.context,n=t.gl;t.activeTexture.set(n.TEXTURE2);const c=this._getLoadedAreaMinimum(),d=new o.du({width:1,height:1},new Float32Array([c]));this._emptyDEMTextureDirty=!1;let f=this._emptyDEMTexture;return f?f.update(d,{premultiply:!1}):f=this._emptyDEMTexture=new o.T(t,d,n.R32F,{premultiply:!1}),f}setupElevationDraw(t,n,c){const d=this.painter.context,f=d.gl,m={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0};m.u_exaggeration=this.exaggeration();let y=null,v=null,T=1;if(c&&c.morphing&&this._useVertexMorphing){const M=c.morphing.srcDemTile,D=c.morphing.dstDemTile;T=c.morphing.phase,M&&D&&(this._prepareDemTileUniforms(t,M,m,"_prev")&&(v=M),this._prepareDemTileUniforms(t,D,m)&&(y=D))}const S=M=>M&&M.demTexture&&this.painter.linearFloatFilteringSupported()?f.LINEAR:f.NEAREST;let C=null;var I;if(this.enabled?v&&y?(C=y.demTexture,d.activeTexture.set(f.TEXTURE4),v.demTexture.bind(S(v),f.CLAMP_TO_EDGE),m.u_dem_lerp=T):(y=this.terrainTileForTile[t.tileID.key],C=this._prepareDemTileUniforms(t,y,m)?y.demTexture:this.emptyDEMTexture):C=this.emptyDEMTexture,d.activeTexture.set(f.TEXTURE2),C&&(m.u_dem_size=(I=C).size[0]===1?1:I.size[0]-2,C.bind(S(y),f.CLAMP_TO_EDGE)),this.painter.setupDepthForOcclusion(c&&c.useDepthForOcclusion,n,m),c&&c.useMeterToDem&&y){const M=(1<<y.tileID.canonical.z)*o.c6(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;m.u_meter_to_dem=M}if(c&&c.labelPlaneMatrixInv&&(m.u_label_plane_matrix_inv=c.labelPlaneMatrixInv),n.setTerrainUniformValues(d,m),this.painter.transform.projection.name==="globe"){const M=this.globeUniformValues(this.painter.transform,t.tileID.canonical,c&&c.useDenormalizedUpVectorScale);n.setGlobeUniformValues(d,M)}}globeUniformValues(t,n,c){const d=t.projection;return{u_tile_tl_up:d.upVector(n,0,0),u_tile_tr_up:d.upVector(n,o.aj,0),u_tile_br_up:d.upVector(n,o.aj,o.aj),u_tile_bl_up:d.upVector(n,0,o.aj),u_tile_up_scale:c?o.dv(1):d.upVectorScale(n,t.center.lat,t.worldSize).metersToTile}}renderToBackBuffer(t){const n=this.painter,c=this.painter.context;t.length!==0&&(c.bindFramebuffer.set(null),c.viewport.set([0,0,n.width,n.height]),n.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,function(d,f,m,y,v){if(d.transform.projection.name==="globe")(function(T,S,C,I,M){const D=T.context,z=D.gl;let O,B;const V=T.transform,H=o.dl(T,D,V),Y=(Oe,ke)=>{if(B===ke)return;const Ze=[ah[ke],"PROJECTION_GLOBE_VIEW"];H&&Ze.push("CUSTOM_ANTIALIASING");const _e=T.isTileAffectedByFog(Oe);O=T.getOrCreateProgram("globeRaster",{defines:Ze,overrideFog:_e}),B=ke},te=T.colorModeForRenderPass(),ee=new xt(z.LEQUAL,xt.ReadWrite,T.depthRangeFor3D);ao.update(M);const J=o.dm(V),K=[o.aD(V.center.lng),o.aH(V.center.lat)],ie=T.globeSharedBuffers,se=[V.width*o.q.devicePixelRatio,V.height*o.q.devicePixelRatio],ye=Float32Array.from(V.globeMatrix),ve={useDenormalizedUpVectorScale:!0};{const Oe=T.transform,ke=lh(Oe.zoom,S.exaggeration(),S.sourceCache._source.tileSize);B=-1;const Ze=z.TRIANGLES;for(const _e of I){const Pe=C.getTile(_e),ue=Zt.disabled,Ne=S.prevTerrainTileForTile[_e.key],Se=S.terrainTileForTile[_e.key];Vc(Ne,Se)&&ao.newMorphing(_e.key,Ne,Se,M,250),D.activeTexture.set(z.TEXTURE0),Pe.texture&&Pe.texture.bind(z.LINEAR,z.CLAMP_TO_EDGE);const qe=ao.getMorphValuesForProxy(_e.key),rt=qe?1:0;qe&&o.L(ve,{morphing:{srcDemTile:qe.from,dstDemTile:qe.to,phase:o.dk(qe.phase)}});const Fe=o.dn(_e.canonical),tt=o.dp(Fe.getCenter().lat),wt=o.dq(_e.canonical,Fe,tt,Oe.worldSize/Oe._pixelsPerMercatorPixel),Tt=o.bh(o.dr(_e.canonical)),gt=Nc(Oe.expandedFarZProjMatrix,ye,J,Tt,o.ah(Oe.zoom),K,Oe.frustumCorners.TL,Oe.frustumCorners.TR,Oe.frustumCorners.BR,Oe.frustumCorners.BL,Oe.globeCenterInViewSpace,Oe.globeRadius,se,ke,Oe._farZ,wt);if(Y(_e,rt),O&&(S.setupElevationDraw(Pe,O,ve),T.uploadCommonUniforms(D,O,_e.toUnwrapped()),ie)){const[Rt,Dt,kt]=ie.getGridBuffers(tt,ke!==0);O.draw(T,Ze,ee,ue,te,Nt.backCCW,gt,"globe_raster",Rt,Dt,kt)}}}if(ie&&(T.renderDefaultNorthPole||T.renderDefaultSouthPole)){const Oe=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];H&&Oe.push("CUSTOM_ANTIALIASING"),O=T.getOrCreateProgram("globeRaster",{defines:Oe});for(const ke of I){const{x:Ze,y:_e,z:Pe}=ke.canonical,ue=_e===0,Ne=_e===(1<<Pe)-1,[Se,qe,rt,Fe]=ie.getPoleBuffers(Pe,!1);if(Fe&&(ue||Ne)){const tt=C.getTile(ke);D.activeTexture.set(z.TEXTURE0),tt.texture&&tt.texture.bind(z.LINEAR,z.CLAMP_TO_EDGE);let wt=o.ds(Pe,Ze,V);const Tt=o.bh(o.dr(ke.canonical)),gt=(Rt,Dt)=>Rt.draw(T,z.TRIANGLES,ee,Zt.disabled,te,Nt.disabled,Nc(V.expandedFarZProjMatrix,wt,wt,Tt,0,K,V.frustumCorners.TL,V.frustumCorners.TR,V.frustumCorners.BR,V.frustumCorners.BL,V.globeCenterInViewSpace,V.globeRadius,se,0,V._farZ),"globe_pole_raster",Dt,rt,Fe);S.setupElevationDraw(tt,O,ve),T.uploadCommonUniforms(D,O,ke.toUnwrapped()),ue&&T.renderDefaultNorthPole&&gt(O,Se),Ne&&T.renderDefaultSouthPole&&(wt=o.cE(o.bz(),wt,[1,-1,1]),gt(O,qe))}}}})(d,f,m,y,v);else{const T=d.context,S=T.gl;let C,I;const M=d.shadowRenderer,D=_s(d,d.longestCutoffRange),z=te=>{if(I===te)return;const ee=[];ee.push(ah[te]),D.shouldRenderCutoff&&ee.push("RENDER_CUTOFF"),M&&(ee.push("RENDER_SHADOWS","DEPTH_TEXTURE"),M.useNormalOffset&&ee.push("NORMAL_OFFSET")),C=d.getOrCreateProgram("terrainRaster",{defines:ee}),I=te},O=d.colorModeForRenderPass(),B=new xt(S.LEQUAL,xt.ReadWrite,d.depthRangeFor3D);ao.update(v);const V=d.transform,H=lh(V.zoom,f.exaggeration(),f.sourceCache._source.tileSize);let Y=[0,0,0];if(M){const te=d.style.directionalLight,ee=d.style.ambientLight;te&&ee&&(Y=jo(d.style,te,ee))}{I=-1;const te=S.TRIANGLES,[ee,J]=[f.gridIndexBuffer,f.gridSegments];for(const K of y){const ie=m.getTile(K),se=Zt.disabled,ye=f.prevTerrainTileForTile[K.key],ve=f.terrainTileForTile[K.key];Vc(ye,ve)&&ao.newMorphing(K.key,ye,ve,v,250),T.activeTexture.set(S.TEXTURE0),ie.texture&&ie.texture.bind(S.LINEAR,S.CLAMP_TO_EDGE);const Oe=ao.getMorphValuesForProxy(K.key),ke=Oe?1:0;let Ze;Oe&&(Ze={morphing:{srcDemTile:Oe.from,dstDemTile:Oe.to,phase:o.dk(Oe.phase)}});const _e=oh(K.projMatrix,Kp(K.canonical,V.renderWorldCopies)?H/10:H,Y);if(z(ke),!C)continue;f.setupElevationDraw(ie,C,Ze);const Pe=K.toUnwrapped();M&&M.setupShadows(Pe,C),d.uploadCommonUniforms(T,C,Pe,null,D),C.draw(d,te,B,se,O,Nt.backCCW,_e,"terrain_raster",f.gridBuffer,ee,J)}}}}(n,this,this.proxySourceCache,t,this._updateTimestamp),this.renderingToTexture=!0,n.gpuTimingDeferredRenderEnd(),t.splice(0,t.length))}renderBatch(t){if(this._drapedRenderBatches.length===0)return t+1;this.renderingToTexture=!0;const n=this.painter,c=this.painter.context,d=this.proxySourceCache,f=this.proxiedCoords[d.id],m=this._drapedRenderBatches.shift(),y=n.style.order,v=[];let T=0;for(const S of f){const C=d.getTileByID(S.proxyTileKey),I=d.proxyCachedFBO[S.key]?d.proxyCachedFBO[S.key][t]:void 0,M=I!==void 0?d.renderCache[I]:this.pool[T++],D=I!==void 0;if(C.texture=M.tex,D&&!M.dirty){v.push(C.tileID);continue}let z;c.bindFramebuffer.set(M.fb.framebuffer),this.renderedToTile=!1,M.dirty&&(c.clear({color:o.am.transparent,stencil:0}),M.dirty=!1);for(let O=m.start;O<=m.end;++O){const B=n.style._mergedLayers[y[O]];if(B.isHidden(n.transform.zoom))continue;const V=n.style.getLayerSourceCache(B),H=V?this.proxyToSource[S.key][V.id]:[S];if(!H)continue;const Y=H;c.viewport.set([0,0,M.fb.width,M.fb.height]),z!==(V?V.id:null)&&(this._setupStencil(M,H,B,V),z=V?V.id:null),n.renderLayer(n,V,B,Y)}if(this._drapedRenderBatches.length===0)for(const O of this._pendingGroundEffectLayers){const B=n.style._mergedLayers[y[O]];if(B.isHidden(n.transform.zoom))continue;const V=n.style.getLayerSourceCache(B),H=V?this.proxyToSource[S.key][V.id]:[S];if(!H)continue;const Y=H;c.viewport.set([0,0,M.fb.width,M.fb.height]),z!==(V?V.id:null)&&(this._setupStencil(M,H,B,V),z=V?V.id:null),n.renderLayer(n,V,B,Y)}this.renderedToTile?(M.dirty=!0,v.push(C.tileID)):D||--T,T===5&&(T=0,this.renderToBackBuffer(v))}return this.renderToBackBuffer(v),this.renderingToTexture=!1,c.bindFramebuffer.set(null),c.viewport.set([0,0,n.width,n.height]),m.end+1}postRender(){}isLayerOrderingCorrect(t){const n=t.order.length;let c=-1,d=n;for(let f=0;f<n;++f)this._style.isLayerDraped(t._mergedLayers[t.order[f]])?c=Math.max(c,f):d=Math.min(d,f);return d>c}getMinElevationBelowMSL(){let t=0;return this._visibleDemTiles.filter(n=>n.dem).forEach(n=>{t=Math.min(t,n.dem.tree.minimums[0])}),t===0?t:(t-30)*this._exaggeration}raycast(t,n,c){if(!this._visibleDemTiles)return null;const d=this._visibleDemTiles.filter(f=>f.dem).map(f=>{const m=f.tileID,y=1<<m.overscaledZ,{x:v,y:T}=m.canonical,S=v/y,C=(v+1)/y,I=T/y,M=(T+1)/y;return{minx:S,miny:I,maxx:C,maxy:M,t:f.dem.tree.raycastRoot(S,I,C,M,t,n,c),tile:f}});d.sort((f,m)=>(f.t!==null?f.t:Number.MAX_VALUE)-(m.t!==null?m.t:Number.MAX_VALUE));for(const f of d){if(f.t==null)return null;const m=f.tile.dem.tree.raycast(f.minx,f.miny,f.maxx,f.maxy,t,n,c);if(m!=null)return m}return null}_createFBO(){const t=this.painter.context,n=t.gl,c=this.drapeBufferSize;t.activeTexture.set(n.TEXTURE0);const d=new o.T(t,{width:c[0],height:c[1],data:null},n.RGBA8);d.bind(n.LINEAR,n.CLAMP_TO_EDGE);const f=t.createFramebuffer(c[0],c[1],!0,null);return f.colorAttachment.set(d.texture),f.depthAttachment=new Yp(t,f.framebuffer),this._sharedDepthStencil===void 0?(this._sharedDepthStencil=t.createRenderbuffer(t.gl.DEPTH_STENCIL,c[0],c[1]),this._stencilRef=0,f.depthAttachment.set(this._sharedDepthStencil),t.clear({stencil:0})):f.depthAttachment.set(this._sharedDepthStencil),t.extTextureFilterAnisotropic&&n.texParameterf(n.TEXTURE_2D,t.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,t.extTextureFilterAnisotropicMax),{fb:f,tex:d,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._debugParams.disableRenderCache||this._style.hasLightTransitions())return!0;for(const t in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[t].hasTransition())return!0;return this._style.order.some(t=>{const n=this._style._mergedLayers[t],c=n.isHidden(this.painter.transform.zoom);return n.type==="hillshade"||n.type==="custom"?!c&&n.shouldRedrape():!c&&n.hasTransition()})}_clearLineLayersFromRenderCache(){let t=!1;for(const c of this._style.getSources())if(c instanceof ol){t=!0;break}if(!t)return;const n={};for(let c=0;c<this._style.order.length;++c){const d=this._style._mergedLayers[this._style.order[c]],f=this._style.getLayerSourceCache(d);if(f&&!n[f.id]&&!d.isHidden(this.painter.transform.zoom)&&d.type==="line"&&d.widthExpression()instanceof o.ab){n[f.id]=!0;for(const m of this.proxyCoords){const y=this.proxyToSource[m.key][f.id];if(y)for(const v of y)this._clearRenderCacheForTile(f.id,v)}}}}_clearRasterLayersFromRenderCache(){let t=!1;for(const c in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[c]._source instanceof Jr){t=!0;break}if(!t)return;const n={};for(let c=0;c<this._style.order.length;++c){const d=this._style._mergedLayers[this._style.order[c]],f=this._style.getLayerSourceCache(d);if(!f||n[f.id]||d.isHidden(this.painter.transform.zoom)||d.type!=="raster")continue;const m=d.paint.get("raster-fade-duration");for(const y of this.proxyCoords){const v=this.proxyToSource[y.key][f.id];if(v)for(const T of v){const S=Ho(f.getTile(T),f.findLoadedParent(T,0),f,this.painter.transform,m);(S.opacity!==1||S.mix!==0)&&this._clearRenderCacheForTile(f.id,T)}}}}_setupDrapedRenderBatches(){this._style.updateDrapeFirstLayers();const t=this._style.order,n=t.length;if(n===0)return;const c=[];this._pendingGroundEffectLayers=[];let d,f=0,m=this._style._mergedLayers[t[f]];for(;!this._style.isLayerDraped(m)&&m.isHidden(this.painter.transform.zoom)&&++f<n;)m=this._style._mergedLayers[t[f]];for(;f<n;++f){const y=this._style._mergedLayers[t[f]];y.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(y)?d===void 0&&(d=f):(y.type==="fill-extrusion"&&this._pendingGroundEffectLayers.push(f),d!==void 0&&(c.push({start:d,end:f-1}),d=void 0)))}if(d!==void 0&&c.push({start:d,end:f-1}),c.length!==0){const y=c[c.length-1];this._pendingGroundEffectLayers.every(v=>v>y.end)||o.w("fill-extrusion with flood lighting and/or ground ambient occlusion should be moved to be on top of all draped layers.")}this._drapedRenderBatches=c}_setupRenderCache(t){const n=this.proxySourceCache;if(this._shouldDisableRenderCache()||this.invalidateRenderCache){if(this.invalidateRenderCache=!1,n.renderCache.length>n.renderCachePool.length){const m=Object.values(n.proxyCachedFBO);n.proxyCachedFBO={};for(let y=0;y<m.length;++y){const v=Object.values(m[y]);n.renderCachePool.push(...v)}}return}this._clearRasterLayersFromRenderCache();const c=this.proxyCoords,d=this._tilesDirty;for(let m=c.length-1;m>=0;m--){const y=c[m];if(n.getTileByID(y.key),n.proxyCachedFBO[y.key]!==void 0){const v=t[y.key],T=this.proxyToSource[y.key];let S=0;for(const C in T){const I=T[C],M=v[C];if(!M||M.length!==I.length||I.some((D,z)=>D!==M[z]||d[C]&&d[C].hasOwnProperty(D.key))){S=-1;break}++S}for(const C in n.proxyCachedFBO[y.key])n.renderCache[n.proxyCachedFBO[y.key][C]].dirty=S<0||S!==Object.values(v).length}}const f=[...this._drapedRenderBatches];f.sort((m,y)=>y.end-y.start-(m.end-m.start));for(const m of f)for(const y of c){if(n.proxyCachedFBO[y.key])continue;let v=n.renderCachePool.pop();v===void 0&&n.renderCache.length<50&&(v=n.renderCache.length,n.renderCache.push(this._createFBO())),v!==void 0&&(n.proxyCachedFBO[y.key]={},n.proxyCachedFBO[y.key][m.start]=v,n.renderCache[v].dirty=!0)}this._tilesDirty={}}_setupStencil(t,n,c,d){if(!d||!this._sourceTilesOverlap[d.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));const f=this.painter.context,m=f.gl;if(n.length<=1)return void(this._overlapStencilType=!1);let y;if(c.isTileClipped())y=n.length,this._overlapStencilMode.test={func:m.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(n[0].overscaledZ>n[n.length-1].overscaledZ))return void(this._overlapStencilType=!1);y=1,this._overlapStencilMode.test={func:m.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+y>255&&(f.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=y,this._overlapStencilMode.ref=this._stencilRef,c.isTileClipped()&&this._renderTileClippingMasks(n,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return this._overlapStencilType==="Clip"||this._overlapStencilType==="Mask"}stencilModeForRTTOverlap(t){return this.renderingToTexture&&this._overlapStencilType?(this._overlapStencilType==="Clip"&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[t.key]),this._overlapStencilMode):Zt.disabled}_renderTileClippingMasks(t,n){const c=this.painter,d=this.painter.context,f=d.gl;c._tileClippingMaskIDs={},d.setColorMode(oi.disabled),d.setDepthMode(xt.disabled);const m=c.getOrCreateProgram("clippingMask");for(const y of t){const v=c._tileClippingMaskIDs[y.key]=--n;m.draw(c,f.TRIANGLES,xt.disabled,new Zt({func:f.ALWAYS,mask:0},v,255,f.KEEP,f.KEEP,f.REPLACE),oi.disabled,Nt.disabled,$o(y.projMatrix),"$clipping",c.tileExtentBuffer,c.quadTriangleIndexBuffer,c.tileExtentSegments)}}pointCoordinate(t){const n=this.painter.transform;if(t.x<0||t.x>n.width||t.y<0||t.y>n.height)return null;const c=[t.x,t.y,1,1];o.aA(c,c,n.pixelMatrixInverse),o.cw(c,c,1/c[3]),c[0]/=n.worldSize,c[1]/=n.worldSize;const d=n._camera.position,f=o.c6(1,n.center.lat),m=[d[0],d[1],d[2]/f,0],y=o.cX([],c.slice(0,3),m);o.au(y,y);const v=this.raycast(m,y,this._exaggeration);return v!==null&&v?(o.bE(m,m,y,v),m[3]=m[2],m[2]*=f,m):null}_setupProxiedCoordsForOrtho(t,n,c){if(t.getSource()instanceof o.aP)return this._setupProxiedCoordsForImageSource(t,n,c);this._findCoveringTileCache[t.id]=this._findCoveringTileCache[t.id]||{};const d=this.proxiedCoords[t.id]=[],f=this.proxyCoords;for(let v=0;v<f.length;v++){const T=f[v],S=this._findTileCoveringTileID(T,t);if(S){const C=this._createProxiedId(T,S,c[T.key]&&c[T.key][t.id]);d.push(C),this.proxyToSource[T.key][t.id]=[C]}}let m=!1;const y=new Set;for(let v=0;v<n.length;v++){const T=t.getTile(n[v]);if(!T||!T.hasData())continue;const S=this._findTileCoveringTileID(T.tileID,this.proxySourceCache);if(S&&S.tileID.canonical.z!==T.tileID.canonical.z){const C=this.proxyToSource[S.tileID.key][t.id],I=this._createProxiedId(S.tileID,T,c[S.tileID.key]&&c[S.tileID.key][t.id]);C?C.splice(C.length-1,0,I):this.proxyToSource[S.tileID.key][t.id]=[I];const M=this.proxyToSource[S.tileID.key][t.id];y.has(M)||y.add(M),d.push(I),m=!0}}if(this._sourceTilesOverlap[t.id]=m,m&&this._debugParams.sortTilesHiZFirst)for(const v of y)v.sort((T,S)=>S.overscaledZ-T.overscaledZ)}_setupProxiedCoordsForImageSource(t,n,c){if(!t.getSource().loaded())return;const d=this.proxiedCoords[t.id]=[],f=this.proxyCoords,m=t.getSource(),y=m.tileID;if(!y)return;const v=new o.P(y.x,y.y)._div(1<<y.z),T=m.coordinates.map(o.ac.fromLngLat).reduce((C,I)=>(C.min.x=Math.min(C.min.x,I.x-v.x),C.min.y=Math.min(C.min.y,I.y-v.y),C.max.x=Math.max(C.max.x,I.x-v.x),C.max.y=Math.max(C.max.y,I.y-v.y),C),{min:new o.P(Number.MAX_VALUE,Number.MAX_VALUE),max:new o.P(-Number.MAX_VALUE,-Number.MAX_VALUE)}),S=(C,I)=>{const M=C.wrap+C.canonical.x/(1<<C.canonical.z),D=C.canonical.y/(1<<C.canonical.z),z=o.aj/(1<<C.canonical.z),O=I.wrap+I.canonical.x/(1<<I.canonical.z),B=I.canonical.y/(1<<I.canonical.z);return M+z<O+T.min.x||M>O+T.max.x||D+z<B+T.min.y||D>B+T.max.y};for(let C=0;C<f.length;C++){const I=f[C];for(let M=0;M<n.length;M++){const D=t.getTile(n[M]);if(!D||!D.hasData()||S(I,D.tileID))continue;const z=this._createProxiedId(I,D,c[I.key]&&c[I.key][t.id]),O=this.proxyToSource[I.key][t.id];O?O.push(z):this.proxyToSource[I.key][t.id]=[z],d.push(z)}}}_createProxiedId(t,n,c){let d=this.orthoMatrix;if(c){const f=c.find(m=>m.key===n.tileID.key);if(f)return f}if(n.tileID.key!==t.key){const f=t.canonical.z-n.tileID.canonical.z;let m,y,v;d=o.bz();const T=n.tileID.wrap-t.wrap<<t.overscaledZ;f>0?(m=o.aj>>f,y=m*((n.tileID.canonical.x<<f)-t.canonical.x+T),v=m*((n.tileID.canonical.y<<f)-t.canonical.y)):(m=o.aj<<-f,y=o.aj*(n.tileID.canonical.x-(t.canonical.x+T<<-f)),v=o.aj*(n.tileID.canonical.y-(t.canonical.y<<-f))),o.c5(d,0,m,0,m,0,1),o.bo(d,d,[y,v,0])}return new Uc(n.tileID,t.key,d)}_findTileCoveringTileID(t,n){let c=n.getTile(t);if(c&&c.hasData())return c;const d=this._findCoveringTileCache[n.id],f=d[t.key];if(c=f?n.getTileByID(f):null,c&&c.hasData()||f===null)return c;let m=c?c.tileID:t,y=m.overscaledZ;const v=n.getSource().minzoom,T=[];if(!f){const C=n.getSource().maxzoom;if(t.canonical.z>=C){const I=t.canonical.z-C;n.getSource().reparseOverscaled?(y=Math.max(t.canonical.z+2,n.transform.tileZoom),m=new o.aM(y,t.wrap,C,t.canonical.x>>I,t.canonical.y>>I)):I!==0&&(y=C,m=new o.aM(y,t.wrap,C,t.canonical.x>>I,t.canonical.y>>I))}m.key!==t.key&&(T.push(m.key),c=n.getTile(m))}const S=C=>{T.forEach(I=>{d[I]=C}),T.length=0};for(y-=1;y>=v&&(!c||!c.hasData());y--){c&&S(c.tileID.key);const C=m.calculateScaledKey(y);if(c=n.getTileByID(C),c&&c.hasData())break;const I=d[C];if(I===null)break;I===void 0?T.push(C):c=n.getTileByID(I)}return S(c?c.tileID.key:null),c&&c.hasData()?c:null}findDEMTileFor(t){return this.enabled?this._findTileCoveringTileID(t,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(t,n){let c=this._tilesDirty[t];c||(c=this._tilesDirty[t]={}),c[n.key]=!0}}function jc(l,t,n){const c=function(y,v,T){const S=o.bG(v,y),C=o.bG(T,[.2126,.7152,.0722]),I=(D,z,O)=>(1-O)*D+O*z,M=I(1-.3*Math.min(C,1),1,Math.min(S+1,1));return I(.92,1,Math.asin(o.ay(v[2],-1,1))/Math.PI+.5)*M}(l,[0,0,1],t),d=[0,0,0];o.bY(d,n.slice(0,3),c);const f=[0,0,0];o.bY(f,t.slice(0,3),l[2]);const m=[0,0,0];return o.cV(m,d,f),o.cY(m)}const ch=["fill","fillOutline","fillPattern","line","linePattern","background","backgroundPattern","hillshade","raster"],uh=["stars","rainParticle","snowParticle","fillExtrusion","fillExtrusionGroundEffect","elevatedStructures","model","symbol"];class Gc{static cacheKey(t,n,c,d){let f=`${n}${d?d.cacheKey:""}`;for(const m of c)t.usedDefines.includes(m)&&(f+=`/${m}`);return f}constructor(t,n,c,d,f,m){const y=t.gl;this.program=y.createProgram(),this.configuration=d,this.name=n,this.fixedDefines=[...m];const v=d?d.getBinderAttributes():[],T=(c.staticAttributes||[]).concat(v);let S=d?d.defines():[];S=S.concat(m.map(O=>`#define ${O}`));const C=`#version 300 es
`;let I=C+S.concat("precision mediump float;",gs,Al.fragmentSource).join(`
`);for(const O of c.fragmentIncludes)I+=`
${Ta[O]}`;I+=`
${c.fragmentSource}`;let M=C+S.concat("precision highp float;",gs,Al.vertexSource).join(`
`);for(const O of c.vertexIncludes)M+=`
${Ta[O]}`;this.forceManualRenderingForInstanceIDShaders=t.forceManualRenderingForInstanceIDShaders&&c.vertexSource.indexOf("gl_InstanceID")!==-1,this.forceManualRenderingForInstanceIDShaders&&(M+=`
uniform int u_instanceID;
`),M+=`
${c.vertexSource}`,this.forceManualRenderingForInstanceIDShaders&&(M=M.replaceAll("gl_InstanceID","u_instanceID"));const D=y.createShader(y.FRAGMENT_SHADER);if(y.isContextLost())return void(this.failedToCreate=!0);y.shaderSource(D,I),y.compileShader(D),y.attachShader(this.program,D);const z=y.createShader(y.VERTEX_SHADER);if(y.isContextLost())this.failedToCreate=!0;else{y.shaderSource(z,M),y.compileShader(z),y.attachShader(this.program,z),this.attributes={},this.numAttributes=T.length;for(let O=0;O<this.numAttributes;O++)if(T[O]){const B=T[O].startsWith("a_")?T[O]:`a_${T[O]}`;y.bindAttribLocation(this.program,O,B),this.attributes[B]=O}y.linkProgram(this.program),y.deleteShader(z),y.deleteShader(D),this.fixedUniforms=f(t),this.binderUniforms=d?d.getUniforms(t):[],this.forceManualRenderingForInstanceIDShaders&&(this.instancingUniforms=(O=>({u_instanceID:new o.c8(O)}))(t)),(m.includes("TERRAIN")||n.indexOf("symbol")!==-1||n.indexOf("circle")!==-1)&&(this.terrainUniforms=(O=>({u_dem:new o.c8(O),u_dem_prev:new o.c8(O),u_dem_tl:new o.cb(O),u_dem_scale:new o.ca(O),u_dem_tl_prev:new o.cb(O),u_dem_scale_prev:new o.ca(O),u_dem_size:new o.ca(O),u_dem_lerp:new o.ca(O),u_exaggeration:new o.ca(O),u_depth:new o.c8(O),u_depth_size_inv:new o.cb(O),u_depth_range_unpack:new o.cb(O),u_occluder_half_size:new o.ca(O),u_occlusion_depth_offset:new o.ca(O),u_meter_to_dem:new o.ca(O),u_label_plane_matrix_inv:new o.cc(O)}))(t)),m.includes("GLOBE")&&(this.globeUniforms=(O=>({u_tile_tl_up:new o.c9(O),u_tile_tr_up:new o.c9(O),u_tile_br_up:new o.c9(O),u_tile_bl_up:new o.c9(O),u_tile_up_scale:new o.ca(O)}))(t)),m.includes("FOG")&&(this.fogUniforms=(O=>({u_fog_matrix:new o.cc(O),u_fog_range:new o.cb(O),u_fog_color:new o.cQ(O),u_fog_horizon_blend:new o.ca(O),u_fog_vertical_limit:new o.cb(O),u_fog_temporal_offset:new o.ca(O),u_frustum_tl:new o.c9(O),u_frustum_tr:new o.c9(O),u_frustum_br:new o.c9(O),u_frustum_bl:new o.c9(O),u_globe_pos:new o.c9(O),u_globe_radius:new o.ca(O),u_globe_transition:new o.ca(O),u_is_globe:new o.c8(O),u_viewport:new o.cb(O)}))(t)),m.includes("RENDER_CUTOFF")&&(this.cutoffUniforms=(O=>({u_cutoff_params:new o.cQ(O)}))(t)),m.includes("LIGHTING_3D_MODE")&&(this.lightsUniforms=(O=>({u_lighting_ambient_color:new o.c9(O),u_lighting_directional_dir:new o.c9(O),u_lighting_directional_color:new o.c9(O),u_ground_radiance:new o.c9(O)}))(t)),m.includes("RENDER_SHADOWS")&&(this.shadowUniforms=(O=>({u_light_matrix_0:new o.cc(O),u_light_matrix_1:new o.cc(O),u_fade_range:new o.cb(O),u_shadow_normal_offset:new o.c9(O),u_shadow_intensity:new o.ca(O),u_shadow_texel_size:new o.ca(O),u_shadow_map_resolution:new o.ca(O),u_shadow_direction:new o.c9(O),u_shadow_bias:new o.c9(O),u_shadowmap_0:new o.c8(O),u_shadowmap_1:new o.c8(O)}))(t))}}setTerrainUniformValues(t,n){if(!this.terrainUniforms)return;const c=this.terrainUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const d in n)c[d]&&c[d].set(this.program,d,n[d])}}setGlobeUniformValues(t,n){if(!this.globeUniforms)return;const c=this.globeUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const d in n)c[d]&&c[d].set(this.program,d,n[d])}}setFogUniformValues(t,n){if(!this.fogUniforms)return;const c=this.fogUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const d in n)c[d].set(this.program,d,n[d])}}setCutoffUniformValues(t,n){if(!this.cutoffUniforms)return;const c=this.cutoffUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const d in n)c[d].set(this.program,d,n[d])}}setLightsUniformValues(t,n){if(!this.lightsUniforms)return;const c=this.lightsUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const d in n)c[d].set(this.program,d,n[d])}}setShadowUniformValues(t,n){if(this.failedToCreate||!this.shadowUniforms)return;const c=this.shadowUniforms;t.program.set(this.program);for(const d in n)c[d].set(this.program,d,n[d])}_drawDebugWireframe(t,n,c,d,f,m,y,v,T,S){const C=t.options.wireframe;if(C.terrain===!1&&C.layers2D===!1&&C.layers3D===!1)return;const I=t.context;if(!(!(!C.terrain||this.name!=="terrainRaster"&&this.name!=="globeRaster")||!(!C.layers2D||t._terrain&&t._terrain.renderingToTexture||!ch.includes(this.name))||!(!C.layers3D||!uh.includes(this.name))))return;const M=I.gl,D=t.wireframeDebugCache.getLinesFromTrianglesBuffer(t.frameCounter,f,I);if(!D)return;const z=[...this.fixedDefines];z.push("DEBUG_WIREFRAME");const O=t.getOrCreateProgram(this.name,{config:this.configuration,defines:z});I.program.set(O.program);const B=(Y,te,ee)=>{if(te[Y]&&ee[Y])for(const J in te[Y])ee[Y][J]&&ee[Y][J].set(ee.program,J,te[Y][J].current)};T&&T.setUniforms(O.program,I,O.binderUniforms,y,{zoom:v}),B("fixedUniforms",this,O),B("terrainUniforms",this,O),B("globeUniforms",this,O),B("fogUniforms",this,O),B("lightsUniforms",this,O),B("shadowUniforms",this,O),D.bind(),I.setColorMode(new oi([M.ONE,M.ONE_MINUS_SRC_ALPHA,M.ZERO,M.ONE],o.am.transparent,[!0,!0,!0,!1])),I.setDepthMode(new xt(n.func===M.LESS?M.LEQUAL:n.func,xt.ReadOnly,n.range)),I.setStencilMode(Zt.disabled);const V=3*m.primitiveLength*2,H=3*m.primitiveOffset*2*2;if(this.forceManualRenderingForInstanceIDShaders){const Y=S||1;for(let te=0;te<Y;++te)O.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",te),M.drawElements(M.LINES,V,M.UNSIGNED_SHORT,H)}else S&&S>1?M.drawElementsInstanced(M.LINES,V,M.UNSIGNED_SHORT,H,S):M.drawElements(M.LINES,V,M.UNSIGNED_SHORT,H);f.bind(),I.program.set(this.program),I.setDepthMode(n),I.setStencilMode(c),I.setColorMode(d)}checkUniforms(t,n,c){if(this.fixedDefines.includes(n)){for(const d of Object.keys(c))if(!c[d].initialized)throw new Error(`Program '${this.name}', from draw '${t}': uniform ${d} not set but required by ${n} being defined`)}}draw(t,n,c,d,f,m,y,v,T,S,C,I,M,D,z,O){const B=t.context,V=B.gl;if(this.failedToCreate)return;B.program.set(this.program),B.setDepthMode(c),B.setStencilMode(d),B.setColorMode(f),B.setCullFace(m);for(const te of Object.keys(this.fixedUniforms))this.fixedUniforms[te].set(this.program,te,y[te]);D&&D.setUniforms(this.program,B,this.binderUniforms,I,{zoom:M});const H={[V.POINTS]:1,[V.LINES]:2,[V.TRIANGLES]:3,[V.LINE_STRIP]:1}[n];this.checkUniforms(v,"RENDER_SHADOWS",this.shadowUniforms);const Y=O&&O>0?1:void 0;for(const te of C.get()){const ee=te.vaos||(te.vaos={});if((ee[v]||(ee[v]=new Sa)).bind(B,this,T,D?D.getPaintVertexBuffers():[],S,te.vertexOffset,z||[],Y),this.forceManualRenderingForInstanceIDShaders){const J=O||1;for(let K=0;K<J;++K)this.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",K),S?V.drawElements(n,te.primitiveLength*H,V.UNSIGNED_SHORT,te.primitiveOffset*H*2):V.drawArrays(n,te.vertexOffset,te.vertexLength)}else O&&O>1?V.drawElementsInstanced(n,te.primitiveLength*H,V.UNSIGNED_SHORT,te.primitiveOffset*H*2,O):S?V.drawElements(n,te.primitiveLength*H,V.UNSIGNED_SHORT,te.primitiveOffset*H*2):V.drawArrays(n,te.vertexOffset,te.vertexLength);n===V.TRIANGLES&&S&&this._drawDebugWireframe(t,c,d,f,S,te,I,M,D,O)}}}function Pl(l,t,n=0){const c=Math.pow(2,t.tileID.overscaledZ),d=t.tileSize*Math.pow(2,l.transform.tileZoom)/c,f=d*(t.tileID.canonical.x+t.tileID.wrap*c),m=d*t.tileID.canonical.y;return{u_image:0,u_texsize:t.imageAtlasTexture?t.imageAtlasTexture.size:[0,0],u_tile_units_to_pixels:1/o.aw(t,1,l.transform.tileZoom),u_pixel_coord_upper:[f>>16,m>>16],u_pixel_coord_lower:[65535&f,65535&m],u_pattern_transition:n}}const Ca={terrain:0,flat:1},hh=o.bz(),Rl=(l,t,n,c,d,f,m,y,v,T,S,C,I,M,D,z,O,B)=>{const V=t.style.light,H=V.properties.get("position"),Y=[H.x,H.y,H.z],te=o.dx();V.properties.get("anchor")==="viewport"&&(o.dy(te,-t.transform.angle),o.dz(Y,Y,te));const ee=V.properties.get("color").toPremultipliedRenderColor(null),J=t.transform,K={u_matrix:l,u_lightpos:Y,u_lightintensity:V.properties.get("intensity"),u_lightcolor:[ee.r,ee.g,ee.b],u_vertical_gradient:+n,u_opacity:c,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:hh,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_height_type:Ca[T],u_base_type:Ca[S],u_ao:d,u_edge_radius:f,u_width_scale:m,u_flood_light_color:D,u_vertical_scale:z,u_flood_light_intensity:O,u_ground_shadow_factor:B};return J.projection.name==="globe"&&(K.u_tile_id=[y.canonical.x,y.canonical.y,1<<y.canonical.z],K.u_zoom_transition=C,K.u_inv_rot_matrix=M,K.u_merc_center=I,K.u_up_dir=J.projection.upVector(new o.cp(0,0,0),I[0]*o.aj,I[1]*o.aj),K.u_height_lift=v),K},Zd=(l,t,n,c,d,f)=>({u_matrix:l,u_edge_radius:t,u_width_scale:n,u_vertical_scale:c,u_height_type:Ca[d],u_base_type:Ca[f]}),Wd=(l,t,n,c,d,f,m,y,v,T,S,C,I,M,D,z,O,B)=>{const V=Rl(l,t,n,c,d,f,m,y,T,S,C,I,M,D,z,O,1,[0,0,0]),H={u_height_factor:-Math.pow(2,y.overscaledZ)/v.tileSize/8};return o.h(V,Pl(t,v,B),H)},Zo=(l,t,n)=>({u_matrix:l,u_emissive_strength:t,u_ground_shadow_factor:n}),Xd=(l,t,n,c,d,f=0)=>o.h(Zo(l,t,d),Pl(n,c,f)),Jp=(l,t,n,c)=>({u_matrix:l,u_world:n,u_emissive_strength:t,u_ground_shadow_factor:c}),Qp=(l,t,n,c,d,f,m=0)=>o.h(Xd(l,t,n,c,f,m),{u_world:d}),em=(l,t)=>({u_matrix:l,u_ground_shadow_factor:t}),qc=(l,t,n,c,d)=>({u_matrix:l,u_camera_pos:[t[0],t[1],t[2]],u_depth_bias:n,u_height_scale:c,u_reset_depth:d}),tm=(l,t,n,c)=>{const d=o.aj/n.tileSize;return{u_matrix:l,u_camera_to_center_distance:t.getCameraToCenterDistance(c),u_extrude_scale:[t.pixelsToGLUnits[0]/d,t.pixelsToGLUnits[1]/d]}},$c=(l,t,n=1)=>({u_matrix:l,u_color:t,u_overlay:0,u_overlay_scale:n}),dh=o.bz(),Yd=(l,t,n,c,d,f,m)=>{const y=l.transform,v=y.projection.name==="globe",T=v?o.dA(y.zoom,t.canonical)*y._pixelsPerMercatorPixel:o.aw(n,1,f),S={u_matrix:t.projMatrix,u_extrude_scale:T,u_intensity:m,u_inv_rot_matrix:dh,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(v){S.u_inv_rot_matrix=c,S.u_merc_center=d,S.u_tile_id=[t.canonical.x,t.canonical.y,1<<t.canonical.z],S.u_zoom_transition=o.ah(y.zoom);const C=d[0]*o.aj,I=d[1]*o.aj;S.u_up_dir=y.projection.upVector(new o.cp(0,0,0),C,I)}return S};function Wo(l,[t,n,c,d],[f,m]){if(f===m)return[0,0,0,0];const y=255*(l-1)/(l*(m-f));return[t*y,n*y,c*y,d*y]}function fh(l,t,[n,c]){return n===c?0:.5/l+(t-n)*(l-1)/(l*(c-n))}const ph=(l,t,n,c,d,f,m,y,v,T,S,C,I,M,D,z,O,B,V,H,Y)=>({u_matrix:l,u_normalize_matrix:t,u_globe_matrix:n,u_merc_matrix:c,u_grid_matrix:d,u_tl_parent:f,u_scale_parent:T,u_fade_t:S.mix,u_opacity:S.opacity*C.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:C.paint.get("raster-brightness-min"),u_brightness_high:C.paint.get("raster-brightness-max"),u_saturation_factor:o.dC(C.paint.get("raster-saturation")),u_contrast_factor:o.dB(C.paint.get("raster-contrast")),u_spin_weights:Kd(C.paint.get("raster-hue-rotate")),u_perspective_transform:I,u_raster_elevation:M,u_zoom_transition:m,u_merc_center:y,u_cutoff_params:v,u_colorization_mix:Wo(o.dD,z,B),u_colorization_offset:fh(o.dD,O,B),u_color_ramp:D,u_texture_offset:[H/(V+2*H),V/(V+2*H)],u_texture_res:[V+2*H,V+2*H],u_emissive_strength:Y});function Kd(l){l*=Math.PI/180;const t=Math.sin(l),n=Math.cos(l);return[(2*n+1)/3,(-Math.sqrt(3)*t-n+1)/3,(Math.sqrt(3)*t-n+1)/3]}const lo=.05,Xo=(l,t,n,c,d,f,m,y,v,T,S,C)=>({u_matrix:l,u_normalize_matrix:t,u_globe_matrix:n,u_merc_matrix:c,u_grid_matrix:d,u_tl_parent:f,u_scale_parent:T,u_fade_t:S.mix,u_opacity:S.opacity,u_image0:0,u_image1:1,u_raster_elevation:C,u_zoom_transition:m,u_merc_center:y,u_cutoff_params:v}),Jd=(l,t,n,c,d,f,m,y,v,T)=>({u_particle_texture:l,u_particle_texture_side_len:t,u_tile_offset:n,u_velocity:c,u_color_ramp:f,u_velocity_res:d,u_max_speed:m,u_uv_offset:y,u_data_scale:[255*v[0],255*v[1]],u_data_offset:T,u_particle_pos_scale:1.1,u_particle_pos_offset:[lo,lo]}),co=(l,t,n,c,d,f,m,y,v,T)=>({u_particle_texture:l,u_particle_texture_side_len:t,u_velocity:n,u_velocity_res:c,u_max_speed:d,u_speed_factor:f,u_reset_rate:m,u_rand_seed:Math.random(),u_uv_offset:y,u_data_scale:[255*v[0],255*v[1]],u_data_offset:T,u_particle_pos_scale:1.1,u_particle_pos_offset:[lo,lo]}),Hc=o.bz(),zl=(l,t,n,c,d,f,m,y,v,T,S,C,I,M,D,z,O,B,V,H,Y,te,ee,J)=>{const K=d.transform,ie={u_is_size_zoom_constant:+(l==="constant"||l==="source"),u_is_size_feature_constant:+(l==="constant"||l==="camera"),u_size_t:t?t.uSizeT:0,u_size:t?t.uSize:0,u_camera_to_center_distance:K.getCameraToCenterDistance(V),u_rotate_symbol:+n,u_aspect_ratio:K.width/K.height,u_fade_change:d.options.fadeDuration?d.symbolFadeChange:1,u_matrix:f,u_label_plane_matrix:m,u_coord_matrix:y,u_is_text:+T,u_elevation_from_sea:v?1:0,u_pitch_with_map:+c,u_texsize:S,u_texsize_icon:C,u_texture:0,u_texture_icon:1,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Hc,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:Hc,u_up_vector:[0,-1,0],u_color_adj_mat:te,u_icon_transition:ee||0,u_gamma_scale:c?d.transform.getCameraToCenterDistance(V)*Math.cos(d.terrain?0:d.transform._pitch):1,u_device_pixel_ratio:o.q.devicePixelRatio,u_is_halo:1,u_scale_factor:J||1,u_ground_shadow_factor:H,u_inv_matrix:o.bi(o.bz(),m),u_normal_scale:Y};return V.name==="globe"&&(ie.u_tile_id=[M.canonical.x,M.canonical.y,1<<M.canonical.z],ie.u_zoom_transition=D,ie.u_inv_rot_matrix=O,ie.u_merc_center=z,ie.u_camera_forward=K._camera.forward(),ie.u_ecef_origin=o.dE(K.globeMatrix,M.toUnwrapped()),ie.u_tile_matrix=Float32Array.from(K.globeMatrix),ie.u_up_vector=B),ie},mh=(l,t,n,c)=>({u_matrix:l,u_emissive_strength:t,u_opacity:n,u_color:c}),_h=(l,t,n,c,d,f,m,y,v)=>o.h(function(T,S,C,I,M,D){const{width:z,height:O}=I.imageManager.getPixelSize(S),B=Math.pow(2,D.tileID.overscaledZ),V=D.tileSize*Math.pow(2,I.transform.tileZoom)/B,H=V*(D.tileID.canonical.x+D.tileID.wrap*B),Y=V*D.tileID.canonical.y;return{u_image:0,u_pattern_tl:C.tl,u_pattern_br:C.br,u_texsize:[z,O],u_pattern_size:C.displaySize,u_pattern_units_to_pixels:M?[I.transform.width,-1*I.transform.height]:[1/o.aw(D,1,I.transform.tileZoom),1/o.aw(D,1,I.transform.tileZoom)],u_pixel_coord_upper:[H>>16,Y>>16],u_pixel_coord_lower:[65535&H,65535&Y]}}(0,f,m,c,y,v),{u_matrix:l,u_emissive_strength:t,u_opacity:n}),Ll=new Float32Array(o.bx([])),Dl=(l,t,n,c,d,f,m,y,v,T,S,C,I,M=[0,0,0],D)=>{const z=d.style.light,O=z.properties.get("position"),B=[-O.x,-O.y,O.z],V=o.dx();z.properties.get("anchor")==="viewport"&&(o.dy(V,-d.transform.angle),o.dz(B,B,V));const H=S.alphaMode==="MASK",Y=z.properties.get("color").toNonPremultipliedRenderColor(null),te=I.paint.get("model-ambient-occlusion-intensity"),ee=I.paint.get("model-color").constantOr(o.am.white).toNonPremultipliedRenderColor(null);return ee.a=I.paint.get("model-color-mix-intensity").constantOr(0),{u_matrix:l,u_lighting_matrix:t,u_normal_matrix:n,u_node_matrix:c||Ll,u_lightpos:B,u_lightintensity:z.properties.get("intensity"),u_lightcolor:[Y.r,Y.g,Y.b],u_camera_pos:M,u_opacity:f,u_baseTextureIsAlpha:0,u_alphaMask:+H,u_alphaCutoff:S.alphaCutoff,u_baseColorFactor:m.toNonPremultipliedRenderColor(null).toArray01(),u_emissiveFactor:y.toNonPremultipliedRenderColor(null).toArray01(),u_metallicFactor:v,u_roughnessFactor:T,u_baseColorTexture:xn.BaseColor,u_metallicRoughnessTexture:xn.MetallicRoughness,u_normalTexture:xn.Normal,u_occlusionTexture:xn.Occlusion,u_emissionTexture:xn.Emission,u_lutTexture:xn.LUT,u_color_mix:ee.toArray01(),u_aoIntensity:te,u_emissive_strength:C,u_occlusionTextureTransform:D||[0,0,0,0]}},Qd=(l,t=Ll,n=Ll)=>({u_matrix:l,u_instance:t,u_node_matrix:n}),ef={fillExtrusion:l=>({u_matrix:new o.cc(l),u_lightpos:new o.c9(l),u_lightintensity:new o.ca(l),u_lightcolor:new o.c9(l),u_vertical_gradient:new o.ca(l),u_opacity:new o.ca(l),u_edge_radius:new o.ca(l),u_width_scale:new o.ca(l),u_ao:new o.cb(l),u_height_type:new o.c8(l),u_base_type:new o.c8(l),u_tile_id:new o.c9(l),u_zoom_transition:new o.ca(l),u_inv_rot_matrix:new o.cc(l),u_merc_center:new o.cb(l),u_up_dir:new o.c9(l),u_height_lift:new o.ca(l),u_flood_light_color:new o.c9(l),u_vertical_scale:new o.ca(l),u_flood_light_intensity:new o.ca(l),u_ground_shadow_factor:new o.c9(l)}),fillExtrusionDepth:l=>({u_matrix:new o.cc(l),u_edge_radius:new o.ca(l),u_width_scale:new o.ca(l),u_vertical_scale:new o.ca(l),u_height_type:new o.c8(l),u_base_type:new o.c8(l)}),fillExtrusionPattern:l=>({u_matrix:new o.cc(l),u_lightpos:new o.c9(l),u_lightintensity:new o.ca(l),u_lightcolor:new o.c9(l),u_vertical_gradient:new o.ca(l),u_height_factor:new o.ca(l),u_edge_radius:new o.ca(l),u_width_scale:new o.ca(l),u_ao:new o.cb(l),u_height_type:new o.c8(l),u_base_type:new o.c8(l),u_tile_id:new o.c9(l),u_zoom_transition:new o.ca(l),u_inv_rot_matrix:new o.cc(l),u_merc_center:new o.cb(l),u_up_dir:new o.c9(l),u_height_lift:new o.ca(l),u_image:new o.c8(l),u_texsize:new o.cb(l),u_pixel_coord_upper:new o.cb(l),u_pixel_coord_lower:new o.cb(l),u_tile_units_to_pixels:new o.ca(l),u_opacity:new o.ca(l),u_pattern_transition:new o.ca(l)}),fillExtrusionGroundEffect:l=>({u_matrix:new o.cc(l),u_opacity:new o.ca(l),u_ao_pass:new o.ca(l),u_meter_to_tile:new o.ca(l),u_ao:new o.cb(l),u_flood_light_intensity:new o.ca(l),u_flood_light_color:new o.c9(l),u_attenuation:new o.ca(l),u_edge_radius:new o.ca(l),u_fb:new o.c8(l),u_fb_size:new o.ca(l),u_dynamic_offset:new o.ca(l)}),fill:l=>({u_matrix:new o.cc(l),u_emissive_strength:new o.ca(l),u_ground_shadow_factor:new o.c9(l)}),fillPattern:l=>({u_matrix:new o.cc(l),u_emissive_strength:new o.ca(l),u_image:new o.c8(l),u_texsize:new o.cb(l),u_pixel_coord_upper:new o.cb(l),u_pixel_coord_lower:new o.cb(l),u_tile_units_to_pixels:new o.ca(l),u_ground_shadow_factor:new o.c9(l),u_pattern_transition:new o.ca(l)}),fillOutline:l=>({u_matrix:new o.cc(l),u_emissive_strength:new o.ca(l),u_world:new o.cb(l),u_ground_shadow_factor:new o.c9(l)}),fillOutlinePattern:l=>({u_matrix:new o.cc(l),u_emissive_strength:new o.ca(l),u_world:new o.cb(l),u_image:new o.c8(l),u_texsize:new o.cb(l),u_pixel_coord_upper:new o.cb(l),u_pixel_coord_lower:new o.cb(l),u_tile_units_to_pixels:new o.ca(l),u_ground_shadow_factor:new o.c9(l),u_pattern_transition:new o.ca(l)}),building:l=>({u_matrix:new o.cc(l),u_normal_matrix:new o.cc(l),u_opacity:new o.ca(l)}),buildingDepth:l=>({u_matrix:new o.cc(l)}),elevatedStructuresDepth:l=>({u_matrix:new o.cc(l),u_depth_bias:new o.ca(l)}),elevatedStructures:l=>({u_matrix:new o.cc(l),u_ground_shadow_factor:new o.c9(l)}),elevatedStructuresDepthReconstruct:l=>({u_matrix:new o.cc(l),u_camera_pos:new o.c9(l),u_depth_bias:new o.ca(l),u_height_scale:new o.ca(l),u_reset_depth:new o.ca(l)}),circle:o.dH,collisionBox:l=>({u_matrix:new o.cc(l),u_camera_to_center_distance:new o.ca(l),u_extrude_scale:new o.cb(l)}),collisionCircle:l=>({u_matrix:new o.cc(l),u_inv_matrix:new o.cc(l),u_camera_to_center_distance:new o.ca(l),u_viewport_size:new o.cb(l)}),debug:l=>({u_color:new o.di(l),u_matrix:new o.cc(l),u_overlay:new o.c8(l),u_overlay_scale:new o.ca(l)}),clippingMask:l=>({u_matrix:new o.cc(l)}),heatmap:l=>({u_extrude_scale:new o.ca(l),u_intensity:new o.ca(l),u_matrix:new o.cc(l),u_inv_rot_matrix:new o.cc(l),u_merc_center:new o.cb(l),u_tile_id:new o.c9(l),u_zoom_transition:new o.ca(l),u_up_dir:new o.c9(l)}),heatmapTexture:l=>({u_image:new o.c8(l),u_color_ramp:new o.c8(l),u_opacity:new o.ca(l)}),hillshade:l=>({u_matrix:new o.cc(l),u_image:new o.c8(l),u_latrange:new o.cb(l),u_light:new o.cb(l),u_shadow:new o.di(l),u_highlight:new o.di(l),u_emissive_strength:new o.ca(l),u_accent:new o.di(l)}),hillshadePrepare:l=>({u_matrix:new o.cc(l),u_image:new o.c8(l),u_dimension:new o.cb(l),u_zoom:new o.ca(l)}),line:o.dG,linePattern:o.dF,raster:l=>({u_matrix:new o.cc(l),u_normalize_matrix:new o.cc(l),u_globe_matrix:new o.cc(l),u_merc_matrix:new o.cc(l),u_grid_matrix:new o.dj(l),u_tl_parent:new o.cb(l),u_scale_parent:new o.ca(l),u_fade_t:new o.ca(l),u_opacity:new o.ca(l),u_image0:new o.c8(l),u_image1:new o.c8(l),u_brightness_low:new o.ca(l),u_brightness_high:new o.ca(l),u_saturation_factor:new o.ca(l),u_contrast_factor:new o.ca(l),u_spin_weights:new o.c9(l),u_perspective_transform:new o.cb(l),u_raster_elevation:new o.ca(l),u_zoom_transition:new o.ca(l),u_merc_center:new o.cb(l),u_cutoff_params:new o.cQ(l),u_colorization_mix:new o.cQ(l),u_colorization_offset:new o.ca(l),u_color_ramp:new o.c8(l),u_texture_offset:new o.cb(l),u_texture_res:new o.cb(l),u_emissive_strength:new o.ca(l)}),rasterParticle:l=>({u_matrix:new o.cc(l),u_normalize_matrix:new o.cc(l),u_globe_matrix:new o.cc(l),u_merc_matrix:new o.cc(l),u_grid_matrix:new o.dj(l),u_tl_parent:new o.cb(l),u_scale_parent:new o.ca(l),u_fade_t:new o.ca(l),u_opacity:new o.ca(l),u_image0:new o.c8(l),u_image1:new o.c8(l),u_raster_elevation:new o.ca(l),u_zoom_transition:new o.ca(l),u_merc_center:new o.cb(l),u_cutoff_params:new o.cQ(l)}),rasterParticleTexture:l=>({u_texture:new o.c8(l),u_opacity:new o.ca(l)}),rasterParticleDraw:l=>({u_particle_texture:new o.c8(l),u_particle_texture_side_len:new o.ca(l),u_tile_offset:new o.cb(l),u_velocity:new o.c8(l),u_color_ramp:new o.c8(l),u_velocity_res:new o.cb(l),u_max_speed:new o.ca(l),u_uv_offset:new o.cb(l),u_data_scale:new o.cb(l),u_data_offset:new o.ca(l),u_particle_pos_scale:new o.ca(l),u_particle_pos_offset:new o.cb(l)}),rasterParticleUpdate:l=>({u_particle_texture:new o.c8(l),u_particle_texture_side_len:new o.ca(l),u_velocity:new o.c8(l),u_velocity_res:new o.cb(l),u_max_speed:new o.ca(l),u_speed_factor:new o.ca(l),u_reset_rate:new o.ca(l),u_rand_seed:new o.ca(l),u_uv_offset:new o.cb(l),u_data_scale:new o.cb(l),u_data_offset:new o.ca(l),u_particle_pos_scale:new o.ca(l),u_particle_pos_offset:new o.cb(l)}),symbol:l=>({u_is_size_zoom_constant:new o.c8(l),u_is_size_feature_constant:new o.c8(l),u_size_t:new o.ca(l),u_size:new o.ca(l),u_camera_to_center_distance:new o.ca(l),u_rotate_symbol:new o.c8(l),u_aspect_ratio:new o.ca(l),u_fade_change:new o.ca(l),u_matrix:new o.cc(l),u_label_plane_matrix:new o.cc(l),u_coord_matrix:new o.cc(l),u_is_text:new o.c8(l),u_elevation_from_sea:new o.c8(l),u_pitch_with_map:new o.c8(l),u_texsize:new o.cb(l),u_texsize_icon:new o.cb(l),u_texture:new o.c8(l),u_texture_icon:new o.c8(l),u_gamma_scale:new o.ca(l),u_device_pixel_ratio:new o.ca(l),u_tile_id:new o.c9(l),u_zoom_transition:new o.ca(l),u_inv_rot_matrix:new o.cc(l),u_merc_center:new o.cb(l),u_camera_forward:new o.c9(l),u_tile_matrix:new o.cc(l),u_up_vector:new o.c9(l),u_ecef_origin:new o.c9(l),u_is_halo:new o.c8(l),u_icon_transition:new o.ca(l),u_color_adj_mat:new o.cc(l),u_scale_factor:new o.ca(l),u_ground_shadow_factor:new o.c9(l),u_inv_matrix:new o.cc(l),u_normal_scale:new o.ca(l)}),background:l=>({u_matrix:new o.cc(l),u_emissive_strength:new o.ca(l),u_opacity:new o.ca(l),u_color:new o.di(l)}),backgroundPattern:l=>({u_matrix:new o.cc(l),u_emissive_strength:new o.ca(l),u_opacity:new o.ca(l),u_image:new o.c8(l),u_pattern_tl:new o.cb(l),u_pattern_br:new o.cb(l),u_texsize:new o.cb(l),u_pattern_size:new o.cb(l),u_pixel_coord_upper:new o.cb(l),u_pixel_coord_lower:new o.cb(l),u_pattern_units_to_pixels:new o.cb(l)}),terrainRaster:l=>({u_matrix:new o.cc(l),u_image0:new o.c8(l),u_skirt_height:new o.ca(l),u_ground_shadow_factor:new o.c9(l)}),skybox:l=>({u_matrix:new o.cc(l),u_sun_direction:new o.c9(l),u_cubemap:new o.c8(l),u_opacity:new o.ca(l),u_temporal_offset:new o.ca(l)}),skyboxGradient:l=>({u_matrix:new o.cc(l),u_color_ramp:new o.c8(l),u_center_direction:new o.c9(l),u_radius:new o.ca(l),u_opacity:new o.ca(l),u_temporal_offset:new o.ca(l)}),skyboxCapture:l=>({u_matrix_3f:new o.dj(l),u_sun_direction:new o.c9(l),u_sun_intensity:new o.ca(l),u_color_tint_r:new o.cQ(l),u_color_tint_m:new o.cQ(l),u_luminance:new o.ca(l)}),globeRaster:l=>({u_proj_matrix:new o.cc(l),u_globe_matrix:new o.cc(l),u_normalize_matrix:new o.cc(l),u_merc_matrix:new o.cc(l),u_zoom_transition:new o.ca(l),u_merc_center:new o.cb(l),u_image0:new o.c8(l),u_grid_matrix:new o.dj(l),u_skirt_height:new o.ca(l),u_far_z_cutoff:new o.ca(l),u_frustum_tl:new o.c9(l),u_frustum_tr:new o.c9(l),u_frustum_br:new o.c9(l),u_frustum_bl:new o.c9(l),u_globe_pos:new o.c9(l),u_globe_radius:new o.ca(l),u_viewport:new o.cb(l)}),globeAtmosphere:l=>({u_frustum_tl:new o.c9(l),u_frustum_tr:new o.c9(l),u_frustum_br:new o.c9(l),u_frustum_bl:new o.c9(l),u_horizon:new o.ca(l),u_transition:new o.ca(l),u_fadeout_range:new o.ca(l),u_color:new o.cQ(l),u_high_color:new o.cQ(l),u_space_color:new o.cQ(l),u_temporal_offset:new o.ca(l),u_horizon_angle:new o.ca(l)}),model:l=>({u_matrix:new o.cc(l),u_lighting_matrix:new o.cc(l),u_normal_matrix:new o.cc(l),u_node_matrix:new o.cc(l),u_lightpos:new o.c9(l),u_lightintensity:new o.ca(l),u_lightcolor:new o.c9(l),u_camera_pos:new o.c9(l),u_opacity:new o.ca(l),u_baseColorFactor:new o.cQ(l),u_emissiveFactor:new o.cQ(l),u_metallicFactor:new o.ca(l),u_roughnessFactor:new o.ca(l),u_baseTextureIsAlpha:new o.c8(l),u_alphaMask:new o.c8(l),u_alphaCutoff:new o.ca(l),u_baseColorTexture:new o.c8(l),u_metallicRoughnessTexture:new o.c8(l),u_normalTexture:new o.c8(l),u_occlusionTexture:new o.c8(l),u_emissionTexture:new o.c8(l),u_lutTexture:new o.c8(l),u_color_mix:new o.cQ(l),u_aoIntensity:new o.ca(l),u_emissive_strength:new o.ca(l),u_occlusionTextureTransform:new o.cQ(l)}),modelDepth:l=>({u_matrix:new o.cc(l),u_instance:new o.cc(l),u_node_matrix:new o.cc(l)}),groundShadow:l=>({u_matrix:new o.cc(l),u_ground_shadow_factor:new o.c9(l)}),stars:l=>({u_matrix:new o.cc(l),u_up:new o.c9(l),u_right:new o.c9(l),u_intensity_multiplier:new o.ca(l)}),snowParticle:l=>({u_modelview:new o.cc(l),u_projection:new o.cc(l),u_time:new o.ca(l),u_cam_pos:new o.c9(l),u_velocityConeAperture:new o.ca(l),u_velocity:new o.ca(l),u_horizontalOscillationRadius:new o.ca(l),u_horizontalOscillationRate:new o.ca(l),u_boxSize:new o.ca(l),u_billboardSize:new o.ca(l),u_simpleShapeParameters:new o.cb(l),u_screenSize:new o.cb(l),u_thinningCenterPos:new o.cb(l),u_thinningShape:new o.c9(l),u_thinningAffectedRatio:new o.ca(l),u_thinningParticleOffset:new o.ca(l),u_particleColor:new o.cQ(l),u_direction:new o.c9(l)}),rainParticle:l=>({u_modelview:new o.cc(l),u_projection:new o.cc(l),u_time:new o.ca(l),u_cam_pos:new o.c9(l),u_texScreen:new o.c8(l),u_velocityConeAperture:new o.ca(l),u_velocity:new o.ca(l),u_boxSize:new o.ca(l),u_rainDropletSize:new o.cb(l),u_distortionStrength:new o.ca(l),u_rainDirection:new o.c9(l),u_color:new o.cQ(l),u_screenSize:new o.cb(l),u_thinningCenterPos:new o.cb(l),u_thinningShape:new o.c9(l),u_thinningAffectedRatio:new o.ca(l),u_thinningParticleOffset:new o.ca(l),u_shapeDirectionalPower:new o.ca(l),u_shapeNormalPower:new o.ca(l),u_mode:new o.ca(l)}),vignette:l=>({u_vignetteShape:new o.c9(l),u_vignetteColor:new o.cQ(l)}),occlusion:l=>({u_matrix:new o.cc(l),u_anchorPos:new o.c9(l),u_screenSizePx:new o.cb(l),u_occluderSizePx:new o.cb(l),u_color:new o.cQ(l)})};class Qn{constructor(t,n,c,d){this.id=Qn.uniqueIdxCounter,Qn.uniqueIdxCounter++,this.context=t;const f=t.gl;this.buffer=f.createBuffer(),this.dynamicDraw=!!c,this.context.unbindVAO(),t.bindElementBuffer.set(this.buffer),f.bufferData(f.ELEMENT_ARRAY_BUFFER,n.arrayBuffer,this.dynamicDraw?f.DYNAMIC_DRAW:f.STATIC_DRAW),this.dynamicDraw||d||n.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(t){this.id=Qn.uniqueIdxCounter,Qn.uniqueIdxCounter++;const n=this.context.gl;this.context.unbindVAO(),this.bind(),n.bufferSubData(n.ELEMENT_ARRAY_BUFFER,0,t.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}Qn.uniqueIdxCounter=0;const im={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class rm{constructor(t,n,c,d,f,m){this.length=n.length,this.attributes=c,this.itemSize=n.bytesPerElement,this.dynamicDraw=d,this.instanceCount=m,this.context=t;const y=t.gl;this.buffer=y.createBuffer(),t.bindVertexBuffer.set(this.buffer),y.bufferData(y.ARRAY_BUFFER,n.arrayBuffer,this.dynamicDraw?y.DYNAMIC_DRAW:y.STATIC_DRAW),this.dynamicDraw||f||n.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(t){const n=this.context.gl;this.bind(),n.bufferSubData(n.ARRAY_BUFFER,0,t.arrayBuffer)}enableAttributes(t,n){for(let c=0;c<this.attributes.length;c++){const d=n.attributes[this.attributes[c].name];d!==void 0&&t.enableVertexAttribArray(d)}}setVertexAttribPointers(t,n,c){for(let d=0;d<this.attributes.length;d++){const f=this.attributes[d],m=n.attributes[f.name];m!==void 0&&t.vertexAttribPointer(m,f.components,t[im[f.type]],!1,this.itemSize,f.offset+this.itemSize*(c||0))}}setVertexAttribDivisor(t,n,c){for(let d=0;d<this.attributes.length;d++){const f=n.attributes[this.attributes[d].name];f!==void 0&&this.instanceCount&&this.instanceCount>0&&t.vertexAttribDivisor(f,c)}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class gh{constructor(t,n,c,d,f){this.context=t,this.width=n,this.height=c;const m=this.framebuffer=t.gl.createFramebuffer();d&&(this.colorAttachment=new qd(t,m)),f&&(this.depthAttachmentType=f,this.depthAttachment=f==="renderbuffer"?new $d(t,m):new Xp(t,m))}destroy(){const t=this.context.gl;if(this.colorAttachment){const n=this.colorAttachment.get();n&&t.deleteTexture(n)}if(this.depthAttachment&&this.depthAttachmentType)if(this.depthAttachmentType==="renderbuffer"){const n=this.depthAttachment.get();n&&t.deleteRenderbuffer(n)}else{const n=this.depthAttachment.get();n&&t.deleteTexture(n)}t.deleteFramebuffer(this.framebuffer)}}class nm{constructor(t,n){this.gl=t,this.clearColor=new kd(this),this.clearDepth=new th(this),this.clearStencil=new Gp(this),this.colorMask=new qp(this),this.depthMask=new $p(this),this.stencilMask=new Hp(this),this.stencilFunc=new Fd(this),this.stencilOp=new Zp(this),this.stencilTest=new zc(this),this.depthRange=new Wp(this),this.depthTest=new Bd(this),this.depthFunc=new ih(this),this.blend=new Lc(this),this.blendFunc=new rh(this),this.blendColor=new qo(this),this.blendEquation=new Ea(this),this.cullFace=new Dc(this),this.cullFaceSide=new Oc(this),this.frontFace=new Ia(this),this.program=new Nd(this),this.activeTexture=new nh(this),this.viewport=new Vd(this),this.bindFramebuffer=new Aa(this),this.bindRenderbuffer=new kc(this),this.bindTexture=new Fc(this),this.bindVertexBuffer=new sh(this),this.bindElementBuffer=new Bc(this),this.bindVertexArrayOES=new Cl(this),this.pixelStoreUnpack=new Ud(this),this.pixelStoreUnpackPremultiplyAlpha=new jd(this),this.pixelStoreUnpackFlipY=new Gd(this),this.options=n?Object.assign({},n):{},this.options.extTextureFilterAnisotropicForceOff||(this.extTextureFilterAnisotropic=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=t.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT))),this.extDebugRendererInfo=t.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=t.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=t.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),this.forceManualRenderingForInstanceIDShaders=n&&!!n.forceManualRenderingForInstanceIDShaders||this.renderer&&this.renderer.indexOf("PowerVR")!==-1,this.options.extTextureFloatLinearForceOff||(this.extTextureFloatLinear=t.getExtension("OES_texture_float_linear")),this.extRenderToTextureHalfFloat=t.getExtension("EXT_color_buffer_half_float"),this.extTimerQuery=t.getExtension("EXT_disjoint_timer_query_webgl2"),this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this.maxPointSize=t.getParameter(t.ALIASED_POINT_SIZE_RANGE)[1]}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArrayOES.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(t,n,c){return new Qn(this,t,n,c)}createVertexBuffer(t,n,c,d,f){return new rm(this,t,n,c,d,f)}createRenderbuffer(t,n,c){const d=this.gl,f=d.createRenderbuffer();return this.bindRenderbuffer.set(f),d.renderbufferStorage(d.RENDERBUFFER,t,n,c),this.bindRenderbuffer.set(null),f}createFramebuffer(t,n,c,d){return new gh(this,t,n,c,d)}clear({color:t,depth:n,stencil:c,colorMask:d}){const f=this.gl;let m=0;t&&(m|=f.COLOR_BUFFER_BIT,this.clearColor.set(t.toNonPremultipliedRenderColor(null)),this.colorMask.set(d||[!0,!0,!0,!0])),n!==void 0&&(m|=f.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(n),this.depthMask.set(!0)),c!==void 0&&(m|=f.STENCIL_BUFFER_BIT,this.clearStencil.set(c),this.stencilMask.set(255)),f.clear(m)}setCullFace(t){t.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(t.mode),this.frontFace.set(t.frontFace))}setDepthMode(t){t.func!==this.gl.ALWAYS||t.mask?(this.depthTest.set(!0),this.depthFunc.set(t.func),this.depthMask.set(t.mask),this.depthRange.set(t.range)):this.depthTest.set(!1)}setStencilMode(t){t.test.func!==this.gl.ALWAYS||t.mask?(this.stencilTest.set(!0),this.stencilMask.set(t.mask),this.stencilOp.set([t.fail,t.depthFail,t.pass]),this.stencilFunc.set({func:t.test.func,ref:t.ref,mask:t.test.mask})):this.stencilTest.set(!1)}setColorMode(t){o.bv(t.blendFunction,oi.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(t.blendFunction),this.blendColor.set(t.blendColor),t.blendEquation?this.blendEquation.set(t.blendEquation):this.blendEquation.setDefault()),this.colorMask.set(t.mask)}unbindVAO(){this.bindVertexArrayOES.set(null)}}let Ma;function Zc(l,t,n,c,d,f,m){const y=l.context,v=y.gl,T=l.transform,S=l.getOrCreateProgram("collisionBox"),C=[];let I=0,M=0;for(let Y=0;Y<c.length;Y++){const te=c[Y],ee=t.getTile(te),J=ee.getBucket(n);if(!J)continue;const K=Ut(te,J,T);let ie=K;d[0]===0&&d[1]===0||(ie=l.translatePosMatrix(K,ee,d,f));const se=m?J.textCollisionBox:J.iconCollisionBox,ye=J.collisionCircleArray;if(ye.length>0){const ve=o.bz(),Oe=ie;o.cB(ve,J.placementInvProjMatrix,T.glCoordMatrix),o.cB(ve,ve,J.placementViewportMatrix),C.push({circleArray:ye,circleOffset:M,transform:Oe,invTransform:ve,projection:J.getProjection()}),I+=ye.length/4,M=I}se&&(l.terrain&&l.terrain.setupElevationDraw(ee,S),S.draw(l,v.LINES,xt.disabled,Zt.disabled,l.colorModeForRenderPass(),Nt.disabled,tm(ie,T,ee,J.getProjection()),n.id,se.layoutVertexBuffer,se.indexBuffer,se.segments,null,T.zoom,null,[se.collisionVertexBuffer,se.collisionVertexBufferExt]))}if(!m||!C.length)return;const D=l.getOrCreateProgram("collisionCircle"),z=new o.dI;z.resize(4*I),z._trim();let O=0;for(const Y of C)for(let te=0;te<Y.circleArray.length/4;te++){const ee=4*te,J=Y.circleArray[ee+0],K=Y.circleArray[ee+1],ie=Y.circleArray[ee+2],se=Y.circleArray[ee+3];z.emplace(O++,J,K,ie,se,0),z.emplace(O++,J,K,ie,se,1),z.emplace(O++,J,K,ie,se,2),z.emplace(O++,J,K,ie,se,3)}(!Ma||Ma.length<2*I)&&(Ma=function(Y){const te=2*Y,ee=new o.a_;ee.resize(te),ee._trim();for(let J=0;J<te;J++){const K=6*J;ee.uint16[K+0]=4*J+0,ee.uint16[K+1]=4*J+1,ee.uint16[K+2]=4*J+2,ee.uint16[K+3]=4*J+2,ee.uint16[K+4]=4*J+3,ee.uint16[K+5]=4*J+0}return ee}(I));const B=y.createIndexBuffer(Ma,!0),V=y.createVertexBuffer(z,o.dJ.members,!0);for(const Y of C){const te={u_matrix:Y.transform,u_inv_matrix:Y.invTransform,u_camera_to_center_distance:(H=T).getCameraToCenterDistance(Y.projection),u_viewport_size:[H.width,H.height]};D.draw(l,v.TRIANGLES,xt.disabled,Zt.disabled,l.colorModeForRenderPass(),Nt.disabled,te,n.id,V,B,o.bd.simpleSegment(0,2*Y.circleOffset,Y.circleArray.length,Y.circleArray.length/2),null,T.zoom)}var H;V.destroy(),B.destroy()}const Ds=o.bz();function Ol(l){const t=l._camera.getWorldToCamera(l.worldSize,1),n=o.az([],t,l.globeMatrix);o.bi(n,n);const c=[0,0,0],d=[0,1,0,0];return o.aA(d,d,n),c[0]=d[0],c[1]=d[1],c[2]=d[2],o.au(c,c),c}function kl({width:l,height:t,anchor:n,textOffset:c,textScale:d},f){const{horizontalAlign:m,verticalAlign:y}=o.bT(n),v=-(m-.5)*l,T=-(y-.5)*t,S=o.bU(n,c);return new o.P((v/d+S[0])*f,(T/d+S[1])*f)}function tf(l,t,n,c,d,f,m,y,v,T){const S=l.text.placedSymbolArray,C=l.text.dynamicLayoutVertexArray,I=l.icon.dynamicLayoutVertexArray,M={},D=l.getProjection(),z=wc(m,D,d),O=d.elevation,B=D.upVectorScale(m.canonical,d.center.lat,d.worldSize).metersToTile;C.clear();for(let V=0;V<S.length;V++){const H=S.get(V),{tileAnchorX:Y,tileAnchorY:te,numGlyphs:ee}=H,J=H.hidden||!H.crossTileID||l.allowVerticalPlacement&&!H.placedOrientation?null:c[H.crossTileID];if(J){let K=0,ie=0,se=0;if(O){const Ne=O?O.getAtTileOffset(m,Y,te):0,[Se,qe,rt]=D.upVector(m.canonical,Y,te);K=Ne*Se*B,ie=Ne*qe*B,se=Ne*rt*B}let[ye,ve,Oe,ke]=os(H.projectedAnchorX+K,H.projectedAnchorY+ie,H.projectedAnchorZ+se,n?z:f);const Ze=_l(d.getCameraToCenterDistance(D),ke);let _e=o.bJ(l.textSizeData,v,H)*Ze/o.bO;n&&(_e*=l.tilePixelRatio/y);const Pe=kl(J,_e);n?({x:ye,y:ve,z:Oe}=D.projectTilePoint(Y+Pe.x,te+Pe.y,m.canonical),[ye,ve,Oe]=os(ye+K,ve+ie,Oe+se,f)):(t&&Pe._rotate(-d.angle),ye+=Pe.x,ve+=Pe.y,Oe=0);const ue=l.allowVerticalPlacement&&H.placedOrientation===o.bI.vertical?Math.PI/2:0;for(let Ne=0;Ne<ee;Ne++)o.bL(C,ye,ve,Oe,ue);T&&H.associatedIconIndex>=0&&(M[H.associatedIconIndex]={x:ye,y:ve,z:Oe,angle:ue})}else No(ee,C)}if(T){I.clear();const V=l.icon.placedSymbolArray;for(let H=0;H<V.length;H++){const Y=V.get(H),{numGlyphs:te}=Y,ee=M[H];if(Y.hidden||!ee)No(te,I);else{const{x:J,y:K,z:ie,angle:se}=ee;for(let ye=0;ye<te;ye++)o.bL(I,J,K,ie,se)}}l.icon.dynamicLayoutVertexBuffer.updateData(I)}l.text.dynamicLayoutVertexBuffer.updateData(C)}function Pa(l,t,n,c,d,f,m={}){const y=n.paint.get("icon-translate"),v=n.paint.get("text-translate"),T=n.paint.get("icon-translate-anchor"),S=n.paint.get("text-translate-anchor"),C=n.layout.get("icon-rotation-alignment"),I=n.layout.get("text-rotation-alignment"),M=n.layout.get("icon-pitch-alignment"),D=n.layout.get("text-pitch-alignment"),z=n.layout.get("icon-keep-upright"),O=n.layout.get("text-keep-upright"),B=n.paint.get("icon-color-saturation"),V=n.paint.get("icon-color-contrast"),H=n.paint.get("icon-color-brightness-min"),Y=n.paint.get("icon-color-brightness-max"),te=n.layout.get("symbol-elevation-reference")==="sea",ee=l.context,J=ee.gl,K=l.transform,ie=C==="map",se=I==="map",ye=M==="map",ve=D==="map",Oe=n.layout.get("symbol-sort-key").constantOr(1)!==void 0;let ke=!1;const Ze=l.depthModeForSublayer(0,xt.ReadOnly),_e=new xt(l.context.gl.LEQUAL,xt.ReadOnly,l.depthRangeFor3D),Pe=[o.aD(K.center.lng),o.aH(K.center.lat)],ue=n.layout.get("text-variable-anchor"),Ne=K.projection.name==="globe",Se=[],qe=[0,-1,0];for(const rt of c){const Fe=t.getTile(rt),tt=Fe.getBucket(n);if(!tt||tt.projection.name==="mercator"&&Ne||tt.fullyClipped)continue;const wt=tt.projection.name==="globe",Tt=wt?o.ah(K.zoom):0,gt=wc(rt,tt.getProjection(),K),Rt=K.calculatePixelsToTileUnitsMatrix(Fe),Dt=ue&&tt.hasTextData(),kt=tt.hasIconTextFit()&&Dt&&tt.hasIconData(),$t=tt.getProjection().createInversionMatrix(K,rt.canonical),ti=(1<<Fe.tileID.canonical.z)*o.aj/l.transform.worldSize,zi=Qi=>{let Ai=[0,0,0];if(Qi){const wr=l.style.directionalLight,mi=l.style.ambientLight;wr&&mi&&(Ai=jo(l.style,wr,mi))}return Ai},Ji=Qi=>{K.depthOcclusionForSymbolsAndCircles&&(n.hasInitialOcclusionOpacityProperties||l.terrain)&&(Qi.push("DEPTH_D24"),Qi.push("DEPTH_OCCLUSION"))},Fi=()=>{const Qi=ie&&n.layout.get("symbol-placement")!=="point",Ai=[];Ji(Ai);const wr=Qi||kt,mi=tt.elevationType==="road"&&ye,Fr=l.shadowRenderer,sr=mi&&!!Fr&&Fr.enabled,Wi=zi(sr),or=mi?_e:Ze,Mi=n.paint.get("icon-image-cross-fade");l.terrainRenderModeElevated()&&ye&&Ai.push("PITCH_WITH_MAP_TERRAIN"),wt&&(Ai.push("PROJECTION_GLOBE_VIEW"),wr&&Ai.push("PROJECTED_POS_ON_VIEWPORT")),Mi>0&&Ai.push("ICON_TRANSITION"),tt.icon.zOffsetVertexBuffer&&Ai.push("Z_OFFSET"),B===0&&V===0&&H===0&&Y===1||Ai.push("COLOR_ADJUSTMENT"),tt.sdfIcons&&Ai.push("RENDER_SDF"),sr&&Ai.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),mi&&tt.icon.orientationVertexBuffer&&Ai.push("ELEVATED_ROADS");const Sr=tt.icon.programConfigurations.get(n.id),tn=l.getOrCreateProgram("symbol",{config:Sr,defines:Ai}),dr=Fe.imageAtlasTexture?Fe.imageAtlasTexture.size:[0,0],Ti=tt.iconSizeData,kn=o.bH(Ti,K.zoom),An=ye||!K.isOrthographic,Hn=Ps(gt,Fe.tileID.canonical,ye,ie,K,tt.getProjection(),Rt),us=vc(gt,Fe.tileID.canonical,ye,ie,K,tt.getProjection(),Rt),ts=l.translatePosMatrix(us,Fe,y,T,!0),Cn=l.translatePosMatrix(gt,Fe,y,T),vo=wr?Ds:Hn,hs=ie&&!ye&&!Qi;let xo=qe;!Ne&&!K.mercatorFromTransition||ie||(xo=Ol(K));const Ql=wt?xo:qe,Uh=n.getColorAdjustmentMatrix(B,V,H,Y),qa=zl(Ti.kind,kn,hs,ye,l,Cn,vo,ts,te,!1,dr,[0,0],0,rt,Tt,Pe,$t,Ql,tt.getProjection(),Wi,ti,Uh,Mi,null),jh=Fe.imageAtlasTexture?Fe.imageAtlasTexture:null,ec=n.layout.get("icon-size").constantOr(0)!==1||tt.iconsNeedLinear,du=tt.sdfIcons||l.options.rotating||l.options.zooming||ec||An?J.LINEAR:J.NEAREST,fu=tt.sdfIcons&&n.paint.get("icon-halo-width").constantOr(1)!==0,bs=l.terrain&&ye&&Qi?o.bi(o.bz(),Hn):Ds;if(Qi&&tt.icon){const $a=K.elevation,ta=$a?$a.getAtTileOffsetFunc(rt,K.center.lat,K.worldSize,tt.getProjection()):null,bo=yc(gt,Fe.tileID.canonical,ye,ie,K,tt.getProjection(),Rt);xc(tt,gt,l,!1,bo,us,ye,z,ta,rt)}return{program:tn,buffers:tt.icon,uniformValues:qa,atlasTexture:jh,atlasTextureIcon:null,atlasInterpolation:du,atlasInterpolationIcon:null,isSDF:tt.sdfIcons,hasHalo:fu,depthMode:or,tile:Fe,renderWithShadows:sr,labelPlaneMatrixInv:bs}},Vi=()=>{const Qi=se&&n.layout.get("symbol-placement")!=="point",Ai=[],wr=Qi||ue||kt,mi=tt.elevationType==="road"&&ve,Fr=l.shadowRenderer,sr=mi&&!!Fr&&Fr.enabled,Wi=zi(sr),or=mi?_e:Ze;l.terrainRenderModeElevated()&&ve&&Ai.push("PITCH_WITH_MAP_TERRAIN"),wt&&(Ai.push("PROJECTION_GLOBE_VIEW"),wr&&Ai.push("PROJECTED_POS_ON_VIEWPORT")),tt.text.zOffsetVertexBuffer&&Ai.push("Z_OFFSET"),tt.iconsInText&&Ai.push("RENDER_TEXT_AND_SYMBOL"),Ai.push("RENDER_SDF"),sr&&Ai.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),mi&&tt.text.orientationVertexBuffer&&Ai.push("ELEVATED_ROADS"),Ji(Ai);const Mi=tt.text.programConfigurations.get(n.id),Sr=l.getOrCreateProgram("symbol",{config:Mi,defines:Ai});let tn,dr=[0,0],Ti=null;const kn=tt.textSizeData;tt.iconsInText&&(dr=Fe.imageAtlasTexture?Fe.imageAtlasTexture.size:[0,0],Ti=Fe.imageAtlasTexture?Fe.imageAtlasTexture:null,tn=ve||!K.isOrthographic||l.options.rotating||l.options.zooming||kn.kind==="composite"||kn.kind==="camera"?J.LINEAR:J.NEAREST);const An=Fe.glyphAtlasTexture?Fe.glyphAtlasTexture.size:[0,0],Hn=n.layout.get("text-size-scale-range"),us=o.ay(l.scaleFactor,Hn[0],Hn[1]),ts=o.bH(kn,K.zoom,us),Cn=Ps(gt,Fe.tileID.canonical,ve,se,K,tt.getProjection(),Rt),vo=vc(gt,Fe.tileID.canonical,ve,se,K,tt.getProjection(),Rt),hs=l.translatePosMatrix(vo,Fe,v,S,!0),xo=l.translatePosMatrix(gt,Fe,v,S),Ql=wr?Ds:Cn,Uh=se&&!ve&&!Qi;let qa=qe;!Ne&&!K.mercatorFromTransition||se||(qa=Ol(K));const jh=zl(kn.kind,ts,Uh,ve,l,xo,Ql,hs,te,!0,An,dr,0,rt,Tt,Pe,$t,wt?qa:qe,tt.getProjection(),Wi,ti,null,null,us),ec=Fe.glyphAtlasTexture?Fe.glyphAtlasTexture:null,du=J.LINEAR,fu=n.paint.get("text-halo-width").constantOr(1)!==0,bs=l.terrain&&ve&&Qi?o.bi(o.bz(),Cn):Ds;if(Qi&&tt.text){const $a=K.elevation,ta=$a?$a.getAtTileOffsetFunc(rt,K.center.lat,K.worldSize,tt.getProjection()):null,bo=yc(gt,Fe.tileID.canonical,ve,se,K,tt.getProjection(),Rt);xc(tt,gt,l,!0,bo,vo,ve,O,ta,rt)}return{program:Sr,buffers:tt.text,uniformValues:jh,atlasTexture:ec,atlasTextureIcon:Ti,atlasInterpolation:du,atlasInterpolationIcon:tn,isSDF:!0,hasHalo:fu,depthMode:or,tile:Fe,renderWithShadows:sr,labelPlaneMatrixInv:bs}},Mr=tt.icon.segments.get().length,Kt=tt.text.segments.get().length,ni=Mr&&!m.onlyText?Fi():null,ui=Kt&&!m.onlyIcons?Vi():null,nr=n.paint.get("icon-opacity").constantOr(1),Vr=n.paint.get("text-opacity").constantOr(1);if(Oe&&tt.canOverlap){ke=!0;const Qi=nr&&!m.onlyText?tt.icon.segments.get():[],Ai=Vr&&!m.onlyIcons?tt.text.segments.get():[];for(const wr of Qi)Se.push({segments:new o.bd([wr]),sortKey:wr.sortKey,state:ni});for(const wr of Ai)Se.push({segments:new o.bd([wr]),sortKey:wr.sortKey,state:ui})}else m.onlyText||Se.push({segments:nr?tt.icon.segments:new o.bd([]),sortKey:0,state:ni}),m.onlyIcons||Se.push({segments:Vr?tt.text.segments:new o.bd([]),sortKey:0,state:ui})}ke&&Se.sort((rt,Fe)=>rt.sortKey-Fe.sortKey);for(const rt of Se){const Fe=rt.state;if(Fe)if(l.terrain?l.terrain.setupElevationDraw(Fe.tile,Fe.program,{useDepthForOcclusion:K.depthOcclusionForSymbolsAndCircles,labelPlaneMatrixInv:Fe.labelPlaneMatrixInv}):l.setupDepthForOcclusion(K.depthOcclusionForSymbolsAndCircles,Fe.program),ee.activeTexture.set(J.TEXTURE0),Fe.atlasTexture&&Fe.atlasTexture.bind(Fe.atlasInterpolation,J.CLAMP_TO_EDGE,!0),Fe.atlasTextureIcon&&(ee.activeTexture.set(J.TEXTURE1),Fe.atlasTextureIcon&&Fe.atlasTextureIcon.bind(Fe.atlasInterpolationIcon,J.CLAMP_TO_EDGE,!0)),Fe.renderWithShadows&&l.shadowRenderer.setupShadows(Fe.tile.tileID.toUnwrapped(),Fe.program,"vector-tile",Fe.tile.tileID.overscaledZ),l.uploadCommonLightUniforms(l.context,Fe.program),Fe.hasHalo){const tt=Fe.uniformValues;tt.u_is_halo=1,Ra(Fe.buffers,rt.segments,n,l,Fe.program,Fe.depthMode,d,f,tt,2),tt.u_is_halo=0}else{if(Fe.isSDF){const tt=Fe.uniformValues;Fe.hasHalo&&(tt.u_is_halo=1,Ra(Fe.buffers,rt.segments,n,l,Fe.program,Fe.depthMode,d,f,tt,1)),tt.u_is_halo=0}Ra(Fe.buffers,rt.segments,n,l,Fe.program,Fe.depthMode,d,f,Fe.uniformValues,1)}}}function Ra(l,t,n,c,d,f,m,y,v,T){const S=[l.dynamicLayoutVertexBuffer,l.opacityVertexBuffer,l.iconTransitioningVertexBuffer,l.globeExtVertexBuffer,l.zOffsetVertexBuffer,l.orientationVertexBuffer];d.draw(c,c.context.gl.TRIANGLES,f,m,y,Nt.disabled,v,n.id,l.layoutVertexBuffer,l.indexBuffer,t,n.paint,c.transform.zoom,l.programConfigurations.get(n.id),S,T)}function Wc(l,t){const n=1<<l.canonical.z,c=(t.x*n-l.canonical.x-l.wrap*n)*o.aj,d=(t.y*n-l.canonical.y)*o.aj,f=o.dS(t.z,t.y);return o.cS(c,d,f)}function yh(l,t,n,c,d){if(!n.layout||n.layout.get("fill-elevation-reference")==="none")return;const f=l.context.gl,m=new xt(l.context.gl.LEQUAL,xt.ReadWrite,l.depthRangeFor3D),y=new xt(l.context.gl.GREATER,xt.ReadWrite,l.depthRangeFor3D),v=function(M){const D=o.cJ(M.pitch);let z=.01;return M.isOrthographic&&(z=o.ai(1e-4,z,o.cN(D>=Yr?1:D/Yr))),2*z}(l.transform),T=l.transform.getFreeCameraOptions().position,S="elevatedStructuresDepthReconstruct",C=l.getOrCreateProgram(S,{defines:["DEPTH_RECONSTRUCTION"]}),I=l.getOrCreateProgram(S);for(const M of c){const D=t.getTile(M),z=D.getBucket(n);if(!z)continue;const O=z.elevatedStructures;if(!O)continue;const B=z.elevationBufferData.heightRange,V=Wc(M.toUnwrapped(),T),H=l.translatePosMatrix(M.projMatrix,D,n.paint.get("fill-translate"),n.paint.get("fill-translate-anchor"));let Y,te,ee,J;if(d==="initialize"){if(!B||B.min>=1||O.depthSegments.segments[0].primitiveLength===0)continue;Y=qc(H,V,v,1,0),te=m,ee=O.depthSegments,J=C}else if(d==="reset"){if(!B||B.min>=0||O.maskSegments.segments[0].primitiveLength===0)continue;Y=qc(H,V,0,0,1),te=y,ee=O.maskSegments,J=C}else if(d==="geometry"){if(O.depthSegments.segments[0].primitiveLength===0)continue;Y=qc(H,V,v,1,0),te=m,ee=O.depthSegments,J=I}J.draw(l,f.TRIANGLES,te,Zt.disabled,oi.disabled,Nt.disabled,Y,n.id,O.vertexBuffer,O.indexBuffer,ee,n.paint,l.transform.zoom)}}function vh(l,t,n){const{painter:c,sourceCache:d,layer:f,coords:m,colorMode:y,elevationType:v,terrainEnabled:T,pass:S}=l,C=c.context.gl,I=f.paint.get("fill-pattern"),M=f.paint.get("fill-pattern-cross-fade"),D=I.constantOr(null);let z=v;v!=="road"||t&&!T||(z="none");const O=z==="road",B=l.painter.shadowRenderer,V=O&&!!B&&B.enabled,H=new xt(c.context.gl.LEQUAL,xt.ReadOnly,c.depthRangeFor3D);let Y=[0,0,0];if(V){const J=c.style.directionalLight,K=c.style.ambientLight;J&&K&&(Y=jo(c.style,J,K))}const te=I&&I.constantOr(1),ee=(J,K)=>{let ie,se,ye,ve,Oe;K?(ie=te&&!f.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",ye=C.LINES):(ie=te?"fillPattern":"fill",ye=C.TRIANGLES);for(const ke of m){const Ze=d.getTile(ke);if(te&&!Ze.patternsLoaded())continue;const _e=Ze.getBucket(f);if(!_e)continue;const Pe=t?_e.elevationBufferData:_e.bufferData;if(Pe.isEmpty())continue;c.prepareDrawTile();const ue=Pe.programConfigurations.get(f.id),Ne=c.isTileAffectedByFog(ke),Se=[],qe=[];O&&(Se.push("ELEVATED_ROADS"),qe.push(Pe.elevatedLayoutVertexBuffer)),V&&Se.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),te&&(c.context.activeTexture.set(C.TEXTURE0),Ze.imageAtlasTexture&&Ze.imageAtlasTexture.bind(C.LINEAR,C.CLAMP_TO_EDGE),ue.updatePaintBuffers());let rt=!1;if(D&&Ze.imageAtlas){const gt=Ze.imageAtlas,Rt=o.dN.from(D),Dt=Rt.getPrimary().scaleSelf(o.q.devicePixelRatio).toString(),kt=Rt.getSecondary(),$t=gt.patternPositions.get(Dt),ti=kt?gt.patternPositions.get(kt.scaleSelf(o.q.devicePixelRatio).toString()):null;rt=!!$t&&!!ti,$t&&ue.setConstantPatternPositions($t,ti)}M>0&&(rt||ue.getPatternTransitionVertexBuffer("fill-pattern"))&&Se.push("FILL_PATTERN_TRANSITION");const Fe=c.getOrCreateProgram(ie,{config:ue,overrideFog:Ne,defines:Se}),tt=c.translatePosMatrix(ke.projMatrix,Ze,f.paint.get("fill-translate"),f.paint.get("fill-translate-anchor"));V&&B.setupShadows(Ze.tileID.toUnwrapped(),Fe,"vector-tile",Ze.tileID.overscaledZ);const wt=f.paint.get("fill-emissive-strength");if(K){ve=Pe.lineIndexBuffer,Oe=Pe.lineSegments;const gt=c.terrain&&c.terrain.renderingToTexture?c.terrain.drapeBufferSize:[C.drawingBufferWidth,C.drawingBufferHeight];se=ie==="fillOutlinePattern"&&te?Qp(tt,wt,c,Ze,gt,Y,M):Jp(tt,wt,gt,Y)}else ve=Pe.indexBuffer,Oe=Pe.triangleSegments,se=te?Xd(tt,wt,c,Ze,Y,M):Zo(tt,wt,Y);c.uploadCommonUniforms(c.context,Fe,ke.toUnwrapped());let Tt=J;(v==="road"&&!T||v==="offset")&&(Tt=H),Fe.draw(c,ye,Tt,n||c.stencilModeForClipping(ke),y,Nt.disabled,se,f.id,Pe.layoutVertexBuffer,ve,Oe,f.paint,c.transform.zoom,ue,qe)}};c.renderPass===S&&ee(c.depthModeForSublayer(1,c.renderPass==="opaque"?xt.ReadWrite:xt.ReadOnly),!1),z==="none"&&c.renderPass==="translucent"&&f.paint.get("fill-antialias")&&ee(c.depthModeForSublayer(f.getPaintProperty("fill-outline-color")?2:0,xt.ReadOnly),!0)}function Os(l,t,n,c,d,f,m,y){n.resetLayerRenderingStats(l);const v=l.context,T=v.gl,S=l.transform,C=n.paint.get("fill-extrusion-pattern"),I=n.paint.get("fill-extrusion-pattern-cross-fade"),M=C.constantOr(null),D=C.constantOr(1),z=n.paint.get("fill-extrusion-opacity"),O=l.style.enable3dLights(),B=n.paint.get(O&&!D?"fill-extrusion-ambient-occlusion-wall-radius":"fill-extrusion-ambient-occlusion-radius"),V=[n.paint.get("fill-extrusion-ambient-occlusion-intensity"),B],H=n.layout.get("fill-extrusion-edge-radius"),Y=H>0&&!n.paint.get("fill-extrusion-rounded-roof"),te=Y?0:H,ee=S.projection.name==="globe"?o.dV():0,J=S.projection.name==="globe",K=J?o.ah(S.zoom):0,ie=[o.aD(S.center.lng),o.aH(S.center.lat)],se=n.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default")==="none",ye=n.paint.get("fill-extrusion-flood-light-color").toNonPremultipliedRenderColor(se?null:n.lut).toArray01().slice(0,3),ve=n.paint.get("fill-extrusion-flood-light-intensity"),Oe=n.paint.get("fill-extrusion-vertical-scale"),ke=n.paint.get("fill-extrusion-line-width").constantOr(1)!==0,Ze=n.paint.get("fill-extrusion-height-alignment"),_e=n.paint.get("fill-extrusion-base-alignment"),Pe=_s(l,n.paint.get("fill-extrusion-cutoff-fade-range")),ue=[];let Ne;J&&ue.push("PROJECTION_GLOBE_VIEW"),V[0]>0&&ue.push("FAUX_AO"),Y&&ue.push("ZERO_ROOF_RADIUS"),y&&ue.push("HAS_CENTROID"),ve>0&&ue.push("FLOOD_LIGHT"),Pe.shouldRenderCutoff&&ue.push("RENDER_CUTOFF"),ke&&ue.push("RENDER_WALL_MODE");const Se=l.renderPass==="shadow",qe=l.shadowRenderer,rt=Se&&!!qe,Fe=Se?Nt.disabled:Nt.backCCW;l.shadowRenderer&&(l.shadowRenderer.useNormalOffset=!0);let tt=[0,0,0];if(qe){const gt=l.style.directionalLight,Rt=l.style.ambientLight;gt&&Rt&&(tt=jo(l.style,gt,Rt)),Se||(ue.push("RENDER_SHADOWS","DEPTH_TEXTURE"),qe.useNormalOffset&&ue.push("NORMAL_OFFSET")),Ne=ue.concat(["SHADOWS_SINGLE_CASCADE"])}const wt=rt?"fillExtrusionDepth":D?"fillExtrusionPattern":"fillExtrusion",Tt=n.getLayerRenderingStats();for(const gt of c){const Rt=t.getTile(gt),Dt=Rt.getBucket(n);if(!Dt||Dt.projection.name!==S.projection.name)continue;let kt=!1;qe&&(kt=qe.getMaxCascadeForTile(gt.toUnwrapped())===0);const $t=l.isTileAffectedByFog(gt),ti=Dt.programConfigurations.get(n.id);let zi=!1;if(M&&Rt.imageAtlas){const ui=Rt.imageAtlas,nr=o.dN.from(M),Vr=nr.getPrimary().scaleSelf(o.q.devicePixelRatio).toString(),Qi=nr.getSecondary(),Ai=ui.patternPositions.get(Vr),wr=Qi?ui.patternPositions.get(Qi.scaleSelf(o.q.devicePixelRatio).toString()):null;zi=!!Ai&&!!wr,Ai&&ti.setConstantPatternPositions(Ai,wr)}I>0&&(zi||ti.getPatternTransitionVertexBuffer("fill-extrusion-pattern"))&&ue.push("FILL_EXTRUSION_PATTERN_TRANSITION");const Ji=l.getOrCreateProgram(wt,{config:ti,defines:kt?Ne:ue,overrideFog:$t});if(l.terrain&&l.terrain.setupElevationDraw(Rt,Ji,{useMeterToDem:!0}),!Dt.centroidVertexBuffer){const ui=Ji.attributes.a_centroid_pos;ui!==void 0&&T.vertexAttrib2f(ui,0,0)}!Se&&qe&&qe.setupShadows(Rt.tileID.toUnwrapped(),Ji,"vector-tile",Rt.tileID.overscaledZ),D&&(l.context.activeTexture.set(T.TEXTURE0),Rt.imageAtlasTexture&&Rt.imageAtlasTexture.bind(T.LINEAR,T.CLAMP_TO_EDGE),ti.updatePaintBuffers());const Fi=n.paint.get("fill-extrusion-vertical-gradient"),Vi=1/Dt.tileToMeter;let Mr;if(Se&&qe){if(ho(Rt.tileID,Dt,l))continue;const ui=qe.calculateShadowPassMatrixFromTile(Rt.tileID.toUnwrapped());Mr=Zd(ui,te,Vi,Oe,Ze,_e)}else{const ui=l.translatePosMatrix(gt.expandedProjMatrix,Rt,n.paint.get("fill-extrusion-translate"),n.paint.get("fill-extrusion-translate-anchor")),nr=S.projection.createInversionMatrix(S,gt.canonical);Mr=D?Wd(ui,l,Fi,z,V,te,Vi,gt,Rt,ee,Ze,_e,K,ie,nr,ye,Oe,I):Rl(ui,l,Fi,z,V,te,Vi,gt,ee,Ze,_e,K,ie,nr,ye,Oe,ve,tt)}l.uploadCommonUniforms(v,Ji,gt.toUnwrapped(),null,Pe);let Kt=Dt.segments;if(S.projection.name==="mercator"&&!Se&&(Kt=Dt.getVisibleSegments(Rt.tileID,l.terrain,l.transform.getFrustum(0)),!Kt.get().length))continue;if(Tt)if(Se)for(const ui of Kt.get())Tt.numRenderedVerticesInShadowPass+=ui.primitiveLength;else for(const ui of Kt.get())Tt.numRenderedVerticesInTransparentPass+=ui.primitiveLength;const ni=[];(l.terrain||y)&&ni.push(Dt.centroidVertexBuffer),J&&ni.push(Dt.layoutVertexExtBuffer),ke&&ni.push(Dt.wallVertexBuffer),Ji.draw(l,v.gl.TRIANGLES,d,f,m,Fe,Mr,n.id,Dt.layoutVertexBuffer,Dt.indexBuffer,Kt,n.paint,l.transform.zoom,ti,ni)}l.shadowRenderer&&(l.shadowRenderer.useNormalOffset=!1)}function ks(l,t,n,c,d,f,m,y,v,T,S,C,I,M,D,z,O,B,V){const H=l.context,Y=H.gl,te=l.transform,ee=l.transform.zoom,J=[],K=_s(l,n.paint.get("fill-extrusion-cutoff-fade-range"));T==="clear"?(J.push("CLEAR_SUBPASS"),V&&(J.push("CLEAR_FROM_TEXTURE"),H.activeTexture.set(Y.TEXTURE0),V.bind(Y.LINEAR,Y.CLAMP_TO_EDGE))):T==="sdf"&&J.push("SDF_SUBPASS"),O&&J.push("HAS_CENTROID"),K.shouldRenderCutoff&&J.push("RENDER_CUTOFF");const ie=n.layout.get("fill-extrusion-edge-radius"),se=(ye,ve,Oe,ke,Ze)=>{const _e=ve.programConfigurations.get(n.id),Pe=l.isTileAffectedByFog(ye),ue=l.getOrCreateProgram("fillExtrusionGroundEffect",{config:_e,defines:J,overrideFog:Pe}),Ne=((qe,rt,Fe,tt,wt,Tt,gt,Rt,Dt,kt,$t)=>({u_matrix:rt,u_opacity:Fe,u_ao_pass:tt?1:0,u_meter_to_tile:wt,u_ao:Tt,u_flood_light_intensity:gt,u_flood_light_color:Rt,u_attenuation:Dt,u_edge_radius:kt,u_fb:0,u_fb_size:$t,u_dynamic_offset:1}))(0,ke,S,v,Ze,[C,I*Ze],M,D,z,ee>=17?0:ie*Ze,V?V.size[0]:0),Se=[];O&&Se.push(ve.hiddenByLandmarkVertexBuffer),l.uploadCommonUniforms(H,ue,ye.toUnwrapped(),null,K),ue.draw(l,H.gl.TRIANGLES,d,f,m,y,Ne,n.id,ve.vertexBuffer,ve.indexBuffer,Oe,n.paint,ee,_e,Se)};for(const ye of c){const ve=t.getTile(ye),Oe=ve.getBucket(n);if(!Oe||Oe.projection.name!==te.projection.name||!Oe.groundEffect||Oe.groundEffect&&!Oe.groundEffect.hasData())continue;const ke=Oe.groundEffect,Ze=1/Oe.tileToMeter;{const _e=l.translatePosMatrix(ye.projMatrix,ve,n.paint.get("fill-extrusion-translate"),n.paint.get("fill-extrusion-translate-anchor")),Pe=ke.getDefaultSegment();se(ye,ke,Pe,_e,Ze)}if(B)for(let _e=0;_e<4;_e++){const Pe=o.dT[_e](ye),ue=t.getTile(Pe);if(!ue)continue;const Ne=ue.getBucket(n);if(!Ne||Ne.projection.name!==te.projection.name||!Ne.groundEffect||Ne.groundEffect&&!Ne.groundEffect.hasData())continue;const Se=Ne.groundEffect;let qe,rt;_e===0?(qe=[-8192,0,0],rt=1):_e===1?(qe=[o.aj,0,0],rt=0):_e===2?(qe=[0,-8192,0],rt=3):(qe=[0,o.aj,0],rt=2);const Fe=Se.regionSegments[rt];if(!Fe)continue;const tt=new Float32Array(16);o.bo(tt,ye.projMatrix,qe),se(ye,Se,Fe,l.translatePosMatrix(tt,ve,n.paint.get("fill-extrusion-translate"),n.paint.get("fill-extrusion-translate-anchor")),Ze)}}}function bt(l,t,n,c,d,f,m){c.centroidVertexArray.length===0&&c.createCentroidsBuffer();const y=f?f.findDEMTileFor(n):null;if(!(y&&y.dem||m))return;f&&y&&y.dem&&c.selfDEMTileTimestamp!==y.dem._timestamp&&(c.borderDoneWithNeighborZ=[-1,-1,-1,-1],c.selfDEMTileTimestamp=y.dem._timestamp);const v=B=>new o.P(Math.ceil((B+o.dX)*o.dY),0),T=B=>{const V=t.getSource().minzoom,H=te=>{const ee=t.getTileByID(te);if(ee&&ee.hasData())return ee.getBucket(d)},Y=[0,-1,1];for(const te of Y){if(B.overscaledZ+te<V)continue;const ee=H(B.calculateScaledKey(B.overscaledZ+te));if(ee)return ee}},S=[0,0,0],C=(B,V)=>(S[0]=Math.min(B.min.y,V.min.y),S[1]=Math.max(B.max.y,V.max.y),S[2]=o.aj-V.min.x>B.max.x?V.min.x-o.aj:B.max.x,S),I=(B,V)=>(S[0]=Math.min(B.min.x,V.min.x),S[1]=Math.max(B.max.x,V.max.x),S[2]=o.aj-V.min.y>B.max.y?V.min.y-o.aj:B.max.y,S),M=[(B,V)=>C(B,V),(B,V)=>C(V,B),(B,V)=>I(B,V),(B,V)=>I(V,B)],D=(B,V,H,Y,te,ee,J)=>{if(!f)return 0;const K=[[ee?H:B,ee?B:H,0],[ee?H:V,ee?V:H,0]],ie=J<0?o.aj+J:J,se=[ee?ie:(B+V)/2,ee?(B+V)/2:ie,0];return H===0&&J<0||H!==0&&J>0?f.getForTilePoints(te,[se],!0,Y):K.push(se),f.getForTilePoints(n,K,!0,y),Math.max(K[0][2],K[1][2],se[2])/f.exaggeration()};for(let B=0;B<4;B++){const V=c.borderFeatureIndices[B];if(V.length===0)continue;const H=o.dT[B](n),Y=T(H);if(!(Y&&Y instanceof o.dU))continue;const te=f?f.findDEMTileFor(H):null;if(!(te&&te.dem||m)||(f&&te&&te.dem&&c.borderDEMTileTimestamp[B]!==te.dem._timestamp&&(c.borderDoneWithNeighborZ[B]=-1,c.borderDEMTileTimestamp[B]=te.dem._timestamp),c.borderDoneWithNeighborZ[B]===Y.canonical.z))continue;Y.centroidVertexArray.length===0&&Y.createCentroidsBuffer();const ee=(B<2?1:5)-B,J=Y.borderDoneWithNeighborZ[ee]!==c.canonical.z,K=Y.borderFeatureIndices[ee];let ie=0;if(c.canonical.z!==Y.canonical.z){for(const se of V)c.showCentroid(c.featuresOnBorder[se]);if(J)for(const se of K)Y.showCentroid(Y.featuresOnBorder[se]);c.borderDoneWithNeighborZ[B]=Y.canonical.z,Y.borderDoneWithNeighborZ[ee]=c.canonical.z}for(const se of V){const ye=c.featuresOnBorder[se],ve=c.centroidData[ye.centroidDataIndex],Oe=ye.borders[B];let ke;for(;ie<K.length;){ke=Y.featuresOnBorder[K[ie]];const Ze=ke.borders[ee];if(Ze[1]>Oe[0]+3||Ze[0]>Oe[0]-3)break;Y.showCentroid(ke),ie++}if(ke&&ie<K.length){const Ze=ie;let _e=0;for(;!(ke.borders[ee][0]>Oe[1]-3)&&(_e++,++ie!==K.length);)ke=Y.featuresOnBorder[K[ie]];ke=Y.featuresOnBorder[K[Ze]];let Pe=!1;if(_e>=1){const Se=ke.borders[ee];Math.abs(Oe[0]-Se[0])<3&&Math.abs(Oe[1]-Se[1])<3&&(_e=1,Pe=!0,ie=Ze+1)}else if(_e===0){c.showCentroid(ye);continue}const ue=Y.centroidData[ke.centroidDataIndex];m&&Pe&&(((z=ve).flags|(O=ue).flags)&o.dW?(z.flags|=o.dW,O.flags|=o.dW):(z.flags&=2147483647,O.flags&=2147483647));const Ne=ye.intersectsCount()>1||ke.intersectsCount()>1;if(_e>1)ie=Ze,ve.centroidXY=ue.centroidXY=new o.P(0,0);else if(te&&te.dem&&!Ne){const Se=M[B](ve,ue),qe=B%2?o.aj-1:0,rt=D(Se[0],Math.min(o.aj-1,Se[1]),qe,te,H,B<2,Se[2]);ve.centroidXY=ue.centroidXY=v(rt)}else Ne?ve.centroidXY=ue.centroidXY=new o.P(0,0):(ve.centroidXY=c.encodeBorderCentroid(ye),ue.centroidXY=Y.encodeBorderCentroid(ke));c.writeCentroidToBuffer(ve),Y.writeCentroidToBuffer(ue)}else c.showCentroid(ye)}c.borderDoneWithNeighborZ[B]=Y.canonical.z,Y.borderDoneWithNeighborZ[ee]=c.canonical.z}var z,O;(c.needsCentroidUpdate||!c.centroidVertexBuffer&&c.centroidVertexArray.length!==0)&&c.uploadCentroid(l)}const rf=[1,0,0],nf=[0,1,0],uo=[0,0,1];function ho(l,t,n){const c=n.transform,d=n.shadowRenderer;if(!d)return!0;const f=l.toUnwrapped(),m=c.tileSize*d._cascades[n.currentShadowCascade].scale;let y=t.maxHeight;if(c.elevation){const z=c.elevation.getMinMaxForTile(l);z&&(y+=z.max)}const v=[...d.shadowDirection];v[2]=-v[2];const T=d.computeSimplifiedTileShadowVolume(f,y,m,v);if(!T)return!1;const S=[rf,nf,uo,v,[v[0],0,v[2]],[0,v[1],v[2]]],C=c.projection.name==="globe",I=c.scaleZoom(m),M=o.cn.fromInvProjectionMatrix(c.invProjMatrix,c.worldSize,I,!C),D=d.getCurrentCascadeFrustum();return M.intersectsPrecise(T.vertices,T.planes,S)===0||D.intersectsPrecise(T.vertices,T.planes,S)===0}function Ft(l){return[l[0]*o.dZ,l[1]*o.dZ,l[2]*o.dZ,0]}function Fl(l,t,n,c,d,f,m,y,v){const T=c.getSource(),S=n.globeSharedBuffers;if(!S)return;let C,I,M;if(t&&(C=c.getTile(t)),T instanceof o.aP?(I=T.texture,M=o.ds(0,0,n.transform)):C&&t&&(I=C.texture,M=o.ds(t.canonical.z,t.canonical.x,n.transform)),!I||!M)return;l||(M=o.cE(o.bz(),M,[1,-1,1]));const D=n.context,z=D.gl,O=d.paint.get("raster-resampling")==="nearest"?z.NEAREST:z.LINEAR,B=n.colorModeForDrapableLayerRenderPass(f),V=m.defines;V.push("GLOBE_POLES");const H=new xt(z.LEQUAL,xt.ReadWrite,n.depthRangeFor3D),Y=Float32Array.from(n.transform.expandedFarZProjMatrix),te=Float32Array.from(o.bh(o.dr(new o.cp(0,0,0))));n.terrain&&n.terrain.prepareDrawTile(),D.activeTexture.set(z.TEXTURE0),I.bind(O,z.CLAMP_TO_EDGE),D.activeTexture.set(z.TEXTURE1),I.bind(O,z.CLAMP_TO_EDGE),"useMipmap"in I&&D.extTextureFilterAnisotropic&&n.transform.pitch>20&&z.texParameterf(z.TEXTURE_2D,D.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,D.extTextureFilterAnisotropicMax);const[ee,J,K,ie]=t?S.getPoleBuffers(t.canonical.z,!1):S.getPoleBuffers(0,!0),se=d.paint.get("raster-elevation");let ye;l?(ye=ee,n.renderDefaultNorthPole=se!==0):(ye=J,n.renderDefaultSouthPole=se!==0);const ve=Ft(m.mix),Oe=((Ze,_e,Pe,ue,Ne,Se,qe,rt,Fe,tt,wt,Tt,gt)=>ph(Ze,_e,Pe,new Float32Array(16),new Float32Array(9),[0,0],ue,[0,0],[0,0,0,0],1,{opacity:1,mix:0},Se,[0,0],rt,2,tt,wt,Tt,1,0,gt))(Y,te,M,o.ah(n.transform.zoom),0,d,0,se,0,ve,m.offset,m.range,f),ke=n.getOrCreateProgram("raster",{defines:V});n.uploadCommonUniforms(D,ke,null),ke.draw(n,z.TRIANGLES,H,v,B,y,Oe,d.id,ye,K,ie)}function sm(l){const t=l._nearZ,n=l.projection.farthestPixelDistance(l),c=n-t,d=.2*l.height,f=t+d;return[t,n,(f-d-t)/c,(f-t)/c]}function om(l,t,n,c){if(l)return t instanceof to&&l instanceof ua?t.getTextureDescriptor(l,n,!0):{texture:l.texture,mix:Ft(c.mix),offset:c.offset,buffer:0,tileSize:1}}var xh=o.d_([{name:"a_index",type:"Int16",components:1}]);class sf{constructor(t,n,c,d){const f={width:c[0],height:c[1],data:null},m=t.gl;this.targetColorTexture=new o.T(t,f,m.RGBA8,{useMipmap:!1}),this.backgroundColorTexture=new o.T(t,f,m.RGBA8,{useMipmap:!1}),this.context=t,this.updateParticleTexture(n,d),this.lastInvalidatedAt=0}updateParticleTexture(t,n){if(this.particleTextureDimension===n.width)return;(this.particleTexture0||this.particleTexture1||this.particleIndexBuffer||this.particleSegment)&&(this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleIndexBuffer.destroy(),this.particleSegment.destroy());const c=this.context.gl,d=n.width*n.height;this.particleTexture0=new o.T(this.context,n,c.RGBA8,{premultiply:!1,useMipmap:!1}),this.particleTexture1=new o.T(this.context,n,c.RGBA8,{premultiply:!1,useMipmap:!1});const f=new o.d$;f.reserve(d);for(let m=0;m<d;m++)f.emplaceBack(m);this.particleIndexBuffer=this.context.createVertexBuffer(f,xh.members,!0),this.particleSegment=o.bd.simpleSegment(0,0,this.particleIndexBuffer.length,0),this.particleTextureDimension=n.width}update(t){return!(this.lastInvalidatedAt<t&&(this.lastInvalidatedAt=o.q.now(),1))}destroy(){this.targetColorTexture.destroy(),this.backgroundColorTexture.destroy(),this.particleIndexBuffer.destroy(),this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleSegment.destroy()}}function am(l,t,n){if(!l)return null;const c=t.getTextureDescriptor(l,n,!0);if(!c)return null;let{texture:d,mix:f,offset:m,tileSize:y,buffer:v,format:T}=c;if(!d||!T)return null;let S=!1;return T==="uint32"&&(S=!0,f[3]=0,f=Wo(o.e0,f,[0,n.paint.get("raster-particle-max-speed")]),m=fh(o.e0,m,[0,n.paint.get("raster-particle-max-speed")])),{texture:d,textureOffset:[v/(y+2*v),y/(y+2*v)],tileSize:y,scalarData:S,scale:f,offset:m,defines:["RASTER_ARRAY",{uint8:"DATA_FORMAT_UINT8",uint16:"DATA_FORMAT_UINT16",uint32:"DATA_FORMAT_UINT32"}[T]]}}function of(l){const t=l._nearZ,n=l.projection.farthestPixelDistance(l),c=n-t,d=.2*l.height,f=t+d;return[t,n,(f-d-t)/c,(f-t)/c]}const lm=new o.am(1,0,0,1),cm=new o.am(0,1,0,1),On=new o.am(0,0,1,1),bh=new o.am(1,0,1,1),bn=new o.am(0,1,1,1);function Fs(l,t,n,c,d,f){for(let m=0;m<n.length;m++)if(d){const T=new o.am(c.r*.8,c.g*.8,c.b*.8,1);Yo(l,t,n[m],c,-1,-1,f),Yo(l,t,n[m],c,-1,1,f),Yo(l,t,n[m],c,1,1,f),Yo(l,t,n[m],c,1,-1,f),Yo(l,t,n[m],T,0,0,f)}else Yo(l,t,n[m],c,0,0,f)}function Yo(l,t,n,c,d,f,m){const y=l.context,v=l.transform,T=y.gl,S=v.projection.name==="globe",C=S?["PROJECTION_GLOBE_VIEW"]:[];let I=o.bw(n.projMatrix);if(S&&o.ah(v.zoom)>0){const ve=o.bg(n.canonical,v),Oe=o.e1(ve);I=o.az(new Float32Array(16),v.globeMatrix,Oe),o.az(I,v.projMatrix,I)}const M=o.bz();M[12]+=2*d/(o.q.devicePixelRatio*v.width),M[13]+=2*f/(o.q.devicePixelRatio*v.height),o.az(I,M,I);const D=l.getOrCreateProgram("debug",{defines:C}),z=t.getTileByID(n.key);l.terrain&&l.terrain.setupElevationDraw(z,D);const O=xt.disabled,B=Zt.disabled,V=l.colorModeForRenderPass(),H="$debug";y.activeTexture.set(T.TEXTURE0),l.emptyTexture.bind(T.LINEAR,T.CLAMP_TO_EDGE),S?z._makeGlobeTileDebugBuffers(l.context,v):z._makeDebugTileBoundsBuffers(l.context,v.projection);const Y=z._tileDebugBuffer||l.debugBuffer,te=z._tileDebugIndexBuffer||l.debugIndexBuffer,ee=z._tileDebugSegments||l.debugSegments;if(D.draw(l,T.LINE_STRIP,O,B,V,Nt.disabled,$c(I,c.toPremultipliedRenderColor(null)),H,Y,te,ee,null,null,null,[z._globeTileDebugBorderBuffer]),m){const ve=z.latestRawTileData,Oe=Math.floor((ve&&ve.byteLength||0)/1024);let ke=n.canonical.toString();n.overscaledZ!==n.canonical.z&&(ke+=` => ${n.overscaledZ}`),ke+=` ${z.state}`,ke+=` ${Oe}kb`,function(Ze,_e){Ze.initDebugOverlayCanvas();const Pe=Ze.debugOverlayCanvas,ue=Ze.context.gl,Ne=Ze.debugOverlayCanvas.getContext("2d");Ne.clearRect(0,0,Pe.width,Pe.height),Ne.shadowColor="white",Ne.shadowBlur=2,Ne.lineWidth=1.5,Ne.strokeStyle="white",Ne.textBaseline="top",Ne.font="bold 36px Open Sans, sans-serif",Ne.fillText(_e,5,5),Ne.strokeText(_e,5,5),Ze.debugOverlayTexture.update(Pe),Ze.debugOverlayTexture.bind(ue.LINEAR,ue.CLAMP_TO_EDGE)}(l,ke)}const J=t.getTile(n).tileSize,K=512/Math.min(J,512)*(n.overscaledZ/v.zoom)*.5,ie=z._tileDebugTextBuffer||l.debugBuffer,se=z._tileDebugTextIndexBuffer||l.quadTriangleIndexBuffer,ye=z._tileDebugTextSegments||l.debugSegments;D.draw(l,T.TRIANGLES,O,B,oi.alphaBlended,Nt.disabled,$c(I,o.am.transparent.toPremultipliedRenderColor(null),K),H,ie,se,ye,null,null,null,[z._globeTileDebugTextBuffer])}function Xc(l,t,n,c){za(l,0,t+n/2,l.transform.width,n,c)}function Yc(l,t,n,c){za(l,t-n/2,0,n,l.transform.height,c)}function za(l,t,n,c,d,f){const m=l.context,y=m.gl;y.enable(y.SCISSOR_TEST),y.scissor(t*o.q.devicePixelRatio,n*o.q.devicePixelRatio,c*o.q.devicePixelRatio,d*o.q.devicePixelRatio),m.clear({color:f}),y.disable(y.SCISSOR_TEST)}const af=o.d_([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:Bs}=af;function Gi(l,t,n,c){l.emplaceBack(t,n,c)}class Bl{constructor(t){this.vertexArray=new o.e2,this.indices=new o.a_,Gi(this.vertexArray,-1,-1,1),Gi(this.vertexArray,1,-1,1),Gi(this.vertexArray,-1,1,1),Gi(this.vertexArray,1,1,1),Gi(this.vertexArray,-1,-1,-1),Gi(this.vertexArray,1,-1,-1),Gi(this.vertexArray,-1,1,-1),Gi(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=t.createVertexBuffer(this.vertexArray,Bs),this.indexBuffer=t.createIndexBuffer(this.indices),this.segment=o.bd.simpleSegment(0,0,36,12)}}function fo(l,t,n,c,d,f){const m=l.context.gl,y=t.paint.get("sky-atmosphere-color"),v=t.paint.get("sky-atmosphere-halo-color"),T=t.paint.get("sky-atmosphere-sun-intensity"),S=((C,I,M,D,z)=>({u_matrix_3f:C,u_sun_direction:I,u_sun_intensity:M,u_color_tint_r:[D.r,D.g,D.b,D.a],u_color_tint_m:[z.r,z.g,z.b,z.a],u_luminance:5e-5}))(o.e4(o.dx(),c),d,T,y.toPremultipliedRenderColor(null),v.toPremultipliedRenderColor(null));m.framebufferTexture2D(m.FRAMEBUFFER,m.COLOR_ATTACHMENT0,m.TEXTURE_CUBE_MAP_POSITIVE_X+f,t.skyboxTexture,0),n.draw(l,m.TRIANGLES,xt.disabled,Zt.disabled,oi.unblended,Nt.frontCW,S,"skyboxCapture",t.skyboxGeometry.vertexBuffer,t.skyboxGeometry.indexBuffer,t.skyboxGeometry.segment)}const lf=o.d_([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class cf{constructor(t){const n=new o.e5;n.emplaceBack(-1,1,1,0,0),n.emplaceBack(1,1,1,1,0),n.emplaceBack(1,-1,1,1,1),n.emplaceBack(-1,-1,1,0,1);const c=new o.a_;c.emplaceBack(0,1,2),c.emplaceBack(2,3,0),this.vertexBuffer=t.createVertexBuffer(n,lf.members),this.indexBuffer=t.createIndexBuffer(c),this.segments=o.bd.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}const uf=o.d_([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_size_scale",components:1},{type:"Float32",name:"a_fade_opacity",components:1}]);class um{constructor(){this.starsCount=16e3,this.sizeMultiplier=.15,this.sizeRange=100,this.intensityRange=200}}class La{constructor(t){this.colorModeAlphaBlendedWriteRGB=new oi([1,Uo,1,Uo],o.am.transparent,[!0,!0,!0,!1]),this.colorModeWriteAlpha=new oi([1,0,1,0],o.am.transparent,[!1,!1,!1,!0]),this.params=new um,this.updateNeeded=!0,t.tp.registerParameter(this.params,["Stars"],"starsCount",{min:100,max:16e3,step:1},()=>{this.updateNeeded=!0}),t.tp.registerParameter(this.params,["Stars"],"sizeMultiplier",{min:.01,max:2,step:.01}),t.tp.registerParameter(this.params,["Stars"],"sizeRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0}),t.tp.registerParameter(this.params,["Stars"],"intensityRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0})}update(t){const n=t.context;if(!this.atmosphereBuffer||this.updateNeeded){this.updateNeeded=!1,this.atmosphereBuffer=new cf(n);const c=this.params.sizeRange,d=this.params.intensityRange,f=function(S){const C=o.e7(30),I=[];for(let M=0;M<S;++M){const D=2*Math.PI*C(),z=Math.acos(1-2*C())-.5*Math.PI;I.push(o.cS(Math.cos(z)*Math.cos(D),Math.cos(z)*Math.sin(D),Math.sin(z)))}return I}(this.params.starsCount),m=o.e7(300),y=new o.e6,v=new o.a_;let T=0;for(let S=0;S<f.length;++S){const C=o.bY([],f[S],200),I=Math.max(0,1+.01*c*(1*m()-.5)),M=Math.max(0,1+.01*d*(1*m()-.5));y.emplaceBack(C[0],C[1],C[2],-1,-1,I,M),y.emplaceBack(C[0],C[1],C[2],1,-1,I,M),y.emplaceBack(C[0],C[1],C[2],1,1,I,M),y.emplaceBack(C[0],C[1],C[2],-1,1,I,M),v.emplaceBack(T+0,T+1,T+2),v.emplaceBack(T+0,T+2,T+3),T+=4}this.starsVx=n.createVertexBuffer(y,uf.members),this.starsIdx=n.createIndexBuffer(v),this.starsSegments=o.bd.simpleSegment(0,0,y.length,v.length)}}destroy(){this.atmosphereBuffer&&this.atmosphereBuffer.destroy(),this.starsVx&&this.starsVx.destroy(),this.starsIdx&&this.starsIdx.destroy()}drawAtmosphereGlow(t,n){const c=t.context,d=c.gl,f=t.transform,m=new xt(d.LEQUAL,xt.ReadOnly,[0,1]),y=o.ah(f.zoom),v=t.style.getLut(n.scope),T=n.properties.get("color-use-theme")==="none",S=n.properties.get("color").toNonPremultipliedRenderColor(T?null:v).toArray01(),C=n.properties.get("high-color-use-theme")==="none",I=n.properties.get("high-color").toNonPremultipliedRenderColor(C?null:v).toArray01(),M=n.properties.get("space-color-use-theme")==="none",D=n.properties.get("space-color").toNonPremultipliedRenderColor(M?null:v).toArray01(),z=5e-4,O=o.e8(n.properties.get("horizon-blend"),0,1,z,.25),B=o.dl(t,c,f)&&O===z?f.worldSize/(2*Math.PI*1.025)-1:f.globeRadius,V=t.frameCounter/1e3%1,H=o.ae(f.globeCenterInViewSpace),Y=Math.sqrt(Math.pow(H,2)-Math.pow(B,2)),te=Math.acos(Y/H),ee=J=>{const K=f.projection.name==="globe"?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"];J&&K.push("ALPHA_PASS");const ie=t.getOrCreateProgram("globeAtmosphere",{defines:K}),se=((ve,Oe,ke,Ze,_e,Pe,ue,Ne,Se,qe,rt,Fe)=>({u_frustum_tl:ve,u_frustum_tr:Oe,u_frustum_br:ke,u_frustum_bl:Ze,u_horizon:_e,u_transition:Pe,u_fadeout_range:ue,u_color:Ne,u_high_color:Se,u_space_color:qe,u_temporal_offset:rt,u_horizon_angle:Fe}))(f.frustumCorners.TL,f.frustumCorners.TR,f.frustumCorners.BR,f.frustumCorners.BL,f.frustumCorners.horizon,y,O,S,I,D,V,te);t.uploadCommonUniforms(c,ie);const ye=this.atmosphereBuffer;ye&&ie.draw(t,d.TRIANGLES,m,Zt.disabled,J?this.colorModeWriteAlpha:this.colorModeAlphaBlendedWriteRGB,Nt.backCW,se,J?"atmosphere_glow_alpha":"atmosphere_glow",ye.vertexBuffer,ye.indexBuffer,ye.segments)};ee(!1),ee(!0)}drawStars(t,n){const c=o.ay(n.properties.get("star-intensity"),0,1);if(c===0)return;const d=t.context,f=d.gl,m=t.transform,y=t.getOrCreateProgram("stars"),v=o.b_([]);o.c0(v,v,-m._pitch),o.b$(v,v,-m.angle),o.c0(v,v,o.al(m._center.lat)),o.e9(v,v,-o.al(m._center.lng));const T=o.c3(new Float32Array(16),v),S=o.az([],m.starsProjMatrix,T),C=o.e4([],T),I=o.ea([],C),M=[0,1,0];o.dz(M,M,I),o.bY(M,M,this.params.sizeMultiplier);const D=[1,0,0];o.dz(D,D,I),o.bY(D,D,this.params.sizeMultiplier);const z=(O=M,B=D,V=c,{u_matrix:Float32Array.from(S),u_up:O,u_right:B,u_intensity_multiplier:V});var O,B,V;t.uploadCommonUniforms(d,y),this.starsVx&&this.starsIdx&&y.draw(t,f.TRIANGLES,xt.disabled,Zt.disabled,this.colorModeAlphaBlendedWriteRGB,Nt.disabled,z,"atmosphere_stars",this.starsVx,this.starsIdx,this.starsSegments)}}function Ko(l,t){const n=[...l],c=t.cameraWorldSizeForFog/t.worldSize,d=o.bx([]);return o.cE(d,d,[c,c,1]),o.az(n,d,n),o.az(n,t.worldToFogMatrix,n),n}function Je(l,t,n,c,d){const f=n.material,m=c.context,{baseColorTexture:y,metallicRoughnessTexture:v}=f.pbrMetallicRoughness,{normalTexture:T,occlusionTexture:S,emissionTexture:C}=f;function I(D,z,O){if(D&&(l.push(z),m.activeTexture.set(m.gl.TEXTURE0+O),D.gfxTexture)){const{minFilter:B,magFilter:V,wrapS:H,wrapT:Y}=D.sampler;D.gfxTexture.bindExtraParam(B,V,H,Y)}}I(y,"HAS_TEXTURE_u_baseColorTexture",xn.BaseColor),I(v,"HAS_TEXTURE_u_metallicRoughnessTexture",xn.MetallicRoughness),I(T,"HAS_TEXTURE_u_normalTexture",xn.Normal),I(S,"HAS_TEXTURE_u_occlusionTexture",xn.Occlusion),I(C,"HAS_TEXTURE_u_emissionTexture",xn.Emission),d&&(d.texture||(d.texture=new o.eh(c.context,d.image,[d.image.height,d.image.height,d.image.height],m.gl.RGBA8)),m.activeTexture.set(m.gl.TEXTURE0+xn.LUT),d.texture&&d.texture.bind(m.gl.LINEAR,m.gl.CLAMP_TO_EDGE),l.push("APPLY_LUT_ON_GPU")),n.texcoordBuffer&&(l.push("HAS_ATTRIBUTE_a_uv_2f"),t.push(n.texcoordBuffer)),n.colorBuffer&&(l.push(n.colorBuffer.itemSize===12?"HAS_ATTRIBUTE_a_color_3f":"HAS_ATTRIBUTE_a_color_4f"),t.push(n.colorBuffer)),n.normalBuffer&&(l.push("HAS_ATTRIBUTE_a_normal_3f"),t.push(n.normalBuffer)),n.pbrBuffer&&(l.push("HAS_ATTRIBUTE_a_pbr"),l.push("HAS_ATTRIBUTE_a_heightBasedEmissiveStrength"),t.push(n.pbrBuffer)),f.alphaMode!=="OPAQUE"&&f.alphaMode!=="MASK"||l.push("UNPREMULT_TEXTURE_IN_SHADER"),f.defined||l.push("DIFFUSE_SHADED");const M=c.shadowRenderer;M&&(l.push("RENDER_SHADOWS","DEPTH_TEXTURE"),M.useNormalOffset&&l.push("NORMAL_OFFSET"))}function _t(l,t,n,c,d,f){const m=n.paint.get("model-opacity").constantOr(1),y=t.context,v=new xt(t.context.gl.LEQUAL,xt.ReadWrite,t.depthRangeFor3D),T=t.transform,S=l.mesh,C=S.material,I=C.pbrMetallicRoughness,M=t.style.fog;let D;D=t.transform.projection.zAxisUnit==="pixels"?[...l.nodeModelMatrix]:o.az([],c.zScaleMatrix,l.nodeModelMatrix),o.az(D,c.negCameraPosMatrix,D);const z=o.bi([],D);o.ee(z,z);const O=n.paint.get("model-color-use-theme").constantOr("default")==="none",B=n.paint.get("model-emissive-strength").constantOr(0),V=Dl(new Float32Array(l.worldViewProjection),new Float32Array(D),new Float32Array(z),null,t,m,I.baseColorFactor,C.emissiveFactor,I.metallicFactor,I.roughnessFactor,C,B,n),H={defines:[]},Y=[],te=t.shadowRenderer;te&&(te.useNormalOffset=!1),Je(H.defines,Y,S,t,O?null:n.lut);let ee=null;if(M){const ie=Ko(l.nodeModelMatrix,t.transform);if(ee=new Float32Array(ie),T.projection.name!=="globe"){const se=S.aabb.min,ye=S.aabb.max,[ve,Oe]=M.getOpacityForBounds(ie,se[0],se[1],ye[0],ye[1]);H.overrideFog=ve>=Ie||Oe>=Ie}}const J=_s(t,n.paint.get("model-cutoff-fade-range"));J.shouldRenderCutoff&&H.defines.push("RENDER_CUTOFF");const K=t.getOrCreateProgram("model",H);t.uploadCommonUniforms(y,K,null,ee,J),t.renderPass!=="shadow"&&te&&te.setupShadowsFromMatrix(l.nodeModelMatrix,K),K.draw(t,y.gl.TRIANGLES,v,d,f,S.material.doubleSided?Nt.disabled:Nt.backCCW,V,n.id,S.vertexBuffer,S.indexBuffer,S.segments,n.paint,t.transform.zoom,void 0,Y)}function Jo(l,t,n,c,d,f,m){let y;y=l.projection.name==="globe"?o.ed(n,l):[...n],o.az(y,y,t.matrix);const v=o.az([],c,y);if(t.meshes)for(const T of t.meshes){if(T.material.alphaMode!=="BLEND"){m.push({mesh:T,depth:0,modelIndex:d,worldViewProjection:v,nodeModelMatrix:y});continue}const S=o.ad([],T.centroid,v);!l.isOrthographic&&S[2]<=0||f.push({mesh:T,depth:S[2],modelIndex:d,worldViewProjection:v,nodeModelMatrix:y})}if(t.children)for(const T of t.children)Jo(l,T,n,c,d,f,m)}function br(l,t,n,c){const d=n.shadowRenderer;if(!d)return;const f=d.getShadowPassDepthMode(),m=d.getShadowPassColorMode(),y=d.calculateShadowPassMatrixFromMatrix(t),v=Qd(y);n.getOrCreateProgram("modelDepth",{defines:n._shadowMapDebug?[]:["DEPTH_TEXTURE"]}).draw(n,n.context.gl.TRIANGLES,f,Zt.disabled,m,Nt.backCCW,v,c.id,l.vertexBuffer,l.indexBuffer,l.segments,c.paint,n.transform.zoom,void 0,void 0)}function ge(l,t,n){const c=t.updateZoomBasedPaintProperties(),d=function(f,m,y){let v,T,S,C=f.terrain?f.terrain.exaggeration():0;if(f.terrain&&C>0){const I=f.terrain,M=I.findDEMTileFor(y);M&&M.dem?v=o.ei.create(I,y,M):C=0}if(C===0&&(m.terrainElevationMin=0,m.terrainElevationMax=0),C===m.validForExaggeration&&(C===0||v&&v._demTile&&v._demTile.tileID===m.validForDEMTile.id&&v._dem._timestamp===m.validForDEMTile.timestamp))return!1;for(const I in m.instancesPerModel){const M=m.instancesPerModel[I];for(let D=0;D<M.instancedDataArray.length;++D){const z=(v?C*v.getElevationAt(0|M.instancedDataArray.float32[16*D],0|M.instancedDataArray.float32[16*D+1],!0,!0):0)+M.instancesEvaluatedElevation[D];M.instancedDataArray.float32[16*D+6]=z,T=T?Math.min(m.terrainElevationMin,z):z,S=S?Math.max(m.terrainElevationMax,z):z}}return m.terrainElevationMin=T||0,m.terrainElevationMax=S||0,m.validForExaggeration=C,m.validForDEMTile=v&&v._demTile?{id:v._demTile.tileID,timestamp:v._dem._timestamp}:{id:void 0,timestamp:0},!0}(l,t,n);(c||d)&&(t.uploaded=!1,t.upload(l.context))}const ls={shadowUniformsInitialized:!1,useSingleShadowCascade:!1,tileMatrix:new Float64Array(16),shadowTileMatrix:new Float32Array(16),aabb:new o.cW([0,0,0],[o.aj,o.aj,0])};function Kc(l,t){const n=1<<l.canonical.z,c=t.getFreeCameraOptions().position,d=t.elevation,f=l.canonical.x/n,m=(l.canonical.x+1)/n,y=l.canonical.y/n,v=(l.canonical.y+1)/n;let T=t._centerAltitude;if(d){const M=d.getMinMaxForTile(l);M&&M.max>T&&(T=M.max)}const S=o.ay(c.x,f,m)-c.x,C=o.ay(c.y,y,v)-c.y,I=o.c6(T,t.center.lat)-c.z;return t._zoomFromMercatorZ(Math.sqrt(S*S+C*C+I*I))}function Jc(l,t,n,c,d,f,m){const y=l.context,v=l.renderPass==="shadow",T=l.shadowRenderer,S=v&&T?T.getShadowPassDepthMode():new xt(y.gl.LEQUAL,xt.ReadWrite,l.depthRangeFor3D),C=l.isTileAffectedByFog(f);if(n.meshes)for(const I of n.meshes){const M=["MODEL_POSITION_ON_GPU"],D=[];let z,O,B;c.instancedDataArray.length>20&&M.push("INSTANCED_ARRAYS");const V=_s(l,t.paint.get("model-cutoff-fade-range"));if(V.shouldRenderCutoff&&M.push("RENDER_CUTOFF"),v&&T)z=l.getOrCreateProgram("modelDepth",{defines:M}),O=Qd(m.shadowTileMatrix,m.shadowTileMatrix,Float32Array.from(n.matrix)),B=T.getShadowPassColorMode();else{Je(M,D,I,l,t.paint.get("model-color-use-theme").constantOr("default")==="none"?null:t.lut),z=l.getOrCreateProgram("model",{defines:M,overrideFog:C});const Y=I.material,te=Y.pbrMetallicRoughness,ee=t.paint.get("model-opacity").constantOr(1),J=t.paint.get("model-emissive-strength").constantOr(0);O=Dl(f.expandedProjMatrix,Float32Array.from(n.matrix),new Float32Array(16),null,l,ee,te.baseColorFactor,Y.emissiveFactor,te.metallicFactor,te.roughnessFactor,Y,J,t,d),T&&(m.shadowUniformsInitialized?z.setShadowUniformValues(y,T.getShadowUniformValues()):(T.setupShadows(f.toUnwrapped(),z,"model-tile",f.overscaledZ),m.shadowUniformsInitialized=!0)),B=V.shouldRenderCutoff||ee<1||Y.alphaMode!=="OPAQUE"?oi.alphaBlended:oi.unblended}l.uploadCommonUniforms(y,z,f.toUnwrapped(),null,V);const H=I.material.doubleSided?Nt.disabled:Nt.backCCW;if(c.instancedDataArray.length>20)D.push(c.instancedDataBuffer),z.draw(l,y.gl.TRIANGLES,S,Zt.disabled,B,H,O,t.id,I.vertexBuffer,I.indexBuffer,I.segments,t.paint,l.transform.zoom,void 0,D,c.instancedDataArray.length);else{const Y=v?"u_instance":"u_normal_matrix";for(let te=0;te<c.instancedDataArray.length;++te)O[Y]=new Float32Array(c.instancedDataArray.arrayBuffer,64*te,16),z.draw(l,y.gl.TRIANGLES,S,Zt.disabled,B,H,O,t.id,I.vertexBuffer,I.indexBuffer,I.segments,t.paint,l.transform.zoom,void 0,D)}}if(n.children)for(const I of n.children)Jc(l,t,I,c,d,f,m)}const wh=[1,-1,1];function hf(l,t,n,c){if(!n.modelManager)return!0;const d=n.modelManager;if(!n.shadowRenderer)return!0;const f=n.shadowRenderer,m=t.aabb;let y=!0,v=l.maxHeight;if(v===0){let S=0;for(const C in l.instancesPerModel){const I=d.getModel(C,c);I?S=Math.max(S,Math.max(Math.max(I.aabb.max[0],I.aabb.max[1]),I.aabb.max[2])):y=!1}v=l.maxScale*S*1.41+l.maxVerticalOffset,y&&(l.maxHeight=v)}m.max[2]=v,m.min[2]+=l.terrainElevationMin,m.max[2]+=l.terrainElevationMax,o.ad(m.min,m.min,t.tileMatrix),o.ad(m.max,m.max,t.tileMatrix);const T=m.intersects(f.getCurrentCascadeFrustum());return n.currentShadowCascade===0&&(l.isInsideFirstShadowMapFrustum=T===2),T===0}function df(l,t){const n=l.uniformValues.u_cutoff_params[0],c=l.uniformValues.u_cutoff_params[1],d=l.uniformValues.u_cutoff_params[2],f=l.uniformValues.u_cutoff_params[3];return c===n||f===d?1:o.ay(((t-n)/(c-n)-d)/(f-d),0,1)}function Da(l,t,n,c){if(t.pitch<20)return 1;const d=t.getWorldToCameraMatrix();o.az(d,d,l);const f=o.ej(n.min[0],n.min[1],n.min[2],1);let m=o.aA(o.ek(),f,d),y=m,v=m;f[1]=n.max[1],m=o.aA(o.ek(),f,d),y=m[1]<y[1]?m:y,v=m[1]>v[1]?m:v,f[0]=n.max[0],m=o.aA(o.ek(),f,d),y=m[1]<y[1]?m:y,v=m[1]>v[1]?m:v,f[1]=n.min[1],m=o.aA(o.ek(),f,d),y=m[1]<y[1]?m:y,v=m[1]>v[1]?m:v;const T=o.ay(c[0],0,1),S=100*t.pixelsPerMeter*o.ay(c[1],0,1),C=o.ay(c[2],0,1),I=o.el(o.ek(),y,v,T),M=Math.tan(.5*t.fovX),D=-I[2]*M;if(S===0)return I[1]<-Math.abs(D)?C:1;const z=(-Math.abs(D)-I[1])/S,O=(V,H,Y)=>(1-Y)*V+Y*H,B=o.ay(O(1,C,z),C,1);return O(1,B,o.ay((t.pitch-20)/20,0,1))}class hm{}class dm{constructor(){this._storage=new Map}getLinesFromTrianglesBuffer(t,n,c){{const C=this._storage.get(n.id);if(C)return C.lastUsedFrameIdx=t,C.buf}const d=c.gl,f=d.getBufferParameter(d.ELEMENT_ARRAY_BUFFER,d.BUFFER_SIZE),m=new ArrayBuffer(f),y=new Int16Array(m);d.getBufferSubData(d.ELEMENT_ARRAY_BUFFER,0,new Int16Array(m));const v=new o.en;for(let C=0;C<f/2;C+=3){const I=y[C],M=y[C+1],D=y[C+2];v.emplaceBack(I,M),v.emplaceBack(M,D),v.emplaceBack(D,I)}const T=c.bindVertexArrayOES.current,S=new hm;return S.buf=new Qn(c,v),S.lastUsedFrameIdx=t,this._storage.set(n.id,S),c.bindVertexArrayOES.set(T),S.buf}update(t){for(const[n,c]of this._storage)t-c.lastUsedFrameIdx>30&&(c.buf.destroy(),this._storage.delete(n))}destroy(){for(const[t,n]of this._storage)n.buf.destroy(),this._storage.delete(t)}}class ff{constructor(t){this.occluderSize=30,this.depthOffset=-1e-4,t.registerParameter(this,["Occlusion"],"occluderSize",{min:1,max:100,step:1}),t.registerParameter(this,["Occlusion"],"depthOffset",{min:-.05,max:0,step:1e-5})}}const Qc=o.d_([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_rainParticleData",components:4}]);class Th{registerParameter(){}registerButton(){}registerBinding(){}refreshUI(){}}class Sh{constructor(t,n){this.revealStart=11,this.revealRange=2,t.registerParameter(this,[...n,"Reveal"],"revealStart",{min:0,max:17,step:.05}),t.registerParameter(this,[...n,"Reveal"],"revealRange",{min:.1,max:5.1,step:.05})}}const pf=o.d_([{type:"Float32",name:"a_pos_2f",components:2}]);class eu{destroy(){this.vignetteVx&&this.vignetteVx.destroy(),this.vignetteIdx&&this.vignetteIdx.destroy()}draw(t,n){const c=t.getOrCreateProgram("vignette");if(!this.vignetteVx||!this.vignetteIdx){const m=new o.eo,y=new o.a_;m.emplaceBack(-1,-1),m.emplaceBack(1,-1),m.emplaceBack(1,1),m.emplaceBack(-1,1),y.emplaceBack(0,1,2),y.emplaceBack(0,2,3),this.vignetteVx=t.context.createVertexBuffer(m,pf.members),this.vignetteIdx=t.context.createIndexBuffer(y)}const d=o.bd.simpleSegment(0,0,4,6);if(this.vignetteVx&&this.vignetteIdx){t.uploadCommonUniforms(t.context,c);const m={u_vignetteShape:(f={vignetteShape:[n.start,n.range,Math.pow(10,n.fadePower)],vignetteColor:[n.color.r,n.color.g,n.color.b,n.color.a*n.strength]}).vignetteShape,u_vignetteColor:f.vignetteColor};c.draw(t,t.context.gl.TRIANGLES,xt.disabled,Zt.disabled,oi.alphaBlended,Nt.disabled,m,"vignette",this.vignetteVx,this.vignetteIdx,d)}var f}}class Nl{constructor(){this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0}update(t,n){const c=t.getFreeCameraOptions().position,d=c.toAltitude(),f=c.toLngLat(),m=o.al(f.lng),y=o.al(f.lat),v=t.pixelsPerMeter/n,T=m*o.eq,S=o.eq*Math.log(Math.tan(Math.PI/4+y/2));if(this._offsetXPrev===void 0)this._offsetXPrev=0,this._offsetYPrev=0,this._elevationPrev=0,this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0;else{const C=-this._offsetYPrev+S,I=-this._elevationPrev+d;this._accumulatedOffsetX+=(-this._offsetXPrev+T)*v,this._accumulatedOffsetY+=C*v,this._accumulatedElevation+=I*v,this._offsetXPrev=T,this._offsetYPrev=S,this._elevationPrev=d}}getPosition(){return[this._accumulatedOffsetX,this._accumulatedOffsetY,this._accumulatedElevation]}}function Qo(l,t){return[-(l[0]-Math.floor(l[0]/t)*t),-(l[1]-Math.floor(l[1]/t)*t),-(l[2]-Math.floor(l[2]/t)*t)]}function Eh(l){const t=o.e7(1323123451230),n=[];for(let c=0;c<l;++c){const d=2*t()-1,f=2*t()-1,m=2*t()-1;n.push(o.cS(d,f,m))}return n}function po(l,t,n,c,d){const f=o.ay((d-n)/(c-n),0,1);return(1-f)*l+f*t}class hn{constructor(t){this._movement=new Nl,this._accumulatedTimeFromStart=0,this._prevTime=Date.now()/1e3,this._vignette=new eu,this._ppmScaleFactor=t}destroy(){this.particlesVx&&this.particlesVx.destroy(),this.particlesIdx&&this.particlesIdx.destroy(),this._vignette&&this._vignette.destroy()}updateOnRender(t,n){const c=t.transform;this._movement.update(c,this._ppmScaleFactor);const d=c.starsProjMatrix,f=o.b_([]);o.c0(f,f,o.al(90)-c._pitch),o.b$(f,f,-c.angle);const m=o.c3(new Float32Array(16),f),y=o.ep(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),v=o.ee([],y),T=o.az([],v,m),S=Date.now()/1e3;return this._accumulatedTimeFromStart+=(S-this._prevTime)*n,this._prevTime=S,{projectionMatrix:d,modelviewMatrix:T}}}class fm extends hn{constructor(t){super(4.25),this._params={overrideStyleParameters:!1,intensity:.5,timeFactor:1,velocityConeAperture:0,velocity:300,boxSize:2500,dropletSizeX:1,dropletSizeYScale:10,distortionStrength:70,screenThinning:{intensity:.57,start:.46,range:1.17,fadePower:.17,affectedRatio:1,particleOffset:-.2},color:{r:.66,g:.68,b:.74,a:.7},direction:{x:-50,y:-35},shapeDirPower:2,shapeNormalPower:1},this._revealParams=new Sh(t.tp,["Precipitation","Rain"]),this._vignetteParams={strength:1,start:.7,range:1,fadePower:.4,color:{r:.27,g:.27,b:.27,a:1}},this.particlesCount=16e3}update(t){const n=t.context;if(!this.particlesVx){const c=Eh(this.particlesCount),d=new o.er,f=new o.a_;let m=0;const y=o.e7(1323123451230);for(let v=0;v<c.length;++v){const T=c[v],S=[2*y()-1,y(),y(),y()];d.emplaceBack(T[0],T[1],T[2],-1,-1,...S),d.emplaceBack(T[0],T[1],T[2],1,-1,...S),d.emplaceBack(T[0],T[1],T[2],1,1,...S),d.emplaceBack(T[0],T[1],T[2],-1,1,...S),f.emplaceBack(m+0,m+1,m+2),f.emplaceBack(m+0,m+2,m+3),m+=4}this.particlesVx=n.createVertexBuffer(d,Qc.members),this.particlesIdx=n.createIndexBuffer(f)}}draw(t){if(!this._params.overrideStyleParameters&&!t.style.rain)return;const n=this._params.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},c=t.transform.zoom;if(n.revealStart>c)return;const d=po(0,1,n.revealStart,n.revealStart+n.revealRange,c);if(!this.particlesVx||!this.particlesIdx)return;const f=structuredClone(this._params);let m=[-f.direction.x,f.direction.y,-100];o.au(m,m);const y=structuredClone(this._vignetteParams);y.strength*=d,f.overrideStyleParameters||(f.intensity=t.style.rain.state.density,f.timeFactor=t.style.rain.state.intensity,f.color=structuredClone(t.style.rain.state.color),m=structuredClone(t.style.rain.state.direction),f.screenThinning.intensity=t.style.rain.state.centerThinning,f.dropletSizeX=t.style.rain.state.dropletSize[0],f.dropletSizeYScale=t.style.rain.state.dropletSize[1]/t.style.rain.state.dropletSize[0],f.distortionStrength=100*t.style.rain.state.distortionStrength,y.strength=1,y.color=structuredClone(t.style.rain.state.vignetteColor));const v=this.updateOnRender(t,f.timeFactor),T=t.context,S=T.gl,C=t.transform;this.screenTexture&&this.screenTexture.size[0]===t.width&&this.screenTexture.size[1]===t.height||(this.screenTexture=new o.T(T,{width:t.width,height:t.height,data:null},S.RGBA8)),f.distortionStrength>0&&(T.activeTexture.set(S.TEXTURE0),this.screenTexture.bind(S.LINEAR,S.CLAMP_TO_EDGE),S.copyTexSubImage2D(S.TEXTURE_2D,0,0,0,0,0,t.width,t.height));const I=t.getOrCreateProgram("rainParticle");t.uploadCommonUniforms(T,I),T.activeTexture.set(S.TEXTURE0),this.screenTexture.bind(S.LINEAR,S.CLAMP_TO_EDGE);const M=[f.color.r,f.color.g,f.color.b,f.color.a],D=(z,O)=>{const B=Qo(this._movement.getPosition(),z),V=f.dropletSizeX,H=f.dropletSizeX*f.dropletSizeYScale,Y=t.width/2,te=t.height/2,ee=po(0,f.screenThinning.start,0,1,f.screenThinning.intensity),J=po(.001,f.screenThinning.range,0,1,f.screenThinning.intensity),K=po(0,f.screenThinning.particleOffset,0,1,f.screenThinning.intensity),ie=(se={modelview:v.modelviewMatrix,projection:v.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:B,velocityConeAperture:f.velocityConeAperture,velocity:f.velocity,boxSize:z,rainDropletSize:[V,H],distortionStrength:f.distortionStrength,rainDirection:m,color:M,screenSize:[C.width,C.height],thinningCenterPos:[Y,te],thinningShape:[ee,J,Math.pow(10,f.screenThinning.fadePower)],thinningAffectedRatio:f.screenThinning.affectedRatio,thinningParticleOffset:K,shapeDirectionalPower:f.shapeDirPower,shapeNormalPower:f.shapeNormalPower,mode:O?0:1},{u_modelview:Float32Array.from(se.modelview),u_projection:Float32Array.from(se.projection),u_time:se.time,u_cam_pos:se.camPos,u_texScreen:0,u_velocityConeAperture:se.velocityConeAperture,u_velocity:se.velocity,u_boxSize:se.boxSize,u_rainDropletSize:se.rainDropletSize,u_distortionStrength:se.distortionStrength,u_rainDirection:se.rainDirection,u_color:se.color,u_screenSize:se.screenSize,u_thinningCenterPos:se.thinningCenterPos,u_thinningShape:se.thinningShape,u_thinningAffectedRatio:se.thinningAffectedRatio,u_thinningParticleOffset:se.thinningParticleOffset,u_shapeDirectionalPower:se.shapeDirectionalPower,u_shapeNormalPower:se.shapeNormalPower,u_mode:se.mode});var se;const ye=Math.round(f.intensity*this.particlesCount),ve=o.bd.simpleSegment(0,0,4*ye,2*ye);I.draw(t,S.TRIANGLES,xt.disabled,Zt.disabled,oi.alphaBlended,Nt.disabled,ie,"rain_particles",this.particlesVx,this.particlesIdx,ve)};f.distortionStrength>0&&D(f.boxSize,!0),D(f.boxSize,!1),this._vignette.draw(t,y)}}const Vl=o.d_([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_snowParticleData",components:4},{type:"Float32",name:"a_snowParticleDataHorizontalOscillation",components:2}]);class hr extends hn{constructor(t){super(2.25),this._params={overrideStyleParameters:!1,intensity:.85,timeFactor:.75,velocityConeAperture:70,velocity:40,horizontalOscillationRadius:4,horizontalOscillationRate:1.5,boxSize:2e3,billboardSize:2,shapeFadeStart:.27,shapeFadePower:.21,screenThinning:{intensity:.4,start:.15,range:1.4,fadePower:.24,affectedRatio:1,particleOffset:-.2},color:{r:1,g:1,b:1,a:1},direction:{x:-50,y:-35}},this._revealParams=new Sh(t.tp,["Precipitation","Snow"]),this._vignetteParams={strength:.3,start:.78,range:.46,fadePower:.2,color:{r:1,g:1,b:1,a:1}},this.particlesCount=16e3}update(t){const n=t.context;if(!this.particlesVx){const c=Eh(this.particlesCount),d=new o.es,f=new o.a_;let m=0;const y=o.e7(1323123451230);for(let v=0;v<c.length;++v){const T=c[v],S=y(),C=y(),I=y(),M=[v/c.length,S,C,I],D=[y(),y()];d.emplaceBack(T[0],T[1],T[2],-1,-1,...M,...D),d.emplaceBack(T[0],T[1],T[2],1,-1,...M,...D),d.emplaceBack(T[0],T[1],T[2],1,1,...M,...D),d.emplaceBack(T[0],T[1],T[2],-1,1,...M,...D),f.emplaceBack(m+0,m+1,m+2),f.emplaceBack(m+0,m+2,m+3),m+=4}this.particlesVx=n.createVertexBuffer(d,Vl.members),this.particlesIdx=n.createIndexBuffer(f)}}draw(t){if(!this._params.overrideStyleParameters&&!t.style.snow)return;const n=structuredClone(this._params);let c=[-n.direction.x,n.direction.y,-100];o.au(c,c);const d=structuredClone(this._vignetteParams),f=n.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},m=t.transform.zoom;if(f.revealStart>m)return;const y=po(0,1,f.revealStart,f.revealStart+f.revealRange,m);d.strength*=y,n.overrideStyleParameters||(n.intensity=t.style.snow.state.density,n.timeFactor=t.style.snow.state.intensity,n.color=structuredClone(t.style.snow.state.color),c=structuredClone(t.style.snow.state.direction),n.screenThinning.intensity=t.style.snow.state.centerThinning,n.billboardSize=2.79*t.style.snow.state.flakeSize,d.strength=1,d.color=structuredClone(t.style.snow.state.vignetteColor));const v=this.updateOnRender(t,n.timeFactor);if(!this.particlesVx||!this.particlesIdx)return;const T=t.context,S=T.gl,C=t.transform,I=t.getOrCreateProgram("snowParticle");t.uploadCommonUniforms(T,I),((M,D,z)=>{const O=Qo(this._movement.getPosition(),M),B=C.width/2,V=C.height/2,H=po(0,z.screenThinning.start,0,1,z.screenThinning.intensity),Y=po(.001,z.screenThinning.range,0,1,z.screenThinning.intensity),te=po(0,z.screenThinning.particleOffset,0,1,z.screenThinning.intensity),ee=(J={modelview:v.modelviewMatrix,projection:v.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:O,velocityConeAperture:z.velocityConeAperture,velocity:z.velocity,horizontalOscillationRadius:z.horizontalOscillationRadius,horizontalOscillationRate:z.horizontalOscillationRate,boxSize:M,billboardSize:1*z.billboardSize,simpleShapeParameters:[z.shapeFadeStart,z.shapeFadePower],screenSize:[C.width,C.height],thinningCenterPos:[B,V],thinningShape:[H,Y,Math.pow(10,z.screenThinning.fadePower)],thinningAffectedRatio:z.screenThinning.affectedRatio,thinningParticleOffset:te,color:[z.color.r,z.color.g,z.color.b,z.color.a],direction:c},{u_modelview:Float32Array.from(J.modelview),u_projection:Float32Array.from(J.projection),u_time:J.time,u_cam_pos:J.camPos,u_velocityConeAperture:J.velocityConeAperture,u_velocity:J.velocity,u_horizontalOscillationRadius:J.horizontalOscillationRadius,u_horizontalOscillationRate:J.horizontalOscillationRate,u_boxSize:J.boxSize,u_billboardSize:J.billboardSize,u_simpleShapeParameters:J.simpleShapeParameters,u_screenSize:J.screenSize,u_thinningCenterPos:J.thinningCenterPos,u_thinningShape:J.thinningShape,u_thinningAffectedRatio:J.thinningAffectedRatio,u_thinningParticleOffset:J.thinningParticleOffset,u_particleColor:J.color,u_direction:J.direction});var J;const K=Math.round(z.intensity*this.particlesCount),ie=o.bd.simpleSegment(0,0,4*K,2*K);this.particlesVx&&this.particlesIdx&&I.draw(t,S.TRIANGLES,xt.disabled,Zt.disabled,oi.alphaBlended,Nt.disabled,ee,"snow_particles",this.particlesVx,this.particlesIdx,ie)})(n.boxSize,0,n),this._vignette.draw(t,d)}}const bi={symbol:function(l,t,n,c,d){if(l.renderPass!=="translucent")return;const f=Zt.disabled,m=l.colorModeForRenderPass(),y=n.layout.get("text-variable-anchor"),v=n.layout.get("text-size-scale-range"),T=o.ay(l.scaleFactor,v[0],v[1]);y&&function(I,M,D,z,O,B,V,H){const Y=M.transform,te=O==="map",ee=B==="map";for(const J of I){const K=z.getTile(J),ie=K.getBucket(D);if(!ie||!ie.text||!ie.text.segments.get().length)continue;const se=o.bH(ie.textSizeData,Y.zoom,H),ye=wc(J,ie.getProjection(),Y),ve=Y.calculatePixelsToTileUnitsMatrix(K),Oe=Ps(ye,K.tileID.canonical,ee,te,Y,ie.getProjection(),ve),ke=ie.hasIconTextFit()&&ie.hasIconData();se&&tf(ie,te,ee,V,Y,Oe,J,Math.pow(2,Y.zoom-K.tileID.overscaledZ),se,ke)}}(c,l,n,t,n.layout.get("text-rotation-alignment"),n.layout.get("text-pitch-alignment"),d,T);const S=n.paint.get("icon-opacity").constantOr(1)!==0,C=n.paint.get("text-opacity").constantOr(1)!==0;n.layout.get("symbol-sort-key").constantOr(1)!==void 0&&(S||C)?Pa(l,t,n,c,f,m):(S&&Pa(l,t,n,c,f,m,{onlyIcons:!0}),C&&Pa(l,t,n,c,f,m,{onlyText:!0})),t.map.showCollisionBoxes&&(Zc(l,t,n,c,n.paint.get("text-translate"),n.paint.get("text-translate-anchor"),!0),Zc(l,t,n,c,n.paint.get("icon-translate"),n.paint.get("icon-translate-anchor"),!1))},circle:function(l,t,n,c){if(l.renderPass!=="translucent")return;const d=n.paint.get("circle-opacity"),f=n.paint.get("circle-stroke-width"),m=n.paint.get("circle-stroke-opacity"),y=n.layout.get("circle-sort-key").constantOr(1)!==void 0,v=n.paint.get("circle-emissive-strength");if(d.constantOr(1)===0&&(f.constantOr(1)===0||m.constantOr(1)===0))return;const T=l.context,S=T.gl,C=l.transform,I=!(!l.terrain||!l.terrain.enabled),M=n.layout.get("circle-elevation-reference"),D=l.depthModeForSublayer(0,xt.ReadOnly),z=new xt(l.context.gl.LEQUAL,xt.ReadOnly,l.depthRangeFor3D),O=M==="none"||I?D:z,B=Zt.disabled,V=l.colorModeForDrapableLayerRenderPass(v),H=C.projection.name==="globe",Y=[o.aD(C.center.lng),o.aH(C.center.lat)],te=[];for(let J=0;J<c.length;J++){const K=c[J],ie=t.getTile(K),se=ie.getBucket(n);if(!se||se.projection.name!==C.projection.name)continue;const ye=se.programConfigurations.get(n.id),ve=se.layoutVertexBuffer,Oe=se.globeExtVertexBuffer,ke=se.indexBuffer,Ze=o.dK(n),_e=[Oe],Pe=l.isTileAffectedByFog(K);H&&Ze.push("PROJECTION_GLOBE_VIEW"),Ze.push("DEPTH_D24"),l.terrain&&C.depthOcclusionForSymbolsAndCircles&&Ze.push("DEPTH_OCCLUSION"),se.hasElevation&&(Ze.push("ELEVATED_ROADS"),_e.push(se.elevatedLayoutVertexBuffer));const ue=l.getOrCreateProgram("circle",{config:ye,defines:Ze,overrideFog:Pe}),Ne=C.projection.createInversionMatrix(C,K.canonical),Se={programConfiguration:ye,program:ue,layoutVertexBuffer:ve,dynamicBuffers:_e,indexBuffer:ke,uniformValues:o.dL(l,K,ie,Ne,Y,n),tile:ie};if(y){const qe=se.segments.get();for(const rt of qe)te.push({segments:new o.bd([rt]),sortKey:rt.sortKey,state:Se})}else te.push({segments:se.segments,sortKey:0,state:Se})}y&&te.sort((J,K)=>J.sortKey-K.sortKey);const ee={useDepthForOcclusion:C.depthOcclusionForSymbolsAndCircles};for(const J of te){const{programConfiguration:K,program:ie,layoutVertexBuffer:se,dynamicBuffers:ye,indexBuffer:ve,uniformValues:Oe,tile:ke}=J.state,Ze=J.segments;l.terrain&&l.terrain.setupElevationDraw(ke,ie,ee),l.uploadCommonUniforms(T,ie,ke.tileID.toUnwrapped()),ie.draw(l,S.TRIANGLES,O,B,V,Nt.disabled,Oe,n.id,se,ve,Ze,n.paint,C.zoom,K,ye)}},heatmap:function(l,t,n,c){if(n.paint.get("heatmap-opacity")!==0)if(l.renderPass==="offscreen"){const d=l.context,f=d.gl,m=Zt.disabled,y=new oi([f.ONE,f.ONE,f.ONE,f.ONE],o.am.transparent,[!0,!0,!0,!0]);(function(M,D,z,O){const B=M.gl,V=D.width*O,H=D.height*O;M.activeTexture.set(B.TEXTURE1),M.viewport.set([0,0,V,H]);let Y=z.heatmapFbo;if(!Y||Y&&(Y.width!==V||Y.height!==H)){Y&&Y.destroy();const te=B.createTexture();B.bindTexture(B.TEXTURE_2D,te),B.texParameteri(B.TEXTURE_2D,B.TEXTURE_WRAP_S,B.CLAMP_TO_EDGE),B.texParameteri(B.TEXTURE_2D,B.TEXTURE_WRAP_T,B.CLAMP_TO_EDGE),B.texParameteri(B.TEXTURE_2D,B.TEXTURE_MIN_FILTER,B.LINEAR),B.texParameteri(B.TEXTURE_2D,B.TEXTURE_MAG_FILTER,B.LINEAR),Y=z.heatmapFbo=M.createFramebuffer(V,H,!0,null),function(ee,J,K,ie,se,ye){const ve=ee.gl;ve.texImage2D(ve.TEXTURE_2D,0,ee.extRenderToTextureHalfFloat?ve.RGBA16F:ve.RGBA,se,ye,0,ve.RGBA,ee.extRenderToTextureHalfFloat?ve.HALF_FLOAT:ve.UNSIGNED_BYTE,null),ie.colorAttachment.set(K)}(M,0,te,Y,V,H)}else B.bindTexture(B.TEXTURE_2D,Y.colorAttachment.get()),M.bindFramebuffer.set(Y.framebuffer)})(d,l,n,l.transform.projection.name==="globe"?.5:.25),d.clear({color:o.am.transparent});const v=l.transform,T=v.projection.name==="globe",S=T?["PROJECTION_GLOBE_VIEW"]:[],C=T?Nt.frontCCW:Nt.disabled,I=[o.aD(v.center.lng),o.aH(v.center.lat)];for(let M=0;M<c.length;M++){const D=c[M];if(t.hasRenderableParent(D))continue;const z=t.getTile(D),O=z.getBucket(n);if(!O||O.projection.name!==v.projection.name)continue;const B=l.isTileAffectedByFog(D),V=O.programConfigurations.get(n.id),H=l.getOrCreateProgram("heatmap",{config:V,defines:S,overrideFog:B}),{zoom:Y}=l.transform;l.terrain&&l.terrain.setupElevationDraw(z,H),l.uploadCommonUniforms(d,H,D.toUnwrapped());const te=v.projection.createInversionMatrix(v,D.canonical);H.draw(l,f.TRIANGLES,xt.disabled,m,y,C,Yd(l,D,z,te,I,Y,n.paint.get("heatmap-intensity")),n.id,O.layoutVertexBuffer,O.indexBuffer,O.segments,n.paint,l.transform.zoom,V,T?[O.globeExtVertexBuffer]:null)}d.viewport.set([0,0,l.width,l.height])}else l.renderPass==="translucent"&&(l.context.setColorMode(l.colorModeForRenderPass()),function(d,f){const m=d.context,y=m.gl,v=f.heatmapFbo;if(!v)return;m.activeTexture.set(y.TEXTURE0),y.bindTexture(y.TEXTURE_2D,v.colorAttachment.get()),m.activeTexture.set(y.TEXTURE1);let T=f.colorRampTexture;T||(T=f.colorRampTexture=new o.T(m,f.colorRamp,y.RGBA8)),T.bind(y.LINEAR,y.CLAMP_TO_EDGE),d.getOrCreateProgram("heatmapTexture").draw(d,y.TRIANGLES,xt.disabled,Zt.disabled,d.colorModeForRenderPass(),Nt.disabled,((S,C,I,M)=>({u_image:0,u_color_ramp:1,u_opacity:C.paint.get("heatmap-opacity")}))(0,f),f.id,d.viewportBuffer,d.quadTriangleIndexBuffer,d.viewportSegments,f.paint,d.transform.zoom)}(l,n))},line:function(l,t,n,c){if(l.renderPass!=="translucent")return;const d=n.paint.get("line-opacity"),f=n.paint.get("line-width");if(d.constantOr(1)===0||f.constantOr(1)===0)return;const m=n.paint.get("line-emissive-strength"),y=n.paint.get("line-occlusion-opacity"),v=n.layout.get("line-elevation-reference"),T=n.layout.get("line-width-unit")==="meters",S=v==="sea",C=!(!l.terrain||!l.terrain.enabled),I=l.context,M=I.gl;if(n.hasElevatedBuckets&&l.transform.projection.name==="globe")return;const D=n.layout.get("line-cross-slope"),z=D!==void 0,O=D<1,B=l.colorModeForDrapableLayerRenderPass(m),V=l.terrain&&l.terrain.renderingToTexture,H=V?1:o.q.devicePixelRatio,Y=n.paint.get("line-dasharray"),te=Y.constantOr(1),ee=n.layout.get("line-cap"),J=Y.constantOr(null),K=ee.constantOr(null),ie=n.paint.get("line-pattern"),se=ie.constantOr(1),ye=n.paint.get("line-pattern-cross-fade"),ve=ie.constantOr(null),Oe=n.paint.get("line-opacity").constantOr(1);let ke=!se&&Oe!==1||l.depthOcclusion&&y>0&&y<1;const Ze=n.paint.get("line-gradient"),_e=se?"linePattern":"line",Pe=o.dM(n);let ue;if(V&&l.terrain&&l.terrain.clipOrMaskOverlapStencilType()&&(ke=!1),y!==0&&l.depthOcclusion){const rt=n.paint._values["line-opacity"];rt&&rt.value&&rt.value.kind==="constant"?ue=rt.value:o.w(`Occlusion opacity for layer ${n.id} is supported only when line-opacity isn't data-driven.`)}f.value.kind!=="constant"&&f.value.isLineProgressConstant===!1&&Pe.push("VARIABLE_LINE_WIDTH");const Ne=(rt,Fe,tt,wt,Tt,gt)=>{for(const Rt of rt){const Dt=t.getTile(Rt);if(se&&!Dt.patternsLoaded())continue;const kt=Dt.getBucket(n);if(!kt||kt.elevationType!=="none"&&!Tt||kt.elevationType==="none"&&Tt)continue;l.prepareDrawTile();const $t=[...Fe],ti=l.shadowRenderer,zi=kt.elevationType==="road"&&!!ti&&ti.enabled;let Ji=[0,0,0];if(zi){const mi=l.style.directionalLight,Fr=l.style.ambientLight;mi&&Fr&&(Ji=jo(l.style,mi,Fr)),$t.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET")}const Fi=kt.programConfigurations.get(n.id);let Vi=!1;if(ve&&Dt.imageAtlas){const mi=o.dN.from(ve),Fr=mi.getPrimary().scaleSelf(H).toString(),sr=Dt.imageAtlas.patternPositions.get(Fr),Wi=mi.getSecondary(),or=Wi?Dt.imageAtlas.patternPositions.get(Wi.scaleSelf(H).toString()):null;Vi=!!sr&&!!or,sr&&Fi.setConstantPatternPositions(sr,or)}ye>0&&(Vi||Fi.getPatternTransitionVertexBuffer("line-pattern"))&&$t.push("LINE_PATTERN_TRANSITION");const Mr=l.isTileAffectedByFog(Rt),Kt=l.getOrCreateProgram(_e,{config:Fi,defines:$t,overrideFog:Mr,overrideRtt:!Tt&&void 0});if(!se&&J&&K&&Dt.lineAtlas){const mi=Dt.lineAtlas.getDash(J,K);mi&&Fi.setConstantPatternPositions(mi)}zi&&ti.setupShadows(Dt.tileID.toUnwrapped(),Kt,"vector-tile",Dt.tileID.overscaledZ);let[ni,ui]=n.paint.get("line-trim-offset");(K==="round"||K==="square")&&ni!==ui&&(ni===0&&(ni-=1),ui===1&&(ui+=1));const nr=V?Rt.projMatrix:null,Vr=T?1/kt.tileToMeter/o.aw(Dt,1,l.transform.zoom):1,Qi=T?1/kt.tileToMeter/o.aw(Dt,1,Math.floor(l.transform.zoom)):1,Ai=se?o.dO(l,Dt,n,nr,H,Vr,Qi,[ni,ui],Ji,ye):o.dP(l,Dt,n,nr,kt.lineClipsArray.length,H,Vr,Qi,[ni,ui],Ji);if(Ze){const mi=kt.gradients[n.id];let Fr=mi.texture;if(n.gradientVersion!==mi.version){let sr=256;if(n.stepInterpolant){const Wi=t.getSource().maxzoom,or=Rt.canonical.z===Wi?Math.ceil(1<<l.transform.maxZoom-Rt.canonical.z):1;sr=o.ay(o.dQ(kt.maxLineLength/o.aj*1024*or),256,I.maxTextureSize)}mi.gradient=o.dR({expression:n.gradientExpression(),evaluationKey:"lineProgress",resolution:sr,image:mi.gradient||void 0,clips:kt.lineClipsArray}),mi.texture?mi.texture.update(mi.gradient):mi.texture=new o.T(I,mi.gradient,M.RGBA8),mi.version=n.gradientVersion,Fr=mi.texture}I.activeTexture.set(M.TEXTURE1),Fr.bind(n.stepInterpolant?M.NEAREST:M.LINEAR,M.CLAMP_TO_EDGE)}te&&(I.activeTexture.set(M.TEXTURE0),Dt.lineAtlasTexture&&Dt.lineAtlasTexture.bind(M.LINEAR,M.REPEAT),Fi.updatePaintBuffers()),se&&(I.activeTexture.set(M.TEXTURE0),Dt.imageAtlasTexture&&Dt.imageAtlasTexture.bind(M.LINEAR,M.CLAMP_TO_EDGE),Fi.updatePaintBuffers()),Tt&&!S&&l.terrain.setupElevationDraw(Dt,Kt),l.uploadCommonUniforms(I,Kt,Rt.toUnwrapped());const wr=mi=>{ue!=null&&(ue.value=Oe*y),Kt.draw(l,M.TRIANGLES,tt,mi,B,Nt.disabled,Ai,n.id,kt.layoutVertexBuffer,kt.indexBuffer,kt.segments,n.paint,l.transform.zoom,Fi,[kt.layoutVertexBuffer2,kt.patternVertexBuffer,kt.zOffsetVertexBuffer]),ue!=null&&(ue.value=Oe)};if(ke&&!Tt){const mi=l.stencilModeForClipping(Rt).ref;mi===0&&V&&I.clear({stencil:0});const Fr={func:M.EQUAL,mask:255};Ai.u_alpha_discard_threshold=.8,wr(new Zt(Fr,mi,255,M.KEEP,M.KEEP,M.INVERT)),Ai.u_alpha_discard_threshold=0,wr(new Zt(Fr,mi,255,M.KEEP,M.KEEP,M.KEEP))}else Ai.u_alpha_discard_threshold=ke&&Tt&&gt?.8:0,wr(Tt?wt:l.stencilModeForClipping(Rt))}};let Se=l.depthModeForSublayer(0,xt.ReadOnly);const qe=new xt(l.depthOcclusion?M.GREATER:M.LEQUAL,xt.ReadOnly,l.depthRangeFor3D);if(n.hasNonElevatedBuckets){const rt=!V&&l.terrain;y!==0&&rt?o.w(`Occlusion opacity for layer ${n.id} is supported on terrain only if the layer has line-z-offset enabled.`):rt?o.w(`Cannot render non-elevated lines in immediate mode when terrain is enabled. Layer: ${n.id}.`):Ne(c,Pe,Se,Zt.disabled,!1,!0)}if(n.hasElevatedBuckets){v==="hd-road-markup"?C||(Se=qe,Pe.push("ELEVATED_ROADS")):(Pe.push("ELEVATED"),Se=qe,z&&Pe.push(O?"CROSS_SLOPE_HORIZONTAL":"CROSS_SLOPE_VERTICAL"),S&&Pe.push("ELEVATION_REFERENCE_SEA"));const rt=ke?l.stencilModeFor3D():Zt.disabled;l.forceTerrainMode=!0,Ne(c,Pe,Se,rt,!0,!0),ke&&Ne(c,Pe,Se,rt,!0,!1),l.forceTerrainMode=!1}ke&&(l.resetStencilClippingMasks(),V&&I.clear({stencil:0})),y===0||l.depthOcclusion||V||l.layersWithOcclusionOpacity.push(l.currentLayer)},fill:function(l,t,n,c){const d=n.paint.get("fill-color"),f=n.paint.get("fill-opacity");if(f.constantOr(1)===0)return;const m=n.paint.get("fill-emissive-strength"),y=l.colorModeForDrapableLayerRenderPass(m),v=n.paint.get("fill-pattern"),T=l.opaquePassEnabledForLayer()&&!v.constantOr(1)&&d.constantOr(o.am.transparent).a===1&&f.constantOr(0)===1?"opaque":"translucent";let S="none";n.layout.get("fill-elevation-reference")!=="none"?S="road":n.paint.get("fill-z-offset").constantOr(1)!==0&&(S="offset");const C=!(!l.terrain||!l.terrain.enabled),I={painter:l,sourceCache:t,layer:n,coords:c,colorMode:y,elevationType:S,terrainEnabled:C,pass:T};if(l.renderPass!=="shadow")if(S!=="offset"){if(vh(I,!1),S==="road"){const M=!C&&l.renderPass==="translucent";M&&yh(l,t,n,c,"geometry"),vh(I,!0,Zt.disabled),M&&function(D){const{painter:z,sourceCache:O,layer:B,coords:V,colorMode:H}=D,Y=z.context.gl,te=D.painter.shadowRenderer,ee=!!te&&te.enabled,J=new xt(z.context.gl.LEQUAL,xt.ReadOnly,z.depthRangeFor3D);let K=[0,0,0];if(ee){const se=z.style.directionalLight,ye=z.style.ambientLight;se&&ye&&(K=jo(z.style,se,ye))}const ie=se=>{for(const ye of V){const ve=O.getTile(ye),Oe=ve.getBucket(B);if(!Oe)continue;const ke=Oe.elevatedStructures;if(!ke)continue;let Ze,_e;if(se?(Ze=ke.renderableBridgeSegments,_e=ke.bridgeProgramConfigurations.get(B.id)):(Ze=ke.renderableTunnelSegments,_e=ke.tunnelProgramConfigurations.get(B.id)),!Ze||Ze.segments[0].primitiveLength===0)continue;_e.updatePaintBuffers(),z.prepareDrawTile();const Pe=z.isTileAffectedByFog(ye),ue=[];ee&&ue.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET");const Ne=z.getOrCreateProgram("elevatedStructures",{config:_e,overrideFog:Pe,defines:ue}),Se=z.translatePosMatrix(ye.projMatrix,ve,B.paint.get("fill-translate"),B.paint.get("fill-translate-anchor"));ee&&te.setupShadows(ve.tileID.toUnwrapped(),Ne,"vector-tile",ve.tileID.overscaledZ);const qe=em(Se,K);z.uploadCommonUniforms(z.context,Ne,ye.toUnwrapped()),Ne.draw(z,Y.TRIANGLES,J,Zt.disabled,H,Nt.backCCW,qe,B.id,ke.vertexBuffer,ke.indexBuffer,Ze,B.paint,z.transform.zoom,_e,[ke.vertexBufferNormal])}};ie(!0),ie(!1)}(I)}}else vh(I,!1,l.stencilModeFor3D());else l.shadowRenderer&&S==="road"&&!C&&function(M){const{painter:D,sourceCache:z,layer:O,coords:B}=M,V=D.context.gl,H=M.painter.shadowRenderer;for(const Y of B){const te=z.getTile(Y),ee=te.getBucket(O);if(!ee)continue;const J=ee.elevatedStructures;if(!J||!J.shadowCasterSegments||J.shadowCasterSegments.segments[0].primitiveLength===0)continue;D.prepareDrawTile();const K=ee.bufferData.programConfigurations.get(O.id),ie=D.isTileAffectedByFog(Y),se=D.getOrCreateProgram("elevatedStructuresDepth",{config:K,overrideFog:ie}),ye=H.calculateShadowPassMatrixFromTile(te.tileID.toUnwrapped());D.uploadCommonUniforms(D.context,se,Y.toUnwrapped());const ve={u_matrix:ye,u_depth_bias:.001};se.draw(D,V.TRIANGLES,H.getShadowPassDepthMode(),Zt.disabled,H.getShadowPassColorMode(),Nt.disabled,ve,O.id,J.vertexBuffer,J.indexBuffer,J.shadowCasterSegments,O.paint,D.transform.zoom,K)}}(I)},"fill-extrusion":function(l,t,n,c){const d=n.paint.get("fill-extrusion-opacity"),f=l.context,m=f.gl,y=l.terrain,v=y&&y.renderingToTexture;if(d===0)return;const T=l.conflationActive&&l.style.isLayerClipped(n,t.getSource()),S=l.style.order.indexOf(n.fqid);if(T&&function(C,I,M,D,z){for(const O of D){const B=I.getTile(O).getBucket(M);B&&(B.updateReplacement(O,C.replacementSource,z),B.uploadCentroid(C.context))}}(l,t,n,c,S),y||T)for(const C of c){const I=t.getTile(C).getBucket(n);I&&bt(l.context,t,C,I,n,y,T)}if(l.renderPass==="shadow"&&l.shadowRenderer){const C=l.shadowRenderer;if(y&&d<.65&&n._transitionablePaint._values["fill-extrusion-opacity"].value.expression instanceof o.ab)return;const I=C.getShadowPassDepthMode(),M=C.getShadowPassColorMode();Os(l,t,n,c,I,Zt.disabled,M,T)}else if(l.renderPass==="translucent"){const C=!n.paint.get("fill-extrusion-pattern").constantOr(1),I=n.paint.get("fill-extrusion-color").constantOr(o.am.white);if(!v&&I.a!==0){const M=new xt(l.context.gl.LEQUAL,xt.ReadWrite,l.depthRangeFor3D);d===1&&C?Os(l,t,n,c,M,Zt.disabled,oi.unblended,T):(Os(l,t,n,c,M,Zt.disabled,oi.disabled,T),Os(l,t,n,c,M,l.stencilModeFor3D(),l.colorModeForRenderPass(),T),l.resetStencilClippingMasks())}if(l.style.enable3dLights()&&C&&(!y&&l.transform.projection.name!=="globe"||v)){const M=n.paint.get("fill-extrusion-opacity"),D=n.paint.get("fill-extrusion-ambient-occlusion-intensity"),z=n.paint.get("fill-extrusion-ambient-occlusion-ground-radius"),O=n.paint.get("fill-extrusion-flood-light-intensity"),B=n.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default")==="none",V=n.paint.get("fill-extrusion-flood-light-color").toNonPremultipliedRenderColor(B?null:n.lut).toArray01().slice(0,3),H=D>0&&z>0,Y=O>0,te=(J,K,ie)=>(1-ie)*J+ie*K,ee=J=>{const K=l.depthModeForSublayer(1,xt.ReadOnly,m.LEQUAL,!0),ie=n.paint.get(J?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),se=te(.1,3,ie),ye=l._showOverdrawInspector;if(!ye){const ve=new Zt({func:m.ALWAYS,mask:255},255,255,m.KEEP,m.KEEP,m.REPLACE),Oe=new oi([m.ONE,m.ONE,m.ONE,m.ONE],o.am.transparent,[!1,!1,!1,!0],m.MIN);ks(l,t,n,c,K,ve,Oe,Nt.disabled,J,"sdf",M,D,z,O,V,se,T,!1)}{const ve=ye?Zt.disabled:new Zt({func:m.EQUAL,mask:255},255,255,m.KEEP,m.DECR,m.DECR),Oe=ye?l.colorModeForRenderPass():new oi([m.ONE_MINUS_DST_ALPHA,m.DST_ALPHA,m.ONE,m.ONE],o.am.transparent,[!0,!0,!0,!0]);ks(l,t,n,c,K,ve,Oe,Nt.disabled,J,"color",M,D,z,O,V,se,T,!1)}};if(v){const J=(K,ie,se)=>{const ye=l.depthModeForSublayer(1,xt.ReadOnly,m.LEQUAL,!1),ve=n.paint.get(K?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),Oe=te(.1,3,ve);{const ke=new oi([m.ONE,m.ONE,m.ONE,m.ONE],o.am.transparent,[!1,!1,!1,!0]);ks(l,t,n,c,ye,Zt.disabled,ke,Nt.disabled,K,"clear",M,D,z,O,V,Oe,T,ie)}{const ke=new Zt({func:m.ALWAYS,mask:255},255,255,m.KEEP,m.KEEP,m.REPLACE),Ze=new oi([m.ONE,m.ONE,m.ONE,m.ONE],o.am.transparent,[!1,!1,!1,!0],m.MIN);ks(l,t,n,c,ye,ke,Ze,Nt.disabled,K,"sdf",M,D,z,O,V,Oe,T,ie)}{const ke=K?m.ZERO:m.ONE_MINUS_DST_ALPHA,Ze=new Zt({func:m.EQUAL,mask:255},255,255,m.KEEP,m.DECR,m.DECR),_e=new oi([ke,m.DST_ALPHA,m.ONE_MINUS_DST_ALPHA,m.ZERO],o.am.transparent,[!0,!0,!0,!0]);ks(l,t,n,c,ye,Ze,_e,Nt.disabled,K,"color",M,D,z,O,V,Oe,T,ie)}{const ke=new oi([m.ONE,m.ONE,m.ONE,K?m.ZERO:m.ONE],o.am.transparent,[!1,!1,!1,!0],K?m.FUNC_ADD:m.MAX);ks(l,t,n,c,ye,Zt.disabled,ke,Nt.disabled,K,"clear",M,D,z,O,V,Oe,T,ie,se)}};if(H||Y){let K;if(l.prepareDrawTile(),y){const ie=y.drapeBufferSize[0],se=y.drapeBufferSize[1];K=y.framebufferCopyTexture,K&&(!K||K.size[0]===ie&&K.size[1]===se)||(K&&K.destroy(),K=y.framebufferCopyTexture=new o.T(f,new o.r({width:ie,height:se}),m.RGBA8)),K.bind(m.LINEAR,m.CLAMP_TO_EDGE),m.copyTexSubImage2D(m.TEXTURE_2D,0,0,0,0,0,ie,se)}H&&J(!0,!1,K),Y&&J(!1,!0,K)}}else H&&ee(!0),Y&&ee(!1),(H||Y)&&l.resetStencilClippingMasks()}}},building:function(l,t,n,c){},hillshade:function(l,t,n,c){if(l.renderPass!=="offscreen"&&l.renderPass!=="translucent"||l.style.disableElevatedTerrain)return;const d=l.context,f=l.terrain&&l.terrain.renderingToTexture,[m,y]=l.renderPass!=="translucent"||f?[{},c]:l.stencilConfigForOverlap(c);for(const v of y){const T=t.getTile(v);if(T.needsHillshadePrepare&&l.renderPass==="offscreen")jp(l,T,n);else if(l.renderPass==="translucent"){const S=l.depthModeForSublayer(0,xt.ReadOnly),C=n.paint.get("hillshade-emissive-strength"),I=l.colorModeForDrapableLayerRenderPass(C),M=f&&l.terrain?l.terrain.stencilModeForRTTOverlap(v):m[v.overscaledZ];Up(l,v,T,n,S,M,I)}}d.viewport.set([0,0,l.width,l.height]),l.resetStencilClippingMasks()},raster:function(l,t,n,c,d,f){if(l.renderPass!=="translucent"||n.paint.get("raster-opacity")===0)return;const m=l.transform.projection.name==="globe",y=n.paint.get("raster-elevation")!==0,v=y&&m;if(l.renderElevatedRasterBackface&&!v)return;const T=l.context,S=T.gl,C=t.getSource(),I=function(ee,J,K,ie){const se=J.paint.get("raster-color"),ye=ee.type==="raster-array",ve=[],Oe=J.paint.get("raster-resampling"),ke=J.paint.get("raster-color-mix");let Ze=J.paint.get("raster-color-range");const _e=[ke[0],ke[1],ke[2],0],Pe=ke[3];let ue=Oe==="nearest"?ie.NEAREST:ie.LINEAR;if(ye&&(ve.push("RASTER_ARRAY"),se||ve.push("RASTER_COLOR"),Oe==="linear"&&ve.push("RASTER_ARRAY_LINEAR"),ue=ie.NEAREST,!Ze&&ee.rasterLayers)){const Ne=ee.rasterLayers.find(({id:Se})=>Se===J.sourceLayer);Ne&&Ne.fields&&Ne.fields.range&&(Ze=Ne.fields.range)}if(Ze=Ze||[0,1],se){ve.push("RASTER_COLOR"),K.activeTexture.set(ie.TEXTURE2),J.updateColorRamp(Ze);let Ne=J.colorRampTexture;Ne||(Ne=J.colorRampTexture=new o.T(K,J.colorRamp,ie.RGBA8)),Ne.bind(ie.LINEAR,ie.CLAMP_TO_EDGE)}return{mix:_e,range:Ze,offset:Pe,defines:ve,resampling:ue}}(C,n,T,S);if(C instanceof o.aP&&!c.length&&!m)return;const M=n.paint.get("raster-emissive-strength"),D=l.colorModeForDrapableLayerRenderPass(M),z=l.terrain&&l.terrain.renderingToTexture,O=!l.options.moving,B=n.paint.get("raster-resampling")==="nearest"?S.NEAREST:S.LINEAR;if(C instanceof o.aP&&!c.length&&(C.onNorthPole||C.onSouthPole)){const ee=y?l.stencilModeFor3D():Zt.disabled;return void Fl(!!C.onNorthPole,null,l,t,n,M,I,Nt.disabled,ee)}if(!c.length)return;const[V,H]=C instanceof o.aP||z?[{},c]:l.stencilConfigForOverlap(c),Y=H[H.length-1].overscaledZ;v&&I.defines.push("PROJECTION_GLOBE_VIEW"),y&&I.defines.push("RENDER_CUTOFF");const te=(ee,J,K)=>{for(const ie of ee){const se=ie.toUnwrapped(),ye=t.getTile(ie);if(z&&(!ye||!ye.hasData()))continue;T.activeTexture.set(S.TEXTURE0);const ve=om(ye,C,n,I);if(!ve||!ve.texture)continue;const{texture:Oe,mix:ke,offset:Ze,tileSize:_e,buffer:Pe}=ve;let ue,Ne;z?(ue=xt.disabled,Ne=ie.projMatrix):y?(ue=new xt(S.LEQUAL,xt.ReadWrite,l.depthRangeFor3D),Ne=m?Float32Array.from(l.transform.expandedFarZProjMatrix):l.transform.calculateProjMatrix(se,O)):(ue=l.depthModeForSublayer(ie.overscaledZ-Y,n.paint.get("raster-opacity")===1?xt.ReadWrite:xt.ReadOnly,S.LESS),Ne=l.transform.calculateProjMatrix(se,O));const Se=l.terrain&&z?l.terrain.stencilModeForRTTOverlap(ie):V[ie.overscaledZ],qe=f?0:n.paint.get("raster-fade-duration");ye.registerFadeDuration(qe);const rt=t.findLoadedParent(ie,0),Fe=Ho(ye,rt,t,l.transform,qe);let tt,wt;l.terrain&&l.terrain.prepareDrawTile(),T.activeTexture.set(S.TEXTURE0),Oe.bind(B,S.CLAMP_TO_EDGE),T.activeTexture.set(S.TEXTURE1),rt?(rt.texture&&rt.texture.bind(B,S.CLAMP_TO_EDGE),tt=Math.pow(2,rt.tileID.overscaledZ-ye.tileID.overscaledZ),wt=[ye.tileID.canonical.x*tt%1,ye.tileID.canonical.y*tt%1]):Oe.bind(B,S.CLAMP_TO_EDGE),"useMipmap"in Oe&&T.extTextureFilterAnisotropic&&l.transform.pitch>20&&S.texParameterf(S.TEXTURE_2D,T.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,T.extTextureFilterAnisotropicMax);const Tt=l.transform;let gt;const Rt=y?sm(Tt):[0,0,0,0];let Dt,kt,$t,ti,zi,Ji=0;if(v&&C instanceof o.aP&&C.coordinates.length>3)Dt=Float32Array.from(o.bh(o.dr(new o.cp(0,0,0)))),kt=Float32Array.from(Tt.globeMatrix),$t=Float32Array.from(o.dm(Tt)),ti=[o.aD(Tt.center.lng),o.aH(Tt.center.lat)],gt=C.elevatedGlobePerspectiveTransform,zi=C.elevatedGlobeGridMatrix||new Float32Array(9);else if(v){const Kt=o.dn(ie.canonical);Ji=o.dp(Kt.getCenter().lat),Dt=Float32Array.from(o.bh(o.dr(ie.canonical))),kt=Float32Array.from(Tt.globeMatrix),$t=Float32Array.from(o.dm(Tt)),ti=[o.aD(Tt.center.lng),o.aH(Tt.center.lat)],gt=[0,0],zi=Float32Array.from(o.dq(ie.canonical,Kt,Ji,Tt.worldSize/Tt._pixelsPerMercatorPixel))}else gt=C instanceof o.aP?C.perspectiveTransform:[0,0],Dt=new Float32Array(16),kt=new Float32Array(9),$t=new Float32Array(16),ti=[0,0],zi=new Float32Array(9);const Fi=ph(Ne,Dt,kt,$t,zi,wt||[0,0],o.ah(l.transform.zoom),ti,Rt,tt||1,Fe,n,gt,y?n.paint.get("raster-elevation"):0,2,ke,Ze,I.range,_e,Pe,M),Vi=l.isTileAffectedByFog(ie),Mr=l.getOrCreateProgram("raster",{defines:I.defines,overrideFog:Vi});if(l.uploadCommonUniforms(T,Mr,se),C instanceof o.aP){const Kt=C.elevatedGlobeVertexBuffer,ni=C.elevatedGlobeIndexBuffer;if(z||!m)C.boundsBuffer&&C.boundsSegments&&Mr.draw(l,S.TRIANGLES,ue,Zt.disabled,D,Nt.disabled,Fi,n.id,C.boundsBuffer,l.quadTriangleIndexBuffer,C.boundsSegments);else if(Kt&&ni){const ui=Tt.zoom<=o.cL?C.elevatedGlobeSegments:C.getSegmentsForLongitude(Tt.center.lng);ui&&Mr.draw(l,S.TRIANGLES,ue,Zt.disabled,D,J,Fi,n.id,Kt,ni,ui)}}else if(v){ue=new xt(S.LEQUAL,xt.ReadOnly,l.depthRangeFor3D);const Kt=l.globeSharedBuffers;if(Kt){const[ni,ui,nr]=Kt.getGridBuffers(Ji,!1);Mr.draw(l,S.TRIANGLES,ue,K||Se,l.colorModeForRenderPass(),J,Fi,n.id,ni,ui,nr)}}else{const{tileBoundsBuffer:Kt,tileBoundsIndexBuffer:ni,tileBoundsSegments:ui}=l.getTileBoundsBuffers(ye);Mr.draw(l,S.TRIANGLES,ue,Se,D,Nt.disabled,Fi,n.id,Kt,ni,ui)}}if(!(C instanceof o.aP)&&v)for(const ie of ee){const se=ie.canonical.y===(1<<ie.canonical.z)-1;ie.canonical.y===0&&Fl(!0,ie,l,t,n,M,I,J,K||Zt.disabled),se&&Fl(!1,ie,l,t,n,M,I,J===Nt.frontCW?Nt.backCW:Nt.frontCW,K||Zt.disabled)}};v?te(H,l.renderElevatedRasterBackface?Nt.backCW:Nt.frontCW,l.stencilModeFor3D()):te(H,Nt.disabled,void 0),l.resetStencilClippingMasks()},"raster-particle":function(l,t,n,c,d,f){l.renderPass==="offscreen"&&function(m,y,v,T){if(!T.length)return;const S=m.context,C=S.gl,I=y.getSource();if(!(I instanceof to))return;const M=Math.ceil(Math.sqrt(v.paint.get("raster-particle-count")));let D=v.particlePositionRGBAImage;if(!D||D.width!==M){const H=function(Y){const te=Y*Y,ee=new Uint8Array(4*te),J=function(ie){return ie|=0,ie=Math.imul(2747636419^ie,2654435769),ie=Math.imul(ie^ie>>>16,2654435769),((ie=Math.imul(ie^ie>>>16,2654435769))>>>0)/4294967296},K=1/1.1;for(let ie=0;ie<te;ie++){const se=K*(J(2*ie+0)+lo),ye=K*(J(2*ie+1)+lo),ve=255*se%1,Oe=255*ye%1,ke=ve,Ze=ye-Oe/255,_e=Oe;ee[4*ie+0]=255*(se-ve/255),ee[4*ie+1]=255*ke,ee[4*ie+2]=255*Ze,ee[4*ie+3]=255*_e}return ee}(M);D=v.particlePositionRGBAImage=new o.r({width:M,height:M},H)}let z=v.particleFramebuffer;z?z.width!==M&&(z.destroy(),z=v.particleFramebuffer=S.createFramebuffer(M,M,!0,null)):z=v.particleFramebuffer=S.createFramebuffer(M,M,!0,null);const O=[];for(const H of T){const Y=y.getTile(H);if(!(Y instanceof ua))continue;const te=am(Y,I,v);if(!te)continue;const ee=[Y.tileSize,Y.tileSize];let J=v.tileFramebuffer;J||(J=v.tileFramebuffer=S.createFramebuffer(ee[0],ee[1],!0,null));let K=Y.rasterParticleState;K||(K=Y.rasterParticleState=new sf(S,H,ee,D));const ie=K.update(v.lastInvalidatedAt);K.particleTextureDimension!==M&&K.updateParticleTexture(H,D);const se=K.targetColorTexture;K.targetColorTexture=K.backgroundColorTexture,K.backgroundColorTexture=se;const ye=K.particleTexture0;K.particleTexture0=K.particleTexture1,K.particleTexture1=ye,O.push([H,te,K,ie])}if(O.length===0)return;const B=o.q.now(),V=v.previousDrawTimestamp?.001*(B-v.previousDrawTimestamp):.0167;if(v.previousDrawTimestamp=B,v.hasColorMap()){S.activeTexture.set(C.TEXTURE0+2);let H=v.colorRampTexture;H||(H=v.colorRampTexture=new o.T(S,v.colorRamp,C.RGBA8)),H.bind(C.LINEAR,C.CLAMP_TO_EDGE)}S.bindFramebuffer.set(v.tileFramebuffer.framebuffer),function(H,Y,te){const ee=H.context,J=ee.gl,K=Y.tileFramebuffer;ee.activeTexture.set(J.TEXTURE0);const ie={u_texture:0,u_opacity:1.05*(ye=Y.paint.get("raster-particle-fade-opacity-factor"))/(ye+.05)},se=H.getOrCreateProgram("rasterParticleTexture",{defines:[],overrideFog:!1});var ye;for(const ve of te){const[,,Oe,ke]=ve;K.colorAttachment.set(Oe.targetColorTexture.texture),ee.viewport.set([0,0,K.width,K.height]),ee.clear({color:o.am.transparent}),ke&&(Oe.backgroundColorTexture.bind(J.NEAREST,J.CLAMP_TO_EDGE),se.draw(H,J.TRIANGLES,xt.disabled,Zt.disabled,oi.alphaBlended,Nt.disabled,ie,Y.id,H.viewportBuffer,H.quadTriangleIndexBuffer,H.viewportSegments))}}(m,v,O),function(H,Y,te,ee){const J=H.context,K=J.gl,ie=te.tileFramebuffer,se=H.transform.projection.name==="globe",ye=te.paint.get("raster-particle-max-speed");for(const ve of ee){const[Oe,ke,Ze]=ve;J.activeTexture.set(K.TEXTURE0+0),ke.texture.bind(K.LINEAR,K.CLAMP_TO_EDGE),ie.colorAttachment.set(Ze.targetColorTexture.texture);const _e=H.getOrCreateProgram("rasterParticleDraw",{defines:ke.defines,overrideFog:!1});J.activeTexture.set(K.TEXTURE0+1);const Pe=ke.scalarData?[]:[0,1,2,3].map(Se=>o.dT[Se](Oe));Pe.push(Oe);const ue=Oe.canonical.x,Ne=Oe.canonical.y;for(const Se of Pe){const qe=Y.getTile(se?Se.wrapped():Se);if(!qe)continue;const rt=qe.rasterParticleState;if(!rt)continue;const Fe=Se.canonical.x+(1<<Se.canonical.z)*(Se.wrap-Oe.wrap),tt=Se.canonical.y;rt.particleTexture0.bind(K.NEAREST,K.CLAMP_TO_EDGE);const wt=Jd(1,rt.particleTexture0.size[0],[Fe-ue,tt-Ne],0,ke.texture.size,2,ye,ke.textureOffset,ke.scale,ke.offset);_e.draw(H,K.POINTS,xt.disabled,Zt.disabled,oi.alphaBlended,Nt.disabled,wt,te.id,rt.particleIndexBuffer,void 0,rt.particleSegment)}}}(m,y,v,O),S.bindFramebuffer.set(v.particleFramebuffer.framebuffer),function(H,Y,te,ee){const J=H.context,K=J.gl,ie=Y.paint.get("raster-particle-max-speed"),se=ee*Y.paint.get("raster-particle-speed-factor")*.15,ye=function(Oe){return Math.pow(Oe,6)}(.01+1*Y.paint.get("raster-particle-reset-rate-factor")),ve=Y.particleFramebuffer;J.viewport.set([0,0,ve.width,ve.height]);for(const Oe of te){const[,ke,Ze]=Oe;J.activeTexture.set(K.TEXTURE0+0),ke.texture.bind(K.LINEAR,K.CLAMP_TO_EDGE),J.activeTexture.set(K.TEXTURE0+1);const _e=Ze.particleTexture0;_e.bind(K.NEAREST,K.CLAMP_TO_EDGE);const Pe=co(1,_e.size[0],0,ke.texture.size,ie,se,ye,ke.textureOffset,ke.scale,ke.offset);ve.colorAttachment.set(Ze.particleTexture1.texture),J.clear({color:o.am.transparent}),H.getOrCreateProgram("rasterParticleUpdate",{defines:ke.defines}).draw(H,K.TRIANGLES,xt.disabled,Zt.disabled,oi.unblended,Nt.disabled,Pe,Y.id,H.viewportBuffer,H.quadTriangleIndexBuffer,H.viewportSegments)}}(m,v,O,V)}(l,t,n,c),l.renderPass==="translucent"&&(function(m,y,v,T,S){const C=m.context,I=C.gl,M=y.getSource().tileSize,D=5*(1-o.af(o.cx,o.cx+1,m.transform.zoom))*M+v.paint.get("raster-particle-elevation"),z=!m.options.moving,O=m.transform.projection.name==="globe";if(!T.length)return;const[B,V]=m.stencilConfigForOverlap(T),H=[];O&&H.push("PROJECTION_GLOBE_VIEW");const Y=m.stencilModeFor3D();for(const te of V){const ee=te.toUnwrapped(),J=y.getTile(te);if(!J.rasterParticleState)continue;const K=J.rasterParticleState,ie=100;J.registerFadeDuration(ie);const se=y.findLoadedParent(te,0),ye=Ho(J,se,y,m.transform,ie);let ve,Oe;m.terrain&&m.terrain.prepareDrawTile(),C.activeTexture.set(I.TEXTURE0),K.targetColorTexture.bind(I.LINEAR,I.CLAMP_TO_EDGE),C.activeTexture.set(I.TEXTURE1),se&&se.rasterParticleState?(se.rasterParticleState.targetColorTexture.bind(I.LINEAR,I.CLAMP_TO_EDGE),ve=Math.pow(2,se.tileID.overscaledZ-J.tileID.overscaledZ),Oe=[J.tileID.canonical.x*ve%1,J.tileID.canonical.y*ve%1]):K.targetColorTexture.bind(I.LINEAR,I.CLAMP_TO_EDGE);const ke=O?Float32Array.from(m.transform.expandedFarZProjMatrix):m.transform.calculateProjMatrix(ee,z),Ze=m.transform,_e=of(Ze),Pe=o.dn(te.canonical),ue=o.dp(Pe.getCenter().lat);let Ne,Se,qe,rt,Fe;O?(Ne=Float32Array.from(o.bh(o.dr(te.canonical))),Se=Float32Array.from(Ze.globeMatrix),qe=Float32Array.from(o.dm(Ze)),rt=[o.aD(Ze.center.lng),o.aH(Ze.center.lat)],Fe=Float32Array.from(o.dq(te.canonical,Pe,ue,Ze.worldSize/Ze._pixelsPerMercatorPixel))):(Ne=new Float32Array(16),Se=new Float32Array(9),qe=new Float32Array(16),rt=[0,0],Fe=new Float32Array(9));const tt=Xo(ke,Ne,Se,qe,Fe,Oe||[0,0],o.ah(m.transform.zoom),rt,_e,ve||1,ye,D),wt=m.isTileAffectedByFog(te),Tt=m.getOrCreateProgram("rasterParticle",{defines:H,overrideFog:wt});if(m.uploadCommonUniforms(C,Tt,ee),O){const gt=new xt(I.LEQUAL,xt.ReadOnly,m.depthRangeFor3D),Rt=0,Dt=m.globeSharedBuffers;if(Dt){const[kt,$t,ti]=Dt.getGridBuffers(ue,Rt!==0);Tt.draw(m,I.TRIANGLES,gt,Y,oi.alphaBlended,m.renderElevatedRasterBackface?Nt.frontCCW:Nt.backCCW,tt,v.id,kt,$t,ti)}}else{const gt=m.depthModeForSublayer(0,xt.ReadOnly),Rt=B[te.overscaledZ],{tileBoundsBuffer:Dt,tileBoundsIndexBuffer:kt,tileBoundsSegments:$t}=m.getTileBoundsBuffers(J);Tt.draw(m,I.TRIANGLES,gt,Rt,oi.alphaBlended,Nt.disabled,tt,v.id,Dt,kt,$t)}}m.resetStencilClippingMasks()}(l,t,n,c),l.style.map.triggerRepaint())},background:function(l,t,n,c){const d=n.paint.get("background-color"),f=n.paint.get("background-color-use-theme").constantOr("default")==="none",m=n.paint.get("background-opacity"),y=n.paint.get("background-emissive-strength"),v=n.paint.get("background-pitch-alignment")==="viewport";if(m===0)return;const T=l.context,S=T.gl,C=l.transform,I=C.tileSize,M=n.paint.get("background-pattern");let D;if(M!==void 0&&(M===null||(D=l.imageManager.getPattern(o.I.from(M.toString()),n.scope,l.style.getLut(n.scope)),!D)))return;const z=!M&&d.a===1&&m===1&&l.opaquePassEnabledForLayer()?"opaque":"translucent";if(l.renderPass!==z)return;const O=Zt.disabled,B=l.depthModeForSublayer(0,z==="opaque"?xt.ReadWrite:xt.ReadOnly),V=l.colorModeForDrapableLayerRenderPass(y),H=M?"backgroundPattern":"background";let Y,te=c;if(te||(Y=l.getBackgroundTiles(),te=Object.values(Y).map(ee=>ee.tileID)),M&&(T.activeTexture.set(S.TEXTURE0),l.imageManager.bind(l.context,n.scope)),v){const ee=l.getOrCreateProgram(H,{overrideFog:!1,overrideRtt:!0}),J=new Float32Array(o.bx([])),K=new o.aM(0,0,0,0,0),ie=M?_h(J,y,m,l,0,n.scope,D,v,{tileID:K,tileSize:I}):mh(J,y,m,d.toPremultipliedRenderColor(f?null:n.lut));ee.draw(l,S.TRIANGLES,B,O,V,Nt.disabled,ie,n.id,l.viewportBuffer,l.quadTriangleIndexBuffer,l.viewportSegments)}else for(const ee of te){const J=l.isTileAffectedByFog(ee),K=l.getOrCreateProgram(H,{overrideFog:J}),ie=ee.toUnwrapped(),se=c?ee.projMatrix:l.transform.calculateProjMatrix(ie);l.prepareDrawTile();const ye=t?t.getTile(ee):Y?Y[ee.key]:new Lo(ee,I,C.zoom,l),ve=M?_h(se,y,m,l,0,n.scope,D,v,{tileID:ee,tileSize:I}):mh(se,y,m,d.toPremultipliedRenderColor(f?null:n.lut));l.uploadCommonUniforms(T,K,ie);const{tileBoundsBuffer:Oe,tileBoundsIndexBuffer:ke,tileBoundsSegments:Ze}=l.getTileBoundsBuffers(ye);K.draw(l,S.TRIANGLES,B,O,V,Nt.disabled,ve,n.id,Oe,ke,Ze)}},sky:function(l,t,n){const c=l._atmosphere?o.ah(l.transform.zoom):1,d=n.paint.get("sky-opacity")*c;if(d===0)return;const f=l.context,m=n.paint.get("sky-type"),y=new xt(f.gl.LEQUAL,xt.ReadOnly,[0,1]),v=l.frameCounter/1e3%1;m==="atmosphere"?l.renderPass==="offscreen"?n.needsSkyboxCapture(l)&&(function(T,S,C,I){const M=T.context,D=M.gl;let z=S.skyboxFbo;if(!z){z=S.skyboxFbo=M.createFramebuffer(32,32,!0,null),S.skyboxGeometry=new Bl(M),S.skyboxTexture=M.gl.createTexture(),D.bindTexture(D.TEXTURE_CUBE_MAP,S.skyboxTexture),D.texParameteri(D.TEXTURE_CUBE_MAP,D.TEXTURE_WRAP_S,D.CLAMP_TO_EDGE),D.texParameteri(D.TEXTURE_CUBE_MAP,D.TEXTURE_WRAP_T,D.CLAMP_TO_EDGE),D.texParameteri(D.TEXTURE_CUBE_MAP,D.TEXTURE_MIN_FILTER,D.LINEAR),D.texParameteri(D.TEXTURE_CUBE_MAP,D.TEXTURE_MAG_FILTER,D.LINEAR);for(let H=0;H<6;++H)D.texImage2D(D.TEXTURE_CUBE_MAP_POSITIVE_X+H,0,D.RGBA,32,32,0,D.RGBA,D.UNSIGNED_BYTE,null)}M.bindFramebuffer.set(z.framebuffer),M.viewport.set([0,0,32,32]);const O=S.getCenter(T,!0),B=T.getOrCreateProgram("skyboxCapture"),V=new Float64Array(16);o.bx(V),o.e3(V,V,.5*-Math.PI),fo(T,S,B,V,O,0),o.bx(V),o.e3(V,V,.5*Math.PI),fo(T,S,B,V,O,1),o.bx(V),o.cG(V,V,.5*-Math.PI),fo(T,S,B,V,O,2),o.bx(V),o.cG(V,V,.5*Math.PI),fo(T,S,B,V,O,3),o.bx(V),fo(T,S,B,V,O,4),o.bx(V),o.e3(V,V,Math.PI),fo(T,S,B,V,O,5),M.viewport.set([0,0,T.width,T.height])}(l,n),n.markSkyboxValid(l)):l.renderPass==="sky"&&function(T,S,C,I,M){const D=T.context,z=D.gl,O=T.transform,B=T.getOrCreateProgram("skybox");D.activeTexture.set(z.TEXTURE0),z.bindTexture(z.TEXTURE_CUBE_MAP,S.skyboxTexture);const V=((H,Y,te,ee,J)=>({u_matrix:H,u_sun_direction:Y,u_cubemap:0,u_opacity:ee,u_temporal_offset:J}))(O.skyboxMatrix,S.getCenter(T,!1),0,I,M);T.uploadCommonUniforms(D,B),B.draw(T,z.TRIANGLES,C,Zt.disabled,T.colorModeForRenderPass(),Nt.backCW,V,"skybox",S.skyboxGeometry.vertexBuffer,S.skyboxGeometry.indexBuffer,S.skyboxGeometry.segment)}(l,n,y,d,v):m==="gradient"&&l.renderPass==="sky"&&function(T,S,C,I,M){const D=T.context,z=D.gl,O=T.transform,B=T.getOrCreateProgram("skyboxGradient");S.skyboxGeometry||(S.skyboxGeometry=new Bl(D)),D.activeTexture.set(z.TEXTURE0);let V=S.colorRampTexture;V||(V=S.colorRampTexture=new o.T(D,S.colorRamp,z.RGBA8)),V.bind(z.LINEAR,z.CLAMP_TO_EDGE);const H=((Y,te,ee,J,K)=>({u_matrix:Y,u_color_ramp:0,u_center_direction:te,u_radius:o.al(ee),u_opacity:J,u_temporal_offset:K}))(O.skyboxMatrix,S.getCenter(T,!1),S.paint.get("sky-gradient-radius"),I,M);T.uploadCommonUniforms(D,B),B.draw(T,z.TRIANGLES,C,Zt.disabled,T.colorModeForRenderPass(),Nt.backCW,H,"skyboxGradient",S.skyboxGeometry.vertexBuffer,S.skyboxGeometry.indexBuffer,S.skyboxGeometry.segment)}(l,n,y,d,v)},custom:function(l,t,n,c){const d=l.context,f=n.implementation;if(!l.transform.projection.unsupportedLayers||!l.transform.projection.unsupportedLayers.includes("custom")||l.terrain&&(l.terrain.renderingToTexture||l.renderPass==="offscreen")&&n.isDraped(t)){if(l.renderPass==="offscreen"){const m=f.prerender;if(m){if(l.setCustomLayerDefaults(),d.setColorMode(l.colorModeForRenderPass()),l.transform.projection.name==="globe"){const y=l.transform.pointMerc;m.call(f,d.gl,l.transform.customLayerMatrix(),l.transform.getProjection(),l.transform.globeToMercatorMatrix(),o.ah(l.transform.zoom),[y.x,y.y],l.transform.pixelsPerMeterRatio)}else m.call(f,d.gl,l.transform.customLayerMatrix());d.setDirty(),l.setBaseState()}}else if(l.renderPass==="translucent"){if(l.terrain&&l.terrain.renderingToTexture){const y=f.renderToTile;if(y){const v=c[0].canonical,T={x:v.x+c[0].wrap*(f.wrapTileId?0:1<<v.z),y:v.y,z:v.z};d.setDepthMode(xt.disabled),d.setStencilMode(Zt.disabled),d.setColorMode(l.colorModeForRenderPass()),l.setCustomLayerDefaults(),y.call(f,d.gl,T),d.setDirty(),l.setBaseState()}return}l.setCustomLayerDefaults(),d.setColorMode(l.colorModeForRenderPass()),d.setStencilMode(Zt.disabled);const m=f.renderingMode==="3d"?new xt(l.context.gl.LEQUAL,xt.ReadWrite,l.depthRangeFor3D):l.depthModeForSublayer(0,xt.ReadOnly);if(d.setDepthMode(m),l.transform.projection.name==="globe"){const y=l.transform.pointMerc;f.render(d.gl,l.transform.customLayerMatrix(),l.transform.getProjection(),l.transform.globeToMercatorMatrix(),o.ah(l.transform.zoom),[y.x,y.y],l.transform.pixelsPerMeterRatio)}else f.render(d.gl,l.transform.customLayerMatrix());d.setDirty(),l.setBaseState(),d.bindFramebuffer.set(null)}}else o.w("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")},model:function(l,t,n,c){if(l.renderPass==="opaque")return;const d=n.paint.get("model-opacity").constantOr(1);if(d===0)return;const f=n.paint.get("model-cast-shadows");if(l.renderPass==="shadow"&&(!f||l.terrain&&d<.65&&n._transitionablePaint._values["model-opacity"].value.expression instanceof o.ab))return;const m=l.shadowRenderer,y=n.paint.get("model-receive-shadows");m&&(m.useNormalOffset=!0,y||(m.enabled=!1));const v=()=>{m&&(m.useNormalOffset=!0,y||(m.enabled=!0))},T=t.getSource();if(l.renderPass==="light-beam"&&T.type!=="batched-model")return;if(T.type==="vector"||T.type==="geojson")return function(B,V,H,Y,te){const ee=B.transform;if(ee.projection.name!=="mercator")return void o.w(`Drawing 3D models for ${ee.projection.name} projection is not yet implemented`);const J=ee.getFreeCameraOptions().position;if(!B.modelManager)return;const K=B.modelManager;H.modelManager=K;const ie=B.shadowRenderer;if(!H._unevaluatedLayout._values.hasOwnProperty("model-id"))return;const se=H._unevaluatedLayout._values["model-id"],ye=Object.assign({},H.layout.get("model-id").parameters),ve=B.style.order.indexOf(H.fqid);for(const Oe of Y){const ke=V.getTile(Oe).getBucket(H);if(!ke||ke.projection.name!==ee.projection.name)continue;const Ze=ke.getModelUris();Ze&&!ke.modelsRequested&&(K.addModelsFromBucket(Ze,te),ke.modelsRequested=!0);const _e=Kc(Oe,ee);ye.zoom=_e;const Pe=se.possiblyEvaluate(ye);if(ge(B,ke,Oe),ls.shadowUniformsInitialized=!1,ls.useSingleShadowCascade=!!ie&&ie.getMaxCascadeForTile(Oe.toUnwrapped())===0,B.renderPass==="shadow"&&ie){if(B.currentShadowCascade===1&&ke.isInsideFirstShadowMapFrustum)continue;const Se=ee.calculatePosMatrix(Oe.toUnwrapped(),ee.worldSize);if(ls.tileMatrix.set(Se),ls.shadowTileMatrix=Float32Array.from(ie.calculateShadowPassMatrixFromMatrix(Se)),ls.aabb.min.fill(0),ls.aabb.max[0]=ls.aabb.max[1]=o.aj,ls.aabb.max[2]=0,hf(ke,ls,B,H.scope))continue}const ue=1<<Oe.canonical.z,Ne=[((J.x-Oe.wrap)*ue-Oe.canonical.x)*o.aj,(J.y*ue-Oe.canonical.y)*o.aj,J.z*ue*o.aj];B.conflationActive&&Object.keys(ke.instancesPerModel).length>0&&B.style.isLayerClipped(H,V.getSource())&&ke.updateReplacement(Oe,B.replacementSource,ve,te)&&(ke.uploaded=!1,ke.upload(B.context));for(let Se in ke.instancesPerModel){const qe=ke.instancesPerModel[Se];qe.features.length>0&&(Se=Pe.evaluate(qe.features[0].feature,{}));const rt=K.getModel(Se,te);if(rt||K.hasURLBeenRequested(Se)||ke.modelUris.includes(Se)||(ke.modelUris.push(Se),ke.modelsRequested=!1),rt&&rt.uploaded)for(const Fe of rt.nodes)Jc(B,H,Fe,qe,Ne,Oe,ls)}}}(l,t,n,c,T.type==="vector"?n.scope:""),void v();if(!T.loaded())return;if(T.type==="batched-model")return function(B,V,H,Y){H.resetLayerRenderingStats(B);const te=B.context,ee=B.transform,J=B.style.fog,K=B.shadowRenderer;if(ee.projection.name!=="mercator")return void o.w(`Drawing 3D landmark models for ${ee.projection.name} projection is not yet implemented`);const ie=B.transform.getFreeCameraOptions().position,se=o.bY([],[ie.x,ie.y,ie.z],B.transform.worldSize),ye=o.eb([],se),ve=o.bx([]),Oe=o.ec(ee.center.lat,ee.zoom),ke=o.bn([],[1,1,1/Oe]);o.bo(ve,ve,ye);const Ze=H.paint.get("model-opacity").constantOr(1),_e=new xt(te.gl.LEQUAL,xt.ReadWrite,B.depthRangeFor3D),Pe=new xt(te.gl.LEQUAL,xt.ReadOnly,B.depthRangeFor3D),ue=new o.cW([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),Ne=B.renderPass==="shadow",Se=Ne&&K?K.getCurrentCascadeFrustum():ee.getFrustum(ee.scaleZoom(ee.worldSize)),qe=H.paint.get("model-front-cutoff"),rt=qe[2]<1,Fe=_s(B,H.paint.get("model-cutoff-fade-range")),tt=H.getLayerRenderingStats();(function(wt,Tt,gt,Rt){const Dt=wt.terrain?wt.terrain.exaggeration():0,kt=wt.transform.zoom;for(const $t of Rt){const ti=Tt.getTile($t).getBucket(gt);ti&&(ti.setFilter(gt.filter),wt.conflationActive&&ti.updateReplacement($t,wt.replacementSource),ti.evaluateTransform(wt,gt),wt.terrain&&Dt>0&&ti.elevationUpdate(wt.terrain,Dt,$t,gt.source),ti.needsReEvaluation(wt,kt,gt)&&ti.evaluate(gt))}})(B,V,H,Y),function(){let wt,Tt,gt;rt?(wt=Y.length-1,Tt=-1,gt=-1):(wt=0,Tt=Y.length,gt=1);const Rt=new Float64Array(16),Dt=o.ef(),kt=new o.P(0,0);for(let $t=wt;$t!==Tt;$t+=gt){const ti=Y[$t],zi=V.getTile(ti).getBucket(H);if(!zi||!zi.uploaded)continue;let Ji=!1;K&&(Ji=K.getMaxCascadeForTile(ti.toUnwrapped())===0);const Fi=ee.calculatePosMatrix(ti.toUnwrapped(),ee.worldSize),Vi=zi.modelTraits;!Ne&&rt&&(o.bi(Rt,Fi),o.ad(Dt,se,Rt),kt.x=Dt[0],kt.y=Dt[1]);const Mr=[];zi.setFilter(H.filter);for(const Kt of zi.getNodesInfo()){if(Kt.hiddenByReplacement||!Kt.node.meshes)continue;const ni=Kt.node;let ui=0;B.terrain&&ni.elevation&&(ui=ni.elevation*B.terrain.exaggeration());const nr=(()=>{const Sr=Kt.aabb;return ue.min=[...Sr.min],ue.max=[...Sr.max],ue.min[2]+=ui,ue.max[2]+=ui,o.ad(ue.min,ue.min,Fi),o.ad(ue.max,ue.max,Fi),ue})(),Vr=Kt.evaluatedScale;if(Vr[0]<=1&&Vr[1]<=1&&Vr[2]<=1&&nr.intersects(Se)===0)continue;if(!Ne&&rt){const Sr=.16666666666666666;Kt.cameraCollisionOpacity=se[0]>nr.min[0]&&se[0]<nr.max[0]&&se[1]>nr.min[1]&&se[1]<nr.max[1]&&se[2]*Oe<nr.max[2]&&ni.footprint&&o.bS(kt,ni.footprint)?Math.max(Kt.cameraCollisionOpacity-Sr,0):Math.min(1,Kt.cameraCollisionOpacity+Sr)}const Qi=[...Fi],Ai=1/o.cU(ti.canonical),wr=ni.anchor?ni.anchor[0]:0,mi=ni.anchor?ni.anchor[1]:0;o.bo(Qi,Qi,[wr*(Vr[0]-1)+Kt.evaluatedTranslation[0]*Ai,mi*(Vr[1]-1)+Kt.evaluatedTranslation[1]*Ai,ui+Kt.evaluatedTranslation[2]]),o.ci(Vr,o.eg)||o.cE(Qi,Qi,Vr);const Fr=o.az([],Qi,ni.matrix),sr=o.az([],ee.expandedFarZProjMatrix,Fr),Wi=o.az([],ee.expandedFarZProjMatrix,Qi),or=o.aA([],[wr,mi,ui,1],sr)[2];ni.hidden=!1;let Mi=Ze;Ne||(rt&&(Mi*=Kt.cameraCollisionOpacity,Mi*=Da(Qi,ee,Kt.aabb,qe)),Mi*=df(Fe,or)),Mi!==0?Mr.push({nodeInfo:Kt,depth:or,opacity:Mi,wvpForNode:sr,wvpForTile:Wi,nodeModelMatrix:Fr,tileModelMatrix:Qi}):ni.hidden=!0}Ne||Mr.sort((Kt,ni)=>!rt||Kt.opacity===1&&ni.opacity===1?Kt.depth<ni.depth?-1:1:Kt.opacity===1?-1:ni.opacity===1?1:Kt.depth>ni.depth?-1:1);for(const Kt of Mr){const ni=Kt.nodeInfo,ui=ni.node;let nr=o.az([],ke,Kt.tileModelMatrix);o.az(nr,ve,nr);const Vr=o.bi([],nr);o.ee(Vr,Vr),o.cE(Vr,Vr,wh),nr=o.az(nr,nr,ui.matrix);const Qi=B.renderPass==="light-beam",Ai=H.paint.get("model-color-use-theme").constantOr("default")==="none",wr=Vi&o.em.HasMapboxMeshFeatures,mi=wr?0:ni.evaluatedRMEA[0][2];for(let Fr=0;Fr<ui.meshes.length;++Fr){const sr=ui.meshes[Fr],Wi=Fr===ui.lightMeshIndex;let or=Kt.wvpForNode;if(Wi){if(!Qi&&!B.terrain&&B.shadowRenderer){B.currentLayer<B.firstLightBeamLayer&&(B.firstLightBeamLayer=B.currentLayer);continue}or=Kt.wvpForTile}else if(Qi)continue;const Mi={defines:[]},Sr=[];if(!Ne&&K&&(K.useNormalOffset=!!sr.normalBuffer),Je(Mi.defines,Sr,sr,B,Ai?null:H.lut),wr||Mi.defines.push("DIFFUSE_SHADED"),Ji&&Mi.defines.push("SHADOWS_SINGLE_CASCADE"),tt&&(Ne?tt.numRenderedVerticesInShadowPass+=sr.vertexArray.length:tt.numRenderedVerticesInTransparentPass+=sr.vertexArray.length),Ne){br(sr,Kt.nodeModelMatrix,B,H);continue}let tn=null;if(J){const us=Ko(Kt.nodeModelMatrix,B.transform);if(tn=new Float32Array(us),ee.projection.name!=="globe"){const ts=sr.aabb.min,Cn=sr.aabb.max,[vo,hs]=J.getOpacityForBounds(us,ts[0],ts[1],Cn[0],Cn[1]);Mi.overrideFog=vo>=Ie||hs>=Ie}}const dr=sr.material;let Ti;dr.occlusionTexture&&dr.occlusionTexture.offsetScale&&(Ti=dr.occlusionTexture.offsetScale,Mi.defines.push("OCCLUSION_TEXTURE_TRANSFORM"));const kn=B.getOrCreateProgram("model",Mi);!Ne&&K&&K.setupShadowsFromMatrix(Kt.tileModelMatrix,kn,K.useNormalOffset),B.uploadCommonUniforms(te,kn,null,tn);const An=dr.pbrMetallicRoughness;An.metallicFactor=.9,An.roughnessFactor=.5;const Hn=Dl(new Float32Array(or),new Float32Array(nr),new Float32Array(Vr),new Float32Array(ui.matrix),B,Kt.opacity,An.baseColorFactor,dr.emissiveFactor,An.metallicFactor,An.roughnessFactor,dr,mi,H,[0,0,0],Ti);!Wi&&(ni.hasTranslucentParts||Kt.opacity<1)&&kn.draw(B,te.gl.TRIANGLES,_e,Zt.disabled,oi.disabled,Nt.backCCW,Hn,H.id,sr.vertexBuffer,sr.indexBuffer,sr.segments,H.paint,B.transform.zoom,void 0,Sr),kn.draw(B,te.gl.TRIANGLES,Wi?Pe:_e,Zt.disabled,Wi||Kt.opacity<1||ni.hasTranslucentParts?oi.alphaBlended:oi.unblended,Nt.backCCW,Hn,H.id,sr.vertexBuffer,sr.indexBuffer,sr.segments,H.paint,B.transform.zoom,void 0,Sr)}}}}()}(l,t,n,c),void v();if(T.type!=="model")return;const S=T.getModels(),C=[],I=l.transform.getFreeCameraOptions().position,M=o.bY([],[I.x,I.y,I.z],l.transform.worldSize);o.eb(M,M);const D=[],z=[];let O=0;for(const B of S){const V=n.paint.get("model-rotation").constantOr(null),H=n.paint.get("model-scale").constantOr(null),Y=n.paint.get("model-translation").constantOr(null);B.computeModelMatrix(l,V,H,Y,!0,!0,!1);const te=o.bx([]),ee=o.ec(B.position.lat,l.transform.zoom),J=o.bn([],[1,1,1/ee]);o.bo(te,te,M),C.push({zScaleMatrix:J,negCameraPosMatrix:te});for(const K of B.nodes)Jo(l.transform,K,B.matrix,l.transform.expandedFarZProjMatrix,O,D,z);O++}if(D.sort((B,V)=>V.depth-B.depth),l.renderPass!=="shadow"){if(d===1)for(const B of z)_t(B,l,n,C[B.modelIndex],Zt.disabled,l.colorModeForRenderPass());else{for(const B of z)_t(B,l,n,C[B.modelIndex],Zt.disabled,oi.disabled);for(const B of z)_t(B,l,n,C[B.modelIndex],l.stencilModeFor3D(),l.colorModeForRenderPass());l.resetStencilClippingMasks()}for(const B of D)_t(B,l,n,C[B.modelIndex],Zt.disabled,l.colorModeForRenderPass());v()}else{for(const B of z)br(B.mesh,B.nodeModelMatrix,l,n);for(const B of D)br(B.mesh,B.nodeModelMatrix,l,n);v()}}},Ih={line:function(l,t,n){if(l.hasElevatedBuckets=!1,l.hasNonElevatedBuckets=!1,l._unevaluatedLayout.getValue("line-elevation-reference")!==void 0||l._unevaluatedLayout.getValue("line-z-offset")!==void 0){if(t){const c=t.getVisibleCoordinates();for(const d of c){const f=t.getTile(d).getBucket(l);if(f&&(f.elevationType!=="none"?l.hasElevatedBuckets=!0:l.hasNonElevatedBuckets=!0,l.hasElevatedBuckets&&l.hasNonElevatedBuckets))break}}}else l.hasNonElevatedBuckets=!0},model:function(l,t,n){const c=t.getSource();if(!c.loaded())return;if(c.type==="vector"||c.type==="geojson")return void(n.modelManager&&n.modelManager.upload(n,c.type==="vector"?l.scope:""));if(c.type==="batched-model"||c.type!=="model")return;const d=c.getModels();for(const f of d)f.upload(n.context)},raster:function(l,t,n){const c=t.getSource();if(!(c instanceof to&&c.loaded()))return;const d=l.sourceLayer||c.rasterLayerIds&&c.rasterLayerIds[0];if(!d)return;const f=l.paint.get("raster-array-band")||c.getInitialBand(d);if(f==null)return;const m=t.getIds().map(y=>t.getTileByID(y));for(const y of m)y.updateNeeded(d,f)&&c.prepareTile(y,d,f)},"raster-particle":function(l,t,n){const c=t.getSource();if(!(c instanceof to&&c.loaded()))return;const d=l.sourceLayer||c.rasterLayerIds&&c.rasterLayerIds[0];if(!d)return;const f=l.paint.get("raster-particle-array-band")||c.getInitialBand(d);if(f==null)return;const m=t.getIds().map(y=>t.getTileByID(y));for(const y of m)y.updateNeeded(d,f)&&c.prepareTile(y,d,f)}},Ns={fill:yh},Ul={fill:function(l,t,n,c){if(!n.layout||n.layout.get("fill-elevation-reference")==="none")return;const d=l.context.gl,f=new xt(d.LEQUAL,xt.ReadOnly,l.depthRangeFor3D),m=new Zt({func:d.ALWAYS,mask:255},255,255,d.KEEP,d.KEEP,d.REPLACE),y=l.transform.getFreeCameraOptions().position,v=l.getOrCreateProgram("elevatedStructuresDepthReconstruct",{defines:["DEPTH_RECONSTRUCTION"]});for(const T of c){const S=t.getTile(T),C=S.getBucket(n);if(!C)continue;const I=C.elevatedStructures;if(!I||I.maskSegments.segments[0].primitiveLength===0)continue;const M=Wc(T.toUnwrapped(),y),D=l.translatePosMatrix(T.projMatrix,S,n.paint.get("fill-translate"),n.paint.get("fill-translate-anchor")),z=qc(D,M,0,0,0);v.draw(l,d.TRIANGLES,f,m,oi.disabled,Nt.disabled,z,n.id,I.vertexBuffer,I.indexBuffer,I.maskSegments,n.paint,l.transform.zoom)}}};class Oa{constructor(t,n,c,d,f,m){this.context=new nm(t,n),this.transform=c,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.tp=f,this._timeStamp=o.q.now(),this._averageFPS=0,this._fpsHistory=[],this._dt=0,this._debugParams={forceEnablePrecipitation:!1,showTerrainProxyTiles:!1,fpsWindow:30,continousRedraw:!1,enabledLayers:{}};const y=["fill","line","symbol","circle","heatmap","fill-extrusion","building","raster","raster-particle","hillshade","model","background","sky"];for(const T of y)this._debugParams.enabledLayers[T]=!0;f.registerParameter(this._debugParams,["Terrain"],"showTerrainProxyTiles",{},()=>{this.style.map.triggerRepaint()}),f.registerParameter(this._debugParams,["Precipitation"],"forceEnablePrecipitation"),f.registerParameter(this._debugParams,["FPS"],"fpsWindow",{min:1,max:100,step:1}),f.registerBinding(this._debugParams,["FPS"],"continousRedraw",{readonly:!0,label:"continuous redraw"}),f.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"value"}),f.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"graph",view:"graph",min:0,max:200});for(const T of y)f.registerParameter(this._debugParams.enabledLayers,["Debug","Layers"],T);this.occlusionParams=new ff(f),this.setup(),this.numSublayers=En.maxUnderzooming+En.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this.conflationActive=!1,this.replacementSource=new o.et,this.longestCutoffRange=0,this.minCutoffZoom=0,this._fogVisible=!1,this._cachedTileFogOpacities={},this._shadowRenderer=new Fp(this),this._wireframeDebugCache=new dm,this.renderDefaultNorthPole=!0,this.renderDefaultSouthPole=!0,this.layersWithOcclusionOpacity=[];const v=new o.r({width:1,height:1},Uint8Array.of(0,0,0,0));this.emptyDepthTexture=new o.T(this.context,v,t.RGBA8),this._clippingActiveLastFrame=!1,this.scaleFactor=d,this.worldview=m}updateTerrain(t,n){const c=!!t&&!!t.terrain&&this.transform.projection.supportsTerrain;if(!(c||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new Ml(this,t));const d=this._terrain;this.transform.elevation=c?d:null,d.update(t,this.transform,n),this.transform.elevation&&!d.enabled&&(this.transform.elevation=null)}_updateFog(t){const n=t.fog;if(!n||this.transform.projection.name==="globe"||n.getOpacity(this.transform.pitch)<1||n.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);const[c,d]=n.getFovAdjustedRange(this.transform._fov);if(c>d)return void(this.transform.fogCullDistSq=null);const f=c+.78*(d-c);this.transform.fogCullDistSq=f*f}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled||this._forceTerrainMode?this._terrain:null}get forceTerrainMode(){return this._forceTerrainMode}set forceTerrainMode(t){t&&!this._terrain&&(this._terrain=new Ml(this,this.style)),this._forceTerrainMode=t}get shadowRenderer(){return this._shadowRenderer&&this._shadowRenderer.enabled?this._shadowRenderer:null}get wireframeDebugCache(){return this._wireframeDebugCache}resize(t,n){if(this.width=t*o.q.devicePixelRatio,this.height=n*o.q.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const c of this.style.order)this.style._mergedLayers[c].resize()}setup(){const t=this.context,n=new o.ba;n.emplaceBack(0,0),n.emplaceBack(o.aj,0),n.emplaceBack(0,o.aj),n.emplaceBack(o.aj,o.aj),this.tileExtentBuffer=t.createVertexBuffer(n,o.bc.members),this.tileExtentSegments=o.bd.simpleSegment(0,0,4,2);const c=new o.ba;c.emplaceBack(0,0),c.emplaceBack(o.aj,0),c.emplaceBack(0,o.aj),c.emplaceBack(o.aj,o.aj),this.debugBuffer=t.createVertexBuffer(c,o.bc.members),this.debugSegments=o.bd.simpleSegment(0,0,4,5);const d=new o.ba;d.emplaceBack(-1,-1),d.emplaceBack(1,-1),d.emplaceBack(-1,1),d.emplaceBack(1,1),this.viewportBuffer=t.createVertexBuffer(d,o.bc.members),this.viewportSegments=o.bd.simpleSegment(0,0,4,2);const f=new o.aZ;f.emplaceBack(0,0,0,0),f.emplaceBack(o.aj,0,o.aj,0),f.emplaceBack(0,o.aj,0,o.aj),f.emplaceBack(o.aj,o.aj,o.aj,o.aj),this.mercatorBoundsBuffer=t.createVertexBuffer(f,o.bf.members),this.mercatorBoundsSegments=o.bd.simpleSegment(0,0,4,2);const m=new o.a_;m.emplaceBack(0,1,2),m.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=t.createIndexBuffer(m);const y=new o.bb;for(const T of[0,1,3,2,0])y.emplaceBack(T);this.debugIndexBuffer=t.createIndexBuffer(y),this.emptyTexture=new o.T(t,new o.r({width:1,height:1},Uint8Array.of(0,0,0,0)),t.gl.RGBA8),this.identityMat=o.bz();const v=this.context.gl;this.stencilClearMode=new Zt({func:v.ALWAYS,mask:0},0,255,v.ZERO,v.ZERO,v.ZERO),this.loadTimeStamps.push(performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(t){return t._makeTileBoundsBuffers(this.context,this.transform.projection),t._tileBoundsBuffer?{tileBoundsBuffer:t._tileBoundsBuffer,tileBoundsIndexBuffer:t._tileBoundsIndexBuffer,tileBoundsSegments:t._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){const t=this.context.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.getOrCreateProgram("clippingMask").draw(this,t.TRIANGLES,xt.disabled,this.stencilClearMode,oi.disabled,Nt.disabled,$o(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(t,n,c){if(!n||this.currentStencilSource===n.id||!t.isTileClipped()||!c||c.length===0)return;if(this._tileClippingMaskIDs&&!this.terrain){let y=!1;for(const v of c)if(this._tileClippingMaskIDs[v.key]===void 0){y=!0;break}if(!y)return}this.currentStencilSource=n.id;const d=this.context,f=d.gl;this.nextStencilID+c.length>256&&this.clearStencil(),d.setColorMode(oi.disabled),d.setDepthMode(xt.disabled);const m=this.getOrCreateProgram("clippingMask");this._tileClippingMaskIDs={};for(const y of c){const v=n.getTile(y),T=this._tileClippingMaskIDs[y.key]=this.nextStencilID++,{tileBoundsBuffer:S,tileBoundsIndexBuffer:C,tileBoundsSegments:I}=this.getTileBoundsBuffers(v);m.draw(this,f.TRIANGLES,xt.disabled,new Zt({func:f.ALWAYS,mask:0},T,255,f.KEEP,f.KEEP,f.REPLACE),oi.disabled,Nt.disabled,$o(y.projMatrix),"$clipping",S,C,I)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const t=this.nextStencilID++,n=this.context.gl;return new Zt({func:n.NOTEQUAL,mask:255},t,255,n.KEEP,n.KEEP,n.REPLACE)}stencilModeForClipping(t){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(t);const n=this.context.gl;return new Zt({func:n.EQUAL,mask:255},this._tileClippingMaskIDs[t.key],0,n.KEEP,n.KEEP,n.REPLACE)}stencilConfigForOverlap(t){const n=this.context.gl,c=t.sort((m,y)=>y.overscaledZ-m.overscaledZ),d=c[c.length-1].overscaledZ,f=c[0].overscaledZ-d+1;if(f>1){this.currentStencilSource=void 0,this.nextStencilID+f>256&&this.clearStencil();const m={};for(let y=0;y<f;y++)m[y+d]=new Zt({func:n.GEQUAL,mask:255},y+this.nextStencilID,255,n.KEEP,n.KEEP,n.REPLACE);return this.nextStencilID+=f,[m,c]}return[{[d]:Zt.disabled},c]}colorModeForRenderPass(){const t=this.context.gl;return this._showOverdrawInspector?new oi([t.CONSTANT_COLOR,t.ONE,t.CONSTANT_COLOR,t.ONE],new o.am(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?oi.unblended:oi.alphaBlended}colorModeForDrapableLayerRenderPass(t){const n=this.context.gl;return this.style&&this.style.enable3dLights()&&this.terrain&&this.terrain.renderingToTexture&&this.renderPass==="translucent"?new oi([n.ONE,n.ONE_MINUS_SRC_ALPHA,n.CONSTANT_ALPHA,n.ONE_MINUS_SRC_ALPHA],new o.am(0,0,0,t===void 0?0:t),[!0,!0,!0,!0]):this.colorModeForRenderPass()}depthModeForSublayer(t,n,c,d=!1){if(this.depthOcclusion)return new xt(this.context.gl.GREATER,xt.ReadOnly,this.depthRangeFor3D);if(!this.opaquePassEnabledForLayer()&&!d)return xt.disabled;const f=1-((1+this.currentLayer)*this.numSublayers+t)*this.depthEpsilon;return new xt(c||this.context.gl.LEQUAL,n,[f,f])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}blitDepth(){const t=this.context.gl,n=Math.ceil(this.width),c=Math.ceil(this.height),d=this.context.bindFramebuffer.get(),f=t.getParameter(t.TEXTURE_BINDING_2D);this.depthFBO&&this.depthFBO.width===n&&this.depthFBO.height===c||(this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),n!==0&&c!==0&&(this.depthFBO=new gh(this.context,n,c,!1,"texture"),this.depthTexture=new o.T(this.context,{width:n,height:c,data:null},t.DEPTH24_STENCIL8),this.depthFBO.depthAttachment.set(this.depthTexture.texture))),this.context.bindFramebuffer.set(d),t.bindTexture(t.TEXTURE_2D,f),this.depthFBO&&(t.bindFramebuffer(t.READ_FRAMEBUFFER,null),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this.depthFBO.framebuffer),t.blitFramebuffer(0,0,n,c,0,0,n,c,t.DEPTH_BUFFER_BIT,t.NEAREST),t.bindFramebuffer(t.FRAMEBUFFER,this.context.bindFramebuffer.current))}updateAverageFPS(){this._fpsHistory.push(this._dt===0?0:1e3/this._dt),this._fpsHistory.length>this._debugParams.fpsWindow&&this._fpsHistory.splice(0,this._fpsHistory.length-this._debugParams.fpsWindow),this._averageFPS=Math.round(this._fpsHistory.reduce((t,n)=>t+n/this._fpsHistory.length,0))}render(t,n){const c=o.q.now();this._dt=c-this._timeStamp,this._timeStamp=c,this._wireframeDebugCache.update(this.frameCounter),this._debugParams.continousRedraw=t.map.repaint,this.style=t,this.options=n;const d=this.style._mergedLayers,f=!(!this.terrain||!this.terrain.enabled),m=()=>this.style._getOrder(f).filter(_e=>{const Pe=d[_e];return!(Pe.type in this._debugParams.enabledLayers)||this._debugParams.enabledLayers[Pe.type]});let y=m(),v=!1,T=!1;for(const _e of y){const Pe=d[_e];Pe.type==="circle"&&(v=!0),Pe.type==="symbol"&&(Pe.hasInitialOcclusionOpacityProperties?T=!0:v=!0)}let S=y.map(_e=>d[_e]);const C=this.style._mergedSourceCaches;this.imageManager=t.imageManager,this.modelManager=t.modelManager,this.symbolFadeChange=t.placement.symbolFadeChange(o.q.now()),this.imageManager.beginFrame();let I=0,M=!1;for(const _e in C){const Pe=C[_e];Pe.used&&(Pe.prepare(this.context),Pe.getSource().usedInConflation&&++I)}let D=!1;for(const _e of S)_e.isHidden(this.transform.zoom)||(_e.type==="clip"&&(D=!0),this.prepareLayer(_e));const z={},O={},B={},V={},H={};for(const _e in C){const Pe=C[_e];z[_e]=Pe.getVisibleCoordinates(),O[_e]=z[_e].slice().reverse(),B[_e]=Pe.getVisibleCoordinates(!0).reverse(),V[_e]=Pe.getShadowCasterCoordinates(),H[_e]=Pe.sortCoordinatesByDistance(z[_e])}const Y=_e=>{const Pe=this.style.getLayerSourceCache(_e);return Pe&&Pe.used?Pe.getSource():null};if(I||D||this._clippingActiveLastFrame){const _e=[],Pe=[];let ue=0;for(const Ne of S)this.isSourceForClippingOrConflation(Ne,Y(Ne))&&(_e.push(Ne),Pe.push(ue)),ue++;if(_e&&(D||_e.length>1)||this._clippingActiveLastFrame){D=!1;const Ne=[];for(let Se=0;Se<_e.length;Se++){const qe=_e[Se],rt=Pe[Se],Fe=this.style.getLayerSourceCache(qe);if(!Fe||!Fe.used||!Fe.getSource().usedInConflation&&qe.type!=="clip")continue;let tt=o.eu,wt=o.bQ.None;const Tt=[];let gt=!0;if(qe.type==="clip"){tt=rt;for(const Rt of qe.layout.get("clip-layer-types"))wt|=Rt==="model"?o.bQ.Model:Rt==="symbol"?o.bQ.Symbol:o.bQ.FillExtrusion;for(const Rt of qe.layout.get("clip-layer-scope"))Tt.push(Rt);qe.isHidden(this.transform.zoom)?gt=!1:D=!0}gt&&Ne.push({layer:qe.fqid,cache:Fe,order:tt,clipMask:wt,clipScope:Tt})}this.replacementSource.setSources(Ne),M=!0}}this._clippingActiveLastFrame=D,M||this.replacementSource.clear(),this.conflationActive=M,this.minCutoffZoom=0,this.longestCutoffRange=0,this.opaquePassCutoff=1/0,this._lastOcclusionLayer=-1,this.layersWithOcclusionOpacity=[];for(let _e=0;_e<S.length;_e++){const Pe=S[_e],ue=Pe.cutoffRange();if(this.longestCutoffRange=Math.max(ue,this.longestCutoffRange),ue>0){const Ne=Y(Pe);Ne&&(this.minCutoffZoom=Math.max(Ne.minzoom,this.minCutoffZoom)),Pe.minzoom&&(this.minCutoffZoom=Math.max(Pe.minzoom,this.minCutoffZoom))}Pe.is3D(f)&&(this.opaquePassCutoff===1/0&&(this.opaquePassCutoff=_e),this._lastOcclusionLayer=_e)}const te=this.style&&this.style.fog;te?(this._fogVisible=te.getOpacity(this.transform.pitch)!==0,this._fogVisible&&this.transform.projection.name!=="globe"&&(this._fogVisible=te.isVisibleOnFrustum(this.transform.cameraFrustum))):this._fogVisible=!1,this._cachedTileFogOpacities={},this.terrain&&(this.terrain.updateTileBinding(B),this.opaquePassCutoff=0,y=m(),S=y.map(_e=>d[_e]));const ee=this._shadowRenderer;if(ee){ee.updateShadowParameters(this.transform,this.style.directionalLight);for(const _e in C)for(const Pe of z[_e]){let ue={min:0,max:0};this.terrain&&(ue=this.terrain.getMinMaxForTile(Pe)||ue),ee.addShadowReceiver(Pe.toUnwrapped(),ue.min,ue.max)}}this.transform.projection.name!=="globe"||this.globeSharedBuffers||(this.globeSharedBuffers=new o.ev(this.context)),this.style.fog&&this.transform.projection.supportsFog?(this._atmosphere||(this._atmosphere=new La(this)),this._atmosphere.update(this)):this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0);const J=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.snow),K=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.rain);if(J&&!this._snow&&(this._snow=new hr(this)),!J&&this._snow&&(this._snow.destroy(),delete this._snow),K&&!this._rain&&(this._rain=new fm(this)),!K&&this._rain&&(this._rain.destroy(),delete this._rain),this._snow&&this._snow.update(this),this._rain&&this._rain.update(this),!Es.has(this.context.gl))return;this.renderPass="offscreen";for(const _e of S){const Pe=t.getLayerSourceCache(_e);if(!_e.hasOffscreenPass()||_e.isHidden(this.transform.zoom))continue;const ue=Pe?O[Pe.id]:void 0;(_e.type==="custom"||_e.type==="raster"||_e.type==="raster-particle"||_e.isSky()||ue&&ue.length)&&this.renderLayer(this,Pe,_e,ue)}this.depthRangeFor3D=[0,1-(S.length+2)*this.numSublayers*this.depthEpsilon],this._shadowRenderer&&(this.renderPass="shadow",this._shadowRenderer.drawShadowPass(this.style,V)),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);const ie=this.transform.projection.name==="globe"||this.transform.isHorizonVisible(),se=(()=>{if(n.showOverdrawInspector)return o.am.black;const _e=this.style.fog;if(_e&&this.transform.projection.supportsFog){const Pe=this.style.getLut(_e.scope);if(!ie){const ue=_e.properties.get("color-use-theme")==="none",Ne=_e.properties.get("color").toNonPremultipliedRenderColor(ue?null:Pe).toArray01();return new o.am(...Ne)}if(ie){const ue=_e.properties.get("space-color-use-theme")==="none",Ne=_e.properties.get("space-color").toNonPremultipliedRenderColor(ue?null:Pe).toArray01();return new o.am(...Ne)}}return o.am.transparent})();if(this.context.clear({color:se,depth:1}),this.clearStencil(),this._showOverdrawInspector=n.showOverdrawInspector,this.renderPass="opaque",this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&ie&&this._atmosphere.drawStars(this,this.style.fog),!this.terrain)for(this.currentLayer=y.length-1;this.currentLayer>=0;this.currentLayer--){const _e=S[this.currentLayer],Pe=t.getLayerSourceCache(_e);if(_e.isSky())continue;const ue=Pe?(_e.is3D(f)?H:O)[Pe.id]:void 0;this._renderTileClippingMasks(_e,Pe,ue),this.renderLayer(this,Pe,_e,ue)}if(this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&ie&&this._atmosphere.drawAtmosphereGlow(this,this.style.fog),this.renderPass="sky",(!this._atmosphere||o.ah(this.transform.zoom)>0)&&(this.transform.projection.name==="globe"||this.transform.isHorizonVisible()))for(this.currentLayer=0;this.currentLayer<y.length;this.currentLayer++){const _e=S[this.currentLayer],Pe=t.getLayerSourceCache(_e);_e.isSky()&&this.renderLayer(this,Pe,_e,Pe?O[Pe.id]:void 0)}function ye(_e,Pe){let ue;return Pe&&(ue=(_e.type==="symbol"?B:_e.is3D(f)?H:O)[Pe.id]),ue}if(this.renderPass="translucent",this.transform.projection.name==="globe"){for(this.renderElevatedRasterBackface=!0,this.currentLayer=0;this.currentLayer<y.length;){const _e=S[this.currentLayer];if(_e.type==="raster"||_e.type==="raster-particle"){const Pe=t.getLayerSourceCache(_e);this.renderLayer(this,Pe,_e,ye(_e,Pe))}++this.currentLayer}this.renderElevatedRasterBackface=!1}this.currentLayer=0,this.firstLightBeamLayer=Number.MAX_SAFE_INTEGER;let ve=0;ee&&(ve=ee.getShadowCastingLayerCount());let Oe=!1,ke=-1;for(let _e=0;_e<y.length;++_e){const Pe=S[_e];Pe.isHidden(this.transform.zoom)||Pe.is3D(f)&&(ke=_e)}T&&ke===-1&&(v=!0);let Ze=!1;for(;this.currentLayer<y.length;){const _e=S[this.currentLayer],Pe=t.getLayerSourceCache(_e);if(_e.isSky())++this.currentLayer;else if(this.terrain&&this.style.isLayerDraped(_e)){if(_e.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=this.terrain.renderBatch(this.currentLayer),this._lastOcclusionLayer=Math.max(this.currentLayer,this._lastOcclusionLayer)}else{if(!Ze&&_e.is3D(f)&&!f){const ue=this.currentLayer,Ne=Se=>{for(this.currentLayer=0;this.currentLayer<S.length;this.currentLayer++){const qe=S[this.currentLayer];if(Ns[qe.type]){const rt=this.style.getLayerSourceCache(qe);Ns[qe.type](this,rt,qe,ye(qe,rt),Se)}}};Ne("initialize"),Ne("reset"),this.currentLayer=ue,Ze=!0}if(v&&!Oe&&this.terrain&&!this.transform.isOrthographic&&(Oe=!0,this.blitDepth()),T&&ke!==-1&&this.currentLayer===ke+1&&!this.transform.isOrthographic&&this.blitDepth(),this.terrain||this._renderTileClippingMasks(_e,Pe,Pe?z[Pe.id]:void 0),this.renderLayer(this,Pe,_e,ye(_e,Pe)),!this.terrain&&ee&&ve>0&&_e.hasShadowPass()&&--ve==0){{this.clearStencil();const ue=this.currentLayer;for(this.currentLayer=0;this.currentLayer<S.length;this.currentLayer++){const Ne=S[this.currentLayer];if(Ul[Ne.type]){const Se=this.style.getLayerSourceCache(Ne);Ul[Ne.type](this,Se,Ne,ye(Ne,Se))}}this.currentLayer=ue}if(ee.drawGroundShadows(),this.firstLightBeamLayer<=this.currentLayer){const ue=this.currentLayer;for(this.renderPass="light-beam",this.currentLayer=this.firstLightBeamLayer;this.currentLayer<=ue;this.currentLayer++){const Ne=S[this.currentLayer];if(!Ne.hasLightBeamPass())continue;const Se=t.getLayerSourceCache(Ne);this.renderLayer(this,Se,Ne,Se?O[Se.id]:void 0)}this.currentLayer=ue,this.renderPass="translucent"}}if(this.currentLayer>=this._lastOcclusionLayer&&this.layersWithOcclusionOpacity.length>0){const ue=this.currentLayer;this.depthOcclusion=!0;for(const Ne of this.layersWithOcclusionOpacity){this.currentLayer=Ne;const Se=S[this.currentLayer],qe=t.getLayerSourceCache(Se),rt=qe?O[qe.id]:void 0;this.terrain||this._renderTileClippingMasks(Se,qe,qe?z[qe.id]:void 0),this.renderLayer(this,qe,Se,rt)}this.depthOcclusion=!1,this.currentLayer=ue,this.renderPass="translucent",this.layersWithOcclusionOpacity=[]}++this.currentLayer}}if(this.terrain&&this.terrain.postRender(),this._snow&&this._snow.draw(this),this._rain&&this._rain.draw(this),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let _e=null;S.forEach(Pe=>{const ue=t.getLayerSourceCache(Pe);ue&&!Pe.isHidden(this.transform.zoom)&&ue.getVisibleCoordinates().length&&(!_e||_e.getSource().maxzoom<ue.getSource().maxzoom)&&(_e=ue)}),_e&&this.options.showTileBoundaries&&Fs(this,_e,_e.getVisibleCoordinates(),o.am.red,!1,this.options.showParseStatus)}this.terrain&&this._debugParams.showTerrainProxyTiles&&Fs(this,this.terrain.proxySourceCache,this.terrain.proxyCoords,new o.am(1,.8,.1,1),!0,this.options.showParseStatus),this.options.showPadding&&function(_e){const Pe=_e.transform.padding;Xc(_e,_e.transform.height-(Pe.top||0),3,lm),Xc(_e,Pe.bottom||0,3,cm),Yc(_e,Pe.left||0,3,On),Yc(_e,_e.transform.width-(Pe.right||0),3,bh);const ue=_e.transform.centerPoint;(function(Ne,Se,qe,rt){za(Ne,Se-1,qe-10,2,20,rt),za(Ne,Se-10,qe-1,20,2,rt)})(_e,ue.x,_e.transform.height-ue.y,bn)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(performance.now()),this.saveCanvasCopy()),M||(this.conflationActive=!1)}prepareLayer(t){this.gpuTimingStart(t);const{unsupportedLayers:n}=this.transform.projection,c=!n||!n.includes(t.type);if(Ih[t.type]&&(c||this.terrain&&t.type==="custom")){const d=this.style.getLayerSourceCache(t);Ih[t.type](t,d,this)}this.gpuTimingEnd()}renderLayer(t,n,c,d){c.isHidden(this.transform.zoom)||(c.type==="background"||c.type==="sky"||c.type==="custom"||c.type==="model"||c.type==="raster"||c.type==="raster-particle"||d&&d.length)&&(this.id=c.id,this.gpuTimingStart(c),t.transform.projection.unsupportedLayers&&t.transform.projection.unsupportedLayers.includes(c.type)&&(!t.terrain||c.type!=="custom")||c.type==="clip"||bi[c.type](t,n,c,d,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(t){if(!this.options.gpuTiming)return;const n=this.context.extTimerQuery,c=this.context.gl;let d=this.gpuTimers[t.id];d||(d=this.gpuTimers[t.id]={calls:0,cpuTime:0,query:c.createQuery()}),d.calls++,c.beginQuery(n.TIME_ELAPSED_EXT,d.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){const t=this.context.extTimerQuery,n=this.context.gl,c=n.createQuery();this.deferredRenderGpuTimeQueries.push(c),n.beginQuery(t.TIME_ELAPSED_EXT,c)}}gpuTimingDeferredRenderEnd(){this.options.gpuTimingDeferredRender&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}gpuTimingEnd(){this.options.gpuTiming&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}collectGpuTimers(){const t=this.gpuTimers;return this.gpuTimers={},t}collectDeferredRenderGpuQueries(){const t=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],t}queryGpuTimers(t){const n={};for(const c in t){const d=t[c],f=this.context.extTimerQuery,m=f.getQueryParameter(d.query,this.context.gl.QUERY_RESULT)/1e6;f.deleteQueryEXT(d.query),n[c]=m}return n}queryGpuTimeDeferredRender(t){if(!this.options.gpuTimingDeferredRender)return 0;const n=this.context.gl;let c=0;for(const d of t)c+=n.getQueryParameter(d,n.QUERY_RESULT)/1e6,n.deleteQuery(d);return c}translatePosMatrix(t,n,c,d,f){if(!c[0]&&!c[1])return t;const m=f?d==="map"?this.transform.angle:0:d==="viewport"?-this.transform.angle:0;if(m){const T=Math.sin(m),S=Math.cos(m);c=[c[0]*S-c[1]*T,c[0]*T+c[1]*S]}const y=[f?c[0]:o.aw(n,c[0],this.transform.zoom),f?c[1]:o.aw(n,c[1],this.transform.zoom),0],v=new Float32Array(16);return o.bo(v,t,y),v}saveTileTexture(t){const n=t.size[0],c=this._tileTextures[n];c?c.push(t):this._tileTextures[n]=[t]}getTileTexture(t){const n=this._tileTextures[t];return n&&n.length>0?n.pop():null}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture||this.forceTerrainMode}linearFloatFilteringSupported(){return this.context.extTextureFloatLinear!=null}currentGlobalDefines(t,n,c){const d=c===void 0?this.terrain&&this.terrain.renderingToTexture:c,f=[];return this.style&&this.style.enable3dLights()&&(t==="globeRaster"||t==="terrainRaster"?(f.push("LIGHTING_3D_MODE"),f.push("LIGHTING_3D_ALPHA_EMISSIVENESS")):d||f.push("LIGHTING_3D_MODE")),this.renderPass==="shadow"&&(this._shadowMapDebug||f.push("DEPTH_TEXTURE")),this.terrainRenderModeElevated()&&(f.push("TERRAIN"),this.linearFloatFilteringSupported()&&f.push("TERRAIN_DEM_FLOAT_FORMAT")),this.transform.projection.name==="globe"&&f.push("GLOBE"),!this._fogVisible||d||n!==void 0&&!n||f.push("FOG","FOG_DITHERING"),d&&f.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&f.push("OVERDRAW_INSPECTOR"),f}getOrCreateProgram(t,n){this.cache=this.cache||{};const c=n&&n.defines||[],d=n&&n.config,f=this.currentGlobalDefines(t,n&&n.overrideFog,n&&n.overrideRtt).concat(c),m=Gc.cacheKey(Pc[t],t,f,d);return this.cache[m]||(this.cache[m]=new Gc(this.context,t,Pc[t],d,ef[t],f)),this.cache[m]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const t=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(t.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new o.T(this.context,this.debugOverlayCanvas,this.context.gl.RGBA8))}destroy(){this._terrain&&this._terrain.destroy(),this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this._wireframeDebugCache.destroy(),this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),this.emptyDepthTexture&&this.emptyDepthTexture.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}uploadCommonLightUniforms(t,n){if(this.style.enable3dLights()){const c=this.style.directionalLight,d=this.style.ambientLight;if(c&&d){const f=((m,y,v)=>{const T=m.properties.get("direction"),S=m.properties.get("color-use-theme")==="none",C=m.properties.get("color").toNonPremultipliedRenderColor(S?null:v.getLut(m.scope)).toArray01(),I=m.properties.get("intensity"),M=y.properties.get("color-use-theme")==="none",D=y.properties.get("color").toNonPremultipliedRenderColor(M?null:v.getLut(y.scope)).toArray01(),z=y.properties.get("intensity"),O=[T.x,T.y,T.z],B=o.dw(D,z),V=o.dw(C,I);return{u_lighting_ambient_color:B,u_lighting_directional_dir:O,u_lighting_directional_color:V,u_ground_radiance:jc(O,V,B)}})(c,d,this.style);n.setLightsUniformValues(t,f)}}}uploadCommonUniforms(t,n,c,d,f){if(this.uploadCommonLightUniforms(t,n),this.terrain&&this.terrain.renderingToTexture)return;const m=this.style.fog;if(m){const y=m.getOpacity(this.transform.pitch),v=((T,S,C,I,M,D,z,O,B,V,H,Y)=>{const te=T.transform,ee=S.properties.get("color-use-theme")==="none",J=S.properties.get("color").toNonPremultipliedRenderColor(ee?null:T.style.getLut(S.scope)).toArray01();J[3]=I;const K=T.frameCounter/1e3%1,[ie,se]=S.properties.get("vertical-range");return{u_fog_matrix:C?te.calculateFogTileMatrix(C):Y||T.identityMat,u_fog_range:S.getFovAdjustedRange(te._fov),u_fog_color:J,u_fog_horizon_blend:S.properties.get("horizon-blend"),u_fog_vertical_limit:[Math.min(ie,se),se],u_fog_temporal_offset:K,u_frustum_tl:M,u_frustum_tr:D,u_frustum_br:z,u_frustum_bl:O,u_globe_pos:B,u_globe_radius:V,u_viewport:H,u_globe_transition:o.ah(te.zoom),u_is_globe:+(te.projection.name==="globe")}})(this,m,c,y,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*o.q.devicePixelRatio,this.transform.height*o.q.devicePixelRatio],d);n.setFogUniformValues(t,v)}f&&n.setCutoffUniformValues(t,f.uniformValues)}setTileLoadedFlag(t){this.tileLoaded=t}saveCanvasCopy(){const t=this.canvasCopy();t&&(this.frameCopies.push(t),this.tileLoaded=!1)}canvasCopy(){const t=this.context.gl,n=t.createTexture();return t.bindTexture(t.TEXTURE_2D,n),t.copyTexImage2D(t.TEXTURE_2D,0,t.RGBA,0,0,t.drawingBufferWidth,t.drawingBufferHeight,0),n}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;const t=this.style&&this.style.fog;return!!t&&t.getOpacity(this.transform.pitch)!==0}getBackgroundTiles(){const t=this._backgroundTiles,n=this._backgroundTiles={},c=this.transform.coveringTiles({tileSize:512});for(const d of c)n[d.key]=t[d.key]||new Lo(d,512,this.transform.tileZoom,this,void 0,this.worldview);return n}clearBackgroundTiles(){this._backgroundTiles={}}isSourceForClippingOrConflation(t,n){return!(!t.is3D(!(!this.terrain||!this.terrain.enabled))||t.type!=="clip"&&(t.minzoom&&t.minzoom>this.transform.zoom||(this.style._clipLayerPresent||t.sourceLayer!=="building")&&(!n||n.type!=="batched-model")))}isTileAffectedByFog(t){if(!this.style||!this.style.fog)return!1;if(this.transform.projection.name==="globe")return!0;let n=this._cachedTileFogOpacities[t.key];return n||(this._cachedTileFogOpacities[t.key]=n=this.style.fog.getOpacityForTile(t)),n[0]>=Ie||n[1]>=Ie}setupDepthForOcclusion(t,n,c){const d=this.context,f=d.gl,m=!!c;var y;c||(c={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0}),d.activeTexture.set(f.TEXTURE3),t&&this.depthFBO&&this.depthTexture?(this.depthTexture.bind(f.NEAREST,f.CLAMP_TO_EDGE),c.u_depth_size_inv=[1/this.depthFBO.width,1/this.depthFBO.height],c.u_depth_range_unpack=[2/((y=this.depthRangeFor3D)[1]-y[0]),-1-2*y[0]/(y[1]-y[0])],c.u_occluder_half_size=.5*this.occlusionParams.occluderSize,c.u_occlusion_depth_offset=this.occlusionParams.depthOffset):this.emptyDepthTexture.bind(f.NEAREST,f.CLAMP_TO_EDGE),d.activeTexture.set(f.TEXTURE0),m||n.setTerrainUniformValues(d,c)}}function mo(l,t){let n=!1,c=null;const d=()=>{c=null,n&&(l(),c=setTimeout(d,t),n=!1)};return()=>(n=!0,c||d(),c)}class Ah{constructor(t){this._hashName=t&&encodeURIComponent(t),o.aV(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=mo(this._updateHashUnthrottled.bind(this),300)}addTo(t){return this._map=t,window.addEventListener("hashchange",this._onHashChange,!1),t.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),window.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){const t=this._map;if(!t)return"";const n=tu(t);if(this._hashName){const c=this._hashName;let d=!1;const f=location.hash.slice(1).split("&").map(m=>{const y=m.split("=")[0];return y===c?(d=!0,`${y}=${n}`):m}).filter(m=>m);return d||f.push(`${c}=${n}`),`#${f.join("&")}`}return`#${n}`}_getCurrentHash(){const t=location.hash.replace("#","");if(this._hashName){let n;return t.split("&").map(c=>c.split("=")).forEach(c=>{c[0]===this._hashName&&(n=c)}),(n&&n[1]||"").split("/")}return t.split("/")}_onHashChange(){const t=this._map;if(!t)return!1;const n=this._getCurrentHash();if(n.length>=3&&!n.some(c=>isNaN(Number(c)))){const c=t.dragRotate.isEnabled()&&t.touchZoomRotate.isEnabled()?+(n[3]||0):t.getBearing();return t.jumpTo({center:[+n[2],+n[1]],zoom:+n[0],bearing:c,pitch:+(n[4]||0)}),!0}return!1}_updateHashUnthrottled(){history.replaceState(history.state,"",location.href.replace(/(#.+)?$/,this.getHashString()))}}function tu(l,t){const n=l.getCenter(),c=Math.round(100*l.getZoom())/100,d=Math.ceil((c*Math.LN2+Math.log(512/360/.5))/Math.LN10),f=Math.pow(10,d),m=Math.round(n.lng*f)/f,y=Math.round(n.lat*f)/f,v=l.getBearing(),T=l.getPitch();let S=t?`/${m}/${y}/${c}`:`${c}/${y}/${m}`;return(v||T)&&(S+="/"+Math.round(10*v)/10),T&&(S+=`/${Math.round(T)}`),S}const ka={linearity:.3,easing:o.ew(0,0,.3,1)},Ch=o.h({deceleration:2500,maxSpeed:1400},ka),ys=o.h({deceleration:20,maxSpeed:1400},ka),_o=o.h({deceleration:1e3,maxSpeed:360},ka),jl=o.h({deceleration:1e3,maxSpeed:90},ka);class iu{constructor(t){this._map=t,this.clear()}clear(){this._inertiaBuffer=[]}record(t){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:o.q.now(),settings:t})}_drainInertiaBuffer(){const t=this._inertiaBuffer,n=o.q.now();for(;t.length>0&&n-t[0].time>160;)t.shift()}_onMoveEnd(t){if(this._map._prefersReducedMotion()||(this._drainInertiaBuffer(),this._inertiaBuffer.length<2))return;const n={zoom:0,bearing:0,pitch:0,pan:new o.P(0,0),pinchAround:void 0,around:void 0};for(const{settings:f}of this._inertiaBuffer)n.zoom+=f.zoomDelta||0,n.bearing+=f.bearingDelta||0,n.pitch+=f.pitchDelta||0,f.panDelta&&n.pan._add(f.panDelta),f.around&&(n.around=f.around),f.pinchAround&&(n.pinchAround=f.pinchAround);const c=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,d={};if(n.pan.mag()){const f=Ba(n.pan.mag(),c,o.h({},Ch,t||{}));d.offset=n.pan.mult(f.amount/n.pan.mag()),d.center=this._map.transform.center,Fa(d,f)}if(n.zoom){const f=Ba(n.zoom,c,ys);d.zoom=this._map.transform.zoom+f.amount,Fa(d,f)}if(n.bearing){const f=Ba(n.bearing,c,_o);d.bearing=this._map.transform.bearing+o.ay(f.amount,-179,179),Fa(d,f)}if(n.pitch){const f=Ba(n.pitch,c,jl);d.pitch=this._map.transform.pitch+f.amount,Fa(d,f)}if(d.zoom||d.bearing){const f=n.pinchAround===void 0?n.around:n.pinchAround;d.around=f?this._map.unproject(f):this._map.getCenter()}return this.clear(),d.noMoveStart=!0,d}}function Fa(l,t){(!l.duration||l.duration<t.duration)&&(l.duration=t.duration,l.easing=t.easing)}function Ba(l,t,n){const{maxSpeed:c,linearity:d,deceleration:f}=n,m=o.ay(l*d/(t/1e3),-c,c),y=Math.abs(m)/(f*d);return{easing:n.easing,duration:1e3*y,amount:m*(y/2)}}class Qr extends o.A{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,n,c,d={}){const f=Gt(n.getCanvasContainer(),c),m=n.unproject(f);super(t,o.h({point:f,lngLat:m,originalEvent:c},d)),this._defaultPrevented=!1,this.target=n}}class Na extends o.A{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,n,c){const d=t==="touchend"?c.changedTouches:c.touches,f=gi(n.getCanvasContainer(),d),m=f.map(v=>n.unproject(v)),y=f.reduce((v,T,S,C)=>v.add(T.div(C.length)),new o.P(0,0));super(t,{points:f,point:y,lngLats:m,lngLat:n.unproject(y),originalEvent:c}),this._defaultPrevented=!1}}class go extends o.A{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,n){super("wheel",{originalEvent:n}),this._defaultPrevented=!1}}class Mh{constructor(t,n){this._map=t,this._clickTolerance=n.clickTolerance}reset(){this._mousedownPos=void 0}wheel(t){return this._firePreventable(new go(this._map,t))}mousedown(t,n){return this._mousedownPos=n,this._firePreventable(new Qr(t.type,this._map,t))}mouseup(t){this._map.fire(new Qr(t.type,this._map,t))}preclick(t){const n=o.h({},t);n.type="preclick",this._map.fire(new Qr(n.type,this._map,n))}click(t,n){this._mousedownPos&&this._mousedownPos.dist(n)>=this._clickTolerance||(this.preclick(t),this._map.fire(new Qr(t.type,this._map,t)))}dblclick(t){return this._firePreventable(new Qr(t.type,this._map,t))}mouseover(t){this._map.fire(new Qr(t.type,this._map,t))}mouseout(t){this._map.fire(new Qr(t.type,this._map,t))}touchstart(t){return this._firePreventable(new Na(t.type,this._map,t))}touchmove(t){this._map.fire(new Na(t.type,this._map,t))}touchend(t){this._map.fire(new Na(t.type,this._map,t))}touchcancel(t){this._map.fire(new Na(t.type,this._map,t))}_firePreventable(t){if(this._map.fire(t),t.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class ru{constructor(t){this._map=t}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(t){this._map.fire(new Qr(t.type,this._map,t))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new Qr("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(t){this._delayContextMenu?this._contextMenuEvent=t:this._map.fire(new Qr(t.type,this._map,t)),this._map.listens("contextmenu")&&t.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Ph{constructor(t,n){this._map=t,this._el=t.getCanvasContainer(),this._container=t.getContainer(),this._clickTolerance=n.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(t,n){this.isEnabled()&&t.shiftKey&&t.button===0&&(nt(),this._startPos=this._lastPos=n,this._active=!0)}mousemoveWindow(t,n){if(!this._active)return;const c=n,d=this._startPos,f=this._lastPos;if(!d||!f||f.equals(c)||!this._box&&c.dist(d)<this._clickTolerance)return;this._lastPos=c,this._box||(this._box=re("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",t));const m=Math.min(d.x,c.x),y=Math.max(d.x,c.x),v=Math.min(d.y,c.y),T=Math.max(d.y,c.y);this._map._requestDomTask(()=>{this._box&&(this._box.style.transform=`translate(${m}px,${v}px)`,this._box.style.width=y-m+"px",this._box.style.height=T-v+"px")})}mouseupWindow(t,n){if(!this._active)return;const c=this._startPos,d=n;if(c&&t.button===0){if(this.reset(),yt(),c.x!==d.x||c.y!==d.y)return this._map.fire(new o.A("boxzoomend",{originalEvent:t})),{cameraAnimation:f=>f.fitScreenCoordinates(c,d,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",t)}}keydown(t){this._active&&t.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",t))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),$e(),delete this._startPos,delete this._lastPos}_fireEvent(t,n){return this._map.fire(new o.A(t,{originalEvent:n}))}}function Gl(l,t){const n={};for(let c=0;c<l.length;c++)n[l[c].identifier]=t[c];return n}class en{constructor(t){this.reset(),this.numTouches=t.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(t,n,c){(this.centroid||c.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===0&&(this.startTime=t.timeStamp),c.length===this.numTouches&&(this.centroid=function(d){const f=new o.P(0,0);for(const m of d)f._add(m);return f.div(d.length)}(n),this.touches=Gl(c,n)))}touchmove(t,n,c){if(this.aborted||!this.centroid)return;const d=Gl(c,n);for(const f in this.touches){const m=d[f];(!m||m.dist(this.touches[f])>30)&&(this.aborted=!0)}}touchend(t,n,c){if((!this.centroid||t.timeStamp-this.startTime>500)&&(this.aborted=!0),c.length===0){const d=!this.aborted&&this.centroid;if(this.reset(),d)return d}}}class ql{constructor(t){this.singleTap=new en(t),this.numTaps=t.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(t,n,c){this.singleTap.touchstart(t,n,c)}touchmove(t,n,c){this.singleTap.touchmove(t,n,c)}touchend(t,n,c){const d=this.singleTap.touchend(t,n,c);if(d){const f=t.timeStamp-this.lastTime<500,m=!this.lastTap||this.lastTap.dist(d)<30;if(f&&m||this.reset(),this.count++,this.lastTime=t.timeStamp,this.lastTap=d,this.count===this.numTaps)return this.reset(),d}}}class Rh{constructor(){this._zoomIn=new ql({numTouches:1,numTaps:2}),this._zoomOut=new ql({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(t,n,c){this._zoomIn.touchstart(t,n,c),this._zoomOut.touchstart(t,n,c)}touchmove(t,n,c){this._zoomIn.touchmove(t,n,c),this._zoomOut.touchmove(t,n,c)}touchend(t,n,c){const d=this._zoomIn.touchend(t,n,c),f=this._zoomOut.touchend(t,n,c);return d?(this._active=!0,t.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:m=>m.easeTo({duration:300,zoom:m.getZoom()+1,around:m.unproject(d)},{originalEvent:t})}):f?(this._active=!0,t.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:m=>m.easeTo({duration:300,zoom:m.getZoom()-1,around:m.unproject(f)},{originalEvent:t})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const zh={0:1,2:2},yo={Control:"ctrlKey",Alt:"altKey",Shift:"shiftKey",Meta:"metaKey"};class $l{constructor(t){this.reset(),this._clickTolerance=t.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(t,n){return!1}_move(t,n){return{}}mousedown(t,n){if(this._lastPoint)return;const c=xi(t);this._correctButton(t,c)&&(this._lastPoint=n,this._eventButton=c)}mousemoveWindow(t,n){const c=this._lastPoint;if(c){if(t.preventDefault(),this._eventButton!=null&&function(d,f){const m=zh[f];return d.buttons===void 0||(d.buttons&m)!==m}(t,this._eventButton))this.reset();else if(this._moved||!(n.dist(c)<this._clickTolerance))return this._moved=!0,this._lastPoint=n,this._move(c,n)}}mouseupWindow(t){this._lastPoint&&xi(t)===this._eventButton&&(this._moved&&yt(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Lh extends $l{mousedown(t,n){super.mousedown(t,n),this._lastPoint&&(this._active=!0)}_correctButton(t,n){return n===0&&!t.ctrlKey}_move(t,n){return{around:n,panDelta:n.sub(t)}}}class nu extends $l{constructor(t){super(t),this._pitchRotateKey=t.pitchRotateKey?yo[t.pitchRotateKey]:void 0}_correctButton(t,n){return this._pitchRotateKey?n===0&&t[this._pitchRotateKey]:n===0&&t.ctrlKey||n===2}_move(t,n){const c=.8*(n.x-t.x);if(c)return this._active=!0,{bearingDelta:c}}contextmenu(t){this._pitchRotateKey||t.preventDefault()}}class ea extends $l{constructor(t){super(t),this._pitchRotateKey=t.pitchRotateKey?yo[t.pitchRotateKey]:void 0}_correctButton(t,n){return this._pitchRotateKey?n===0&&t[this._pitchRotateKey]:n===0&&t.ctrlKey||n===2}_move(t,n){const c=-.5*(n.y-t.y);if(c)return this._active=!0,{pitchDelta:c}}contextmenu(t){this._pitchRotateKey||t.preventDefault()}}class Dh{constructor(t,n){this._map=t,this._el=t.getCanvasContainer(),this._minTouches=1,this._clickTolerance=n.clickTolerance||1,this.reset(),o.aV(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new o.P(0,0)}touchstart(t,n,c){return this._calculateTransform(t,n,c)}touchmove(t,n,c){if(this._active&&!(c.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(c.length===1&&!o.ex())return void this._showTouchPanBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return t.cancelable&&t.preventDefault(),this._calculateTransform(t,n,c)}}touchend(t,n,c){this._calculateTransform(t,n,c),this._active&&c.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(t,n,c){c.length>0&&(this._active=!0);const d=Gl(c,n),f=new o.P(0,0),m=new o.P(0,0);let y=0;for(const T in d){const S=d[T],C=this._touches[T];C&&(f._add(S),m._add(S.sub(C)),y++,d[T]=S)}if(this._touches=d,y<this._minTouches||!m.mag())return;const v=m.div(y);return this._sum._add(v),this._sum.mag()<this._clickTolerance?void 0:{around:f.div(y),panDelta:v}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=re("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.removeAttribute("role")},500)}}class Hl{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(t){}_move(t,n,c){return{}}touchstart(t,n,c){this._firstTwoTouches||c.length<2||(this._firstTwoTouches=[c[0].identifier,c[1].identifier],this._start([n[0],n[1]]))}touchmove(t,n,c){const d=this._firstTwoTouches;if(!d)return;t.preventDefault();const[f,m]=d,y=Va(c,n,f),v=Va(c,n,m);if(!y||!v)return;const T=this._aroundCenter?null:y.add(v).div(2);return this._move([y,v],T,t)}touchend(t,n,c){if(!this._firstTwoTouches)return;const[d,f]=this._firstTwoTouches,m=Va(c,n,d),y=Va(c,n,f);m&&y||(this._active&&yt(),this.reset())}touchcancel(){this.reset()}enable(t){this._enabled=!0,this._aroundCenter=!!t&&t.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function Va(l,t,n){for(let c=0;c<l.length;c++)if(l[c].identifier===n)return t[c]}function Zl(l,t){return Math.log(l/t)/Math.LN2}class Oh extends Hl{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(t){this._startDistance=this._distance=t[0].dist(t[1])}_move(t,n){const c=this._distance;if(this._distance=t[0].dist(t[1]),this._active||!(Math.abs(Zl(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:Zl(this._distance,c),pinchAround:n}}}function su(l,t){return 180*l.angleWith(t)/Math.PI}class mf extends Hl{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(t){this._startVector=this._vector=t[0].sub(t[1]),this._minDiameter=t[0].dist(t[1])}_move(t,n){const c=this._vector;if(this._vector=t[0].sub(t[1]),c&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:su(this._vector,c),pinchAround:n}}_isBelowThreshold(t){this._minDiameter=Math.min(this._minDiameter,t.mag());const n=25/(Math.PI*this._minDiameter)*360,c=this._startVector;if(!c)return!1;const d=su(t,c);return Math.abs(d)<n}}function ou(l){return Math.abs(l.y)>Math.abs(l.x)}class _f extends Hl{constructor(t){super(),this._map=t}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(t){this._lastPoints=t,ou(t[0].sub(t[1]))&&(this._valid=!1)}_move(t,n,c){const d=this._lastPoints;if(!d)return;const f=t[0].sub(d[0]),m=t[1].sub(d[1]);return this._map._cooperativeGestures&&!o.ex()&&c.touches.length<3||(this._valid=this.gestureBeginsVertically(f,m,c.timeStamp),!this._valid)?void 0:(this._lastPoints=t,this._active=!0,{pitchDelta:(f.y+m.y)/2*-.5})}gestureBeginsVertically(t,n,c){if(this._valid!==void 0)return this._valid;const d=t.mag()>=2,f=n.mag()>=2;if(!d&&!f)return;if(!d||!f)return this._firstMove==null&&(this._firstMove=c),c-this._firstMove<100&&void 0;const m=t.y>0==n.y>0;return ou(t)&&ou(n)&&m}}const gf={panStep:100,bearingStep:15,pitchStep:10};class yf{constructor(){const t=gf;this._panStep=t.panStep,this._bearingStep=t.bearingStep,this._pitchStep=t.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(t){if(t.altKey||t.ctrlKey||t.metaKey)return;let n=0,c=0,d=0,f=0,m=0;switch(t.keyCode){case 61:case 107:case 171:case 187:n=1;break;case 189:case 109:case 173:n=-1;break;case 37:t.shiftKey?c=-1:(t.preventDefault(),f=-1);break;case 39:t.shiftKey?c=1:(t.preventDefault(),f=1);break;case 38:t.shiftKey?d=1:(t.preventDefault(),m=-1);break;case 40:t.shiftKey?d=-1:(t.preventDefault(),m=1);break;default:return}return this._rotationDisabled&&(c=0,d=0),{cameraAnimation:y=>{const v=y.getZoom();y.easeTo({duration:300,easeId:"keyboardHandler",easing:vf,zoom:n?Math.round(v)+n*(t.shiftKey?2:1):v,bearing:y.getBearing()+c*this._bearingStep,pitch:y.getPitch()+d*this._pitchStep,offset:[-f*this._panStep,-m*this._panStep],center:y.getCenter()},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function vf(l){return l*(2-l)}const kh=4.000244140625,xf=1/450;class bf{constructor(t,n){this._map=t,this._el=t.getCanvasContainer(),this._handler=n,this._delta=0,this._lastDelta=0,this._defaultZoomRate=.01,this._wheelZoomRate=xf,o.aV(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(t){this._defaultZoomRate=t}setWheelZoomRate(t){this._wheelZoomRate=t}isEnabled(){return!!this._enabled}isActive(){return this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(t){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!t&&t.around==="center",this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(t){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(t.ctrlKey||t.metaKey||this.isZooming()||o.ex()))return void this._showBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let n=t.deltaMode===WheelEvent.DOM_DELTA_LINE?40*t.deltaY:t.deltaY;const c=o.q.now(),d=c-(this._lastWheelEventTime||0);this._lastWheelEventTime=c,n!==0&&n%kh==0?this._type="wheel":n!==0&&Math.abs(n)<4?this._type="trackpad":d>400?(this._type=null,this._lastValue=n,this._timeout=window.setTimeout(this._onTimeout,40,t)):this._type||(this._type=Math.abs(d*n)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,n+=this._lastValue)),t.shiftKey&&n&&(n/=4),this._type&&(this._lastWheelEvent=t,this._delta-=n,this._active||this._start(t)),t.preventDefault()}_onTimeout(t){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(t)}_start(t){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const n=Gt(this._el,t);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:n,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const t=this._map.transform;this._type==="wheel"&&t.projection.wrap&&(t._center.lng>=180||t._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);const n=()=>t._terrainEnabled()&&this._aroundCoord?t.computeZoomRelativeTo(this._aroundCoord):t.zoom;if(this._delta!==0){const T=this._type==="wheel"&&Math.abs(this._delta)>kh?this._wheelZoomRate:this._defaultZoomRate;let S=2/(1+Math.exp(-Math.abs(this._delta*T)));this._delta<0&&S!==0&&(S=1/S);const C=n(),I=Math.pow(2,C),M=typeof this._targetZoom=="number"?t.zoomScale(this._targetZoom):I;this._targetZoom=Math.min(t.maxZoom,Math.max(t.minZoom,t.scaleZoom(M*S))),this._type==="wheel"&&(this._startZoom=C,this._easing=this._smoothOutEasing(200)),this._lastDelta=this._delta,this._delta=0}const c=typeof this._targetZoom=="number"?this._targetZoom:n(),d=this._startZoom,f=this._easing;let m,y=!1;if(this._type==="wheel"&&d&&f){const T=Math.min((o.q.now()-this._lastWheelEventTime)/200,1),S=f(T);m=o.ai(d,c,S),T<1?this._frameId||(this._frameId=!0):y=!0}else m=c,y=!0;this._active=!0,y&&(this._active=!1,this._finishTimeout=window.setTimeout(()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout},200));let v=m-n();return v*this._lastDelta<0&&(v=0),{noInertia:!0,needsRenderFrame:!y,zoomDelta:v,around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(t){let n=o.ey;if(this._prevEase){const c=this._prevEase,d=(o.q.now()-c.start)/c.duration,f=c.easing(d+.01)-c.easing(d),m=.27/Math.sqrt(f*f+1e-4)*.01,y=Math.sqrt(.0729-m*m);n=o.ew(m,y,.25,1)}return this._prevEase={start:o.q.now(),duration:t,easing:n},n}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=re("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.removeAttribute("role")},200)}}class wf{constructor(t,n){this._clickZoom=t,this._tapZoom=n}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class Tf{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(t,n){return t.preventDefault(),{cameraAnimation:c=>{c.easeTo({duration:300,zoom:c.getZoom()+(t.shiftKey?-1:1),around:c.unproject(n)},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Sf{constructor(){this._tap=new ql({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(t,n,c){this._swipePoint||(this._tapTime&&t.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?c.length>0&&(this._swipePoint=n[0],this._swipeTouch=c[0].identifier):this._tap.touchstart(t,n,c))}touchmove(t,n,c){if(this._tapTime){if(this._swipePoint){if(c[0].identifier!==this._swipeTouch)return;const d=n[0],f=d.y-this._swipePoint.y;return this._swipePoint=d,t.preventDefault(),this._active=!0,{zoomDelta:f/128}}}else this._tap.touchmove(t,n,c)}touchend(t,n,c){this._tapTime?this._swipePoint&&c.length===0&&this.reset():this._tap.touchend(t,n,c)&&(this._tapTime=t.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Ef{constructor(t,n,c){this._el=t,this._mousePan=n,this._touchPan=c}enable(t){this._inertiaOptions=t||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class pm{constructor(t,n,c){this._pitchWithRotate=t.pitchWithRotate,this._mouseRotate=n,this._mousePitch=c}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class mm{constructor(t,n,c,d){this._el=t,this._touchZoom=n,this._touchRotate=c,this._tapDragZoom=d,this._rotationDisabled=!1,this._enabled=!0}enable(t){this._touchZoom.enable(t),this._rotationDisabled||this._touchRotate.enable(t),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const au=l=>l.zoom||l.drag||l.pitch||l.rotate;class Tr extends o.A{}class If{constructor(){this.constants=[1,1,.01],this.radius=0}setup(t,n){const c=o.at([],n,t);this.radius=o.ae(c[2]<0?o.eA([],c,this.constants):[c[0],c[1],0])}projectRay(t){o.eA(t,t,this.constants),o.au(t,t),o.eB(t,t,this.constants);const n=o.bY([],t,this.radius);if(n[2]>0){const c=o.bY([],[0,0,1],o.bG(n,[0,0,1])),d=o.bY([],o.au([],[n[0],n[1],0]),this.radius),f=o.cV([],n,o.bY([],o.at([],o.cV([],d,c),n),2));n[0]=f[0],n[1]=f[1]}return n}}function lu(l){return l.panDelta&&l.panDelta.mag()||l.zoomDelta||l.bearingDelta||l.pitchDelta}class Fh{constructor(t,n){this._map=t,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new iu(t),this._bearingSnap=n.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new If,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(n),o.aV(["handleEvent","handleWindowEvent"],this);const c=this._el;this._listeners=[[c,"touchstart",{passive:!0}],[c,"touchmove",{passive:!1}],[c,"touchend",void 0],[c,"touchcancel",void 0],[c,"mousedown",void 0],[c,"mousemove",void 0],[c,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[c,"mouseover",void 0],[c,"mouseout",void 0],[c,"dblclick",void 0],[c,"click",void 0],[c,"keydown",{capture:!1}],[c,"keyup",void 0],[c,"wheel",{passive:!1}],[c,"contextmenu",void 0],[window,"blur",void 0]];for(const[d,f,m]of this._listeners){const y=d===document?this.handleWindowEvent:this.handleEvent;d.addEventListener(f,y,m)}}destroy(){for(const[t,n,c]of this._listeners){const d=t===document?this.handleWindowEvent:this.handleEvent;t.removeEventListener(n,d,c)}}_addDefaultHandlers(t){const n=this._map,c=n.getCanvasContainer();this._add("mapEvent",new Mh(n,t));const d=n.boxZoom=new Ph(n,t);this._add("boxZoom",d);const f=new Rh,m=new Tf;n.doubleClickZoom=new wf(m,f),this._add("tapZoom",f),this._add("clickZoom",m);const y=new Sf;this._add("tapDragZoom",y);const v=n.touchPitch=new _f(n);this._add("touchPitch",v);const T=new nu(t),S=new ea(t);n.dragRotate=new pm(t,T,S),this._add("mouseRotate",T,["mousePitch"]),this._add("mousePitch",S,["mouseRotate"]);const C=new Lh(t),I=new Dh(n,t);n.dragPan=new Ef(c,C,I),this._add("mousePan",C),this._add("touchPan",I,["touchZoom","touchRotate"]);const M=new mf,D=new Oh;n.touchZoomRotate=new mm(c,D,M,y),this._add("touchRotate",M,["touchPan","touchZoom"]),this._add("touchZoom",D,["touchPan","touchRotate"]),this._add("blockableMapEvent",new ru(n));const z=n.scrollZoom=new bf(n,this);this._add("scrollZoom",z,["mousePan"]);const O=n.keyboard=new yf;this._add("keyboard",O);for(const B of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])t.interactive&&t[B]&&n[B].enable(t[B])}_add(t,n,c){this._handlers.push({handlerName:t,handler:n,allowed:c}),this._handlersById[t]=n}stop(t){if(!this._updatingCamera){for(const{handler:n}of this._handlers)n.reset();this._inertia.clear(),this._fireEvents({},{},t),this._changes=[],this._originalZoom=void 0}}isActive(){for(const{handler:t}of this._handlers)if(t.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!au(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(t,n,c){for(const d in t)if(d!==c&&(!n||n.indexOf(d)<0))return!0;return!1}handleWindowEvent(t){this.handleEvent(t,`${t.type}Window`)}_getMapTouches(t){const n=[];for(const c of t)this._el.contains(c.target)&&n.push(c);return n}handleEvent(t,n){this._updatingCamera=!0;const c=t.type==="renderFrame",d=c?void 0:t,f={needsRenderFrame:!1},m={},y={},v=t.touches?this._getMapTouches(t.touches):void 0,T=v?gi(this._el,v):c?void 0:Gt(this._el,t);for(const{handlerName:I,handler:M,allowed:D}of this._handlers){if(!M.isEnabled())continue;let z;this._blockedByActive(y,D,I)?M.reset():M[n||t.type]&&(z=M[n||t.type](t,T,v),this.mergeHandlerResult(f,m,z,I,d),z&&z.needsRenderFrame&&this._triggerRenderFrame()),(z||M.isActive())&&(y[I]=M)}const S={};for(const I in this._previousActiveHandlers)y[I]||(S[I]=d);this._previousActiveHandlers=y,(Object.keys(S).length||lu(f))&&(this._changes.push([f,m,S]),this._triggerRenderFrame()),(Object.keys(y).length||lu(f))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:C}=f;C&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],C(this._map))}mergeHandlerResult(t,n,c,d,f){if(!c)return;o.h(t,c);const m={handlerName:d,originalEvent:c.originalEvent||f};c.zoomDelta!==void 0&&(n.zoom=m),c.panDelta!==void 0&&(n.drag=m),c.pitchDelta!==void 0&&(n.pitch=m),c.bearingDelta!==void 0&&(n.rotate=m)}_applyChanges(){const t={},n={},c={};for(const[d,f,m]of this._changes)d.panDelta&&(t.panDelta=(t.panDelta||new o.P(0,0))._add(d.panDelta)),d.zoomDelta&&(t.zoomDelta=(t.zoomDelta||0)+d.zoomDelta),d.bearingDelta&&(t.bearingDelta=(t.bearingDelta||0)+d.bearingDelta),d.pitchDelta&&(t.pitchDelta=(t.pitchDelta||0)+d.pitchDelta),d.around!==void 0&&(t.around=d.around),d.aroundCoord!==void 0&&(t.aroundCoord=d.aroundCoord),d.pinchAround!==void 0&&(t.pinchAround=d.pinchAround),d.noInertia&&(t.noInertia=d.noInertia),o.h(n,f),o.h(c,m);this._updateMapTransform(t,n,c),this._changes=[]}_updateMapTransform(t,n,c){const d=this._map,f=d.transform,m=V=>[V.x,V.y,V.z];if((V=>{const H=this._eventsInProgress.drag;return H&&!this._handlersById[H.handlerName].isActive()})()&&!lu(t)){const V=f.zoom;f.cameraElevationReference="sea",this._originalZoom!=null&&f._orthographicProjectionAtLowPitch&&f.projection.name!=="globe"&&f.pitch===0?(f.cameraElevationReference="ground",f.zoom=this._originalZoom):(f.recenterOnTerrain(),f.cameraElevationReference="ground"),V!==f.zoom&&this._map._update(!0)}if(f._isCameraConstrained&&d._stop(!0),!lu(t))return void this._fireEvents(n,c,!0);let{panDelta:y,zoomDelta:v,bearingDelta:T,pitchDelta:S,around:C,aroundCoord:I,pinchAround:M}=t;f._isCameraConstrained&&(v>0&&(v=0),f._isCameraConstrained=!1),M!==void 0&&(C=M),(v||(V=>n[V]&&!this._eventsInProgress[V])("drag"))&&C&&(this._dragOrigin=m(f.pointCoordinate3D(C)),this._originalZoom=f.zoom,this._trackingEllipsoid.setup(f._camera.position,this._dragOrigin)),f.cameraElevationReference="sea",d._stop(!0),C=C||d.transform.centerPoint,T&&(f.bearing+=T),S&&(f.pitch+=S),f._updateCameraState();const D=[0,0,0];if(y)if(f.projection.name==="mercator"){const V=this._trackingEllipsoid.projectRay(f.screenPointToMercatorRay(C).dir),H=this._trackingEllipsoid.projectRay(f.screenPointToMercatorRay(C.sub(y)).dir);D[0]=H[0]-V[0],D[1]=H[1]-V[1]}else{const V=f.pointCoordinate(C);if(f.projection.name==="globe"){y=y.rotate(-f.angle);const H=f._pixelsPerMercatorPixel/f.worldSize;D[0]=-y.x*o.ez(o.aY(V.y))*H,D[1]=-y.y*o.ez(f.center.lat)*H}else{const H=f.pointCoordinate(C.sub(y));V&&H&&(D[0]=H.x-V.x,D[1]=H.y-V.y)}}const z=f.zoom,O=[0,0,0];if(v){const V=m(I||f.pointCoordinate3D(C)),H={dir:o.au([],o.at([],V,f._camera.position))};if(H.dir[2]<0){const Y=f.zoomDeltaToMovement(V,v);o.bY(O,H.dir,Y)}}const B=o.cV(D,D,O);f._translateCameraConstrained(B),v&&Math.abs(f.zoom-z)>1e-4&&f.recenterOnTerrain(),f.cameraElevationReference="ground",this._map._update(),t.noInertia||this._inertia.record(t),this._fireEvents(n,c,!0)}_fireEvents(t,n,c){const d=au(this._eventsInProgress),f=au(t),m={};for(const S in t){const{originalEvent:C}=t[S];this._eventsInProgress[S]||(m[`${S}start`]=C),this._eventsInProgress[S]=t[S]}!d&&f&&this._fireEvent("movestart",f.originalEvent);for(const S in m)this._fireEvent(S,m[S]);f&&this._fireEvent("move",f.originalEvent);for(const S in t){const{originalEvent:C}=t[S];this._fireEvent(S,C)}const y={};let v;for(const S in this._eventsInProgress){const{handlerName:C,originalEvent:I}=this._eventsInProgress[S];this._handlersById[C].isActive()||(delete this._eventsInProgress[S],v=n[C]||I,y[`${S}end`]=v)}for(const S in y)this._fireEvent(S,y[S]);const T=au(this._eventsInProgress);if(c&&(d||f)&&!T){this._updatingCamera=!0;const S=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),C=I=>I!==0&&-this._bearingSnap<I&&I<this._bearingSnap;S?(C(S.bearing||this._map.getBearing())&&(S.bearing=0),this._map.easeTo(S,{originalEvent:v})):(this._map.fire(new o.A("moveend",{originalEvent:v})),C(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(t,n){this._map.fire(new o.A(t,n?{originalEvent:n}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(t=>{this._frameId=void 0,this.handleEvent(new Tr("renderFrame",{timeStamp:t})),this._applyChanges()})}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}const Af="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class Wl extends o.E{constructor(t,n){super(),this._moving=!1,this._zooming=!1,this.transform=t,this._bearingSnap=n.bearingSnap,this._respectPrefersReducedMotion=n.respectPrefersReducedMotion!==!1,o.aV(["_renderFrameCallback"],this)}getCenter(){return new o.cd(this.transform.center.lng,this.transform.center.lat)}setCenter(t,n){return this.jumpTo({center:t},n)}panBy(t,n,c){return t=o.P.convert(t).mult(-1),this.panTo(this.transform.center,o.h({offset:t},n),c)}panTo(t,n,c){return this.easeTo(o.h({center:t},n),c)}getZoom(){return this.transform.zoom}setZoom(t,n){return this.jumpTo({zoom:t},n),this}zoomTo(t,n,c){return this.easeTo(o.h({zoom:t},n),c)}zoomIn(t,n){return this.zoomTo(this.getZoom()+1,t,n),this}zoomOut(t,n){return this.zoomTo(this.getZoom()-1,t,n),this}getBearing(){return this.transform.bearing}setBearing(t,n){return this.jumpTo({bearing:t},n),this}getPadding(){return this.transform.padding}setPadding(t,n){return this.jumpTo({padding:t},n),this}rotateTo(t,n,c){return this.easeTo(o.h({bearing:t},n),c)}resetNorth(t,n){return this.rotateTo(0,o.h({duration:1e3},t),n),this}resetNorthPitch(t,n){return this.easeTo(o.h({bearing:0,pitch:0,duration:1e3},t),n),this}snapToNorth(t,n){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(t,n):this}getPitch(){return this.transform.pitch}setPitch(t,n){return this.jumpTo({pitch:t},n),this}cameraForBounds(t,n){t=o.aG.convert(t);const c=n&&n.bearing||0,d=n&&n.pitch||0,f=t.getNorthWest(),m=t.getSouthEast();return this._cameraForBounds(this.transform,f,m,c,d,n)}_extendPadding(t){const n={top:0,right:0,bottom:0,left:0};return t==null?o.h({},n,this.transform.padding):typeof t=="number"?{top:t,bottom:t,right:t,left:t}:o.h({},n,t)}_extendCameraOptions(t){return(t=o.h({offset:[0,0],maxZoom:this.transform.maxZoom},t)).padding=this._extendPadding(t.padding),t}_minimumAABBFrustumDistance(t,n){const c=n.max[0]-n.min[0],d=n.max[1]-n.min[1];return c/d>t.aspect?c/(2*Math.tan(.5*t.fovX)*t.aspect):d/(2*Math.tan(.5*t.fovY)*t.aspect)}_cameraForBoundsOnGlobe(t,n,c,d,f,m){const y=t.clone(),v=this._extendCameraOptions(m);y.bearing=d,y.pitch=f;const T=o.cd.convert(n),S=o.cd.convert(c),C=.5*(T.lat+S.lat),I=.5*(T.lng+S.lng),M=o.eC(C,I),D=o.au([],M),z=o.au([],o.bF([],D,[0,1,0])),O=o.bF([],z,D),B=[z[0],z[1],z[2],0,O[0],O[1],O[2],0,D[0],D[1],D[2],0,0,0,0,1],V=[M,o.eC(T.lat,T.lng),o.eC(S.lat,T.lng),o.eC(S.lat,S.lng),o.eC(T.lat,S.lng),o.eC(C,T.lng),o.eC(C,S.lng),o.eC(T.lat,I),o.eC(S.lat,I)];let H=o.cW.fromPoints(V.map(Se=>[o.bG(z,Se),o.bG(O,Se),o.bG(D,Se)]));const Y=o.ad([],H.center,B);o.eD(Y)===0&&o.eE(Y,0,0,1),o.au(Y,Y),o.bY(Y,Y,o.aB),y.center=o.eF(Y);const te=y.getWorldToCameraMatrix(),ee=o.bi(new Float64Array(16),te);H=o.cW.applyTransform(H,o.az([],te,B));const J=this._extendAABB(H,y,v,d);if(!J)return void o.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");H=J,o.ad(Y,Y,te);const K=.5*(H.max[2]-H.min[2]),ie=this._minimumAABBFrustumDistance(y,H),se=o.bY([],[0,0,1],K),ye=o.cV(se,Y,se),ve=ie+(y.pitch===0?0:o.bD(Y,ye)),Oe=y.globeCenterInViewSpace,ke=o.at([],Y,[Oe[0],Oe[1],Oe[2]]);o.au(ke,ke),o.bY(ke,ke,ve);const Ze=o.cV([],Y,ke);o.ad(Ze,Ze,ee);const _e=o.eq/o.aB,Pe=o.ae(Ze),ue=o.c6(Math.max(Pe*_e-o.eq,Number.EPSILON),0),Ne=Math.min(y.zoomFromMercatorZAdjusted(ue),v.maxZoom);return Ne>.5*(o.cL+o.cx)?(y.setProjection({name:"mercator"}),y.zoom=Ne,this._cameraForBounds(y,n,c,d,f,m)):{center:y.center,zoom:Ne,bearing:d,pitch:f}}_extendAABB(t,n,c,d){const f=.5*((c.padding.left||0)+(c.padding.right||0)),m=.5*((c.padding.top||0)+(c.padding.bottom||0)),y=m,v=f,T=f,S=m,C=n.width-(v+T),I=n.height-(y+S),M=o.at([],t.max,t.min),D=Math.min(C/M[0],I/M[1]),z=Math.min(n.scaleZoom(n.scale*D),c.maxZoom);if(isNaN(z))return null;const O=n.scale/n.zoomScale(z),B=new o.cW([t.min[0]-v*O,t.min[1]-S*O,t.min[2]],[t.max[0]+T*O,t.max[1]+y*O,t.max[2]]),V=(typeof c.offset.x=="number"&&typeof c.offset.y=="number"?new o.P(c.offset.x,c.offset.y):o.P.convert(c.offset)).rotate(-o.al(d));return B.center[0]-=V.x*O,B.center[1]+=V.y*O,B}queryTerrainElevation(t,n){const c=this.transform.elevation;return c?(n=o.h({},{exaggerated:!0},n),c.getAtPoint(o.ac.fromLngLat(t),null,n.exaggerated)):null}_cameraForBounds(t,n,c,d,f,m){if(t.projection.name==="globe")return this._cameraForBoundsOnGlobe(t,n,c,d,f,m);const y=t.clone(),v=this._extendCameraOptions(m);y.bearing=d,y.pitch=f;const T=o.cd.convert(n),S=o.cd.convert(c),C=new o.cd(T.lng,S.lat),I=new o.cd(S.lng,T.lat),M=y.project(T),D=y.project(S),z=this.queryTerrainElevation(T),O=this.queryTerrainElevation(S),B=this.queryTerrainElevation(C),V=this.queryTerrainElevation(I),H=[[M.x,M.y,Math.min(z||0,O||0,B||0,V||0)],[D.x,D.y,Math.max(z||0,O||0,B||0,V||0)]];let Y=o.cW.fromPoints(H);const te=y.getWorldToCameraMatrix(),ee=o.bi(new Float64Array(16),te);Y=o.cW.applyTransform(Y,te);const J=this._extendAABB(Y,y,v,d);if(!J)return void o.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");Y=J;const K=.5*o.at([],Y.max,Y.min)[2],ie=this._minimumAABBFrustumDistance(y,Y),se=[0,0,1,0];o.aA(se,se,te),o.eG(se,se);const ye=o.bY([],se,ie+K),ve=o.cV([],Y.center,ye);o.ad(Y.center,Y.center,ee),o.ad(ve,ve,ee);const Oe=y.unproject(new o.P(Y.center[0],Y.center[1])),ke=o.eH(y.projection,Oe),Ze=Math.pow(2,ke),_e=Math.min(y._zoomFromMercatorZ(ve[2]*y.pixelsPerMeter*Ze/y.worldSize),v.maxZoom);return y.mercatorFromTransition&&_e<.5*(o.cL+o.cx)?(y.setProjection({name:"globe"}),y.zoom=_e,this._cameraForBounds(y,n,c,d,f,m)):{center:Oe,zoom:_e,bearing:d,pitch:f}}fitBounds(t,n,c){const d=this.cameraForBounds(t,n);return this._fitInternal(d,n,c)}fitScreenCoordinates(t,n,c,d,f){const m=o.P.convert(t),y=o.P.convert(n),v=new o.P(Math.min(m.x,y.x),Math.min(m.y,y.y)),T=new o.P(Math.max(m.x,y.x),Math.max(m.y,y.y));if(this.transform.projection.name==="mercator"&&this.transform.anyCornerOffEdge(m,y))return this;const S=this.transform.pointLocation3D(v),C=this.transform.pointLocation3D(T),I=this.transform.pointLocation3D(new o.P(v.x,T.y)),M=this.transform.pointLocation3D(new o.P(T.x,v.y)),D=[Math.min(S.lng,C.lng,I.lng,M.lng),Math.min(S.lat,C.lat,I.lat,M.lat)],z=[Math.max(S.lng,C.lng,I.lng,M.lng),Math.max(S.lat,C.lat,I.lat,M.lat)],O=d&&d.pitch?d.pitch:this.getPitch(),B=this._cameraForBounds(this.transform,D,z,c,O,d);return this._fitInternal(B,d,f)}_fitInternal(t,n,c){return t?(n=o.h(t,n)).linear?this.easeTo(n,c):this.flyTo(n,c):this}jumpTo(t,n){this.stop();const c=t.preloadOnly?this.transform.clone():this.transform;let d=!1,f=!1,m=!1;"zoom"in t&&c.zoom!==+t.zoom&&(d=!0,c.zoom=+t.zoom),t.center!==void 0&&(c.center=o.cd.convert(t.center)),"bearing"in t&&c.bearing!==+t.bearing&&(f=!0,c.bearing=+t.bearing),"pitch"in t&&c.pitch!==+t.pitch&&(m=!0,c.pitch=+t.pitch);const y=typeof t.padding=="number"?this._extendPadding(t.padding):t.padding;if(t.padding!=null&&!c.isPaddingEqual(y))if(t.retainPadding===!1){const v=c.clone();v.padding=y,c.setLocationAtPoint(c.center,v.centerPoint)}else c.padding=y;return t.preloadOnly?(this._preloadTiles(c),this):(this.fire(new o.A("movestart",n)).fire(new o.A("move",n)),d&&this.fire(new o.A("zoomstart",n)).fire(new o.A("zoom",n)).fire(new o.A("zoomend",n)),f&&this.fire(new o.A("rotatestart",n)).fire(new o.A("rotate",n)).fire(new o.A("rotateend",n)),m&&this.fire(new o.A("pitchstart",n)).fire(new o.A("pitch",n)).fire(new o.A("pitchend",n)),this.fire(new o.A("moveend",n)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||o.w(Af),this.transform.getFreeCameraOptions()}setFreeCameraOptions(t,n){const c=this.transform;if(!c.projection.supportsFreeCamera)return o.w(Af),this;this.stop();const d=c.zoom,f=c.pitch,m=c.bearing;c.setFreeCameraOptions(t);const y=d!==c.zoom,v=f!==c.pitch,T=m!==c.bearing;return this.fire(new o.A("movestart",n)).fire(new o.A("move",n)),y&&this.fire(new o.A("zoomstart",n)).fire(new o.A("zoom",n)).fire(new o.A("zoomend",n)),T&&this.fire(new o.A("rotatestart",n)).fire(new o.A("rotate",n)).fire(new o.A("rotateend",n)),v&&this.fire(new o.A("pitchstart",n)).fire(new o.A("pitch",n)).fire(new o.A("pitchend",n)),this.fire(new o.A("moveend",n)),this}easeTo(t,n){this._stop(!1,t.easeId),((t=o.h({offset:[0,0],duration:500,easing:o.ey},t)).animate===!1||this._prefersReducedMotion(t))&&(t.duration=0);const c=this.transform,d=this.getZoom(),f=this.getBearing(),m=this.getPitch(),y=this.getPadding(),v="zoom"in t?+t.zoom:d,T="bearing"in t?this._normalizeBearing(t.bearing,f):f,S="pitch"in t?+t.pitch:m,C=this._extendPadding(t.padding),I=o.P.convert(t.offset);let M,D,z;if(c.projection.name==="globe"){const se=o.ac.fromLngLat(c.center),ye=I.rotate(-c.angle);se.x+=ye.x/c.worldSize,se.y+=ye.y/c.worldSize;const ve=se.toLngLat(),Oe=o.cd.convert(t.center||ve);this._normalizeCenter(Oe),M=c.centerPoint.add(ye),D=new o.P(se.x,se.y).mult(c.worldSize),z=new o.P(o.aD(Oe.lng),o.aH(Oe.lat)).mult(c.worldSize).sub(D)}else{M=c.centerPoint.add(I);const se=c.pointLocation(M),ye=o.cd.convert(t.center||se);this._normalizeCenter(ye),D=c.project(se),z=c.project(ye).sub(D)}const O=c.zoomScale(v-d);let B,V;t.around&&(B=o.cd.convert(t.around),V=c.locationPoint(B));const H=this._zooming||v!==d,Y=this._rotating||f!==T,te=this._pitching||S!==m,ee=!c.isPaddingEqual(C),J=t.retainPadding===!1?c.clone():c,K=se=>ye=>{if(H&&(se.zoom=o.ai(d,v,ye)),Y&&(se.bearing=o.ai(f,T,ye)),te&&(se.pitch=o.ai(m,S,ye)),ee&&(J.interpolatePadding(y,C,ye),M=J.centerPoint.add(I)),B)se.setLocationAtPoint(B,V);else{const ve=se.zoomScale(se.zoom-d),Oe=v>d?Math.min(2,O):Math.max(.5,O),ke=Math.pow(Oe,1-ye),Ze=se.unproject(D.add(z.mult(ye*ke)).mult(ve));se.setLocationAtPoint(se.renderWorldCopies?Ze.wrap():Ze,M)}return t.preloadOnly||this._fireMoveEvents(n),se};if(t.preloadOnly){const se=this._emulate(K,t.duration,c);return this._preloadTiles(se),this}const ie={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=H,this._rotating=Y,this._pitching=te,this._padding=ee,this._easeId=t.easeId,this._prepareEase(n,t.noMoveStart,ie),this._ease(K(c),se=>{c.cameraElevationReference==="sea"&&c.recenterOnTerrain(),this._afterEase(n,se)},t),this}_prepareEase(t,n,c={}){this._moving=!0,this.transform.cameraElevationReference="sea",this.transform._orthographicProjectionAtLowPitch&&this.transform.pitch===0&&this.transform.projection.name!=="globe"&&(this.transform.cameraElevationReference="ground"),n||c.moving||this.fire(new o.A("movestart",t)),this._zooming&&!c.zooming&&this.fire(new o.A("zoomstart",t)),this._rotating&&!c.rotating&&this.fire(new o.A("rotatestart",t)),this._pitching&&!c.pitching&&this.fire(new o.A("pitchstart",t))}_fireMoveEvents(t){this.fire(new o.A("move",t)),this._zooming&&this.fire(new o.A("zoom",t)),this._rotating&&this.fire(new o.A("rotate",t)),this._pitching&&this.fire(new o.A("pitch",t))}_afterEase(t,n){if(this._easeId&&n&&this._easeId===n)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";const c=this._zooming,d=this._rotating,f=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,c&&this.fire(new o.A("zoomend",t)),d&&this.fire(new o.A("rotateend",t)),f&&this.fire(new o.A("pitchend",t)),this.fire(new o.A("moveend",t))}flyTo(t,n){if(this._prefersReducedMotion(t)){const Se=o.aF(t,["center","zoom","bearing","pitch","around","padding","retainPadding"]);return this.jumpTo(Se,n)}this.stop(),t=o.h({offset:[0,0],speed:1.2,curve:1.42,easing:o.ey},t);const c=this.transform,d=this.getZoom(),f=this.getBearing(),m=this.getPitch(),y=this.getPadding(),v="zoom"in t?o.ay(+t.zoom,c.minZoom,c.maxZoom):d,T="bearing"in t?this._normalizeBearing(t.bearing,f):f,S="pitch"in t?+t.pitch:m,C=this._extendPadding(t.padding),I=c.zoomScale(v-d),M=o.P.convert(t.offset);let D=c.centerPoint.add(M);const z=c.pointLocation(D),O=o.cd.convert(t.center||z);this._normalizeCenter(O);const B=c.project(z),V=c.project(O).sub(B);let H=t.curve;const Y=Math.max(c.width,c.height),te=Y/I,ee=V.mag();if("minZoom"in t){const Se=o.ay(Math.min(t.minZoom,d,v),c.minZoom,c.maxZoom),qe=Y/c.zoomScale(Se-d);H=Math.sqrt(qe/ee*2)}const J=H*H;function K(Se){const qe=(te*te-Y*Y+(Se?-1:1)*J*J*ee*ee)/(2*(Se?te:Y)*J*ee);return Math.log(Math.sqrt(qe*qe+1)-qe)}function ie(Se){return(Math.exp(Se)-Math.exp(-Se))/2}function se(Se){return(Math.exp(Se)+Math.exp(-Se))/2}const ye=K(0);let ve=function(Se){return se(ye)/se(ye+H*Se)},Oe=function(Se){return Y*((se(ye)*(ie(qe=ye+H*Se)/se(qe))-ie(ye))/J)/ee;var qe},ke=(K(1)-ye)/H;if(Math.abs(ee)<1e-6||!isFinite(ke)){if(Math.abs(Y-te)<1e-6)return this.easeTo(t,n);const Se=te<Y?-1:1;ke=Math.abs(Math.log(te/Y))/H,Oe=function(){return 0},ve=function(qe){return Math.exp(Se*H*qe)}}t.duration="duration"in t?+t.duration:1e3*ke/("screenSpeed"in t?+t.screenSpeed/H:+t.speed),t.maxDuration&&t.duration>t.maxDuration&&(t.duration=0);const Ze=f!==T,_e=S!==m,Pe=!c.isPaddingEqual(C),ue=t.retainPadding===!1?c.clone():c,Ne=Se=>qe=>{const rt=qe*ke,Fe=1/ve(rt);Se.zoom=qe===1?v:d+Se.scaleZoom(Fe),Ze&&(Se.bearing=o.ai(f,T,qe)),_e&&(Se.pitch=o.ai(m,S,qe)),Pe&&(ue.interpolatePadding(y,C,qe),D=ue.centerPoint.add(M));const tt=qe===1?O:Se.unproject(B.add(V.mult(Oe(rt))).mult(Fe));return Se.setLocationAtPoint(Se.renderWorldCopies?tt.wrap():tt,D),Se._updateCameraOnTerrain(),t.preloadOnly||this._fireMoveEvents(n),Se};if(t.preloadOnly){const Se=this._emulate(Ne,t.duration,c);return this._preloadTiles(Se),this}return this._zooming=!0,this._rotating=Ze,this._pitching=_e,this._padding=Pe,this._prepareEase(n,!1),this._ease(Ne(c),()=>this._afterEase(n),t),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_requestRenderFrame(t){}_cancelRenderFrame(t){}_stop(t,n){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){const c=this._onEaseEnd;this._onEaseEnd=void 0,c.call(this,n)}if(!t){const c=this.handlers;c&&c.stop(!1)}return this}_ease(t,n,c){c.animate===!1||c.duration===0?(t(1),n()):(this._easeStart=o.q.now(),this._easeOptions=c,this._onEaseFrame=t,this._onEaseEnd=n,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const t=Math.min((o.q.now()-this._easeStart)/this._easeOptions.duration,1),n=this._onEaseFrame;n&&n(this._easeOptions.easing(t)),t<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(t,n){t=o.bX(t,-180,180);const c=Math.abs(t-n);return Math.abs(t-360-n)<c&&(t-=360),Math.abs(t+360-n)<c&&(t+=360),t}_normalizeCenter(t){const n=this.transform;if(n.maxBounds||n.projection.name!=="globe"&&!n.renderWorldCopies)return;const c=t.lng-n.center.lng;t.lng+=c>180?-360:c<-180?360:0}_prefersReducedMotion(t){return this._respectPrefersReducedMotion&&o.q.prefersReducedMotion&&!(t&&t.essential)}_emulate(t,n,c){const d=Math.ceil(15*n/1e3),f=[],m=t(c.clone());for(let y=0;y<=d;y++){const v=m(y/d);f.push(v.clone())}return f}_preloadTiles(t,n){}}class Bh{constructor(t={}){this.options=t,o.aV(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(t){const n=this.options&&this.options.compact,c=t._getUIString("AttributionControl.ToggleAttribution");this._map=t,this._container=re("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=re("button","mapboxgl-ctrl-attrib-button",this._container),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._compactButton.setAttribute("aria-label",c);const d=re("span","mapboxgl-ctrl-icon",this._compactButton);return d.setAttribute("aria-hidden","true"),d.setAttribute("title",c),this._innerContainer=re("div","mapboxgl-ctrl-attrib-inner",this._container),n&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),n===void 0&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let t=this._editLink;t||(t=this._editLink=this._container.querySelector(".mapbox-improve-map"));const n=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||o.e.ACCESS_TOKEN}];if(t){const c=n.reduce((d,f,m)=>(f.value&&(d+=`${f.key}=${f.value}${m<n.length-1?"&":""}`),d),"?");t.href=`${o.e.FEEDBACK_URL}/${c}#${tu(this._map,!0)}`,t.rel="noopener nofollow"}}_updateData(t){!t||t.sourceDataType!=="metadata"&&t.sourceDataType!=="visibility"&&t.dataType!=="style"||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let t=[];if(this._map.style.stylesheet){const d=this._map.style.stylesheet;this.styleOwner=d.owner,this.styleId=d.id}const n=this._map.style._mergedSourceCaches;for(const d in n){const f=n[d];if(f.used){const m=f.getSource();m.attribution&&t.indexOf(m.attribution)<0&&t.push(m.attribution)}}t.sort((d,f)=>d.length-f.length),t=t.filter((d,f)=>{for(let m=f+1;m<t.length;m++)if(t[m].indexOf(d)>=0)return!1;return!0}),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?t=[...this.options.customAttribution,...t]:t.unshift(this.options.customAttribution));const c=t.join(" | ");c!==this._attribHTML&&(this._attribHTML=c,t.length?(this._innerContainer.innerHTML=c,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class cu{constructor(){o.aV(["_updateLogo","_updateCompact"],this)}onAdd(t){this._map=t,this._container=re("div","mapboxgl-ctrl");const n=re("a","mapboxgl-ctrl-logo");return n.target="_blank",n.rel="noopener nofollow",n.href="https://www.mapbox.com/",n.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),n.setAttribute("rel","noopener nofollow"),this._container.appendChild(n),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(t){t&&t.sourceDataType!=="metadata"||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;const t=this._map.style._sourceCaches;if(Object.entries(t).length===0)return!0;for(const n in t){const c=t[n].getSource();if(c.hasOwnProperty("mapbox_logo")&&!c.mapbox_logo)return!1}return!0}_updateCompact(){const t=this._container.children;if(t.length){const n=t[0];this._map.getCanvasContainer().offsetWidth<250?n.classList.add("mapboxgl-compact"):n.classList.remove("mapboxgl-compact")}}}class Xl{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(t){const n=++this._id;return this._queue.push({callback:t,id:n,cancelled:!1}),n}remove(t){const n=this._currentlyRunning,c=n?this._queue.concat(n):this._queue;for(const d of c)if(d.id===t)return void(d.cancelled=!0)}run(t=0){const n=this._currentlyRunning=this._queue;this._queue=[];for(const c of n)if(!c.cancelled&&(c.callback(t),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}class Vs{constructor(t){this.jumpTo(t)}getValue(t){if(t<=this._startTime)return this._start;if(t>=this._endTime)return this._end;const n=o.dk((t-this._startTime)/(this._endTime-this._startTime));return this._start*(1-n)+this._end*n}isEasing(t){return t>=this._startTime&&t<=this._endTime}jumpTo(t){this._startTime=-1/0,this._endTime=-1/0,this._start=t,this._end=t}easeTo(t,n,c){this._start=this.getValue(n),this._end=t,this._startTime=n,this._endTime=n+c}}const uu={"AttributionControl.ToggleAttribution":"Toggle attribution","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox homepage","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use ⌘ + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"};class kr extends o.A{constructor(t,n,c,d){const{point:f,lngLat:m,originalEvent:y,target:v}=t;super(t.type,{point:f,lngLat:m,originalEvent:y,target:v}),this.preventDefault=()=>{t.preventDefault()},this.id=n,this.interaction=c,this.feature=d}}class vs{constructor(t){this.map=t,this.interactionsByType=new Map,this.delegatedInteractions=new Map,this.typeById=new Map,this.filters=new Map,this.handleType=this.handleType.bind(this),this.handleMove=this.handleMove.bind(this),this.handleOut=this.handleOut.bind(this),this.hoveredFeatures=new Map,this.prevHoveredFeatures=new Map}add(t,n){if(this.typeById.has(t))throw new Error(`Interaction id "${t}" already exists.`);const c=n.filter;let d=n.type;c&&this.filters.set(t,o.b3(c)),d==="mouseover"&&(d="mouseenter"),d==="mouseout"&&(d="mouseleave");const f=this.interactionsByType.get(d)||new Map;d==="mouseenter"||d==="mouseleave"?(this.delegatedInteractions.size===0&&(this.map.on("mousemove",this.handleMove),this.map.on("mouseout",this.handleOut)),this.delegatedInteractions.set(t,n)):f.size===0&&this.map.on(d,this.handleType),f.size===0&&this.interactionsByType.set(d,f),f.set(t,n),this.typeById.set(t,d)}get(t){const n=this.typeById.get(t);if(!n)return;const c=this.interactionsByType.get(n);return c?c.get(t):void 0}remove(t){const n=this.typeById.get(t);if(!n)return;this.typeById.delete(t),this.filters.delete(t);const c=this.interactionsByType.get(n);c&&(c.delete(t),n==="mouseenter"||n==="mouseleave"?(this.delegatedInteractions.delete(t),this.delegatedInteractions.size===0&&(this.map.off("mousemove",this.handleMove),this.map.off("mouseout",this.handleOut))):c.size===0&&this.map.off(n,this.handleType))}queryTargets(t,n){const c=[];for(const[d,f]of n)f.target&&c.push({targetId:d,target:f.target,filter:this.filters.get(d)});return this.map.style.queryRenderedTargets(t,c,this.map.transform)}handleMove(t){this.prevHoveredFeatures=this.hoveredFeatures,this.hoveredFeatures=new Map;const n=this.queryTargets(t.point,Array.from(this.delegatedInteractions).reverse());n.length&&(t.type="mouseenter",this.handleType(t,n));const c=new Map;for(const[d,{feature:f}]of this.prevHoveredFeatures)this.hoveredFeatures.has(d)||c.set(f.id,f);c.size&&(t.type="mouseleave",this.handleType(t,Array.from(c.values())))}handleOut(t){const n=Array.from(this.hoveredFeatures.values()).map(({feature:c})=>c);n.length&&(t.type="mouseleave",this.handleType(t,n)),this.hoveredFeatures.clear()}handleType(t,n){const c=t.type==="mouseenter";if(c&&!this.interactionsByType.has(t.type))return void o.w("mouseenter interaction required for mouseleave to work.");const d=Array.from(this.interactionsByType.get(t.type)).reverse(),f=!!n;n=n||this.queryTargets(t.point,d);let m=!1;const y=new Set;for(const v of n){for(const[T,S]of d){if(!S.target)continue;const C=v.variants?v.variants[T]:null;if(C){for(const I of C){if(pc(I,v,y,T))continue;const M=new o.de(v,I),D=ll(I,v,T);f&&(M.state=this.map.getFeatureState(M));const z=c?this.prevHoveredFeatures.get(D):null,O=new kr(t,T,S,M),B=z?z.stop:S.handler(O);if(c&&this.hoveredFeatures.set(D,{feature:v,stop:B}),B!==!1){m=!0;break}}if(m)break}}if(m)break}if(!m)for(const[v,T]of d){const{handler:S,target:C}=T;if(!C&&S(new kr(t,v,T,null))!==!1)break}}}function Yl(l,t){if(Array.isArray(l)&&Array.isArray(t)){const n=new Set(l),c=new Set(t);return n.size===c.size&&l.every(d=>c.has(d))}return o.bv(l,t)}const hu={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,antialias:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,respectPrefersReducedMotion:!0,crossSourceCollisions:!0,collectResourceTiming:!1,testMode:!1,precompilePrograms:!0,scaleFactor:1,spriteFormat:"auto"},Cf={showCompass:!0,showZoom:!0,visualizePitch:!1};class _m{constructor(t,n,c=!1){this._clickTolerance=10,this.element=n,this.mouseRotate=new nu({clickTolerance:t.dragRotate._mouseRotate._clickTolerance}),this.map=t,c&&(this.mousePitch=new ea({clickTolerance:t.dragRotate._mousePitch._clickTolerance})),o.aV(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),n.addEventListener("mousedown",this.mousedown),n.addEventListener("touchstart",this.touchstart,{passive:!1}),n.addEventListener("touchmove",this.touchmove),n.addEventListener("touchend",this.touchend),n.addEventListener("touchcancel",this.reset)}down(t,n){this.mouseRotate.mousedown(t,n),this.mousePitch&&this.mousePitch.mousedown(t,n),nt()}move(t,n){const c=this.map,d=this.mouseRotate.mousemoveWindow(t,n),f=d&&d.bearingDelta;if(f&&c.setBearing(c.getBearing()+f),this.mousePitch){const m=this.mousePitch.mousemoveWindow(t,n),y=m&&m.pitchDelta;y&&c.setPitch(c.getPitch()+y)}}off(){const t=this.element;t.removeEventListener("mousedown",this.mousedown),t.removeEventListener("touchstart",this.touchstart),t.removeEventListener("touchmove",this.touchmove),t.removeEventListener("touchend",this.touchend),t.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){$e(),window.removeEventListener("mousemove",this.mousemove),window.removeEventListener("mouseup",this.mouseup)}mousedown(t){this.down(o.h({},t,{ctrlKey:!0,preventDefault:()=>t.preventDefault()}),Gt(this.element,t)),window.addEventListener("mousemove",this.mousemove),window.addEventListener("mouseup",this.mouseup)}mousemove(t){this.move(t,Gt(this.element,t))}mouseup(t){this.mouseRotate.mouseupWindow(t),this.mousePitch&&this.mousePitch.mouseupWindow(t),this.offTemp()}touchstart(t){t.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=gi(this.element,t.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>t.preventDefault()},this._startPos))}touchmove(t){t.targetTouches.length!==1?this.reset():(this._lastPos=gi(this.element,t.targetTouches)[0],this.move({preventDefault:()=>t.preventDefault()},this._lastPos))}touchend(t){t.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}function Ua(l,t,n){if(l=new o.cd(l.lng,l.lat),t){const c=new o.cd(l.lng-360,l.lat),d=new o.cd(l.lng+360,l.lat),f=360*Math.ceil(Math.abs(l.lng-n.center.lng)/360),m=n.locationPoint3D(l).distSqr(t),y=t.x<0||t.y<0||t.x>n.width||t.y>n.height;n.locationPoint3D(c).distSqr(t)<m&&(y||Math.abs(c.lng-n.center.lng)<f)?l=c:n.locationPoint3D(d).distSqr(t)<m&&(y||Math.abs(d.lng-n.center.lng)<f)&&(l=d)}for(;Math.abs(l.lng-n.center.lng)>180;){const c=n.locationPoint3D(l);if(c.x>=0&&c.y>=0&&c.x<=n.width&&c.y<=n.height)break;l.lng>n.center.lng?l.lng-=360:l.lng+=360}return l}const Nh={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"},xs={rotation:0,rotationAlignment:"auto",pitchAlignment:"auto",occludedOpacity:.2,altitude:0};class Kl extends o.E{constructor(t,n){super(),(t instanceof HTMLElement||n)&&(t=o.h({element:t},n)),o.aV(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this);const{anchor:c="center",color:d="#3FB1CE",scale:f=1,draggable:m=!1,clickTolerance:y=0,rotation:v=xs.rotation,rotationAlignment:T=xs.rotationAlignment,pitchAlignment:S=xs.pitchAlignment,occludedOpacity:C=xs.occludedOpacity,altitude:I=xs.altitude}=t||{};this._anchor=c,this._color=d,this._scale=f,this._draggable=m,this._clickTolerance=y,this._rotation=v,this._rotationAlignment=T,this._pitchAlignment=S,this._occludedOpacity=C,this._altitude=I,this._state="inactive",this._isDragging=!1,this._updateMoving=()=>this._update(!0),t&&t.element?(this._element=t.element,this._offset=o.P.convert(t&&t.offset||[0,0])):(this._defaultMarker=!0,this._element=this._createDefaultMarker(),this._offset=o.P.convert(t&&t.offset||[0,-14])),this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.hasAttribute("role")||this._element.setAttribute("role","img"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",z=>{z.preventDefault()}),this._element.addEventListener("mousedown",z=>{z.preventDefault()});const M=this._element.classList;for(const z in Nh)M.remove(`mapboxgl-marker-anchor-${z}`);M.add(`mapboxgl-marker-anchor-${this._anchor}`);const D=t&&t.className?t.className.trim().split(/\s+/):[];M.add(...D),this._popup=null}_createDefaultMarker(){const t=re("div"),n=Ge("svg",{display:"block",height:41*this._scale+"px",width:27*this._scale+"px",viewBox:"0 0 27 41"},t);if(this._altitude===0){const c=Ge("radialGradient",{id:"shadowGradient"},Ge("defs",{},n));Ge("stop",{offset:"10%","stop-opacity":.4},c),Ge("stop",{offset:"100%","stop-opacity":.05},c),Ge("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},n)}return Ge("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},n),Ge("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},n),Ge("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},n),t}addTo(t){return t===this._map||(this.remove(),this._map=t,t.getCanvasContainer().appendChild(this._element),t.on("move",this._updateMoving),t.on("moveend",this._update),t.on("remove",this._clearFadeTimer),t._addMarker(this),this.setDraggable(this._draggable),this._update(),t.on("click",this._onMapClick)),this}remove(){const t=this._map;return t&&(t.off("click",this._onMapClick),t.off("move",this._updateMoving),t.off("moveend",this._update),t.off("mousedown",this._addDragHandler),t.off("touchstart",this._addDragHandler),t.off("mouseup",this._onUp),t.off("touchend",this._onUp),t.off("mousemove",this._onMove),t.off("touchmove",this._onMove),t.off("remove",this._clearFadeTimer),t._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(t){return this._lngLat=o.cd.convert(t),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}setAltitude(t){return t===this._altitude||(this._defaultMarker&&(this._altitude===0&&t!==0||this._altitude!==0&&t===0)&&(this._element=this._createDefaultMarker()),this._altitude=t||xs.altitude,this._update()),this}getAltitude(){return this._altitude}getElement(){return this._element}setPopup(t){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),t){if(!("offset"in t.options)){const d=Math.sqrt(Math.pow(13.5,2)/2);t.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[d,-1*(38.1-13.5+d)],"bottom-right":[-d,-1*(38.1-13.5+d)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=t,t._marker=this,t._altitude=this._altitude,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(t){const n=t.code,c=t.charCode||t.keyCode;n!=="Space"&&n!=="Enter"&&c!==32&&c!==13||this.togglePopup()}_onMapClick(t){const n=t.originalEvent.target,c=this._element;this._popup&&(n===c||c.contains(n))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const t=this._popup;return t?(t.isOpen()?(t.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(t.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){const t=this._map,n=this._pos;if(!t||!n)return!1;const c=t.unproject(n,this._altitude),d=t.getFreeCameraOptions();if(!d.position)return!1;const f=d.position.toLngLat();return f.distanceTo(c)<.9*f.distanceTo(this._lngLat)}_evaluateOpacity(){const t=this._map;if(!t)return;const n=this._pos;if(!n||n.x<0||n.x>t.transform.width||n.y<0||n.y>t.transform.height)return void this._clearFadeTimer();const c=t.unproject(n,this._altitude);let d;t._showingGlobe()&&o.eK(t.transform,this._lngLat)?d=0:(d=1-t._queryFogOpacity(c),t.transform._terrainEnabled()&&t.getTerrain()&&this._behindTerrain()&&(d*=this._occludedOpacity)),this._element.style.opacity=`${d}`,this._element.style.pointerEvents=d>0?"auto":"none",this._popup&&this._popup._setOpacity(d),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){const t=this._pos;if(!t||!this._map)return;const n=this._offset.mult(this._scale);this._element.style.transform=`
            translate(${t.x}px,${t.y}px)
            ${Nh[this._anchor]}
            ${this._calculateXYTransform()} ${this._calculateZTransform()}
            translate(${n.x}px,${n.y}px)
        `}_calculateXYTransform(){const t=this._pos,n=this._map,c=this.getPitchAlignment();if(!n||!t||c!=="map")return"";if(!n._showingGlobe()){const v=n.getPitch();return v?`rotateX(${v}deg)`:""}const d=o.cJ(o.eL(n.transform,this._lngLat)),f=t.sub(o.eM(n.transform)),m=Math.abs(f.x)+Math.abs(f.y);if(m===0)return"";const y=d/m;return`rotateX(${-f.y*y}deg) rotateY(${f.x*y}deg)`}_calculateZTransform(){const t=this._pos,n=this._map;if(!n||!t)return"";let c=0;const d=this.getRotationAlignment();if(d==="map")if(n._showingGlobe()){const f=n.project(new o.cd(this._lngLat.lng,this._lngLat.lat+.001),this._altitude),m=n.project(new o.cd(this._lngLat.lng,this._lngLat.lat-.001),this._altitude).sub(f);c=o.cJ(Math.atan2(m.y,m.x))-90}else c=-n.getBearing();else if(d==="horizon"){const f=o.af(4,6,n.getZoom()),m=o.eM(n.transform);m.y+=f*n.transform.height;const y=t.sub(m),v=o.cJ(Math.atan2(y.y,y.x));c=(v>90?v-270:v+90)*(1-f)}return c+=this._rotation,c?`rotateZ(${c}deg)`:""}_update(t){cancelAnimationFrame(this._updateFrameId);const n=this._map;n&&(n.transform.renderWorldCopies&&(this._lngLat=Ua(this._lngLat,this._pos,n.transform)),this._pos=n.project(this._lngLat,this._altitude),t===!0?this._updateFrameId=requestAnimationFrame(()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())}):this._pos=this._pos.round(),n._requestDomTask(()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(n._showingGlobe()||n.getTerrain()||n.getFog())&&!this._fadeTimer&&(this._fadeTimer=window.setTimeout(this._evaluateOpacity.bind(this),60)))}))}getOffset(){return this._offset}setOffset(t){return this._offset=o.P.convert(t),this._update(),this}addClassName(t){return this._element.classList.add(t),this}removeClassName(t){return this._element.classList.remove(t),this}toggleClassName(t){return this._element.classList.toggle(t)}_onMove(t){const n=this._map;if(!n)return;const c=this._pointerdownPos,d=this._positionDelta;if(c&&d){if(!this._isDragging){const f=this._clickTolerance||n._clickTolerance;if(t.point.dist(c)<f)return;this._isDragging=!0}this._pos=t.point.sub(d),this._lngLat=n.unproject(this._pos,this._altitude),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new o.A("dragstart"))),this.fire(new o.A("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;const t=this._map;t&&(t.off("mousemove",this._onMove),t.off("touchmove",this._onMove)),this._state==="active"&&this.fire(new o.A("dragend")),this._state="inactive"}_addDragHandler(t){const n=this._map,c=this._pos;n&&c&&this._element.contains(t.originalEvent.target)&&(t.preventDefault(),this._positionDelta=t.point.sub(c),this._pointerdownPos=t.point,this._state="pending",n.on("mousemove",this._onMove),n.on("touchmove",this._onMove),n.once("mouseup",this._onUp),n.once("touchend",this._onUp))}setDraggable(t){this._draggable=!!t;const n=this._map;return n&&(t?(n.on("mousedown",this._addDragHandler),n.on("touchstart",this._addDragHandler)):(n.off("mousedown",this._addDragHandler),n.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(t){return this._rotation=t||xs.rotation,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(t){return this._rotationAlignment=t||xs.rotationAlignment,this._update(),this}getRotationAlignment(){return this._rotationAlignment==="auto"||this._rotationAlignment==="horizon"&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(t){return this._pitchAlignment=t||xs.pitchAlignment,this._update(),this}getPitchAlignment(){return this._pitchAlignment==="auto"?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(t){return this._occludedOpacity=t||xs.occludedOpacity,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}const Vh={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},Jl={maxWidth:100,unit:"metric"},ja={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"},Us={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px",altitude:0},cs=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function es(l=new o.P(0,0),t="bottom"){if(typeof l=="number"){const n=Math.round(Math.sqrt(.5*Math.pow(l,2)));switch(t){case"top":return new o.P(0,l);case"top-left":return new o.P(n,n);case"top-right":return new o.P(-n,n);case"bottom":return new o.P(0,-l);case"bottom-left":return new o.P(n,-n);case"bottom-right":return new o.P(-n,-n);case"left":return new o.P(l,0);case"right":return new o.P(-l,0)}return new o.P(0,0)}return l instanceof o.P||Array.isArray(l)?o.P.convert(l):o.P.convert(l[t]||[0,0])}return{version:Ae,supported:st.supported,setRTLTextPlugin:o.eQ,getRTLTextPluginStatus:o.eP,Map:class extends Wl{constructor(l){ot.mark(Ce.create);const t=l;if((l=o.h({},hu,l)).minZoom!=null&&l.maxZoom!=null&&l.minZoom>l.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(l.minPitch!=null&&l.maxPitch!=null&&l.minPitch>l.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(l.minPitch!=null&&l.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(l.maxPitch!=null&&l.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(l.antialias&&o.eI(window)&&(l.antialias=!1,o.w("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new Hu(l.minZoom,l.maxZoom,l.minPitch,l.maxPitch,l.renderWorldCopies,null,null),l),this._repaint=!!l.repaint,this._interactive=l.interactive,this._minTileCacheSize=l.minTileCacheSize,this._maxTileCacheSize=l.maxTileCacheSize,this._failIfMajorPerformanceCaveat=l.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=l.preserveDrawingBuffer,this._antialias=l.antialias,this._trackResize=l.trackResize,this._bearingSnap=l.bearingSnap,this._refreshExpiredTiles=l.refreshExpiredTiles,this._fadeDuration=l.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=l.crossSourceCollisions,this._collectResourceTiming=l.collectResourceTiming,this._language=this._parseLanguage(l.language),this._worldview=l.worldview,this._renderTaskQueue=new Xl,this._domRenderTaskQueue=new Xl,this._controls=[],this._markers=[],this._popups=[],this._mapId=o.a$(),this._locale=o.h({},uu,l.locale),this._clickTolerance=l.clickTolerance,this._cooperativeGestures=l.cooperativeGestures,this._performanceMetricsCollection=l.performanceMetricsCollection,this._tessellationStep=l.tessellationStep,this._containerWidth=0,this._containerHeight=0,this._showParseStatus=!0,this._precompilePrograms=l.precompilePrograms,this._scaleFactorChanged=!1,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new Vs(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._frameId=0,this._scaleFactor=l.scaleFactor,this._requestManager=new Ei(l.transformRequest,l.accessToken,l.testMode),this._silenceAuthErrors=!!l.testMode,this._contextCreateOptions=l.contextCreateOptions?Object.assign({},l.contextCreateOptions):{},typeof l.container=="string"){const n=document.getElementById(l.container);if(!n)throw new Error(`Container '${l.container.toString()}' not found.`);this._container=n}else{if(!(l.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=l.container}if(this._container.childNodes.length>0&&o.w("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),l.maxBounds&&this.setMaxBounds(l.maxBounds),this._spriteFormat=l.spriteFormat,o.aV(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._tp||(this._tp=new Th),this._tp.registerParameter(this,["Debug"],"showOverdrawInspector"),this._tp.registerParameter(this,["Debug"],"showTileBoundaries"),this._tp.registerParameter(this,["Debug"],"showParseStatus"),this._tp.registerParameter(this,["Debug"],"repaint"),this._tp.registerParameter(this,["Debug"],"showTileAABBs"),this._tp.registerParameter(this,["Debug"],"showPadding"),this._tp.registerParameter(this,["Debug"],"showCollisionBoxes",{noSave:!0}),this._tp.registerParameter(this.transform,["Debug"],"freezeTileCoverage",{noSave:!0},()=>{this._update()}),this._tp.registerParameter(this,["Debug","Wireframe"],"showTerrainWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers2DWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers3DWireframe"),this._tp.registerParameter(this,["Scaling"],"_scaleFactor",{min:.1,max:10,step:.1},()=>{this.setScaleFactor(this._scaleFactor)}),this._setupPainter(),this.painter===void 0)throw new Error("Failed to initialize WebGL.");if(this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),this._fullscreenchangeEvent="onfullscreenchange"in document?"fullscreenchange":"webkitfullscreenchange",window.addEventListener("online",this._onWindowOnline,!1),window.addEventListener("resize",this._onWindowResize,!1),window.addEventListener("orientationchange",this._onWindowResize,!1),window.addEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.addEventListener("visibilitychange",this._onVisibilityChange,!1),this.handlers=new Fh(this,l),this._localFontFamily=l.localFontFamily,this._localIdeographFontFamily=l.localIdeographFontFamily,(l.style||!l.testMode)&&this.setStyle(l.style||o.e.DEFAULT_STYLE,{config:l.config,localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),l.projection&&this.setProjection(l.projection),this.indoor=new Bp(this),l.hash&&(this._hash=new Ah(typeof l.hash=="string"&&l.hash||void 0).addTo(this)),!this._hash||!this._hash._onHashChange()){t.center==null&&t.zoom==null||(this.transform._unmodified=!1),this.jumpTo({center:l.center,zoom:l.zoom,bearing:l.bearing,pitch:l.pitch});const n=l.bounds;n&&(this.resize(),this.fitBounds(n,o.h({},l.fitBoundsOptions,{duration:0})))}this.resize(),l.attributionControl&&this.addControl(new Bh({customAttribution:l.customAttribution})),this._logoControl=new cu,this.addControl(this._logoControl,l.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet),this._postStyleLoadEvent()}),this.on("data",n=>{this._update(n.dataType==="style"),this.fire(new o.A(`${n.dataType}data`,n))}),this.on("dataloading",n=>{this.fire(new o.A(`${n.dataType}dataloading`,n))}),this._interactions=new vs(this)}_getMapId(){return this._mapId}addControl(l,t){if(t===void 0&&(t=l.getDefaultPosition?l.getDefaultPosition():"top-right"),!l||!l.onAdd)return this.fire(new o.z(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const n=l.onAdd(this);this._controls.push(l);const c=this._controlPositions[t];return t.indexOf("bottom")!==-1?c.insertBefore(n,c.firstChild):c.appendChild(n),this}removeControl(l){if(!l||!l.onRemove)return this.fire(new o.z(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const t=this._controls.indexOf(l);return t>-1&&this._controls.splice(t,1),l.onRemove(this),this}hasControl(l){return this._controls.indexOf(l)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(l){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));const t=!this._moving;return t&&this.fire(new o.A("movestart",l)).fire(new o.A("move",l)),this.fire(new o.A("resize",l)),t&&this.fire(new o.A("moveend",l)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(l){return this.transform.setMaxBounds(o.aG.convert(l)),this._update()}setMinZoom(l){if((l=l??-2)>=-2&&l<=this.transform.maxZoom)return this.transform.minZoom=l,this._update(),this.getZoom()<l?this.setZoom(l):this.fire(new o.A("zoomstart")).fire(new o.A("zoom")).fire(new o.A("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(l){if((l=l??22)>=this.transform.minZoom)return this.transform.maxZoom=l,this._update(),this.getZoom()>l?this.setZoom(l):this.fire(new o.A("zoomstart")).fire(new o.A("zoom")).fire(new o.A("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(l){if((l=l??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(l>=0&&l<=this.transform.maxPitch)return this.transform.minPitch=l,this._update(),this.getPitch()<l?this.setPitch(l):this.fire(new o.A("pitchstart")).fire(new o.A("pitch")).fire(new o.A("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(l){if((l=l??85)>85)throw new Error("maxPitch must be less than or equal to 85");if(l>=this.transform.minPitch)return this.transform.maxPitch=l,this._update(),this.getPitch()>l?this.setPitch(l):this.fire(new o.A("pitchstart")).fire(new o.A("pitch")).fire(new o.A("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getScaleFactor(){return this._scaleFactor}setScaleFactor(l){return this._scaleFactor=l,this.painter.scaleFactor=l,this._tp.refreshUI(),this._scaleFactorChanged=!0,this.style._updateFilteredLayers(t=>t.type==="symbol"),this._update(!0),this}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(l){return this.transform.renderWorldCopies=l,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(l){return l==="auto"?navigator.language:Array.isArray(l)?l.length===0?void 0:l.map(t=>t==="auto"?navigator.language:t):l}setLanguage(l){const t=this._parseLanguage(l);if(!this.style||t===this._language)return this;this._language=t,this.style.reloadSources();for(const n of this._controls)n._setLanguage&&n._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(l){return this.style&&l!==this._worldview?(this._worldview=l,this._styleDirty=!0,this.style.reloadSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return this.transform.projection.name==="globe"}setProjection(l){return this._lazyInitEmptyStyle(),l?typeof l=="string"&&(l={name:l}):l=null,this._useExplicitProjection=!!l,this._prioritizeAndUpdateProjection(l,this.style.projection)}_updateProjectionTransition(){if(this.getProjection().name!=="globe")return;const l=this.transform,t=l.projection.name;let n;t==="globe"&&l.zoom>=o.cx?(l.setMercatorFromTransition(),n=!0):t==="mercator"&&l.zoom<o.cx&&(l.setProjection({name:"globe"}),n=!0),n&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate(),this._update(!0))}_prioritizeAndUpdateProjection(l,t){return this._updateProjection(l||t||{name:"mercator"})}_updateProjection(l){let t;return t=l.name==="globe"&&this.transform.zoom>=o.cx?this.transform.setMercatorFromTransition():this.transform.setProjection(l),this.style.applyProjectionUpdate(),t&&(this.painter.clearBackgroundTiles(),this.style.clearSources(),this._update(!0),this._forceMarkerAndPopupUpdate(!0)),this}project(l,t){return this.transform.locationPoint3D(o.cd.convert(l),t)}unproject(l,t){return this.transform.pointLocation3D(o.P.convert(l),t)}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(l,t,n){const c=d=>{let f=[];if(Array.isArray(t)){const m=t.filter(y=>this.getLayer(y));f=m.length?this.queryRenderedFeatures(d,{layers:m}):[]}else f=this.queryRenderedFeatures(d,{target:t});return f};if(l==="mouseenter"||l==="mouseover"){let d=!1;return{listener:n,targets:t,delegates:{mousemove:m=>{const y=c(m.point);y.length?d||(d=!0,n.call(this,new Qr(l,this,m.originalEvent,{features:y}))):d=!1},mouseout:()=>{d=!1}}}}if(l==="mouseleave"||l==="mouseout"){let d=!1;return{listener:n,targets:t,delegates:{mousemove:y=>{c(y.point).length?d=!0:d&&(d=!1,n.call(this,new Qr(l,this,y.originalEvent)))},mouseout:y=>{d&&(d=!1,n.call(this,new Qr(l,this,y.originalEvent)))}}}}{const d=f=>{const m=c(f.point);m.length&&(f.features=m,n.call(this,f),delete f.features)};return{listener:n,targets:t,delegates:{[l]:d}}}}on(l,t,n){if(typeof t=="function"||n===void 0)return super.on(l,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;const c=this._createDelegatedListener(l,t,n);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[l]=this._delegatedListeners[l]||[],this._delegatedListeners[l].push(c);for(const d in c.delegates)this.on(d,c.delegates[d]);return this}once(l,t,n){if(typeof t=="function"||n===void 0)return super.once(l,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;const c=this._createDelegatedListener(l,t,n);for(const d in c.delegates)this.once(d,c.delegates[d]);return this}off(l,t,n){if(typeof t=="function"||n===void 0)return super.off(l,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;const c=this._delegatedListeners?this._delegatedListeners[l]:void 0;return c&&(d=>{for(let f=0;f<d.length;f++){const m=d[f];if(m.listener===n&&Yl(m.targets,t)){for(const y in m.delegates)this.off(y,m.delegates[y]);return d.splice(f,1),this}}})(c),this}queryRenderedFeatures(l,t){if(!this.style)return[];if(l===void 0||l instanceof o.P||Array.isArray(l)||t!==void 0||(t=l,l=void 0),l=l||[[0,0],[this.transform.width,this.transform.height]],!t){const f=this.style.queryRenderedFeatures(l,void 0,this.transform),m=this.style.queryRenderedFeatureset(l,void 0,this.transform);return f.concat(m)}let n=!0;if(t.target&&(n=this._isTargetValid(t.target),n&&!t.layers))return this.style.queryRenderedFeatureset(l,t,this.transform);let c=!0;if(t.layers&&Array.isArray(t.layers)){for(const f of t.layers)if(!this._isValidId(f)){c=!1;break}if(c&&!t.target)return this.style.queryRenderedFeatures(l,t,this.transform)}let d=[];return c&&(d=d.concat(this.style.queryRenderedFeatures(l,t,this.transform))),n&&(d=d.concat(this.style.queryRenderedFeatureset(l,t,this.transform))),d}querySourceFeatures(l,t){return!l||typeof l=="string"&&!this._isValidId(l)?[]:this.style.querySourceFeatures(l,t)}isPointOnSurface(l){const{name:t}=this.transform.projection;return t!=="globe"&&t!=="mercator"&&o.w(`${t} projection does not support isPointOnSurface, this API may behave unexpectedly.`),this.transform.isPointOnSurface(o.P.convert(l))}addInteraction(l,t){return this._interactions.add(l,t),this}removeInteraction(l){return this._interactions.remove(l),this}getCooperativeGestures(){return this._cooperativeGestures}setCooperativeGestures(l){return this._cooperativeGestures=l,this}setStyle(l,t){return t=o.h({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},t),this.style&&l&&t.diff!==!1&&t.localFontFamily===this._localFontFamily&&t.localIdeographFontFamily===this._localIdeographFontFamily&&!t.config?(this.style._diffStyle(l,(n,c)=>{if(n){const d=typeof n=="string"?n:n instanceof Error?n.message:n.error;o.w(`Unable to perform style diff: ${d}. Rebuilding the style from scratch.`),this._updateStyle(l,t)}else c&&this._update(!0)},()=>this._postStyleLoadEvent()),this):(this._localIdeographFontFamily=t.localIdeographFontFamily,this._localFontFamily=t.localFontFamily,this._updateStyle(l,t))}_getUIString(l){const t=this._locale[l];if(t==null)throw new Error(`Missing UI string '${l}'`);return t}_updateStyle(l,t){if(this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),l){const n=o.h({},t);t&&t.config&&(n.initialConfig=t.config,delete n.config),this.style=new un(this,n).load(l),this.style.setEventedParent(this,{style:this.style})}return this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new un(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(o.w("There is no style added to the map."),!1)}_isValidId(l){return l==null?(this.fire(new o.z(new Error("IDs can't be empty."))),!1):!o.d8(l)||(this.fire(new o.z(new Error(`IDs can't contain special symbols: "${l}".`))),!1)}_isTargetValid(l){return"featuresetId"in l?this._isValidId("importId"in l?l.importId:l.featuresetId):"layerId"in l&&this._isValidId(l.layerId)}_areTargetsValid(l){if(Array.isArray(l)){for(const t of l)if(!this._isValidId(t))return!1;return!0}return this._isTargetValid(l)}addSource(l,t){return this._isValidId(l)?(this._lazyInitEmptyStyle(),this.style.addSource(l,t),this._update(!0)):this}isSourceLoaded(l){return!!this._isValidId(l)&&!!this.style&&this.style._isSourceCacheLoaded(l)}areTilesLoaded(){return this.style.areTilesLoaded()}addSourceType(l,t,n){this._lazyInitEmptyStyle(),this.style.addSourceType(l,t,n)}removeSource(l){return this._isValidId(l)?(this.style.removeSource(l),this._updateTerrain(),this._update(!0)):this}getSource(l){return this._isValidId(l)?this.style.getOwnSource(l):null}addImage(l,t,{pixelRatio:n=1,sdf:c=!1,stretchX:d,stretchY:f,content:m}={}){this._lazyInitEmptyStyle();const y=o.I.from(l);if(t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap){const{width:v,height:T,data:S}=o.q.getImageData(t);this.style.addImage(y,{data:new o.r({width:v,height:T},S),pixelRatio:n,stretchX:d,stretchY:f,content:m,sdf:c,version:0,usvg:!1})}else if(t.width===void 0||t.height===void 0)this.fire(new o.z(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{const{width:v,height:T}=t,S=t;this.style.addImage(y,{data:new o.r({width:v,height:T},new Uint8Array(S.data)),pixelRatio:n,stretchX:d,stretchY:f,content:m,sdf:c,usvg:!1,version:0,userImage:S}),S.onAdd&&S.onAdd(this,l)}}updateImage(l,t){this._lazyInitEmptyStyle();const n=o.I.from(l),c=this.style.getImage(n);if(!c)return void this.fire(new o.z(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const d=t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap?o.q.getImageData(t):t,{width:f,height:m,data:y}=d;if(f===void 0||m===void 0)return void this.fire(new o.z(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(f!==(c.usvg?c.icon.usvg_tree.width:c.data.width)||m!==(c.usvg?c.icon.usvg_tree.height:c.data.height))return void this.fire(new o.z(new Error(`The width and height of the updated image (${f}, ${m})
                must be that same as the previous version of the image
                (${c.data.width}, ${c.data.height})`)));const v=!(t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap);let T=!1;c.usvg?(c.data=new o.r({width:f,height:m},new Uint8Array(y)),c.usvg=!1,c.icon=void 0,T=!0):c.data.replace(y,v),this.style.updateImage(n,c,T)}hasImage(l){return l?!!this.style&&!!this.style.getImage(o.I.from(l)):(this.fire(new o.z(new Error("Missing required image id"))),!1)}removeImage(l){this.style.removeImage(o.I.from(l))}loadImage(l,t){o.o(this._requestManager.transformRequest(l,o.R.Image),(n,c)=>{t(n,c instanceof HTMLImageElement?o.q.getImageData(c):c)})}listImages(){return this.style.listImages().map(l=>l.name)}addModel(l,t){this._lazyInitEmptyStyle(),this.style.addModel(l,t)}hasModel(l){return l?this.style.hasModel(l):(this.fire(new o.z(new Error("Missing required model id"))),!1)}removeModel(l){this.style.removeModel(l)}listModels(){return this.style.listModels()}addLayer(l,t){return this._isValidId(l.id)?(this._lazyInitEmptyStyle(),this.style.addLayer(l,t),this._update(!0)):this}getSlot(l){const t=this.getLayer(l);return t&&t.slot||null}setSlot(l,t){return this.style.setSlot(l,t),this.style.mergeLayers(),this._update(!0)}addImport(l,t){return this.style.addImport(l,t).catch(n=>this.fire(new o.z(new Error("Failed to add import",n)))),this}updateImport(l,t){return typeof t!="string"&&t.id!==l?(this.removeImport(l),this.addImport(t)):(this.style.updateImport(l,t),this._update(!0))}removeImport(l){return this.style.removeImport(l),this}moveImport(l,t){return this.style.moveImport(l,t),this._update(!0)}moveLayer(l,t){return this._isValidId(l)?(this.style.moveLayer(l,t),this._update(!0)):this}removeLayer(l){return this._isValidId(l)?(this.style.removeLayer(l),this._update(!0)):this}getLayer(l){if(!this._isValidId(l))return null;const t=this.style.getOwnLayer(l);return t?t.type==="custom"?t.implementation:t.serialize():void 0}getSlots(){return this.style.getSlots()}setLayerZoomRange(l,t,n){return this._isValidId(l)?(this.style.setLayerZoomRange(l,t,n),this._update(!0)):this}setFilter(l,t,n={}){return this._isValidId(l)?(this.style.setFilter(l,t,n),this._update(!0)):this}getFilter(l){return this._isValidId(l)?this.style.getFilter(l):null}setPaintProperty(l,t,n,c={}){return this._isValidId(l)?(this.style.setPaintProperty(l,t,n,c),this._update(!0)):this}getPaintProperty(l,t){return this._isValidId(l)?this.style.getPaintProperty(l,t):null}setLayoutProperty(l,t,n,c={}){return this._isValidId(l)?(this.style.setLayoutProperty(l,t,n,c),this._update(!0)):this}getLayoutProperty(l,t){return this._isValidId(l)?this.style.getLayoutProperty(l,t):null}getGlyphsUrl(){return this.style.getGlyphsUrl()}setGlyphsUrl(l){return this.style.setGlyphsUrl(l),this._update(!0)}getSchema(l){return this.style.getSchema(l)}setSchema(l,t){return this.style.setSchema(l,t),this._update(!0)}getConfig(l){return this.style.getConfig(l)}setConfig(l,t){return this.style.setConfig(l,t),this._update(!0)}getConfigProperty(l,t){return this.style.getConfigProperty(l,t)}setConfigProperty(l,t,n){return this.style.setConfigProperty(l,t,n),this._update(!0)}getFeaturesetDescriptors(l){return this.style.getFeaturesetDescriptors(l)}setLights(l){if(this._lazyInitEmptyStyle(),l&&l.length===1&&l[0].type==="flat"){const t=l[0];t.properties?this.style.setFlatLight(t.properties,t.id,{}):this.style.setFlatLight({},"flat")}else this.style.setLights(l),this.painter.terrain&&(this.painter.terrain.invalidateRenderCache=!0);return this._update(!0)}getLights(){const l=this.style.getLights()||[];return l.length===0&&l.push({id:this.style.light.id,type:"flat",properties:this.style.getFlatLight()}),l}setLight(l,t={}){return console.log("The `map.setLight` function is deprecated, prefer using `map.setLights` with `flat` light type instead."),this.setLights([{id:"flat",type:"flat",properties:l}])}getLight(){return console.log("The `map.getLight` function is deprecated, prefer using `map.getLights` instead."),this.style.getFlatLight()}setTerrain(l){return this._lazyInitEmptyStyle(),!l&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(l),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(l){return this._lazyInitEmptyStyle(),this.style.setFog(l),this._update(!0)}getFog(){return this.style?this.style.getFog():null}setSnow(l){return this._lazyInitEmptyStyle(),this.style.setSnow(l),this._update(!0)}getSnow(){return this.style?this.style.getSnow():null}setRain(l){return this._lazyInitEmptyStyle(),this.style.setRain(l),this._update(!0)}getRain(){return this.style?this.style.getRain():null}setColorTheme(l){return this._lazyInitEmptyStyle(),this.style.setColorTheme(l),this._update(!0)}setImportColorTheme(l,t){return this._lazyInitEmptyStyle(),this.style.setImportColorTheme(l,t),this._update(!0)}setCamera(l){return this.style.setCamera(l),this._triggerCameraUpdate(l)}_triggerCameraUpdate(l){return this._update(this.transform.setOrthographicProjectionAtLowPitch(l["camera-projection"]==="orthographic"))}getCamera(){return this.style.camera}_queryFogOpacity(l){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(o.cd.convert(l),this.transform):0}setFeatureState(l,t){return l.source&&!this._isValidId(l.source)?this:(this.style.setFeatureState(l,t),this._update())}removeFeatureState(l,t){return l.source&&!this._isValidId(l.source)?this:(this.style.removeFeatureState(l,t),this._update())}getFeatureState(l){return l.source&&!this._isValidId(l.source)?null:this.style.getFeatureState(l)}_updateContainerDimensions(){if(!this._container)return;const l=this._container.getBoundingClientRect().width||400,t=this._container.getBoundingClientRect().height||300;let n,c,d,f=this._container;for(;f&&(!c||!d);){const m=window.getComputedStyle(f).transform;m&&m!=="none"&&(n=m.match(/matrix.*\((.+)\)/)[1].split(", "),n[0]&&n[0]!=="0"&&n[0]!=="1"&&(c=n[0]),n[3]&&n[3]!=="0"&&n[3]!=="1"&&(d=n[3])),f=f.parentElement}this._containerWidth=c?Math.abs(l/c):l,this._containerHeight=d?Math.abs(t/d):t}_detectMissingCSS(){window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")!=="rgb(250, 128, 114)"&&o.w("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){const l=this._container;l.classList.add("mapboxgl-map"),(this._missingCSSCanary=re("div","mapboxgl-canary",l)).style.visibility="hidden",this._detectMissingCSS();const t=this._canvasContainer=re("div","mapboxgl-canvas-container",l);this._canvas=re("canvas","mapboxgl-canvas",t),this._interactive&&(t.classList.add("mapboxgl-interactive"),this._canvas.setAttribute("tabindex","0")),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);const n=this._controlContainer=re("div","mapboxgl-control-container",l),c=this._controlPositions={};["top-left","top","top-right","right","bottom-right","bottom","bottom-left","left"].forEach(d=>{c[d]=re("div",`mapboxgl-ctrl-${d}`,n)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(l,t){const n=o.q.devicePixelRatio||1;this._canvas.width=n*Math.ceil(l),this._canvas.height=n*Math.ceil(t),this._canvas.style.width=`${l}px`,this._canvas.style.height=`${t}px`}_addMarker(l){this._markers.push(l)}_removeMarker(l){const t=this._markers.indexOf(l);t!==-1&&this._markers.splice(t,1)}_addPopup(l){this._popups.push(l)}_removePopup(l){const t=this._popups.indexOf(l);t!==-1&&this._popups.splice(t,1)}_setupPainter(){const l=o.h({},st.supported.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),t=this._canvas.getContext("webgl2",l);t?(rs(t,!0),this.painter=new Oa(t,this._contextCreateOptions,this.transform,this._scaleFactor,this._tp,this._worldview),this.on("data",n=>{n.dataType==="source"&&this.painter.setTileLoadedFlag(!0)}),o.l.testSupport(t)):this.fire(new o.z(new Error("Failed to initialize WebGL")))}_contextLost(l){l.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new o.A("webglcontextlost",{originalEvent:l}))}_contextRestored(l){this._setupPainter(),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight)),this._updateTerrain(),this.style&&(this.style.reloadModels(),this.style.clearSources()),this._update(),this.fire(new o.A("webglcontextrestored",{originalEvent:l}))}_onMapScroll(l){if(l.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}idle(){return!this.isMoving()&&this.loaded()}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}frameReady(){return this.loaded()&&!this._placementDirty}_update(l){return this.style?(this._styleDirty=this._styleDirty||l,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(l){return this._update(),this._renderTaskQueue.add(l)}_cancelRenderFrame(l){this._renderTaskQueue.remove(l)}_requestDomTask(l){!this.loaded()||this.loaded()&&!this.isMoving()?l():this._domRenderTaskQueue.add(l)}_render(l){let t;this.fire(new o.A("renderstart")),++this._frameId;const n=this.painter.context.extTimerQuery,c=o.q.now(),d=this.painter.context.gl;if(this.listens("gpu-timing-frame")&&(t=d.createQuery(),d.beginQuery(n.TIME_ELAPSED_EXT,t)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],performance.now())),this._renderTaskQueue.run(l),this._domRenderTaskQueue.run(l),this._removed)return;this._updateProjectionTransition();const f=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;const T=this.transform.zoom,S=this.transform.pitch,C=o.q.now(),I=new o.aa(T,{now:C,fadeDuration:f,pitch:S,transition:this.style.transition,worldview:this._worldview});this.style.update(I)}this.style&&this.style.hasFogTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let m=!1;this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),m=this._updateAverageElevation(c),this.style.updateSources(this.transform),this.style.updateImageProviders(),this.isMoving()||this._forceMarkerAndPopupUpdate()):m=this._updateAverageElevation(c);const y=this.style&&this.style._updatePlacement(this.painter,this.painter.transform,this.showCollisionBoxes,f,this._crossSourceCollisions,this.painter.replacementSource,this._scaleFactorChanged);if(this._scaleFactorChanged&&(this._scaleFactorChanged=!1),y&&(this._placementDirty=y.needsRerender),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showParseStatus:this.showParseStatus,wireframe:{terrain:this.showTerrainWireframe,layers2D:this.showLayers2DWireframe,layers3D:this.showLayers3DWireframe},showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:f,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new o.A("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,ot.mark(Ce.load),this.fire(new o.A("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&(this.style.snow||this.style.rain)&&(this._styleDirty=!0),this.style&&this.style.imageManager.hasPatternsInFlight()&&(this._styleDirty=!0),this.style&&!this.style.modelManager.isLoaded()&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),t){const T=o.q.now()-c;d.endQuery(n.TIME_ELAPSED_EXT),setTimeout(()=>{const S=d.getQueryParameter(t,d.QUERY_RESULT)/1e6;d.deleteQuery(t),this.fire(new o.A("gpu-timing-frame",{cpuTime:T,gpuTime:S}))},50)}if(this.listens("gpu-timing-layer")){const T=this.painter.collectGpuTimers();setTimeout(()=>{const S=this.painter.queryGpuTimers(T);this.fire(new o.A("gpu-timing-layer",{layerTimes:S}))},50)}if(this.listens("gpu-timing-deferred-render")){const T=this.painter.collectDeferredRenderGpuQueries();setTimeout(()=>{const S=this.painter.queryGpuTimeDeferredRender(T);this.fire(new o.A("gpu-timing-deferred-render",{gpuTime:S}))},50)}const v=this._sourcesDirty||this._styleDirty||this._placementDirty||m;if(v||this._repaint)this.triggerRepaint();else{const T=this.idle();if(T&&(m=this._updateAverageElevation(c,!0)),m)this.triggerRepaint();else if(this._triggerFrame(!1),T&&(this.fire(new o.A("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){const S=this._calculateSpeedIndex();this.fire(new o.A("speedindexcompleted",{speedIndex:S})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||v||(this._fullyLoaded=!0,ot.mark(Ce.fullLoad),this._performanceMetricsCollection&&Zr(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(l){for(const t of this._markers)l&&!this.getRenderWorldCopies()&&(t._lngLat=t._lngLat.wrap()),t._update();for(const t of this._popups)!l||this.getRenderWorldCopies()||t._trackPointer||(t._lngLat=t._lngLat.wrap()),t._update()}_updateAverageElevation(l,t=!1){const n=d=>(this.transform.averageElevation=d,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return this.transform.averageElevation!==0&&n(0);const c=this.transform.elevation&&this.transform.elevation.exaggeration()!==this._averageElevationExaggeration;if(c||(t||l-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(l)){const d=this.transform.averageElevation;let f=this.transform.sampleAverageElevation();this.transform.elevation!=null&&(this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(f)?f=0:this._averageElevationLastSampledAt=l;const m=Math.abs(d-f);if(m>1){if(this._isInitialLoad||c)return this._averageElevation.jumpTo(f),n(f);this._averageElevation.easeTo(f,l,300)}else if(m>1e-4)return this._averageElevation.jumpTo(f),n(f)}return!!this._averageElevation.isEasing(l)&&n(this._averageElevation.getValue(l))}_authenticate(){Ss(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,l=>{if(l&&(l.message===Rr||l.status===401)){const t=this.painter.context.gl;rs(t,!1),this._logoControl instanceof cu&&this._logoControl._updateLogo(),t&&t.clear(t.DEPTH_BUFFER_BIT|t.COLOR_BUFFER_BIT|t.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new o.z(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}}),Zs(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,()=>{})}_postStyleLoadEvent(){this.style.globalId&&Ar(this._requestManager._customAccessToken,{map:this,style:this.style.globalId,importedStyles:this.style.getImportGlobalIds()})}_updateTerrain(){const l=this._isDragging();this.painter.updateTerrain(this.style,l)}_calculateSpeedIndex(){const l=this.painter.canvasCopy(),t=this.painter.getCanvasCopiesAndTimestamps();t.timeStamps.push(performance.now());const n=this.painter.context.gl,c=n.createFramebuffer();function d(f){n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,f,0);const m=new Uint8Array(n.drawingBufferWidth*n.drawingBufferHeight*4);return n.readPixels(0,0,n.drawingBufferWidth,n.drawingBufferHeight,n.RGBA,n.UNSIGNED_BYTE,m),m}return n.bindFramebuffer(n.FRAMEBUFFER,c),this._canvasPixelComparison(d(l),t.canvasCopies.map(d),t.timeStamps)}_canvasPixelComparison(l,t,n){let c=n[1]-n[0];const d=l.length/4;for(let f=0;f<t.length;f++){const m=t[f];let y=0;for(let v=0;v<m.length;v+=4)m[v]===l[v]&&m[v+1]===l[v+1]&&m[v+2]===l[v+2]&&m[v+3]===l[v+3]&&(y+=1);c+=(n[f+2]-n[f+1])*(1-y/d)}return c}remove(){this._hash&&this._hash.remove();for(const t of this._controls)t.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.indoor.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),window.removeEventListener("resize",this._onWindowResize,!1),window.removeEventListener("orientationchange",this._onWindowResize,!1),window.removeEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.removeEventListener("online",this._onWindowOnline,!1),window.removeEventListener("visibilitychange",this._onVisibilityChange,!1);const l=this.painter.context.gl.getExtension("WEBGL_lose_context");l&&l.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),Es.delete(this.painter.context.gl),ji.remove(),Ts.remove(),this._removed=!0,this.fire(new o.A("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(l){this._renderNextFrame=this._renderNextFrame||l,this.style&&!this._frame&&(this._frame=o.q.frame(t=>{const n=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,n&&this._render(t)}))}_preloadTiles(l){const t=this.style?this.style.getSourceCaches():[];return o.bt(t,(n,c)=>n._preloadTiles(l,c),()=>{this.triggerRepaint()}),this}_onWindowOnline(){this._update()}_onWindowResize(l){this._trackResize&&this.resize({originalEvent:l})._update()}_onVisibilityChange(){document.visibilityState==="hidden"&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(l){this._showTileBoundaries!==l&&(this._showTileBoundaries=l,this._tp.refreshUI(),this._update())}get showParseStatus(){return!!this._showParseStatus}set showParseStatus(l){this._showParseStatus!==l&&(this._showParseStatus=l,this._tp.refreshUI(),this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(l){this._showTerrainWireframe!==l&&(this._showTerrainWireframe=l,this._tp.refreshUI(),this._update())}get showLayers2DWireframe(){return!!this._showLayers2DWireframe}set showLayers2DWireframe(l){this._showLayers2DWireframe!==l&&(this._showLayers2DWireframe=l,this._tp.refreshUI(),this._update())}get showLayers3DWireframe(){return!!this._showLayers3DWireframe}set showLayers3DWireframe(l){this._showLayers3DWireframe!==l&&(this._showLayers3DWireframe=l,this._tp.refreshUI(),this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(l){this._speedIndexTiming!==l&&(this._speedIndexTiming=l,this._update())}get showPadding(){return!!this._showPadding}set showPadding(l){this._showPadding!==l&&(this._showPadding=l,this._tp.refreshUI(),this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(l){this._showCollisionBoxes!==l&&(this._showCollisionBoxes=l,this._tp.refreshUI(),l?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(l){this._showOverdrawInspector!==l&&(this._showOverdrawInspector=l,this._tp.refreshUI(),this._update())}get repaint(){return!!this._repaint}set repaint(l){this._repaint!==l&&(this._repaint=l,this._tp.refreshUI(),this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(l){this._vertices=l,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(l){this._showTileAABBs!==l&&(this._showTileAABBs=l,this._tp.refreshUI(),l&&this._update())}_setCacheLimits(l,t){o.eJ(l,t)}get version(){return Ae}},NavigationControl:class{constructor(l={}){this.options=o.h({},Cf,l),this._container=re("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",t=>t.preventDefault()),this.options.showZoom&&(o.aV(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",t=>{this._map&&this._map.zoomIn({},{originalEvent:t})}),re("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",t=>{this._map&&this._map.zoomOut({},{originalEvent:t})}),re("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(o.aV(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",t=>{const n=this._map;n&&(this.options.visualizePitch?n.resetNorthPitch({},{originalEvent:t}):n.resetNorth({},{originalEvent:t}))}),this._compassIcon=re("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){const l=this._map;if(!l)return;const t=l.getZoom(),n=t===l.getMaxZoom(),c=t===l.getMinZoom();this._zoomInButton.disabled=n,this._zoomOutButton.disabled=c,this._zoomInButton.setAttribute("aria-disabled",n.toString()),this._zoomOutButton.setAttribute("aria-disabled",c.toString())}_rotateCompassArrow(){const l=this._map;if(!l)return;const t=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(l.transform.pitch*(Math.PI/180)),.5)}) rotateX(${l.transform.pitch}deg) rotateZ(${l.transform.angle*(180/Math.PI)}deg)`:`rotate(${l.transform.angle*(180/Math.PI)}deg)`;l._requestDomTask(()=>{this._compassIcon&&(this._compassIcon.style.transform=t)})}onAdd(l){return this._map=l,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),l.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&l.on("pitch",this._rotateCompassArrow),l.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new _m(l,this._compass,this.options.visualizePitch)),this._container}onRemove(){const l=this._map;l&&(this._container.remove(),this.options.showZoom&&l.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&l.off("pitch",this._rotateCompassArrow),l.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(l,t){const n=re("button",l,this._container);return n.type="button",n.addEventListener("click",t),n}_setButtonTitle(l,t){if(!this._map)return;const n=this._map._getUIString(`NavigationControl.${t}`);l.setAttribute("aria-label",n),l.firstElementChild&&l.firstElementChild.setAttribute("title",n)}},GeolocateControl:class extends o.E{constructor(l={}){super();const t=navigator.geolocation;this.options=o.h({geolocation:t},Vh,l),o.aV(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=mo(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(l){return this._map=l,this._container=re("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){this._geolocationWatchID!==void 0&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(l){const t=(n=!!this.options.geolocation)=>{this._supportsGeolocation=n,l(n)};this._supportsGeolocation!==void 0?l(this._supportsGeolocation):navigator.permissions!==void 0?navigator.permissions.query({name:"geolocation"}).then(n=>t(n.state!=="denied")).catch(()=>t()):t()}_isOutOfMapMaxBounds(l){const t=this._map.getMaxBounds(),n=l.coords;return!!t&&(n.longitude<t.getWest()||n.longitude>t.getEast()||n.latitude<t.getSouth()||n.latitude>t.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(l){if(this._map){if(this._isOutOfMapMaxBounds(l))return this._setErrorState(),this.fire(new o.A("outofmaxbounds",l)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=l,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(l),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(l),this.options.showUserLocation&&this._userLocationDotMarker.removeClassName("mapboxgl-user-location-dot-stale"),this.fire(new o.A("geolocate",l)),this._finish()}}_updateCamera(l){const t=new o.cd(l.coords.longitude,l.coords.latitude),n=l.coords.accuracy,c=this._map.getBearing(),d=o.h({bearing:c},this.options.fitBoundsOptions);this._map.fitBounds(t.toBounds(n),d,{geolocateSource:!0})}_updateMarker(l){if(l){const t=new o.cd(l.coords.longitude,l.coords.latitude);this._accuracyCircleMarker.setLngLat(t).addTo(this._map),this._userLocationDotMarker.setLngLat(t).addTo(this._map),this._accuracy=l.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const l=this._map.transform,t=o.c6(1,l._center.lat)*l.worldSize,n=Math.ceil(2*this._accuracy*t);this._circleElement.style.width=`${n}px`,this._circleElement.style.height=`${n}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&typeof this._heading=="number"?(this._userLocationDotMarker.setRotation(this._heading),this._userLocationDotMarker.addClassName("mapboxgl-user-location-show-heading")):(this._userLocationDotMarker.removeClassName("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(l){if(this._map){if(this.options.trackUserLocation)if(l.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(l.code===3&&this._noTimeout)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._userLocationDotMarker.addClassName("mapboxgl-user-location-dot-stale"),this.fire(new o.A("error",l)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(l){if(this._map!==void 0){if(this._container.addEventListener("contextmenu",t=>t.preventDefault()),this._geolocateButton=re("button","mapboxgl-ctrl-geolocate",this._container),re("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",l===!1){o.w("Geolocation support is not available so the GeolocateControl will be disabled.");const t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t)}else{const t=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=re("div","mapboxgl-user-location"),this._dotElement.appendChild(re("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(re("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new Kl({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=re("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new Kl({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",t=>{t.geolocateSource||this._watchState!=="ACTIVE_LOCK"||t.originalEvent&&t.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new o.A("trackuserlocationend")))})}}_onDeviceOrientation(l){this._userLocationDotMarker&&(l.webkitCompassHeading?this._heading=l.webkitCompassHeading:l.absolute===!0&&(this._heading=-1*l.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return o.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new o.A("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new o.A("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new o.A("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let l;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(l={maximumAge:6e5,timeout:0},this._noTimeout=!0):(l=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,l),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=window.setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){const l=()=>{"ondeviceorientationabsolute"in window?window.addEventListener("deviceorientationabsolute",this._onDeviceOrientation):window.addEventListener("deviceorientation",this._onDeviceOrientation)};typeof DeviceMotionEvent<"u"&&typeof DeviceMotionEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(t=>{t==="granted"&&l()}).catch(console.error):l()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),window.removeEventListener("deviceorientation",this._onDeviceOrientation),window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:Bh,ScaleControl:class{constructor(l={}){this.options=o.h({},Jl,l),this._isNumberFormatSupported=function(){try{return new Intl.NumberFormat("en",{style:"unit",unitDisplay:"short",unit:"meter"}),!0}catch{return!1}}(),o.aV(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){const l=this.options.maxWidth||100,t=this._map,n=t._containerHeight/2,c=t._containerWidth/2-l/2,d=t.unproject([c,n]),f=t.unproject([c+l,n]),m=d.distanceTo(f);if(this.options.unit==="imperial"){const y=3.2808*m;y>5280?this._setScale(l,y/5280,"mile"):this._setScale(l,y,"foot")}else this.options.unit==="nautical"?this._setScale(l,m/1852,"nautical-mile"):m>=1e3?this._setScale(l,m/1e3,"kilometer"):this._setScale(l,m,"meter")}_setScale(l,t,n){this._map._requestDomTask(()=>{const c=function(f){const m=Math.pow(10,`${Math.floor(f)}`.length-1);let y=f/m;return y=y>=10?10:y>=5?5:y>=3?3:y>=2?2:y>=1?1:function(v){const T=Math.pow(10,Math.ceil(-Math.log(v)/Math.LN10));return Math.round(v*T)/T}(y),m*y}(t),d=c/t;this._container.innerHTML=this._isNumberFormatSupported&&n!=="nautical-mile"?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"short",unit:n}).format(c):`${c}&nbsp;${ja[n]}`,this._container.style.width=l*d+"px"})}onAdd(l){return this._map=l,this._language=l.getLanguage(),this._container=re("div","mapboxgl-ctrl mapboxgl-ctrl-scale",l.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(l){this._language=l,this._update()}setUnit(l){this.options.unit=l,this._update()}},FullscreenControl:class{constructor(l={}){this._fullscreen=!1,l&&l.container&&(l.container instanceof HTMLElement?this._container=l.container:o.w("Full screen control 'container' must be a DOM element.")),o.aV(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(l){return this._map=l,this._container||(this._container=this._map.getContainer()),this._controlContainer=re("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",o.w("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!document.fullscreenEnabled&&!document.webkitFullscreenEnabled)}_setupUI(){const l=this._fullscreenButton=re("button","mapboxgl-ctrl-fullscreen",this._controlContainer);re("span","mapboxgl-ctrl-icon",l).setAttribute("aria-hidden","true"),l.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const l=this._getTitle();this._fullscreenButton.setAttribute("aria-label",l),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",l)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(document.fullscreenElement||document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?document.exitFullscreen?document.exitFullscreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},Popup:class extends o.E{constructor(l){super(),this.options=o.h(Object.create(Us),l),this._altitude=this.options.altitude,o.aV(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(l&&l.className?l.className.trim().split(/\s+/):[])}addTo(l){return this._map&&this.remove(),this._map=l,this.options.closeOnClick&&l.on("preclick",this._onClose),this.options.closeOnMove&&l.on("move",this._onClose),l.on("remove",this.remove),this._update(),l._addPopup(this),this._focusFirstElement(),this._trackPointer?(l.on("mousemove",this._onMouseEvent),l.on("mouseup",this._onMouseEvent),l._canvasContainer.classList.add("mapboxgl-track-pointer")):l.on("move",this._update),this.fire(new o.A("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);const l=this._map;return l&&(l.off("move",this._update),l.off("move",this._onClose),l.off("preclick",this._onClose),l.off("click",this._onClose),l.off("remove",this.remove),l.off("mousemove",this._onMouseEvent),l.off("mouseup",this._onMouseEvent),l.off("drag",this._onMouseEvent),l._canvasContainer&&l._canvasContainer.classList.remove("mapboxgl-track-pointer"),l._removePopup(this),this._map=void 0),this.fire(new o.A("close")),this}getLngLat(){return this._lngLat}setLngLat(l){this._lngLat=o.cd.convert(l),this._pos=null,this._trackPointer=!1,this._update();const t=this._map;return t&&(t.on("move",this._update),t.off("mousemove",this._onMouseEvent),t._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}getAltitude(){return this._altitude}setAltitude(l){return this._altitude=l,this._update(),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();const l=this._map;return l&&(l.off("move",this._update),l.on("mousemove",this._onMouseEvent),l.on("drag",this._onMouseEvent),l._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(l){return this.setDOMContent(document.createTextNode(l))}setHTML(l){const t=document.createDocumentFragment(),n=document.createElement("body");let c;for(n.innerHTML=l;c=n.firstChild,c;)t.appendChild(c);return this.setDOMContent(t)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(l){return this.options.maxWidth=l,this._update(),this}setDOMContent(l){let t=this._content;if(t)for(;t.hasChildNodes();)t.firstChild&&t.removeChild(t.firstChild);else t=this._content=re("div","mapboxgl-popup-content",this._container||void 0);if(t.appendChild(l),this.options.closeButton){const n=this._closeButton=re("button","mapboxgl-popup-close-button",t);n.type="button",n.setAttribute("aria-label","Close popup"),n.innerHTML='<span aria-hidden="true">&#215;</span>',n.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(l){return this._classList.add(l),this._updateClassList(),this}removeClassName(l){return this._classList.delete(l),this._updateClassList(),this}setOffset(l){return this.options.offset=l,this._update(),this}toggleClassName(l){let t;return this._classList.delete(l)?t=!1:(this._classList.add(l),t=!0),this._updateClassList(),t}_onMouseEvent(l){this._update(l.point)}_getAnchor(l){if(this.options.anchor)return this.options.anchor;const t=this._map,n=this._container,c=this._pos;if(!t||!n||!c)return"bottom";const d=n.offsetWidth,f=n.offsetHeight,m=c.x<d/2,y=c.x>t.transform.width-d/2;if(c.y+l<f)return m?"top-left":y?"top-right":"top";if(c.y>t.transform.height-f){if(m)return"bottom-left";if(y)return"bottom-right"}return m?"left":y?"right":"bottom"}_updateClassList(){const l=this._container;if(!l)return;const t=[...this._classList];t.push("mapboxgl-popup"),this._anchor&&t.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&t.push("mapboxgl-popup-track-pointer"),l.className=t.join(" ")}_update(l){const t=this._map,n=this._content;if(!t||!this._lngLat&&!this._trackPointer||!n)return;let c=this._container;if(c||(c=this._container=re("div","mapboxgl-popup",t.getContainer()),this._tip=re("div","mapboxgl-popup-tip",c),c.appendChild(n)),this.options.maxWidth&&c.style.maxWidth!==this.options.maxWidth&&(c.style.maxWidth=this.options.maxWidth),t.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=Ua(this._lngLat,this._pos,t.transform)),!this._trackPointer||l){const d=this._pos=this._trackPointer&&l instanceof o.P?l:t.project(this._lngLat,this._altitude),f=es(this.options.offset),m=this._anchor=this._getAnchor(f.y),y=es(this.options.offset,m),v=d.add(y).round();t._requestDomTask(()=>{this._container&&m&&(this._container.style.transform=`${Nh[m]} translate(${v.x}px,${v.y}px)`)})}if(!this._marker&&t._showingGlobe()){const d=o.eK(t.transform,this._lngLat)?0:1;this._setOpacity(d)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const l=this._container.querySelector(cs);l&&l.focus()}_onClose(){this.remove()}_setOpacity(l){this._container&&(this._container.style.opacity=`${l}`),this._content&&(this._content.style.pointerEvents=l?"auto":"none")}},Marker:Kl,Style:un,LngLat:o.cd,LngLatBounds:o.aG,Point:o.P,MercatorCoordinate:o.ac,FreeCameraOptions:Rd,Evented:o.E,config:o.e,prewarm:o.eO,clearPrewarmedResources:o.eN,get accessToken(){return o.e.ACCESS_TOKEN},set accessToken(l){o.e.ACCESS_TOKEN=l},get baseApiUrl(){return o.e.API_URL},set baseApiUrl(l){o.e.API_URL=l},get workerCount(){return o.eX.workerCount},set workerCount(l){o.eX.workerCount=l},get maxParallelImageRequests(){return o.e.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(l){o.e.MAX_PARALLEL_IMAGE_REQUESTS=l},clearStorage(l){o.eW(l)},get workerUrl(){return o.eV.workerUrl},set workerUrl(l){o.eV.workerUrl=l},get workerClass(){return o.eV.workerClass},set workerClass(l){o.eV.workerClass=l},get workerParams(){return o.eV.workerParams},set workerParams(l){o.eV.workerParams=l},get dracoUrl(){return o.eU()},set dracoUrl(l){o.eT(l)},get meshoptUrl(){return o.eS()},set meshoptUrl(l){o.eR(l)},setNow:o.q.setNow,restoreNow:o.q.restoreNow}});var Be=le;return Be})}(Ip)),Ip.exports}var G2=j2();const Ao=s1(G2);var L_,f0;function Ou(){if(f0)return L_;f0=1,L_=Te;var je=Object.prototype.hasOwnProperty;function Te(){for(var he={},pe=0;pe<arguments.length;pe++){var le=arguments[pe];for(var be in le)je.call(le,be)&&(he[be]=le[be])}return he}return L_}var D_={exports:{}},p0;function q2(){return p0||(p0=1,function(je,Te){(function(){var he={};je.exports=he,he.simpleFilter=function(pe,le){return le.filter(function(be){return he.test(pe,be)})},he.test=function(pe,le){return he.match(pe,le)!==null},he.match=function(pe,le,be){be=be||{};var Be=0,o=[],Ae=le.length,Ce=0,ot=0,ht=be.pre||"",zt=be.post||"",qt=be.caseSensitive&&le||le.toLowerCase(),st;pe=be.caseSensitive&&pe||pe.toLowerCase();for(var re=0;re<Ae;re++)st=le[re],qt[re]===pe[Be]?(st=ht+st+zt,Be+=1,ot+=1+ot):ot=0,Ce+=ot,o[o.length]=st;return Be===pe.length?(Ce=qt===pe?1/0:Ce,{rendered:o.join(""),score:Ce}):null},he.filter=function(pe,le,be){return!le||le.length===0?[]:typeof pe!="string"?le:(be=be||{},le.reduce(function(Be,o,Ae,Ce){var ot=o;be.extract&&(ot=be.extract(o));var ht=he.match(pe,ot,be);return ht!=null&&(Be[Be.length]={string:ht.rendered,score:ht.score,index:Ae,original:o}),Be},[]).sort(function(Be,o){var Ae=o.score-Be.score;return Ae||Be.index-o.index}))}})()}(D_)),D_.exports}var O_,m0;function $2(){if(m0)return O_;m0=1;var je=function(Te){return this.component=Te,this.items=[],this.active=0,this.wrapper=document.createElement("div"),this.wrapper.className="suggestions-wrapper",this.element=document.createElement("ul"),this.element.className="suggestions",this.wrapper.appendChild(this.element),this.selectingListItem=!1,Te.el.parentNode.insertBefore(this.wrapper,Te.el.nextSibling),this};return je.prototype.show=function(){this.element.style.display="block"},je.prototype.hide=function(){this.element.style.display="none"},je.prototype.add=function(Te){this.items.push(Te)},je.prototype.clear=function(){this.items=[],this.active=0},je.prototype.isEmpty=function(){return!this.items.length},je.prototype.isVisible=function(){return this.element.style.display==="block"},je.prototype.draw=function(){if(this.element.innerHTML="",this.items.length===0){this.hide();return}for(var Te=0;Te<this.items.length;Te++)this.drawItem(this.items[Te],this.active===Te);this.show()},je.prototype.drawItem=function(Te,he){var pe=document.createElement("li"),le=document.createElement("a");he&&(pe.className+=" active"),le.innerHTML=Te.string,pe.appendChild(le),this.element.appendChild(pe),pe.addEventListener("mousedown",(function(){this.selectingListItem=!0}).bind(this)),pe.addEventListener("mouseup",(function(){this.handleMouseUp.call(this,Te)}).bind(this))},je.prototype.handleMouseUp=function(Te){this.selectingListItem=!1,this.component.value(Te.original),this.clear(),this.draw()},je.prototype.move=function(Te){this.active=Te,this.draw()},je.prototype.previous=function(){this.move(this.active===0?this.items.length-1:this.active-1)},je.prototype.next=function(){this.move(this.active===this.items.length-1?0:this.active+1)},je.prototype.drawError=function(Te){var he=document.createElement("li");he.innerHTML=Te,this.element.appendChild(he),this.show()},O_=je,O_}var k_,_0;function H2(){if(_0)return k_;_0=1;var je=Ou(),Te=q2(),he=$2(),pe=function(le,be,Be){return Be=Be||{},this.options=je({minLength:2,limit:5,filter:!0,hideOnBlur:!0},Be),this.el=le,this.data=be||[],this.list=new he(this),this.query="",this.selected=null,this.list.draw(),this.el.addEventListener("keyup",(function(o){this.handleKeyUp(o.keyCode)}).bind(this),!1),this.el.addEventListener("keydown",(function(o){this.handleKeyDown(o)}).bind(this)),this.el.addEventListener("focus",(function(){this.handleFocus()}).bind(this)),this.el.addEventListener("blur",(function(){this.handleBlur()}).bind(this)),this.el.addEventListener("paste",(function(o){this.handlePaste(o)}).bind(this)),this.render=this.options.render?this.options.render.bind(this):this.render.bind(this),this.getItemValue=this.options.getItemValue?this.options.getItemValue.bind(this):this.getItemValue.bind(this),this};return pe.prototype.handleKeyUp=function(le){le===40||le===38||le===27||le===13||le===9||this.handleInputChange(this.el.value)},pe.prototype.handleKeyDown=function(le){switch(le.keyCode){case 13:case 9:this.list.isEmpty()||(this.list.isVisible()&&le.preventDefault(),this.value(this.list.items[this.list.active].original),this.list.hide());break;case 27:this.list.isEmpty()||this.list.hide();break;case 38:this.list.previous();break;case 40:this.list.next();break}},pe.prototype.handleBlur=function(){!this.list.selectingListItem&&this.options.hideOnBlur&&this.list.hide()},pe.prototype.handlePaste=function(le){if(le.clipboardData)this.handleInputChange(le.clipboardData.getData("Text"));else{var be=this;setTimeout(function(){be.handleInputChange(le.target.value)},100)}},pe.prototype.handleInputChange=function(le){if(this.query=this.normalize(le),this.list.clear(),this.query.length<this.options.minLength){this.list.draw();return}this.getCandidates((function(be){for(var Be=0;Be<be.length&&(this.list.add(be[Be]),Be!==this.options.limit-1);Be++);this.list.draw()}).bind(this))},pe.prototype.handleFocus=function(){this.list.isEmpty()||this.list.show(),this.list.selectingListItem=!1},pe.prototype.update=function(le){this.data=le,this.handleKeyUp()},pe.prototype.clear=function(){this.data=[],this.list.clear()},pe.prototype.normalize=function(le){return le=le.toLowerCase(),le},pe.prototype.match=function(le,be){return le.indexOf(be)>-1},pe.prototype.value=function(le){if(this.selected=le,this.el.value=this.getItemValue(le),document.createEvent){var be=document.createEvent("HTMLEvents");be.initEvent("change",!0,!1),this.el.dispatchEvent(be)}else this.el.fireEvent("onchange")},pe.prototype.getCandidates=function(le){var be={pre:"<strong>",post:"</strong>",extract:(function(o){return this.getItemValue(o)}).bind(this)},Be;this.options.filter?(Be=Te.filter(this.query,this.data,be),Be=Be.map((function(o){return{original:o.original,string:this.render(o.original,o.string)}}).bind(this))):Be=this.data.map((function(o){var Ae=this.render(o);return{original:o,string:Ae}}).bind(this)),le(Be)},pe.prototype.getItemValue=function(le){return le},pe.prototype.render=function(le,be){if(be)return be;for(var Be=le.original?this.getItemValue(le.original):this.getItemValue(le),o=this.normalize(Be),Ae=o.lastIndexOf(this.query);Ae>-1;){var Ce=Ae+this.query.length;Be=Be.slice(0,Ae)+"<strong>"+Be.slice(Ae,Ce)+"</strong>"+Be.slice(Ce),Ae=o.slice(0,Ae).lastIndexOf(this.query)}return Be},pe.prototype.renderError=function(le){this.list.drawError(le)},k_=pe,k_}var F_,g0;function Z2(){if(g0)return F_;g0=1;var je=H2();return F_=je,typeof window<"u"&&(window.Suggestions=je),F_}var B_,y0;function W2(){if(y0)return B_;y0=1;var je="Expected a function",Te=NaN,he="[object Symbol]",pe=/^\s+|\s+$/g,le=/^[-+]0x[0-9a-f]+$/i,be=/^0b[01]+$/i,Be=/^0o[0-7]+$/i,o=parseInt,Ae=typeof el=="object"&&el&&el.Object===Object&&el,Ce=typeof self=="object"&&self&&self.Object===Object&&self,ot=Ae||Ce||Function("return this")(),ht=Object.prototype,zt=ht.toString,qt=Math.max,st=Math.min,re=function(){return ot.Date.now()};function Ge($e,Ye,yt){var Gt,gi,xi,Si,Dr,Rr,Ei=0,zr=!1,Or=!1,Nn=!0;if(typeof $e!="function")throw new TypeError(je);Ye=nt(Ye)||0,at(yt)&&(zr=!!yt.leading,Or="maxWait"in yt,xi=Or?qt(nt(yt.maxWait)||0,Ye):xi,Nn="trailing"in yt?!!yt.trailing:Nn);function Vn($i){var Zr=Gt,ji=gi;return Gt=gi=void 0,Ei=$i,Si=$e.apply(ji,Zr),Si}function Un($i){return Ei=$i,Dr=setTimeout(pn,Ye),zr?Vn($i):Si}function rr($i){var Zr=$i-Rr,ji=$i-Ei,Ss=Ye-Zr;return Or?st(Ss,xi-ji):Ss}function fn($i){var Zr=$i-Rr,ji=$i-Ei;return Rr===void 0||Zr>=Ye||Zr<0||Or&&ji>=xi}function pn(){var $i=re();if(fn($i))return Ts($i);Dr=setTimeout(pn,rr($i))}function Ts($i){return Dr=void 0,Nn&&Gt?Vn($i):(Gt=gi=void 0,Si)}function Zs(){Dr!==void 0&&clearTimeout(Dr),Ei=0,Gt=Rr=gi=Dr=void 0}function mr(){return Dr===void 0?Si:Ts(re())}function Ar(){var $i=re(),Zr=fn($i);if(Gt=arguments,gi=this,Rr=$i,Zr){if(Dr===void 0)return Un(Rr);if(Or)return Dr=setTimeout(pn,Ye),Vn(Rr)}return Dr===void 0&&(Dr=setTimeout(pn,Ye)),Si}return Ar.cancel=Zs,Ar.flush=mr,Ar}function at($e){var Ye=typeof $e;return!!$e&&(Ye=="object"||Ye=="function")}function It($e){return!!$e&&typeof $e=="object"}function vt($e){return typeof $e=="symbol"||It($e)&&zt.call($e)==he}function nt($e){if(typeof $e=="number")return $e;if(vt($e))return Te;if(at($e)){var Ye=typeof $e.valueOf=="function"?$e.valueOf():$e;$e=at(Ye)?Ye+"":Ye}if(typeof $e!="string")return $e===0?$e:+$e;$e=$e.replace(pe,"");var yt=be.test($e);return yt||Be.test($e)?o($e.slice(2),yt?2:8):le.test($e)?Te:+$e}return B_=Ge,B_}var Ep={exports:{}},v0;function X2(){if(v0)return Ep.exports;v0=1;var je=typeof Reflect=="object"?Reflect:null,Te=je&&typeof je.apply=="function"?je.apply:function($e,Ye,yt){return Function.prototype.apply.call($e,Ye,yt)},he;je&&typeof je.ownKeys=="function"?he=je.ownKeys:Object.getOwnPropertySymbols?he=function($e){return Object.getOwnPropertyNames($e).concat(Object.getOwnPropertySymbols($e))}:he=function($e){return Object.getOwnPropertyNames($e)};function pe(nt){console&&console.warn&&console.warn(nt)}var le=Number.isNaN||function($e){return $e!==$e};function be(){be.init.call(this)}Ep.exports=be,Ep.exports.once=at,be.EventEmitter=be,be.prototype._events=void 0,be.prototype._eventsCount=0,be.prototype._maxListeners=void 0;var Be=10;function o(nt){if(typeof nt!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof nt)}Object.defineProperty(be,"defaultMaxListeners",{enumerable:!0,get:function(){return Be},set:function(nt){if(typeof nt!="number"||nt<0||le(nt))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+nt+".");Be=nt}}),be.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},be.prototype.setMaxListeners=function($e){if(typeof $e!="number"||$e<0||le($e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+$e+".");return this._maxListeners=$e,this};function Ae(nt){return nt._maxListeners===void 0?be.defaultMaxListeners:nt._maxListeners}be.prototype.getMaxListeners=function(){return Ae(this)},be.prototype.emit=function($e){for(var Ye=[],yt=1;yt<arguments.length;yt++)Ye.push(arguments[yt]);var Gt=$e==="error",gi=this._events;if(gi!==void 0)Gt=Gt&&gi.error===void 0;else if(!Gt)return!1;if(Gt){var xi;if(Ye.length>0&&(xi=Ye[0]),xi instanceof Error)throw xi;var Si=new Error("Unhandled error."+(xi?" ("+xi.message+")":""));throw Si.context=xi,Si}var Dr=gi[$e];if(Dr===void 0)return!1;if(typeof Dr=="function")Te(Dr,this,Ye);else for(var Rr=Dr.length,Ei=st(Dr,Rr),yt=0;yt<Rr;++yt)Te(Ei[yt],this,Ye);return!0};function Ce(nt,$e,Ye,yt){var Gt,gi,xi;if(o(Ye),gi=nt._events,gi===void 0?(gi=nt._events=Object.create(null),nt._eventsCount=0):(gi.newListener!==void 0&&(nt.emit("newListener",$e,Ye.listener?Ye.listener:Ye),gi=nt._events),xi=gi[$e]),xi===void 0)xi=gi[$e]=Ye,++nt._eventsCount;else if(typeof xi=="function"?xi=gi[$e]=yt?[Ye,xi]:[xi,Ye]:yt?xi.unshift(Ye):xi.push(Ye),Gt=Ae(nt),Gt>0&&xi.length>Gt&&!xi.warned){xi.warned=!0;var Si=new Error("Possible EventEmitter memory leak detected. "+xi.length+" "+String($e)+" listeners added. Use emitter.setMaxListeners() to increase limit");Si.name="MaxListenersExceededWarning",Si.emitter=nt,Si.type=$e,Si.count=xi.length,pe(Si)}return nt}be.prototype.addListener=function($e,Ye){return Ce(this,$e,Ye,!1)},be.prototype.on=be.prototype.addListener,be.prototype.prependListener=function($e,Ye){return Ce(this,$e,Ye,!0)};function ot(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function ht(nt,$e,Ye){var yt={fired:!1,wrapFn:void 0,target:nt,type:$e,listener:Ye},Gt=ot.bind(yt);return Gt.listener=Ye,yt.wrapFn=Gt,Gt}be.prototype.once=function($e,Ye){return o(Ye),this.on($e,ht(this,$e,Ye)),this},be.prototype.prependOnceListener=function($e,Ye){return o(Ye),this.prependListener($e,ht(this,$e,Ye)),this},be.prototype.removeListener=function($e,Ye){var yt,Gt,gi,xi,Si;if(o(Ye),Gt=this._events,Gt===void 0)return this;if(yt=Gt[$e],yt===void 0)return this;if(yt===Ye||yt.listener===Ye)--this._eventsCount===0?this._events=Object.create(null):(delete Gt[$e],Gt.removeListener&&this.emit("removeListener",$e,yt.listener||Ye));else if(typeof yt!="function"){for(gi=-1,xi=yt.length-1;xi>=0;xi--)if(yt[xi]===Ye||yt[xi].listener===Ye){Si=yt[xi].listener,gi=xi;break}if(gi<0)return this;gi===0?yt.shift():re(yt,gi),yt.length===1&&(Gt[$e]=yt[0]),Gt.removeListener!==void 0&&this.emit("removeListener",$e,Si||Ye)}return this},be.prototype.off=be.prototype.removeListener,be.prototype.removeAllListeners=function($e){var Ye,yt,Gt;if(yt=this._events,yt===void 0)return this;if(yt.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):yt[$e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete yt[$e]),this;if(arguments.length===0){var gi=Object.keys(yt),xi;for(Gt=0;Gt<gi.length;++Gt)xi=gi[Gt],xi!=="removeListener"&&this.removeAllListeners(xi);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(Ye=yt[$e],typeof Ye=="function")this.removeListener($e,Ye);else if(Ye!==void 0)for(Gt=Ye.length-1;Gt>=0;Gt--)this.removeListener($e,Ye[Gt]);return this};function zt(nt,$e,Ye){var yt=nt._events;if(yt===void 0)return[];var Gt=yt[$e];return Gt===void 0?[]:typeof Gt=="function"?Ye?[Gt.listener||Gt]:[Gt]:Ye?Ge(Gt):st(Gt,Gt.length)}be.prototype.listeners=function($e){return zt(this,$e,!0)},be.prototype.rawListeners=function($e){return zt(this,$e,!1)},be.listenerCount=function(nt,$e){return typeof nt.listenerCount=="function"?nt.listenerCount($e):qt.call(nt,$e)},be.prototype.listenerCount=qt;function qt(nt){var $e=this._events;if($e!==void 0){var Ye=$e[nt];if(typeof Ye=="function")return 1;if(Ye!==void 0)return Ye.length}return 0}be.prototype.eventNames=function(){return this._eventsCount>0?he(this._events):[]};function st(nt,$e){for(var Ye=new Array($e),yt=0;yt<$e;++yt)Ye[yt]=nt[yt];return Ye}function re(nt,$e){for(;$e+1<nt.length;$e++)nt[$e]=nt[$e+1];nt.pop()}function Ge(nt){for(var $e=new Array(nt.length),Ye=0;Ye<$e.length;++Ye)$e[Ye]=nt[Ye].listener||nt[Ye];return $e}function at(nt,$e){return new Promise(function(Ye,yt){function Gt(xi){nt.removeListener($e,gi),yt(xi)}function gi(){typeof nt.removeListener=="function"&&nt.removeListener("error",Gt),Ye([].slice.call(arguments))}vt(nt,$e,gi,{once:!0}),$e!=="error"&&It(nt,Gt,{once:!0})})}function It(nt,$e,Ye){typeof nt.on=="function"&&vt(nt,"error",$e,Ye)}function vt(nt,$e,Ye,yt){if(typeof nt.on=="function")yt.once?nt.once($e,Ye):nt.on($e,Ye);else if(typeof nt.addEventListener=="function")nt.addEventListener($e,function Gt(gi){yt.once&&nt.removeEventListener($e,Gt),Ye(gi)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof nt)}return Ep.exports}var N_,x0;function Y2(){return x0||(x0=1,N_={fr:{name:"France",bbox:[[-4.59235,41.380007],[9.560016,51.148506]]},us:{name:"United States",bbox:[[-171.791111,18.91619],[-66.96466,71.357764]]},ru:{name:"Russia",bbox:[[19.66064,41.151416],[190.10042,81.2504]]},ca:{name:"Canada",bbox:[[-140.99778,41.675105],[-52.648099,83.23324]]}}),N_}var V_,b0;function K2(){if(b0)return V_;b0=1;function je(pe){var le=pe.match(/\s*(.+)\s*=\s*"?([^"]+)"?/);return le?{key:le[1],value:le[2]}:null}function Te(pe){var le=pe.match(/<?([^>]*)>(.*)/);if(!le)return null;var be=le[1],Be=le[2].split(";"),o=null,Ae=Be.reduce(function(Ce,ot){var ht=je(ot);return ht?ht.key==="rel"?(o||(o=ht.value),Ce):(Ce[ht.key]=ht.value,Ce):Ce},{});return o?{url:be,rel:o,params:Ae}:null}function he(pe){return pe?pe.split(/,\s*</).reduce(function(le,be){var Be=Te(be);if(!Be)return le;var o=Be.rel.split(/\s+/);return o.forEach(function(Ae){le[Ae]||(le[Ae]={url:Be.url,params:Be.params})}),le},{}):{}}return V_=he,V_}var U_,w0;function J2(){if(w0)return U_;w0=1;var je=K2();function Te(he,pe){this.request=he,this.headers=pe.headers,this.rawBody=pe.body,this.statusCode=pe.statusCode;try{this.body=JSON.parse(pe.body||"{}")}catch{this.body=pe.body}this.links=je(this.headers.link)}return Te.prototype.hasNextPage=function(){return!!this.links.next},Te.prototype.nextPage=function(){return this.hasNextPage()?this.request._extend({path:this.links.next.url}):null},U_=Te,U_}var j_,T0;function Rp(){return T0||(T0=1,j_={API_ORIGIN:"https://api.mapbox.com",EVENT_PROGRESS_DOWNLOAD:"downloadProgress",EVENT_PROGRESS_UPLOAD:"uploadProgress",EVENT_ERROR:"error",EVENT_RESPONSE:"response",ERROR_HTTP:"HttpError",ERROR_REQUEST_ABORTED:"RequestAbortedError"}),j_}var G_,S0;function Q2(){if(S0)return G_;S0=1;var je=Rp();function Te(he){var pe=he.type||je.ERROR_HTTP,le;if(he.body)try{le=JSON.parse(he.body)}catch{le=he.body}else le=null;var be=he.message||null;be||(typeof le=="string"?be=le:le&&typeof le.message=="string"?be=le.message:pe===je.ERROR_REQUEST_ABORTED&&(be="Request aborted")),this.message=be,this.type=pe,this.statusCode=he.statusCode||null,this.request=he.request,this.body=le}return G_=Te,G_}var q_,E0;function eT(){if(E0)return q_;E0=1;function je(he){var pe=he.indexOf(":"),le=he.substring(0,pe).trim().toLowerCase(),be=he.substring(pe+1).trim();return{name:le,value:be}}function Te(he){var pe={};return he&&he.trim().split(/[\r|\n]+/).forEach(function(le){var be=je(le);pe[be.name]=be.value}),pe}return q_=Te,q_}var $_,I0;function tT(){if(I0)return $_;I0=1;var je=J2(),Te=Q2(),he=Rp(),pe=eT(),le={};function be(ht){var zt=le[ht.id];zt&&(zt.abort(),delete le[ht.id])}function Be(ht,zt){return new je(ht,{body:zt.response,headers:pe(zt.getAllResponseHeaders()),statusCode:zt.status})}function o(ht){var zt=ht.total,qt=ht.loaded,st=100*qt/zt;return{total:zt,transferred:qt,percent:st}}function Ae(ht,zt){return new Promise(function(qt,st){zt.onprogress=function(at){ht.emitter.emit(he.EVENT_PROGRESS_DOWNLOAD,o(at))};var re=ht.file;re&&(zt.upload.onprogress=function(at){ht.emitter.emit(he.EVENT_PROGRESS_UPLOAD,o(at))}),zt.onerror=function(at){st(at)},zt.onabort=function(){var at=new Te({request:ht,type:he.ERROR_REQUEST_ABORTED});st(at)},zt.onload=function(){if(delete le[ht.id],zt.status<200||zt.status>=400){var at=new Te({request:ht,body:zt.response,statusCode:zt.status});st(at);return}qt(zt)};var Ge=ht.body;typeof Ge=="string"?zt.send(Ge):Ge?zt.send(JSON.stringify(Ge)):re?zt.send(re):zt.send(),le[ht.id]=zt}).then(function(qt){return Be(ht,qt)})}function Ce(ht,zt){var qt=ht.url(zt),st=new window.XMLHttpRequest;return st.open(ht.method,qt),Object.keys(ht.headers).forEach(function(re){st.setRequestHeader(re,ht.headers[re])}),st}function ot(ht){return Promise.resolve().then(function(){var zt=Ce(ht,ht.client.accessToken);return Ae(ht,zt)})}return $_={browserAbort:be,sendRequestXhr:Ae,browserSend:ot,createRequestXhr:Ce},$_}var Sd={exports:{}};/*! http://mths.be/base64 v0.1.0 by @mathias | MIT license */var iT=Sd.exports,A0;function rT(){return A0||(A0=1,function(je,Te){(function(he){var pe=Te,le=je&&je.exports==pe&&je,be=typeof el=="object"&&el;(be.global===be||be.window===be)&&(he=be);var Be=function(st){this.message=st};Be.prototype=new Error,Be.prototype.name="InvalidCharacterError";var o=function(st){throw new Be(st)},Ae="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Ce=/[\t\n\f\r ]/g,ot=function(st){st=String(st).replace(Ce,"");var re=st.length;re%4==0&&(st=st.replace(/==?$/,""),re=st.length),(re%4==1||/[^+a-zA-Z0-9/]/.test(st))&&o("Invalid character: the string to be decoded is not correctly encoded.");for(var Ge=0,at,It,vt="",nt=-1;++nt<re;)It=Ae.indexOf(st.charAt(nt)),at=Ge%4?at*64+It:It,Ge++%4&&(vt+=String.fromCharCode(255&at>>(-2*Ge&6)));return vt},ht=function(st){st=String(st),/[^\0-\xFF]/.test(st)&&o("The string to be encoded contains characters outside of the Latin1 range.");for(var re=st.length%3,Ge="",at=-1,It,vt,nt,$e,Ye=st.length-re;++at<Ye;)It=st.charCodeAt(at)<<16,vt=st.charCodeAt(++at)<<8,nt=st.charCodeAt(++at),$e=It+vt+nt,Ge+=Ae.charAt($e>>18&63)+Ae.charAt($e>>12&63)+Ae.charAt($e>>6&63)+Ae.charAt($e&63);return re==2?(It=st.charCodeAt(at)<<8,vt=st.charCodeAt(++at),$e=It+vt,Ge+=Ae.charAt($e>>10)+Ae.charAt($e>>4&63)+Ae.charAt($e<<2&63)+"="):re==1&&($e=st.charCodeAt(at),Ge+=Ae.charAt($e>>2)+Ae.charAt($e<<4&63)+"=="),Ge},zt={encode:ht,decode:ot,version:"0.1.0"};if(pe&&!pe.nodeType)if(le)le.exports=zt;else for(var qt in zt)zt.hasOwnProperty(qt)&&(pe[qt]=zt[qt]);else he.base64=zt})(iT)}(Sd,Sd.exports)),Sd.exports}var H_,C0;function a1(){if(C0)return H_;C0=1;var je=rT(),Te={};function he(be){if(Te[be])return Te[be];var Be=be.split("."),o=Be[0],Ae=Be[1];if(!Ae)throw new Error("Invalid token");var Ce=pe(Ae),ot={usage:o,user:Ce.u};return le(Ce,"a")&&(ot.authorization=Ce.a),le(Ce,"exp")&&(ot.expires=Ce.exp*1e3),le(Ce,"iat")&&(ot.created=Ce.iat*1e3),le(Ce,"scopes")&&(ot.scopes=Ce.scopes),le(Ce,"client")&&(ot.client=Ce.client),le(Ce,"ll")&&(ot.lastLogin=Ce.ll),le(Ce,"iu")&&(ot.impersonator=Ce.iu),Te[be]=ot,ot}function pe(be){try{return JSON.parse(je.decode(be))}catch{throw new Error("Invalid token")}}function le(be,Be){return Object.prototype.hasOwnProperty.call(be,Be)}return H_=he,H_}var Z_={exports:{}},M0;function nT(){return M0||(M0=1,function(je){var Te=Object.prototype.hasOwnProperty,he="~";function pe(){}Object.create&&(pe.prototype=Object.create(null),new pe().__proto__||(he=!1));function le(Ae,Ce,ot){this.fn=Ae,this.context=Ce,this.once=ot||!1}function be(Ae,Ce,ot,ht,zt){if(typeof ot!="function")throw new TypeError("The listener must be a function");var qt=new le(ot,ht||Ae,zt),st=he?he+Ce:Ce;return Ae._events[st]?Ae._events[st].fn?Ae._events[st]=[Ae._events[st],qt]:Ae._events[st].push(qt):(Ae._events[st]=qt,Ae._eventsCount++),Ae}function Be(Ae,Ce){--Ae._eventsCount===0?Ae._events=new pe:delete Ae._events[Ce]}function o(){this._events=new pe,this._eventsCount=0}o.prototype.eventNames=function(){var Ce=[],ot,ht;if(this._eventsCount===0)return Ce;for(ht in ot=this._events)Te.call(ot,ht)&&Ce.push(he?ht.slice(1):ht);return Object.getOwnPropertySymbols?Ce.concat(Object.getOwnPropertySymbols(ot)):Ce},o.prototype.listeners=function(Ce){var ot=he?he+Ce:Ce,ht=this._events[ot];if(!ht)return[];if(ht.fn)return[ht.fn];for(var zt=0,qt=ht.length,st=new Array(qt);zt<qt;zt++)st[zt]=ht[zt].fn;return st},o.prototype.listenerCount=function(Ce){var ot=he?he+Ce:Ce,ht=this._events[ot];return ht?ht.fn?1:ht.length:0},o.prototype.emit=function(Ce,ot,ht,zt,qt,st){var re=he?he+Ce:Ce;if(!this._events[re])return!1;var Ge=this._events[re],at=arguments.length,It,vt;if(Ge.fn){switch(Ge.once&&this.removeListener(Ce,Ge.fn,void 0,!0),at){case 1:return Ge.fn.call(Ge.context),!0;case 2:return Ge.fn.call(Ge.context,ot),!0;case 3:return Ge.fn.call(Ge.context,ot,ht),!0;case 4:return Ge.fn.call(Ge.context,ot,ht,zt),!0;case 5:return Ge.fn.call(Ge.context,ot,ht,zt,qt),!0;case 6:return Ge.fn.call(Ge.context,ot,ht,zt,qt,st),!0}for(vt=1,It=new Array(at-1);vt<at;vt++)It[vt-1]=arguments[vt];Ge.fn.apply(Ge.context,It)}else{var nt=Ge.length,$e;for(vt=0;vt<nt;vt++)switch(Ge[vt].once&&this.removeListener(Ce,Ge[vt].fn,void 0,!0),at){case 1:Ge[vt].fn.call(Ge[vt].context);break;case 2:Ge[vt].fn.call(Ge[vt].context,ot);break;case 3:Ge[vt].fn.call(Ge[vt].context,ot,ht);break;case 4:Ge[vt].fn.call(Ge[vt].context,ot,ht,zt);break;default:if(!It)for($e=1,It=new Array(at-1);$e<at;$e++)It[$e-1]=arguments[$e];Ge[vt].fn.apply(Ge[vt].context,It)}}return!0},o.prototype.on=function(Ce,ot,ht){return be(this,Ce,ot,ht,!1)},o.prototype.once=function(Ce,ot,ht){return be(this,Ce,ot,ht,!0)},o.prototype.removeListener=function(Ce,ot,ht,zt){var qt=he?he+Ce:Ce;if(!this._events[qt])return this;if(!ot)return Be(this,qt),this;var st=this._events[qt];if(st.fn)st.fn===ot&&(!zt||st.once)&&(!ht||st.context===ht)&&Be(this,qt);else{for(var re=0,Ge=[],at=st.length;re<at;re++)(st[re].fn!==ot||zt&&!st[re].once||ht&&st[re].context!==ht)&&Ge.push(st[re]);Ge.length?this._events[qt]=Ge.length===1?Ge[0]:Ge:Be(this,qt)}return this},o.prototype.removeAllListeners=function(Ce){var ot;return Ce?(ot=he?he+Ce:Ce,this._events[ot]&&Be(this,ot)):(this._events=new pe,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=he,o.EventEmitter=o,je.exports=o}(Z_)),Z_.exports}var W_,P0;function sT(){if(P0)return W_;P0=1;function je(Be){return Be.map(encodeURIComponent).join(",")}function Te(Be){return Array.isArray(Be)?je(Be):encodeURIComponent(String(Be))}function he(Be,o,Ae){if(Ae===!1||Ae===null)return Be;var Ce=/\?/.test(Be)?"&":"?",ot=encodeURIComponent(o);return Ae!==void 0&&Ae!==""&&Ae!==!0&&(ot+="="+Te(Ae)),""+Be+Ce+ot}function pe(Be,o){if(!o)return Be;var Ae=Be;return Object.keys(o).forEach(function(Ce){var ot=o[Ce];ot!==void 0&&(Array.isArray(ot)&&(ot=ot.filter(function(ht){return ht!=null}).join(",")),Ae=he(Ae,Ce,ot))}),Ae}function le(Be,o){if(!o||Be.slice(0,4)==="http")return Be;var Ae=Be[0]==="/"?"":"/";return""+o.replace(/\/$/,"")+Ae+Be}function be(Be,o){return o?Be.replace(/\/:([a-zA-Z0-9]+)/g,function(Ae,Ce){var ot=o[Ce];if(ot===void 0)throw new Error("Unspecified route parameter "+Ce);var ht=Te(ot);return"/"+ht}):Be}return W_={appendQueryObject:pe,appendQueryParam:he,prependOrigin:le,interpolateRouteParams:be},W_}var X_,R0;function oT(){if(R0)return X_;R0=1;var je=a1(),Te=Ou(),he=nT(),pe=sT(),le=Rp(),be=1;function Be(o,Ae){if(!o)throw new Error("MapiRequest requires a client");if(!Ae||!Ae.path||!Ae.method)throw new Error("MapiRequest requires an options object with path and method properties");var Ce={};Ae.body&&(Ce["content-type"]="application/json");var ot=Te(Ce,Ae.headers),ht=Object.keys(ot).reduce(function(zt,qt){return zt[qt.toLowerCase()]=ot[qt],zt},{});this.id=be++,this._options=Ae,this.emitter=new he,this.client=o,this.response=null,this.error=null,this.sent=!1,this.aborted=!1,this.path=Ae.path,this.method=Ae.method,this.origin=Ae.origin||o.origin,this.query=Ae.query||{},this.params=Ae.params||{},this.body=Ae.body||null,this.file=Ae.file||null,this.encoding=Ae.encoding||"utf8",this.sendFileAs=Ae.sendFileAs||null,this.headers=ht}return Be.prototype.url=function(Ae){var Ce=pe.prependOrigin(this.path,this.origin);Ce=pe.appendQueryObject(Ce,this.query);var ot=this.params,ht=Ae??this.client.accessToken;if(ht){Ce=pe.appendQueryParam(Ce,"access_token",ht);var zt=je(ht).user;ot=Te({ownerId:zt},ot)}return Ce=pe.interpolateRouteParams(Ce,ot),Ce},Be.prototype.send=function(){var Ae=this;if(Ae.sent)throw new Error("This request has already been sent. Check the response and error properties. Create a new request with clone().");return Ae.sent=!0,Ae.client.sendRequest(Ae).then(function(Ce){return Ae.response=Ce,Ae.emitter.emit(le.EVENT_RESPONSE,Ce),Ce},function(Ce){throw Ae.error=Ce,Ae.emitter.emit(le.EVENT_ERROR,Ce),Ce})},Be.prototype.abort=function(){this._nextPageRequest&&(this._nextPageRequest.abort(),delete this._nextPageRequest),!(this.response||this.error||this.aborted)&&(this.aborted=!0,this.client.abortRequest(this))},Be.prototype.eachPage=function(Ae){var Ce=this;function ot(qt){function st(){delete Ce._nextPageRequest;var re=qt.nextPage();re&&(Ce._nextPageRequest=re,zt(re))}Ae(null,qt,st)}function ht(qt){Ae(qt,null,function(){})}function zt(qt){qt.send().then(ot,ht)}zt(this)},Be.prototype.clone=function(){return this._extend()},Be.prototype._extend=function(Ae){var Ce=Te(this._options,Ae);return new Be(this.client,Ce)},X_=Be,X_}var Y_,z0;function l1(){if(z0)return Y_;z0=1;var je=a1(),Te=oT(),he=Rp();function pe(le){if(!le||!le.accessToken)throw new Error("Cannot create a client without an access token");je(le.accessToken),this.accessToken=le.accessToken,this.origin=le.origin||he.API_ORIGIN}return pe.prototype.createRequest=function(be){return new Te(this,be)},Y_=pe,Y_}var K_,L0;function c1(){if(L0)return K_;L0=1;var je=tT(),Te=l1();function he(le){Te.call(this,le)}he.prototype=Object.create(Te.prototype),he.prototype.constructor=he,he.prototype.sendRequest=je.browserSend,he.prototype.abortRequest=je.browserAbort;function pe(le){return new he(le)}return K_=pe,K_}var J_,D0;function aT(){if(D0)return J_;D0=1;var je=c1();return J_=je,J_}var Q_,O0;function lT(){if(O0)return Q_;O0=1;var je=Object.prototype.toString;return Q_=function(Te){var he;return je.call(Te)==="[object Object]"&&(he=Object.getPrototypeOf(Te),he===null||he===Object.getPrototypeOf({}))},Q_}var eg,k0;function cT(){if(k0)return eg;k0=1;var je=lT(),Te=Ou(),he="value",pe=`
  `,le={};le.assert=function(st,re){return re=re||{},function(Ge){var at=Be(st,Ge);if(at){var It=o(at,re);throw re.apiName&&(It=re.apiName+": "+It),new Error(It)}}},le.shape=function(re){var Ge=qt(re);return function(It){var vt=Be(le.plainObject,It);if(vt)return vt;for(var nt,$e,Ye=[],yt=0;yt<Ge.length;yt++)nt=Ge[yt].key,$e=Ge[yt].value,vt=Be($e,It[nt]),vt&&Ye.push([nt].concat(vt));return Ye.length<2?Ye[0]:function(Gt){Ye=Ye.map(function(Si){var Dr=Si[0],Rr=o(Si,Gt).split(`
`).join(pe);return"- "+Dr+": "+Rr});var gi=Gt.path.join("."),xi=gi===he?"":" of "+gi;return"The following properties"+xi+" have invalid values:"+pe+Ye.join(pe)}}},le.strictShape=function(re){var Ge=le.shape(re);return function(It){var vt=Ge(It);if(vt)return vt;var nt=Object.keys(It).reduce(function($e,Ye){return re[Ye]===void 0&&$e.push(Ye),$e},[]);if(nt.length!==0)return function(){return"The following keys are invalid: "+nt.join(", ")}}},le.arrayOf=function(re){return be(re)},le.tuple=function(){var re=Array.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments);return be(re)};function be(st){var re=Array.isArray(st),Ge=function(at){return re?st[at]:st};return function(It){var vt=Be(le.plainArray,It);if(vt)return vt;if(re&&It.length!==st.length)return"an array with "+st.length+" items";for(var nt=0;nt<It.length;nt++)if(vt=Be(Ge(nt),It[nt]),vt)return[nt].concat(vt)}}le.required=function(re){function Ge(at){return at==null?function(It){return ht(It,zt(It.path)?"cannot be undefined/null.":"is required.")}:re.apply(this,arguments)}return Ge.__required=!0,Ge},le.oneOfType=function(){var re=Array.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments);return function(at){var It=re.map(function(vt){return Be(vt,at)}).filter(Boolean);if(It.length===re.length)return It.every(function(vt){return vt.length===1&&typeof vt[0]=="string"})?Ae(It.map(function(vt){return vt[0]})):It.reduce(function(vt,nt){return nt.length>vt.length?nt:vt})}},le.equal=function(re){return function(at){if(at!==re)return JSON.stringify(re)}},le.oneOf=function(){var re=Array.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments),Ge=re.map(function(at){return le.equal(at)});return le.oneOfType.apply(this,Ge)},le.range=function(re){var Ge=re[0],at=re[1];return function(vt){var nt=Be(le.number,vt);if(nt||vt<Ge||vt>at)return"number between "+Ge+" & "+at+" (inclusive)"}},le.any=function(){},le.boolean=function(re){if(typeof re!="boolean")return"boolean"},le.number=function(re){if(typeof re!="number")return"number"},le.plainArray=function(re){if(!Array.isArray(re))return"array"},le.plainObject=function(re){if(!je(re))return"object"},le.string=function(re){if(typeof re!="string")return"string"},le.func=function(re){if(typeof re!="function")return"function"};function Be(st,re){if(!(re==null&&!st.hasOwnProperty("__required"))){var Ge=st(re);if(Ge)return Array.isArray(Ge)?Ge:[Ge]}}function o(st,re){var Ge=st.length,at=st[Ge-1],It=st.slice(0,Ge-1);return It.length===0&&(It=[he]),re=Te(re,{path:It}),typeof at=="function"?at(re):ht(re,Ce(at))}function Ae(st){return st.length<2?st[0]:st.length===2?st.join(" or "):st.slice(0,-1).join(", ")+", or "+st.slice(-1)}function Ce(st){return"must be "+ot(st)+"."}function ot(st){return/^an? /.test(st)?st:/^[aeiou]/i.test(st)?"an "+st:/^[a-z]/i.test(st)?"a "+st:st}function ht(st,re){var Ge=zt(st.path),at=st.path.join(".")+" "+re,It=Ge?"Item at position ":"";return It+at}function zt(st){return typeof st[st.length-1]=="number"||typeof st[0]=="number"}function qt(st){return Object.keys(st||{}).map(function(re){return{key:re,value:st[re]}})}return le.validate=Be,le.processMessage=o,eg=le,eg}var tg,F0;function uT(){if(F0)return tg;F0=1;var je=Ou(),Te=cT();function he(Be){if(typeof window<"u")return Be instanceof el.Blob||Be instanceof el.ArrayBuffer?void 0:"Blob or ArrayBuffer";if(!(typeof Be=="string"||Be.pipe!==void 0))return"Filename or Readable stream"}function pe(Be,o){return Te.assert(Te.strictShape(Be),o)}function le(Be){var o="date";if(typeof Be=="boolean")return o;try{var Ae=new Date(Be);if(Ae.getTime&&isNaN(Ae.getTime()))return o}catch{return o}}function be(Be){return Te.tuple(Te.number,Te.number)(Be)}return tg=je(Te,{file:he,date:le,coordinates:be,assertShape:pe}),tg}var ig,B0;function hT(){if(B0)return ig;B0=1;function je(Te,he){var pe=function(le,be){return he.indexOf(le)!==-1&&be!==void 0};return typeof he=="function"&&(pe=he),Object.keys(Te).filter(function(le){return pe(le,Te[le])}).reduce(function(le,be){return le[be]=Te[be],le},{})}return ig=je,ig}var rg,N0;function dT(){if(N0)return rg;N0=1;function je(Te,he){return Object.keys(Te).reduce(function(pe,le){return pe[le]=he(le,Te[le]),pe},{})}return rg=je,rg}var ng,V0;function fT(){if(V0)return ng;V0=1;var je=dT();function Te(he){return je(he,function(pe,le){return typeof le=="boolean"?JSON.stringify(le):le})}return ng=Te,ng}var sg,U0;function pT(){if(U0)return sg;U0=1;var je=l1(),Te=c1();function he(pe){return function(le){var be;je.prototype.isPrototypeOf(le)?be=le:be=Te(le);var Be=Object.create(pe);return Be.client=be,Be}}return sg=he,sg}var og,j0;function mT(){if(j0)return og;j0=1;var je=Ou(),Te=uT(),he=hT(),pe=fT(),le=pT(),be={},Be=["country","region","postcode","district","place","locality","neighborhood","address","poi","poi.landmark"];return be.forwardGeocode=function(o){Te.assertShape({query:Te.required(Te.string),mode:Te.oneOf("mapbox.places","mapbox.places-permanent"),countries:Te.arrayOf(Te.string),proximity:Te.oneOf(Te.coordinates,"ip"),types:Te.arrayOf(Te.oneOf(Be)),autocomplete:Te.boolean,bbox:Te.arrayOf(Te.number),limit:Te.number,language:Te.arrayOf(Te.string),routing:Te.boolean,fuzzyMatch:Te.boolean,worldview:Te.string,session_token:Te.string})(o),o.mode=o.mode||"mapbox.places";var Ae=pe(je({country:o.countries},he(o,["proximity","types","autocomplete","bbox","limit","language","routing","fuzzyMatch","worldview","session_token"])));return this.client.createRequest({method:"GET",path:"/geocoding/v5/:mode/:query.json",params:he(o,["mode","query"]),query:Ae})},be.reverseGeocode=function(o){Te.assertShape({query:Te.required(Te.coordinates),mode:Te.oneOf("mapbox.places","mapbox.places-permanent"),countries:Te.arrayOf(Te.string),types:Te.arrayOf(Te.oneOf(Be)),bbox:Te.arrayOf(Te.number),limit:Te.number,language:Te.arrayOf(Te.string),reverseMode:Te.oneOf("distance","score"),routing:Te.boolean,worldview:Te.string,session_token:Te.string})(o),o.mode=o.mode||"mapbox.places";var Ae=pe(je({country:o.countries},he(o,["country","types","bbox","limit","language","reverseMode","routing","worldview","session_token"])));return this.client.createRequest({method:"GET",path:"/geocoding/v5/:mode/:query.json",params:he(o,["mode","query"]),query:Ae})},og=le(be),og}let _T="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict",u1=je=>crypto.getRandomValues(new Uint8Array(je)),h1=(je,Te,he)=>{let pe=(2<<Math.log(je.length-1)/Math.LN2)-1,le=-~(1.6*pe*Te/je.length);return(be=Te)=>{let Be="";for(;;){let o=he(le),Ae=le|0;for(;Ae--;)if(Be+=je[o[Ae]&pe]||"",Be.length===be)return Be}}},gT=(je,Te=21)=>h1(je,Te,u1),yT=(je=21)=>crypto.getRandomValues(new Uint8Array(je)).reduce((Te,he)=>(he&=63,he<36?Te+=he.toString(36):he<62?Te+=(he-26).toString(36).toUpperCase():he>62?Te+="-":Te+="_",Te),"");const vT=Object.freeze(Object.defineProperty({__proto__:null,customAlphabet:gT,customRandom:h1,nanoid:yT,random:u1,urlAlphabet:_T},Symbol.toStringTag,{value:"Module"})),xT=V2(vT);var ag,G0;function bT(){if(G0)return ag;G0=1;var je=xT.nanoid;function Te(he){this.origin=he.origin||"https://api.mapbox.com",this.endpoint="events/v2",this.access_token=he.accessToken,this.version="0.3.0",this.pluginSessionID=this.generateSessionID(),this.sessionIncrementer=0,this.userAgent=this.getUserAgent(),this.options=he,this.send=this.send.bind(this),this.countries=he.countries?he.countries.split(","):null,this.types=he.types?he.types.split(","):null,this.bbox=he.bbox?he.bbox:null,this.language=he.language?he.language.split(","):null,this.limit=he.limit?+he.limit:null,this.locale=navigator.language||null,this.enableEventLogging=this.shouldEnableLogging(he),this.eventQueue=new Array,this.flushInterval=he.flushInterval||1e3,this.maxQueueSize=he.maxQueueSize||100,this.timer=this.flushInterval?setTimeout(this.flush.bind(this),this.flushInterval):null,this.lastSentInput="",this.lastSentIndex=0}return Te.prototype={select:function(he,pe){var le=this.getEventPayload("search.select",pe,{selectedFeature:he});if(le&&!(le.resultIndex===this.lastSentIndex&&le.queryString===this.lastSentInput||le.resultIndex==-1))return this.lastSentIndex=le.resultIndex,this.lastSentInput=le.queryString,this.push(le)},start:function(he){var pe=this.getEventPayload("search.start",he);if(pe)return this.push(pe)},keyevent:function(he,pe){if(he.key&&!(he.metaKey||[9,27,37,39,13,38,40].indexOf(he.keyCode)!==-1)){var le=this.getEventPayload("search.keystroke",pe,{key:he.key});if(le)return this.push(le)}},send:function(he,pe){if(!this.enableEventLogging)return pe?pe():void 0;var le=this.getRequestOptions(he);this.request(le,(function(be){if(be)return this.handleError(be,pe);if(pe)return pe()}).bind(this))},getRequestOptions:function(he){Array.isArray(he)||(he=[he]);var pe={method:"POST",host:this.origin,path:this.endpoint+"?access_token="+this.access_token,headers:{"Content-Type":"application/json"},body:JSON.stringify(he)};return pe},getEventPayload:function(he,pe,le={}){if(he==="search.select"&&!le.selectedFeature||he==="search.keystroke"&&!le.key)return null;var be;if(!pe.options.proximity)be=null;else if(typeof pe.options.proximity=="object")be=[pe.options.proximity.longitude,pe.options.proximity.latitude];else if(pe.options.proximity==="ip"){var Be=pe._headers?pe._headers["ip-proximity"]:null;Be&&typeof Be=="string"?be=Be.split(",").map(parseFloat):be=[999,999]}else be=pe.options.proximity;var o=pe._map?pe._map.getZoom():void 0,Ae={event:he,version:this.getEventSchemaVersion(he),created:+new Date,sessionIdentifier:this.getSessionId(),country:this.countries,userAgent:this.userAgent,language:this.language,bbox:this.bbox,types:this.types,endpoint:"mapbox.places",autocomplete:pe.options.autocomplete,fuzzyMatch:pe.options.fuzzyMatch,proximity:be,limit:pe.options.limit,routing:pe.options.routing,worldview:pe.options.worldview,mapZoom:o,keyboardLocale:this.locale};if(he==="search.select"?Ae.queryString=pe.inputString:he!="search.select"&&pe._inputEl?Ae.queryString=pe._inputEl.value:Ae.queryString=pe.inputString,["search.keystroke","search.select"].includes(he)&&(Ae.path="geocoding/v5/mapbox.places"),he==="search.keystroke"&&le.key)Ae.lastAction=le.key;else if(he==="search.select"&&le.selectedFeature){var Ce=le.selectedFeature,ot=this.getSelectedIndex(Ce,pe);if(Ae.resultIndex=ot,Ae.resultPlaceName=Ce.place_name,Ae.resultId=Ce.id,Ce.properties&&(Ae.resultMapboxId=Ce.properties.mapbox_id),pe._typeahead){var ht=pe._typeahead.data;ht&&ht.length>0&&(Ae.suggestionIds=this.getSuggestionIds(ht),Ae.suggestionNames=this.getSuggestionNames(ht),Ae.suggestionTypes=this.getSuggestionTypes(ht),Ae.suggestionSources=this.getSuggestionSources(ht))}}return this.validatePayload(Ae)?Ae:null},request:function(he,pe){var le=new XMLHttpRequest;le.onreadystatechange=function(){if(this.readyState==4)return this.status==204?pe(null):pe(this.statusText)},le.open(he.method,he.host+"/"+he.path,!0);for(var be in he.headers){var Be=he.headers[be];le.setRequestHeader(be,Be)}le.send(he.body)},handleError:function(he,pe){if(pe)return pe(he)},generateSessionID:function(){return je()},getSessionId:function(){return this.pluginSessionID+"."+this.sessionIncrementer},getUserAgent:function(){return"mapbox-gl-geocoder."+this.version+"."+navigator.userAgent},getSelectedIndex:function(he,pe){if(pe._typeahead){var le=pe._typeahead.data,be=he.id,Be=le.map(function(Ae){return Ae.id}),o=Be.indexOf(be);return o}},getSuggestionIds:function(he){return he.map(function(pe){return pe.properties?pe.properties.mapbox_id||"":pe.id||""})},getSuggestionNames:function(he){return he.map(function(pe){return pe.place_name||""})},getSuggestionTypes:function(he){return he.map(function(pe){return pe.place_type&&Array.isArray(pe.place_type)&&pe.place_type[0]||""})},getSuggestionSources:function(he){return he.map(function(pe){return pe._source||""})},getEventSchemaVersion:function(he){return["search.keystroke","search.select"].includes(he)?"2.2":"2.0"},validatePayload:function(he){if(!he||!he.event)return!1;var pe=["event","created","sessionIdentifier","queryString"],le=["event","created","sessionIdentifier","queryString","lastAction"],be=["event","created","sessionIdentifier","queryString","resultIndex","path","suggestionIds"],Be=he.event;return Be==="search.start"?this.objectHasRequiredProps(he,pe):Be==="search.keystroke"?this.objectHasRequiredProps(he,le):Be==="search.select"?this.objectHasRequiredProps(he,be):!0},objectHasRequiredProps:function(he,pe){return pe.every(function(le){return le==="queryString"?typeof he[le]=="string"&&he[le].length>0:he[le]!==void 0})},shouldEnableLogging:function(he){return!(he.enableEventLogging===!1||he.origin&&he.origin!=="https://api.mapbox.com")},flush:function(){this.eventQueue.length>0&&(this.send(this.eventQueue),this.eventQueue=new Array),this.timer&&clearTimeout(this.timer),this.flushInterval&&(this.timer=setTimeout(this.flush.bind(this),this.flushInterval))},push:function(he,pe){this.eventQueue.push(he),(this.eventQueue.length>=this.maxQueueSize||pe)&&this.flush()},remove:function(){this.flush()}},ag=Te,ag}var lg,q0;function wT(){if(q0)return lg;q0=1;var je={de:"Suche",it:"Ricerca",en:"Search",nl:"Zoeken",fr:"Chercher",ca:"Cerca",he:"לחפש",ja:"サーチ",lv:"Meklēt",pt:"Procurar",sr:"Претрага",zh:"搜索",cs:"Vyhledávání",hu:"Keresés",ka:"ძიება",nb:"Søke",sk:"Vyhľadávanie",th:"ค้นหา",fi:"Hae",is:"Leita",ko:"수색",pl:"Szukaj",sl:"Iskanje",fa:"جستجو",ru:"Поиск"};return lg={placeholder:je},lg}var Ap={exports:{}},TT=Ap.exports,$0;function ST(){return $0||($0=1,function(je){(function(Te,he,pe){je.exports?je.exports=pe():Te[he]=pe()})(TT,"subtag",function(){var Te="",he=/^([a-zA-Z]{2,3})(?:[_-]+([a-zA-Z]{3})(?=$|[_-]+))?(?:[_-]+([a-zA-Z]{4})(?=$|[_-]+))?(?:[_-]+([a-zA-Z]{2}|[0-9]{3})(?=$|[_-]+))?/;function pe(Ae){return Ae.match(he)||[]}function le(Ae){return pe(Ae).filter(function(Ce,ot){return Ce&&ot})}function be(Ae){return Ae=pe(Ae),{language:Ae[1]||Te,extlang:Ae[2]||Te,script:Ae[3]||Te,region:Ae[4]||Te}}function Be(Ae,Ce,ot){Object.defineProperty(Ae,Ce,{value:ot,enumerable:!0})}function o(Ae,Ce,ot){function ht(zt){return pe(zt)[Ae]||Te}Be(ht,"pattern",Ce),Be(be,ot,ht)}return o(1,/^[a-zA-Z]{2,3}$/,"language"),o(2,/^[a-zA-Z]{3}$/,"extlang"),o(3,/^[a-zA-Z]{4}$/,"script"),o(4,/^[a-zA-Z]{2}$|^[0-9]{3}$/,"region"),Be(be,"split",le),be})}(Ap)),Ap.exports}var cg,H0;function ET(){if(H0)return cg;H0=1;function je(){}return je.prototype={isSupport:function(){return!!window.navigator.geolocation},getCurrentPosition:function(){const Te={enableHighAccuracy:!0};return new Promise(function(he,pe){window.navigator.geolocation.getCurrentPosition(he,pe,Te)})}},cg=je,cg}var ug,Z0;function IT(){if(Z0)return ug;Z0=1;function je(pe,le){const be=Te(pe),Be=["address","street","place","country"];var o;if(typeof le=="function")return le(be);const Ae=Be.indexOf(le);return Ae===-1?o=Be:o=Be.slice(Ae),o.reduce(function(Ce,ot){return be[ot]?(Ce!==""&&(Ce=Ce+", "),Ce+be[ot]):Ce},"")}function Te(pe){const le=pe.address||"",be=pe.text||"",Be=pe.place_name||"",Ae={address:Be.split(",")[0],houseNumber:le,street:be,placeName:Be};return pe.context.forEach(function(Ce){const ot=Ce.id.split(".")[0];Ae[ot]=Ce.text}),Ae}return ug={transformFeatureToGeolocationText:je,getAddressInfo:Te,REVERSE_GEOCODE_COORD_RGX:/^[ ]*(-?\d{1,3}(\.\d{0,256})?)[, ]+(-?\d{1,3}(\.\d{0,256})?)[ ]*$/},ug}var hg,W0;function AT(){if(W0)return hg;W0=1;var je=Z2(),Te=W2(),he=Ou(),pe=X2().EventEmitter,le=Y2(),be=aT(),Be=mT(),o=bT(),Ae=wT(),Ce=ST(),ot=ET(),ht=IT();const zt={FORWARD:0,LOCAL:1,REVERSE:2};function qt(){var re=document.createElement("div");return re.className="mapboxgl-ctrl-geocoder--powered-by",re.innerHTML='<a href="https://www.mapbox.com/search-service" target="_blank">Powered by Mapbox</a>',re}function st(re){this._eventEmitter=new pe,this.options=he({},this.options,re),this.inputString="",this.fresh=!0,this.lastSelected=null,this.geolocation=new ot}return st.prototype={options:{zoom:16,flyTo:!0,trackProximity:!0,minLength:2,reverseGeocode:!1,flipCoordinates:!1,limit:5,origin:"https://api.mapbox.com",enableEventLogging:!0,marker:!0,mapboxgl:null,collapsed:!1,clearAndBlurOnEsc:!1,clearOnBlur:!1,enableGeolocation:!1,addressAccuracy:"street",getItemValue:function(re){return re.place_name},render:function(re){var Ge=re.place_name.split(",");return'<div class="mapboxgl-ctrl-geocoder--suggestion"><div class="mapboxgl-ctrl-geocoder--suggestion-title">'+Ge[0]+'</div><div class="mapboxgl-ctrl-geocoder--suggestion-address">'+Ge.splice(1,Ge.length).join(",")+"</div></div>"}},_headers:{},addTo:function(re){function Ge(at,It){if(!document.body.contains(It))throw new Error("Element provided to #addTo() exists, but is not in the DOM");const vt=at.onAdd();It.appendChild(vt)}if(re._controlContainer)re.addControl(this);else if(re instanceof HTMLElement)Ge(this,re);else if(typeof re=="string"){const at=document.querySelectorAll(re);if(at.length===0)throw new Error("Element ",re,"not found.");if(at.length>1)throw new Error("Geocoder can only be added to a single html element");Ge(this,at[0])}else throw new Error("Error: addTo must be a mapbox-gl-js map, an html element, or a CSS selector query for a single html element")},onAdd:function(re){if(re&&typeof re!="string"&&(this._map=re),this.setLanguage(),this.options.localGeocoderOnly||(this.geocoderService=Be(be({accessToken:this.options.accessToken,origin:this.options.origin}))),this.options.localGeocoderOnly&&!this.options.localGeocoder)throw new Error("A localGeocoder function must be specified to use localGeocoderOnly mode");this.eventManager=new o(this.options),this._onChange=this._onChange.bind(this),this._onKeyDown=this._onKeyDown.bind(this),this._onPaste=this._onPaste.bind(this),this._onBlur=this._onBlur.bind(this),this._showButton=this._showButton.bind(this),this._hideButton=this._hideButton.bind(this),this._onQueryResult=this._onQueryResult.bind(this),this.clear=this.clear.bind(this),this._updateProximity=this._updateProximity.bind(this),this._collapse=this._collapse.bind(this),this._unCollapse=this._unCollapse.bind(this),this._clear=this._clear.bind(this),this._clearOnBlur=this._clearOnBlur.bind(this),this._geolocateUser=this._geolocateUser.bind(this);var Ge=this.container=document.createElement("div");Ge.className="mapboxgl-ctrl-geocoder mapboxgl-ctrl";var at=this.createIcon("search",'<path d="M7.4 2.5c-2.7 0-4.9 2.2-4.9 4.9s2.2 4.9 4.9 4.9c1 0 1.8-.2 2.5-.8l3.7 3.7c.2.2.4.3.8.3.7 0 1.1-.4 1.1-1.1 0-.3-.1-.5-.3-.8L11.4 10c.4-.8.8-1.6.8-2.5.1-2.8-2.1-5-4.8-5zm0 1.6c1.8 0 3.2 1.4 3.2 3.2s-1.4 3.2-3.2 3.2-3.3-1.3-3.3-3.1 1.4-3.3 3.3-3.3z"/>');this._inputEl=document.createElement("input"),this._inputEl.type="text",this._inputEl.className="mapboxgl-ctrl-geocoder--input",this.setPlaceholder(),this.options.collapsed&&(this._collapse(),this.container.addEventListener("mouseenter",this._unCollapse),this.container.addEventListener("mouseleave",this._collapse),this._inputEl.addEventListener("focus",this._unCollapse)),(this.options.collapsed||this.options.clearOnBlur)&&this._inputEl.addEventListener("blur",this._onBlur),this._inputEl.addEventListener("keydown",Te(this._onKeyDown,200)),this._inputEl.addEventListener("paste",this._onPaste),this._inputEl.addEventListener("change",this._onChange),this.container.addEventListener("mouseenter",this._showButton),this.container.addEventListener("mouseleave",this._hideButton),this._inputEl.addEventListener("keyup",(function(Gt){this.eventManager.keyevent(Gt,this)}).bind(this));var It=document.createElement("div");It.classList.add("mapboxgl-ctrl-geocoder--pin-right"),this._clearEl=document.createElement("button"),this._clearEl.setAttribute("aria-label","Clear"),this._clearEl.addEventListener("click",this.clear),this._clearEl.className="mapboxgl-ctrl-geocoder--button";var vt=this.createIcon("close",'<path d="M3.8 2.5c-.6 0-1.3.7-1.3 1.3 0 .3.2.7.5.8L7.2 9 3 13.2c-.3.3-.5.7-.5 1 0 .6.7 1.3 1.3 1.3.3 0 .7-.2 1-.5L9 10.8l4.2 4.2c.2.3.7.3 1 .3.6 0 1.3-.7 1.3-1.3 0-.3-.2-.7-.3-1l-4.4-4L15 4.6c.3-.2.5-.5.5-.8 0-.7-.7-1.3-1.3-1.3-.3 0-.7.2-1 .3L9 7.1 4.8 2.8c-.3-.1-.7-.3-1-.3z"/>');if(this._clearEl.appendChild(vt),this._loadingEl=this.createIcon("loading",'<path fill="#333" d="M4.4 4.4l.8.8c2.1-2.1 5.5-2.1 7.6 0l.8-.8c-2.5-2.5-6.7-2.5-9.2 0z"/><path opacity=".1" d="M12.8 12.9c-2.1 2.1-5.5 2.1-7.6 0-2.1-2.1-2.1-5.5 0-7.7l-.8-.8c-2.5 2.5-2.5 6.7 0 9.2s6.6 2.5 9.2 0 2.5-6.6 0-9.2l-.8.8c2.2 2.1 2.2 5.6 0 7.7z"/>'),It.appendChild(this._clearEl),It.appendChild(this._loadingEl),Ge.appendChild(at),Ge.appendChild(this._inputEl),Ge.appendChild(It),this.options.enableGeolocation&&this.geolocation.isSupport()){this._geolocateEl=document.createElement("button"),this._geolocateEl.setAttribute("aria-label","Geolocate"),this._geolocateEl.addEventListener("click",this._geolocateUser),this._geolocateEl.className="mapboxgl-ctrl-geocoder--button";var nt=this.createIcon("geolocate",'<path d="M12.999 3.677L2.042 8.269c-.962.403-.747 1.823.29 1.912l5.032.431.431 5.033c.089 1.037 1.509 1.252 1.912.29l4.592-10.957c.345-.822-.477-1.644-1.299-1.299z" fill="#4264fb"/>');this._geolocateEl.appendChild(nt),It.appendChild(this._geolocateEl),this._showGeolocateButton()}var $e=this._typeahead=new je(this._inputEl,[],{filter:!1,minLength:this.options.minLength,limit:this.options.limit});this.setRenderFunction(this.options.render),$e.getItemValue=this.options.getItemValue;var Ye=$e.list.draw,yt=this._footerNode=qt();return $e.list.draw=function(){Ye.call(this),yt.addEventListener("mousedown",(function(){this.selectingListItem=!0}).bind(this)),yt.addEventListener("mouseup",(function(){this.selectingListItem=!1}).bind(this)),this.element.appendChild(yt)},this.mapMarker=null,this._handleMarker=this._handleMarker.bind(this),this._map&&(this.options.trackProximity&&(this._updateProximity(),this._map.on("moveend",this._updateProximity)),this._mapboxgl=this.options.mapboxgl,!this._mapboxgl&&this.options.marker&&(console.error("No mapboxgl detected in options. Map markers are disabled. Please set options.mapboxgl."),this.options.marker=!1)),Ge},_geolocateUser:function(){this._hideGeolocateButton(),this._showLoadingIcon(),this.geolocation.getCurrentPosition().then((function(re){this._hideLoadingIcon();const Ge={geometry:{type:"Point",coordinates:[re.coords.longitude,re.coords.latitude]}};this._handleMarker(Ge),this._fly(Ge),this._typeahead.clear(),this._typeahead.selected=!0,this.lastSelected=JSON.stringify(Ge),this._showClearButton(),this.fresh=!1;const at={limit:1,language:[this.options.language],query:Ge.geometry.coordinates,types:["address"]};if(this.options.localGeocoderOnly){const It=Ge.geometry.coordinates[0]+","+Ge.geometry.coordinates[1];this._setInputValue(It),this._eventEmitter.emit("result",{result:Ge})}else this.geocoderService.reverseGeocode(at).send().then((function(It){const vt=It.body.features[0];if(vt){const nt=ht.transformFeatureToGeolocationText(vt,this.options.addressAccuracy);this._setInputValue(nt),vt.user_coordinates=Ge.geometry.coordinates,this._eventEmitter.emit("result",{result:vt})}else this._eventEmitter.emit("result",{result:{user_coordinates:Ge.geometry.coordinates}})}).bind(this))}).bind(this)).catch((function(re){re.code===1?this._renderUserDeniedGeolocationError():this._renderLocationError(),this._hideLoadingIcon(),this._showGeolocateButton(),this._hideAttribution()}).bind(this))},createIcon:function(re,Ge){var at=document.createElementNS("http://www.w3.org/2000/svg","svg");return at.setAttribute("class","mapboxgl-ctrl-geocoder--icon mapboxgl-ctrl-geocoder--icon-"+re),at.setAttribute("viewBox","0 0 18 18"),at.setAttribute("xml:space","preserve"),at.setAttribute("width",18),at.setAttribute("height",18),at.innerHTML=Ge,at},onRemove:function(){return this.container.parentNode.removeChild(this.container),this.options.trackProximity&&this._map&&this._map.off("moveend",this._updateProximity),this._removeMarker(),this._map=null,this},_setInputValue:function(re){this._inputEl.value=re,setTimeout((function(){this._inputEl.focus(),this._inputEl.scrollLeft=0,this._inputEl.setSelectionRange(0,0)}).bind(this),1)},_onPaste:function(re){var Ge=(re.clipboardData||window.clipboardData).getData("text");Ge.length>=this.options.minLength&&this._geocode(Ge)},_onKeyDown:function(re){var Ge=27,at=9;if(re.keyCode===Ge&&this.options.clearAndBlurOnEsc)return this._clear(re),this._inputEl.blur();var It=re.target&&re.target.shadowRoot?re.target.shadowRoot.activeElement:re.target,vt=It?It.value:"";if(!vt)return this.fresh=!0,re.keyCode!==at&&this.clear(re),this._showGeolocateButton(),this._hideClearButton();this._hideGeolocateButton(),!(re.metaKey||[at,Ge,37,39,13,38,40].indexOf(re.keyCode)!==-1)&&It.value.length>=this.options.minLength&&this._geocode(It.value)},_showButton:function(){this._typeahead.selected&&this._showClearButton()},_hideButton:function(){this._typeahead.selected&&this._hideClearButton()},_showClearButton:function(){this._clearEl.style.display="block"},_hideClearButton:function(){this._clearEl.style.display="none"},_showGeolocateButton:function(){this._geolocateEl&&this.geolocation.isSupport()&&(this._geolocateEl.style.display="block")},_hideGeolocateButton:function(){this._geolocateEl&&(this._geolocateEl.style.display="none")},_showLoadingIcon:function(){this._loadingEl.style.display="block"},_hideLoadingIcon:function(){this._loadingEl.style.display="none"},_showAttribution:function(){this._footerNode.style.display="block"},_hideAttribution:function(){this._footerNode.style.display="none"},_onBlur:function(re){this.options.clearOnBlur&&this._clearOnBlur(re),this.options.collapsed&&this._collapse()},_onChange:function(){var re=this._typeahead.selected;re&&JSON.stringify(re)!==this.lastSelected&&(this._hideClearButton(),this.options.flyTo&&this._fly(re),this.options.marker&&this._mapboxgl&&this._handleMarker(re),this._inputEl.focus(),this._inputEl.scrollLeft=0,this._inputEl.setSelectionRange(0,0),this.lastSelected=JSON.stringify(re),this._eventEmitter.emit("result",{result:re}),this.eventManager.select(re,this))},_fly:function(re){var Ge;if(re.properties&&le[re.properties.short_code])Ge=he({},this.options.flyTo),this._map&&this._map.fitBounds(le[re.properties.short_code].bbox,Ge);else if(re.bbox){var at=re.bbox;Ge=he({},this.options.flyTo),this._map&&this._map.fitBounds([[at[0],at[1]],[at[2],at[3]]],Ge)}else{var It={zoom:this.options.zoom};Ge=he({},It,this.options.flyTo),re.center?Ge.center=re.center:re.geometry&&re.geometry.type&&re.geometry.type==="Point"&&re.geometry.coordinates&&(Ge.center=re.geometry.coordinates),this._map&&this._map.flyTo(Ge)}},_requestType:function(re,Ge){var at;return re.localGeocoderOnly?at=zt.LOCAL:re.reverseGeocode&&ht.REVERSE_GEOCODE_COORD_RGX.test(Ge)?at=zt.REVERSE:at=zt.FORWARD,at},_setupConfig:function(re,Ge){const at=["bbox","limit","proximity","countries","types","language","reverseMode","mode","autocomplete","fuzzyMatch","routing","worldview"],It=/[\s,]+/;var vt=this,nt=at.reduce(function(Ye,yt){if(vt.options[yt]===void 0||vt.options[yt]===null)return Ye;["countries","types","language"].indexOf(yt)>-1?Ye[yt]=vt.options[yt].split(It):Ye[yt]=vt.options[yt];const Gt=typeof vt.options[yt].longitude=="number"&&typeof vt.options[yt].latitude=="number";if(yt==="proximity"&&Gt){const gi=vt.options[yt].longitude,xi=vt.options[yt].latitude;Ye[yt]=[gi,xi]}return Ye},{});switch(re){case zt.REVERSE:{var $e=Ge.split(It).map(function(Ye){return parseFloat(Ye,10)});vt.options.flipCoordinates||$e.reverse(),nt.types&&nt.types[0],nt=he(nt,{query:$e,limit:1}),["proximity","autocomplete","fuzzyMatch","bbox"].forEach(function(Ye){Ye in nt&&delete nt[Ye]})}break;case zt.FORWARD:{const Ye=Ge.trim();/^(-?\d{1,3}(\.\d{0,256})?)[, ]+(-?\d{1,3}(\.\d{0,256})?)?$/.test(Ye)&&(Ge=Ge.replace(/,/g," ")),nt=he(nt,{query:Ge})}break}return nt.session_token=this.eventManager.getSessionId(),nt},_geocode:function(re){this.inputString=re,this._showLoadingIcon(),this._eventEmitter.emit("loading",{query:re});const Ge=this._requestType(this.options,re),at=this._setupConfig(Ge,re);var It;switch(Ge){case zt.LOCAL:It=Promise.resolve();break;case zt.FORWARD:It=this.geocoderService.forwardGeocode(at).send();break;case zt.REVERSE:It=this.geocoderService.reverseGeocode(at).send();break}var vt=this.options.localGeocoder?this.options.localGeocoder(re)||[]:[],nt=[],$e=null;return It.catch((function(Ye){$e=Ye}).bind(this)).then((function(Ye){this._hideLoadingIcon();var yt={};return Ye?Ye.statusCode=="200"&&(yt=Ye.body,yt.request=Ye.request,yt.headers=Ye.headers,this._headers=Ye.headers):yt={type:"FeatureCollection",features:[]},yt.config=at,this.fresh&&(this.eventManager.start(this),this.fresh=!1),yt.features&&yt.features.length&&yt.features.map(function(Gt){Gt._source="mapbox"}),yt.features=yt.features?vt.concat(yt.features):vt,this.options.externalGeocoder?(nt=this.options.externalGeocoder(re,yt.features)||Promise.resolve([]),nt.then(function(Gt){return yt.features=yt.features?Gt.concat(yt.features):Gt,yt},function(){return yt})):yt}).bind(this)).then((function(Ye){if($e)throw $e;this.options.filter&&Ye.features.length&&(Ye.features=Ye.features.filter(this.options.filter)),Ye.features.length?(this._showClearButton(),this._hideGeolocateButton(),this._showAttribution(),this._eventEmitter.emit("results",Ye),this._typeahead.update(Ye.features)):(this._hideClearButton(),this._hideAttribution(),this._typeahead.selected=null,this._renderNoResults(),this._eventEmitter.emit("results",Ye))}).bind(this)).catch((function(Ye){this._hideLoadingIcon(),this._hideAttribution(),vt.length&&this.options.localGeocoder||nt.length&&this.options.externalGeocoder?(this._showClearButton(),this._hideGeolocateButton(),this._typeahead.update(vt)):(this._hideClearButton(),this._typeahead.selected=null,this._renderError()),this._eventEmitter.emit("results",{features:vt}),this._eventEmitter.emit("error",{error:Ye})}).bind(this)),It},_clear:function(re){re&&re.preventDefault(),this._inputEl.value="",this._typeahead.selected=null,this._typeahead.clear(),this.eventManager.sessionIncrementer++,this._onChange(),this._hideClearButton(),this._showGeolocateButton(),this._removeMarker(),this.lastSelected=null,this._eventEmitter.emit("clear"),this.fresh=!0},clear:function(re){this._clear(re),this._inputEl.focus()},_clearOnBlur:function(re){var Ge=this;re.relatedTarget&&Ge._clear(re)},_onQueryResult:function(re){var Ge=re.body;if(Ge.features.length){var at=Ge.features[0];this._typeahead.selected=at,this._inputEl.value=at.place_name,this._onChange()}},_updateProximity:function(){if(!(!this._map||!this.options.trackProximity))if(this._map.getZoom()>9){var re=this._map.getCenter().wrap();this.setProximity({longitude:re.lng,latitude:re.lat},!1)}else this.setProximity(null,!1)},_collapse:function(){!this._inputEl.value&&this._inputEl!==document.activeElement&&this.container.classList.add("mapboxgl-ctrl-geocoder--collapsed")},_unCollapse:function(){this.container.classList.remove("mapboxgl-ctrl-geocoder--collapsed")},query:function(re){return this._geocode(re).then(this._onQueryResult),this},_renderError:function(){var re="<div class='mapbox-gl-geocoder--error'>There was an error reaching the server</div>";this._renderMessage(re)},_renderLocationError:function(){var re="<div class='mapbox-gl-geocoder--error'>A location error has occurred</div>";this._renderMessage(re)},_renderNoResults:function(){var re="<div class='mapbox-gl-geocoder--error mapbox-gl-geocoder--no-results'>No results found</div>";this._renderMessage(re)},_renderUserDeniedGeolocationError:function(){var re="<div class='mapbox-gl-geocoder--error'>Geolocation permission denied</div>";this._renderMessage(re)},_renderMessage:function(re){this._typeahead.update([]),this._typeahead.selected=null,this._typeahead.clear(),this._typeahead.renderError(re)},_getPlaceholderText:function(){if(this.options.placeholder)return this.options.placeholder;if(this.options.language){var re=this.options.language.split(",")[0],Ge=Ce.language(re),at=Ae.placeholder[Ge];if(at)return at}return"Search"},setInput:function(re,Ge){return Ge===void 0&&(Ge=!1),this._inputEl.value=re,this._typeahead.selected=null,this._typeahead.clear(),re.length>=this.options.minLength&&(Ge?this._geocode(re):this._onChange()),this},setProximity:function(re,Ge=!0){return this.options.proximity=re,Ge&&(this.options.trackProximity=!1),this},getProximity:function(){return this.options.proximity},setRenderFunction:function(re){return re&&typeof re=="function"&&(this._typeahead.render=re),this},getRenderFunction:function(){return this._typeahead.render},setLanguage:function(re){var Ge=navigator.language||navigator.userLanguage||navigator.browserLanguage;return this.options.language=re||this.options.language||Ge,this},getLanguage:function(){return this.options.language},getZoom:function(){return this.options.zoom},setZoom:function(re){return this.options.zoom=re,this},getFlyTo:function(){return this.options.flyTo},setFlyTo:function(re){return this.options.flyTo=re,this},getPlaceholder:function(){return this.options.placeholder},setPlaceholder:function(re){return this.options.placeholder=re||this._getPlaceholderText(),this._inputEl.placeholder=this.options.placeholder,this._inputEl.setAttribute("aria-label",this.options.placeholder),this},getBbox:function(){return this.options.bbox},setBbox:function(re){return this.options.bbox=re,this},getCountries:function(){return this.options.countries},setCountries:function(re){return this.options.countries=re,this},getTypes:function(){return this.options.types},setTypes:function(re){return this.options.types=re,this},getMinLength:function(){return this.options.minLength},setMinLength:function(re){return this.options.minLength=re,this._typeahead&&(this._typeahead.options.minLength=re),this},getLimit:function(){return this.options.limit},setLimit:function(re){return this.options.limit=re,this._typeahead&&(this._typeahead.options.limit=re),this},getFilter:function(){return this.options.filter},setFilter:function(re){return this.options.filter=re,this},setOrigin:function(re){return this.options.origin=re,this.geocoderService=Be(be({accessToken:this.options.accessToken,origin:this.options.origin})),this},getOrigin:function(){return this.options.origin},setAccessToken:function(re){return this.options.accessToken=re,this.geocoderService=Be(be({accessToken:this.options.accessToken,origin:this.options.origin})),this},setAutocomplete:function(re){return this.options.autocomplete=re,this},getAutocomplete:function(){return this.options.autocomplete},setFuzzyMatch:function(re){return this.options.fuzzyMatch=re,this},getFuzzyMatch:function(){return this.options.fuzzyMatch},setRouting:function(re){return this.options.routing=re,this},getRouting:function(){return this.options.routing},setWorldview:function(re){return this.options.worldview=re,this},getWorldview:function(){return this.options.worldview},_handleMarker:function(re){if(this._map){this._removeMarker();var Ge={color:"#4668F2"},at=he({},Ge,this.options.marker);return this.mapMarker=new this._mapboxgl.Marker(at),re.center?this.mapMarker.setLngLat(re.center).addTo(this._map):re.geometry&&re.geometry.type&&re.geometry.type==="Point"&&re.geometry.coordinates&&this.mapMarker.setLngLat(re.geometry.coordinates).addTo(this._map),this}},_removeMarker:function(){this.mapMarker&&(this.mapMarker.remove(),this.mapMarker=null)},on:function(re,Ge){return this._eventEmitter.on(re,Ge),this},off:function(re,Ge){return this._eventEmitter.removeListener(re,Ge),this.eventManager.remove(),this}},hg=st,hg}var CT=AT();const MT=s1(CT);function d1(){return{map:L2("mapbox-map",null)}}const dg=new Map,PT=/onMb([A-Z])(.+)/;function RT(je){return dg.has(je)||dg.set(je,je.replace(PT,(Te,he,pe)=>he.toLowerCase()+pe)),dg.get(je)}function gg(je,Te,he=[],pe=null){const le=R2(),be=Io(()=>Object.entries(le).filter(([Ce,ot])=>Ce.startsWith("on")&&typeof ot=="function").map(([Ce])=>Ce)),Be=new Map;function o(Ce){Array.isArray(Ce)&&Ce.forEach(ot=>{const ht=Be.get(ot);typeof ht=="function"&&ht()})}function Ae(Ce){Array.isArray(Ce)&&Ce.forEach(ot=>{const ht=RT(ot);if(!he.includes(ht))return;const zt=(...qt)=>{je(`mb-${ht}`,...qt)};pe?(Oi(Te).on(ht,pe,zt),Be.set(ot,()=>{Oi(Te).off(ht,pe,zt)})):(Oi(Te).on(ht,zt),Be.set(ot,()=>{Oi(Te).off(ht,zt)}))})}Ed(be,(Ce,ot)=>{const ht=Array.isArray(Ce)?(ot??[]).filter(qt=>!Ce.includes(qt)):ot??[],zt=Array.isArray(ot)?(Ce??[]).filter(qt=>!ot.includes(qt)):Ce??[];if(Oi(Te))o(ht),Ae(zt);else{const qt=Ed(Te,st=>{st&&(o(ht),Ae(zt),qt())})}},{immediate:!0})}function zT(je){return je.charAt(0).toUpperCase()+je.slice(1)}function yg(je,Te,he){function pe(le){Object.keys(je).filter(be=>je[be]!==void 0&&je[be]!==null).forEach(be=>{var Be;const o=be==="mapStyle"?"setStyle":`set${zT(be)}`,Ae=typeof le[o]=="function",Ce=typeof he[be]>"u"||"bind"in he[be]?((Be=he[be])==null?void 0:Be.bind)??!1:!0;if(!Ae||!Ce)return;const{type:ot}=he[be],ht={deep:ot===Object||Array.isArray(ot)&&ot.includes(Object)};Ed(()=>je[be],zt=>{le[o](zt)},ht)})}if(Oi(Te))pe(Oi(Te));else{const le=Ed(Te,be=>{be&&(pe(be),le())})}}if(!Ao)throw new Error("mapboxgl is not installed.");if(!MT)throw new Error("MapboxGeocoder is not installed.");const LT={key:0},DT={key:1};if(!Ao)throw new Error("mapboxgl is not installed.");const{LngLatBounds:X0,LngLat:OT}=Ao,Y0={accessToken:{type:String,default:"no-token"},container:{type:[typeof HTMLElement<"u"&&HTMLElement,String],default:void 0},minZoom:{type:Number,default:0},maxZoom:{type:Number,default:22},minPitch:{type:Number,default:0},maxPitch:{type:Number,default:60},mapStyle:{type:[Object,String],required:!0},hash:{type:Boolean,default:!1},interactive:{type:Boolean,default:!0},bearingSnap:{type:Number,default:7},pitchWithRotate:{type:Boolean,default:!0},clickTolerance:{type:Number,default:3},attributionControl:{type:Boolean,default:!0},customAttribution:{type:[String,Array],default:null},logoPosition:{type:String,default:"bottom-left"},failIfMajorPerformanceCaveat:{type:Boolean,default:!1},preserveDrawingBuffer:{type:Boolean,default:!1},antialias:{type:Boolean,default:!1},refreshExpiredTiles:{type:Boolean,default:!0},maxBounds:{type:[X0,Array],default:void 0},scrollZoom:{type:[Boolean,Object],default:!0},boxZoom:{type:Boolean,default:!0},dragRotate:{type:Boolean,default:!0},dragPan:{type:[Boolean,Object],default:!0},keyboard:{type:Boolean,default:!0},doubleClickZoom:{type:Boolean,default:!0},touchZoomRotate:{type:[Boolean,Object],default:!0},trackResize:{type:Boolean,default:!0},center:{type:[OT,Array,Object],default:()=>[0,0]},zoom:{type:Number,default:0},bearing:{type:Number,default:0},pitch:{type:Number,default:0},bounds:{type:[X0,Array],default:void 0},fitBoundsOptions:{type:Object,default:null},renderWorldCopies:{type:Boolean,default:!0},maxTileCacheSize:{type:Number,default:null},localIdeographFontFamily:{type:String,default:"sans-serif"},transformRequest:{type:Function,default:null},collectResourceTiming:{type:Boolean,default:!1},fadeDuration:{type:Number,default:300},crossSourceCollisions:{type:Boolean,default:!0},cooperativeGestures:{type:Boolean},language:{type:[String,Array],default:null},locale:{type:Object,default:null},localFontFamily:{type:[Boolean,String],default:!1},minTileCacheSize:{type:Number,default:null},optimizeForTerrain:{type:Boolean,default:!0},performanceMetricsCollection:{type:Boolean,default:!0},projection:{type:[String,Object],default:"mercator"},testMode:{type:Boolean,default:!1},touchPitch:{type:[Boolean,Object],default:!0},useWebGL2:{type:Boolean,default:!1},worldview:{type:String,default:null}},kT=["boxzoomcancel","boxzoomend","boxzoomstart","click","contextmenu","data","dataloading","dblclick","drag","dragend","dragstart","error","idle","load","mousedown","mouseenter","mouseleave","mousemove","mouseout","mouseover","mouseup","move","moveend","movestart","pitch","pitchend","pitchstart","remove","render","resize","rotate","rotateend","rotatestart","sourcedata","sourcedataloading","styledata","styledataloading","styleimagemissing","touchcancel","touchend","touchmove","touchstart","webglcontextlost","webglcontextrestored","wheel","zoom","zoomend","zoomstart"],FT={inheritAttrs:!1},BT=pg({...FT,__name:"MapboxMap",props:Y0,setup(je,{expose:Te,emit:he}){const pe=je,le=he,be=mg(null);D2("mapbox-map",be);const Be=fs(),o=fs(!1),Ae=Io(()=>{const{accessToken:Ce,mapStyle:ot,...ht}=pe;return!ht.container&&Be.value&&(ht.container=Be.value),{style:ot,...ht}});return gg(le,be,kT),yg(pe,be,Y0),Lu(()=>{Ao.accessToken=pe.accessToken,be.value=new Ao.Map(Ae.value),be.value.on("load",()=>{o.value=!0}),le("mb-created",be.value);const Ce=new ResizeObserver(()=>{be.value.resize()});Ce.observe(Ae.value.container),Pp(()=>{Ce.disconnect(),be.value.remove()})}),Te({map:be}),(Ce,ot)=>(Ki(),Ir(_g,null,[yi("div",i1({ref_key:"root",ref:Be},Ce.$attrs),null,16),o.value?(Ki(),Ir("div",LT,[Hs(Ce.$slots,"default")])):(Ki(),Ir("div",DT,[Hs(Ce.$slots,"loader")]))],64))}});if(!Ao)throw new Error("mapboxgl is not installed.");const{GeolocateControl:CE}=Ao,{Popup:NT,Point:VT,LngLat:UT}=Ao,K0={lngLat:{type:[UT,Array,Object],required:!0},closeButton:{type:Boolean,default:!0},closeOnClick:{type:Boolean,default:!0},closeOnMove:{type:Boolean,default:!1},anchor:{type:String,default:null},offset:{type:[Number,VT,Array,Object],default:0},className:{type:String,default:null},maxWidth:{type:String,default:"240px"},renderless:{type:Boolean,default:!1,bind:!1}},jT=["open","close"],GT=pg({__name:"MapboxPopup",props:K0,setup(je,{expose:Te,emit:he}){const pe=je,le=he,be=mg(),Be=fs(),o=Io(()=>{const{lngLat:Ae,...Ce}=pe;return Ce});return yg(pe,be,K0),gg(le,be,jT),Lu(()=>{const{map:Ae}=d1();be.value=new NT(o.value).setLngLat(pe.lngLat).setDOMContent(Be.value),pe.renderless||be.value.addTo(Ae.value),le("mb-open",be.value)}),Pp(()=>{be.value&&be.value.remove()}),Te({popup:be}),(Ae,Ce)=>(Ki(),Ir("div",{ref_key:"root",ref:Be},[Hs(Ae.$slots,"default")],512))}}),{Marker:qT,Point:$T}=Ao,J0={lngLat:{type:Array,required:!0},popup:{type:[Object,Boolean],default:!1,bind:!1},element:{type:typeof HTMLElement<"u"?HTMLElement:Object,default:null},offset:{type:[$T,Array],default:null},anchor:{type:String,default:"center"},color:{type:String,default:null},scale:{type:Number,default:1},draggable:{type:Boolean,default:!1},rotation:{type:Number,default:0},pitchAlignment:{type:String,default:"auto"},rotationAlignment:{type:String,default:"auto"},renderless:{type:Boolean,default:!1,bind:!1}},HT=["dragstart","drag","dragend"],Q0=pg({__name:"MapboxMarker",props:J0,setup(je,{expose:Te,emit:he}){const pe=je,le=he,be=z2(),Be=mg(),o=fs(),Ae=fs(),Ce=Io(()=>typeof be.popup<"u"),ot=Io(()=>Ce.value?Ae.value.popup:null),ht=Io(()=>({lngLat:pe.lngLat,...pe.popup?pe.popup:{},renderless:!0})),zt=Io(()=>{const{lngLat:qt,popup:st,...re}=pe;return be.default&&(re.element=o.value),re});return yg(pe,Be,J0),gg(le,Be,HT),Lu(()=>{const{map:qt}=d1();Be.value=new qT(zt.value).setLngLat(pe.lngLat),pe.renderless||Be.value.addTo(qt.value),Ce.value&&Be.value.setPopup(ot.value)}),Pp(()=>{Be.value&&Be.value.remove()}),Te({marker:Be,popup:ot}),(qt,st)=>(Ki(),Ir("div",null,[yi("div",{ref_key:"contentRef",ref:o},[Hs(qt.$slots,"default")],512),Ce.value?(Ki(),il(GT,i1({key:0,ref_key:"popupRef",ref:Ae},ht.value),{default:Mn(()=>[Hs(qt.$slots,"popup")]),_:3},16)):ps("",!0)]))}});if(!Ao)throw new Error("mapboxgl is not installed.");const ZT="pk.eyJ1Ijoib2xlaC1rb3p1YiIsImEiOiJjbWN3YTN6NXgwMGJ1MmxxdHR2dXNhcGpmIn0.sqIGhAjqP4Rbcu-Hb-37PQ",e1={style:"mapbox://styles/mapbox/streets-v12",apiToken:ZT},zp="/points",WT=()=>Du.get(zp).then(({data:je})=>je.map(Te=>({...Te,id:Te._id}))),XT=je=>Du.post(zp,je),YT=je=>Du.put(zp,je),KT=je=>Du.delete(`${zp}/${je}`),fg=()=>{const je=fs(!1);return{isOpen:je,openModal:()=>{je.value=!0},closeModal:()=>{je.value=!1},toggleModal:()=>{je.value=!je.value}}},JT=()=>Du.get("/user/logout"),QT=()=>Du.get("/user/me"),eS={},tS={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",fill:"currentColor",height:"24px",width:"24px",version:"1.1",id:"Layer_1",viewBox:"0 0 512 512","xml:space":"preserve"};function iS(je,Te){return Ki(),Ir("svg",tS,Te[0]||(Te[0]=[yi("circle",{cx:"256",cy:"114.526",r:"114.526"},null,-1),yi("path",{d:"M256,256c-111.619,0-202.105,90.487-202.105,202.105c0,29.765,24.13,53.895,53.895,53.895h296.421    c29.765,0,53.895-24.13,53.895-53.895C458.105,346.487,367.619,256,256,256z"},null,-1)]))}const rS=hc(eS,[["render",iS]]),nS={class:"flex sticky top-0 items-center text-black gap-3 bg-[#ffe6dc] border-solid border-b-2 border-primary rounded-bl-2xl rounded-br-2xl px-6 py-4 mb-10"},sS={class:"w-10 h-10 flex items-center justify-center rounded-full color-primary bg-primary"},oS={key:0},aS={key:1},lS={__name:"UserInfo",setup(je){const{data:Te,mutation:he,isLoading:pe}=zu({mutationFunction:()=>QT()});return Lu(()=>{he()}),(le,be)=>(Ki(),Ir("div",nS,[yi("div",sS,[Lr(rS,{class:"text-white"})]),Oi(pe)?(Ki(),Ir("span",oS,"Loading...")):ps("",!0),Oi(Te)?(Ki(),Ir("span",aS,Ru(Oi(Te).data.name),1)):ps("",!0)]))}},cS={},uS={width:"28",height:"28",viewBox:"0 0 28 28",fill:"none",xmlns:"http://www.w3.org/2000/svg"};function hS(je,Te){return Ki(),Ir("svg",uS,Te[0]||(Te[0]=[yi("path",{d:"M21 7L7 21",stroke:"#2C2C2C","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},null,-1),yi("path",{d:"M7 7L21 21",stroke:"#2C2C2C","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},null,-1)]))}const dS=hc(cS,[["render",hS]]),fS={class:"relative bg-white min-w-[350px] m-auto text-black rounded-2xl p-10"},vg={__name:"ItTravelerModal",emits:["close"],setup(je,{emit:Te}){const he=Te;return Lu(()=>{document.body.style.overflow="hidden"}),Pp(()=>{document.body.style.overflow="initial"}),(pe,le)=>(Ki(),il(O2(k2),{to:"body"},{default:Mn(()=>[yi("div",{class:"flex w-full h-full fixed top-0 left-0 overflow-auto bg-[rgba(0,0,0,0.3)]",onClick:le[1]||(le[1]=Ad(be=>he("close"),["self"]))},[yi("div",fS,[yi("button",{class:"absolute right-3 top-3",onClick:le[0]||(le[0]=be=>he("close"))},[Lr(dS,{class:"w-6 h-6"})]),Hs(pe.$slots,"default")])])]),_:3}))}},pS={},mS={width:"18",height:"18",viewBox:"0 0 18 18",fill:"none",xmlns:"http://www.w3.org/2000/svg"};function _S(je,Te){return Ki(),Ir("svg",mS,Te[0]||(Te[0]=[yi("path",{d:"M15.8061 10.6312L7.36856 2.19373C5.96231 0.731231 3.65605 0.731231 2.19355 2.13748C0.731055 3.54373 0.731055 5.90623 2.19355 7.31248L2.2498 7.36873L3.8248 8.99998L4.6123 8.21248L2.98105 6.58123C2.0248 5.62498 2.0248 3.99373 2.98105 3.03748C3.9373 2.08123 5.56855 2.02498 6.5248 2.98123L6.58105 3.03748L14.9623 11.4187C15.9748 12.375 15.9748 14.0062 15.0186 14.9625C14.0623 15.975 12.4311 15.975 11.4748 15.0187L11.4186 14.9625L7.25605 10.8C6.69355 10.2375 6.7498 9.33748 7.25605 8.83123C7.52572 8.58696 7.87658 8.45167 8.24043 8.45167C8.60428 8.45167 8.95514 8.58696 9.2248 8.83123L11.5311 11.1375L12.3186 10.35L9.95605 7.98748C9.71659 7.76102 9.43467 7.58419 9.12654 7.4672C8.81841 7.3502 8.49018 7.29535 8.16075 7.30581C7.83133 7.31627 7.50723 7.39182 7.20715 7.52813C6.90706 7.66443 6.63692 7.85878 6.4123 8.09998C5.5123 9.05623 5.5123 10.575 6.4123 11.5875L10.6311 15.8062C12.0373 17.2687 14.3436 17.2687 15.8061 15.8625C17.2686 14.4562 17.2686 12.0937 15.8061 10.6312C15.8061 10.6875 15.8061 10.6312 15.8061 10.6312Z",fill:"#2C2C2C"},null,-1)]))}const gS=hc(pS,[["render",_S]]),yS={classr:"cursor-pointer hover:text-primary"},vS={class:"flex gap-2 items-center"},xS={class:"underline text-xs"},bS={key:0,class:"text-red-500"},f1={__name:"InputImage",emits:"uploaded",setup(je,{emit:Te}){const he=Te,pe=fs(""),le=be=>{const Be=be.target.files[0];if(Be.size>3*1024*1024){pe.value="Завеликий файл";return}const o=new FileReader;pe.value="",o.readAsDataURL(Be),o.onload=()=>{he("uploaded",o.result)}};return(be,Be)=>(Ki(),Ir("div",null,[yi("label",yS,[yi("input",{type:"file",accept:"image/*",class:"hidden",onChange:le},null,32),yi("span",vS,[Lr(gS),yi("span",xS,[Hs(be.$slots,"default")])])]),pe.value?(Ki(),Ir("div",bS,Ru(pe.value),1)):ps("",!0)]))}},wS={width:"20",height:"24",viewBox:"0 0 20 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},TS={key:0},SS={key:1,"clip-path":"url(#clip0_17_758)"},Mp={__name:"MarkerIcon",props:{isActive:{type:Boolean,default:!1}},setup(je){return(Te,he)=>(Ki(),Ir("svg",wS,[je.isActive?(Ki(),Ir("g",TS,he[0]||(he[0]=[yi("path",{d:"M10.0002 -5.11874e-05C8.72364 -0.0599241 7.44863 0.147406 6.25679 0.608668C5.06496 1.06993 3.98256 1.77496 3.0789 2.67863C2.17523 3.5823 1.4702 4.66469 1.00894 5.85652C0.547675 7.04836 0.340344 8.32337 0.400217 9.59995C0.400217 12.6239 2.80022 15.5999 4.00022 16.7999C5.20022 17.9999 10.0002 23.9999 10.0002 23.9999C10.0002 23.9999 14.8002 17.9999 16.0002 16.7999C17.2002 15.5999 19.6002 12.6239 19.6002 9.59995C19.6601 8.32337 19.4528 7.04836 18.9915 5.85652C18.5302 4.66469 17.8252 3.5823 16.9215 2.67863C16.0179 1.77496 14.9355 1.06993 13.7436 0.608668C12.5518 0.147406 11.2768 -0.0599241 10.0002 -5.11874e-05ZM10.0002 13.4999C9.22887 13.4999 8.47484 13.2712 7.83349 12.8427C7.19214 12.4141 6.69227 11.805 6.39709 11.0924C6.10191 10.3798 6.02467 9.59562 6.17515 8.8391C6.32564 8.08257 6.69708 7.38766 7.2425 6.84223C7.78793 6.29681 8.48284 5.92537 9.23936 5.77489C9.99589 5.6244 10.7801 5.70164 11.4927 5.99682C12.2053 6.292 12.8144 6.79187 13.2429 7.43322C13.6715 8.07458 13.9002 8.8286 13.9002 9.59995C13.9002 10.1121 13.7993 10.6192 13.6033 11.0924C13.4074 11.5656 13.1201 11.9955 12.7579 12.3577C12.3958 12.7198 11.9659 13.0071 11.4927 13.2031C11.0195 13.3991 10.5124 13.4999 10.0002 13.4999Z",fill:"#6d6dd3"},null,-1)]))):(Ki(),Ir("g",SS,he[1]||(he[1]=[yi("path",{d:"M10.0002 -5.11874e-05C8.72364 -0.0599241 7.44863 0.147406 6.25679 0.608668C5.06496 1.06993 3.98256 1.77496 3.0789 2.67863C2.17523 3.5823 1.4702 4.66469 1.00894 5.85652C0.547675 7.04836 0.340344 8.32337 0.400217 9.59995C0.400217 12.6239 2.80022 15.5999 4.00022 16.7999C5.20022 17.9999 10.0002 23.9999 10.0002 23.9999C10.0002 23.9999 14.8002 17.9999 16.0002 16.7999C17.2002 15.5999 19.6002 12.6239 19.6002 9.59995C19.6601 8.32337 19.4528 7.04836 18.9915 5.85652C18.5302 4.66469 17.8252 3.5823 16.9215 2.67863C16.0179 1.77496 14.9355 1.06993 13.7436 0.608668C12.5518 0.147406 11.2768 -0.0599241 10.0002 -5.11874e-05ZM10.0002 13.4999C9.22887 13.4999 8.47484 13.2712 7.83349 12.8427C7.19214 12.4141 6.69227 11.805 6.39709 11.0924C6.10191 10.3798 6.02467 9.59562 6.17515 8.8391C6.32564 8.08257 6.69708 7.38766 7.2425 6.84223C7.78793 6.29681 8.48284 5.92537 9.23936 5.77489C9.99589 5.6244 10.7801 5.70164 11.4927 5.99682C12.2053 6.292 12.8144 6.79187 13.2429 7.43322C13.6715 8.07458 13.9002 8.8286 13.9002 9.59995C13.9002 10.1121 13.7993 10.6192 13.6033 11.0924C13.4074 11.5656 13.1201 11.9955 12.7579 12.3577C12.3958 12.7198 11.9659 13.0071 11.4927 13.2031C11.0195 13.3991 10.5124 13.4999 10.0002 13.4999Z",fill:"url(#paint0_linear_17_758)"},null,-1)]))),he[2]||(he[2]=yi("defs",null,[yi("linearGradient",{id:"paint0_linear_17_758",x1:"0.390137",y1:"10.3942",x2:"19.6104",y2:"10.4008",gradientUnits:"userSpaceOnUse"},[yi("stop",{"stop-color":"#FFA279"}),yi("stop",{offset:"1","stop-color":"#F3743D"})])],-1))]))}},p1="data:image/svg+xml,%3c?xml%20version='1.0'%20encoding='iso-8859-1'?%3e%3c!--%20Uploaded%20to:%20SVG%20Repo,%20www.svgrepo.com,%20Generator:%20SVG%20Repo%20Mixer%20Tools%20--%3e%3csvg%20version='1.1'%20id='Layer_1'%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20viewBox='0%200%20507.8%20507.8'%20xml:space='preserve'%3e%3ccircle%20style='fill:%2354C0EB;'%20cx='253.9'%20cy='253.9'%20r='253.9'/%3e%3cpath%20style='fill:%23324A5E;'%20d='M365.2,68.1H142.6c-10.8,0-19.5,8.7-19.5,19.5v332.5c0,10.8,8.7,19.5,19.5,19.5h222.6%20c10.8,0,19.5-8.7,19.5-19.5V87.7C384.7,76.9,376,68.1,365.2,68.1z'/%3e%3cg%3e%3cpath%20style='fill:%232B3B4E;'%20d='M365.2,68.1h-45.1L163.4,439.7h201.8c10.8,0,19.5-8.7,19.5-19.5V87.7%20C384.7,76.9,376,68.1,365.2,68.1z'/%3e%3cpath%20style='fill:%232B3B4E;'%20d='M292.9,90.7h-57.6c-2.2,0-3.9-1.7-3.9-3.9l0,0c0-2.2,1.7-3.9,3.9-3.9h57.6c2.2,0,3.9,1.7,3.9,3.9%20l0,0C296.8,89,295.1,90.7,292.9,90.7z'/%3e%3cpath%20style='fill:%232B3B4E;'%20d='M222.9,90.7h-8c-2.2,0-3.9-1.7-3.9-3.9l0,0c0-2.2,1.7-3.9,3.9-3.9h8c2.2,0,3.9,1.7,3.9,3.9l0,0%20C226.8,89,225.1,90.7,222.9,90.7z'/%3e%3c/g%3e%3ccircle%20style='fill:%23324A5E;'%20cx='253.9'%20cy='411.1'%20r='16.4'/%3e%3crect%20x='143'%20y='101.5'%20style='fill:%23FFFFFF;'%20width='221.8'%20height='283.2'/%3e%3cg%3e%3cpolygon%20style='fill:%234CDBC4;'%20points='223.5,257.5%20270.1,279.7%20233.5,362.7%20205.3,360.1%20231.3,312.2%20188.4,293.3%20'/%3e%3cpolygon%20style='fill:%234CDBC4;'%20points='194.9,195%20217.3,193.1%20259.5,156.7%20250,101.5%20170.1,101.5%20'/%3e%3c/g%3e%3cellipse%20style='fill:%2384DBFF;'%20cx='302.3'%20cy='241.7'%20rx='16.4'%20ry='15.8'/%3e%3cpath%20style='fill:%23E6E9EE;'%20d='M165.1,384.7h5.8l2.9-31.2l15.2,10.6l65.1,6.1l3.7,14.4h6l-3.1-12l26.7,12h13.7l-14.2-6.4l17.1-34.3%20l60.8,8.5v-5.7l-64.2-8.9l-18.9,38.1l-21.5-9.7l24.7-59.1l79.9,9.3v-5.5l-23.8-2.8l23.8-22.5v-7.9l-31.1,29.5l-46.5-5.4l17.4-41.7%20c9.4-1.1,16.7-8.7,17-18l43.2-2.4v-5.6l-43.9,2.5c-2-6.9-8.1-12.2-15.6-13.3v-38.8l-41.9-27.9l-5.8-31l63.9-14.6l43.3,87.9v-13%20L352,160l12.8-14.7v-8.7l-15.5,17.8l-26-52.8h-6.4l2.1,4.2l-62.3,14.3l-3.4-18.5h-5.9l10.3,55.6l-41.2,33.3l-18.8,2.1l-24.4-91h-6%20l24.6,91.7l-48,5.3v5.6l72.5-8.1l28,35.9l-55.7,55.2l-44.8-19.7v6.2l87.6,38.6l-26,47.8l-14.2-1.3l-47.5-33.1v6.9l24.7,17.2%20L165.1,384.7z%20M315.8,241.7c0,7.2-6,13-13.5,13s-13.5-5.8-13.5-13s6-13,13.5-13S315.8,234.5,315.8,241.7z%20M221.5,193.6l39.4-31.8%20l38.6,25.7v35.8c-8.3,1.2-14.8,7.5-16.1,15.5l-25.4,1.4L221.5,193.6z%20M247.7,236.5l7.4,9.5l28.2-1.6c1.2,7.8,7.3,14,15.2,15.5%20l-43.8,104.8l-15.1-1.4l38.2-86.5l-50.2-20.3L247.7,236.5z%20M239.3,309.6l-45.2-19.9l29.1-28.8l46.9,18.9l-36.6,83l-21.9-2.1%20L239.3,309.6z'/%3e%3cpath%20style='fill:%23FF7058;'%20d='M269.3,198.9c0,23.5-42.5,72.2-42.5,72.2s-42.5-48.7-42.5-72.2s19-42.5,42.5-42.5%20C250.3,156.4,269.3,175.5,269.3,198.9z'/%3e%3ccircle%20style='fill:%23FFFFFF;'%20cx='226.8'%20cy='199.1'%20r='18.1'/%3e%3cpath%20style='fill:%23FF7058;'%20d='M327.9,317.2c0,11.7-21.3,36.1-21.3,36.1s-21.3-24.3-21.3-36.1c0-11.7,9.5-21.3,21.3-21.3%20C318.4,296,327.9,305.5,327.9,317.2z'/%3e%3ccircle%20style='fill:%23FFFFFF;'%20cx='306.6'%20cy='317.3'%20r='9.1'/%3e%3c/svg%3e",ES={class:"w-[750px]"},IS={class:"flex gap-2 items-center mb-10"},AS={class:"flex gap-5"},CS={class:"w-5/12"},MS=["src"],PS={class:"w-7/12"},RS={class:"mt-4"},zS={__name:"EditPlaceModal",props:{isOpen:{default:!1,type:Boolean},isLoading:{default:!1,type:Boolean},place:Object},emits:["close","submit"],setup(je,{emit:Te}){const he=je,pe=Te,le=fs({id:"",title:"",description:"",img:"",coordinates:null});Ed(()=>he.place,()=>{le.value={...he.place}});const be=Be=>{le.value.img=Be};return(Be,o)=>he.isOpen?(Ki(),il(Oi(vg),{key:0,onClose:o[3]||(o[3]=Ae=>pe("close"))},{default:Mn(()=>[yi("div",ES,[yi("div",IS,[Lr(Mp,{height:"18",width:"18"}),o[4]||(o[4]=yi("span",{class:"font-bold text-base"},"Редагувати маркер",-1))]),yi("form",{onSubmit:o[2]||(o[2]=Ad(Ae=>pe("submit",le.value),["prevent"]))},[yi("div",AS,[yi("div",CS,[yi("img",{class:"w-full h-[276px] object-cover rounded-md",src:le.value.img||Oi(p1),alt:"place img"},null,8,MS)]),yi("div",PS,[Lr(Oi(Cp),{label:"Локація",modelValue:le.value.title,"onUpdate:modelValue":o[0]||(o[0]=Ae=>le.value.title=Ae)},null,8,["modelValue"]),yi("div",RS,[Lr(Oi(Cp),{label:"Опис",type:"textarea",modelValue:le.value.description,"onUpdate:modelValue":o[1]||(o[1]=Ae=>le.value.description=Ae)},null,8,["modelValue"])]),Lr(Oi(Id),{class:"mt-10 w-full",variant:"gradient","is-loading":je.isLoading},{default:Mn(()=>o[5]||(o[5]=[tl(" Зберегти ")])),_:1,__:[5]},8,["is-loading"])])]),Lr(f1,{class:"mt-3",onUploaded:be},{default:Mn(()=>o[6]||(o[6]=[yi("span",{span:"text-xs"},"Натисність тут, щоб додати інше фото",-1)])),_:1,__:[6]})],32)])]),_:1})):ps("",!0)}},LS={},DS={class:"text-grey cursor-pointer hover:text-primary"};function OS(je,Te){return Ki(),Ir("button",DS,[Hs(je.$slots,"default")])}const t1=hc(LS,[["render",OS]]),kS={},FS={width:"16",height:"16",viewBox:"0 0 16 16",fill:"none",xmlns:"http://www.w3.org/2000/svg"};function BS(je,Te){return Ki(),Ir("svg",FS,Te[0]||(Te[0]=[yi("path",{d:"M1.6665 14.3334L5.36602 12.9105C5.60264 12.8195 5.72096 12.774 5.83165 12.7146C5.92997 12.6618 6.0237 12.6009 6.11186 12.5324C6.21112 12.4554 6.30075 12.3658 6.48002 12.1865L13.9999 4.66671C14.7362 3.93033 14.7362 2.73642 13.9999 2.00004C13.2635 1.26366 12.0696 1.26366 11.3332 2.00004L3.81336 9.51985C3.63409 9.69912 3.54445 9.78876 3.46743 9.88801C3.39902 9.97617 3.33811 10.0699 3.28533 10.1682C3.22591 10.2789 3.1804 10.3972 3.08939 10.6339L1.6665 14.3334ZM1.6665 14.3334L3.03858 10.766C3.13677 10.5107 3.18586 10.3831 3.27006 10.3246C3.34365 10.2735 3.43471 10.2542 3.5227 10.271C3.62339 10.2902 3.72009 10.3869 3.91349 10.5803L5.41955 12.0864C5.61295 12.2798 5.70965 12.3765 5.72888 12.4772C5.74568 12.5652 5.72636 12.6562 5.67527 12.7298C5.6168 12.814 5.48916 12.8631 5.23388 12.9613L1.6665 14.3334Z",stroke:"currentColor","stroke-width":"1.3","stroke-linecap":"round","stroke-linejoin":"round"},null,-1)]))}const NS=hc(kS,[["render",BS]]),VS={},US={width:"16",height:"16",viewBox:"0 0 16 16",fill:"none",xmlns:"http://www.w3.org/2000/svg"};function jS(je,Te){return Ki(),Ir("svg",US,Te[0]||(Te[0]=[yi("path",{d:"M6 2H10",stroke:"currentColor","stroke-width":"1.3","stroke-linecap":"round","stroke-linejoin":"round"},null,-1),yi("path",{d:"M2 4H14",stroke:"currentColor","stroke-width":"1.3","stroke-linecap":"round","stroke-linejoin":"round"},null,-1),yi("path",{d:"M3.3335 4L3.73409 10.0089C3.80846 11.1245 3.84565 11.6823 4.02795 12.1304C4.35894 12.9441 5.02988 13.5718 5.86373 13.8479C6.32301 14 6.88206 14 8.00016 14V14C9.11826 14 9.67731 14 10.1366 13.8479C10.9704 13.5718 11.6414 12.9441 11.9724 12.1304C12.1547 11.6823 12.1919 11.1245 12.2662 10.0089L12.6668 4",stroke:"currentColor","stroke-width":"1.3","stroke-linecap":"round","stroke-linejoin":"round"},null,-1)]))}const GS=hc(VS,[["render",jS]]),qS={section:"",class:"text-grey mb-6 last:mb-0"},$S={class:"flex gap-4"},HS=["src"],ZS={class:"w-full"},WS={class:"flex justify-between items-center mb-2"},XS={class:"font-bold text-sm text-[#2C2C2C]"},YS={class:"flex gap-2"},KS={class:"text-xs line-clamp-3"},JS={__name:"FavouritePlace",props:{title:{required:!0,type:String},description:{required:!0,type:String},img:String,isActive:{required:!0,type:Boolean}},emits:["edit","delete"],setup(je,{emit:Te}){const he=je,pe=Te;return(le,be)=>(Ki(),Ir("section",qS,[yi("div",$S,[yi("img",{class:"w-[76px] h-[76px] shrink-0 rounded-md",src:he.img||Oi(p1),alt:""},null,8,HS),yi("div",ZS,[yi("div",WS,[yi("h2",XS,Ru(he.title),1),yi("div",YS,[Lr(t1,{onClick:be[0]||(be[0]=Be=>pe("edit"))},{default:Mn(()=>[Lr(NS)]),_:1}),Lr(t1,{onClick:be[1]||(be[1]=Ad(Be=>pe("delete"),["stop"]))},{default:Mn(()=>[Lr(GS)]),_:1})])]),yi("p",KS,Ru(he.description),1)])]),yi("div",{class:r1(["h-[1px] w-full bg-[#ececec] mt-4",{"bg-primary":he.isActive,"bg-[#ececec]":!he.isActive}])},null,2)]))}},QS={class:"mb-4 test-lg"},eE={class:"flex gap-3 justify-center"},tE={key:0,class:"text-red-500"},iE={__name:"ConfirmationModal",props:{title:{default:!1,type:String},isOpen:{default:!1,type:Boolean},isLoading:{default:!1,type:Boolean},hasError:{default:!1,type:Boolean}},emits:["cancel","confirm"],setup(je,{emit:Te}){const he=Te;return(pe,le)=>je.isOpen?(Ki(),il(Oi(vg),{key:0,onClose:le[2]||(le[2]=be=>he("cancel"))},{default:Mn(()=>[yi("div",QS,Ru(je.title),1),yi("div",eE,[Lr(Oi(Id),{onClick:le[0]||(le[0]=be=>he("cancel")),variant:"primary"},{default:Mn(()=>le[3]||(le[3]=[tl(" Відхилити")])),_:1,__:[3]}),Lr(Oi(Id),{onClick:le[1]||(le[1]=be=>he("confirm")),variant:"gradient","is-loading":je.isLoading},{default:Mn(()=>le[4]||(le[4]=[tl(" Підтвердити ")])),_:1,__:[4]},8,["is-loading"])]),je.hasError?(Ki(),Ir("div",tE,"Щось пішло не так")):ps("",!0)]),_:1})):ps("",!0)}},rE={class:"px-6"},nE={key:0},sE={__name:"FavouritePlaces",props:{items:{required:!0,type:Array},activeId:{required:!0,type:[String,null]},isPlacesLoading:{type:Boolean,default:!1}},emits:["place-clicked","create","updated"],setup(je,{emit:Te}){const he=je,pe=Te,le=fs(null),{isOpen:be,openModal:Be,closeModal:o}=fg(),{isOpen:Ae,openModal:Ce,closeModal:ot}=fg(),{mutation:ht,isLoading:zt}=zu({mutationFunction:async Ye=>{await YT(Ye)},onSuccess:()=>{o(),pe("updated")}}),{mutation:qt,isLoading:st,error:re}=zu({mutationFunction:Ye=>KT(Ye),onSuccess:()=>{ot(),le.value=null,pe("updated")}}),Ge=fs(null),at=Io(()=>he.items.find(Ye=>Ye.id===Ge.value)),It=Ye=>{Ge.value=Ye,Be()},vt=Ye=>{ht(Ye)},nt=Ye=>{le.value=Ye,Ce()},$e=()=>{qt(le.value)};return(Ye,yt)=>(Ki(),Ir("div",rE,[yt[2]||(yt[2]=yi("div",{class:"text-grey mb-4"},"Додані маркери",-1)),Hs(Ye.$slots,"label"),Hs(Ye.$slots,"list",{},()=>[je.items.length===0&&!je.isPlacesLoading?(Ki(),Ir("div",nE,"Список порожній")):ps("",!0),(Ki(!0),Ir(_g,null,n1(he.items,Gt=>(Ki(),il(JS,{key:Gt.id,title:Gt.title,description:Gt.description,img:Gt.img,"is-active":Gt.id===he.activeId,onClick:gi=>pe("place-clicked",Gt.id),onEdit:gi=>It(Gt.id),onDelete:gi=>nt(Gt.id)},null,8,["title","description","img","is-active","onClick","onEdit","onDelete"]))),128)),Lr(zS,{"is-open":Oi(be),"is-loading":Oi(zt),place:at.value,onClose:Oi(o),onSubmit:vt},null,8,["is-open","is-loading","place","onClose"]),Lr(iE,{"is-open":Oi(Ae),"is-loading":Oi(st),"has-error":Oi(re),onCancel:Oi(ot),onConfirm:$e,title:"Ви дійсно хочете видалити улюблене місце?"},null,8,["is-open","is-loading","has-error","onCancel"])]),Hs(Ye.$slots,"default"),Lr(Oi(Id),{class:"w-full mt-10",onClick:yt[0]||(yt[0]=Gt=>pe("create")),variant:"gradient"},{default:Mn(()=>yt[1]||(yt[1]=[tl(" Додати маркер ")])),_:1,__:[1]})]))}},oE={class:"flex gap-1 font-bold justify-center mb-10"},aE={class:"flex gap-1 items-center mb-10"},lE=["src"],cE={key:0,class:"text-red-500"},uE={__name:"CreateNewPlaceModal",props:{isOpen:{default:!1,type:Boolean},isLoading:{default:!1,type:Boolean},hasError:{default:!1,type:Boolean}},emits:["close","submit"],setup(je,{emit:Te}){const he=je,pe=Te,le=F2({title:"",description:"",img:""}),be=Ae=>{le.img=Ae},Be=Io(()=>`Натисність тут, щоб ${le.img?"змінити":"додати"} фото`),o=()=>{le.title="",le.description="",le.img=""};return(Ae,Ce)=>he.isOpen?(Ki(),il(Oi(vg),{key:0,onClose:Ce[3]||(Ce[3]=ot=>pe("close"))},{default:Mn(()=>[yi("form",{onSubmit:Ce[2]||(Ce[2]=Ad(ot=>pe("submit",le,o),["prevent"])),class:"min-w-[420px]"},[yi("div",oE,[Lr(Mp),Ce[4]||(Ce[4]=tl("Додати маркер"))]),Lr(Oi(Cp),{label:"Локація",class:"mb-4",modelValue:le.title,"onUpdate:modelValue":Ce[0]||(Ce[0]=ot=>le.title=ot)},null,8,["modelValue"]),Lr(Oi(Cp),{label:"Опис",type:"textarea",class:"mb-2",modelValue:le.description,"onUpdate:modelValue":Ce[1]||(Ce[1]=ot=>le.description=ot)},null,8,["modelValue"]),yi("div",aE,[le.img?(Ki(),Ir("img",{key:0,src:le.img,alt:"",class:"w-20 h-20 object-cover"},null,8,lE)):ps("",!0),Lr(f1,{class:"mb-10",onUploaded:be},{default:Mn(()=>[tl(Ru(Be.value),1)]),_:1})]),Lr(Oi(Id),{class:"w-full",variant:"gradient","is-loading":he.isLoading},{default:Mn(()=>Ce[5]||(Ce[5]=[tl("Додати")])),_:1,__:[5]},8,["is-loading"]),he.hasError?(Ki(),Ir("div",cE,"Щось пішло не так")):ps("",!0)],32)]),_:1})):ps("",!0)}},hE={},dE={width:"18",height:"18",viewBox:"0 0 18 18",fill:"none",xmlns:"http://www.w3.org/2000/svg"};function fE(je,Te){return Ki(),Ir("svg",dE,Te[0]||(Te[0]=[yi("path",{d:"M12 12.75L15.75 9M15.75 9L12 5.25M15.75 9H6.75M6.75 2.25H5.85C4.58988 2.25 3.95982 2.25 3.47852 2.49524C3.05516 2.71095 2.71095 3.05516 2.49524 3.47852C2.25 3.95982 2.25 4.58988 2.25 5.85V12.15C2.25 13.4101 2.25 14.0402 2.49524 14.5215C2.71095 14.9448 3.05516 15.289 3.47852 15.5048C3.95982 15.75 4.58988 15.75 5.85 15.75H6.75",stroke:"#2C2C2C","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},null,-1)]))}const pE=hc(hE,[["render",fE]]),mE={key:0},_E={key:1,class:"flex gap-2 items-center px-6 text-black"},gE={__name:"LogoutButton",setup(je){const Te=B2(),{mutation:he,isLoading:pe}=zu({mutationFunction:()=>JT(),onSuccess:()=>{N2.clearToken(),Te.replace("auth/login")}});return(le,be)=>(Ki(),Ir("button",{onClick:be[0]||(be[0]=(...Be)=>Oi(he)&&Oi(he)(...Be))},[Oi(pe)?(Ki(),Ir("span",mE,"Loading...")):(Ki(),Ir("span",_E,[be[1]||(be[1]=tl("Вихід")),Lr(pE)]))]))}},yE={class:"flex h-screen"},vE={class:"relative bg-white h-full w-[400px] shrink-0 overflow-auto pb-10"},xE={key:0,class:"text-black px-6"},bE={class:"w-full h-full flex items-center justify-center text-6xl"},wE=["onClick"],ME={__name:"HomepageView",setup(je){const Te=fs(""),he=fs(null),pe=fs(null),{isOpen:le,openModal:be,closeModal:Be}=fg(),{data:o,mutation:Ae,isLoading:Ce}=zu({mutationFunction:()=>WT()}),ot=Io(()=>o.value??[]),{mutation:ht,isLoading:zt,error:qt}=zu({mutationFunction:async It=>{await XT(It)},onSuccess:()=>{Be(),pe.value=null,Ae()}}),st=It=>{Te.value=It},re=It=>{const vt=ot.value.find($e=>$e.id===It),{coordinates:nt}=vt;st(It),he.value.flyTo({center:nt})},Ge=({lngLat:It})=>{pe.value=[It.lng,It.lat]},at=async(It,vt)=>{const nt={...It,coordinates:pe.value};await ht(nt),vt()};return Lu(()=>{Ae()}),(It,vt)=>(Ki(),Ir("main",yE,[yi("div",vE,[Lr(lS),Oi(Ce)?(Ki(),Ir("div",xE,"Loading...")):ps("",!0),Lr(sE,{items:ot.value,"active-id":Te.value,"is-places-loading":Oi(Ce),onPlaceClicked:re,onCreate:Oi(be),onUpdated:Oi(Ae)},null,8,["items","active-id","is-places-loading","onCreate","onUpdated"]),Lr(uE,{"is-open":Oi(le),"is-loading":Oi(zt),"has-error":!!Oi(qt),onClose:Oi(Be),onSubmit:at},null,8,["is-open","is-loading","has-error","onClose"]),Lr(gE,{class:"mt-10"})]),yi("div",bE,[Lr(Oi(BT),{class:"w-full h-full",center:[30.523333,50.450001],zoom:10,"access-token":Oi(e1).apiToken,"map-style":Oi(e1).style,onMbClick:Ge,onMbCreated:vt[0]||(vt[0]=nt=>{he.value=nt})},{default:Mn(()=>[pe.value?(Ki(),il(Oi(Q0),{key:0,lngLat:pe.value,anchor:"bottom"},{default:Mn(()=>[Lr(Mp,{class:"h-8 w-8","is-active":""})]),_:1},8,["lngLat"])):ps("",!0),(Ki(!0),Ir(_g,null,n1(ot.value,nt=>(Ki(),il(Oi(Q0),{key:nt.id,lngLat:nt.coordinates,anchor:"bottom"},{default:Mn(()=>[yi("button",{onClick:Ad($e=>st(nt.id),["stop"])},[Lr(Mp,{class:r1(nt.id===Te.value?"h-10 w-10":"h-8 w-8")},null,8,["class"])],8,wE)]),_:2},1032,["lngLat"]))),128))]),_:1},8,["access-token","map-style"])])]))}};export{ME as default};
